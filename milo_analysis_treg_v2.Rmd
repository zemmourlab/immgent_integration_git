---
title: "Milo_analysis"
output: html_document
date: "2024-05-29"
editor_options: 
  chunk_output_type: console
---

**Start interactive session on Midway3**
```{bash}
ssh -Y zemmour@midway3.rcc.uchicago.edu
sinfo -s
screen -S david
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=jfkfloor2 --qos=jfkfloor2 --nodes=1 
sinteractive --time=12:00:00 --account=pi-zemmour --partition=caslake --nodes=1 --mem=128GB
sinteractive --time=3:00:00 --account=pi-zemmour --partition=gpu --gres=gpu:1 --mem=152GB
cd $LABHOME

module load python/anaconda-2022.05 
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13

#sinteractive --time=1:00:00 -p gpu --gres=gpu:1 --account=pi-zemmour 

#source activate /project/jfkfloor2/zemmourlab/david/envs/scvi
source activate /project/zemmour/david/envs/scvi_20240315
module load openblas/0.3.13 #load again or error

cd /project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/Treg
#cd ~/google_drive/ImmgenT/analysis/data_integration/IGT1_56/Treg

R
#options(max.print=1000)
#options(Seurat.object.assay.version = 'v5')
```

**Initialize in R: load libraries and custom functions**

```{r}
setwd("/project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/Treg")

libs = c("miloR","scater", "EnhancedVolcano","Seurat","BPCells", "ggplot2", "dplyr", "reshape2", "ggrastr", "RColorBrewer", "pals", "scales", "pheatmap") 
#libs = c("matrixStats", "gplots","ggplot2", "reshape2", "scales", "gridExtra", "dplyr", "RColorBrewer", "grid", "Rtsne", "limma",   "RColorBrewer", "pheatmap", "Seurat",  "ggrastr", "ggbeeswarm") #pwr, preprocessCore, "readxl", vegan", "genefilter" "scde" "cellrangerRkit", "Rsamtools", "GenomicRanges", "GenomicAlignments", "VGAM", "WGCNA",rafalib, ‘UsingR’,MAST "ggrastr",
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))

options(Seurat.object.assay.version = 'v5')

ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
ColorRamp = rev(rainbow(10, end = 4/6))
ColorRamp = viridis(100)

#mycol = c("black","blue","red","darkgreen", "orange","purple", "cyan", "greenyellow",    "salmon", "magenta","pink", "tan", "brown") # c("magenta", "red",  "darkgreen", "cyan", "blue", "blue", "blue", "black", "blue", "blue", "blue", "blue", "orange")

n = 70
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
mypal1 = unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals))))
mypal1 = mypal1[-4]

library("pals")
parade = function(n) { return(Seurat::DiscretePalette(n, palette = "parade", shuffle = F)) }

length(glasbey())
length(polychrome())
mypal = c(glasbey(), polychrome(), mypal1)
names(mypal) = NULL
#pal.bands(glasbey(), polychrome(), parade(), main="Colormap suggestions")

#pdf("mypal.pdf", 10, 10)
#pie(rep(1,n), col=unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))) )
#pie(rep(1,n), col=unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))), labels =  unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))))
#dev.off()

MyplotDAbeeswarm = function (da.res, group.by = NULL, alpha = 0.1, subset.nhoods = NULL) 
{
    require(ggbeeswarm)
    if (!is.null(group.by)) {
        if (!group.by %in% colnames(da.res)) {
            stop(group.by, " is not a column in da.res. Have you forgot to run annotateNhoods(x, da.res, ", 
                group.by, ")?")
        }
        if (is.numeric(da.res[, group.by])) {
        }
        da.res <- mutate(da.res, group_by = da.res[, group.by])
    }
    else {
        da.res <- mutate(da.res, group_by = "g1")
    }
    if (!is.factor(da.res[, "group_by"])) {
        message("Converting group_by to factor...")
        da.res <- mutate(da.res, group_by = factor(group_by, 
            levels = unique(group_by)))
    }
    if (!is.null(subset.nhoods)) {
        da.res <- da.res[subset.nhoods, ]
    }
    beeswarm_pos <- ggplot_build(da.res %>% mutate(is_signif = ifelse(PValue < 
        alpha, 1, 0)) %>% arrange(group_by) %>% ggplot(aes(group_by, 
        logFC)) + geom_quasirandom())
    pos_x <- beeswarm_pos$data[[1]]$x
    pos_y <- beeswarm_pos$data[[1]]$y
    n_groups <- unique(da.res$group_by) %>% length()
    da.res %>% mutate(is_signif = ifelse(SpatialFDR < alpha, 
        1, 0)) %>% mutate(logFC_color = ifelse(is_signif == 1, 
        logFC, NA)) %>% arrange(group_by) %>% mutate(Nhood = factor(Nhood, 
        levels = unique(Nhood))) %>% mutate(pos_x = pos_x, pos_y = pos_y) %>% 
        ggplot(aes(pos_x, pos_y, color = logFC, size = PValue < 
        alpha))  + scale_color_gradient2() + xlab(group.by) + ylab("Log Fold Change") + #guides(color = "none")
        scale_x_continuous(breaks = seq(1, n_groups), labels = setNames(levels(da.res$group_by), 
            seq(1, n_groups))) + geom_point() + coord_flip() + 
        theme_bw(base_size = 22) + theme(strip.text.y = element_text(angle = 0))
}


```

**Make milo object**

Load seurat expression data
```{r}
so = readRDS("totalvi_igt1_56_allgenes_Treg_20240529_so_withclusters.Rds")
```

```{r}
prefix = "milo_totalvi20240525rmigtsample"
setwd(prefix)
milo.dim = "TOTALVI_20240525_RMIGTSAMPLE"
```

Count number of cells for each cluster in each sample
```{r}
m = so@meta.data

stat = m %>% group_by(sample_id) %>% mutate(n_sampleid = n()) %>% group_by(sample_id, Cluster_totalvi20240525rmigtsample_Res0.5) %>% summarize(ncells = n(), prop = ncells/first(n_sampleid)) %>% ungroup() %>% as.data.frame()

write.table(stat, file = "Treg_Cluster_totalvi20240525rmigtsample_Res0.5_PropPerSampleID.csv",row.names = F, col.names = T, sep = ",", quote = F)

summary_df <- m %>%
  group_by(sample_id) %>%
  mutate(total_count = n()) %>%  # Calculate the total count per sample_id
  group_by(sample_id, Cluster_totalvi20240525rmigtsample_Res0.5) %>%
  summarize(
    absolute_count = n(),                            # Calculate the absolute count per cluster
    fraction = n() / first(total_count)              # Calculate the fraction per sample_id
  ) %>%
  ungroup()  # Ungroup after summarizing


stat %>% group_by(sample_id) %>% summarize(totalprop = sum(prop))

```



**Enrichments in condition_detailed ~ tissue in the totalVI IGT_sample space**

Neighborhood optimization in TOTALVI
d = 30 because 30 dims in TOTALVI
Tip: best to have a distribution peaking between 50 and 100. Otherwise you might consider rerunning makeNhoods increasing k and/or prop. 
Tip: can use the same k than for UMAP
Tip: average neighbourhood size over 5 x N_samples (in the interested condition, e.g. colon)
Tip:Prop 0.1 if <30K cells, 0.05 for larger. but it also depends on the sample size: if few cells in one condition (e.g. skin), need to increase prop to cover them

```{r}
sce = as.SingleCellExperiment(so)
mi = Milo(sce)

#optimize k and prop
pdf("neighborhood_optimization.pdf", 10,10, useDingbats = F)
k_s = seq(10, 50, by = 10)
prop_s = seq(0.1, 0.5, by = 0.1)
for (k in k_s) {
    print(sprintf("k = %s",k))
    for (prop in prop_s) {
        print(sprintf("prop = %s",prop))
        mi = buildGraph(mi, k = k, d = 30, reduced.dim = milo.dim) #d = 30 because 30 dims in TOTALVI
        mi = makeNhoods(mi, reduced_dims = milo.dim, prop = prop, k = k, d = 30, refined = TRUE) #use same k and d as above
        
        print(plotNhoodSizeHist(mi, bins = 50) + ggtitle(sprintf("k=%s prop = %s", k, prop)) )
    }
}
dev.off()

```

Running with  d=30, k=30, prop=10%
( d=30, k=50, prop=50%: neighborhhod more dense, might be better to see more subtle signal)
```{r}
mi = buildGraph(mi, k = 30, d = 30, reduced.dim = milo.dim) #d = 30 because 30 dims in TOTALVI, can use the same k than for UMAP
mi = makeNhoods(mi, reduced_dims = milo.dim, prop = 0.1, k = 30, d = 30, refined = TRUE) #refinement_scheme="graph" for faster, use same k and d as above. Prop 0.1 is <30K cells, 0.05 for larger;
mi = buildNhoodGraph(mi)

plotNhoodSizeHist(mi) + ggtitle("") #best to have a distribution peaking between 50 and 100. Otherwise you might consider rerunning makeNhoods increasing k and/or prop. here changed k from 10 to 25. average neighbourhood size over 5 x N_samples

#Count cells in the neighborhoods: this count matrix will be used for DA testing.
mi = countCells(mi, meta.data = data.frame(mi@colData), samples="sample_id")

head(nhoodCounts(mi))

saveRDS(mi, "milo_object_k30_prop10.Rds")

```

Create the design matrix

```{r}
mi = readRDS("milo_object_k30_prop10.Rds")

#Add metadata if needed
all(colnames(so) == colnames(mi))
mi$Cluster_totalvi20240525rmigtsample_Res0.5 = so$Cluster_totalvi20240525rmigtsample_Res0.5[colnames(mi)]

#create the design matrix
mi$organ_simplified.orig = mi$organ_simplified
mi$condition_detailed.orig = mi$condition_detailed
mi$sex.orig = mi$sex
mi$organ_simplified = make.names(mi$organ_simplified)
mi$condition_detailed = make.names(mi$condition_detailed)
mi$sex = make.names(mi$sex)

design = data.frame(mi@colData[,c("sample_id", "organ_simplified", "condition_detailed", "sex")])
#design$organ_simplified = make.names(design$organ_simplified)
#design$condition_broad = make.names(design$condition_broad)
design = distinct(design)
rownames(design) = design$sample_id
## Reorder rownames to match columns of nhoodCounts(milo)
design = design[colnames(nhoodCounts(mi)), , drop=FALSE]
design


```

Milo uses an adaptation of the Spatial FDR correction introduced by cydar, where we correct p-values accounting for the amount of overlap between neighbourhoods. Specifically, each hypothesis test P-value is weighted by the reciprocal of the kth nearest neighbour distance. To use this statistic we first need to store the distances between nearest neighbors in the Milo object.
```{r}
#optional: takes too long for now
#mi = calcNhoodDistance(mi, d=30, reduced.dim = milo.dim)
```

Custom UMAP of DA_res: Plot results in the original UMAP
Key: mi@nhoodIndex isindex cells for UMAP
```{r}

# i = 1
# da_res = da_results[[i]]
# nhoodIndex = colnames(mi)[unlist(mi@nhoodIndex[da_res$Nhood])]
# color_by = "organ_simplified"
# color_by = NULL
# alpha = 0.5
# umap_to_plot = sprintf("umap_%s",tolower(milo.dim))
# title = names(da_results)[i]

DA_UMAP = function(so = so, da_res = da_results[[i]], nhoodIndex = colnames(mi)[unlist(mi@nhoodIndex[da_res$Nhood])], umap_to_plot = sprintf("umap_%s",tolower(milo.dim)), title = names(da_results)[i]) {
    df1 = data.frame(so@meta.data, dim1 = so[[umap_to_plot]]@cell.embeddings[,1], dim2 = so[[umap_to_plot]]@cell.embeddings[,2])
    df2 = data.frame(da_res, dim1 = so[[umap_to_plot]]@cell.embeddings[nhoodIndex,1], dim2 = so[[umap_to_plot]]@cell.embeddings[nhoodIndex,2])
    
    plot1 = ggplot(df1) + geom_point_rast(aes(dim1, dim2), alpha = I(0.1), raster.dpi = 100) 
    plot2 = geom_point(data = df2, aes(dim1, dim2, color = logFC, size = PValue<0.05), alpha = I(1)) #-log10(PValue)
    p = plot1+plot2+ theme_minimal() + scale_color_gradientn(colours = ColorRamp) + ggtitle(title) + theme(axis.text.x=element_text(size=15), axis.text.y=element_text(size=15), legend.text=element_text(size=10), axis.title.x = element_text(size=20) , axis.title.y = element_text(size=20), legend.title = element_text(size=10), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
    
    return(p)
    
}

# i = 1
# da_res = da_results[[i]]
# DA_UMAP(so = so, da_res = da_res, nhoodIndex = colnames(mi)[unlist(mi@nhoodIndex[da_res$Nhood])], umap_to_plot = sprintf("umap_%s",tolower(milo.dim)), title = names(da_res)[i])

```

```{r}
# alternative to pass multiple comparison at a time: this is the edgeR code called by `testNhoods` but the results are confusing, so not recommended.
# model = model.matrix(~ 0 + organ_simplified, data=design.sub)
# mod.constrast = makeContrasts(contrasts=contrasts, levels=model)
# mod.constrast
# contrast1.res = testNhoods(mi, design = ~ organ_simplified, design.df=design.sub, fdr.weighting="graph-overlap", model.contrasts = mod.constrast, reduced.dim = milo.dim, norm.method="TMM")
```

make contrasts one organ vs all the others in Healthy and plots UMAP
--> prefix = "daresults_OrgansInHealthy"
```{r}
prefix = "daresults_OrgansInHealthy"

group = as.character(mi$organ_simplified)
group[!mi$condition_detailed %in% c("baseline")] = "notincluded"
group = factor(group)
x = levels(group)
x = x[x != "notincluded"]

design.sub = design[design$condition_detailed %in% c("baseline"),]
design.sub$organ_simplified = factor(design.sub$organ_simplified)
contrasts = sapply(x, FUN = function(i) sprintf("organ_simplified%s-(%s)/%s", i, paste(sprintf("organ_simplified%s",x[x!= i]), collapse = "+"), length(x)-1)) #"organ_simplifiedspleen - organ_simplifiedcolon" # the syntax is <VariableName><ConditionLevel> - <VariableName><ControlLevel> 
namescontrasts = paste(x, "_vs_OtherOrgansInHealthy", sep = "")
names(contrasts) = namescontrasts
contrasts

da_results = list()
for (i in 1:length(contrasts)) {
    print(i)
    da_results[[names(contrasts)[i]]] = testNhoods(mi, design = ~ 0+ organ_simplified, design.df = design.sub, model.contrasts = contrasts[i], fdr.weighting="graph-overlap", reduced.dim = milo.dim, norm.method="TMM") #doesn't work if not 0+
}
# saveRDS(da_results, sprintf("%s_milo.Rds",prefix))

# alternative to pass multiple comparison at a time: this is the edgeR code called by `testNhoods` but the results are confusing, so not recommended.
# model = model.matrix(~ 0 + organ_simplified, data=design.sub)
# mod.constrast = makeContrasts(contrasts=contrasts, levels=model)
# mod.constrast
# contrast1.res = testNhoods(mi, design = ~ organ_simplified, design.df=design.sub, fdr.weighting="graph-overlap", model.contrasts = mod.constrast, reduced.dim = milo.dim, norm.method="TMM")

da_results = readRDS(sprintf("%s_milo.Rds",prefix))
table(da_results[[1]]$SpatialFDR < 0.1)

pdf(sprintf("%s_UMAP.pdf", prefix), 10,10, useDingbats = F)
for (i in 1:length(da_results)) {
    print(names(da_results)[i])
    da_res = da_results[[i]]
    p = DA_UMAP(so = so, da_res = da_res, nhoodIndex = colnames(mi)[unlist(mi@nhoodIndex[da_res$Nhood])], umap_to_plot = sprintf("umap_%s",tolower(milo.dim)), title = names(da_results)[i])
    print(p)
}
dev.off()

pdf(sprintf("%s_plotDAbeeswarm.pdf", prefix), 10,10, useDingbats = F)
for (i in 1:length(da_results)) {
    print(names(da_results)[i])
    da_res = da_results[[i]]
    coldata_col = "Cluster_totalvi20240525rmigtsample_Res0.5"
    da_res = annotateNhoods(mi, da_res , coldata_col = coldata_col)
    da_res[[coldata_col]] = ifelse(da_res[[sprintf("%s_fraction",coldata_col)]] < 0.7, "Mixed", da_res[[coldata_col]])
    #alpha = max(da_res$SpatialFDR[da_res$PValue<0.05]) if using miloR::plotDAbeeswarm
    #y_lim = round(max(abs(da_res$logFC)))*1.1
    da_res[[coldata_col]] = factor(da_res[[coldata_col]], levels = c(levels(so[[coldata_col]][,1]), "Mixed"))
    p = MyplotDAbeeswarm(da_res, group.by = coldata_col, alpha = 0.05) + scale_color_gradient2(low = ColorRamp[1], mid = ColorRamp[50], high = ColorRamp[100],midpoint = 0 ) + ggtitle(names(da_results)[i]) #+ scale_color_gradient2(low = viridis(100)[1], mid = viridis(100)[50], high = viridis(100)[100], midpoint = 0 ) 
    tryCatch(print(p), error = function(e) {message("too few data points")})
}
dev.off()


```

make contrasts condition_detailed in lung
-->prefix = "daresults_ConditionDetailedInLung"
```{r}
prefix = "daresults_ConditionDetailedInLung"

exclusion_column = "organ_simplified"
contrast_column = "condition_detailed"

group = as.character(mi[[contrast_column]])
group[!mi[[exclusion_column]] %in% c("lung")] = "notincluded"
group = factor(group)
x = levels(group)
x = x[x != "notincluded"]

design.sub = design[design[[exclusion_column]] %in% c("lung"),]
design.sub[[contrast_column]] = factor(design.sub[[contrast_column]])

contrasts = sapply(x[x!="baseline"], FUN = function(i) sprintf("%s%s-%s%s", contrast_column,i, contrast_column, "baseline")) #"organ_simplifiedspleen - organ_simplifiedcolon" # the syntax is <VariableName><ConditionLevel> - <VariableName><ControlLevel> 
namescontrasts = paste(x[x!="baseline"], "_vs_BaselineInLung", sep = "")
names(contrasts) = namescontrasts
contrasts

da_results = list()
for (i in 1:length(contrasts)) {
    print(i)
    da_results[[names(contrasts)[i]]] = testNhoods(mi, design = ~ 0 + condition_detailed, design.df = design.sub, model.contrasts = contrasts[i], fdr.weighting="graph-overlap", reduced.dim = milo.dim, norm.method="TMM")
}
# saveRDS(da_results, sprintf("%s_milo.Rds",prefix))

da_results = readRDS(sprintf("%s_milo.Rds",prefix))
table(da_results[[1]]$SpatialFDR < 0.1)

pdf(sprintf("%s_UMAP.pdf", prefix), 10,10, useDingbats = F)
for (i in 1:length(da_results)) {
    print(names(da_results)[i])
    da_res = da_results[[i]]
    p = DA_UMAP(so = so, da_res = da_res, nhoodIndex = colnames(mi)[unlist(mi@nhoodIndex[da_res$Nhood])], umap_to_plot = sprintf("umap_%s",tolower(milo.dim)), title = names(da_results)[i])
    print(p)
}
dev.off()

pdf(sprintf("%s_plotDAbeeswarm.pdf", prefix), 10,10, useDingbats = F)
for (i in 1:length(da_results)) {
    print(names(da_results)[i])
    da_res = da_results[[i]]
    coldata_col = "Cluster_totalvi20240525rmigtsample_Res0.5"
    da_res = annotateNhoods(mi, da_res , coldata_col = coldata_col)
    da_res[[coldata_col]] = ifelse(da_res[[sprintf("%s_fraction",coldata_col)]] < 0.7, "Mixed", da_res[[coldata_col]])
    #alpha = max(da_res$SpatialFDR[da_res$PValue<0.05]) if using miloR::plotDAbeeswarm
    #y_lim = round(max(abs(da_res$logFC)))*1.1
    da_res[[coldata_col]] = factor(da_res[[coldata_col]], levels = c(levels(so[[coldata_col]][,1]), "Mixed"))
    p = MyplotDAbeeswarm(da_res, group.by = coldata_col, alpha = 0.05) + scale_color_gradient2(low = ColorRamp[1], mid = ColorRamp[50], high = ColorRamp[100],midpoint = 0 ) + ggtitle(names(da_results)[i]) #+ scale_color_gradient2(low = viridis(100)[1], mid = viridis(100)[50], high = viridis(100)[100], midpoint = 0 ) 
    tryCatch(print(p), error = function(e) {message("too few data points")})
}
dev.off()

```

make contrasts condition_detailed in Colon
-->prefix = "daresults_ConditionDetailedInColon"
```{r}
prefix = "daresults_ConditionDetailedInColon"

exclusion_column = "organ_simplified"
contrast_column = "condition_detailed"

group = as.character(mi[[contrast_column]])
group[!mi[[exclusion_column]] %in% c("colon")] = "notincluded"
group = factor(group)
x = levels(group)
x = x[x != "notincluded"]

design.sub = design[design[[exclusion_column]] %in% c("colon"),]
design.sub[[contrast_column]] = factor(design.sub[[contrast_column]])

contrasts = sapply(x[x!="baseline"], FUN = function(i) sprintf("%s%s-%s%s", contrast_column,i, contrast_column, "baseline")) #"organ_simplifiedspleen - organ_simplifiedcolon" # the syntax is <VariableName><ConditionLevel> - <VariableName><ControlLevel> 
namescontrasts = paste(x[x!="baseline"], "_vs_BaselineInColon", sep = "")
names(contrasts) = namescontrasts
contrasts

da_results = list()
for (i in 1:length(contrasts)) {
    print(i)
    da_results[[names(contrasts)[i]]] = testNhoods(mi, design = ~ 0 + condition_detailed, design.df = design.sub, model.contrasts = contrasts[i], fdr.weighting="graph-overlap", reduced.dim = milo.dim, norm.method="TMM")
}
#saveRDS(da_results, sprintf("%s_milo.Rds",prefix))

da_results = readRDS(sprintf("%s_milo.Rds",prefix))
table(da_results[[1]]$SpatialFDR < 0.1)

pdf(sprintf("%s_UMAP.pdf", prefix), 10,10, useDingbats = F)
for (i in 1:length(da_results)) {
    print(names(da_results)[i])
    da_res = da_results[[i]]
    p = DA_UMAP(so = so, da_res = da_res, nhoodIndex = colnames(mi)[unlist(mi@nhoodIndex[da_res$Nhood])], umap_to_plot = sprintf("umap_%s",tolower(milo.dim)), title = names(da_results)[i])
    print(p)
}
dev.off()

pdf(sprintf("%s_plotDAbeeswarm.pdf", prefix), 10,10, useDingbats = F)
for (i in 1:length(da_results)) {
    print(names(da_results)[i])
    da_res = da_results[[i]]
    coldata_col = "Cluster_totalvi20240525rmigtsample_Res0.5"
    da_res = annotateNhoods(mi, da_res , coldata_col = coldata_col)
    da_res[[coldata_col]] = ifelse(da_res[[sprintf("%s_fraction",coldata_col)]] < 0.7, "Mixed", da_res[[coldata_col]])
    #alpha = max(da_res$SpatialFDR[da_res$PValue<0.05]) if using miloR::plotDAbeeswarm
    #y_lim = round(max(abs(da_res$logFC)))*1.1
    da_res[[coldata_col]] = factor(da_res[[coldata_col]], levels = c(levels(so[[coldata_col]][,1]), "Mixed"))
    p = MyplotDAbeeswarm(da_res, group.by = coldata_col, alpha = 0.05) + scale_color_gradient2(low = ColorRamp[1], mid = ColorRamp[50], high = ColorRamp[100],midpoint = 0 ) + ggtitle(names(da_results)[i]) #+ scale_color_gradient2(low = viridis(100)[1], mid = viridis(100)[50], high = viridis(100)[100], midpoint = 0 ) 
    tryCatch(print(p), error = function(e) {message("too few data points")})
}
dev.off()

```

make contrasts condition_detailed in Spleen
-->prefix = "daresults_ConditionDetailedInSpleen"
```{r}
prefix = "daresults_ConditionDetailedInSpleen"

exclusion_column = "organ_simplified"
contrast_column = "condition_detailed"

group = as.character(mi[[contrast_column]])
group[!mi[[exclusion_column]] %in% c("spleen")] = "notincluded"
group = factor(group)
x = levels(group)
x = x[x != "notincluded"]
x

design.sub = design[design[[exclusion_column]] %in% c("spleen"),]
design.sub[[contrast_column]] = factor(design.sub[[contrast_column]])
head(design.sub)

contrasts = sapply(x[x!="baseline"], FUN = function(i) sprintf("%s%s-%s%s", contrast_column,i, contrast_column, "baseline")) #"organ_simplifiedspleen - organ_simplifiedcolon" # the syntax is <VariableName><ConditionLevel> - <VariableName><ControlLevel> 
namescontrasts = paste(x[x!="baseline"], "_vs_BaselineInSpleen", sep = "")
names(contrasts) = namescontrasts
contrasts

da_results = list()
for (i in 1:length(contrasts)) {
    print(i)
    da_results[[names(contrasts)[i]]] = testNhoods(mi, design = ~ 0 + condition_detailed, design.df = design.sub, model.contrasts = contrasts[i], fdr.weighting="graph-overlap", reduced.dim = milo.dim, norm.method="TMM")
}
#saveRDS(da_results, sprintf("%s_milo.Rds",prefix))

da_results = readRDS(sprintf("%s_milo.Rds",prefix))
table(da_results[[1]]$SpatialFDR < 0.1)

pdf(sprintf("%s_UMAP.pdf", prefix), 10,10, useDingbats = F)
for (i in 1:length(da_results)) {
    print(names(da_results)[i])
    da_res = da_results[[i]]
    p = DA_UMAP(so = so, da_res = da_res, nhoodIndex = colnames(mi)[unlist(mi@nhoodIndex[da_res$Nhood])], umap_to_plot = sprintf("umap_%s",tolower(milo.dim)), title = names(da_results)[i])
    print(p)
}
dev.off()

pdf(sprintf("%s_plotDAbeeswarm.pdf", prefix), 10,10, useDingbats = F)
for (i in 1:length(da_results)) {
    print(names(da_results)[i])
    da_res = da_results[[i]]
    coldata_col = "Cluster_totalvi20240525rmigtsample_Res0.5"
    da_res = annotateNhoods(mi, da_res , coldata_col = coldata_col)
    da_res[[coldata_col]] = ifelse(da_res[[sprintf("%s_fraction",coldata_col)]] < 0.7, "Mixed", da_res[[coldata_col]])
    #alpha = max(da_res$SpatialFDR[da_res$PValue<0.05]) if using miloR::plotDAbeeswarm
    #y_lim = round(max(abs(da_res$logFC)))*1.1
    da_res[[coldata_col]] = factor(da_res[[coldata_col]], levels = c(levels(so[[coldata_col]][,1]), "Mixed"))
    p = MyplotDAbeeswarm(da_res, group.by = coldata_col, alpha = 0.05) + scale_color_gradient2(low = ColorRamp[1], mid = ColorRamp[50], high = ColorRamp[100],midpoint = 0 ) + ggtitle(names(da_results)[i]) #+ scale_color_gradient2(low = viridis(100)[1], mid = viridis(100)[50], high = viridis(100)[100], midpoint = 0 ) 
    tryCatch(print(p), error = function(e) {message("too few data points")})
}
dev.off()


```

make contrasts condition_detailed in LN
-->prefix = "daresults_ConditionDetailedInLN"
```{r}
prefix = "daresults_ConditionDetailedInLN"

exclusion_column = "organ_simplified"
contrast_column = "condition_detailed"

group = as.character(mi[[contrast_column]])
group[!mi[[exclusion_column]] %in% c("LN")] = "notincluded"
group = factor(group)
x = levels(group)
x = x[x != "notincluded"]
x

design.sub = design[design[[exclusion_column]] %in% c("LN"),]
design.sub[[contrast_column]] = factor(design.sub[[contrast_column]])
head(design.sub)

contrasts = sapply(x[x!="baseline"], FUN = function(i) sprintf("%s%s-%s%s", contrast_column,i, contrast_column, "baseline")) #"organ_simplifiedspleen - organ_simplifiedcolon" # the syntax is <VariableName><ConditionLevel> - <VariableName><ControlLevel> 
namescontrasts = paste(x[x!="baseline"], "_vs_BaselineInLN", sep = "")
names(contrasts) = namescontrasts
contrasts

da_results = list()
for (i in 1:length(contrasts)) {
    print(i)
    da_results[[names(contrasts)[i]]] = testNhoods(mi, design = ~ 0 + condition_detailed, design.df = design.sub, model.contrasts = contrasts[i], fdr.weighting="graph-overlap", reduced.dim = milo.dim, norm.method="TMM")
}
saveRDS(da_results, sprintf("%s_milo.Rds",prefix))

da_results = readRDS(sprintf("%s_milo.Rds",prefix))
table(da_results[[1]]$SpatialFDR < 0.1)

pdf(sprintf("%s_UMAP.pdf", prefix), 10,10, useDingbats = F)
for (i in 1:length(da_results)) {
    print(names(da_results)[i])
    da_res = da_results[[i]]
    p = DA_UMAP(so = so, da_res = da_res, nhoodIndex = colnames(mi)[unlist(mi@nhoodIndex[da_res$Nhood])], umap_to_plot = sprintf("umap_%s",tolower(milo.dim)), title = names(da_results)[i])
    print(p)
}
dev.off()

pdf(sprintf("%s_plotDAbeeswarm.pdf", prefix), 10,10, useDingbats = F)
for (i in 1:length(da_results)) {
    print(names(da_results)[i])
    da_res = da_results[[i]]
    coldata_col = "Cluster_totalvi20240525rmigtsample_Res0.5"
    da_res = annotateNhoods(mi, da_res , coldata_col = coldata_col)
    da_res[[coldata_col]] = ifelse(da_res[[sprintf("%s_fraction",coldata_col)]] < 0.7, "Mixed", da_res[[coldata_col]])
    #alpha = max(da_res$SpatialFDR[da_res$PValue<0.05]) if using miloR::plotDAbeeswarm
    #y_lim = round(max(abs(da_res$logFC)))*1.1
    da_res[[coldata_col]] = factor(da_res[[coldata_col]], levels = c(levels(so[[coldata_col]][,1]), "Mixed"))
    p = MyplotDAbeeswarm(da_res, group.by = coldata_col, alpha = 0.05) + scale_color_gradient2(low = ColorRamp[1], mid = ColorRamp[50], high = ColorRamp[100],midpoint = 0 ) + ggtitle(names(da_results)[i]) #+ scale_color_gradient2(low = viridis(100)[1], mid = viridis(100)[50], high = viridis(100)[100], midpoint = 0 ) 
    tryCatch(print(p), error = function(e) {message("too few data points")})
}
dev.off()

```


TO DO next
sex in healthy tissues #specific genes: c("Xist","Eif2s3y","Ddx3y","Kdm5d","Uty","Gm34590")
Sex effect in one disease, in different tissues
```{r}
prefix = "milo_totalvi_daresults_sex"
#da_results = readRDS(sprintf("%s_daresults.Rds", prefix))
table(mi$sex, mi$organ_simplified)
#foxus on organs with male and female cells in healthy

group = as.character(mi$sex)
group[!mi$condition_broad %in% c("healthy")] = "notincluded"
group[mi$sex %in% c("NA.")] = "notincluded"
group[!mi$organ_simplified %in% c("colon", "kidney", "liver", "lung", "lymph.node", "skin", "small.intestine", "spleen", "submandibular.gland")] = "notincluded"
group = factor(group)
table(group)
x = levels(group)
x = x[x != "notincluded"]

design.sub = design[design$sex %in% c("female", "male") & design$condition_broad %in% c("healthy") & design$organ_simplified %in% c("colon", "kidney", "liver", "lung", "lymph.node", "skin", "small.intestine", "spleen", "submandibular.gland"),]
design.sub$sex = factor(design.sub$sex)
design.sub$organ_simplified = factor(design.sub$organ_simplified)
design.sub$condition_broad = factor(design.sub$condition_broad)

contrasts = "sexfemale-sexmale"
names(contrasts) = "Female_vs_MaleInHealthy"
contrasts

da_results = list()
for (i in 1:length(contrasts)) {
    print(i)
    da_results[[names(contrasts)[i]]] = testNhoods(mi, design = ~ 0 + sex, design.df = design.sub, model.contrasts = contrasts[i], fdr.weighting="graph-overlap", reduced.dim = milo.dim, norm.method="TMM")
}

table(da_results[[1]]$SpatialFDR < 0.1)

#UMAP plots
library("patchwork")
library("EnhancedVolcano")
library("scater")

umap_pl = plotReducedDim(mi[,mi$condition_broad %in% c("healthy") & mi$sex %in% c("female", "male")  & mi$organ_simplified %in% c("colon", "kidney", "liver", "lung", "lymph.node", "skin", "small.intestine", "spleen", "submandibular.gland")], dimred = "UMAP_TOTALVI", colour_by="sex", text_by = "sex", text_size = 3, point_size=0.5) + guides(fill="none") #change to the same conditions as design.sub
for (i in 1:length(da_results)) {
    print(i)
    da_results[[i]]$log2FC = da_results[[i]]$logFC/log(2)
    pdf(sprintf("%s_%s_volcano.pdf", prefix, names(da_results)[i]), 10,10)
    p = EnhancedVolcano(da_results[[i]], lab = da_results[[i]]$Nhood, x = 'log2FC', y = 'SpatialFDR', pCutoff = 0.1, FCcutoff = 1, col=c('black', 'green', 'blue', 'red3'),title= names(da_results)[i],subtitle = NULL ) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
    print(p)
    dev.off()
    nh_graph_pl = plotNhoodGraphDA(mi, da_results[[i]], layout="UMAP_TOTALVI",alpha=0.1) + ggtitle(names(da_results)[i] )
    pdf(sprintf("%s_%s_UMAP.pdf", prefix, names(da_results)[i]), 15,10)
    print(umap_pl + nh_graph_pl + plot_layout(guides="collect"))
    dev.off()
}

# logFC vs 1D UMAP
for (i in 1:length(da_results)) {
    print(i)
    da_results[[i]]$cell_index = colnames(mi)[unlist(mi@nhoodIndex)]
    da_results[[i]]$cell_index_umap1 = reducedDims(mi)[["UMAP_TOTALVI_1D"]][da_results[[i]]$cell_index,]
}

da_results_long = lapply(names(da_results), function(name) { da_results[[name]] %>% mutate(id = name) }) # Add an id column
da_results_long = do.call(rbind, da_results_long)

saveRDS(da_results, sprintf("%s_daresults.Rds", prefix))
write.table(da_results_long, file = sprintf("%s_daresults.csv", prefix),sep = ",", row.names = F, col.names = T, quote = F)

#ggplot(da_results[[i]], aes(x = cell_index_umap1, y = log2FC)) + geom_point(aes(color = SpatialFDR < 0.1)) + geom_smooth() + theme_bw()
p = ggplot(da_results_long) + geom_smooth(aes(x = cell_index_umap1, y = log2FC, group = id, color = id)) + theme_bw() + scale_color_manual(values = mypal) + theme(legend.title = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
p2 = ggplot(da_results_long) + geom_smooth(aes(x = cell_index_umap1, y = log2FC)) + theme_bw() + theme(legend.title = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
pdf(sprintf("%s_FCumap1D.pdf", prefix), 15,10, useDingbats = F)
print(p)
print(p2)
dev.off()

##DEG and DEP in the female neighborhood: CAREFUL the analysis isn't female vs male but cells enriched in the female neighborhoods!! (containing male and female)
mi = logNormCounts(mi)

da_nhood_genes = list()
da_nhood_proteins = list()

i = "Female_vs_MaleInHealthy"

group1 = da_results[[i]]$Nhood[da_results[[i]]$NhoodGroup == 1]
group0 = da_results[[i]]$Nhood[da_results[[i]]$NhoodGroup == 0]
group1 = names(which(rowSums(mi@nhoods[,group1])>1 & mi$condition_broad %in% c("healthy") & mi$sex %in% c("female", "male")  & mi$organ_simplified %in% c("colon", "kidney", "liver", "lung", "lymph.node", "skin", "small.intestine", "spleen", "submandibular.gland")))
group0 = names(which(rowSums(mi@nhoods[,group0])>1 & mi$condition_broad %in% c("healthy") & mi$sex %in% c("female", "male")  & mi$organ_simplified %in% c("colon", "kidney", "liver", "lung", "lymph.node", "skin", "small.intestine", "spleen", "submandibular.gland")))
so$groups = NA
so$groups[colnames(so) %in% group1] = "group1"
so$groups[colnames(so) %in% group0] = "group0"
Idents(so) = "groups"
so = NormalizeData(so,assay = "ADT", normalization.method = "CLR", verbose = T)
da_nhood_proteins[[i]] = FindMarkers(so, ident.1 = 'group1', ident.2 = 'group0', assay = 'ADT', slot = "data", logfc.threshold = 0, min.pct = 0, pseudocount.use = 1)

p = EnhancedVolcano(da_nhood_proteins[[i]], lab = rownames(da_nhood_proteins[[i]]), x = 'avg_log2FC', y = 'p_val', pCutoff = 0.05, FCcutoff = 0.5,drawConnectors = TRUE, col=c('black', 'black', 'black', 'red3'),subtitle = NULL, title= i ) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
pdf(sprintf("%s_%s_proteinvolcano.pdf", prefix, i), 10, 10, useDingbats = F)
print(p)
dev.off()

da_nhood_genes[[i]] = FindMarkers(so, ident.1 = 'group1', ident.2 = 'group0', assay = 'RNA', slot = "data", logfc.threshold = 0, min.pct = 0.1, pseudocount.use = 1)

da_nhood_genes[[i]][c("Xist","Eif2s3y","Ddx3y","Kdm5d","Uty","Gm34590"),]

p = EnhancedVolcano(da_nhood_genes[[i]], lab = rownames(da_nhood_genes[[i]]), x = 'avg_log2FC', y = 'p_val', pCutoff = 0.05, FCcutoff = 0.5, drawConnectors = TRUE, col=c('black', 'black', 'black', 'red3'),subtitle = NULL, title= i ) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
pdf(sprintf("%s_%s_genevolcano.pdf", prefix, i), 10, 10, useDingbats = F)
print(p)
dev.off()

# write DEG and DEP
da_nhood_genes_long = lapply(names(da_nhood_genes), function(name) { da_nhood_genes[[name]] %>% mutate(id = name) }) # Add an id column
da_nhood_genes_long = do.call(rbind, da_nhood_genes_long)
saveRDS(da_nhood_genes, sprintf("%s_da_nhood_genes.Rds", prefix))
write.table(da_nhood_genes_long, file = sprintf("%s_da_nhood_genes.csv", prefix),sep = ",", row.names = F, col.names = T, quote = F)

da_nhood_proteins

da_nhood_proteins_long = lapply(names(da_nhood_proteins), function(name) { da_nhood_proteins[[name]] %>% mutate(id = name) }) # Add an id column
da_nhood_proteins_long = do.call(rbind, da_nhood_proteins_long)
saveRDS(da_nhood_proteins_long, sprintf("%s_da_nhood_proteins.Rds", prefix))
write.table(da_nhood_proteins_long, file = sprintf("%s_da_nhood_proteins.csv", prefix),sep = ",", row.names = F, col.names = T, quote = F)

```






##########


UMAP plots
```{r}
library("patchwork")
library("EnhancedVolcano")
library("scater")

umap_pl = plotReducedDim(mi, dimred = "UMAP_TOTALVI", colour_by="organ_simplified", text_by = "organ_simplified", text_size = 3, point_size=0.5) + guides(fill="none")
for (i in 1:length(da_results)) {
    print(i)
    da_results[[i]]$log2FC = da_results[[i]]$logFC/log(2)
    pdf(sprintf("%s_%s_volcano.pdf", prefix, names(da_results)[i]), 10,10)
    p = EnhancedVolcano(da_results[[i]], lab = da_results[[i]]$Nhood, x = 'log2FC', y = 'SpatialFDR', pCutoff = 0.1, FCcutoff = 1, col=c('black', 'green', 'blue', 'red3'),title= names(da_results)[i],subtitle = NULL ) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
    print(p)
    dev.off()
    nh_graph_pl = plotNhoodGraphDA(mi, da_results[[i]], layout="UMAP_TOTALVI",alpha=0.1) + ggtitle(names(da_results)[i] )
    pdf(sprintf("%s_%s_UMAP.pdf", prefix, names(da_results)[i]), 15,10)
    print(umap_pl + nh_graph_pl + plot_layout(guides="collect"))
    dev.off()
}

# logFC vs 1D UMAP
so = RunUMAP(so, dims = 1:30, reduction = "totalvi", n.components = 1, reduction.name = "umap_totalvi_1d")

all(rownames(reducedDims(mi)[["UMAP_TOTALVI"]]) == rownames(so[["umap_totalvi_1d"]]@cell.embeddings))
reducedDims(mi)[["UMAP_TOTALVI_1D"]] = so[["umap_totalvi_1d"]]@cell.embeddings

#i = "colon_vs_OtherOrgansInHealthy"
#da_results[[i]]$cell_index = colnames(mi)[unlist(mi@nhoodIndex)]
#da_results[[i]]$cell_index_umap1 = reducedDims(mi)[["UMAP_TOTALVI_1D"]][da_results[[i]]$cell_index,]
#ggplot(da_results[[i]], aes(x = cell_index_umap1, y = log2FC)) + geom_point(aes(color = SpatialFDR < 0.1)) + geom_smooth() + theme_bw()
#ggplot(da_results_long, aes(x = cell_index_umap1, y = log2FC, group = id)) + geom_smooth() + theme_bw()

for (i in 1:length(da_results)) {
    print(i)
    da_results[[i]]$cell_index = colnames(mi)[unlist(mi@nhoodIndex)]
    da_results[[i]]$cell_index_umap1 = reducedDims(mi)[["UMAP_TOTALVI_1D"]][da_results[[i]]$cell_index,]
}

da_results_long = lapply(names(da_results), function(name) { da_results[[name]] %>% mutate(id = name) }) # Add an id column
da_results_long = do.call(rbind, da_results_long)

saveRDS(da_results, sprintf("%s_daresults.Rds", prefix))
write.table(da_results_long, file = sprintf("%s_daresults.csv", prefix),sep = ",", row.names = F, col.names = T, quote = F)

#ggplot(da_results[[i]], aes(x = cell_index_umap1, y = log2FC)) + geom_point(aes(color = SpatialFDR < 0.1)) + geom_smooth() + theme_bw()
p = ggplot(da_results_long) + geom_smooth(aes(x = cell_index_umap1, y = log2FC, group = id, color = id)) + theme_bw() + scale_color_manual(values = mypal) + theme(legend.title = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
p2 = ggplot(da_results_long) + geom_smooth(aes(x = cell_index_umap1, y = log2FC)) + theme_bw() + theme(legend.title = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
pdf(sprintf("%s_FCumap1D.pdf", prefix), 15,10, useDingbats = F)
print(p)
print(p2)
dev.off()

```

make contrasts one condition vs all others in colon 
milo_totalvi_daresults_ConditionsbroadInColon.Rds
milo_totalvi_daresults_ConditionsbroadInColon.csv
milo_totalvi_daresults_ConditionsbroadInColon_XXXX_UMAP.pdf
milo_totalvi_daresults_ConditionsbroadInColon_FCumap1D.pdf
milo_totalvi_daresults_ConditionsbroadInColon_genevolcano.pdf
milo_totalvi_daresults_ConditionsbroadInColon_proteinvolcano.pdf
milo_totalvi_daresults_ConditionsbroadInColon_da_nhood_markers.Rds and csv
milo_totalvi_daresults_ConditionsbroadInColon_da_nhood_proteins.Rds and csv

redo the DEG using seurat, not milo!
da_nhood_genes = list()
```{r}

prefix = "milo_totalvi_daresults_ConditionsbroadInColon"
#da_results = readRDS(sprintf("%s_daresults.Rds", prefix))

group = as.character(mi$condition_broad)
group[!mi$organ_simplified %in% c("colon")] = "notincluded"
group = factor(group)
x = levels(group)
x = x[x != "notincluded"]

design.sub = design[design$organ_simplified %in% c("colon"),]
design.sub$condition_broad = factor(design.sub$condition_broad)

contrasts = sapply(x, FUN = function(i) sprintf("condition_broad%s-condition_broadhealthy", i)) #"organ_simplifiedspleen - organ_simplifiedcolon" # the syntax is <VariableName><ConditionLevel> - <VariableName><ControlLevel> 
namescontrasts = paste(x, "_vs_HealthytInColon", sep = "")
names(contrasts) = namescontrasts
contrasts
contrasts = contrasts[!names(contrasts) %in% "healthy_vs_HealthytInColon"]
contrasts["Healthy_vs_DiseaseInColon"] = sprintf("condition_broadhealthy-(%s)/%s", paste(sprintf("condition_broad%s",x[x!= "healthy"]), collapse = "+"), length(x)-1) #"organ_simplifiedspleen - organ_simplifiedcolon" # the syntax is <VariableName><ConditionLevel> - <VariableName><ControlLevel> 

da_results = list()
for (i in 1:length(contrasts)) {
    print(i)
    da_results[[names(contrasts)[i]]] = testNhoods(mi, design = ~ 0 + condition_broad, design.df = design.sub, model.contrasts = contrasts[i], fdr.weighting="graph-overlap", reduced.dim = milo.dim, norm.method="TMM")
}

table(da_results[[1]]$SpatialFDR < 0.1)

#UMAP plots
library("patchwork")
library("EnhancedVolcano")
library("scater")

umap_pl = plotReducedDim(mi[,mi$organ_simplified == "colon"], dimred = "UMAP_TOTALVI", colour_by="condition_broad", text_by = "condition_broad", text_size = 3, point_size=0.5) + guides(fill="none")
for (i in 1:length(da_results)) {
    print(i)
    da_results[[i]]$log2FC = da_results[[i]]$logFC/log(2)
    pdf(sprintf("%s_%s_volcano.pdf", prefix, names(da_results)[i]), 10,10)
    p = EnhancedVolcano(da_results[[i]], lab = da_results[[i]]$Nhood, x = 'log2FC', y = 'SpatialFDR', pCutoff = 0.1, FCcutoff = 1, col=c('black', 'green', 'blue', 'red3'),title= names(da_results)[i,],subtitle = NULL ) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
    print(p)
    dev.off()
    nh_graph_pl = plotNhoodGraphDA(mi, da_results[[i]], layout="UMAP_TOTALVI",alpha=0.1) + ggtitle(names(da_results)[i] )
    pdf(sprintf("%s_%s_UMAP.pdf", prefix, names(da_results)[i]), 15,10)
    print(umap_pl + nh_graph_pl + plot_layout(guides="collect"))
    dev.off()
}

# logFC vs 1D UMAP
for (i in 1:length(da_results)) {
    print(i)
    da_results[[i]]$cell_index = colnames(mi)[unlist(mi@nhoodIndex)]
    da_results[[i]]$cell_index_umap1 = reducedDims(mi)[["UMAP_TOTALVI_1D"]][da_results[[i]]$cell_index,]
}

da_results_long = lapply(names(da_results), function(name) { da_results[[name]] %>% mutate(id = name) }) # Add an id column
da_results_long = do.call(rbind, da_results_long)

saveRDS(da_results, sprintf("%s_daresults.Rds", prefix))
write.table(da_results_long, file = sprintf("%s_daresults.csv", prefix),sep = ",", row.names = F, col.names = T, quote = F)

#ggplot(da_results[[i]], aes(x = cell_index_umap1, y = log2FC)) + geom_point(aes(color = SpatialFDR < 0.1)) + geom_smooth() + theme_bw()
p = ggplot(da_results_long) + geom_smooth(aes(x = cell_index_umap1, y = log2FC, group = id, color = id)) + theme_bw() + scale_color_manual(values = mypal) + theme(legend.title = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
p2 = ggplot(da_results_long) + geom_smooth(aes(x = cell_index_umap1, y = log2FC)) + theme_bw() + theme(legend.title = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
pdf(sprintf("%s_FCumap1D.pdf", prefix), 15,10, useDingbats = F)
print(p)
print(p2)
dev.off()

##DEG and DEP in the bacteria neighborhoods
mi = logNormCounts(mi)

da_nhood_markers = list()
da_nhood_proteins = list()

i = "bacteria_vs_HealthytInColon"
da_results[[i]]$NhoodGroup = as.numeric(da_results[[i]]$SpatialFDR < 0.1 & da_results[[i]]$log2FC > 1)
table(da_results[[i]]$NhoodGroup)
da_nhood_markers[[i]] = findNhoodGroupMarkers(mi, da_results[[i]])
da_nhood_markers[[i]]$log2FC_1 = da_nhood_markers[[i]]$logFC_1/log(2)

p = EnhancedVolcano(da_nhood_markers[[i]], lab = da_nhood_markers[[i]]$GeneID, x = 'log2FC_1', y = 'adj.P.Val_1', pCutoff = 0.1, FCcutoff = 0.6,drawConnectors = TRUE, col=c('black', 'black', 'black', 'red3'),title= i,subtitle = NULL) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
pdf(sprintf("%s_%s_genevolcano.pdf", prefix, i), 10, 10, useDingbats = F)
print(p)
dev.off()
 
#da_nhood_markers[[i]] %>% arrange(desc(logFC_1), adj.P.Val_0) %>% head(10)
#da_nhood_markers[[i]] %>% arrange(logFC_1, adj.P.Val_0) %>% head(10)
#da_nhood_markers[[i]][da_nhood_markers[[i]]$GeneID %in% "Foxp3",]

group1 = da_results[[i]]$Nhood[da_results[[i]]$NhoodGroup == 1]
group0 = da_results[[i]]$Nhood[da_results[[i]]$NhoodGroup == 0]
group1 = names(which(rowSums(mi@nhoods[,group1])>1 & mi$organ_simplified == "colon"))
group0 = names(which(rowSums(mi@nhoods[,group0])>1 & mi$organ_simplified == "colon"))
so$groups = NA
so$groups[colnames(so) %in% group1] = "group1"
so$groups[colnames(so) %in% group0] = "group0"
Idents(so) = "groups"
so = NormalizeData(so,assay = "ADT", normalization.method = "CLR", verbose = T)
da_nhood_proteins[[i]] = FindMarkers(so, ident.1 = 'group1', ident.2 = 'group0', assay = 'ADT', slot = "data", logfc.threshold = 0, min.pct = 0, pseudocount.use =0)

p = EnhancedVolcano(da_nhood_proteins[[i]], lab = rownames(da_nhood_proteins[[i]]), x = 'avg_log2FC', y = 'p_val', pCutoff = 0.05, FCcutoff = 0.5,drawConnectors = TRUE, col=c('black', 'black', 'black', 'red3'),subtitle = NULL, title= i ) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
pdf(sprintf("%s_%s_proteinvolcano.pdf", prefix, i), 10, 10, useDingbats = F)
print(p)
dev.off()

##DEG and DEP in the healthy neighborhoods
i = "Healthy_vs_DiseaseInColon"
#mi = logNormCounts(mi)
da_results[[i]]$NhoodGroup = as.numeric(da_results[[i]]$SpatialFDR < 0.1 & da_results[[i]]$log2FC > 1)
table(da_results[[i]]$NhoodGroup)
da_nhood_markers[[i]] = findNhoodGroupMarkers(mi, da_results[[i]]) #aggregate.samples = TRUE, sample_col = "sample_id"
da_nhood_markers[[i]]$log2FC_1 = da_nhood_markers[[i]]$logFC_1/log(2)

p = EnhancedVolcano(da_nhood_markers[[i]], lab = da_nhood_markers[[i]]$GeneID, x = 'log2FC_1', y = 'adj.P.Val_1', pCutoff = 0.1, FCcutoff = 0.6,drawConnectors = TRUE, col=c('black', 'black', 'black', 'red3'),title= i ) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
pdf(sprintf("%s_%s_genevolcano.pdf", prefix, i), 10, 10, useDingbats = F)
print(p)
dev.off()

#da_nhood_markers[[i]] %>% arrange(desc(logFC_1), adj.P.Val_0) %>% head(10)
#da_nhood_markers[[i]] %>% arrange(logFC_1, adj.P.Val_0) %>% head(10)
#da_nhood_markers[[i]][da_nhood_markers[[i]]$GeneID %in% "Foxp3",]

group1 = da_results[[i]]$Nhood[da_results[[i]]$NhoodGroup == 1]
group0 = da_results[[i]]$Nhood[da_results[[i]]$NhoodGroup == 0]
group1 = names(which(rowSums(mi@nhoods[,group1])>1 & mi$organ_simplified == "colon"))
group0 = names(which(rowSums(mi@nhoods[,group0])>1 & mi$organ_simplified == "colon"))
so$groups = NA
so$groups[colnames(so) %in% group1] = "group1"
so$groups[colnames(so) %in% group0] = "group0"
Idents(so) = "groups"
so = NormalizeData(so,assay = "ADT", normalization.method = "CLR", verbose = T)
da_nhood_proteins[[i]] = FindMarkers(so, ident.1 = 'group1', ident.2 = 'group0', assay = 'ADT', slot = "data", logfc.threshold = 0, min.pct = 0, pseudocount.use =0)

p = EnhancedVolcano(da_nhood_proteins[[i]], lab = rownames(da_nhood_proteins[[i]]), x = 'avg_log2FC', y = 'p_val', pCutoff = 0.05, FCcutoff = 0.5,drawConnectors = TRUE, col=c('black', 'black', 'black', 'red3'),subtitle = NULL, title= i ) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
pdf(sprintf("%s_%s_proteinvolcano.pdf", prefix, i), 10, 10, useDingbats = F)
print(p)
dev.off()

da_nhood_markers_long = lapply(names(da_nhood_markers), function(name) { da_nhood_markers[[name]] %>% mutate(id = name) }) # Add an id column
da_nhood_markers_long = do.call(rbind, da_nhood_markers_long)
saveRDS(da_nhood_markers, sprintf("%s_da_nhood_markers.Rds", prefix))
write.table(da_nhood_markers_long, file = sprintf("%s_da_nhood_markers.csv", prefix),sep = ",", row.names = F, col.names = T, quote = F)

da_nhood_proteins

da_nhood_proteins_long = lapply(names(da_nhood_proteins), function(name) { da_nhood_proteins[[name]] %>% mutate(id = name) }) # Add an id column
da_nhood_proteins_long = do.call(rbind, da_nhood_proteins_long)
saveRDS(da_nhood_proteins_long, sprintf("%s_da_nhood_proteins.Rds", prefix))
write.table(da_nhood_proteins_long, file = sprintf("%s_da_nhood_proteins.csv", prefix),sep = ",", row.names = F, col.names = T, quote = F)



```

make contrasts Male vs Female 
milo_totalvi_daresults_sex.Rds
milo_totalvi_daresults_sex.csv
milo_totalvi_daresults_sex_UMAP.pdf
milo_totalvi_daresults_sex_FCumap1D.pdf
milo_totalvi_daresults_sex_daresults.Rds and csv
_UMAP.pdf
_FCumap1D.pdf
_genevolcano.pdf
_proteinvolcano.pdf
_da_nhood_markers.Rds and csv
_da_nhood_proteins.Rds and csv

sex specific genes: c("Xist","Eif2s3y","Ddx3y","Kdm5d","Uty","Gm34590")
```{r}
prefix = "milo_totalvi_daresults_sex"
#da_results = readRDS(sprintf("%s_daresults.Rds", prefix))
table(mi$sex, mi$organ_simplified)
#foxus on organs with male and female cells in healthy

group = as.character(mi$sex)
group[!mi$condition_broad %in% c("healthy")] = "notincluded"
group[mi$sex %in% c("NA.")] = "notincluded"
group[!mi$organ_simplified %in% c("colon", "kidney", "liver", "lung", "lymph.node", "skin", "small.intestine", "spleen", "submandibular.gland")] = "notincluded"
group = factor(group)
table(group)
x = levels(group)
x = x[x != "notincluded"]

design.sub = design[design$sex %in% c("female", "male") & design$condition_broad %in% c("healthy") & design$organ_simplified %in% c("colon", "kidney", "liver", "lung", "lymph.node", "skin", "small.intestine", "spleen", "submandibular.gland"),]
design.sub$sex = factor(design.sub$sex)
design.sub$organ_simplified = factor(design.sub$organ_simplified)
design.sub$condition_broad = factor(design.sub$condition_broad)

contrasts = "sexfemale-sexmale"
names(contrasts) = "Female_vs_MaleInHealthy"
contrasts

da_results = list()
for (i in 1:length(contrasts)) {
    print(i)
    da_results[[names(contrasts)[i]]] = testNhoods(mi, design = ~ 0 + sex, design.df = design.sub, model.contrasts = contrasts[i], fdr.weighting="graph-overlap", reduced.dim = milo.dim, norm.method="TMM")
}

table(da_results[[1]]$SpatialFDR < 0.1)

#UMAP plots
library("patchwork")
library("EnhancedVolcano")
library("scater")

umap_pl = plotReducedDim(mi[,mi$condition_broad %in% c("healthy") & mi$sex %in% c("female", "male")  & mi$organ_simplified %in% c("colon", "kidney", "liver", "lung", "lymph.node", "skin", "small.intestine", "spleen", "submandibular.gland")], dimred = "UMAP_TOTALVI", colour_by="sex", text_by = "sex", text_size = 3, point_size=0.5) + guides(fill="none") #change to the same conditions as design.sub
for (i in 1:length(da_results)) {
    print(i)
    da_results[[i]]$log2FC = da_results[[i]]$logFC/log(2)
    pdf(sprintf("%s_%s_volcano.pdf", prefix, names(da_results)[i]), 10,10)
    p = EnhancedVolcano(da_results[[i]], lab = da_results[[i]]$Nhood, x = 'log2FC', y = 'SpatialFDR', pCutoff = 0.1, FCcutoff = 1, col=c('black', 'green', 'blue', 'red3'),title= names(da_results)[i],subtitle = NULL ) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
    print(p)
    dev.off()
    nh_graph_pl = plotNhoodGraphDA(mi, da_results[[i]], layout="UMAP_TOTALVI",alpha=0.1) + ggtitle(names(da_results)[i] )
    pdf(sprintf("%s_%s_UMAP.pdf", prefix, names(da_results)[i]), 15,10)
    print(umap_pl + nh_graph_pl + plot_layout(guides="collect"))
    dev.off()
}

# logFC vs 1D UMAP
for (i in 1:length(da_results)) {
    print(i)
    da_results[[i]]$cell_index = colnames(mi)[unlist(mi@nhoodIndex)]
    da_results[[i]]$cell_index_umap1 = reducedDims(mi)[["UMAP_TOTALVI_1D"]][da_results[[i]]$cell_index,]
}

da_results_long = lapply(names(da_results), function(name) { da_results[[name]] %>% mutate(id = name) }) # Add an id column
da_results_long = do.call(rbind, da_results_long)

saveRDS(da_results, sprintf("%s_daresults.Rds", prefix))
write.table(da_results_long, file = sprintf("%s_daresults.csv", prefix),sep = ",", row.names = F, col.names = T, quote = F)

#ggplot(da_results[[i]], aes(x = cell_index_umap1, y = log2FC)) + geom_point(aes(color = SpatialFDR < 0.1)) + geom_smooth() + theme_bw()
p = ggplot(da_results_long) + geom_smooth(aes(x = cell_index_umap1, y = log2FC, group = id, color = id)) + theme_bw() + scale_color_manual(values = mypal) + theme(legend.title = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
p2 = ggplot(da_results_long) + geom_smooth(aes(x = cell_index_umap1, y = log2FC)) + theme_bw() + theme(legend.title = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
pdf(sprintf("%s_FCumap1D.pdf", prefix), 15,10, useDingbats = F)
print(p)
print(p2)
dev.off()

##DEG and DEP in the female neighborhood: CAREFUL the analysis isn't female vs male but cells enriched in the female neighborhoods!! (containing male and female)
mi = logNormCounts(mi)

da_nhood_genes = list()
da_nhood_proteins = list()

i = "Female_vs_MaleInHealthy"

group1 = da_results[[i]]$Nhood[da_results[[i]]$NhoodGroup == 1]
group0 = da_results[[i]]$Nhood[da_results[[i]]$NhoodGroup == 0]
group1 = names(which(rowSums(mi@nhoods[,group1])>1 & mi$condition_broad %in% c("healthy") & mi$sex %in% c("female", "male")  & mi$organ_simplified %in% c("colon", "kidney", "liver", "lung", "lymph.node", "skin", "small.intestine", "spleen", "submandibular.gland")))
group0 = names(which(rowSums(mi@nhoods[,group0])>1 & mi$condition_broad %in% c("healthy") & mi$sex %in% c("female", "male")  & mi$organ_simplified %in% c("colon", "kidney", "liver", "lung", "lymph.node", "skin", "small.intestine", "spleen", "submandibular.gland")))
so$groups = NA
so$groups[colnames(so) %in% group1] = "group1"
so$groups[colnames(so) %in% group0] = "group0"
Idents(so) = "groups"
so = NormalizeData(so,assay = "ADT", normalization.method = "CLR", verbose = T)
da_nhood_proteins[[i]] = FindMarkers(so, ident.1 = 'group1', ident.2 = 'group0', assay = 'ADT', slot = "data", logfc.threshold = 0, min.pct = 0, pseudocount.use = 1)

p = EnhancedVolcano(da_nhood_proteins[[i]], lab = rownames(da_nhood_proteins[[i]]), x = 'avg_log2FC', y = 'p_val', pCutoff = 0.05, FCcutoff = 0.5,drawConnectors = TRUE, col=c('black', 'black', 'black', 'red3'),subtitle = NULL, title= i ) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
pdf(sprintf("%s_%s_proteinvolcano.pdf", prefix, i), 10, 10, useDingbats = F)
print(p)
dev.off()

da_nhood_genes[[i]] = FindMarkers(so, ident.1 = 'group1', ident.2 = 'group0', assay = 'RNA', slot = "data", logfc.threshold = 0, min.pct = 0.1, pseudocount.use = 1)

da_nhood_genes[[i]][c("Xist","Eif2s3y","Ddx3y","Kdm5d","Uty","Gm34590"),]

p = EnhancedVolcano(da_nhood_genes[[i]], lab = rownames(da_nhood_genes[[i]]), x = 'avg_log2FC', y = 'p_val', pCutoff = 0.05, FCcutoff = 0.5, drawConnectors = TRUE, col=c('black', 'black', 'black', 'red3'),subtitle = NULL, title= i ) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
pdf(sprintf("%s_%s_genevolcano.pdf", prefix, i), 10, 10, useDingbats = F)
print(p)
dev.off()

# write DEG and DEP
da_nhood_genes_long = lapply(names(da_nhood_genes), function(name) { da_nhood_genes[[name]] %>% mutate(id = name) }) # Add an id column
da_nhood_genes_long = do.call(rbind, da_nhood_genes_long)
saveRDS(da_nhood_genes, sprintf("%s_da_nhood_genes.Rds", prefix))
write.table(da_nhood_genes_long, file = sprintf("%s_da_nhood_genes.csv", prefix),sep = ",", row.names = F, col.names = T, quote = F)

da_nhood_proteins

da_nhood_proteins_long = lapply(names(da_nhood_proteins), function(name) { da_nhood_proteins[[name]] %>% mutate(id = name) }) # Add an id column
da_nhood_proteins_long = do.call(rbind, da_nhood_proteins_long)
saveRDS(da_nhood_proteins_long, sprintf("%s_da_nhood_proteins.Rds", prefix))
write.table(da_nhood_proteins_long, file = sprintf("%s_da_nhood_proteins.csv", prefix),sep = ",", row.names = F, col.names = T, quote = F)

```


TO DO PLOTS: not a graph by add a ggplot layer to the UMAP with the index cells only 
size and color as log2FC

```{r}
# mi@nhoodIndex represent the index cell
unlist(mi@nhoodIndex)
colnames(mi)[unlist(mi@nhoodIndex)]
plot(so[["umap_totalvi"]]@cell.embeddings[colnames(mi)[unlist(mi@nhoodIndex)],])
# nhoodCounts could be used to calculate the nhood size if wanted to plot
da_results.1$cell_index = colnames(mi)[unlist(mi@nhoodIndex)]
da_results.1$cell_index_umap1 = so[["umap_totalvi"]]@cell.embeddings[colnames(mi)[unlist(mi@nhoodIndex)],1]
da_results.1$cell_index_umap2 = so[["umap_totalvi"]]@cell.embeddings[colnames(mi)[unlist(mi@nhoodIndex)],2]

write.table(da_results.1, file = "milo_da_results.1_k30_prop10.csv", sep = ",", row.names = F,col.names = T)

```

Mi findNhoodGroupMarkers: don't like it because one vs all and it takes all cells from all samples in the neighborhood, regardless of whether it was included in the initial diff analysis of neighborhoods...
```{r}
da_nhood_markers = list()
da_nhood_proteins = list()

i = "Female_vs_MaleInHealthy"
da_results[[i]]$NhoodGroup = as.numeric(da_results[[i]]$SpatialFDR < 0.1 & da_results[[i]]$log2FC > 1)
table(da_results[[i]]$NhoodGroup)
da_nhood_markers[[i]] = findNhoodGroupMarkers(mi, da_results[[i]])
da_nhood_markers[[i]]$log2FC_1 = da_nhood_markers[[i]]$logFC_1/log(2)

p = EnhancedVolcano(da_nhood_markers[[i]], lab = da_nhood_markers[[i]]$GeneID, x = 'log2FC_1', y = 'adj.P.Val_1', pCutoff = 0.1, FCcutoff = 0.6,drawConnectors = TRUE, col=c('black', 'black', 'black', 'red3'),title= i,subtitle = NULL) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
pdf(sprintf("%s_%s_genevolcano.pdf", prefix, i), 10, 10, useDingbats = F)
print(p)
dev.off()
 
#da_nhood_markers[[i]] %>% arrange(desc(logFC_1), adj.P.Val_0) %>% head(10)
#da_nhood_markers[[i]] %>% arrange(logFC_1, adj.P.Val_0) %>% head(10)
#da_nhood_markers[[i]][da_nhood_markers[[i]]$GeneID %in% "Foxp3",]
```


```{r}
table(mi$condition_broad, mi$organ_simplified)
```
               B16 tumor blood bone marrow
  allergy               0     0           0
  autoimmune            0     0           0
  bacteria              0     0           0
  fungus                0     0           0
  healthy               0   203         695
  mutiinfection         0     0           0
  parasite              0     0           0
  tumor               475     0           0
  virus                 0     0         436
               
                central nervous system (brain and spine) colon decidua
  allergy                                              0     0       0
  autoimmune                                           5   395       0
  bacteria                                             0    51       0
  fungus                                               0   159       0
  healthy                                              0  2005      91
  mutiinfection                                        0     0       0
  parasite                                             0   160       0
  tumor                                                0     0       0
  virus                                                0     0       0
               
                endocrine pancreas kidney liver lung lymph node mammary gland
  allergy                        0      0     0  278         58             0
  autoimmune                   330      0     0   40        274             0
  bacteria                       0      0     0  129         71             0
  fungus                         0      0     0  324        210             0
  healthy                        0    102   114  506       3905            61
  mutiinfection                  0      0     0    0          0             0
  parasite                       0      0     0    0          0             0
  tumor                          0      0     0    0          0             0
  virus                          0      0     6    8       1257             0
               
                peritoneal cavity prostate gland skin small intestine spleen
  allergy                       0              0    0               0      0
  autoimmune                    0              0    0              33    684
  bacteria                      0              0    1               0      0
  fungus                        0              0    5               0      0
  healthy                     104              0 1079            1615   3604
  mutiinfection                 0              0    0               0    263
  parasite                      0              0    0               0      0
  tumor                         0              0    0               0      0
  virus                         0              3    6             236   1928
               
                submandibular gland synovial fluid uterus
  allergy                         0              0      0
  autoimmune                     49             18      0
  bacteria                        0              0    431
  fungus                          0              0      0
  healthy                        10              0     72
  mutiinfection                   0              0      0
  parasite                        0              0      0
  tumor                           0              0      0
  virus                           9              0      0


**Study disease effect in a specific organs: milo in TOTALVI space in COLON, LUNG**
rerun UMAP in colon cells only
milo
highlight autoimmune, bacteria, fungus, parasite
highlight specific diseases and bugs too

```{r}

```

**Study disease effect in a specific organ: milo in TOTALVI space in LUNG**

**Study disease effect: milo in TOTALVI space done removing the organ_simplified confounding**


