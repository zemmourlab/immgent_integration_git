---
title: "misc"
output: html_document
date: "2025-11-13"
author: "David Zemmour"
editor_options: 
  chunk_output_type: console
---

**Initialize: load libraries and custom functions**

```{bash}
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=jfkfloor2 --qos=jfkfloor2 --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=beagle3-bigmem --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=zemmour-hm --qos=zemmour --nodes=1 
sinteractive --time=03:00:00 --account=pi-zemmour --partition=caslake --nodes=1 --mem=96GB

module load python/anaconda-2022.05 
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13
source activate /project/zemmour/david/envs/scvi_20240315
#source activate /project/zemmour/david/envs/r443
module load openblas/0.3.13

cd /project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96
R
```


```{r}
# setwd("~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/")
libs = c("ZemmourLib","forcats", "gridExtra","patchwork", "Matrix", "Seurat", "ggplot2", "dplyr", "reshape2", "ggrastr","scattermore", "RColorBrewer", "pals", "scales", "pheatmap", "rafalib") 
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))
#source("/project/jfkfloor2/zemmourlab/david/immgent/immgent_integration_git/custom_functions_david.R")

ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
ColorRamp = rev(rainbow(10, end = 4/6))
ColorRamp = rev(viridis(100))
ColorRamp = brewer.pal(9, "Blues")

#mycol = c("black","blue","red","darkgreen", "orange","purple", "cyan", "greenyellow",    "salmon", "magenta","pink", "tan", "brown") # c("magenta", "red",  "darkgreen", "cyan", "blue", "blue", "blue", "black", "blue", "blue", "blue", "blue", "orange")

mypal_level2 = immgent_colors$level2
mypal_level2["not classified"] = "black"
mypal_level2 = immgent_colors$level2_option2
mypal_level2["not classified"] = "black"
mypal_level1 = immgent_colors$level1
mypal_level1["not classified"] = "black"
mypal_organ = immgent_colors$organ_simplified

#Large Color palette
library("pals")
n = 70
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
mypal1 = unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals))))
mypal1 = mypal1[-4]
mypal = c(glasbey(), polychrome(), mypal1)
names(mypal) = NULL
#pal.bands(mypal, main="Colormap suggestions")
# mypal_organ = setNames(mypal, unique(so$organ_simplified))
# mypal_organ = mypal_organ[!is.na(names(mypal_organ))]
# mypal_level1 = setNames(mypal, unique(so$annotation_level1))
# mypal_level1 = mypal_level1[!is.na(names(mypal_level1))]
# mypal_level2 = setNames(mypal, unique(so_orig$annotation_level2))
# mypal_level2 = mypal_level2[!is.na(names(mypal_level2))]
# mypal_level2["CD4_cl18"] = "blue"
mypal_igt = setNames(mypal, unique(so_orig$IGT))
mypal_igt = mypal_igt[!is.na(names(mypal_igt))]

```

```{r}
# fig_dir = "~/google_drive_uchicago/ImmgenT/20250109_freeze/paper_cosmology/figures/bits"
# fig_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/paper_cosmology/figures/bits"

out_dir = "~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/misc_plots" 
out_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/misc_plots"

```


**Most up-to-date data**
on Midway
```{r}

# so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250513_clean.Rds") 
so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250710_clean.Rds") 
so_orig$annotation_level2[so_orig$annotation_level2 == "Treg_cl7"] = "Treg_cl1"
so_orig$annotation_level1 = factor(so_orig$annotation_level1, levels = c("CD8", "CD4", "Treg", "gdT", "CD8aa", "nonconv", "DN", "DP", "thymocyte"))

so = so_orig[,so_orig@meta.data %>% filter(organ_simplified != "thymus") %>% row.names()]
so = NormalizeData(so, assay = "RNA", normalization.method = "LogNormalize")


```

on Desktop
```{r}
setwd("~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/")
so_orig = readRDS("igt1_96_withtotalvi20250710_clean_ADTonly.Rds")
so_orig$annotation_level2[so_orig$annotation_level2 == "Treg_cl7"] = "Treg_cl1"
so_orig$annotation_level1 = factor(so_orig$annotation_level1, levels = c("CD8", "CD4", "Treg", "gdT", "CD8aa", "nonconv", "DN", "DP", "thymocyte"))

so = so_orig[,so_orig@meta.data %>% filter(organ_simplified != "thymus") %>% row.names()]
so = NormalizeData(so, assay = "RNA", normalization.method = "LogNormalize")


```


Load GP: L1 and F1
```{r}
library("flashier")
prefix = "topic"
prefix2 = "flashier20250215_alldata_backfit"
fit_flash = readRDS(sprintf("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/%s/%s/fit.Rds", prefix,prefix2))
fit = fit_flash

res = ldf(fit, type = "i")
L1 = with(res, L %*% diag(D)  ) #same as res$L %*% diag(res$D)
L1 = L1[colnames(so),]
all(colnames(so) == rownames(L1))
any(is.na(L1))
colnames(L1) = sprintf("F%s", 1:ncol(L1))
# sub_cells = sample(colnames(so_orig), 1500, replace = F)
# sub_cells = c(sample(colnames(so_orig)[so_orig$annotation_level1 %in% "Treg"], 1500, replace = F), sample(colnames(so_orig)[!so_orig$annotation_level1 %in% "Treg"], 1500, replace = F))
# sub_cells = c(so_orig@meta.data %>% filter(annotation_level1 == "Treg") %>% slice_sample(n = 1500, replace = FALSE) %>% pull(cellID),
#               so_orig@meta.data %>% filter(annotation_level1 != "Treg") %>% group_by(annotation_level1) %>% slice_sample(n = 100, replace = FALSE) %>% ungroup() %>% pull(cellID))

F1 = with(ldf(fit, type = "i"), F)
colnames(F1) = paste("F", 1:ncol(F1), sep = "")


# mdata_orig = read.table("metadata_20250513_mde.txt", header = T, sep = "\t")
mdata_orig = so@meta.data
```

**Figure 1B - Counting cells in immgenT**

per organ
```{r}
library(dplyr)

df <- so@meta.data 
df$organ_simplified2 = as.character(df$organ_simplified)
df$organ_simplified2[df$organ_simplified %in% c("spleen", "LN", "SLO", "blood")] = "spleen LN blood"
df$organ_simplified2[grepl(pattern = "colon|small intestine",df$organ_simplified)] = "gut"
df$organ_simplified2[grepl(pattern = "colon|small intestine",df$organ_simplified)] = "gut"
df$organ_simplified2[grepl(pattern = "synovial|prostate|uterus|pancreas|peritoneal|bone|kidney|liver|mammary|pancreas|placenta|thymus",df$organ_simplified)] = "other"

df2 <- df %>%
  filter(!is.na(organ_simplified2)) %>%
  count(organ_simplified2, name = "n") %>%
  mutate(organ_simplified2 = fct_reorder(organ_simplified2, n)) %>% arrange(n)
df2$organ_simplified2 = factor(df2$organ_simplified2, levels = c("spleen LN blood", "CNS", "submandibular gland", "lung", "gut", "skin", "other"))

# barplot with labels on bars
p1 = ggplot(df2, aes(x = organ_simplified2, y = n, fill = organ_simplified2)) +
  geom_col(width = 0.75) +
  geom_text(aes(label = comma(n)), vjust = -0.25, size = 3) +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0.02, 0.10))) +
  labs(title = "# cells by organ", x = NULL, y = "cells") +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    legend.position = "none"
  ) + scale_fill_brewer(palette = "Set3") + NoGrid()

pdf(sprintf("%s/barplot_cellcount_organ.pdf", out_dir), 10,5, useDingbats = F)
p1
dev.off()

```

per condition_broad
```{r}
library(dplyr)

df = so@meta.data 
df$condition_broad[df$condition_broad == "autoimmunity"] = "autoimmune"
df$condition_broad[df$condition_broad == "mutiinfection"] = "virus"

# df$condition_broad = as.character(df$condition_broad)
# df$organ_simplified2[df$organ_simplified %in% c("spleen", "LN", "SLO", "blood")] = "spleen LN blood"
# df$organ_simplified2[grepl(pattern = "colon|small intestine",df$organ_simplified)] = "gut"
# df$organ_simplified2[grepl(pattern = "colon|small intestine",df$organ_simplified)] = "gut"
# df$organ_simplified2[grepl(pattern = "synovial|prostate|uterus|pancreas|peritoneal|bone|kidney|liver|mammary|pancreas|placenta|thymus",df$organ_simplified)] = "other"

df2 <- df %>%
  filter(!is.na(condition_broad)) %>%
  count(condition_broad, name = "n") 

df2 = df2 %>%
  mutate(condition_broad = fct_reorder(condition_broad, n)) %>% arrange(n)
df2$condition_broad = factor(df2$condition_broad, levels = c("healthy", "allergy", "autoimmune", "bacteria", "virus", "parasite", "fungus", "cancer", "immunization", "allotransplant" ))
any(is.na(df2$condition_broad ))

# barplot with labels on bars
p = ggplot(df2, aes(x = rev(condition_broad), y = -n, fill = condition_broad)) +
    geom_col(width = 0.75) +
    geom_text(aes(label = comma(n)), hjust = 0, size = 3) +
    # geom_text(aes(y = 0, label = comma(n)), hjust = -0.25, size = 3) +
    scale_y_continuous(labels = comma, expand = expansion(mult = c(0.02, 0.10))) +
    labs(title = "# cells by organ", x = NULL, y = "cells") +
    coord_flip() +
    theme_bw(base_size = 12) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.x = element_blank(),
        legend.position = "none"
    ) + scale_fill_brewer(palette = "Set3") + NoGrid()
p

pdf(sprintf("%s/barplot_cellcount_conditionbroad.pdf", out_dir), 5,5, useDingbats = F)
p
dev.off()

```

**Figure 1C**
```{r}
igt = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/exp_id/20220428_exp_id_05_Skin/IGT5/dataset_clean.Rds')
# igt = Seurat::NormalizeData(igt, assay = "RNA", normalization.method = "LogNormalize")
igt@meta.data$sub = T

pdf(sprintf("%s/IGT5_UMAPs.pdf", out_dir), 5,5, useDingbats = F)
DimPlot(igt, reduction = "umap_rna", group.by = "RNA_clusters")
DimPlot(igt, reduction = "umap_adt", group.by = "RNA_clusters")
MyFeatureScatter(so = igt, assay = "ADT", slot = "data", feature1 = "TCRB", feature2 = "TCRGD", group.by = "sub", raster = F,highlight_size = 2)
MyFeatureScatter(so = igt, assay = "ADT", slot = "data", feature1 = "CD4", feature2 = "CD8B", group.by = "sub", raster = T, highlight_size = 2)
dev.off()

```

**Figure 2 - Integration**

MDE plots level1 (2A and S2A)
```{r}
pdf(sprintf("%s/MDE_level1.pdf", out_dir), 5,5, useDingbats = F)
p = DimPlot(object = so, reduction = "mde2_totalvi_20241006", group.by = "annotation_level1", raster = T, raster.dpi = c(1024,1024)) + scale_color_manual(values = mypal_level1) + NoGrid()
p + NoLegend()
dev.off()

pdf(sprintf("%s/MDE_level1_separated.pdf", out_dir), 10,10, useDingbats = F)
o = unique(so$annotation_level1)
for (o in unique(so$annotation_level1)) {
    print(o)
    p = MyDimPlotHighlight(seurat_object = so, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(so)[which(so$annotation_level1 %in% o)], highlight_column_name = "annotation_level1", pixels = c(1024, 1024), mycols = mypal_level1, title = o, highlight_size = 0.1, highlight_alpha = 0.5, print_plot1 = T, print_plot2 = T, labelclusters = T)
    print(p$plot3)
}
dev.off()

pdf(sprintf("%s/MDE_level1_separated2.pdf", out_dir), 5,5, useDingbats = F)
o = unique(so$annotation_level1)
for (o in unique(so$annotation_level1)) {
    print(o)
    p = DimPlot(object = so, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(1024,1024), cells.highlight = names(which(so$annotation_level1 == o)), cols.highlight = mypal_level1[o]) + NoLegend()
    print(p)
    
}
dev.off()

# DimPlot(object = so, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(1024,1024), cells.highlight = colnames(so), group.by = "annotation_level1", cols.highlight = mypal_level1, split.by = "annotation_level1") doesn't work

```

MDE plots organ (2F and S2B)
```{r}
tmp = so[,so@meta.data %>% filter(condition_broad == "healthy" & organ_simplified0 != "thymus") %>% row.names()]


pdf(sprintf("%s/MDE_organ_separated.pdf", out_dir), 10,10, useDingbats = F)
for (o in unique(tmp$organ_simplified0)) {
    print(o)
    p = MyDimPlotHighlight(seurat_object = tmp, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(tmp)[which(tmp$organ_simplified0 %in% o)], highlight_column_name = "organ_simplified0", pixels = c(1024, 1024), mycols = mypal_organ, title = o, highlight_size = 0.1, highlight_alpha = 0.5, print_plot1 = T, print_plot2 = T, labelclusters = T)
    print(p$plot1)
    print(p$plot2)
}
dev.off()

pdf(sprintf("%s/MDE_organ_separated_collevel1.pdf", out_dir), 10,10, useDingbats = F)
for (o in unique(tmp$organ_simplified0)) {
    print(o)
    p = MyDimPlotHighlight(seurat_object = tmp, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(tmp)[which(tmp$organ_simplified0 %in% o)], highlight_column_name = "annotation_level1", pixels = c(1024, 1024), mycols = mypal_level1, title = o, highlight_size = 0.1, highlight_alpha = 0.5, print_plot1 = T, print_plot2 = T, labelclusters = T)
    print(p$plot1)
    print(p$plot2)
}
dev.off()

pdf(sprintf("%s/MDE_organ_separated2.pdf", out_dir), 5,5, useDingbats = F)
for (o in unique(tmp$organ_simplified0)) {
    print(o)
    p = DimPlot(object = tmp, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(512,512), cells.highlight = names(which(tmp$organ_simplified0 == o)), cols.highlight = mypal_organ[o]) + ggtitle(label = o) + NoLegend()
    print(p)
    
}
dev.off()

pdf(sprintf("%s/MDE_organ_separated3.pdf", out_dir), 10,10, useDingbats = F)
p = DimPlot(object = tmp, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(512,512), group.by = "organ_simplified0", cols = mypal_organ,split.by = "organ_simplified0", ncol =  4) 
print(p)
dev.off()

pdf(sprintf("%s/MDE_organ_separated_collevel1b.pdf", out_dir), 10,10, useDingbats = F)
p = DimPlot(object = tmp, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(512,512), group.by = "annotation_level1", cols = mypal_level1,split.by = "organ_simplified0", ncol =  4) 
print(p)
dev.off()

##color = IGT
pdf(sprintf("%s/MDE_organ_separated_colIGT.pdf", out_dir), 10,10, useDingbats = F)
for (o in unique(tmp$organ_simplified0)) {
    print(o)
    p = MyDimPlotHighlight(seurat_object = tmp, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(tmp)[which(tmp$organ_simplified0 %in% o)], highlight_column_name = "IGT", pixels = c(1024, 1024), mycols = mypal_igt, title = o, highlight_size = 0.5, highlight_alpha = 0.5, print_plot1 = T, print_plot2 = T, labelclusters = T)
    print(p$plot1)
    print(p$plot2)
}
dev.off()

pdf(sprintf("%s/MDE_organ_separated_colIGTb.pdf", out_dir), 10,10, useDingbats = F)
p = DimPlot(object = tmp, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(512,512), group.by = "IGT", cols = mypal_igt,split.by = "organ_simplified0", ncol =  4) 
p
p + NoLegend()
dev.off()

```

Spleen standard (2E)
```{r}
pdf(sprintf("%s/MDE_spleenstandard.pdf", out_dir), 5,5, useDingbats = F)
p = MyDimPlotHighlight(seurat_object = so, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = names(which(so$spleen_standard == T)), highlight_column_name = "IGT", pixels = c(1024, 1024), mycols = mypal_igt, title = "", highlight_size = 0.1, highlight_alpha = 0.5, print_plot1 = T, print_plot2 = T, labelclusters = F)
p
    # p = DimPlot(object = so, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(512,512), cells.highlight = names(which(so$spleen_standard == T)), cols.highlight = mypal_organ[o]) + ggtitle(label = o) + NoLegend()
    # print(p)
dev.off()
```

FeatureScatter ADT (2B)
```{r}
so = so_orig[,so_orig@meta.data %>% filter(cite_seq == T, organ_simplified != "thymus") %>% row.names()]
so = NormalizeData(so, assay = "ADT", normalization.method = "LogNormalize")
features_list = list(c("TCRB", "TCRGD"),
                     c("CD4", "CD8B"),
                     c("CD8A", "CD8B")
                     )
thresholds = list("TCRB" = 3, "TCRGD" = 4,"CD4" = 4, "CD8B" = 5, "CD8A" = 4.5)

pdf(sprintf("%s/FeatureScatter_level1.pdf", out_dir), 3,3, useDingbats = F)
for (i in 1:length(features_list)) {
    feature1 = features_list[[i]][1]
    feature2 = features_list[[i]][2]
    th1 = thresholds[feature1][1] %>% as.numeric()
    th2 = thresholds[feature2][1] %>% as.numeric()
    p = FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level1", raster = T, pt.size = 1, plot.cor = F) + scale_color_manual(values = mypal_level1) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown") + NoLegend()
    print(p)
}
dev.off()

pdf(sprintf("%s/FeatureScatter_level1_split.pdf", out_dir), 15,3, useDingbats = F)
for (i in 1:length(features_list)) {
    print(i)
    feature1 = features_list[[i]][1]
    feature2 = features_list[[i]][2]
    th1 = thresholds[feature1][1] %>% as.numeric()
    th2 = thresholds[feature2][1] %>% as.numeric()
    p = FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level1", split.by = "annotation_level1", raster = T, pt.size = 1) + scale_color_manual(values = mypal_level1) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown") + NoLegend()
    print(p)
    
}
dev.off()

```

FeaturePlot (Midway3) (2C)
```{r}
so = so_orig[,so_orig@meta.data %>% filter(organ_simplified != "thymus") %>% row.names()]
so = NormalizeData(so, assay = "RNA", normalization.method = "LogNormalize")
pdf(sprintf("%s/FeaturePlot_MainMarkers_level1.pdf", out_dir), 12,15, useDingbats = F)
FeaturePlot(so, reduction = "mde2_totalvi_20241006", features = c("Foxp3", "Cd4", "Cd8b1", "Cd8a","Trdc", "Zbtb16"), order = T, cols = c("lightgrey", "blue"), raster = T,max.cutoff = "q95") + ggplot2::xlim(-2.5,2.5) + ggplot2::ylim(-2.5,2.5)#Trgc1, Trgv2
dev.off()

FeaturePlot(so, reduction = "mde2_totalvi_20241006", features = c("Foxp3"), order = T, cols = c("lightgrey", "blue"), raster = T, max.cutoff = "q90") + ggplot2::xlim(-2.5,2.5) + ggplot2::ylim(-2.5,2.5)#Trgc1, Trgv2


```


**Figure 2H - Biological conservation analysis: clustering in each batch**

colon IGT20, IGT24 and IGT27
```{r}
igt = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/exp_id/20220812_exp_id_13_ColonSI/IGT20/dataset_clean.Rds')
tmp = so_orig
tmp$RNA_clusters = NA
tmp$RNA_clusters = as.character(igt$RNA_clusters[match(colnames(tmp), colnames(igt))])
pdf(sprintf("%s/IGT20_UMAP_seuratclusters.pdf", out_dir), 5,5, useDingbats = F)
mypal_batch = setNames(mypal, unique(igt$RNA_clusters))
mypal_batch = mypal_batch[!is.na(names(mypal_batch))]
DimPlot(igt[,grepl("Colon", igt$sample_name)], reduction = "umap_rna", group.by = "RNA_clusters") + scale_color_manual(values = mypal_batch) + NoLegend() + NoGrid()
MyDimPlotHighlight(igt, umap_to_plot = "umap_rna", cells_to_highlight = colnames(igt)[grepl("Colon", igt$sample_name)], highlight_column_name = "RNA_clusters",mycols = mypal_batch, print_plot1 = F, print_plot2 = T, labelclusters = F, pixels = c(256, 256) )
# DimPlot(tmp[,colnames(igt)], reduction = "mde2_totalvi_20241006", group.by = "RNA_clusters")  + scale_color_manual(values = mypal_batch)
MyDimPlotHighlight(tmp, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(igt)[grepl("Colon", igt$sample_name)], highlight_column_name = "RNA_clusters",mycols = mypal_batch, print_plot1 = F, print_plot2 = T, labelclusters = F )
dev.off()

igt = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/exp_id/20220912_exp_id_16_CBDM_scurfy/IGT24/dataset_clean.Rds')
tmp = so_orig
tmp$RNA_clusters = NA
tmp$RNA_clusters = as.character(igt$RNA_clusters[match(colnames(tmp), colnames(igt))])
pdf(sprintf("%s/IGT24_UMAP_seuratclusters.pdf", out_dir), 5,5, useDingbats = F)
mypal_batch = setNames(mypal, unique(igt$RNA_clusters))
mypal_batch = mypal_batch[!is.na(names(mypal_batch))]
DimPlot(igt[,grepl("WT.COL", igt$sample_name)], reduction = "umap_rna", group.by = "RNA_clusters") + scale_color_manual(values = mypal_batch) + NoLegend() + NoGrid()
MyDimPlotHighlight(igt, umap_to_plot = "umap_rna", cells_to_highlight = colnames(igt)[grepl("WT.COL", igt$sample_name)], highlight_column_name = "RNA_clusters",mycols = mypal_batch, print_plot1 = F, print_plot2 = T, labelclusters = F, pixels = c(256, 256) )
# DimPlot(tmp[,colnames(igt)], reduction = "mde2_totalvi_20241006", group.by = "RNA_clusters")  + scale_color_manual(values = mypal_batch)
MyDimPlotHighlight(tmp, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(igt)[grepl("WT.COL", igt$sample_name)], highlight_column_name = "RNA_clusters",mycols = mypal_batch, print_plot1 = F, print_plot2 = T, labelclusters = F )
dev.off()

igt = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/exp_id/20221019_exp_id_21_Iliev/IGT27/dataset_clean.Rds')
tmp = so_orig
tmp$RNA_clusters = NA
tmp$RNA_clusters = as.character(igt$RNA_clusters[match(colnames(tmp), colnames(igt))])
pdf(sprintf("%s/IGT27_UMAP_seuratclusters.pdf", out_dir), 5,5, useDingbats = F)
mypal_batch = setNames(mypal, unique(igt$RNA_clusters))
mypal_batch = mypal_batch[!is.na(names(mypal_batch))]
DimPlot(igt[,grepl("No_colon_M", igt$sample_name)], reduction = "umap_rna", group.by = "RNA_clusters") + scale_color_manual(values = mypal_batch) + NoLegend() + NoGrid()
MyDimPlotHighlight(igt, umap_to_plot = "umap_rna", cells_to_highlight = colnames(igt)[grepl("No_colon_M", igt$sample_name)], highlight_column_name = "RNA_clusters",mycols = mypal_batch, print_plot1 = F, print_plot2 = T, labelclusters = F, pixels = c(256, 256) )
# DimPlot(tmp[,colnames(igt)], reduction = "mde2_totalvi_20241006", group.by = "RNA_clusters")  + scale_color_manual(values = mypal_batch)
MyDimPlotHighlight(tmp, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(igt)[grepl("No_colon_M", igt$sample_name)], highlight_column_name = "RNA_clusters",mycols = mypal_batch, print_plot1 = F, print_plot2 = T, labelclusters = F )
dev.off()

```

Cluster structure conservation with silhoette analysis
```{r}
library(cluster)
so_list = Seurat::SplitObject(so_orig[,so_orig$IGT %in% c("IGT1", "IGT5")], split.by = "IGT")

BioConservationSilhouette = function(so, reduc_integrated = "totalvi_20241008_rmIGTsample") {
    message("Clustering in the batch...")
    so <- so %>%
        NormalizeData(normalization.method = "LogNormalize", scale.factor = 1e4, verbose = F) %>%
        FindVariableFeatures(selection.method = "vst", nfeatures = 2000, verbose = F) %>%
        ScaleData(features = VariableFeatures(.), verbose = F) %>%     # note the "."
        RunPCA(features = VariableFeatures(.), npcs = 50, verbose = F) %>%
        FindNeighbors(dims = 1:30, verbose = F) %>%
        FindClusters(resolution = 1, verbose = F)
    # RunUMAP(dims = 1:30, seed.use = 123, verbose = T)
    
    message("Calculating silhouette pre integration...")
    reduc.dist = dist(so[["pca"]]@cell.embeddings)
    cl = as.integer(so[["RNA_snn_res.1"]][,1])
    sil_pre = silhouette(cl, dist = reduc.dist)
    sil_summary_pre = as.data.frame(sil_pre) %>% 
        group_by(cluster) %>% 
        summarise(mean_sil_width = mean(sil_width),
                  median_sil_width = median(sil_width),
                  total = n(),  # Count total observations in each cluster
                  positive_count = sum(sil_width > 0),  # Count negative silhouette widths
                  percentage_positive = (positive_count / total) * 100)     %>%  # Calculate percentage) 
        as.data.frame()

    message("Calculating silhouette post integration...")
    reduc.dist = dist(so[[reduc_integrated]]@cell.embeddings)
    cl = as.integer(so[["RNA_snn_res.1"]][,1])
    sil_post = silhouette(cl, dist = reduc.dist)
    sil_summary_post = as.data.frame(sil_post) %>% 
        group_by(cluster) %>% 
        summarise(mean_sil_width = mean(sil_width),
                  median_sil_width = median(sil_width),
                  total = n(),  # Count total observations in each cluster
                  positive_count = sum(sil_width > 0),  # Count negative silhouette widths
                  percentage_positive = (positive_count / total) * 100)     %>%  # Calculate percentage) 
        as.data.frame()
    
    sil_summary = merge(sil_summary_pre, sil_summary_post, by = "cluster", suffixes = c(".pre",".post"))
    
    return(sil_summary)
    
}

sil_summary_list = list()
for (i in unique(so_orig$IGT)) {
    print(i)
    sil_summary_list[[i]] = BioConservationSilhouette(so_orig[,so_orig$IGT == i], reduc_integrated = "totalvi_20241008_rmIGTsample" )
    sil_summary_list[[i]]$IGT = i
    # plot(sil_summary$mean_sil_width.pre, sil_summary$mean_sil_width.post)
    print(median(sil_summary_list[[i]]$mean_sil_width.pre - sil_summary_list[[i]]$mean_sil_width.post))
    print(cor(sil_summary_list[[i]]$mean_sil_width.pre, sil_summary_list[[i]]$mean_sil_width.post, method = "spearman"))
    print(cor(sil_summary_list[[i]]$median_sil_width.pre, sil_summary_list[[i]]$median_sil_width.post, method = "spearman"))
}
saveRDS(sil_summary_list, file = "BioConservationSilhouette_IGT.Rds")

sil_summary_merged = Reduce(rbind, sil_summary_list)

pdf(sprintf("%s/BioConservationSilhouette_Summary.pdf", out_dir), 5,5, useDingbats = F)
#mean
p <- ggplot(sil_summary_merged) +
    geom_point(aes(mean_sil_width.pre, mean_sil_width.post, color = IGT), size = 1) +
    geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black", linewidth = 0.3) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black", linewidth = 0.3) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "black", linewidth = 0.3) +
    scale_color_manual(values = mypal_igt) +
    xlim(c(-0.6,0.6)) +
    ylim(c(-0.6,0.6)) +
    theme_bw() + NoGrid()
p
p + NoLegend()

#with regression line
fit  <- lm(mean_sil_width.post ~ mean_sil_width.pre, data = sil_summary_merged)
b0   <- coef(fit)[1]
b1   <- coef(fit)[2]
r2   <- summary(fit)$r.squared
eq_lab <- sprintf("y = %.2f + %.2f·x\nR² = %.2f", b0, b1, r2)
p <- ggplot(sil_summary_merged) +
    geom_point(aes(mean_sil_width.pre, mean_sil_width.post, color = IGT), size = 1) +
    geom_smooth(aes(mean_sil_width.pre, mean_sil_width.post),
                method = "lm", se = FALSE, color = "black") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black", linewidth = 0.3) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "black", linewidth = 0.3) +
    scale_color_manual(values = mypal_igt) +
    xlim(c(-0.6,0.6)) +
    ylim(c(-0.6,0.6)) +
    theme_bw() + NoGrid() +
    annotate(
        "text",
        x = min(sil_summary_merged$mean_sil_width.pre,  na.rm = TRUE),
        y = max(sil_summary_merged$mean_sil_width.post, na.rm = TRUE),
        hjust = 0, vjust = 1,
        label = eq_lab, size = 3
    )
p + NoLegend()

#median
p <- ggplot(sil_summary_merged) +
    geom_point(aes(median_sil_width.pre, median_sil_width.post, color = IGT), size = 1) +
    geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black", linewidth = 0.3) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black", linewidth = 0.3) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "black", linewidth = 0.3) +
    scale_color_manual(values = mypal_igt) +
    xlim(c(-0.6,0.6)) +
    ylim(c(-0.6,0.6)) +
    theme_bw() + NoGrid()
p
p + NoLegend()

#median with regression line
fit  <- lm(median_sil_width.post ~ median_sil_width.pre, data = sil_summary_merged)
b0   <- coef(fit)[1]
b1   <- coef(fit)[2]
r2   <- summary(fit)$r.squared
eq_lab <- sprintf("y = %.2f + %.2f·x\nR² = %.2f", b0, b1, r2)
p <- ggplot(sil_summary_merged) +
    geom_point(aes(median_sil_width.pre, median_sil_width.post, color = IGT), size = 1) +
    geom_smooth(aes(median_sil_width.pre, median_sil_width.post),
                method = "lm", se = FALSE, color = "black") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black", linewidth = 0.3) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "black", linewidth = 0.3) +
    scale_color_manual(values = mypal_igt) +
    xlim(c(-0.6,0.6)) +
    ylim(c(-0.6,0.6)) + 
    theme_bw() + NoGrid() +
    annotate(
        "text",
        x = min(sil_summary_merged$median_sil_width.pre,  na.rm = TRUE),
        y = max(sil_summary_merged$median_sil_width.post, na.rm = TRUE),
        hjust = 0, vjust = 1,
        label = eq_lab, size = 3
    )
p + NoLegend()

dev.off()

median(sil_summary_merged$mean_sil_width.pre - sil_summary_merged$mean_sil_width.post)
cor(sil_summary_merged$mean_sil_width.pre, sil_summary_merged$mean_sil_width.post, method = "spearman")
cor(sil_summary_merged$median_sil_width.pre, sil_summary_merged$median_sil_width.post, method = "spearman")
cor(sil_summary_merged$mean_sil_width.pre, sil_summary_merged$mean_sil_width.post, method = "pearson")
cor(sil_summary_merged$median_sil_width.pre, sil_summary_merged$median_sil_width.post, method = "pearson")



```


**Figure 3 - Level2 and clustering cluster distribution across organs and conditions**
3A
```{r}
so = so_orig[,so_orig@meta.data %>% filter(organ_simplified != "thymus") %>% row.names()]
so@meta.data %>% count(organ_simplified)
so@meta.data %>% count(IGT)
so@meta.data %>% filter(IGT == "IGT70") %>% select(exp_name) %>% unique()

pdf(sprintf("%s/MDE_level2.pdf", out_dir), 5,5, useDingbats = F)
p = DimPlot(object = so, reduction = "mde2_totalvi_20241006", group.by = "annotation_level2", raster = T, raster.dpi = c(1024,1024)) + scale_color_manual(values = mypal_level2) + NoGrid()
p
p + NoLegend()
p = DimPlot(object = so, reduction = "mde2_totalvi_20241006", group.by = "annotation_level2", raster = T, raster.dpi = c(1024,1024), label = T, label.size = 2) + scale_color_manual(values = mypal_level2) + NoGrid()
p + NoLegend()
dev.off()

pdf(sprintf("%s/MDE_level1_separated.pdf", out_dir), 10,10, useDingbats = F)
o = unique(so$annotation_level1)
for (o in unique(so$annotation_level1)) {
    print(o)
    p = MyDimPlotHighlight(seurat_object = so, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(so)[which(so$annotation_level1 %in% o)], highlight_column_name = "annotation_level1", pixels = c(1024, 1024), mycols = mypal_level1, title = o, highlight_size = 0.1, highlight_alpha = 0.5, print_plot1 = T, print_plot2 = T, labelclusters = T)
    print(p$plot3)
}
dev.off()

pdf(sprintf("%s/MDE_level1_separated2.pdf", out_dir), 5,5, useDingbats = F)
o = unique(so$annotation_level1)
for (o in unique(so$annotation_level1)) {
    print(o)
    p = DimPlot(object = so, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(1024,1024), cells.highlight = names(which(so$annotation_level1 == o)), cols.highlight = mypal_level1[o]) + NoLegend()
    print(p)
    
}
dev.off()

# DimPlot(object = so, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(1024,1024), cells.highlight = colnames(so), group.by = "annotation_level1", cols.highlight = mypal_level1, split.by = "annotation_level1") doesn't work

```

S3A
Clusters by IGT
```{r}

library(dplyr)
library(rlang)

CompositionOfEachCluster <- function(meta = so@meta.data, cluster_col = "annotation_level2", sample_col  = "IGT") {
    clust  <- sym(cluster_col)
    sample <- sym(sample_col)
    
    # 1) counts per cluster × sample
    comp <- meta %>%
        filter(!is.na(!!clust), !is.na(!!sample)) %>%
        count(!!clust, !!sample, name = "n") %>%
        # 2) normalize within sample (like your tmp2)
        group_by(!!sample) %>%
        mutate(p_in_sample = n / sum(n)) %>%
        ungroup() %>%
        # 3) normalize within cluster (like your tmp3)
        group_by(!!clust) %>%
        mutate(p_weighted = p_in_sample / sum(p_in_sample)) %>%
        ungroup()
    
    # 4) total n per cluster + label "cluster (n=XX)"
    cluster_sizes <- comp %>%
        group_by(!!clust) %>%
        summarise(n_total = sum(n), .groups = "drop") %>%
        mutate(
            clust_chr = as.character(!!clust),
            label = paste0(clust_chr, " (n=", n_total, ")")
        ) %>%
        select(-clust_chr)
    
    # 5) join labels back & make label a factor in a stable order
    comp_labeled <- comp %>%
        left_join(cluster_sizes, by = rlang::as_name(clust)) %>%
        mutate(label = factor(label, levels = cluster_sizes$label))
    
    return(comp_labeled)
}

comp_df = CompositionOfEachCluster(so@meta.data,
                                    cluster_col = "annotation_level2",
                                    sample_col  = "IGT")

head(comp_df)

p <- ggplot(comp_df) +
    geom_bar(
        aes(x = label, y = p_weighted, fill = IGT),
        stat = "identity"
    ) +
    scale_fill_manual(values = mypal_igt) +
    theme_bw() +
    ggtitle("IGT composition in each cluster") +
    theme(
        axis.text.x = element_text(angle = 75, vjust = 0.5, size = 10),
        axis.title.x = element_blank()
    )

pdf(sprintf("%s/Barplot_Level2ByIGT.pdf", out_dir), 15,5, useDingbats = F)
p
p + NoLegend()
dev.off()
```

Proportion of level2 (denominator is level1) in each organ
allT only
annotation_level2_PropPerSamplePerLevel1_withMetadata.Rds in composition_anbalysis_igt1_96.Rmd
--> Barplot_Level2ByIGT_healthy.pdf and Barplot_Level2ByIGT.pdf
```{r}
make_comp_dotdata_and_plot <- function(data,
                                       so,
                                       condition_col = "condition_broad") {
    require(dplyr)
    require(tidyr)
    require(ggplot2)
    require(RColorBrewer)
    require(rlang)
    require(tibble)
    cond_sym <- sym(condition_col)
    
    ## 1. Long format with both .prop and .ncells
    data_long <- data %>%
        select(!!cond_sym, IGTHT, matches("\\.(prop|ncells)$")) %>%
        pivot_longer(
            cols = matches("\\.(prop|ncells)$"),
            names_to = c("cluster", "metric"),
            names_sep = "\\.",
            values_to = "value"
        ) %>%
        pivot_wider(
            names_from  = metric,
            values_from = value
        )
    # columns: <condition_col>, IGTHT, cluster, prop, ncells
    
    ## 2. Aggregate across IGTHT for each condition × cluster
    comp_mean <- data_long %>%
        group_by(!!cond_sym, cluster) %>%
        summarise(
            mean_prop    = mean(prop,   na.rm = TRUE),
            total_ncells = sum(ncells,  na.rm = TRUE),
            .groups = "drop"
        )
    
    ## 3. Map clusters to level1 using so@meta.data
    cluster_map <- so@meta.data %>%
        as.data.frame() %>%
        distinct(annotation_level1, annotation_level2)
    
    comp_mean <- comp_mean %>%
        left_join(cluster_map, by = c("cluster" = "annotation_level2"))
    
    ## 4. Cluster conditions (rows) based on similarity in mean_prop
    mat <- comp_mean %>%
        select(!!cond_sym, cluster, mean_prop) %>%
        pivot_wider(
            names_from  = cluster,
            values_from = mean_prop,
            values_fill = list(mean_prop = 0)
        ) %>%
        column_to_rownames(var = as_name(cond_sym)) %>%
        as.matrix()
    
    if (nrow(mat) > 1) {
        organ_order <- rownames(mat)[hclust(dist(mat))$order]
    } else {
        organ_order <- rownames(mat)
    }
    
    comp_mean <- comp_mean %>%
        mutate(
            !!condition_col := factor(!!cond_sym, levels = organ_order)
        )
    
    ## 5. Apply factor orders from Seurat object
    comp_mean <- comp_mean %>%
        mutate(
            annotation_level1 = factor(annotation_level1,
                                       levels = levels(so$annotation_level1)),
            cluster = factor(cluster,
                             levels = levels(so$annotation_level2))
        )
    
    ## 6. Add log10 size
    comp_mean <- comp_mean %>%
        mutate(
            size_log10 = log10(total_ncells + 1)  # +1 protects zeros
        )
    
    ## 7. Build the plot
    p <- ggplot(comp_mean, aes(x = cluster, y = !!cond_sym)) +
        geom_point(
            aes(size = size_log10, fill = mean_prop),
            shape = 21, colour = "black", stroke = 0.2
        ) +
        scale_fill_gradientn(
            colours = RColorBrewer::brewer.pal(9, "Blues"),
            name = "Mean prop"
        ) +
        scale_size(
            range = c(1, 8),
            name = "log10(# cells)"
        ) +
        facet_grid(
            . ~ annotation_level1,
            scales = "free_x",
            space  = "free_x"
        ) +
        labs(x = NULL, y = NULL) +
        theme_minimal(base_size = 11) +
        theme(
            axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1, size = 12),
            axis.text.y = element_text(size = 12),
            panel.grid = element_blank(),
            strip.text = element_text(face = "bold")
        )
    
    # return both data and plot
    list(
        data = comp_mean,
        plot = p
    )
}


m3 = readRDS(file = sprintf("%s/annotation_level2_PropPerSamplePerLevel1_withMetadata.Rds", '/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/analysis/data_integration/IGT1_96/SampleComp/20250226_2'))

pdf(sprintf("%s/DotPlot_Level2ByOrgan_all.pdf", out_dir), 25,6, useDingbats = F)
m4 = m3 %>% filter(organ_simplified != "thymus", target_cells_simplified %in% c("CD45p", "allT")) %>% select(-contains("thymocyte"))
res <- make_comp_dotdata_and_plot(
  data = m4,
  so   = so,
  condition_col = "organ_simplified"   # or "organ_simplified", etc.
)
comp_mean <- res$data
p <- res$plot + scale_fill_gradientn(colours = colorRampPalette(c("white", "black"))(10), name = "Mean prop")
p
dev.off()

pdf(sprintf("%s/DotPlot_Level2ByOrgan_healthy.pdf", out_dir), 25,6, useDingbats = F)
m4 = m3 %>% filter(organ_simplified != "thymus", target_cells_simplified %in% c("CD45p", "allT"), condition_broad == "healthy") %>% select(-contains("thymocyte"))
res <- make_comp_dotdata_and_plot(
  data = m4,
  so   = so,
  condition_col = "organ_simplified"   # or "organ_simplified", etc.
)
comp_mean <- res$data
p <- res$plot + scale_fill_gradientn(colours = colorRampPalette(c("white", "black"))(10), name = "Mean prop")
p
dev.off()

pdf(sprintf("%s/DotPlot_Level2ByConditionBroad_all.pdf", out_dir), 25,4, useDingbats = F)
m4 = m3 %>% filter(organ_simplified != "thymus", target_cells_simplified %in% c("CD45p", "allT")) %>% select(-contains("thymocyte"))
res <- make_comp_dotdata_and_plot(
  data = m4,
  so   = so,
  condition_col = "condition_broad"   # or "organ_simplified", etc.
)
comp_mean <- res$data
p <- res$plot 
p
dev.off()


pdf(sprintf("%s/DotPlot_Level2ByConditionDetailedSimplified_Lung.pdf", out_dir), 22,3.5, useDingbats = F)
m4 = m3 %>% filter(organ_simplified == "lung", target_cells_simplified %in% c("CD45p", "allT")) %>% select(-contains("thymocyte"))
res <- make_comp_dotdata_and_plot(
  data = m4,
  so   = so,
  condition_col = "condition_detailed_simplified"   # or "organ_simplified", etc.
)
comp_mean <- res$data
p <- res$plot #+ scale_fill_gradientn(colours = colorRampPalette(c("white", mypal_organ["lung"]))(10), name = "Mean prop")#scale_fill_gradientn(colours = RColorBrewer::brewer.pal(9, "Greens"), name = "Mean prop")
p
dev.off()

pdf(sprintf("%s/DotPlot_Level2ByConditionDetailedSimplified_Colon.pdf", out_dir), 22,3.5, useDingbats = F)
m4 = m3 %>% filter(organ_simplified == "colon", target_cells_simplified %in% c("CD45p", "allT")) %>% select(-contains("thymocyte"))
res <- make_comp_dotdata_and_plot(
  data = m4,
  so   = so,
  condition_col = "condition_detailed_simplified"   # or "organ_simplified", etc.
)
comp_mean <- res$data
p <- res$plot + scale_fill_gradientn(colours = colorRampPalette(c("white", mypal_organ["colon"]))(10), name = "Mean prop") #RColorBrewer::brewer.pal(9, "Reds")
p
dev.off()


```

