---
title: "misc"
output: html_document
date: "2025-11-13"
author: "David Zemmour"
editor_options: 
  chunk_output_type: console
---

**Initialize: load libraries and custom functions**

```{bash}
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=jfkfloor2 --qos=jfkfloor2 --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=beagle3-bigmem --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=zemmour-hm --qos=zemmour --nodes=1 
sinteractive --time=03:00:00 --account=pi-zemmour --partition=caslake --nodes=1 --mem=96GB

module load python/anaconda-2022.05 
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13
source activate /project/zemmour/david/envs/scvi_20240315
#source activate /project/zemmour/david/envs/r443
module load openblas/0.3.13

cd /project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96
R
```


```{r}
# setwd("~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/")
libs = c("ZemmourLib","forcats", "gridExtra","patchwork", "Matrix", "Seurat", "ggplot2", "dplyr", "reshape2", "ggrastr","scattermore", "RColorBrewer", "pals", "scales", "pheatmap", "rafalib") 
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))
#source("/project/jfkfloor2/zemmourlab/david/immgent/immgent_integration_git/custom_functions_david.R")

ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
ColorRamp = rev(rainbow(10, end = 4/6))
ColorRamp = rev(viridis(100))
ColorRamp = brewer.pal(9, "Blues")

#mycol = c("black","blue","red","darkgreen", "orange","purple", "cyan", "greenyellow",    "salmon", "magenta","pink", "tan", "brown") # c("magenta", "red",  "darkgreen", "cyan", "blue", "blue", "blue", "black", "blue", "blue", "blue", "blue", "orange")

mypal_level2 = immgent_colors$level2
mypal_level2["not classified"] = "black"
# mypal_level2 = immgent_colors$level2_option2
# mypal_level2["not classified"] = "black"
mypal_level1 = immgent_colors$level1
mypal_level1["not classified"] = "black"
mypal_organ = immgent_colors$organ_simplified
mypal_level2group = c("resting" = "blue", "activated" = "red", "miniverse" = "darkgreen", "proliferating" = "black", "other" = "grey", "preT" = "grey" )

#Large Color palette
library("pals")
n = 70
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
mypal1 = unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals))))
mypal1 = mypal1[-4]
mypal = c(glasbey(), polychrome(), mypal1)
names(mypal) = NULL
#pal.bands(mypal, main="Colormap suggestions")
# mypal_organ = setNames(mypal, unique(so$organ_simplified))
# mypal_organ = mypal_organ[!is.na(names(mypal_organ))]
# mypal_level1 = setNames(mypal, unique(so$annotation_level1))
# mypal_level1 = mypal_level1[!is.na(names(mypal_level1))]
# mypal_level2 = setNames(mypal, unique(so_orig$annotation_level2))
# mypal_level2 = mypal_level2[!is.na(names(mypal_level2))]
# mypal_level2["CD4_cl18"] = "blue"
mypal_igt = setNames(mypal, unique(so_orig$IGT))
mypal_igt = mypal_igt[!is.na(names(mypal_igt))]

```

```{r}
# fig_dir = "~/google_drive_uchicago/ImmgenT/20250109_freeze/paper_cosmology/figures/bits"
# fig_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/paper_cosmology/figures/bits"

out_dir = "~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/misc_plots" 
out_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/misc_plots"

```


**Most up-to-date data**
on Midway
```{r}
# so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250513_clean.Rds") 
so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250710_clean.Rds") 
so_orig$annotation_level2[so_orig$annotation_level2 == "Treg_cl7"] = "Treg_cl1"
so_orig$annotation_level1 = factor(so_orig$annotation_level1, levels = c("CD8", "CD4", "Treg", "gdT", "CD8aa", "nonconv", "DN", "DP", "thymocyte"))

so = so_orig[,so_orig@meta.data %>% filter(organ_simplified != "thymus") %>% row.names()]
so = NormalizeData(so, assay = "RNA", normalization.method = "LogNormalize")


```

on Desktop
```{r}
setwd("~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/")
so_orig = readRDS("igt1_96_withtotalvi20250710_clean_ADTonly.Rds")
so_orig$annotation_level2[so_orig$annotation_level2 == "Treg_cl7"] = "Treg_cl1"
so_orig$annotation_level1 = factor(so_orig$annotation_level1, levels = c("CD8", "CD4", "Treg", "gdT", "CD8aa", "nonconv", "DN", "DP", "thymocyte"))

so = so_orig[,so_orig@meta.data %>% filter(organ_simplified != "thymus") %>% row.names()]
# so = NormalizeData(so, assay = "RNA", normalization.method = "LogNormalize")
# so = NormalizeData(so, assay = "ADT", normalization.method = "LogNormalize")

```


Load GP: L1 and F1
```{r}
library("flashier")
prefix = "topic"
prefix2 = "flashier20250215_alldata_backfit"
fit_flash = readRDS(sprintf("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/%s/%s/fit.Rds", prefix,prefix2))
fit = fit_flash

res = ldf(fit, type = "i")
L1 = with(res, L %*% diag(D)  ) #same as res$L %*% diag(res$D)
L1 = L1[colnames(so),]
all(colnames(so) == rownames(L1))
any(is.na(L1))
colnames(L1) = sprintf("F%s", 1:ncol(L1))
# sub_cells = sample(colnames(so_orig), 1500, replace = F)
# sub_cells = c(sample(colnames(so_orig)[so_orig$annotation_level1 %in% "Treg"], 1500, replace = F), sample(colnames(so_orig)[!so_orig$annotation_level1 %in% "Treg"], 1500, replace = F))
# sub_cells = c(so_orig@meta.data %>% filter(annotation_level1 == "Treg") %>% slice_sample(n = 1500, replace = FALSE) %>% pull(cellID),
#               so_orig@meta.data %>% filter(annotation_level1 != "Treg") %>% group_by(annotation_level1) %>% slice_sample(n = 100, replace = FALSE) %>% ungroup() %>% pull(cellID))

F1 = with(ldf(fit, type = "i"), F)
colnames(F1) = paste("F", 1:ncol(F1), sep = "")


# mdata_orig = read.table("metadata_20250513_mde.txt", header = T, sep = "\t")
mdata_orig = so@meta.data
```

**Figure 1B - Counting cells in immgenT**

per organ
```{r}
library(dplyr)
library(forcats)

df <- so@meta.data 
df$organ_simplified2 = as.character(df$organ_simplified)
df$organ_simplified2[df$organ_simplified %in% c("spleen", "LN", "SLO", "blood")] = "spleen LN blood"
df$organ_simplified2[grepl(pattern = "colon|small intestine",df$organ_simplified)] = "gut"
df$organ_simplified2[grepl(pattern = "colon|small intestine",df$organ_simplified)] = "gut"
df$organ_simplified2[grepl(pattern = "synovial|prostate|uterus|pancreas|peritoneal|bone|kidney|liver|mammary|pancreas|placenta|thymus",df$organ_simplified)] = "other"

df2 <- df %>%
  filter(!is.na(organ_simplified2)) %>%
  count(organ_simplified2, name = "n") %>%
  mutate(organ_simplified2 = fct_reorder(organ_simplified2, n)) %>% arrange(n)
df2$organ_simplified2 = factor(df2$organ_simplified2, levels = c("spleen LN blood", "gut", "lung", "skin", "submandibular gland", "CNS", "other"))

# barplot with labels on bars
p1 = ggplot(df2, aes(x = organ_simplified2, y = n, fill = organ_simplified2)) +
  geom_col(width = 0.75) +
  geom_text(aes(label = comma(n)), vjust = -0.25, size = 3) +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0.02, 0.10))) +
  labs(title = "# cells by organ", x = NULL, y = "cells") +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    legend.position = "none"
  ) + scale_fill_brewer(palette = "Set3") + NoGrid()

pdf(sprintf("%s/barplot_cellcount_organ.pdf", out_dir), 10,7, useDingbats = F)
p1
dev.off()

df2 <- df %>%
  filter(!is.na(organ_simplified)) %>%
  count(organ_simplified, name = "n") %>%
  mutate(organ_simplified = fct_reorder(organ_simplified, n, .desc = T)) %>% arrange(n)
p1 = ggplot(df2, aes(x = organ_simplified, y = n, fill = organ_simplified)) +
  geom_col(width = 0.75) +
  geom_text(aes(label = comma(n)), vjust = -0.25, size = 3) +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0.02, 0.10))) +
  labs(title = "# cells by organ", x = NULL, y = "cells") +
    scale_fill_manual(values = mypal_organ)+
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    legend.position = "none"
  ) + NoGrid()
p1

df2 <- df %>%
  filter(!is.na(sex), sex != "mixed") %>%
  count(sex, name = "n") %>%
  mutate(sex = fct_reorder(sex, n, .desc = T)) %>% arrange(n)
p1 = ggplot(df2, aes(x = sex, y = n, fill = sex)) +
  geom_col(width = 0.75) +
  geom_text(aes(label = comma(n)), vjust = -0.25, size = 3) +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0.02, 0.10))) +
  labs(title = "# cells by sex", x = NULL, y = "cells") +
    scale_fill_brewer(palette = "Set3") +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    legend.position = "none"
  ) + NoGrid()

p1

df2 <- df %>%
  filter(!is.na(condition_detailed_simplified)) %>%
  count(condition_detailed_simplified, name = "n") %>%
  mutate(condition_detailed_simplified = fct_reorder(condition_detailed_simplified, n, .desc = T)) %>% arrange(n)
p1 = ggplot(df2, aes(x = condition_detailed_simplified, y = log10(n), fill = condition_detailed_simplified)) +
  geom_col(width = 0.75) +
  geom_text(aes(label = comma(n)), hjust = 0, vjust = 0.1, size = 3, angle = 90) +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0.02, 0.10))) +
  labs(title = "# cells by immune perturbation", x = NULL, y = "cells") +
    scale_fill_manual(values = mypal) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    legend.position = "none"
  ) + NoGrid()

p1

```

per condition_broad
```{r}
library(dplyr)

df = so@meta.data 
df$condition_broad[df$condition_broad == "autoimmunity"] = "autoimmune"
df$condition_broad[df$condition_broad == "mutiinfection"] = "virus"

# df$condition_broad = as.character(df$condition_broad)
# df$organ_simplified2[df$organ_simplified %in% c("spleen", "LN", "SLO", "blood")] = "spleen LN blood"
# df$organ_simplified2[grepl(pattern = "colon|small intestine",df$organ_simplified)] = "gut"
# df$organ_simplified2[grepl(pattern = "colon|small intestine",df$organ_simplified)] = "gut"
# df$organ_simplified2[grepl(pattern = "synovial|prostate|uterus|pancreas|peritoneal|bone|kidney|liver|mammary|pancreas|placenta|thymus",df$organ_simplified)] = "other"

df2 <- df %>%
  filter(!is.na(condition_broad)) %>%
  count(condition_broad, name = "n") 

df2 = df2 %>%
  mutate(condition_broad = fct_reorder(condition_broad, n)) %>% arrange(n)
df2$condition_broad = factor(df2$condition_broad, levels = rev(c("healthy", "allergy", "autoimmune", "bacteria", "virus", "parasite", "fungus", "cancer", "immunization", "allotransplant" )))
any(is.na(df2$condition_broad ))

# barplot with labels on bars
p = ggplot(df2, aes(x = condition_broad, y = -n, fill = condition_broad)) +
    geom_col(width = 0.75) +
    geom_text(aes(label = comma(n)), hjust = 0, size = 3) +
    # geom_text(aes(y = 0, label = comma(n)), hjust = -0.25, size = 3) +
    scale_y_continuous(labels = comma, expand = expansion(mult = c(0.02, 0.10))) +
    labs(title = "# cells by organ", x = NULL, y = "cells") +
    coord_flip() +
    theme_bw(base_size = 12) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.x = element_blank(),
        legend.position = "none"
    ) + scale_fill_brewer(palette = "Set3") + NoGrid()
p

pdf(sprintf("%s/barplot_cellcount_conditionbroad.pdf", out_dir), 5,5, useDingbats = F)
p
dev.off()

```

**Figure S1 - QC**
--> in qc_analysis.Rmd up to line 222 (TCR)

**Figure 1C**
```{r}
igt = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/exp_id/20220428_exp_id_05_Skin/IGT5/dataset_clean.Rds')
# igt = Seurat::NormalizeData(igt, assay = "RNA", normalization.method = "LogNormalize")
igt@meta.data$sub = T

pdf(sprintf("%s/IGT5_UMAPs.pdf", out_dir), 5,5, useDingbats = F)
DimPlot(igt, reduction = "umap_rna", group.by = "RNA_clusters")
DimPlot(igt, reduction = "umap_adt", group.by = "RNA_clusters")
MyFeatureScatter(so = igt, assay = "ADT", slot = "data", feature1 = "TCRB", feature2 = "TCRGD", group.by = "sub", raster = F,highlight_size = 2)
MyFeatureScatter(so = igt, assay = "ADT", slot = "data", feature1 = "CD4", feature2 = "CD8B", group.by = "sub", raster = T, highlight_size = 2)
dev.off()

```

**Figure 2 - Integration**

MDE plots level1 (2A and S2A)
```{r}
pdf(sprintf("%s/MDE_level1.pdf", out_dir), 5,5, useDingbats = F)
p = DimPlot(object = so, reduction = "mde2_totalvi_20241006", group.by = "annotation_level1", raster = T, raster.dpi = c(1024,1024)) + scale_color_manual(values = mypal_level1) + NoGrid()
p + NoLegend()
dev.off()

pdf(sprintf("%s/MDE_level1_separated.pdf", out_dir), 10,10, useDingbats = F)
o = unique(so$annotation_level1)
for (o in unique(so$annotation_level1)) {
    print(o)
    p = MyDimPlotHighlight(seurat_object = so, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(so)[which(so$annotation_level1 %in% o)], highlight_column_name = "annotation_level1", pixels = c(1024, 1024), mycols = mypal_level1, title = o, highlight_size = 0.1, highlight_alpha = 0.5, print_plot1 = T, print_plot2 = T, labelclusters = T)
    print(p$plot3)
}
dev.off()

pdf(sprintf("%s/MDE_level1_separated2.pdf", out_dir), 5,5, useDingbats = F)
o = unique(so$annotation_level1)
for (o in unique(so$annotation_level1)) {
    print(o)
    p = DimPlot(object = so, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(1024,1024), cells.highlight = colnames(so)[so$annotation_level1 == o], cols.highlight = mypal_level1[o]) + NoLegend()
    print(p)
    
}
dev.off()

# DimPlot(object = so, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(1024,1024), cells.highlight = colnames(so), group.by = "annotation_level1", cols.highlight = mypal_level1, split.by = "annotation_level1") doesn't work

```

MDE plots organ (2F and S2B)
```{r}
tmp = so[,so@meta.data %>% filter(condition_broad == "healthy" & organ_simplified0 != "thymus") %>% row.names()]


pdf(sprintf("%s/MDE_organ_separated.pdf", out_dir), 10,10, useDingbats = F)
for (o in unique(tmp$organ_simplified0)) {
    print(o)
    p = MyDimPlotHighlight(seurat_object = tmp, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(tmp)[which(tmp$organ_simplified0 %in% o)], highlight_column_name = "organ_simplified0", pixels = c(1024, 1024), mycols = mypal_organ, title = o, highlight_size = 0.1, highlight_alpha = 0.5, print_plot1 = T, print_plot2 = T, labelclusters = T)
    print(p$plot1)
    print(p$plot2)
}
dev.off()

pdf(sprintf("%s/MDE_organ_separated_collevel1.pdf", out_dir), 10,10, useDingbats = F)
for (o in unique(tmp$organ_simplified0)) {
    print(o)
    p = MyDimPlotHighlight(seurat_object = tmp, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(tmp)[which(tmp$organ_simplified0 %in% o)], highlight_column_name = "annotation_level1", pixels = c(1024, 1024), mycols = mypal_level1, title = o, highlight_size = 0.1, highlight_alpha = 0.5, print_plot1 = T, print_plot2 = T, labelclusters = T)
    print(p$plot1)
    print(p$plot2)
}
dev.off()

pdf(sprintf("%s/MDE_organ_separated2.pdf", out_dir), 5,5, useDingbats = F)
for (o in unique(tmp$organ_simplified0)) {
    print(o)
    p = DimPlot(object = tmp, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(512,512), cells.highlight = names(which(tmp$organ_simplified0 == o)), cols.highlight = mypal_organ[o]) + ggtitle(label = o) + NoLegend()
    print(p)
    
}
dev.off()

pdf(sprintf("%s/MDE_organ_separated3.pdf", out_dir), 10,10, useDingbats = F)
p = DimPlot(object = tmp, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(512,512), group.by = "organ_simplified0", cols = mypal_organ,split.by = "organ_simplified0", ncol =  4) 
print(p)
dev.off()

pdf(sprintf("%s/MDE_organ_separated_collevel1b.pdf", out_dir), 10,10, useDingbats = F)
p = DimPlot(object = tmp, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(512,512), group.by = "annotation_level1", cols = mypal_level1,split.by = "organ_simplified0", ncol =  4) 
print(p)
dev.off()

##color = IGT
pdf(sprintf("%s/MDE_organ_separated_colIGT.pdf", out_dir), 10,10, useDingbats = F)
for (o in unique(tmp$organ_simplified0)) {
    print(o)
    p = MyDimPlotHighlight(seurat_object = tmp, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(tmp)[which(tmp$organ_simplified0 %in% o)], highlight_column_name = "IGT", pixels = c(1024, 1024), mycols = mypal_igt, title = o, highlight_size = 0.5, highlight_alpha = 0.5, print_plot1 = T, print_plot2 = T, labelclusters = T)
    print(p$plot1)
    print(p$plot2)
}
dev.off()

pdf(sprintf("%s/MDE_organ_separated_colIGTb.pdf", out_dir), 10,10, useDingbats = F)
p = DimPlot(object = tmp, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(512,512), group.by = "IGT", cols = mypal_igt,split.by = "organ_simplified0", ncol =  4) 
p
p + NoLegend()
dev.off()

```

Spleen standard (2E)
```{r}
pdf(sprintf("%s/MDE_spleenstandard.pdf", out_dir), 5,5, useDingbats = F)
p = MyDimPlotHighlight(seurat_object = so, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = names(which(so$spleen_standard == T)), highlight_column_name = "IGT", pixels = c(1024, 1024), mycols = mypal_igt, title = "", highlight_size = 0.1, highlight_alpha = 0.5, print_plot1 = T, print_plot2 = T, labelclusters = F)
p
    # p = DimPlot(object = so, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(512,512), cells.highlight = names(which(so$spleen_standard == T)), cols.highlight = mypal_organ[o]) + ggtitle(label = o) + NoLegend()
    # print(p)
dev.off()
```

FeatureScatter ADT (2B)
```{r}
so = so_orig[,so_orig@meta.data %>% filter(cite_seq == T, organ_simplified != "thymus") %>% row.names()]
so = NormalizeData(so, assay = "ADT", normalization.method = "LogNormalize")
features_list = list(c("TCRB", "TCRGD"),
                     c("CD4", "CD8B"),
                     c("CD8A", "CD8B")
                     )
thresholds = list("TCRB" = 3, "TCRGD" = 4,"CD4" = 4, "CD8B" = 5, "CD8A" = 4.5)

pdf(sprintf("%s/FeatureScatter_level1.pdf", out_dir), 3,3, useDingbats = F)
for (i in 1:length(features_list)) {
    feature1 = features_list[[i]][1]
    feature2 = features_list[[i]][2]
    th1 = thresholds[feature1][1] %>% as.numeric()
    th2 = thresholds[feature2][1] %>% as.numeric()
    p = FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level1", raster = T, pt.size = 1, plot.cor = F) + scale_color_manual(values = mypal_level1) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown") + NoLegend()
    print(p)
}
dev.off()

pdf(sprintf("%s/FeatureScatter_level1_split.pdf", out_dir), 15,3, useDingbats = F)
for (i in 1:length(features_list)) {
    print(i)
    feature1 = features_list[[i]][1]
    feature2 = features_list[[i]][2]
    th1 = thresholds[feature1][1] %>% as.numeric()
    th2 = thresholds[feature2][1] %>% as.numeric()
    p = FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level1", split.by = "annotation_level1", raster = T, pt.size = 1) + scale_color_manual(values = mypal_level1) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown") + NoLegend()
    print(p)
    
}
dev.off()

```

FeaturePlot (Midway3) (2C)
```{r}
so = so_orig[,so_orig@meta.data %>% filter(organ_simplified != "thymus") %>% row.names()]
so = NormalizeData(so, assay = "RNA", normalization.method = "LogNormalize")
pdf(sprintf("%s/FeaturePlot_MainMarkers_level1.pdf", out_dir), 12,15, useDingbats = F)
FeaturePlot(so, reduction = "mde2_totalvi_20241006", features = c("Foxp3", "Cd4", "Cd8b1", "Cd8a","Trdc", "Zbtb16"), order = T, cols = c("lightgrey", "blue"), raster = T,max.cutoff = "q95") + ggplot2::xlim(-2.5,2.5) + ggplot2::ylim(-2.5,2.5)#Trgc1, Trgv2
dev.off()

FeaturePlot(so, reduction = "mde2_totalvi_20241006", features = c("Foxp3"), order = T, cols = c("lightgrey", "blue"), raster = T, max.cutoff = "q90") + ggplot2::xlim(-2.5,2.5) + ggplot2::ylim(-2.5,2.5)#Trgc1, Trgv2


```


**Figure 2H - Biological conservation analysis: clustering in each batch**

colon IGT20, IGT24 and IGT27
```{r}
igt = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/exp_id/20220812_exp_id_13_ColonSI/IGT20/dataset_clean.Rds')
tmp = so_orig
tmp$RNA_clusters = NA
tmp$RNA_clusters = as.character(igt$RNA_clusters[match(colnames(tmp), colnames(igt))])
pdf(sprintf("%s/IGT20_UMAP_seuratclusters.pdf", out_dir), 5,5, useDingbats = F)
mypal_batch = setNames(mypal, unique(igt$RNA_clusters))
mypal_batch = mypal_batch[!is.na(names(mypal_batch))]
DimPlot(igt[,grepl("Colon", igt$sample_name)], reduction = "umap_rna", group.by = "RNA_clusters") + scale_color_manual(values = mypal_batch) + NoLegend() + NoGrid()
MyDimPlotHighlight(igt, umap_to_plot = "umap_rna", cells_to_highlight = colnames(igt)[grepl("Colon", igt$sample_name)], highlight_column_name = "RNA_clusters",mycols = mypal_batch, print_plot1 = F, print_plot2 = T, labelclusters = F, pixels = c(256, 256) )
# DimPlot(tmp[,colnames(igt)], reduction = "mde2_totalvi_20241006", group.by = "RNA_clusters")  + scale_color_manual(values = mypal_batch)
MyDimPlotHighlight(tmp, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(igt)[grepl("Colon", igt$sample_name)], highlight_column_name = "RNA_clusters",mycols = mypal_batch, print_plot1 = F, print_plot2 = T, labelclusters = F )
dev.off()

igt = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/exp_id/20220912_exp_id_16_CBDM_scurfy/IGT24/dataset_clean.Rds')
tmp = so_orig
tmp$RNA_clusters = NA
tmp$RNA_clusters = as.character(igt$RNA_clusters[match(colnames(tmp), colnames(igt))])
pdf(sprintf("%s/IGT24_UMAP_seuratclusters.pdf", out_dir), 5,5, useDingbats = F)
mypal_batch = setNames(mypal, unique(igt$RNA_clusters))
mypal_batch = mypal_batch[!is.na(names(mypal_batch))]
DimPlot(igt[,grepl("WT.COL", igt$sample_name)], reduction = "umap_rna", group.by = "RNA_clusters") + scale_color_manual(values = mypal_batch) + NoLegend() + NoGrid()
MyDimPlotHighlight(igt, umap_to_plot = "umap_rna", cells_to_highlight = colnames(igt)[grepl("WT.COL", igt$sample_name)], highlight_column_name = "RNA_clusters",mycols = mypal_batch, print_plot1 = F, print_plot2 = T, labelclusters = F, pixels = c(256, 256) )
# DimPlot(tmp[,colnames(igt)], reduction = "mde2_totalvi_20241006", group.by = "RNA_clusters")  + scale_color_manual(values = mypal_batch)
MyDimPlotHighlight(tmp, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(igt)[grepl("WT.COL", igt$sample_name)], highlight_column_name = "RNA_clusters",mycols = mypal_batch, print_plot1 = F, print_plot2 = T, labelclusters = F )
dev.off()

igt = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/exp_id/20221019_exp_id_21_Iliev/IGT27/dataset_clean.Rds')
tmp = so_orig
tmp$RNA_clusters = NA
tmp$RNA_clusters = as.character(igt$RNA_clusters[match(colnames(tmp), colnames(igt))])
pdf(sprintf("%s/IGT27_UMAP_seuratclusters.pdf", out_dir), 5,5, useDingbats = F)
mypal_batch = setNames(mypal, unique(igt$RNA_clusters))
mypal_batch = mypal_batch[!is.na(names(mypal_batch))]
DimPlot(igt[,grepl("No_colon_M", igt$sample_name)], reduction = "umap_rna", group.by = "RNA_clusters") + scale_color_manual(values = mypal_batch) + NoLegend() + NoGrid()
MyDimPlotHighlight(igt, umap_to_plot = "umap_rna", cells_to_highlight = colnames(igt)[grepl("No_colon_M", igt$sample_name)], highlight_column_name = "RNA_clusters",mycols = mypal_batch, print_plot1 = F, print_plot2 = T, labelclusters = F, pixels = c(256, 256) )
# DimPlot(tmp[,colnames(igt)], reduction = "mde2_totalvi_20241006", group.by = "RNA_clusters")  + scale_color_manual(values = mypal_batch)
MyDimPlotHighlight(tmp, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(igt)[grepl("No_colon_M", igt$sample_name)], highlight_column_name = "RNA_clusters",mycols = mypal_batch, print_plot1 = F, print_plot2 = T, labelclusters = F )
dev.off()

```

Cluster structure conservation with silhoette analysis
```{r}
library(cluster)
# so_list = Seurat::SplitObject(so_orig[,so_orig$IGT %in% c("IGT1", "IGT5")], split.by = "IGT")

BioConservationSilhouette = function(so, reduc_integrated = "totalvi_20241008_rmIGTsample") {
    message("Clustering in the batch...")
    so <- so %>%
        NormalizeData(normalization.method = "LogNormalize", scale.factor = 1e4, verbose = F) %>%
        FindVariableFeatures(selection.method = "vst", nfeatures = 2000, verbose = F) %>%
        ScaleData(features = VariableFeatures(.), verbose = F) %>%     # note the "."
        RunPCA(features = VariableFeatures(.), npcs = 50, verbose = F) %>%
        FindNeighbors(dims = 1:30, verbose = F) %>%
        FindClusters(resolution = 1, verbose = F)
    # RunUMAP(dims = 1:30, seed.use = 123, verbose = T)
    
    message("Calculating silhouette pre integration...")
    reduc.dist = dist(so[["pca"]]@cell.embeddings)
    cl = as.integer(so[["RNA_snn_res.1"]][,1])
    sil_pre = silhouette(cl, dist = reduc.dist)
    sil_summary_pre = as.data.frame(sil_pre) %>% 
        group_by(cluster) %>% 
        summarise(mean_sil_width = mean(sil_width),
                  median_sil_width = median(sil_width),
                  total = n(),  # Count total observations in each cluster
                  positive_count = sum(sil_width > 0),  # Count negative silhouette widths
                  percentage_positive = (positive_count / total) * 100)     %>%  # Calculate percentage) 
        as.data.frame()

    message("Calculating silhouette post integration...")
    reduc.dist = dist(so[[reduc_integrated]]@cell.embeddings)
    cl = as.integer(so[["RNA_snn_res.1"]][,1])
    sil_post = silhouette(cl, dist = reduc.dist)
    sil_summary_post = as.data.frame(sil_post) %>% 
        group_by(cluster) %>% 
        summarise(mean_sil_width = mean(sil_width),
                  median_sil_width = median(sil_width),
                  total = n(),  # Count total observations in each cluster
                  positive_count = sum(sil_width > 0),  # Count negative silhouette widths
                  percentage_positive = (positive_count / total) * 100)     %>%  # Calculate percentage) 
        as.data.frame()
    
    sil_summary = merge(sil_summary_pre, sil_summary_post, by = "cluster", suffixes = c(".pre",".post"))
    
    return(sil_summary)
    
}

sil_summary_list = list()
for (i in unique(so_orig$IGT)) {
    print(i)
    sil_summary_list[[i]] = BioConservationSilhouette(so_orig[,so_orig$IGT == i], reduc_integrated = "totalvi_20241008_rmIGTsample" )
    sil_summary_list[[i]]$IGT = i
    # plot(sil_summary$mean_sil_width.pre, sil_summary$mean_sil_width.post)
    print(median(sil_summary_list[[i]]$mean_sil_width.pre - sil_summary_list[[i]]$mean_sil_width.post))
    print(cor(sil_summary_list[[i]]$mean_sil_width.pre, sil_summary_list[[i]]$mean_sil_width.post, method = "spearman"))
    print(cor(sil_summary_list[[i]]$median_sil_width.pre, sil_summary_list[[i]]$median_sil_width.post, method = "spearman"))
}
saveRDS(sil_summary_list, file = "BioConservationSilhouette_IGT.Rds")

sil_summary_merged = Reduce(rbind, sil_summary_list)

pdf(sprintf("%s/BioConservationSilhouette_Summary.pdf", out_dir), 5,5, useDingbats = F)
#mean
p <- ggplot(sil_summary_merged) +
    geom_point(aes(mean_sil_width.pre, mean_sil_width.post, color = IGT), size = 1) +
    geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black", linewidth = 0.3) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black", linewidth = 0.3) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "black", linewidth = 0.3) +
    scale_color_manual(values = mypal_igt) +
    xlim(c(-0.6,0.6)) +
    ylim(c(-0.6,0.6)) +
    theme_bw() + NoGrid()
p
p + NoLegend()

#with regression line
fit  <- lm(mean_sil_width.post ~ mean_sil_width.pre, data = sil_summary_merged)
b0   <- coef(fit)[1]
b1   <- coef(fit)[2]
r2   <- summary(fit)$r.squared
eq_lab <- sprintf("y = %.2f + %.2f·x\nR² = %.2f", b0, b1, r2)
p <- ggplot(sil_summary_merged) +
    geom_point(aes(mean_sil_width.pre, mean_sil_width.post, color = IGT), size = 1) +
    geom_smooth(aes(mean_sil_width.pre, mean_sil_width.post),
                method = "lm", se = FALSE, color = "black") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black", linewidth = 0.3) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "black", linewidth = 0.3) +
    scale_color_manual(values = mypal_igt) +
    xlim(c(-0.6,0.6)) +
    ylim(c(-0.6,0.6)) +
    theme_bw() + NoGrid() +
    annotate(
        "text",
        x = min(sil_summary_merged$mean_sil_width.pre,  na.rm = TRUE),
        y = max(sil_summary_merged$mean_sil_width.post, na.rm = TRUE),
        hjust = 0, vjust = 1,
        label = eq_lab, size = 3
    )
p + NoLegend()

#median
p <- ggplot(sil_summary_merged) +
    geom_point(aes(median_sil_width.pre, median_sil_width.post, color = IGT), size = 1) +
    geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black", linewidth = 0.3) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black", linewidth = 0.3) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "black", linewidth = 0.3) +
    scale_color_manual(values = mypal_igt) +
    xlim(c(-0.6,0.6)) +
    ylim(c(-0.6,0.6)) +
    theme_bw() + NoGrid()
p
p + NoLegend()

#median with regression line
fit  <- lm(median_sil_width.post ~ median_sil_width.pre, data = sil_summary_merged)
b0   <- coef(fit)[1]
b1   <- coef(fit)[2]
r2   <- summary(fit)$r.squared
eq_lab <- sprintf("y = %.2f + %.2f·x\nR² = %.2f", b0, b1, r2)
p <- ggplot(sil_summary_merged) +
    geom_point(aes(median_sil_width.pre, median_sil_width.post, color = IGT), size = 1) +
    geom_smooth(aes(median_sil_width.pre, median_sil_width.post),
                method = "lm", se = FALSE, color = "black") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black", linewidth = 0.3) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "black", linewidth = 0.3) +
    scale_color_manual(values = mypal_igt) +
    xlim(c(-0.6,0.6)) +
    ylim(c(-0.6,0.6)) + 
    theme_bw() + NoGrid() +
    annotate(
        "text",
        x = min(sil_summary_merged$median_sil_width.pre,  na.rm = TRUE),
        y = max(sil_summary_merged$median_sil_width.post, na.rm = TRUE),
        hjust = 0, vjust = 1,
        label = eq_lab, size = 3
    )
p + NoLegend()

dev.off()

median(sil_summary_merged$mean_sil_width.pre - sil_summary_merged$mean_sil_width.post)
cor(sil_summary_merged$mean_sil_width.pre, sil_summary_merged$mean_sil_width.post, method = "spearman")
cor(sil_summary_merged$median_sil_width.pre, sil_summary_merged$median_sil_width.post, method = "spearman")
cor(sil_summary_merged$mean_sil_width.pre, sil_summary_merged$mean_sil_width.post, method = "pearson")
cor(sil_summary_merged$median_sil_width.pre, sil_summary_merged$median_sil_width.post, method = "pearson")



```


**Figure 3 - Level2 and clustering cluster distribution across organs and conditions**
*3A*
```{r}
so = so_orig[,so_orig@meta.data %>% filter(organ_simplified != "thymus") %>% row.names()]
# so@meta.data %>% count(organ_simplified)
# so@meta.data %>% count(IGT)
# so@meta.data %>% filter(IGT == "IGT70") %>% select(exp_name) %>% unique()

pdf(sprintf("%s/MDE_level2.pdf", out_dir), 5,5, useDingbats = F)
p = DimPlot(object = so, reduction = "mde2_totalvi_20241006", group.by = "annotation_level2", raster = T, raster.dpi = c(1024,1024)) + scale_color_manual(values = mypal_level2) + NoGrid()
p
p + NoLegend()
p = DimPlot(object = so, reduction = "mde2_totalvi_20241006", group.by = "annotation_level2", raster = T, raster.dpi = c(1024,1024), label = T, label.size = 2) + scale_color_manual(values = mypal_level2) + NoGrid()
p + NoLegend()
dev.off()

pdf(sprintf("%s/MDE_level1_separated.pdf", out_dir), 10,10, useDingbats = F)
o = unique(so$annotation_level1)
for (o in unique(so$annotation_level1)) {
    print(o)
    p = MyDimPlotHighlight(seurat_object = so, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(so)[which(so$annotation_level1 %in% o)], highlight_column_name = "annotation_level1", pixels = c(1024, 1024), mycols = mypal_level1, title = o, highlight_size = 0.1, highlight_alpha = 0.5, print_plot1 = T, print_plot2 = T, labelclusters = T)
    print(p$plot3)
}
dev.off()

pdf(sprintf("%s/MDE_level1_separated2.pdf", out_dir), 5,5, useDingbats = F)
o = unique(so$annotation_level1)
for (o in unique(so$annotation_level1)) {
    print(o)
    p = DimPlot(object = so, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(1024,1024), cells.highlight = names(which(so$annotation_level1 == o)), cols.highlight = mypal_level1[o]) + NoLegend()
    print(p)
    
}
dev.off()

# DimPlot(object = so, reduction = "mde2_totalvi_20241006", raster = T, raster.dpi = c(1024,1024), cells.highlight = colnames(so), group.by = "annotation_level1", cols.highlight = mypal_level1, split.by = "annotation_level1") doesn't work

```

*3E: level2 in level1 MDE*
```{r}
so = so_orig[,so_orig@meta.data %>% filter(organ_simplified != "thymus") %>% row.names()]
so_list = SplitObject(so, split.by = "annotation_level1")

pdf(sprintf("%s/MDE_level2_subsetMDEs.pdf", out_dir), 5,5, useDingbats = F)
p = DimPlot(so_list[["CD8"]], reduction = "mde_incremental", group.by = "annotation_level2", cols = mypal_level2, raster = T, raster.dpi = c(1024,1024), pt.size = 1, alpha = 1)
p
p + NoLegend()
p = DimPlot(so_list[["CD4"]], reduction = "mde_incremental", group.by = "annotation_level2", cols = mypal_level2, raster = T, raster.dpi = c(1024,1024), pt.size = 1, alpha = 1)
p
p + NoLegend()
p = DimPlot(so_list[["Treg"]], reduction = "mde_incremental", group.by = "annotation_level2", cols = mypal_level2, raster = T, raster.dpi = c(1024,1024), pt.size = 2, alpha = 1)
p
p + NoLegend()
p = DimPlot(so_list[["gdT"]], reduction = "mde_incremental", group.by = "annotation_level2", cols = mypal_level2, raster = T, raster.dpi = c(1024,1024), pt.size = 2, alpha = 1)
p
p + NoLegend()
p = DimPlot(so_list[["CD8aa"]], reduction = "mde_incremental", group.by = "annotation_level2", cols = mypal_level2, raster = T, raster.dpi = c(1024,1024), pt.size = 2, alpha = 1)
p
p + NoLegend()
p = DimPlot(so_list[["nonconv"]], reduction = "mde_incremental", group.by = "annotation_level2", cols = mypal_level2, raster = T, raster.dpi = c(1024,1024), pt.size = 2, alpha = 1)
p
p + NoLegend()
p = DimPlot(so_list[["DN"]], reduction = "mde_incremental", group.by = "annotation_level2", cols = mypal_level2, raster = T, raster.dpi = c(1024,1024), pt.size = 3, alpha = 1)
p
p + NoLegend()
p = DimPlot(so_list[["DP"]], reduction = "mde_incremental", group.by = "annotation_level2", cols = mypal_level2, raster = T, raster.dpi = c(1024,1024), pt.size = 3, alpha = 1)
p
p + NoLegend()
dev.off()


for (o in unique(so$annotation_level1)) {
    print(o)
    p = DimPlot(object = so_list[[o]], reduction = "mde_incremental", group.by = "annotation_level2", raster = T, raster.dpi = c(512,512)) + scale_color_manual(values = mypal_level2) + NoGrid()
    print(p)
    print(p+ NoLegend())
}
dev.off()


```


*S3A*
Clusters by IGT
```{r}
library(dplyr)
library(rlang)

CompositionOfEachCluster <- function(meta = so@meta.data, cluster_col = "annotation_level2", sample_col  = "IGT") {
    clust  <- sym(cluster_col)
    sample <- sym(sample_col)
    
    # 1) counts per cluster × sample
    comp <- meta %>%
        filter(!is.na(!!clust), !is.na(!!sample)) %>%
        count(!!clust, !!sample, name = "n") %>%
        # 2) normalize within sample (like your tmp2)
        group_by(!!sample) %>%
        mutate(p_in_sample = n / sum(n)) %>%
        ungroup() %>%
        # 3) normalize within cluster (like your tmp3)
        group_by(!!clust) %>%
        mutate(p_weighted = p_in_sample / sum(p_in_sample)) %>%
        ungroup()
    
    # 4) total n per cluster + label "cluster (n=XX)"
    cluster_sizes <- comp %>%
        group_by(!!clust) %>%
        summarise(n_total = sum(n), .groups = "drop") %>%
        mutate(
            clust_chr = as.character(!!clust),
            label = paste0(clust_chr, " (n=", n_total, ")")
        ) %>%
        select(-clust_chr)
    
    # 5) join labels back & make label a factor in a stable order
    comp_labeled <- comp %>%
        left_join(cluster_sizes, by = rlang::as_name(clust)) %>%
        mutate(label = factor(label, levels = cluster_sizes$label))
    
    return(comp_labeled)
}

comp_df = CompositionOfEachCluster(so@meta.data,
                                    cluster_col = "annotation_level2",
                                    sample_col  = "IGT")

head(comp_df)

p <- ggplot(comp_df) +
    geom_bar(
        aes(x = label, y = p_weighted, fill = IGT),
        stat = "identity"
    ) +
    scale_fill_manual(values = mypal_igt) +
    theme_bw() +
    ggtitle("IGT composition in each cluster") +
    theme(
        axis.text.x = element_text(angle = 75, vjust = 0.5, size = 10),
        axis.title.x = element_blank()
    )

pdf(sprintf("%s/Barplot_Level2ByIGT.pdf", out_dir), 15,5, useDingbats = F)
p
p + NoLegend()
dev.off()
```

*3B/C* Proportion of level2 (denominator is level1) in each organ
annotation_level2_PropPerSamplePerLevel1_withMetadata.Rds in composition_anbalysis_igt1_96.Rmd
--> Barplot_Level2ByIGT_healthy.pdf and Barplot_Level2ByIGT.pdf
```{r}
make_comp_dotdata_and_plot <- function(data,
                                       so,
                                       condition_col = "condition_broad") {
    require(dplyr)
    require(tidyr)
    require(ggplot2)
    require(RColorBrewer)
    require(rlang)
    require(tibble)
    cond_sym <- sym(condition_col)
    
    ## 1. Long format with both .prop and .ncells
    data_long <- data %>%
        select(!!cond_sym, IGTHT, matches("\\.(prop|ncells)$")) %>%
        pivot_longer(
            cols = matches("\\.(prop|ncells)$"),
            names_to = c("cluster", "metric"),
            names_sep = "\\.",
            values_to = "value"
        ) %>%
        pivot_wider(
            names_from  = metric,
            values_from = value
        )
    # columns: <condition_col>, IGTHT, cluster, prop, ncells
    
    ## 2. Aggregate across IGTHT for each condition × cluster
    comp_mean <- data_long %>%
        group_by(!!cond_sym, cluster) %>%
        summarise(
            mean_prop    = mean(prop,   na.rm = TRUE),
            total_ncells = sum(ncells,  na.rm = TRUE),
            .groups = "drop"
        )
    
    ## 3. Map clusters to level1 using so@meta.data
    cluster_map <- so@meta.data %>%
        as.data.frame() %>%
        distinct(annotation_level1, annotation_level2)
    
    comp_mean <- comp_mean %>%
        left_join(cluster_map, by = c("cluster" = "annotation_level2"))
    
    ## 4. Cluster conditions (rows) based on similarity in mean_prop
    mat <- comp_mean %>%
        select(!!cond_sym, cluster, mean_prop) %>%
        pivot_wider(
            names_from  = cluster,
            values_from = mean_prop,
            values_fill = list(mean_prop = 0)
        ) %>%
        column_to_rownames(var = as_name(cond_sym)) %>%
        as.matrix()
    
    if (nrow(mat) > 1) {
        organ_order <- rownames(mat)[hclust(dist(mat))$order]
    } else {
        organ_order <- rownames(mat)
    }
    
    comp_mean <- comp_mean %>%
        mutate(
            !!condition_col := factor(!!cond_sym, levels = organ_order)
        )
    
    ## 5. Apply factor orders from Seurat object
    comp_mean <- comp_mean %>%
        mutate(
            annotation_level1 = factor(annotation_level1,
                                       levels = levels(so$annotation_level1)),
            cluster = factor(cluster,
                             levels = levels(so$annotation_level2))
        )
    
    ## 6. Add log10 size
    comp_mean <- comp_mean %>%
        mutate(
            size_log10 = log10(total_ncells + 1)  # +1 protects zeros
        )
    
    ## 7. Build the plot
    p <- ggplot(comp_mean, aes(x = cluster, y = !!cond_sym)) +
        geom_point(
            aes(size = size_log10, fill = mean_prop),
            shape = 21, colour = "black", stroke = 0.2
        ) +
        scale_fill_gradientn(
            colours = RColorBrewer::brewer.pal(9, "Blues"),
            name = "Mean prop"
        ) +
        scale_size(
            range = c(1, 8),
            name = "log10(# cells)"
        ) +
        facet_grid(
            . ~ annotation_level1,
            scales = "free_x",
            space  = "free_x"
        ) +
        labs(x = NULL, y = NULL) +
        theme_minimal(base_size = 11) +
        theme(
            axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1, size = 12),
            axis.text.y = element_text(size = 12),
            panel.grid = element_blank(),
            strip.text = element_text(face = "bold")
        )
    
    # return both data and plot
    list(
        data = comp_mean,
        plot = p
    )
}


m3 = readRDS(file = sprintf("%s/annotation_level2_PropPerSamplePerLevel1_withMetadata.Rds", '/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/analysis/data_integration/IGT1_96/SampleComp/20250226_2'))

pdf(sprintf("%s/DotPlot_Level2ByOrgan_all.pdf", out_dir), 25,6, useDingbats = F)
m4 = m3 %>% filter(organ_simplified != "thymus", target_cells_simplified %in% c("CD45p", "allT")) %>% select(-contains("thymocyte"))
res <- make_comp_dotdata_and_plot(
  data = m4,
  so   = so,
  condition_col = "organ_simplified"   # or "organ_simplified", etc.
)
comp_mean <- res$data
p <- res$plot + scale_fill_gradientn(colours = colorRampPalette(c("white", "black"))(10), name = "Mean prop")
p
dev.off()

pdf(sprintf("%s/DotPlot_Level2ByOrgan_healthy.pdf", out_dir), 25,5, useDingbats = F)
m4 = m3 %>% filter(organ_simplified != "thymus", target_cells_simplified %in% c("CD45p", "allT"), condition_broad == "healthy") %>% select(-contains("thymocyte"))
res <- make_comp_dotdata_and_plot(
  data = m4,
  so   = so,
  condition_col = "organ_simplified"   # or "organ_simplified", etc.
)
comp_mean <- res$data
p <- res$plot + scale_fill_gradientn(colours = colorRampPalette(c("white", "black"))(10), name = "Mean prop")
p
dev.off()

pdf(sprintf("%s/DotPlot_Level2ByConditionBroad_all.pdf", out_dir), 25,4, useDingbats = F)
m4 = m3 %>% filter(organ_simplified != "thymus", target_cells_simplified %in% c("CD45p", "allT")) %>% select(-contains("thymocyte"))
res <- make_comp_dotdata_and_plot(
  data = m4,
  so   = so,
  condition_col = "condition_broad"   # or "organ_simplified", etc.
)
comp_mean <- res$data
p <- res$plot 
p
dev.off()


pdf(sprintf("%s/DotPlot_Level2ByConditionDetailedSimplified_Lung.pdf", out_dir), 22,3.5, useDingbats = F)
m4 = m3 %>% filter(organ_simplified == "lung", target_cells_simplified %in% c("CD45p", "allT")) %>% select(-contains("thymocyte"))
res <- make_comp_dotdata_and_plot(
  data = m4,
  so   = so,
  condition_col = "condition_detailed_simplified"   # or "organ_simplified", etc.
)
comp_mean <- res$data
p <- res$plot #+ scale_fill_gradientn(colours = colorRampPalette(c("white", mypal_organ["lung"]))(10), name = "Mean prop")#scale_fill_gradientn(colours = RColorBrewer::brewer.pal(9, "Greens"), name = "Mean prop")
p
dev.off()

pdf(sprintf("%s/DotPlot_Level2ByConditionDetailedSimplified_Colon.pdf", out_dir), 22,3.5, useDingbats = F)
m4 = m3 %>% filter(organ_simplified == "colon", target_cells_simplified %in% c("CD45p", "allT")) %>% select(-contains("thymocyte"))
res <- make_comp_dotdata_and_plot(
  data = m4,
  so   = so,
  condition_col = "condition_detailed_simplified"   # or "organ_simplified", etc.
)
comp_mean <- res$data
p <- res$plot + scale_fill_gradientn(colours = colorRampPalette(c("white", mypal_organ["colon"]))(10), name = "Mean prop") #RColorBrewer::brewer.pal(9, "Reds")
p
dev.off()


```

*3D/E CD62L CD44 plots*

MDE incremental plots level2
```{r}
# so = so_orig[,so_orig@meta.data %>% filter(organ_simplified != "thymus") %>% row.names()]
# pdf(sprintf("%s/MDEincremental_level2.pdf", out_dir), 30,5, useDingbats = F)
p = DimPlot(object = so, reduction = "mde_incremental", group.by = "annotation_level2", raster = T, raster.dpi = c(512,512), split.by = "annotation_level1", cols = mypal_level2) + NoGrid()
p + NoLegend()
# dev.off()
```


```{r}
so = so_orig[,so_orig@meta.data %>% filter(organ_simplified != "thymus", cite_seq == T) %>% row.names()]
so = NormalizeData(so, assay = "ADT", normalization.method = "LogNormalize")

pdf(sprintf("%s/FeaturePlot_CD62L_CD44.pdf", out_dir), 5,5, useDingbats = F)
# FeaturePlot(so, reduction = "mde2_totalvi_20241006", features = c("CD62L", "CD44"), order = T, cols = c("lightgrey", "blue"), raster = T,max.cutoff = "q99") + ggplot2::xlim(-2.5,2.5) + ggplot2::ylim(-2.5,2.5)#Trgc1, Trgv2
FeaturePlot(so, reduction = "mde2_totalvi_20241006", features = c("CD62L"), order = T, cols = c("lightgrey", "blue"), raster = T,min.cutoff = "q20",max.cutoff = "q70") + ggplot2::xlim(-2.5,2.5) + ggplot2::ylim(-2.5,2.5)#Trgc1, Trgv2
FeaturePlot(so, reduction = "mde2_totalvi_20241006", features = c("CD44"), order = T, cols = c("lightgrey", "brown"), raster = T,min.cutoff = "q20",max.cutoff = "q70") + ggplot2::xlim(-2.5,2.5) + ggplot2::ylim(-2.5,2.5)#Trgc1, Trgv2

so$sub = F
so$sub[sample(x = colnames(so), size = 50000, replace = F)] = T
MyFeatureScatter(so = so[,so$sub], assay = "ADT", slot = "data", feature1 = "CD62L", feature2 = "CD44", group.by = "sub", raster = T,highlight_size = 1) + geom_vline(aes(xintercept = 4.5), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = 5), linetype="dashed", color = "brown") + NoLegend()

so$is_CD62L_pos = so[["ADT"]]@data["CD62L",] > 4.5
MyDimPlotHighlightDensity(seurat_object = so, umap_to_plot = "mde2_totalvi_20241006", group.by = "is_CD62L_pos", raster = T,cols = plasma(10), highlight_size = 0.1, highlight_pixels = c(512,512))
DimPlot(so, reduction = "mde2_totalvi_20241006", group.by = "is_CD62L_pos", raster = T, order = T) + scale_color_manual(values = c("grey", "blue")) + NoLegend()
# so$is_CD44_pos = so[["ADT"]]@data["CD44",] > 5 & so[["ADT"]]@data["CD62L",] < 4

so$is_CD44_pos = so[["ADT"]]@data["CD44",] > 5
MyDimPlotHighlightDensity(seurat_object = so, umap_to_plot = "mde2_totalvi_20241006", group.by = "is_CD44_pos", raster = T, cols = plasma(10), highlight_size = 0.1)
DimPlot(so, reduction = "mde2_totalvi_20241006", group.by = "is_CD44_pos", raster = T, order = T) + scale_color_manual(values = c("grey", "red")) + NoLegend()

so$is_CD62L_sp = so[["ADT"]]@data["CD62L",] > 4.5 & so[["ADT"]]@data["CD44",] < 5
MyDimPlotHighlightDensity(seurat_object = so, umap_to_plot = "mde2_totalvi_20241006", group.by = "is_CD62L_sp", raster = T,cols = plasma(10), highlight_size = 0.1, highlight_pixels = c(512,512)) + ggtitle(label = "CD44- CD62L+")
# DimPlot(so, reduction = "mde2_totalvi_20241006", group.by = "is_CD62L_sp", raster = T, order = T) + scale_color_manual(values = c("grey", "blue")) + NoLegend()
# so$is_CD44_pos = so[["ADT"]]@data["CD44",] > 5 & so[["ADT"]]@data["CD62L",] < 4

so$is_CD44_sp = so[["ADT"]]@data["CD62L",] < 4.5 & so[["ADT"]]@data["CD44",] > 5
MyDimPlotHighlightDensity(seurat_object = so, umap_to_plot = "mde2_totalvi_20241006", group.by = "is_CD44_sp", raster = T,cols = plasma(10), highlight_size = 0.1, highlight_pixels = c(512,512)) + ggtitle(label = "CD44+ CD62L-")

so$is_CD44_CD62L_dp = so[["ADT"]]@data["CD62L",] > 4.5 & so[["ADT"]]@data["CD44",] > 5
MyDimPlotHighlightDensity(seurat_object = so, umap_to_plot = "mde2_totalvi_20241006", group.by = "is_CD44_CD62L_dp", raster = T,cols = plasma(10), highlight_size = 0.1, highlight_pixels = c(512,512)) + ggtitle(label = "CD44+ CD62L+")

so$is_CD44_CD62L_dn = so[["ADT"]]@data["CD62L",] < 4.5 & so[["ADT"]]@data["CD44",] < 5
MyDimPlotHighlightDensity(seurat_object = so, umap_to_plot = "mde2_totalvi_20241006", group.by = "is_CD44_CD62L_dn", raster = T,cols = plasma(10), highlight_size = 0.1, highlight_pixels = c(512,512)) + ggtitle(label = "CD44- CD62L-")

p = DimPlot(so, reduction = "mde2_totalvi_20241006", group.by = "annotation_level2_group") + scale_color_manual(values = mypal_level2group) + NoGrid()
p + NoLegend()

dev.off()

pdf(sprintf("%s/FeaturePlots_CD62L_CD44_Bylevel1.pdf", out_dir), 7,7, useDingbats = F)
so$sub = F
so$sub[sample(x = colnames(so), size = 50000, replace = F)] = T
MyFeatureScatter(so = so[,so$sub], assay = "ADT", slot = "data", feature1 = "CD62L", feature2 = "CD44", group.by = "sub", raster = T,highlight_size = 1) + geom_vline(aes(xintercept = 4.5), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = 5), linetype="dashed", color = "brown") + NoLegend()

MyDimPlotHighlightDensity(seurat_object = so, umap_to_plot = "mde_incremental", group.by = "is_CD62L_pos", , split.by = "annotation_level1", raster = T,cols = plasma(10), highlight_size = 0.5, highlight_pixels = c(512,512)) + ggtitle(label = "CD62L+")

MyDimPlotHighlightDensity(seurat_object = so, umap_to_plot = "mde_incremental", group.by = "is_CD44_pos", split.by = "annotation_level1", raster = T,cols = plasma(10), highlight_size = 0.5, highlight_pixels = c(512,512)) + ggtitle(label = "CD44+")

MyDimPlotHighlightDensity(seurat_object = so, umap_to_plot = "mde_incremental", group.by = "is_CD62L_sp", , split.by = "annotation_level1", raster = T,cols = plasma(10), highlight_size = 0.5, highlight_pixels = c(512,512)) + ggtitle(label = "CD44- CD62L+")

MyDimPlotHighlightDensity(seurat_object = so, umap_to_plot = "mde_incremental", group.by = "is_CD44_sp", split.by = "annotation_level1", raster = T,cols = plasma(10), highlight_size = 0.5, highlight_pixels = c(512,512)) + ggtitle(label = "CD44+ CD62L-")

MyDimPlotHighlightDensity(seurat_object = so, umap_to_plot = "mde_incremental", group.by = "is_CD44_CD62L_dp", split.by = "annotation_level1", raster = T,cols = plasma(10), highlight_size = 0.5, highlight_pixels = c(512,512)) + ggtitle(label = "CD44+ CD62L+")

MyDimPlotHighlightDensity(seurat_object = so, umap_to_plot = "mde_incremental", group.by = "is_CD44_CD62L_dn", split.by = "annotation_level1", raster = T,cols = plasma(10), highlight_size = 0.5, highlight_pixels = c(512,512)) + ggtitle(label = "CD44- CD62L-")
dev.off()

```

*S3B: Conservation of level2 in each dataset - RNA space*
classic silhouette, filter cells in each IGT with at least 10 cell per level2. 
```{r}
library(cluster)
so = so_orig[,so_orig@meta.data %>% filter(organ_simplified != "thymus") %>% row.names()]
# so = NormalizeData(so, assay = "RNA", normalization.method = "LogNormalize")
so$level2_int = as.integer(so[["annotation_level2"]][,1])
DefaultAssay(so) = "RNA"

dict_l2 = so@meta.data %>% count(annotation_level2, level2_int)

sil_summary_list = list()
for (i in unique(so$IGT)) {
    print(i) 
    tmp = so[,so$IGT == i]
    subcl = tmp@meta.data %>% count(annotation_level2) %>% filter(n>10) %>% pull(annotation_level2) %>% as.character()
    if (length(subcl) > 1) {
        tmp = tmp[,tmp$annotation_level2 %in% subcl]
        tmp = tmp %>% 
            NormalizeData(normalization.method = "LogNormalize", verbose = F) %>%
            FindVariableFeatures(selection.method = "vst", nfeatures = 2000, verbose = F) %>%
            ScaleData(features = VariableFeatures(.), verbose = F) %>%    
            RunPCA(features = VariableFeatures(.), npcs = 30, verbose = F) #%>% FindNeighbors(dims = 1:30, verbose = F) %>% RunUMAP(dims = 1:30, seed.use = 123, verbose = T)
        # DimPlot(tmp, reduction = "umap", group.by = "annotation_level2", label = T) + scale_color_manual(values = mypal_level2) + NoLegend()
        
        # message("Calculating silhouette post integration...")
        reduc.dist = dist(tmp[["pca"]]@cell.embeddings)
        cl = as.integer(tmp[["level2_int"]][,1])
        sil_post = silhouette(cl, dist = reduc.dist)
        sil_summary = as.data.frame(sil_post) %>% 
            group_by(cluster) %>% 
            summarise(mean_sil_width = mean(sil_width),
                      median_sil_width = median(sil_width),
                      total = n(),  # Count total observations in each cluster
                      positive_count = sum(sil_width > 0),  # Count negative silhouette widths
                      percentage_positive = (positive_count / total) * 100)     %>%  # Calculate percentage) 
            as.data.frame()
        # sil_summary$cluster == dict_l2$level2_int[match(sil_summary$cluster, dict_l2$level2_int)]
        sil_summary$annotation_level2 = dict_l2$annotation_level2[match(sil_summary$cluster, dict_l2$level2_int)]
        sil_summary$IGT = i
        sil_summary_list[[i]] = sil_summary 
    }
    
}
saveRDS(sil_summary_list, file = "RobustnessLevel2RNASpace_Silhouette_IGT.Rds")

sil_summary_merged = Reduce(rbind, sil_summary_list)

dict_l1 = so@meta.data %>% count(annotation_level1, annotation_level2)
sil_summary_merged$annotation_level1 = dict_l1$annotation_level1[match(sil_summary_merged$annotation_level2, dict_l1$annotation_level2)]
    

sil_summary_merged$annotation_level2 <- factor(
    sil_summary_merged$annotation_level2,
    levels = levels(so$annotation_level2)
)

p_list = list()
for(j in c("mean_sil_width", "median_sil_width", "percentage_positive")) {
    p_list[[j]] = ggplot(sil_summary_merged) + #%>% filter(total > 10
    aes(x = annotation_level2, y = !!sym(j)) +
    geom_jitter(aes(color = IGT),
                width = 0.15, height = 0,
                size = 1.8, alpha = 0.9) +
    geom_boxplot(outlier.shape = NA,
                 fill = "grey90",
                 colour = "black",
                 width = 0.6) +
    scale_color_manual(values = mypal_igt) +
    theme_bw() +
    # labs(
    #     x = "Cluster (annotation_level2)",
    #     y = "Median silhouette width",
    #     color = "IGT"
    # ) +
    facet_grid(
        . ~ annotation_level1,
        scales = "free_x",
        space  = "free_x"
    ) +
    labs(x = NULL, y = NULL) +
    ggtitle(j) +
    theme_minimal(base_size = 11) +
    theme(
        axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1, size = 12),
        axis.text.y = element_text(size = 12),
        panel.grid = element_blank(),
        strip.text = element_text(face = "bold")
    )
}

pdf(sprintf("%s/Boxplot_Level2RNASpace.pdf", out_dir), 25,6, useDingbats = F)
print(p_list[[1]])
print(p_list[[1]] + NoLegend())
print(p_list[[2]] + NoLegend())
print(p_list[[3]] + NoLegend())
dev.off()
# pdf(sprintf("%s/Boxplot_Level2RNASpace.pdf", out_dir), 25,6, useDingbats = F)

```


*S3C: Conservation of level2 in each dataset - Protein/ADT space*
classic silhouette, filter cells in each IGT with at least 10 cell per level2. 
```{r}
library(cluster)
so = so_orig[,so_orig@meta.data %>% filter(organ_simplified != "thymus", cite_seq == T) %>% row.names()]
so$level2_int = as.integer(so[["annotation_level2"]][,1])
DefaultAssay(so) = "ADT"

dict_l2 = so@meta.data %>% count(annotation_level2, level2_int)
#Select only good ADT markers
markers = so[["ADT"]]@meta.features %>% filter(IGT1only == F & classification %in% c("good", "intermediate")) %>% row.names()

sil_summary_list = list()
for (i in unique(so$IGT)) {
    print(i)
    tmp = so[markers,so$IGT == i]
    subcl = tmp@meta.data %>% count(annotation_level2) %>% filter(n>10) %>% pull(annotation_level2) %>% as.character()
    if (length(subcl) > 1) {
        tmp = tmp[,tmp$annotation_level2 %in% subcl]
        tmp = tmp %>% 
            NormalizeData(normalization.method = "CLR", verbose = F) %>%
            FindVariableFeatures(selection.method = "vst", nfeatures = 50, verbose = F) %>%
            ScaleData(features = VariableFeatures(.), verbose = F) %>%    
            RunPCA(features = VariableFeatures(.), npcs = 10, verbose = F) #%>% FindNeighbors(dims = 1:10, verbose = F) %>% RunUMAP(dims = 1:10, seed.use = 123, verbose = T)
        # DimPlot(tmp, reduction = "umap", group.by = "annotation_level2", label = T) + scale_color_manual(values = mypal_level2) + NoLegend()
        
        # message("Calculating silhouette post integration...")
        reduc.dist = dist(tmp[["pca"]]@cell.embeddings)
        cl = as.integer(tmp[["level2_int"]][,1])
        sil_post = silhouette(cl, dist = reduc.dist)
        sil_summary = as.data.frame(sil_post) %>% 
            group_by(cluster) %>% 
            summarise(mean_sil_width = mean(sil_width),
                      median_sil_width = median(sil_width),
                      total = n(),  # Count total observations in each cluster
                      positive_count = sum(sil_width > 0),  # Count negative silhouette widths
                      percentage_positive = (positive_count / total) * 100)     %>%  # Calculate percentage) 
            as.data.frame()
        # sil_summary$cluster == dict_l2$level2_int[match(sil_summary$cluster, dict_l2$level2_int)]
        sil_summary$annotation_level2 = dict_l2$annotation_level2[match(sil_summary$cluster, dict_l2$level2_int)]
        sil_summary$IGT = i
        sil_summary_list[[i]] = sil_summary 
    }
    
}


sil_summary_merged = Reduce(rbind, sil_summary_list)

dict_l1 = so@meta.data %>% count(annotation_level1, annotation_level2)
sil_summary_merged$annotation_level1 = dict_l1$annotation_level1[match(sil_summary_merged$annotation_level2, dict_l1$annotation_level2)]
    

sil_summary_merged$annotation_level2 <- factor(
    sil_summary_merged$annotation_level2,
    levels = levels(so$annotation_level2)
)

p_list = list()
for(j in c("mean_sil_width", "median_sil_width", "percentage_positive")) {
    p_list[[j]] = ggplot(sil_summary_merged) + #%>% filter(total > 10
    aes(x = annotation_level2, y = !!sym(j)) +
    geom_jitter(aes(color = IGT),
                width = 0.15, height = 0,
                size = 1.8, alpha = 0.9) +
    geom_boxplot(outlier.shape = NA,
                 fill = "grey90",
                 colour = "black",
                 width = 0.6) +
    scale_color_manual(values = mypal_igt) +
    theme_bw() +
    # labs(
    #     x = "Cluster (annotation_level2)",
    #     y = "Median silhouette width",
    #     color = "IGT"
    # ) +
    facet_grid(
        . ~ annotation_level1,
        scales = "free_x",
        space  = "free_x"
    ) +
    labs(x = NULL, y = NULL) +
    ggtitle(j) +
    theme_minimal(base_size = 11) +
    theme(
        axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1, size = 12),
        axis.text.y = element_text(size = 12),
        panel.grid = element_blank(),
        strip.text = element_text(face = "bold")
    )
}

pdf(sprintf("%s/Boxplot_Level2ProteinSpace.pdf", out_dir), 25,6, useDingbats = F)
print(p_list[[1]])
print(p_list[[1]] + NoLegend())
print(p_list[[2]])
print(p_list[[3]])
dev.off()
# pdf(sprintf("%s/Boxplot_Level2RNASpace.pdf", out_dir), 25,6, useDingbats = F)

```

colon IGT20, IGT24 and IGT27
```{r}
igt = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/exp_id/20220812_exp_id_13_ColonSI/IGT20/dataset_clean.Rds')
tmp = so_orig
tmp$RNA_clusters = NA
tmp$RNA_clusters = as.character(igt$RNA_clusters[match(colnames(tmp), colnames(igt))])
pdf(sprintf("%s/IGT20_MDE_immgenTclusters.pdf", out_dir), 5,5, useDingbats = F)
mypal_batch = setNames(mypal, unique(igt$RNA_clusters))
mypal_batch = mypal_batch[!is.na(names(mypal_batch))]
igt@meta.data$annotation_level2 = so_orig$annotation_level2[match(colnames(igt), colnames(so_orig))]
igt@meta.data$annotation_level1 = so_orig$annotation_level1[match(colnames(igt), colnames(so_orig))]
DimPlot(igt[,grepl("Colon", igt$sample_name)], reduction = "umap_rna", group.by = "RNA_clusters") + scale_color_manual(values = mypal_batch) + NoGrid()
DimPlot(igt[,grepl("Colon", igt$sample_name)], reduction = "umap_rna", group.by = "annotation_level1") + scale_color_manual(values = mypal_level1) + NoGrid()
DimPlot(igt[,grepl("Colon", igt$sample_name)], reduction = "umap_rna", group.by = "annotation_level2") + scale_color_manual(values = mypal_level2) + NoGrid()
igt_colon = igt[,grepl("Colon", igt$sample_name)]
big_clusters = names(which(table(igt_colon$annotation_level2) >= 50))
p = DimPlot(igt_colon, reduction = "umap_rna", group.by = "annotation_level2", label = FALSE) + scale_color_manual(values = mypal_level2) + NoGrid()
p + NoLegend()
LabelClusters(p, id = "annotation_level2", clusters = big_clusters, size = 3, repel = TRUE, box = T) + NoLegend()

DimPlot(igt[,grepl("Colon", igt$sample_name)], reduction = "umap_adt", group.by = "RNA_clusters") + scale_color_manual(values = mypal_batch) + NoGrid()
DimPlot(igt[,grepl("Colon", igt$sample_name)], reduction = "umap_adt", group.by = "annotation_level1") + scale_color_manual(values = mypal_level1) + NoGrid()
DimPlot(igt[,grepl("Colon", igt$sample_name)], reduction = "umap_adt", group.by = "annotation_level2") + scale_color_manual(values = mypal_level2) + NoGrid()
igt_colon = igt[,grepl("Colon", igt$sample_name)]
big_clusters = names(which(table(igt_colon$annotation_level2) >= 50))
p = DimPlot(igt_colon, reduction = "umap_adt", group.by = "annotation_level2", label = FALSE) + scale_color_manual(values = mypal_level2) + NoGrid()
p + NoLegend()
LabelClusters(p, id = "annotation_level2", clusters = big_clusters, size = 3, repel = TRUE, box = T) + NoLegend()

# tmp2 = data.frame(dim1 = tmp[["mde2_totalvi_20241006"]]@cell.embeddings[, 1], dim2 = tmp[["mde2_totalvi_20241006"]]@cell.embeddings[, 2])
# bkrg = ggplot(tmp2) + scattermore::geom_scattermore(aes(dim1, dim2), color = "grey50", pointsize = 0.5, alpha = 0.5, pixels = c(512,512))
p = DimPlot(tmp[,colnames(igt_colon)], reduction = "mde2_totalvi_20241006", group.by = "annotation_level2", label = FALSE) + scale_color_manual(values = mypal_level2) + NoGrid()
p + NoLegend()
LabelClusters(p, id = "annotation_level2", clusters = big_clusters, size = 3, repel = TRUE, box = T) + NoLegend()

MyDimPlotHighlight(tmp, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(igt)[grepl("Colon", igt$sample_name)], highlight_column_name = "annotation_level2",mycols = mypal_level2, print_plot1 = F, print_plot2 = T, labelclusters = T )
dev.off()

igt = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/exp_id/20221019_exp_id_21_Iliev/IGT27/dataset_clean.Rds')
tmp = so_orig
tmp$RNA_clusters = NA
tmp$RNA_clusters = as.character(igt$RNA_clusters[match(colnames(tmp), colnames(igt))])
pdf(sprintf("%s/IGT27_MDE_immgenTclusters.pdf", out_dir), 5,5, useDingbats = F)
mypal_batch = setNames(mypal, unique(igt$RNA_clusters))
mypal_batch = mypal_batch[!is.na(names(mypal_batch))]
igt@meta.data$annotation_level2 = so_orig$annotation_level2[match(colnames(igt), colnames(so_orig))]
igt@meta.data$annotation_level1 = so_orig$annotation_level1[match(colnames(igt), colnames(so_orig))]
DimPlot(igt[,grepl("No_colon_M", igt$sample_name)], reduction = "umap_rna", group.by = "RNA_clusters") + scale_color_manual(values = mypal_batch) + NoGrid()
DimPlot(igt[,grepl("No_colon_M", igt$sample_name)], reduction = "umap_rna", group.by = "annotation_level1") + scale_color_manual(values = mypal_level1) + NoGrid()
DimPlot(igt[,grepl("No_colon_M", igt$sample_name)], reduction = "umap_rna", group.by = "annotation_level2") + scale_color_manual(values = mypal_level2) + NoGrid()
igt_colon = igt[,grepl("No_colon_M", igt$sample_name)]
big_clusters = names(which(table(igt_colon$annotation_level2) >= 10))
p = DimPlot(igt_colon, reduction = "umap_rna", group.by = "annotation_level2", label = FALSE) + scale_color_manual(values = mypal_level2) + NoGrid()
p + NoLegend()
LabelClusters(p, id = "annotation_level2", clusters = big_clusters, size = 3, repel = TRUE, box = T) + NoLegend()

DimPlot(igt[,grepl("No_colon_M", igt$sample_name)], reduction = "umap_adt", group.by = "RNA_clusters") + scale_color_manual(values = mypal_batch) + NoGrid()
DimPlot(igt[,grepl("No_colon_M", igt$sample_name)], reduction = "umap_adt", group.by = "annotation_level1") + scale_color_manual(values = mypal_level1) + NoGrid()
DimPlot(igt[,grepl("No_colon_M", igt$sample_name)], reduction = "umap_adt", group.by = "annotation_level2") + scale_color_manual(values = mypal_level2) + NoGrid()
igt_colon = igt[,grepl("No_colon_M", igt$sample_name)]
big_clusters = names(which(table(igt_colon$annotation_level2) >= 10))
p = DimPlot(igt_colon, reduction = "umap_adt", group.by = "annotation_level2", label = FALSE) + scale_color_manual(values = mypal_level2) + NoGrid()
p + NoLegend()
LabelClusters(p, id = "annotation_level2", clusters = big_clusters, size = 3, repel = TRUE, box = T) + NoLegend()

# tmp2 = data.frame(dim1 = tmp[["mde2_totalvi_20241006"]]@cell.embeddings[, 1], dim2 = tmp[["mde2_totalvi_20241006"]]@cell.embeddings[, 2])
# bkrg = ggplot(tmp2) + scattermore::geom_scattermore(aes(dim1, dim2), color = "grey50", pointsize = 0.5, alpha = 0.5, pixels = c(512,512))
p = DimPlot(tmp[,colnames(igt_colon)], reduction = "mde2_totalvi_20241006", group.by = "annotation_level2", label = FALSE) + scale_color_manual(values = mypal_level2) + NoGrid()
p + NoLegend()
LabelClusters(p, id = "annotation_level2", clusters = big_clusters, size = 3, repel = TRUE, box = T) + NoLegend()

MyDimPlotHighlight(tmp, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(igt)[grepl("No_colon_M", igt$sample_name)], highlight_column_name = "annotation_level2",mycols = mypal_level2, print_plot1 = F, print_plot2 = T, labelclusters = T )
dev.off()

```

**Figure 4A: cumulative number of clusters**

```{r}
library(dplyr)

## 1. Count cells per IGT × annotation_level2
df_counts <- so@meta.data %>%
  as.data.frame() %>%
  count(IGT, annotation_level2, name = "n_cells") %>%
  mutate(
    IGT_num = as.numeric(gsub("[^0-9]", "", IGT))   # extract numeric part to sort IGT1..IGT96
  )

## 2. Cumulative # cells per cluster across IGTs
df_cum <- df_counts %>%
  arrange(annotation_level2, IGT_num) %>%          # for each cluster, go in IGT order
  group_by(annotation_level2) %>%
  mutate(
    cum_n_cells = cumsum(n_cells)                  # cumulative # cells in this cluster up to this IGT
  ) %>%
  ungroup()

## 3. For each IGT, how many clusters have cum_n_cells > 20 so far?
# igt_cum_clusters <- df_cum %>%
#   group_by(IGT, IGT_num) %>%
#   summarise(
#     n_clusters_gt20 = sum(cum_n_cells > 20),
#     .groups = "drop"
#   ) %>%
#   arrange(IGT_num)

discovery_tbl <- df_cum %>%
  filter(cum_n_cells > 50) %>%                   # only steps where it’s above threshold
  group_by(annotation_level2) %>%
  summarise(
    first_IGT_num = min(IGT_num),                # first time this cluster crosses 20 cells
    .groups = "drop"
  )

## 4. Walk through IGTs in order and compute cumulative discovery
igt_steps <- df_cum %>%
  distinct(IGT, IGT_num) %>%
  arrange(IGT_num)

igt_steps$n_new <- 0L

for (i in seq_len(nrow(igt_steps))) {
  current_num <- igt_steps$IGT_num[i]
  # how many clusters cross the threshold for the FIRST time at this IGT?
  igt_steps$n_new[i] <- sum(discovery_tbl$first_IGT_num == current_num)
}

igt_steps$cum_clusters <- cumsum(igt_steps$n_new)

igt_steps
igt_steps = igt_steps %>% arrange(IGT_num)
igt_steps$IGT = factor(igt_steps$IGT, levels = igt_steps$IGT)

# pdf(sprintf("%s/CumulativeNumberClusters_immgenT.pdf", out_dir,i), 10,5, useDingbats = F)
p = ggplot(igt_steps, aes(x = IGT, y = cum_clusters, group = 1)) +
  geom_line() +
  geom_point(size = 1.5) +
    geom_hline(yintercept = 112, colour = "brown", linetype = "dashed", size = 0.5) +
  # scale_x_continuous(breaks = igt_steps$IGT_num,labels = igt_steps$IGT) +
  labs(
    x = "IGT",
    y = "Cumulative # clusters (cum_n_cells > 50)",
    title = "Cumulative discovery of clusters across IGTs",
    subtitle = "number of clusters detected=cumsum reaching least 50 cells"
  ) +
    ylim(0,115) +
  theme_bw(base_size = 11) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
p + NoGrid()
# dev.off()


```


**Figure 4 T-RBI**
see here for https://docs.google.com/spreadsheets/d/10icsN1kaUNOgMYi-oVTFx8AH9CI_52SlQb3p798MfQY/edit?usp=sharing
GSE186164_IEL_CD8aa - ctrl IEL only
GSE141895_Baranek_iNKT_Fhl2 - WT only
GSE189485_Thymus_Lung_Liver_Spleen - remove thymus?
GSE239558_mLN_Ileum_Colon maybe
```{r}
paths = c(GSE244487 = "/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE244487_conceicao-neto_exhaustion/Not_classified_Full_Trial/Not_classified_loop_fixed/Final_Seurat_object.Rds",
GSE160055 = "/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD4/GSE160055_mouse_colon_LP_CD4_conditions/Not_classified_Full_Trial/Not_classified_loop_fixed/Final_Seurat_object.Rds",
GSE253394 = "/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD4/GSE253394_chlamydia/Not_classified_Full_Trial/Not_classified_loop_fixed/Final_Seurat_object.Rds",
GSE122712 = "/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE122712/Not_classified_Full_Trial/Not_classified_loop_fixed/Final_Seurat_object.Rds",
GSE131535 = "/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE131535/Not_classified_Full_Trial/Not_classified_loop_fixed/Final_Seurat_object.Rds",
GSE164978 = "/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE164978_CD8_atlas/Not_classified_Full_Trial/Not_classified_loop_fixed/Final_Seurat_object.Rds",
GSE182275 = "/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE182275/Not_classified_Full_Trial/Not_classified_loop_fixed/Final_Seurat_object.Rds",
GSE202543 = "/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE202543_Giovanni_CAR_T/Not_classified_Full_Trial/Not_classified_loop_fixed/Final_Seurat_object.Rds",
GSE199563 = "/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE199563_Giles_Wherry_Exhausted/Trial_Final/Final_Seurat_object.Rds",
GSE186164 = "/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8aa/GSE186164_IEL_CD8aa/Not_classified_Full_Trial/Not_classified_loop_fixed/Final_Seurat_object.Rds",
GSE129030 = '/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/DN/GSE129030_DN_Naive_Activated/Not_classified_Full_Trial/Not_classified_loop_fixed/Final_Seurat_object.Rds',
GSE141895 = "/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/iNKT/GSE141895_Baranek_iNKT_Fhl2/Not_classified_Full_Trial/Not_classified_loop_fixed/Final_Seurat_object.Rds",
GSE189485 = "/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/MAIT/GSE189485_Thymus_Lung_Liver_Spleen/Not_classified_Full_Trial/Not_classified_loop_fixed/Final_Seurat_object.Rds",
GSE239558 = "/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/MAIT/GSE239558_mLN_Ileum_Colon/Not_classified_Full_Trial/Not_classified_loop_fixed/Final_Seurat_object.Rds",
TabulaMuris = "/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/Treg/Tabula_muris_Senis/T_cells/Not_classified_Full_Trial/Not_classified_loop_fixed/Final_Seurat_object.Rds",
GSE196338 = "/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/Treg/GSE196338_Gut_RORg+_Tregs/Not_classified_Full_Trial/Not_classified_loop_fixed/Final_Seurat_object.Rds",
GSE234317 = "/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/Treg/GSE234317_Treg_Meninges/Not_classified_Full_Trial/Not_classified_loop_fixed/Final_Seurat_object.Rds")

so_list = list()
for (i in names(paths)) {
    print(i)
   so_list[[i]] = readRDS(paths[i])
}

saveRDS(so_list, file = "trbi_17studies.Rds")

```

Merge on Midway3
```{r}
library(Seurat)
library(purrr)

so_list = readRDS("trbi_17studies.Rds")

so_list_slim = list()

for (i in 1:length(so_list)) {
    print(i)
    obj = so_list[[i]]
    dim_keep <- intersect(c("mde_incremental_allT", "mde_incremental_level2"), names(obj@reductions))
    features_keep = intersect(c("Cd4", "Cd8b1", "Cd8a", "Trdc", "Foxp3", "Zbtb16"), rownames(obj[["RNA"]]@counts))
    
    message("DietSeurat...")
    obj_slim = DietSeurat(
    obj,
    assays = "RNA",
    layers = "counts",
    features = features_keep,
    dimreducs  = dim_keep,
    misc       = FALSE
  )
    
    obj_slim$dataset = names(so_list)[i]
    
    message("Rename cells...")
    obj_slim = RenameCells(obj_slim, new.names = paste0(names(so_list)[i], "_", colnames(obj_slim)))
    
    so_list_slim[[names(so_list)[i]]] = obj_slim
                          
}

# Merge all slimmed objects
so_merged = merge(so_list_slim[[1]],so_list_slim[2:length(so_list_slim)],  collapse = T, merge.data = T, merge.dr = T)
# so_merged = Reduce(function(x, y) merge(x, y), so_list_slim)
so_merged
so_merged_orig$level1_final[so_merged_orig$dataset == "GSE199563"] = "CD8"
saveRDS(so_merged, file = "trbi_17studies_diet_merged.Rds")

```

Table with datasets and cell counts: 335042
```{r}
so_merged_orig = readRDS("trbi_17studies_diet_merged.Rds")
# so_merged_orig@meta.data %>% count(dataset,sample_name, name = "n_cells") %>% write.table(file = "trbi_17studies_table.txt", row.names = F, col.names = T, sep = "\t", quote = F)

so_merged = so_merged_orig[,!so_merged_orig$level1_final %in% c("nonT", "unclear")]

```

```{r}
so_merged_orig = readRDS("trbi_17studies_diet_merged.Rds")

igt_bkrg = data.frame(dim1 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,1], dim2 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,2])
bkrg = ggplot(igt_bkrg) + geom_scattermore(aes(dim1, dim2), colour = "grey", alpha = 0.5, pixels = c(1024, 1024))

dat_frg = data.frame(so_merged@meta.data[rownames(so_merged[["mde_incremental_allT"]]),], dim1 = so_merged[["mde_incremental_allT"]]@cell.embeddings[,1], dim2 = so_merged[["mde_incremental_allT"]]@cell.embeddings[,2])

pdf(sprintf("%s/TRBI_MDEmain_dataset.pdf", out_dir), 5,5, useDingbats = F)
p = bkrg + geom_scattermore(data = dat_frg, aes(dim1, dim2, color = dataset), size =2, pixels = c(c(1024, 1024))) + scale_color_manual(values = mypal) + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid()
p
p + NoLegend()
dev.off()

pdf(sprintf("%s/TRBI_MDEmain_level1_perdataset.pdf", out_dir), 5,5, useDingbats = F)
bkrg + geom_scattermore(data = dat_frg, aes(dim1, dim2, color = level1_final), size =2, pixels = c(c(1024, 1024))) + scale_color_manual(values = mypal_level1) + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()
for (i in unique(dat_frg$dataset)) {
    print(i)
   p = bkrg + geom_scattermore(data = dat_frg %>% filter(dataset == i), aes(dim1, dim2, color = level1_final), size =2, pixels = c(c(1024, 1024))) + scale_color_manual(values = mypal_level1) + ggtitle(label = i) + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()
   print(p)
}
dev.off()
# DimPlot(so_merged, reduction = "mde_incremental_allT",group.by = "level1_final", raster.dpi = c(1024, 1024)) + scale_color_manual(values = mypal_level1) + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()
# DimPlot(so_merged, reduction = "mde_incremental_allT",group.by = "is_nont", raster.dpi = c(1024, 1024)) + scale_color_manual(values = c("grey", "red")) + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()


pdf(sprintf("%s/TRBI_MDEmain_level2_perdataset.pdf", out_dir), 5,5, useDingbats = F)
bkrg + geom_scattermore(data = dat_frg, aes(dim1, dim2, color = level2_final), size =2, pixels = c(c(1024, 1024))) + scale_color_manual(values = c(mypal_level1, mypal_level2)) + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()
for (i in unique(dat_frg$dataset)) {
    print(i)
   p = bkrg + geom_scattermore(data = dat_frg %>% filter(dataset == i), aes(dim1, dim2, color = level2_final), size =2, pixels = c(c(1024, 1024))) + scale_color_manual(values = c(mypal_level1, mypal_level2)) + ggtitle(label = i) + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()
   print(p)
}
dev.off()

```


FeaturePlots
```{r}
pdf(sprintf("%s/TRBI_FeaturePlots.pdf", out_dir), 5,5, useDingbats = F)
FeaturePlot(so_merged_orig, raster.dpi = c(1024, 1024), features = c("Cd4"), order = T,reduction = "mde_incremental_allT", max.cutoff = "q90") + xlim(-2.5,2.5) + ylim(-2.5,2.5) + theme_void()
FeaturePlot(so_merged_orig, raster.dpi = c(1024, 1024), features = c("Cd8b1"), order = T,reduction = "mde_incremental_allT") + xlim(-2.5,2.5) + ylim(-2.5,2.5) + theme_void()
FeaturePlot(so_merged_orig, raster.dpi = c(1024, 1024), features = c("Cd8a"), order = T,reduction = "mde_incremental_allT") + xlim(-2.5,2.5) + ylim(-2.5,2.5) + theme_void()
FeaturePlot(so_merged_orig, raster.dpi = c(1024, 1024), features = c("Trdc"), order = T,reduction = "mde_incremental_allT", max.cutoff = "q90") + xlim(-2.5,2.5) + ylim(-2.5,2.5) + theme_void()
FeaturePlot(so_merged_orig, raster.dpi = c(1024, 1024), features = c("Foxp3"), order = T,reduction = "mde_incremental_allT",max.cutoff = "q90") + xlim(-2.5,2.5) + ylim(-2.5,2.5) + theme_void()
FeaturePlot(so_merged_orig, raster.dpi = c(1024, 1024), features = c("Zbtb16"), order = T,reduction = "mde_incremental_allT",max.cutoff = "q90") + xlim(-2.5,2.5) + ylim(-2.5,2.5) + theme_void()
dev.off()
```

showing nonT outside the MDE
```{r}
igt_bkrg = data.frame(dim1 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,1], dim2 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,2])
bkrg = ggplot(igt_bkrg) + geom_scattermore(aes(dim1, dim2), colour = "grey", alpha = 0.5, pixels = c(1024, 1024))

so_merged_orig$is_nont = so_merged_orig$level1_final == "nonT"
dat_frg = data.frame(so_merged_orig@meta.data[rownames(so_merged_orig[["mde_incremental_allT"]]),], dim1 = so_merged_orig[["mde_incremental_allT"]]@cell.embeddings[,1], dim2 = so_merged_orig[["mde_incremental_allT"]]@cell.embeddings[,2])

pdf(sprintf("%s/TRBI_MDEmain_nonT.pdf", out_dir), 5,5, useDingbats = F)
bkrg + geom_scattermore(data = dat_frg, aes(dim1, dim2, color = is_nont), size =3, pixels = c(c(1024, 1024))) + ggtitle(label = "nonT in red, others in black, immgenT in grey") + scale_color_manual(values = c("grey0", "red")) + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()
bkrg + geom_scattermore(data = dat_frg, aes(dim1, dim2), color = "black", size =3, pixels = c(c(1024, 1024))) +
    geom_point(data = dat_frg[dat_frg$is_nont,], aes(dim1, dim2), color = "red",size = 1, alpha = 0.1) + ggtitle(label = "nonT in red, others in black, immgenT in grey") + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()
dev.off()

```

MDE per dataset with immgent in background
```{r}
igt_bkrg = data.frame(dim1 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,1], dim2 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,2])
bkrg = ggplot(igt_bkrg) + geom_scattermore(aes(dim1, dim2), colour = "grey", alpha = 0.5, pixels = c(1024, 1024))

dat_frg = data.frame(so_merged@meta.data[rownames(so_merged[["mde_incremental_allT"]]),], dim1 = so_merged[["mde_incremental_allT"]]@cell.embeddings[,1], dim2 = so_merged[["mde_incremental_allT"]]@cell.embeddings[,2])

pdf(sprintf("%s/TRBI_MDEmain_level1_perdataset.pdf", out_dir), 5,5, useDingbats = F)
bkrg + geom_scattermore(data = dat_frg, aes(dim1, dim2, color = level1_final), size =2, pixels = c(c(1024, 1024))) + scale_color_manual(values = mypal_level1) + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()
for (i in unique(dat_frg$dataset)) {
    print(i)
   p = bkrg + geom_scattermore(data = dat_frg %>% filter(dataset == i), aes(dim1, dim2, color = level1_final), size =2, pixels = c(c(1024, 1024))) + scale_color_manual(values = mypal_level1) + ggtitle(label = i) + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()
   print(p)
}
dev.off()
# DimPlot(so_merged, reduction = "mde_incremental_allT",group.by = "level1_final", raster.dpi = c(1024, 1024)) + scale_color_manual(values = mypal_level1) + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()
# DimPlot(so_merged, reduction = "mde_incremental_allT",group.by = "is_nont", raster.dpi = c(1024, 1024)) + scale_color_manual(values = c("grey", "red")) + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()


pdf(sprintf("%s/TRBI_MDEmain_level2_perdataset.pdf", out_dir), 5,5, useDingbats = F)
bkrg + geom_scattermore(data = dat_frg, aes(dim1, dim2, color = level2_final), size =2, pixels = c(c(1024, 1024))) + scale_color_manual(values = c(mypal_level1, mypal_level2)) + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()
for (i in unique(dat_frg$dataset)) {
    print(i)
   p = bkrg + geom_scattermore(data = dat_frg %>% filter(dataset == i), aes(dim1, dim2, color = level2_final), size =2, pixels = c(c(1024, 1024))) + scale_color_manual(values = c(mypal_level1, mypal_level2)) + ggtitle(label = i) + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()
   print(p)
}
dev.off()


DimPlot(so_merged2[,so_merged2$level1_final == "CD8"], reduction = "mde_incremental_level2",group.by = "level2_final", raster.dpi = c(1024, 1024), split.by = "dataset", ncol = 5) + scale_color_manual(values = c(mypal_level2,mypal_level1) ) + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()

FeaturePlot(so_merged2[,so_merged2$level1_final == "CD8"], features = c("Cd8a"), order = T,reduction = "mde_incremental_level2") + xlim(-2.5,2.5) + ylim(-2.5,2.5) 
```

Barplot with % annotated
326 not classified out of 299764 cells in level1
```{r}
prop_level1_per_dataset = so_merged@meta.data %>%
  as.data.frame() %>%
  count(dataset, level1_final, name = "n_cells") %>%  
  group_by(dataset) %>%
  mutate(
    total_cells = sum(n_cells),
    prop = n_cells / total_cells                   
  ) %>%
  ungroup()

prop_level2_per_dataset = so_merged@meta.data %>%
  as.data.frame() %>%
  count(dataset, level2_final, name = "n_cells") %>%    
  group_by(dataset) %>%
  mutate(
    total_cells = sum(n_cells),
    prop = n_cells / total_cells                     
  ) %>%
    filter(level2_final %in% c("not classified","CD4", "CD8", "Treg", "gdT", "nonconv", "CD8aa", "DN", "DP", "thymocyte")) %>%                          # keep only selected categories
  group_by(dataset) %>%
  summarise(prop_notclass = sum(prop), .groups = "drop") 


pdf(sprintf("%s/TRBI_barplot_notclassified_perdataset.pdf", out_dir), 5,5, useDingbats = F)
ggplot(data = prop_level1_per_dataset %>% filter(level1_final == "not classified"), aes(x = dataset, y = (1-prop)*100)) +
  geom_col(fill = "black") +
  labs(
    x = "Dataset",
    y = "% not annotated",
    title = "Fraction of 'not classified' cells per dataset at level1"
  ) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  NoGrid()

ggplot(data = prop_level2_per_dataset, aes(x = dataset, y = (1-prop_notclass)*100)) +
  geom_col(fill = "black") +
  labs(
    x = "Dataset",
    y = "% not annotated",
    title = "Fraction of 'not classified' cells per dataset at level2"
  ) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  NoGrid()
dev.off()


```

326 not classified out of 299764 cells in level1
11256 not classified in level2
```{r}
igt_bkrg = data.frame(dim1 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,1], dim2 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,2])
bkrg = ggplot(igt_bkrg) + geom_scattermore(aes(dim1, dim2), colour = "grey", alpha = 0.5, pixels = c(1024, 1024))

pdf(sprintf("%s/TRBI_MDEmain_notclassified.pdf", out_dir), 5,5, useDingbats = F)
so_merged$is_noclassl1 = so_merged$level1_final == "not classified"
dat_frg = data.frame(so_merged@meta.data[rownames(so_merged[["mde_incremental_allT"]]),], dim1 = so_merged[["mde_incremental_allT"]]@cell.embeddings[,1], dim2 = so_merged[["mde_incremental_allT"]]@cell.embeddings[,2])
bkrg + geom_scattermore(data = dat_frg, aes(dim1, dim2), col = "grey0", size =3, pixels = c(c(1024, 1024))) + 
    geom_point(data = dat_frg[dat_frg$is_noclassl1,], aes(dim1, dim2), color = "red", size =0.25) + 
    ggtitle(label = "not classified level1 in red") + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()

so_merged$is_noclassl2 = so_merged$level2_final %in% c("not classified", "CD4", "CD8", "Treg", "gdT", "nonconv", "CD8aa", "DN", "DP", "thymocyte")
dat_frg = data.frame(so_merged@meta.data[rownames(so_merged[["mde_incremental_allT"]]),], dim1 = so_merged[["mde_incremental_allT"]]@cell.embeddings[,1], dim2 = so_merged[["mde_incremental_allT"]]@cell.embeddings[,2])
bkrg + geom_scattermore(data = dat_frg, aes(dim1, dim2), col = "grey0", size =3, pixels = c(c(1024, 1024))) + 
    geom_scattermore(data = dat_frg[dat_frg$is_noclassl2,], aes(dim1, dim2), color = "red", pixels = c(512, 512)) + 
    ggtitle(label = "not classified level2 in red") + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()

dev.off()

```

Discovery score functions
```{r}
library(RANN)
library(dplyr)

# old_mat: numeric matrix/data.frame with columns x,y (100000 x 2)
# new_mat: numeric matrix/data.frame with columns x,y (1000 x 2)
# k: number of neighbors for the metric, e.g., 10
# --- usage ---
# old_mat <- as.matrix(old_df[, c("x","y")])
# new_mat <- as.matrix(new_df[, c("x","y")])
# s <- knn_novelty_scores(old_mat, new_mat, k = 10)
# summarize_discovery(s, ratio_threshold = 1.2)

knn_novelty_scores <- function(old_mat, new_mat, k = 10) {
  old_mat <- as.matrix(old_mat)
  new_mat <- as.matrix(new_mat)
  stopifnot(ncol(old_mat) >= 2, ncol(new_mat) >= 2, ncol(old_mat) == ncol(new_mat))
  if (nrow(new_mat) <= k) stop("Need k < number of new points.")

  # Mean distance to k nearest REFERENCE neighbors
  ref_knn <- nn2(data = old_mat, query = new_mat, k = k)
  mean_d_ref <- rowMeans(ref_knn$nn.dists)

  # Mean distance to k nearest QUERY neighbors (leave-one-out: drop the self at distance 0)
  qry_knn <- nn2(data = new_mat, query = new_mat, k = k + 1)
  # First column is self (distance 0). Remove it; take the next k neighbors.
  mean_d_qry <- rowMeans(qry_knn$nn.dists[, -1, drop = FALSE])

  # Scores
  ratio <- mean_d_ref / mean_d_qry
  score_log <- log(ratio)
  score_sym <- (mean_d_ref - mean_d_qry) / (mean_d_ref + mean_d_qry)  # in [-1, 1]

  tibble::tibble(
    idx = seq_len(nrow(new_mat)),
    mean_d_ref = mean_d_ref,
    mean_d_qry = mean_d_qry,
    ratio = ratio,
    score_log = score_log,
    score_sym = score_sym
  )
}

summarize_discovery <- function(scores_tbl, ratio_threshold = 2) {
  # "Discovery rate": fraction of new points at least 20% farther from ref than from query neighbors
  discovery_ncells <- sum(na.omit(scores_tbl$ratio > ratio_threshold)) #mean(scores_tbl$ratio > ratio_threshold)
  tibble::tibble(
    k = NA_integer_,
    ratio_threshold = ratio_threshold,
    discovery_ncells = discovery_ncells,
    median_ratio = median(na.omit(scores_tbl$ratio)),
    q90_ratio = quantile(na.omit(scores_tbl$ratio), 0.9),
    mean_log_score = mean(na.omit(scores_tbl$score_log))
  )
}

```

Discovery score of not classified cells within each dataset RNA PCA/UMAP
```{r}
summaries_list2 = list()
scores_tbl_list2 = list()

for (i in unique(so_merged$dataset)) {
    print(i)
    tmp = readRDS(paths[i])
    tmp = tmp[,tmp@meta.data %>% filter(!level2_final %in% c("nonT", "unclear")) %>% row.names()]
    # tmp = tmp %>%
    #     NormalizeData(normalization.method = "LogNormalize", verbose = F) %>%
    #     FindVariableFeatures(selection.method = "vst", nfeatures = 2000, verbose = F) %>%
    #     ScaleData(features = VariableFeatures(.), verbose = F) %>%
    #     RunPCA(features = VariableFeatures(.), npcs = 30, verbose = F) %>%
    #     FindNeighbors(dims = 1:30, verbose = F) %>%
    #     RunUMAP(dims = 1:30, seed.use = 123, verbose = T)
    if (!"mde_incremental_allT" %in% names(tmp@reductions)) {
        message("Skipping ", i, ": no mde_incremental_allT")
        next
    }
    if (!"umap_rna" %in% names(tmp@reductions)) {
        message("Skipping ", i, ": no umap_rna")
        next
    }
    if (!"pca_rna" %in% names(tmp@reductions)) {
        message("Skipping ", i, ": no pca_rna")
        next
    }
    
    tmp$is_noclassl2 = F
    tmp$is_noclassl2[tmp$level2_final %in% c("not classified", "CD8", "Treg", "CD4", "nonconv",  "gdT", "CD8aa","DN", "DP")] = T
    old_mat = tmp[["pca_rna"]]@cell.embeddings[tmp$is_noclassl2 == F,]
    new_mat = tmp[["pca_rna"]]@cell.embeddings[tmp$is_noclassl2 == T,]
    scores_tbl = knn_novelty_scores(old_mat, new_mat, k = 10) %>% as.data.frame()
    rownames(scores_tbl) = rownames(new_mat)
    scores_tbl$dataset = i
    scores_tbl$mde_incremental_allT_dim1 = tmp[["mde_incremental_allT"]]@cell.embeddings[rownames(scores_tbl),1]
    scores_tbl$mde_incremental_allT_dim2 = tmp[["mde_incremental_allT"]]@cell.embeddings[rownames(scores_tbl),2]
    scores_tbl_list2[[i]] = scores_tbl
    
    tmp$score_log = NA
    tmp$score_log = scores_tbl$score_log[match(colnames(tmp), rownames(scores_tbl))]
    tmp$score_log = scores_tbl$score_log[match(colnames(tmp), rownames(scores_tbl))]
    tmp$discovery = tmp$score_log > log(2)
    
    pdf(sprintf("%s/TRBI_%s_discovery_DatasetPCA.pdf", out_dir,i), 5,5, useDingbats = F)
    p1 = FeaturePlot(tmp, reduction = "umap_rna",features = "score_log")
    p2 = DimPlot(tmp, reduction = "umap_rna",group.by = "discovery", order = T) + scale_color_manual(values = c("black", "red"))
    igt_bkrg = data.frame(dim1 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,1], dim2 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,2])
    bkrg = ggplot(igt_bkrg) + geom_scattermore(aes(dim1, dim2), colour = "grey", alpha = 0.5, pixels = c(1024, 1024))
    dat_frg = data.frame(tmp@meta.data[rownames(tmp[["mde_incremental_allT"]]),], dim1 = tmp[["mde_incremental_allT"]]@cell.embeddings[,1], dim2 = tmp[["mde_incremental_allT"]]@cell.embeddings[,2])
    p3 = bkrg + geom_scattermore(data = dat_frg, aes(dim1, dim2), col = "grey0", size =3, pixels = c(c(1024, 1024))) + 
        geom_point(data = dat_frg[dat_frg$discovery,], aes(dim1, dim2), color = "red", size =1) + 
        ggtitle(label = sprintf("%s: black the dataset cells,\nred not classified with potential new state", i)) + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()
    print(p1)
    print(p2)
    print(p3)
    dev.off()
    # FeaturePlot(tmp, slot = "counts", reduction = "mde_incremental_allT",features = c("Cd4", "Cd8b1", "Cd8a", "Foxp3", "Zbtb16","Trdc"), order = T)
    
    discovery_report = data.frame(dataset = i, summarize_discovery(scores_tbl, ratio_threshold = 2) %>% as.data.frame())
    discovery_report %>% write.table(sprintf("%s/TRBI_%s_discovery_DatasetPCA.txt", out_dir,i), quote = F, row.names = F, col.names = T, sep = "\t")
    summaries_list2[[i]] = discovery_report
    
}

summaries_merged2 = Reduce(rbind, summaries_list2)
# write.table(summaries_merged2, file = sprintf("%s/TRBI_discovery_summary_dataset_DatasetPCA.txt", out_dir), row.names = F, col.names = T,quote = F )
scores_tbl_merged2 = Reduce(rbind, scores_tbl_list2)
# saveRDS(scores_tbl_merged2, file = sprintf("%s/TRBI_discovery_scores_tbl_merged_DatasetPCA.Rds", out_dir))

pdf(sprintf("%s/TRBI_discovery_scores_tbl_merged_DatasetPCA.pdf", out_dir,i), 5,5, useDingbats = F)
ggplot(scores_tbl_merged2, aes(x = dataset, y = score_log)) +
    # boxplot first (no outlier points, so we see our own points instead)
    geom_boxplot(outlier.shape = NA, fill = NA, colour = "black") +
    # scatter on top (jittered)
    geom_jitter(width = 0.2, alpha = 0.3, size = 0.1) +
    geom_hline(yintercept = log(2), colour = "brown", linetype = "dashed", size = 0.5) +
    labs(
        x = "Dataset",
        y = "score_log",
        title = "score_log distribution per dataset"
    ) +
    # ylim(-1.1,1.1)+
    theme_bw(base_size = 11) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    ) + NoGrid()
dev.off()

igt_bkrg = data.frame(dim1 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,1], dim2 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,2])
bkrg = ggplot(igt_bkrg) + geom_scattermore(aes(dim1, dim2), colour = "grey", alpha = 0.5, pixels = c(1024, 1024))

pdf(sprintf("%s/TRBI_MDEmain_discoveryscore.pdf", out_dir), 5,5, useDingbats = F)
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
dat_frg = data.frame(so_merged@meta.data[rownames(so_merged[["mde_incremental_allT"]]),], dim1 = so_merged[["mde_incremental_allT"]]@cell.embeddings[,1], dim2 = so_merged[["mde_incremental_allT"]]@cell.embeddings[,2])
p = bkrg + geom_scattermore(data = dat_frg, aes(dim1, dim2), col = "grey0", size =3, pixels = c(c(1024, 1024))) + 
    geom_point(data = scores_tbl_merged2[!is.na(scores_tbl_merged2$score_log),], aes(mde_incremental_allT_dim1, mde_incremental_allT_dim2, colour = score_log), size =0.25) + scale_color_gradientn(colours = ColorRamp, limits  = c(-1, 1), oob = scales::squish) + ggtitle(label = "discovery score") + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() 
p
p + NoLegend()
dev.off()



```

Discovery score of not classified cells within each dataset RNA PCA/UMAP keeping nonT and unclear
```{r}
summaries_list2 = list()
scores_tbl_list2 = list()

for (i in unique(so_merged$dataset)) {
    print(i)
    tmp = readRDS(paths[i])
    # tmp = tmp[,tmp@meta.data %>% filter(!level2_final %in% c("nonT", "unclear")) %>% row.names()]
    # tmp = tmp %>%
    #     NormalizeData(normalization.method = "LogNormalize", verbose = F) %>%
    #     FindVariableFeatures(selection.method = "vst", nfeatures = 2000, verbose = F) %>%
    #     ScaleData(features = VariableFeatures(.), verbose = F) %>%
    #     RunPCA(features = VariableFeatures(.), npcs = 30, verbose = F) %>%
    #     FindNeighbors(dims = 1:30, verbose = F) %>%
    #     RunUMAP(dims = 1:30, seed.use = 123, verbose = T)
    if (!"mde_incremental_allT" %in% names(tmp@reductions)) {
        message("Skipping ", i, ": no mde_incremental_allT")
        next
    }
    if (!"umap_rna" %in% names(tmp@reductions)) {
        message("Skipping ", i, ": no umap_rna")
        next
    }
    if (!"pca_rna" %in% names(tmp@reductions)) {
        message("Skipping ", i, ": no pca_rna")
        next
    }
    
    tmp$is_noclassl2 = F
    tmp$is_noclassl2[tmp$level2_final %in% c("not classified", "CD8", "Treg", "CD4", "nonconv",  "gdT", "CD8aa","DN", "DP", "nonT", "unclear")] = T
    old_mat = tmp[["pca_rna"]]@cell.embeddings[tmp$is_noclassl2 == F,]
    new_mat = tmp[["pca_rna"]]@cell.embeddings[tmp$is_noclassl2 == T,]
    scores_tbl = knn_novelty_scores(old_mat, new_mat, k = 10) %>% as.data.frame()
    rownames(scores_tbl) = rownames(new_mat)
    scores_tbl$dataset = i
    scores_tbl$mde_incremental_allT_dim1 = tmp[["mde_incremental_allT"]]@cell.embeddings[rownames(scores_tbl),1]
    scores_tbl$mde_incremental_allT_dim2 = tmp[["mde_incremental_allT"]]@cell.embeddings[rownames(scores_tbl),2]
    scores_tbl_list2[[i]] = scores_tbl
    
    tmp$score_log = NA
    tmp$score_log = scores_tbl$score_log[match(colnames(tmp), rownames(scores_tbl))]
    tmp$score_log = scores_tbl$score_log[match(colnames(tmp), rownames(scores_tbl))]
    tmp$discovery = tmp$score_log > log(2)
    
    pdf(sprintf("%s/TRBI_%s_discovery_DatasetPCA_withnonT.pdf", out_dir,i), 5,5, useDingbats = F)
    p1 = FeaturePlot(tmp, reduction = "umap_rna",features = "score_log")
    p2 = DimPlot(tmp, reduction = "umap_rna",group.by = "discovery", order = T) + scale_color_manual(values = c("black", "red"))
    igt_bkrg = data.frame(dim1 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,1], dim2 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,2])
    bkrg = ggplot(igt_bkrg) + geom_scattermore(aes(dim1, dim2), colour = "grey", alpha = 0.5, pixels = c(1024, 1024))
    dat_frg = data.frame(tmp@meta.data[rownames(tmp[["mde_incremental_allT"]]),], dim1 = tmp[["mde_incremental_allT"]]@cell.embeddings[,1], dim2 = tmp[["mde_incremental_allT"]]@cell.embeddings[,2])
    p3 = bkrg + geom_scattermore(data = dat_frg, aes(dim1, dim2), col = "grey0", size =3, pixels = c(c(1024, 1024))) + 
        geom_point(data = dat_frg[dat_frg$discovery,], aes(dim1, dim2), color = "red", size =1) + 
        ggtitle(label = sprintf("%s: black the dataset cells,\nred not classified with potential new state", i)) + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()
    print(p1)
    print(p2)
    print(p3)
    dev.off()
    # FeaturePlot(tmp, slot = "counts", reduction = "mde_incremental_allT",features = c("Cd4", "Cd8b1", "Cd8a", "Foxp3", "Zbtb16","Trdc"), order = T)
    
    discovery_report = data.frame(dataset = i, summarize_discovery(scores_tbl, ratio_threshold = 2) %>% as.data.frame())
    discovery_report %>% write.table(sprintf("%s/TRBI_%s_discovery_DatasetPCA_withnonT.txt", out_dir,i), quote = F, row.names = F, col.names = T, sep = "\t")
    summaries_list2[[i]] = discovery_report
    
}

summaries_merged2 = Reduce(rbind, summaries_list2)
# write.table(summaries_merged2, file = sprintf("%s/TRBI_discovery_summary_dataset_DatasetPCA_withnonT.txt", out_dir), row.names = F, col.names = T,quote = F )
scores_tbl_merged2 = Reduce(rbind, scores_tbl_list2)
# saveRDS(scores_tbl_merged2, file = sprintf("%s/TRBI_discovery_scores_tbl_merged_DatasetPCA_withnonT.Rds", out_dir))

pdf(sprintf("%s/TRBI_discovery_scores_tbl_merged_DatasetPCA_withnonT.pdf", out_dir,i), 5,5, useDingbats = F)
ggplot(scores_tbl_merged2, aes(x = dataset, y = score_log)) +
    # boxplot first (no outlier points, so we see our own points instead)
    geom_boxplot(outlier.shape = NA, fill = NA, colour = "black") +
    # scatter on top (jittered)
    geom_jitter(width = 0.2, alpha = 0.3, size = 0.1) +
    geom_hline(yintercept = log(2), colour = "brown", linetype = "dashed", size = 0.5) +
    labs(
        x = "Dataset",
        y = "score_log",
        title = "score_log distribution per dataset"
    ) +
    # ylim(-1.1,1.1)+
    theme_bw(base_size = 11) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    ) + NoGrid()
dev.off()

igt_bkrg = data.frame(dim1 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,1], dim2 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,2])
bkrg = ggplot(igt_bkrg) + geom_scattermore(aes(dim1, dim2), colour = "grey", alpha = 0.5, pixels = c(1024, 1024))

pdf(sprintf("%s/TRBI_MDEmain_discoveryscore_DatasetPCA_withnonT.pdf", out_dir), 5,5, useDingbats = F)
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
dat_frg = data.frame(so_merged@meta.data[rownames(so_merged[["mde_incremental_allT"]]),], dim1 = so_merged[["mde_incremental_allT"]]@cell.embeddings[,1], dim2 = so_merged[["mde_incremental_allT"]]@cell.embeddings[,2])
p = bkrg + geom_scattermore(data = dat_frg, aes(dim1, dim2), col = "grey0", size =3, pixels = c(c(1024, 1024))) + 
    geom_point(data = scores_tbl_merged2[!is.na(scores_tbl_merged2$score_log),], aes(mde_incremental_allT_dim1, mde_incremental_allT_dim2, colour = score_log), size =0.25) + scale_color_gradientn(colours = ColorRamp, limits  = c(-1, 1), oob = scales::squish) + ggtitle(label = "discovery score") + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() 
p
p + NoLegend()
dev.off()



```


same Discovery score of not classified cells but within immgenT space
```{r}

summaries_list = list()
scores_tbl_list = list()

for (i in unique(so_merged$dataset)) {
    print(i)
    tmp = so_merged[,so_merged$dataset == i]
    tmp = tmp[,tmp@meta.data %>% filter(!level2_final %in% c("nonT", "unclear")) %>% row.names()]
    if (!"mde_incremental_allT" %in% names(tmp@reductions)) {
        message("Skipping ", i, ": no mde_incremental_allT")
        next
    }
    
    tmp$is_noclassl2 = F
    tmp$is_noclassl2[tmp$level2_final %in% c("not classified", "CD8", "Treg", "CD4", "nonconv",  "gdT", "CD8aa","DN", "DP")] = T
    old_mat = tmp[["mde_incremental_allT"]]@cell.embeddings[tmp$is_noclassl2 == F,]
    new_mat = tmp[["mde_incremental_allT"]]@cell.embeddings[tmp$is_noclassl2 == T,]
    scores_tbl = knn_novelty_scores(old_mat, new_mat, k = 10) %>% as.data.frame()
    rownames(scores_tbl) = rownames(new_mat)
    scores_tbl$dataset = i
    scores_tbl_list[[i]] = scores_tbl
    
    tmp$score_log = NA
    tmp$score_log = scores_tbl$score_log[match(colnames(tmp), rownames(scores_tbl))]
    tmp$score_log = scores_tbl$score_log[match(colnames(tmp), rownames(scores_tbl))]
    tmp$discovery = tmp$score_log > log(2)
    
    pdf(sprintf("%s/TRBI_%s_discovery_immgentMDE.pdf", out_dir,i), 5,5, useDingbats = F)
    p1 = FeaturePlot(tmp, reduction = "mde_incremental_allT",features = "score_log")  + xlim(-2.5,2.5) + ylim(-2.5,2.5) 
    p2 = DimPlot(tmp, reduction = "mde_incremental_allT",group.by = "discovery", order = T) + scale_color_manual(values = c("black", "red"))
    igt_bkrg = data.frame(dim1 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,1], dim2 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[,2])
    bkrg = ggplot(igt_bkrg) + geom_scattermore(aes(dim1, dim2), colour = "grey", alpha = 0.5, pixels = c(1024, 1024))
    dat_frg = data.frame(tmp@meta.data[rownames(tmp[["mde_incremental_allT"]]),], dim1 = tmp[["mde_incremental_allT"]]@cell.embeddings[,1], dim2 = tmp[["mde_incremental_allT"]]@cell.embeddings[,2])
    p3 = bkrg + geom_scattermore(data = dat_frg, aes(dim1, dim2), col = "grey0", size =3, pixels = c(c(1024, 1024))) + 
        geom_point(data = dat_frg[dat_frg$discovery,], aes(dim1, dim2), color = "red", size =1) + 
        ggtitle(label = sprintf("%s: black the dataset cells,\nred not classified with potential new state", i)) + theme_void() + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()
    print(p1)
    print(p2)
    print(p3)
    dev.off()
    # FeaturePlot(tmp, slot = "counts", reduction = "mde_incremental_allT",features = c("Cd4", "Cd8b1", "Cd8a", "Foxp3", "Zbtb16","Trdc"), order = T)
    
    discovery_report = data.frame(dataset = i, summarize_discovery(scores_tbl, ratio_threshold = 2) %>% as.data.frame())
    discovery_report %>% write.table(sprintf("%s/TRBI_%s_discovery_immgentMDE.txt", out_dir,i), quote = F, row.names = F, col.names = T, sep = "\t")
    summaries_list[[i]] = discovery_report
    
}

summaries_merged = Reduce(rbind, summaries_list)
# write.table(summaries_merged, file = sprintf("%s/TRBI_discovery_summary_dataset_immgentMDE.txt", out_dir), row.names = F, col.names = T,quote = F )
scores_tbl_merged = Reduce(rbind, scores_tbl_list)
# saveRDS(scores_tbl_merged, file = sprintf("%s/TRBI_discovery_scores_tbl_merged_immgentMDE.Rds", out_dir))

# # optional: make dataset a factor and order by median score_log
# scores_tbl <- scores_tbl %>%
#   mutate(
#     dataset = factor(
#       dataset,
#       levels = names(sort(tapply(score_log, dataset, median, na.rm = TRUE)))
#     )
#   )

pdf(sprintf("%s/TRBI_discovery_scores_tbl_merged_immgentMDE.pdf", out_dir,i), 5,5, useDingbats = F)
ggplot(scores_tbl_merged, aes(x = dataset, y = score_log)) +
    # boxplot first (no outlier points, so we see our own points instead)
    geom_boxplot(outlier.shape = NA, fill = NA, colour = "black") +
    # scatter on top (jittered)
    geom_jitter(width = 0.2, alpha = 0.3, size = 0.1) +
    geom_hline(yintercept = log(2), colour = "brown", linetype = "dashed", size = 0.5) +
    labs(
        x = "Dataset",
        y = "score_log",
        title = "score_log distribution per dataset"
    ) +
    # ylim(-1.1,1.1)+
    theme_bw(base_size = 11) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    ) + NoGrid()
dev.off()


```

###############
(silhouette_width where the distance of each cell to its cluster medoid is compared to the closest medioid of cluysters it doesn't belong to. Pretty much the same as normal silhouette, because similar definition... SO STICK TO THE SILHOUETTE!)
only focused on cells in an IGT with at least 10 cells in a level2 cluster
```{r}
silhouette_medoid_from_dist <- function(d, clusters) {
  # d: distance matrix (n x n) or 'dist' object
  # clusters: factor/character vector of cluster labels (length n)
  
  if (inherits(d, "dist")) {
    d <- as.matrix(d)
  } else {
    d <- as.matrix(d)
  }
  n <- nrow(d)
  if (n != ncol(d)) stop("d must be a square distance matrix")
  
  if (length(clusters) != n) stop("length(clusters) must match nrow(d)")
  clusters <- as.factor(clusters)
  k_levels <- levels(clusters)
  
  # 1. Find medoid index for each cluster
  medoids <- setNames(integer(length(k_levels)), k_levels)
  for (cl in k_levels) {
    idx <- which(clusters == cl)
    if (length(idx) == 1L) {
      medoids[cl] <- idx
    } else {
      # medoid = argmin_j sum_k d[j,k] within cluster
      subD <- d[idx, idx, drop = FALSE]
      tot <- rowSums(subD)
      medoids[cl] <- idx[which.min(tot)]
    }
  }
  
  a <- numeric(n)
  b <- numeric(n)
  s <- numeric(n)
  
  for (i in seq_len(n)) {
    ci <- clusters[i]
    # a(i): distance to own cluster medoid
    a[i] <- d[i, medoids[as.character(ci)]]
    
    # b(i): min distance to medoids of other clusters
    other_cls <- k_levels[k_levels != ci]
    if (length(other_cls) == 0L) {
      b[i] <- NA
      s[i] <- 0
      next
    }
    b[i] <- min(d[i, medoids[other_cls]])
    
    denom <- max(a[i], b[i])
    if (is.na(denom) || denom == 0) {
      s[i] <- 0
    } else {
      s[i] <- (b[i] - a[i]) / denom
    }
  }
  
  out <- data.frame(
    cluster = clusters,
    a = a,
    b = b,
    s = s,
    stringsAsFactors = FALSE
  )
  rownames(out) <- rownames(d)
  out
}


# set.seed(1)
# X <- rbind(
#   matrix(rnorm(50, mean = 0),  ncol = 2),
#   matrix(rnorm(50, mean = 3),  ncol = 2),
#   matrix(rnorm(50, mean = -3), ncol = 2)
# )
# colnames(X) <- c("x1", "x2")
# cl <- factor(rep(c("A", "B", "C"), each = 25))
# text(X[,1], X[,2], labels =  cl)
# sc <- silhouette_centroid(X, cl)
# head(sc)
# sc %>% group_by(cluster) %>% summarize(mean(s))


library(cluster)
so = so_orig[,so_orig@meta.data %>% filter(organ_simplified != "thymus", cite_seq == T) %>% row.names()]
so$level2_int = as.integer(so[["annotation_level2"]][,1])
DefaultAssay(so) = "ADT"

dict_l2 = so@meta.data %>% count(annotation_level2, level2_int)
#Select only good ADT markers
markers = so[["ADT"]]@meta.features %>% filter(IGT1only == F & classification %in% c("good", "intermediate")) %>% row.names()

sil_summary_list = list()
for (i in unique(so$IGT)) {
    print(i)
    tmp = so[markers,so$IGT == i]
    subcl = tmp@meta.data %>% count(annotation_level2) %>% filter(n>10) %>% pull(annotation_level2) %>% as.character()
    if (length(subcl) > 1) {
        tmp = tmp[,tmp$annotation_level2 %in% subcl]
        tmp = tmp %>% 
            NormalizeData(normalization.method = "CLR", verbose = F) %>%
            FindVariableFeatures(selection.method = "vst", nfeatures = 50, verbose = F) %>%
            ScaleData(features = VariableFeatures(.), verbose = F) %>%    
            RunPCA(features = VariableFeatures(.), npcs = 10, verbose = F) #%>% FindNeighbors(dims = 1:10, verbose = F) %>% RunUMAP(dims = 1:10, seed.use = 123, verbose = T)
        # DimPlot(tmp, reduction = "umap", group.by = "annotation_level2", label = T) + scale_color_manual(values = mypal_level2) + NoLegend()
        
        # message("Calculating silhouette post integration...")
        reduc.dist = dist(tmp[["pca"]]@cell.embeddings)
        cl = as.integer(tmp[["level2_int"]][,1])
        # sil_post = silhouette(cl, dist = reduc.dist)
        sil_post = silhouette_medoid_from_dist(d = reduc.dist, clusters = cl)
        sil_post$sil_width = sil_post$s
        sil_summary = as.data.frame(sil_post) %>% 
            group_by(cluster) %>% 
            summarise(mean_sil_width = mean(sil_width),
                      median_sil_width = median(sil_width),
                      total = n(),  # Count total observations in each cluster
                      positive_count = sum(sil_width > 0),  # Count negative silhouette widths
                      percentage_positive = (positive_count / total) * 100)     %>%  # Calculate percentage) 
            as.data.frame()
        # sil_summary$cluster == dict_l2$level2_int[match(sil_summary$cluster, dict_l2$level2_int)]
        sil_summary$annotation_level2 = dict_l2$annotation_level2[match(sil_summary$cluster, dict_l2$level2_int)]
        sil_summary$IGT = i
        sil_summary_list[[i]] = sil_summary 
    }
    
}


sil_summary_merged = Reduce(rbind, sil_summary_list)

dict_l1 = so@meta.data %>% count(annotation_level1, annotation_level2)
sil_summary_merged$annotation_level1 = dict_l1$annotation_level1[match(sil_summary_merged$annotation_level2, dict_l1$annotation_level2)]
    

sil_summary_merged$annotation_level2 <- factor(
    sil_summary_merged$annotation_level2,
    levels = levels(so$annotation_level2)
)

p = ggplot(sil_summary_merged %>% filter(total > 10),
       aes(x = annotation_level2, y = median_sil_width)) +
    geom_jitter(aes(color = IGT),
                width = 0.15, height = 0,
                size = 1.8, alpha = 0.9) +
    geom_boxplot(outlier.shape = NA,
                 fill = "grey90",
                 colour = "black",
                 width = 0.6) +
    scale_color_manual(values = mypal_igt) +
    theme_bw() +
    # labs(
    #     x = "Cluster (annotation_level2)",
    #     y = "Median silhouette width",
    #     color = "IGT"
    # ) +
    facet_grid(
        . ~ annotation_level1,
        scales = "free_x",
        space  = "free_x"
    ) +
    labs(x = NULL, y = NULL) +
    theme_minimal(base_size = 11) +
    theme(
        axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1, size = 12),
        axis.text.y = element_text(size = 12),
        panel.grid = element_blank(),
        strip.text = element_text(face = "bold")
    )
p
# pdf(sprintf("%s/Boxplot_Level2RNASpace.pdf", out_dir), 25,6, useDingbats = F)

```

**Figure 6: TF**

Gene_AUC function
```{r}
Gene_AUC <- function(
        pseudobulk,
        genes, # vector of genes
        out_dir,
        mypal = NULL,              # named vector of colors for TF lines
        order_groups = levels(so$annotation_level2),
        mypal_groups = mypal_level2,       # named vector of colors for level1 barplots
        n_top = 20,                # number of top TF to highlight
        expr_threshold = 0.5,       # threshold for filtering genes, in CK10K
        cols_heatmap_gradient = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100)),
        pdf_width = 7,
        pdf_height = 7
        
) {
    # ---- sanity + setup ----
    stopifnot("RNA" %in% names(pseudobulk))
    if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE)
    
    # 1. Extract matrix for genes of interest
    mat <- pseudobulk[["RNA"]]$data[genes, , drop = FALSE]
    
    # 2. Normalize each TF by its row sum
    row_sums <- rowSums(mat)
    row_sums[row_sums == 0] <- NA  # avoid division by zero
    mat_norm <- mat / row_sums
    
    # 3. Filter TFs: at least one cluster with expression > expr_threshold
    filt_expr <- rownames(mat)[rowSums(mat > expr_threshold, na.rm = TRUE) >= 1]
    mat_norm_filt <- mat_norm[filt_expr, , drop = FALSE]
    
    # 4. Long format + cumulative curves
    data_long <- mat_norm_filt |>
        as.data.frame() |>
        tibble::rownames_to_column(var = "Gene") |>
        tidyr::pivot_longer(
            cols = -Gene,
            names_to = "Group",
            values_to = "Expression"
        ) |>
        dplyr::group_by(Gene) |>
        dplyr::arrange(dplyr::desc(Expression), .by_group = TRUE) |>
        dplyr::mutate(
            CumulativeExpression = cumsum(Expression),
            Rank = dplyr::row_number()
        ) |>
        dplyr::ungroup()
    
    # 5. AUC per gene
    gene_auc <- data_long |>
        dplyr::group_by(Gene) |>
        dplyr::summarise(
            auc = sum(CumulativeExpression) / dplyr::n(),
            .groups = "drop"
        ) |>
        dplyr::arrange(dplyr::desc(auc))
    
    # Write AUC table
    utils::write.table(
        gene_auc,
        file = sprintf("%s/AUC.txt", out_dir),
        quote = FALSE,
        col.names = TRUE,
        row.names = FALSE,
        sep = "\t"
    )
    
    # Top TFs
    top_genes <- head(gene_auc$Gene, n_top)
    
    # 6. Cumulative curves PDF
    pdf(sprintf("%s/cum_curves.pdf", out_dir),
        7, 7, useDingbats = FALSE)
    
    p1 <- ggplot2::ggplot(
        data_long,
        ggplot2::aes(x = Rank, y = CumulativeExpression, group = Gene)
    ) +
        ggplot2::geom_line(size = 0.5, alpha = 0.1)
    
    p2 <- ggplot2::geom_line(
        data = subset(data_long, Gene %in% top_genes),
        mapping = ggplot2::aes(
            x = Rank, y = CumulativeExpression,
            group = Gene, color = Gene
        ),
        size = 1,
        alpha = 1
    )
    
    p3 <- ggrepel::geom_label_repel(
        data = data_long |>
            dplyr::filter(Gene %in% top_genes) |>
            dplyr::group_by(Gene) |>
            dplyr::slice_sample(n = 1) |>
            dplyr::ungroup(),
        ggplot2::aes(
            x = Rank, y = CumulativeExpression,
            label = Gene, color = Gene
        ),
        size = 4,
        segment.size = 0.2,
        segment.color = "grey",
        max.overlaps = 50
    )
    
    # Colors for lines
    if (is.null(mypal)) {
        cols <- grDevices::rainbow(length(top_genes))
        names(cols) <- top_genes
    } else {
        cols <- mypal
    }
    
    print(
        p1 + p2 + p3 +
            ggplot2::scale_color_manual(values = cols) +
            ggplot2::labs(
                title = "Cumulative Expression",
                x = "Ranked Groups by Expression",
                y = "Cumulative Expression"
            ) +
            ggplot2::theme_minimal() +
            ZemmourLib::NoLegend() +
            ZemmourLib::NoGrid()
    )
    
    dev.off()
    
    # 7. Barplots for top genes (requires so + mypal_groups)
    if (!is.null(so) && !is.null(mypal_groups)) {
        pdf(sprintf("%s/barplots_topgenes.pdf", out_dir),
            pdf_width, pdf_height, useDingbats = FALSE)
        
        for (g in top_genes) {
            gene_to_plot <- g
            data <- data.frame(
                Group    = colnames(pseudobulk[["RNA"]]$data),
                Expression = pseudobulk[["RNA"]]$data[gene_to_plot, ]
            )
            data$Group <- gsub("\\-", "_", data$Group)
            data$Group <- factor(data$Group, levels = order_groups)
            # data$level1  <- so$annotation_level1[match(data$Group, so$annotation_level1)]
            
            p <- ggplot2::ggplot(data, ggplot2::aes(x = Group, y = Expression, fill = Group)) +
                ggplot2::geom_bar(stat = "identity") +
                ggplot2::scale_fill_manual(values = mypal_groups) +
                ggplot2::labs(
                    title = sprintf("%s Expression in Groups", gene_to_plot),
                    x = "Group", y = "Expression"
                ) +
                ggplot2::theme_minimal() +
                ggplot2::theme(
                    axis.text.x  = ggplot2::element_text(size = 8, angle = 90,
                                                         hjust = 1, vjust = 0.5),
                    axis.title.x = ggplot2::element_text(size = 10),
                    axis.title.y = ggplot2::element_text(size = 10)
                )
            
            print(p + ZemmourLib::NoGrid())
            print(p + NoLegend() + ZemmourLib::NoGrid())
        }
        
        dev.off()
    }
    
    # 8. Heatmaps
    pdf(sprintf("%s/heatmap_topgenes.pdf", out_dir),
        pdf_width, pdf_height, useDingbats = FALSE)
    
    top_mat_norm <- mat_norm[top_genes, , drop = FALSE]
    # top_mat_norm[top_mat_norm > 0.10] <- 0.1
    # uplim <- round(max(top_mat_norm, na.rm = TRUE) * 1.1, 1)
    
    ColorRamp <- colorRampPalette(RColorBrewer::brewer.pal(9, "Blues"))(50)
    
    pheatmap::pheatmap(
        top_mat_norm,
        color = ColorRamp,
        breaks         = seq(0, 1, length.out = length(ColorRamp) + 1),
        legend_breaks  = seq(0, 1, by = 0.1),
        legend_labels  = seq(0, 1, by = 0.1),
        main           = "rows sum to 1"
    )
    
    pheatmap::pheatmap( mat[top_genes, , drop = FALSE],
                        color = cols_heatmap_gradient,
                       main = "expression log1p CP10K")
    
    pheatmap::pheatmap(mat[top_genes, , drop = FALSE],
                       color = cols_heatmap_gradient,
                       cluster_cols = FALSE,
                       main = "expression log1p CP10K")
    
    dev.off()
    
    # invisible(list(
    #     gene_auc    = gene_auc,
    #     data_long = data_long,
    #     top_genes    = top_genes
    # ))
}


```

!! using so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20251128_clean.Rds")  here
```{r}
so_orig = readRDS("~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20251128_clean.Rds") 
```


Calculate pseudobulk (on Midway)
remove prolif and miniverse since many level2 converge there. thymocyte and thymus
```{r}
so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20251128_clean.Rds") 
so = so_orig[,so_orig@meta.data %>% filter(organ_simplified != "thymus" & !(annotation_level2_group %in% c("proliferating", "miniverse")) & (annotation_level2 != "thymocyte")) %>% row.names()]

pseudobulk = AggregateExpression(
    object = so,
    assay = "RNA",
    group.by = "annotation_level1",
    # features = tf,
    normalization.method = "LogNormalize",
    scale.factor = 10000,
    verbose = T,
    return.seurat = TRUE
)
# write.table(pseudobulk[["RNA"]]$data, file = sprintf("%s/igt1_96_pseudobulk_byclusterannotationlevel1_log1pCP10K.tsv", out_dir),sep = "\t", quote = F) #out_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128"
# saveRDS(pseudobulk, file = sprintf("%s/igt1_96_pseudobulk_byclusterannotationlevel1_log1pCP10K.Rds", out_dir)) #out_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128"

pseudobulk = AggregateExpression(
    object = so,
    assay = "RNA",
    group.by = "annotation_level2",
    # features = tf,
    normalization.method = "LogNormalize",
    scale.factor = 10000,
    verbose = T,
    return.seurat = TRUE
)
# write.table(pseudobulk[["RNA"]]$data, file = sprintf("%s/igt1_96_pseudobulk_byclusterannotationlevel2_log1pCP10K.tsv", out_dir),sep = "\t", quote = F) #out_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128"
# saveRDS(pseudobulk, file = sprintf("%s/igt1_96_pseudobulk_byclusterannotationlevel2_log1pCP10K.Rds", out_dir)) #out_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128"

pseudobulk_orig = readRDS(sprintf("%s/igt1_96_pseudobulk_byclusterannotationlevel2_log1pCP10K.Rds", "/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128"))
```


Gene/TF list
```{r}
library(org.Mm.eg.db)
mm = org.Mm.eg.db
go2eg = as.list(org.Mm.egGO2ALLEGS)
symbols = select(mm, keys = unique(unlist(go2eg)), columns = "SYMBOL", keytype = "ENTREZID")
cc = sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(c(go2eg[["GO:0007049"]]))])
cellmembrane = sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(unlist(list(go2eg[["GO:0009986"]], go2eg[["GO:0009897"]], go2eg[["GO:0016494"]], go2eg[["GO:0098552"]])))]) #go2eg[["GO:0016020"]]
#is_cellmembrane = rownames(cor_genes) %in% is_cellmembrane
tf =  c(sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(go2eg[["GO:0003700"]])]), "Tox", "Tox2", "Tox3", "Tox4") %>% sort()
effmol = sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(go2eg[["GO:0005615"]])])
chemreceptor = symbols$SYMBOL[symbols$ENTREZID %in% unique(c(go2eg[["GO:0004950"]]))]

tf = tf[tf %in% rownames(pseudobulk_orig)]

##
# library(org.Hs.eg.db)
# hs = org.Hs.eg.db
# go2eg = as.list(org.Hs.egGO2ALLEGS)
# symbols = select(hs, keys = unique(unlist(go2eg)), columns = "SYMBOL", keytype = "ENTREZID")
# cc = sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(c(go2eg[["GO:0007049"]]))])
# cellmembrane = sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(unlist(list(go2eg[["GO:0009986"]], go2eg[["GO:0009897"]], go2eg[["GO:0016494"]], go2eg[["GO:0098552"]])))]) #go2eg[["GO:0016020"]]
# #is_cellmembrane = rownames(cor_genes) %in% is_cellmembrane
# tf =  sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(go2eg[["GO:0003700"]])])
# secretedmol = sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(go2eg[["GO:0005615"]])])
# effmol = sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(go2eg[["GO:0005615"]])])
# chemreceptor = symbols$SYMBOL[symbols$ENTREZID %in% unique(c(go2eg[["GO:0004950"]]))]
```

Level1
```{r}
pseudobulk_orig = readRDS(sprintf("%s/igt1_96_pseudobulk_byclusterannotationlevel1_log1pCP10K.Rds", "/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128"))

pseudobulk = pseudobulk_orig
out_dir2 = sprintf("/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128/%s", "level1")
    
Gene_AUC(pseudobulk,
         genes = tf, # vector of genes
         out_dir = out_dir2,
         mypal = mypal,              # named vector of colors for TF lines
         order_groups = levels(so_orig$annotation_level1),
         mypal_groups = mypal_level1,       # named vector of colors for groups in barplots
         n_top = 20,                # number of top TF to highlight
         expr_threshold = 0.5,       # threshold for filtering genes, in CK10K
         cols_heatmap_gradient = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
)


```

Across Level2
```{r}
pseudobulk_orig = readRDS(sprintf("%s/igt1_96_pseudobulk_byclusterannotationlevel2_log1pCP10K.Rds", "/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128"))

pseudobulk = pseudobulk_orig
out_dir2 = sprintf("/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128/%s", "level2")
    
Gene_AUC(pseudobulk,
         genes = tf, # vector of genes
         out_dir = out_dir2,
         mypal = mypal,              # named vector of colors for TF lines
         order_groups = levels(so_orig$annotation_level2),
         mypal_groups = mypal_level2,       # named vector of colors for groups in barplots
         n_top = 20,                # number of top TF to highlight
         expr_threshold = 0.5,       # threshold for filtering genes, in CK10K
         cols_heatmap_gradient = colorRampPalette(c('white','orange','brown'))(100),#rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100)),
         pdf_width = 12,
         pdf_height = 7
         
)

out_dir2 = sprintf("/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128/%s", "level2Top50")
Gene_AUC(pseudobulk,
         genes = tf, # vector of genes
         out_dir = out_dir2,
         mypal = mypal,              # named vector of colors for TF lines
         order_groups = levels(so_orig$annotation_level2),
         mypal_groups = mypal_level2,       # named vector of colors for groups in barplots
         n_top = 50,                # number of top TF to highlight
         expr_threshold = 0.5,       # threshold for filtering genes, in CK10K
         cols_heatmap_gradient = colorRampPalette(c('white','orange','brown'))(100),#rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100)),
         pdf_width = 12,
         pdf_height = 10
         
)

```


in each Level2
```{r}
pseudobulk_orig = readRDS(sprintf("%s/igt1_96_pseudobulk_byclusterannotationlevel2_log1pCP10K.Rds", "/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128"))

for (ct in c("CD8", "CD4", "Treg", "gdT", "CD8aa", "nonconv", "DN", "DP")) {
    print(ct)
    out_dir2 = sprintf("/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128/%s", ct)
    
    pseudobulk = pseudobulk_orig[,grepl(sprintf("^%s\\-",ct), colnames(pseudobulk_orig))]
    
    Gene_AUC(pseudobulk,
             genes = tf, # vector of genes
             out_dir = out_dir2,
             mypal = mypal,              # named vector of colors for TF lines
             order_groups = levels(so_orig$annotation_level2),
             mypal_groups = mypal_level2,       # named vector of colors for groups in barplots
             n_top = 20,                # number of top TF to highlight
             expr_threshold = 0.5,       # threshold for filtering genes, in CK10K
             cols_heatmap_gradient = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
    )
}

```

Ahrr expression
```{r}
pseudobulk = readRDS(file = sprintf("%s/igt1_96_pseudobulk_byclusterannotationlevel2_log1pCP10K.Rds", "~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128"))

pdf(sprintf("%s/annotation_level2_barplots_%s.pdf", out_dir, "OtherTF"), 12, 7, useDingbats = F)
genes_to_plot = c("Ahrr", "Tox","Tox2", "Tbx21", "Gata3")
for (gene_to_plot in genes_to_plot) {
    print(gene_to_plot)
    data = data.frame(
        Cluster = names(pseudobulk[["RNA"]]$data[gene_to_plot, ]),
        Expression = pseudobulk[["RNA"]]$data[gene_to_plot, ]
    )
    data$Cluster = gsub("\\-", "_", data$Cluster)
    data$Cluster = factor(data$Cluster, levels = levels(so$annotation_level2))
    data$level1 = so$annotation_level1[match(data$Cluster, so$annotation_level2)]
    
    p = ggplot(data, aes(x = Cluster, y = Expression, fill = level1)) +
        scale_fill_manual(values = mypal_level1) +
        geom_bar(stat = "identity") +
        labs(title = sprintf("%s Expression in Clusters", gene_to_plot), x = "Cluster", y = "Expression") +
        theme_minimal() +
        theme(
            axis.text.x = element_text(size = 8, angle = 90, hjust = 1, vjust = 0.5),
            axis.title.x = element_text(size = 10),
            axis.title.y = element_text(size = 10)
        )
    print(p + NoGrid() + NoLegend())
}
dev.off()

```


**Figure 7: Effector molecules**


!! using so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20251128_clean.Rds")  here
```{r}
so_orig = readRDS("~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20251128_clean.Rds") 
```


Calculate pseudobulk (on Midway)
remove prolif and miniverse since many level2 converge there. thymocyte and thymus
```{r}
so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20251128_clean.Rds") 
so = so_orig[,so_orig@meta.data %>% filter(organ_simplified != "thymus" & !(annotation_level2_group %in% c("proliferating", "miniverse")) & (annotation_level2 != "thymocyte")) %>% row.names()]

pseudobulk = AggregateExpression(
    object = so,
    assay = "RNA",
    group.by = "annotation_level1",
    # features = tf,
    normalization.method = "LogNormalize",
    scale.factor = 10000,
    verbose = T,
    return.seurat = TRUE
)
# write.table(pseudobulk[["RNA"]]$data, file = sprintf("%s/igt1_96_pseudobulk_byclusterannotationlevel1_log1pCP10K.tsv", out_dir),sep = "\t", quote = F) #out_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128"
# saveRDS(pseudobulk, file = sprintf("%s/igt1_96_pseudobulk_byclusterannotationlevel1_log1pCP10K.Rds", out_dir)) #out_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128"

pseudobulk = AggregateExpression(
    object = so,
    assay = "RNA",
    group.by = "annotation_level2",
    # features = tf,
    normalization.method = "LogNormalize",
    scale.factor = 10000,
    verbose = T,
    return.seurat = TRUE
)
# write.table(pseudobulk[["RNA"]]$data, file = sprintf("%s/igt1_96_pseudobulk_byclusterannotationlevel2_log1pCP10K.tsv", out_dir),sep = "\t", quote = F) #out_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128"
# saveRDS(pseudobulk, file = sprintf("%s/igt1_96_pseudobulk_byclusterannotationlevel2_log1pCP10K.Rds", out_dir)) #out_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128"

pseudobulk_orig = readRDS(sprintf("%s/igt1_96_pseudobulk_byclusterannotationlevel2_log1pCP10K.Rds", "/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128"))
```


Gene/effmol list
```{r}
library(org.Mm.eg.db)
mm = org.Mm.eg.db
go2eg = as.list(org.Mm.egGO2ALLEGS)
symbols = select(mm, keys = unique(unlist(go2eg)), columns = "SYMBOL", keytype = "ENTREZID")
cc = sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(c(go2eg[["GO:0007049"]]))])
cellmembrane = sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(unlist(list(go2eg[["GO:0009986"]], go2eg[["GO:0009897"]], go2eg[["GO:0016494"]], go2eg[["GO:0098552"]])))]) #go2eg[["GO:0016020"]]
#is_cellmembrane = rownames(cor_genes) %in% is_cellmembrane
tf =  c(sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(go2eg[["GO:0003700"]])]), "Tox", "Tox2", "Tox3", "Tox4") %>% sort()
effmol = sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(go2eg[["GO:0005615"]])])
chemreceptor = symbols$SYMBOL[symbols$ENTREZID %in% unique(c(go2eg[["GO:0004950"]]))]

effmols = c(effmol[effmol %in% rownames(pseudobulk_orig)], chemreceptor[chemreceptor %in% rownames(pseudobulk_orig)]) %>% sort()

##
# library(org.Hs.eg.db)
# hs = org.Hs.eg.db
# go2eg = as.list(org.Hs.egGO2ALLEGS)
# symbols = select(hs, keys = unique(unlist(go2eg)), columns = "SYMBOL", keytype = "ENTREZID")
# cc = sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(c(go2eg[["GO:0007049"]]))])
# cellmembrane = sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(unlist(list(go2eg[["GO:0009986"]], go2eg[["GO:0009897"]], go2eg[["GO:0016494"]], go2eg[["GO:0098552"]])))]) #go2eg[["GO:0016020"]]
# #is_cellmembrane = rownames(cor_genes) %in% is_cellmembrane
# tf =  sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(go2eg[["GO:0003700"]])])
# secretedmol = sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(go2eg[["GO:0005615"]])])
# effmol = sort(symbols$SYMBOL[symbols$ENTREZID %in% unique(go2eg[["GO:0005615"]])])
# chemreceptor = symbols$SYMBOL[symbols$ENTREZID %in% unique(c(go2eg[["GO:0004950"]]))]
```

Level1
```{r}
pseudobulk_orig = readRDS(sprintf("%s/igt1_96_pseudobulk_byclusterannotationlevel1_log1pCP10K.Rds", "/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128"))

pseudobulk = pseudobulk_orig
out_dir2 = sprintf("/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/EffMol_analysis/20251128/%s", "level1")
    
Gene_AUC(pseudobulk,
         genes = effmols, # vector of genes
         out_dir = out_dir2,
         mypal = mypal,              # named vector of colors for TF lines
         order_groups = levels(so_orig$annotation_level1),
         mypal_groups = mypal_level1,       # named vector of colors for groups in barplots
         n_top = 20,                # number of top TF to highlight
         expr_threshold = 0.5,       # threshold for filtering genes, in CK10K
         cols_heatmap_gradient = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
)


```

Across Level2
```{r}
pseudobulk_orig = readRDS(sprintf("%s/igt1_96_pseudobulk_byclusterannotationlevel2_log1pCP10K.Rds", "/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128"))

pseudobulk = pseudobulk_orig
out_dir2 = sprintf("/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/EffMol_analysis/20251128/%s", "level2")
    
Gene_AUC(pseudobulk,
         genes = effmols, # vector of genes
         out_dir = out_dir2,
         mypal = mypal,              # named vector of colors for TF lines
         order_groups = levels(so_orig$annotation_level2),
         mypal_groups = mypal_level2,       # named vector of colors for groups in barplots
         n_top = 110,                # number of top TF to highlight
         expr_threshold = 0.5,       # threshold for filtering genes, in CK10K
         cols_heatmap_gradient = colorRampPalette(c('white','cyan4','blue4'))(100), #colorRampPalette(c('white','red','brown'))(100), rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
         pdf_width = 12,
         pdf_height = 15
         
)

out_dir2 = sprintf("/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/EffMol_analysis/20251128/%s", "level2Top50")
Gene_AUC(pseudobulk,
         genes = effmols, # vector of genes
         out_dir = out_dir2,
         mypal = mypal,              # named vector of colors for TF lines
         order_groups = levels(so_orig$annotation_level2),
         mypal_groups = mypal_level2,       # named vector of colors for groups in barplots
         n_top = 50,                # number of top TF to highlight
         expr_threshold = 0.5,       # threshold for filtering genes, in CK10K
         cols_heatmap_gradient = colorRampPalette(c('white','orange','red4'))(100), #rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))  rev(viridis::rocket(100))
         pdf_width = 12,
         pdf_height = 10
         
)

ColorRamp = rev(colorRampPalette(c('white','yellow4','red4'))(100))
colorRampPalette(c('white','red','brown'))(100)
colorRampPalette(c('white','cyan4','blue4'))(100)

```


in each Level2
```{r}
pseudobulk_orig = readRDS(sprintf("%s/igt1_96_pseudobulk_byclusterannotationlevel2_log1pCP10K.Rds", "/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/TF_analysis/20251128"))

for (ct in c("CD8", "CD4", "Treg", "gdT", "CD8aa", "nonconv", "DN", "DP")) {
    print(ct)
    out_dir2 = sprintf("/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/EffMol_analysis/20251128/%s", ct)
    
    pseudobulk = pseudobulk_orig[,grepl(sprintf("^%s\\-",ct), colnames(pseudobulk_orig))]
    
    Gene_AUC(pseudobulk,
             genes = effmols, # vector of genes
             out_dir = out_dir2,
             mypal = mypal,              # named vector of colors for TF lines
             order_groups = levels(so_orig$annotation_level2),
             mypal_groups = mypal_level2,       # named vector of colors for groups in barplots
             n_top = 70,                # number of top TF to highlight
             expr_threshold = 0.5,       # threshold for filtering genes, in CK10K
             cols_heatmap_gradient = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100)),
             pdf_width = 12,
             pdf_height = 10
    )
}

```

**Figure 8**

PlotAlluvialHighlight specific clusters, conditions organ - for CD8_cl10
```{r}
library(ggplot2)
library(ggalluvial)
library(dplyr)
library(tidyr)

PlotAlluvialHighlight <- function(
  df3_plot = df3_plot,
  mypal_alluv = mypal_alluv,
  title = "CD8: organ → cluster → condition",
  alpha_range = c(0.2, 1),
  x_limits = c("condition_detailed_simplified", "organ_simplified0", "annotation_level2")
) {
  ggplot(
    df3_plot,
    aes(
      y     = count,
      axis2 = organ_simplified0,
      axis1 = annotation_level2,
      axis3 = condition_detailed_simplified
    )
  ) +
    geom_alluvium(
      aes(fill = fill_key, alpha = alpha_val),
      width  = 1/5,
      colour = NA
    ) +
    geom_stratum(width = 1/5, fill = "white", color = "grey50") +
    geom_text(
      stat  = "stratum",
      aes(label = after_stat(stratum)),
      size  = 3,
      angle = 90
    ) +
    scale_x_discrete(
      limits = x_limits,
      expand = c(.05, .05)
    ) +
    coord_flip() +
    scale_fill_manual(values = mypal_alluv) +
    scale_alpha(range = alpha_range, guide = "none") +
    ggtitle(title) +
    theme_minimal() +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title       = element_blank(),
      axis.text        = element_blank(),
      axis.ticks       = element_blank()
    )
}


so_orig@meta.data %>% count(organ_simplified0)

# df0 = so_orig@meta.data %>% filter(annotation_level1 %in% "CD8" & !(annotation_level2 %in% c("CD8_prolif", "CD8_miniverse")) & !(organ_simplified0 %in% "SLO")) %>% group_by(annotation_level2, organ_simplified0, condition_detailed_simplified) %>% slice_sample(n = 100) 

df0 = so_orig@meta.data %>% filter(annotation_level1 %in% "CD8" & !(annotation_level2 %in% c("CD8_prolif", "CD8_miniverse")) & !(organ_simplified0 %in% "SLO")) %>% group_by(condition_detailed_simplified) %>%
  slice_sample(n = 1000) 

## 1. Hierarchical clustering for cluster (annotation_level2) order
df1 = df0%>% 
  ungroup() %>%
  group_by(annotation_level2, organ_simplified0) %>%
  summarize(count = n(), .groups = "drop") %>%  # Count the number of cells in each group
  as.data.frame()

mat_clust <- df1 %>%
  select(annotation_level2, organ_simplified0, count) %>%
  pivot_wider(
    names_from  = organ_simplified0,
    values_from = count,
    values_fill = 0
  ) %>% as.data.frame()

rownames(mat_clust) <- mat_clust$annotation_level2
mat_clust$annotation_level2 <- NULL

cluster_order <- rownames(mat_clust)[hclust(dist(mat_clust))$order]

## 2. Hierarchical clustering for organ order
df1 = df0%>% 
  ungroup() %>%
  group_by(annotation_level2, organ_simplified0) %>%
  summarize(count = n(), .groups = "drop") %>%  # Count the number of cells in each group
  as.data.frame()

mat_org <- df1 %>%
  select(organ_simplified0, annotation_level2, count) %>%
  pivot_wider(
    names_from  = annotation_level2,
    values_from = count,
    values_fill = 0
  ) %>% as.data.frame()

rownames(mat_org) <- mat_org$organ_simplified0
mat_org$organ_simplified0 <- NULL

organ_order <- rownames(mat_org)[hclust(dist(mat_org))$order]

## 3. Hierarchical clustering for condition_detailed order
df2 = df0%>% 
  ungroup() %>%
  group_by(annotation_level2, condition_detailed_simplified) %>%
  summarize(count = n(), .groups = "drop") %>%  # Count the number of cells in each group
  as.data.frame()
mat_cond <- df2 %>%
  select(condition_detailed_simplified, annotation_level2, count) %>%
  pivot_wider(
    names_from  = annotation_level2,
    values_from = count,
    values_fill = 0
  ) %>% as.data.frame()

rownames(mat_cond) <- mat_cond$condition_detailed_simplified
mat_cond$condition_detailed_simplified <- NULL

cond_order <- rownames(mat_cond)[hclust(dist(mat_cond))$order]

#4. Alluvial 3-way
# Example: organ - cluster - condition_broad
df3 <- df0 %>%
  group_by(organ_simplified0, annotation_level2, condition_detailed_simplified) %>%
  summarise(count = n(), .groups = "drop")

df3 <- df3 %>%
    mutate(
        annotation_level2 = factor(annotation_level2, levels = cluster_order),
        condition_detailed_simplified  = factor(condition_detailed_simplified,  levels = cond_order),
        organ_simplified0  = factor(organ_simplified0,  levels = organ_order)
    )

highlight <- "CD8_cl10"
df3_plot <- df3 %>%
  mutate(
    # is this alluvium part of the highlighted condition?
    is_highlight = annotation_level2 %in% highlight,
    # fill key: either "other" (grey) or the level2 cluster name
    fill_key = ifelse(is_highlight, as.character(annotation_level2), "other"),
    # alpha: low for background, high for highlight
    alpha_val = ifelse(is_highlight, 1, 0.25)
  )
pal_alluv <- c(other = "grey80", CD8_cl10 = "red")  
# pal_alluv <- setNames(mypal, unique(df3_plot$fill_key))
df3_plot %>% count(is_highlight)
p = PlotAlluvialHighlight(df3_plot, mypal_alluv = pal_alluv)

pdf(sprintf("%s/alluvial_CD8_cl10.pdf", out_dir), 15,5, useDingbats = F)
p
# dev.off()

```

PlotAlluvialHighlight specific clusters, conditions organ - for CD4_cl13
```{r}
library(ggplot2)
library(ggalluvial)
library(dplyr)
library(tidyr)

# df0 = so_orig@meta.data %>% filter(annotation_level1 %in% "CD4" & !(annotation_level2 %in% c("CD4_prolif", "CD4_miniverse")) & !(organ_simplified0 %in% "SLO")) %>% group_by(annotation_level2, organ_simplified0, condition_detailed_simplified) %>% slice_sample(n = 100) 

df0 = so_orig@meta.data %>% filter(annotation_level1 %in% "CD4" & !(annotation_level2 %in% c("CD4_prolif", "CD4_miniverse")) & !(organ_simplified0 %in% "SLO")) %>% group_by(condition_detailed_simplified) %>%
  slice_sample(n = 1000) 

## 1. Hierarchical clustering for cluster (annotation_level2) order
df1 = df0%>% 
  ungroup() %>%
  group_by(annotation_level2, organ_simplified0) %>%
  summarize(count = n(), .groups = "drop") %>%  # Count the number of cells in each group
  as.data.frame()

mat_clust <- df1 %>%
  select(annotation_level2, organ_simplified0, count) %>%
  pivot_wider(
    names_from  = organ_simplified0,
    values_from = count,
    values_fill = 0
  ) %>% as.data.frame()

rownames(mat_clust) <- mat_clust$annotation_level2
mat_clust$annotation_level2 <- NULL

cluster_order <- rownames(mat_clust)[hclust(dist(mat_clust))$order]

## 2. Hierarchical clustering for organ order
df1 = df0%>% 
  ungroup() %>%
  group_by(annotation_level2, organ_simplified0) %>%
  summarize(count = n(), .groups = "drop") %>%  # Count the number of cells in each group
  as.data.frame()

mat_org <- df1 %>%
  select(organ_simplified0, annotation_level2, count) %>%
  pivot_wider(
    names_from  = annotation_level2,
    values_from = count,
    values_fill = 0
  ) %>% as.data.frame()

rownames(mat_org) <- mat_org$organ_simplified0
mat_org$organ_simplified0 <- NULL

organ_order <- rownames(mat_org)[hclust(dist(mat_org))$order]

## 3. Hierarchical clustering for condition_detailed order
df2 = df0%>% 
  ungroup() %>%
  group_by(annotation_level2, condition_detailed_simplified) %>%
  summarize(count = n(), .groups = "drop") %>%  # Count the number of cells in each group
  as.data.frame()
mat_cond <- df2 %>%
  select(condition_detailed_simplified, annotation_level2, count) %>%
  pivot_wider(
    names_from  = annotation_level2,
    values_from = count,
    values_fill = 0
  ) %>% as.data.frame()

rownames(mat_cond) <- mat_cond$condition_detailed_simplified
mat_cond$condition_detailed_simplified <- NULL

cond_order <- rownames(mat_cond)[hclust(dist(mat_cond))$order]

#4. Alluvial 3-way
# Example: organ - cluster - condition_broad
df3 <- df0 %>%
  group_by(organ_simplified0, annotation_level2, condition_detailed_simplified) %>%
  summarise(count = n(), .groups = "drop")

df3 <- df3 %>%
    mutate(
        annotation_level2 = factor(annotation_level2, levels = cluster_order),
        condition_detailed_simplified  = factor(condition_detailed_simplified,  levels = cond_order),
        organ_simplified0  = factor(organ_simplified0,  levels = organ_order)
    )


highlight <- "CD4_cl14"
df3_plot <- df3 %>%
  mutate(
    # is this alluvium part of the highlighted condition?
    is_highlight = annotation_level2 %in% highlight,
    # fill key: either "other" (grey) or the level2 cluster name
    fill_key = ifelse(is_highlight, as.character(annotation_level2), "other"),
    # alpha: low for background, high for highlight
    alpha_val = ifelse(is_highlight, 1, 0.25)
  )
pal_alluv <- c(other = "grey80", CD4_cl14 = "red")
# pal_alluv <- c(other = "grey80", mypal_level2)  
# pal_alluv <- setNames(mypal, unique(df3_plot$fill_key))
df3_plot %>% count(is_highlight)
p = PlotAlluvialHighlight(df3_plot, mypal_alluv = pal_alluv)

pdf(sprintf("%s/alluvial_CD4_cl14.pdf", out_dir), 15,5, useDingbats = F)
p
dev.off()

```

**Figure 8: cl10 + infection cleared + Ag specific + NLT vs cl10_noninfection**

```{r}
mdata_orig = so_orig@meta.data

mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("B16_ACT", "PDAC", "GBMclass", "GBMmes", "KP")) %>% count(condition_detailed_simplified)
mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & !(condition_broad %in% c("healthy", "cancer"))) %>% count(condition_detailed_simplified)
mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("baseline")) %>% count(condition_detailed_simplified)

res_list = list()

mdata_orig %>% filter( annotation_level2 %in% c("CD8_cl10") & !is.na(Ag_spe) & infection_phase == "cleared" & !(organ_simplified %in% c("spleen", "SLO", "LN"))) %>% count(condition_detailed_organ)
mdata_orig %>% filter( annotation_level2 %in% c("CD8_cl10") & !(condition_broad %in% c("bacteria", "fungus", "virus", "parasite"))& !(organ_simplified %in% c("spleen", "SLO", "LN"))) %>% count(condition_detailed_organ)

group1 = mdata_orig %>% filter( annotation_level2 %in% c("CD8_cl10") & !is.na(Ag_spe) & infection_phase == "cleared" & !(organ_simplified %in% c("spleen", "SLO", "LN"))) %>% pull(cellID)
group2 = mdata_orig %>% filter( annotation_level2 %in% c("CD8_cl10") & !(condition_broad %in% c("bacteria", "fungus", "virus", "parasite"))& !(organ_simplified %in% c("spleen", "SLO", "LN"))) %>% pull(cellID)
length(group1)
length(group2)
res_list[["CD8cl10_Trm_vs_CD8cl10_nonTrm"]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("CD8_cl10 Trm vs CD8_cl10 nonTrm%s",""))
# res_list[["CD8cl10_Trm_vs_CD8cl10_nonTrm"]]$p1
# res_list[["CD8cl10_Trm_vs_CD8cl10_nonTrm"]]$p2
# res_list[["CD8cl10_Trm_vs_CD8cl10_nonTrm"]]$diff_genes %>% arrange(desc(log2FC)) %>% head(50) %>% pull(SYMBOL)

group1 = mdata_orig %>% filter( annotation_level2 %in% c("CD8_cl10") & !is.na(Ag_spe) & infection_phase == "cleared" & !(organ_simplified %in% c("spleen", "SLO", "LN"))) %>% pull(cellID)
group2 = mdata_orig %>% filter( annotation_level2 %in% c("CD8_cl1") & spleen_standard == T) %>% pull(cellID)
length(group1)
length(group2)
res_list[["CD8cl10_Trm_vs_CD8cl1_spleenstandard"]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("CD8_cl10 Trm vs CD8_cl1 spleen standard %s",""))
# res_list[["CD8cl10_Trm_vs_CD8cl1_spleenstandard"]]$p1
# res_list[["CD8cl10_Trm_vs_CD8cl1_spleenstandard"]]$p2
# res_list[["CD8cl10_Trm_vs_CD8cl1_spleenstandard"]]$diff_genes %>% arrange(desc(log2FC)) %>% head(50) %>% pull(SYMBOL)

group1 = mdata_orig %>% filter( annotation_level2 %in% c("CD8_cl10") & !(condition_broad %in% c("bacteria", "fungus", "virus", "parasite"))& !(organ_simplified %in% c("spleen", "SLO", "LN"))) %>% pull(cellID)
group2 = mdata_orig %>% filter( annotation_level2 %in% c("CD8_cl1") & spleen_standard == T) %>% pull(cellID)
length(group1)
length(group2)
res_list[["CD8cl10_nonTrm_vs_CD8cl1_spleenstandard"]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("CD8_cl10 Trm vs CD8_cl1 spleen standard %s",""))
# res_list[["CD8cl10_nonTrm_vs_CD8cl1_spleenstandard"]]$p1
# res_list[["CD8cl10_nonTrm_vs_CD8cl1_spleenstandard"]]$p2
# res_list[["CD8cl10_Trm_vs_CD8cl1_spleenstandard"]]$diff_genes %>% arrange(desc(log2FC)) %>% head(50) %>% pull(SYMBOL)

all(res_list[[2]]$diff_genes$SYMBOL == res_list[[3]]$diff_genes$SYMBOL)

i = "CD8cl10_Trm_vs_CD8cl1_spleenstandard"
j = "CD8cl10_nonTrm_vs_CD8cl1_spleenstandard"
vplot = data.frame(fc1 = 2^(res_list[[i]]$diff_genes$log2FC), fc2 = 2^(res_list[[j]]$diff_genes$log2FC), SYMBOL = res_list[[i]]$diff_genes$SYMBOL)
genes_to_plot = c(res_list[[i]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(200) %>% pull(SYMBOL), res_list[[j]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(200) %>% pull(SYMBOL)) %>% unique()
# genes_to_label = vplot[genes_to_plot, ]
p1 = FCFCplot(vplot, 
         xlab = "CD8_cl10 Trm vs baseline cl1 spleen", 
         ylab = "CD8_cl10 nonTrm vs baseline cl1 spleen", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = genes_to_plot, xlimits = c(1/3, 3), ylimits = c(1/3, 3)) + NoGrid()
p2 = FCFCplot(vplot, 
         xlab = "CD8_cl10 Trm vs baseline cl1 spleen", 
         ylab = "CD8_cl10 nonTrm vs baseline cl1 spleen", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = NULL, xlimits = c(1/3, 3), ylimits = c(1/3, 3)) + NoGrid()


pdf(sprintf("%s/FlashierDGE_CD8_cl10_Trm_vs_nonTrm.pdf",out_dir), 7, 7, useDingbats = F)
res_list[["CD8cl10_Trm_vs_CD8cl10_nonTrm"]]$p1 + NoGrid()
res_list[["CD8cl10_Trm_vs_CD8cl10_nonTrm"]]$p2 + NoGrid()
res_list[["CD8cl10_Trm_vs_CD8cl1_spleenstandard"]]$p1 + NoGrid()
res_list[["CD8cl10_Trm_vs_CD8cl1_spleenstandard"]]$p2 + NoGrid()
res_list[["CD8cl10_nonTrm_vs_CD8cl1_spleenstandard"]]$p1 + NoGrid()
res_list[["CD8cl10_nonTrm_vs_CD8cl1_spleenstandard"]]$p2 + NoGrid()
print(p1)
print(p2)
dev.off()

i1 = "CD8cl10_Trm_vs_CD8cl10_nonTrm"
i2 = "CD8cl10_Trm_vs_CD8cl1_spleenstandard"
i3 = "CD8cl10_nonTrm_vs_CD8cl1_spleenstandard"
write.table(res_list[[i1]]$diff_genes, file = sprintf("%s/%s.txt",out_dir, i1), row.names = F, sep = "\t")
write.table(res_list[[i2]]$diff_genes, file = sprintf("%s/%s.txt",out_dir, i2), row.names = F, sep = "\t")
write.table(res_list[[i3]]$diff_genes, file = sprintf("%s/%s.txt",out_dir, i3), row.names = F, sep = "\t")
saveRDS(res_list, file = sprintf("%s/FlashierDGE_CD8_cl10_Trm_vs_nonTrmAnalysis.Rds",out_dir) )



```

