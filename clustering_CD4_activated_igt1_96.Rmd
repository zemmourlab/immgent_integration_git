---
title: "clustering_CD4"
output: html_document
date: "2024-10-17"
editor_options: 
  chunk_output_type: console
---

**Start interactive session on Midway3**
```{bash}
ssh -Y zemmour@midway3.rcc.uchicago.edu
sinfo -s
screen -S david
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=jfkfloor2 --qos=jfkfloor2 --nodes=1 
sinteractive --time=12:00:00 --account=pi-zemmour --partition=caslake --nodes=1 --mem=128GB
sinteractive --time=3:00:00 --account=pi-zemmour --partition=gpu --gres=gpu:1 --mem=152GB
cd $LABHOME

module load python/anaconda-2022.05 
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13

#sinteractive --time=1:00:00 -p gpu --gres=gpu:1 --account=pi-zemmour 

#source activate /project/jfkfloor2/zemmourlab/david/envs/scvi
source activate /project/zemmour/david/envs/scvi_20240315
module load openblas/0.3.13 #load again or error

cd /project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD4_activated
#cd ~/google_drive/ImmgenT/analysis/data_integration/IGT1_56/Treg

R
#options(max.print=1000)
#options(Seurat.object.assay.version = 'v5')
```

**Initialize: load libraries and custom functions**

```{r}
options(max.print=1000)
setwd("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD4_activated")
source("/project/jfkfloor2/zemmourlab/david/immgent/immgent_integration_git/custom_functions_david.R")

libs = c("fgsea","fastTopics", "flashier", "Matrix", "Seurat","BPCells", "ggplot2", "dplyr", "reshape2", "ggrastr", "RColorBrewer", "pals", "scales", "pheatmap") 
#libs = c("matrixStats", "gplots","ggplot2", "reshape2", "scales", "gridExtra", "dplyr", "RColorBrewer", "grid", "Rtsne", "limma",   "RColorBrewer", "pheatmap", "Seurat",  "ggrastr", "ggbeeswarm") #pwr, preprocessCore, "readxl", vegan", "genefilter" "scde" "cellrangerRkit", "Rsamtools", "GenomicRanges", "GenomicAlignments", "VGAM", "WGCNA",rafalib, ‘UsingR’,MAST "ggrastr",
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))


#Gradients
library(RColorBrewer)
ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
ColorRamp = rev(rainbow(10, end = 4/6))
library(viridis)
ColorRamp = rev(viridis(100))
ColorRamp = rev(cividis(100))
#image(1:100, 1, as.matrix(1:100), col = ColorRamp, main = "Color Palette", xaxt = 'n', yaxt = 'n', xlab = "", ylab = "")

#mycol = c("black","blue","red","darkgreen", "orange","purple", "cyan", "greenyellow",    "salmon", "magenta","pink", "tan", "brown") # c("magenta", "red",  "darkgreen", "cyan", "blue", "blue", "blue", "black", "blue", "blue", "blue", "blue", "orange")

#Large Color palette
library("pals")
n = 70
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
mypal1 = unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals))))
mypal1 = mypal1[-4]
mypal = c(glasbey(), polychrome(), mypal1)
names(mypal) = NULL
#pal.bands(mypal, main="Colormap suggestions")

#parade = function(n) { return(Seurat::DiscretePalette(n, palette = "parade", shuffle = F)) }


```

Seurat object with the results: igt1_96_cd4_20241017.Rds
Cluster_totalvi_20241014_CD4_activated_rmIGTsample_Res.csv

```{r}

so = readRDS(file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD4/igt1_96_CD4_activated_20241017.Rds")
so = NormalizeData(so,assay = "RNA", normalization.method = "LogNormalize",verbose = T)
so = NormalizeData(so,assay = "ADT", normalization.method = "CLR", verbose = T)

```

**Load seurat expression data**
--> igt1_96_treg_20241017.Rds
```{r}
so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD4/igt1_96_cd4_20241017.Rds")

annot = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/annotation_CD4_clusters_l1.csv",header = F, sep = ",", row.names = 1)
so_orig$annotation_CD4_level1 = annot[match(colnames(so_orig), rownames(annot)),1]

so = so_orig[,so_orig$annotation_CD4_level1 == "CD4_activated"]
so[['mde_totalvi_20241006']] = NULL
so[['umap2_totalvi_20241006']] = NULL
so[['mdeumap_totalvi_20241006']] = NULL
so[['mde_totalvi_20241008_rmIGTsample']] = NULL
so[['mdeumap_totalvi_20241008_rmIGTsample']] = NULL

```

Add latent spaces, umaps
```{r}
# sprintf("%s_X_SCVI_%s.csv", prefix, prefix2)

AddLatentData = function(so, latent_file, prefix, calculate_umap = F) {
    totalvi = read.csv(file = latent_file, header = T, sep = ",", row.names = 1)
    # pattern = "(IGT\\S*)_(\\d+)"
    # rownames(totalvi) = gsub(pattern, "\\1", rownames(totalvi))
    colnames(totalvi) = as.character(seq(1:ncol(totalvi)))
    #all(rownames(totalvi) == colnames(so))
    totalvi = as.matrix(totalvi)
    pattern = "^IGT\\d{1,2}\\.[A-Z]{16}$"
    matches = grepl(pattern, rownames(totalvi))
    if (!all(matches)) {
        print("updating cell names in csv file, assuming same order as seurat object" )
        #rownames(totalvi) = gsub(pattern = "(\\S*)_(\\d+)", replacement = "\\1", rownames(totalvi))
        rownames(totalvi) = colnames(so)
    }
    totalvi = totalvi[colnames(so),]
    if (all(colnames(so) == rownames(totalvi))) {
        print("all cells ARE in the latent_file")
        so[[prefix]] = CreateDimReducObject(embeddings = totalvi, key = prefix, assay = "RNA") #sprintf("totalvi_%s", prefix2)
        if (calculate_umap == T) {
            so = RunUMAP(so, dims = 1:ncol(totalvi), reduction = prefix, n.components = 2, reduction.name = sprintf("umap_%s", prefix))
        }
        return(so)
    } else {
        print("all cells ARE NOT in the latent_file")
        return(so)
    }
}

dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD4_activated/totalvi_20241014_CD4_activated_rmIGTsample"
so = AddLatentData(so, latent_file = sprintf("%s/latent.csv",dir_with_file), prefix = "totalvi_20241014_CD4_activated_rmIGTsample", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/umap_python.csv",dir_with_file), prefix = "umap_totalvi_20241014_CD4_activated_rmIGTsample", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/mde2.csv",dir_with_file), prefix = "mde_totalvi_20241014_CD4_activated_rmIGTsample", calculate_umap = F)
#write.table(so[['umap_totalvi_20241006']]@cell.embeddings, file = sprintf("%s/umap.csv",dir_with_file), quote = F, sep = ",", row.names = T, col.names = T)

dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD4_activated/totalvi_20241014_CD4_activated"
so = AddLatentData(so, latent_file = sprintf("%s/latent.csv",dir_with_file), prefix = "totalvi_20241014_CD4_activated", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/umap_python.csv",dir_with_file), prefix = "umap_totalvi_20241014_CD4_activated", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/mde2.csv",dir_with_file), prefix = "mde_totalvi_20241014_CD4_activated", calculate_umap = F)

dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD4_activated/totalvi_20241014_CD4_activated_rmIGTsample"
so = AddLatentData(so, latent_file = sprintf("%s/latent.csv",dir_with_file), prefix = "totalvi_20241014_CD4_activated_rmIGTsample", calculate_umap = F)

```

Compare 3 UMAP, umap_totalvi_20241008_rmIGTsample / umap_totalvi_20241014_CD4_rmIGTsample / umap_totalvi_20241014_CD4_activated_rmIGTsample
```{r}

dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/totalvi_20241008_rmIGTsample"
so = AddLatentData(so, latent_file = sprintf("%s/latent.csv",dir_with_file), prefix = "totalvi_20241008_rmIGTsample", calculate_umap = F)
prefix = "totalvi_20241008_rmIGTsample"
so = RunUMAP(so, dims = 1:30, reduction = prefix, n.components = 2, reduction.name = sprintf("umapCD4_%s", prefix))

prefix = "totalvi_20241014_CD4_rmIGTsample"
so = RunUMAP(so, dims = 1:30, reduction = prefix, n.components = 2, reduction.name = sprintf("umapCD4_%s", prefix))

prefix = "totalvi_20241014_CD4_activated_rmIGTsample"
so = RunUMAP(so, dims = 1:30, reduction = prefix, n.components = 2, reduction.name = sprintf("umapCD4_%s", prefix))

pdf(sprintf("%s/Comparing_3UMAPs.pdf", "totalvi_20241014_CD4_activated_rmIGTsample"), 10, 10, useDingbats = F)
DimPlot(so, reduction = "umapCD4_totalvi_20241008_rmIGTsample", group.by = "Cluster_totalvi_20241014_CD4_activated_rmIGTsample_Res0.5", raster = T, raster.dpi = c(512,512))
DimPlot(so, reduction = "umapCD4_totalvi_20241014_CD4_rmIGTsample", group.by = "Cluster_totalvi_20241014_CD4_activated_rmIGTsample_Res0.5", raster = T, raster.dpi = c(512,512))
DimPlot(so, reduction = "umapCD4_totalvi_20241014_CD4_activated_rmIGTsample", group.by = "Cluster_totalvi_20241014_CD4_activated_rmIGTsample_Res0.5", raster = T, raster.dpi = c(512,512))
dev.off()

```

```{r}
prefix = "totalvi_20241014_CD4_activated_rmIGTsample"
#setwd(prefix)
reduc = "mde_totalvi_20241014_CD4_rmIGTsample"
reduc = "umap_totalvi_20241014_CD4_activated_rmIGTsample"
```

```{r}
RenameCluster = function(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl") {
    cl = as.numeric(cluster.vector)
    ordered = order(unique(cl))
    cl = sprintf("%s%s", cluster.prefix, cl )
    renamed.vector = factor(cl, levels = unique(cl)[ordered])
    return(renamed.vector)
}

n_latent = ncol(so[[prefix]]@cell.embeddings)
so = FindNeighbors(so, dims = 1:n_latent, reduction = prefix)
so = FindClusters(so, resolution = 0.25, cluster.name = sprintf("Cluster_%s_Res0.25",prefix))
so = FindClusters(so, resolution = 0.5, cluster.name = sprintf("Cluster_%s_Res0.5",prefix))
so = FindClusters(so, resolution = 0.75, cluster.name = sprintf("Cluster_%s_Res0.75",prefix))
so = FindClusters(so, resolution = 1, cluster.name = sprintf("Cluster_%s_Res1",prefix))
so = FindClusters(so, resolution = 1.5, cluster.name = sprintf("Cluster_%s_Res1.5",prefix))
so = FindClusters(so, resolution = 2, cluster.name = sprintf("Cluster_%s_Res2",prefix))
so = FindClusters(so, resolution = 3, cluster.name = sprintf("Cluster_%s_Res3",prefix))
so = FindClusters(so, resolution = 4, cluster.name = sprintf("Cluster_%s_Res4",prefix))

cluster.name = sprintf("Cluster_%s_Res0.25",prefix)
so[[cluster.name]][,1] = RenameCluster(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl")
cluster.name = sprintf("Cluster_%s_Res0.5",prefix)
so[[cluster.name]][,1] = RenameCluster(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl")
cluster.name = sprintf("Cluster_%s_Res0.75",prefix)
so[[cluster.name]][,1] = RenameCluster(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl")
cluster.name = sprintf("Cluster_%s_Res1",prefix)
so[[cluster.name]][,1] = RenameCluster(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl")
cluster.name = sprintf("Cluster_%s_Res1.5",prefix)
so[[cluster.name]][,1] = RenameCluster(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl")
cluster.name = sprintf("Cluster_%s_Res2",prefix)
so[[cluster.name]][,1] = RenameCluster(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl")
cluster.name = sprintf("Cluster_%s_Res3",prefix)
so[[cluster.name]][,1] = RenameCluster(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl")
cluster.name = sprintf("Cluster_%s_Res4",prefix)
so[[cluster.name]][,1] = RenameCluster(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl")

write.table(data.frame(colnames(so), so@meta.data[,grepl(sprintf("Cluster_%s_Res",prefix), colnames(so@meta.data))]), file = sprintf("%s/%s.csv", prefix, sprintf("Cluster_%s_Res",prefix)), sep = ",", quote = F, row.names = F, col.names = F)

df = data.frame(colnames(soa), soa@meta.data[,grepl(sprintf("Cluster_%s_Res",prefix), colnames(soa@meta.data))])
# write.table( df, file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD4_activated/totalvi_20241014_CD4_activated_rmIGTsample/Cluster_totalvi_20241014_CD4_activated_rmIGTsample_Res.csv", sep = ",", quote = F, row.names = F, col.names = T)

```

UMAP/MDE with clusters
```{r}
# pdf(sprintf("%s/UMAP_Clusters.pdf", prefix), 20, 20, useDingbats = F)
# for (i in c(0.25,0.5,0.75,1,1.5,2,3,4)) {
#     MyPlots(seurat_object = so, 
#         dim1 = so[[reduc]]@cell.embeddings[,1], 
#         dim2 = so[[reduc]]@cell.embeddings[,2], 
#         color_by = sprintf("Cluster_%s_Res%s",prefix,i), 
#         split_by1 = "organ_simplified",
#         split_by2 =  NULL, 
#         genes = NULL, 
#         cluster_key = NULL, mypal = mypal) #glasbey()
# }
# dev.off()

# pdf(sprintf("%s/UMAP_Clusters.pdf", prefix), 20, 20, useDingbats = F)
pdf(sprintf("%s/MDE_Clusters2.pdf", prefix), 20, 20, useDingbats = F)
for (i in c(0.25,0.5,0.75,1,1.5,2,3,4)) {
    print(i)
    print(DimPlot(so, reduction = reduc, group.by = sprintf("Cluster_%s_Res%s",prefix,i), raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal))
    print(DimPlot(so, reduction = reduc, group.by = sprintf("Cluster_%s_Res%s",prefix,i), split.by = "organ_simplified", ncol = trunc(sqrt(length(unique(so$organ_simplified)))), raster = T, raster.dpi = c(512,512), label = F, pt.size = 2) + scale_color_manual(values = mypal))
}
dev.off()

```

UMAP/MDE with genes
```{r}
# pdf(sprintf("%s/UMAP_genes2.pdf", prefix), 20,20, useDingbats = F)
pdf(sprintf("%s/MDE_genes2.pdf", prefix), 30,30, useDingbats = F)
DefaultAssay(so) = "RNA"
FeaturePlot(so, slot = "data", reduction = reduc, features = c("Cd4", "Cd8a", "Cd8b1","Foxp3","Sell", "Ccr7","Cd44","Il7r", "Tcf7", "Cxcr5", "Cd40lg","Bcl6", "Icos", "Tbx21", "Il1rl1", "Nr4a1", "Mki67", "Ifng","Il4", "Rorc", "Il17a", "Il9", "Il22", "Il10", "Pdcd1", "Havcr2", "Ctla4", "Tox", "Ly6c1", "Itgae", "Cd69"), ncol = 5, order = T, raster = T, raster.dpi = c(512,512))
dev.off()

# pdf(sprintf("%s/UMAP_proteins.pdf", prefix), 20,20, useDingbats = F)
pdf(sprintf("%s/MDE_proteins2.pdf", prefix), 30,30, useDingbats = F)
DefaultAssay(so) = "ADT"
FeaturePlot(so[,so$cite_seq == T], reduction = reduc,slot = "data", features = c("CD3","CD4","CD8A","CD8B","TCRB", "CD62L","CD44", "IL2RA.CD25","IL7RA.CD127","CD43", "CD45RB","KLRG1", "CD69", "CD103", "CD27", "CXCR5", "ICOS.CD278", "PDCD1.PD1.CD279",  "HAVCR2", "TIGIT"), ncol = 5, order = T, raster = T, raster.dpi = c(512,512), pt.size = 2)
dev.off()
```



```{r}
DefaultAssay(so) = "ADT"
so[['RNA']]$data = NULL
DefaultAssay(so) = "RNA"
so[['ADT']]$data = NULL

# saveRDS(so, file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD4_activated/igt1_96_CD4_activated_20241017.Rds")

```
