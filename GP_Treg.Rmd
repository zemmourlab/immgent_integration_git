---
title: "Treg_GP"
output: html_document
date: "2025-05-28"
author: "David Zemmour"
editor_options: 
  chunk_output_type: console
---

**Initialize: load libraries and custom functions**

```{bash}
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=jfkfloor2 --qos=jfkfloor2 --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=beagle3-bigmem --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=zemmour-hm --qos=zemmour --nodes=1 
sinteractive --time=03:00:00 --account=pi-zemmour --partition=caslake --nodes=1 --mem=96GB

module load python/anaconda-2022.05 
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13
source activate /project/zemmour/david/envs/scvi_20240315
#source activate /project/zemmour/david/envs/r443
module load openblas/0.3.13

cd /project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg
R
```


```{r}
# setwd("~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96")
libs = c("ZemmourLib","flashier", "patchwork","gridExtra","Matrix", "Seurat", "ggplot2", "dplyr", "reshape2", "ggrastr","scattermore", "RColorBrewer", "pals", "scales", "pheatmap", "rafalib") 
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))
#source("/project/jfkfloor2/zemmourlab/david/immgent/immgent_integration_git/custom_functions_david.R")

ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
ColorRamp = rev(rainbow(10, end = 4/6))
ColorRamp = rev(viridis(100))
ColorRamp = brewer.pal(9, "Blues")

#mycol = c("black","blue","red","darkgreen", "orange","purple", "cyan", "greenyellow",    "salmon", "magenta","pink", "tan", "brown") # c("magenta", "red",  "darkgreen", "cyan", "blue", "blue", "blue", "black", "blue", "blue", "blue", "blue", "orange")

mypal_level2 = immgent_colors$level2
mypal_level1 = immgent_colors$level1
mypal_organ = immgent_colors$organ_simplified

mypal_topics = setNames(object = RColorBrewer::brewer.pal(8,name = "Set1"), c("F27","F12", "F6", "F80", "F15", "F152")) #RColorBrewer::brewer.pal(8,name = "Accent") sample(gtex_colors)
mypal_topics = mypal_topics[!is.na(names(mypal_topics))]

#Large Color palette
library("pals")
n = 70
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
mypal1 = unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals))))
mypal1 = mypal1[-4]
mypal = c(glasbey(), polychrome(), mypal1)
names(mypal) = NULL
#pal.bands(mypal, main="Colormap suggestions")
# mypal_organ = setNames(mypal, unique(so$organ_simplified))
# mypal_organ = mypal_organ[!is.na(names(mypal_organ))]
# mypal_level1 = setNames(mypal, unique(so$annotation_level1))
# mypal_level1 = mypal_level1[!is.na(names(mypal_level1))]
# mypal_level2 = setNames(mypal, unique(so_orig$annotation_level2))
# mypal_level2 = mypal_level2[!is.na(names(mypal_level2))]
# mypal_level2["CD4_cl18"] = "blue"
mypal_igt = setNames(mypal, unique(so$IGT))
mypal_igt = mypal_igt[!is.na(names(mypal_igt))]



```

```{r}
fig_dir = "~/google_drive_uchicago/ImmgenT/20250109_freeze/Treg/paper_Treg/figures/bits_david"
fig_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg/paper_Treg/figures/bits_david"

out_dir = "~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/Treg/GP" 
out_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg/GP"

```


**Most up-to-date data**
on Midway
```{r}
#so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250513_clean.Rds") 
so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250710_clean.Rds") 
so_orig$annotation_level2[so_orig$annotation_level2 == "Treg_cl7"] = "Treg_cl1"

so =  so_orig[,so_orig$annotation_level1 == "Treg"]
so$annotation_level2 = factor(so$annotation_level2, levels = c("Treg_cl1", "Treg_cl3", "Treg_cl6", "Treg_cl2","Treg_cl8","Treg_cl4", "Treg_prolif", "Treg_miniverse"))
```

on Desktop
```{r}
#source('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/analysis/immgent_integration_git/custom_functions_david.R') -->

tt_list = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/analysis/data_integration/IGT1_96/Treg/DGE_limma/20250109/ttlist_OneVsAll.Rds')

```

Counting cells
```{r}
library(dplyr)

target_organs <- c("blood", "spleen", "LN", "thymus")

nlt = so_orig@meta.data %>% filter(annotation_level1 == "Treg" & !(organ_simplified %in% target_organs)) %>% count(name = "total_cells")

tot= so_orig@meta.data %>% filter(annotation_level1 == "Treg") %>% count(name = "total_cells")
(nlt)/tot
so_orig@meta.data %>% filter(annotation_level1 == "Treg") %>% distinct(IGTHT) %>% nrow()
```


**Load L1 and F1**
```{r}
prefix = "topic"
prefix2 = "flashier20250215_alldata_backfit"
fit_flash = readRDS(sprintf("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/%s/%s/fit.Rds", prefix,prefix2))
fit = fit_flash

res = ldf(fit, type = "i")
L1 = with(res, L %*% diag(D)  ) #same as res$L %*% diag(res$D)
L1 = L1[colnames(so),]
all(colnames(so) == rownames(L1))
any(is.na(L1))
colnames(L1) = sprintf("F%s", 1:ncol(L1))
# sub_cells = sample(colnames(so_orig), 1500, replace = F)
# sub_cells = c(sample(colnames(so_orig)[so_orig$annotation_level1 %in% "Treg"], 1500, replace = F), sample(colnames(so_orig)[!so_orig$annotation_level1 %in% "Treg"], 1500, replace = F))
# sub_cells = c(so_orig@meta.data %>% filter(annotation_level1 == "Treg") %>% slice_sample(n = 1500, replace = FALSE) %>% pull(cellID),
#               so_orig@meta.data %>% filter(annotation_level1 != "Treg") %>% group_by(annotation_level1) %>% slice_sample(n = 100, replace = FALSE) %>% ungroup() %>% pull(cellID))

F1 = with(ldf(fit, type = "i"), F)
colnames(F1) = paste("F", 1:ncol(F1), sep = "")


# mdata_orig = read.table("metadata_20250513_mde.txt", header = T, sep = "\t")
mdata_orig = so@meta.data
```

GP specific to each level2?
cl1: F9
not cl1: 27,6,25
cl3: 12
cl6: (15),174
cl2: 27,6,35
cl4: 25,80
cl8: 6,152,25,27,72

```{r}

# group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl1") & organ_simplified %in% c("lung") & condition_detailed %in% c("baseline")) %>% pull(cellID) #c("HDM", "HDM_primaryD5", "HDM_secondaryD3")
# group2 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl8") & organ_simplified %in% c("colon") & condition_detailed %in% c("baseline")) %>% pull(cellID)

pops = c("Treg_cl1", "Treg_cl2", "Treg_cl3", "Treg_cl4", "Treg_cl6", "Treg_cl8")

pdf(sprintf("%s/FlashierDGE_Tregclusters.pdf",out_dir),10, 10, useDingbats = F)
results = list()
for (pop in pops) {
    print(pop)
    group1 = mdata_orig %>% filter( annotation_level2 %in% c(pop) ) %>% pull(cellID) #c("HDM", "HDM_primaryD5", "HDM_secondaryD3")
    group2 = mdata_orig %>% filter( !annotation_level2 %in% c(pop, "Treg_prolif", "Treg_miniverse") ) %>% pull(cellID)
    length(group1)
    length(group2)

    results[[pop]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("%s vs other Tregs",pop))
    # results$diff_genes %>% arrange(desc(log2FC)) %>% head(50) %>% pull(SYMBOL)
    # print(results[[pop]]$p1) # First plot (MA plot of factors)
    # print(results[[pop]]$p2)  # Second plot (MA plot of genes)
}
dev.off()

```

topics_to_plot = c("F12", "F35", "F27","F72","F25","F80","F6") # --> v3 pdf for final figure
Dot plot and structure plots
```{r}
# topics_to_plot = c("F9", "F27","F6", "F25", "F12", "F174", "F25", "F80", "F152", "F72")
topics_to_plot = c("F9","F12", "F27","F174", "F72",  "F35", "F6","F152", "F25", "F80")  # --> v2 pdf
mypal_level2[grepl("Treg",names(mypal_level2))]
mypal_topics = c(F9 = "darkolivegreen",#as.character(mypal_level2["Treg_cl3"]),
                 F12 = as.character(mypal_level2["Treg_cl3"]),
                 F27 = as.character(mypal_level2["Treg_cl2"]),
                 F174 = as.character(mypal_level2["Treg_cl6"]),
                 F72 = as.character(mypal_level2["Treg_cl8"]), #cl8
                 F35 = "chartreuse", #as.character(mypal_level2["Treg_cl8"])
                 F6 = "chartreuse3",#as.character(mypal_level2["Treg_cl8"]),
                 F152 = "chartreuse4", #as.character(mypal_level2["Treg_cl8"]),
                 F25 = as.character(mypal_level2["Treg_cl4"]),
                 F80 = "darkorchid")#as.character(mypal_level2["Treg_cl4"]))

topics_to_plot = c("F12", "F35", "F27","F72","F25","F80","F6") # --> v3 pdf for final figure
mypal_topics = c(F12 = as.character(mypal_level2["Treg_cl3"]),
                 F35 = "deepskyblue4", #as.character(mypal_level2["Treg_cl6"])
                 F27 = as.character(mypal_level2["Treg_cl2"]),
                 F72 = as.character(mypal_level2["Treg_cl8"]), #cl8
                 # F152 = "chartreuse4", #cl8
                 F25 = as.character(mypal_level2["Treg_cl4"]),
                 F80 = "darkorchid4",
                 F6 = "darkorange4")
# mypal_topics = setNames(object = RColorBrewer::brewer.pal(10, name = "Set3"),topics_to_plot) #RColorBrewer::brewer.pal(8,name = "Accent") sample(gtex_colors)
# mypal_topics = mypal_topics[!is.na(names(mypal_topics))]

idx_mat <- apply(F1[,topics_to_plot], 2, function(col) head(order(col, decreasing = TRUE), 15))
idx_vec <- as.vector(idx_mat)
idx_vec <- unique(as.vector(idx_mat))
top_genes <- rownames(F1)[idx_vec]

diff_genes = lapply(results, function(x) { x[["diff_genes"]] %>% as.data.frame() %>% arrange(desc(log2FC)) %>% head(50) %>% pull(SYMBOL)}) %>% unlist() %>% unique()
diff_genes

intersect(top_genes, diff_genes) %>% length()

sub_cells = c(so@meta.data %>% filter(annotation_level1 == "Treg" & !(annotation_level2 %in% c("Treg_miniverse", "Treg_prolif"))) %>% group_by(annotation_level2) %>% slice_sample(n = 500, replace = FALSE) %>% ungroup() %>% pull(cellID))

so2 = so[,sub_cells] %>% NormalizeData()

# pdf(file = sprintf("%s/DotPlot_Tregclusters.pdf", out_dir), 20, 5, useDingbats = F)
# DotPlot(object = so2, top_genes, assay = "RNA", group.by = "annotation_level2")  + scale_colour_gradientn(colours =  rev(magma(10))) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
# DotPlot(object = so2, top_genes, assay = "RNA", group.by = "annotation_level2") + scale_colour_gradientn(colours =  colorRampPalette(c('white','red'))(20)) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
# DotPlot(object = so2, top_genes, assay = "RNA", group.by = "annotation_level2") + scale_colour_gradientn(colours =  rev(colorRampPalette(brewer.pal(n = 7,name = "RdBu"))(20))) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
# dev.off() 


#MyDotPlot
p = list()
top_genes2 = results[["Treg_cl1"]]$diff_genes %>% arrange(desc(log2FC)) %>% head(10) %>% pull(SYMBOL) 
p[["Treg_cl1"]] = MyDotPlot(object = so2, features = top_genes2, assay = "RNA", group.by = "annotation_level2", dot.scale = 6, scale = T, scale.by = "radius",point.shape = 21, alpha.range = c(0, 1), show.alpha.legend = F)  +
    labs(subtitle = "resting", x = NULL) +
    scale_fill_gradientn(colours =  colorRampPalette(c("grey",'white',"blue"))(10)) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + coord_flip()

idx_mat <- apply(F1[,topics_to_plot], 2, function(col) head(order(col, decreasing = TRUE), 15))


for (topic in topics_to_plot) {
    print(topic)
    idx_vec <- as.vector(idx_mat[,topic])
    top_genes = rownames(F1)[idx_vec] %>% intersect(diff_genes)
    # p[[topic]] = DotPlot(object = so, top_genes, assay = "RNA", group.by = "annotation_level2", dot.scale = 6, scale = T, scale.by = "radius")  + 
    #     labs(y = topic, x = NULL) +
    #     scale_colour_gradientn(colours =  colorRampPalette(c('white',mypal_topics[topic]))(10)) + 
    #     theme(axis.text.x = element_text(angle = 45, hjust = 1)) + coord_flip()
    p[[topic]] = MyDotPlot(object = so2, top_genes, assay = "RNA", group.by = "annotation_level2", dot.scale = 6, scale = T, scale.by = "radius",point.shape = 21, alpha.range = c(0, 1), show.alpha.legend = F)  + 
    labs(subtitle = topic, x = NULL) +
    scale_fill_gradientn(colours =  colorRampPalette(c("grey",'white',mypal_topics[topic]))(10)) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + coord_flip()

}

stacked = wrap_plots(p, ncol = 1) + plot_layout(axes = "collect_x", guides = "collect")  # collect x-axes & legends
pdf(file = sprintf("%s/GeneTilePlot_Tregclusters_stacked_v3.pdf", out_dir), 5, 20, useDingbats = F)
stacked
dev.off()

#Structure Plot
# sub_cells = so@meta.data %>% filter(annotation_level1 == "Treg" & condition_broad == "healthy") %>% group_by(annotation_level2) %>% slice_sample(n = 100, replace = FALSE) %>% ungroup() %>% pull(cellID)

# fastTopics::structure_plot(L1[sub_cells,topics_to_plot], topics = topics_to_plot, gap = 25, colors = mypal_topics,loadings_order = sub_cells,grouping = so_orig$annotation_level2[sub_cells]) + ylim(values = c(0,5))
# fastTopics::structure_plot(L1[sub_cells,topics_to_plot], topics = topics_to_plot, loadings_order = "embed", colors = mypal_topics, gap = 25, grouping = factor(so_orig$annotation_level2[sub_cells], levels = c("Treg_cl1", "Treg_cl3", "Treg_cl6", "Treg_cl2","Treg_cl8","Treg_cl4", "Treg_prolif", "Treg_miniverse"))) + ylim(values = c(0,5)) #gap = 25, grouping = factor(so_orig$annotation_level2[sub_cells])
# fastTopics::structure_plot(L1[sub_cells,topics_to_plot], topics = topics_to_plot, loadings_order = "embed", colors = mypal_topics) + ylim(values = c(0,5)) #gap = 25, grouping = factor(so_orig$annotation_level2[sub_cells])

library(Rtsne)
tmp = L1[sub_cells,topics_to_plot]
tsne_1d = Rtsne(
    tmp,
    dims = 1,
    perplexity = 30,
    theta = 0.5,
    pca = FALSE,              # we already did PCA
    check_duplicates = FALSE, # avoid error if rows are duplicated
    verbose = TRUE
  )
ord_cells = order(tsne_1d$Y)
p_struct = fastTopics::structure_plot(L1[sub_cells,topics_to_plot], topics = topics_to_plot, loadings_order = ord_cells, colors = mypal_topics) + ylim(values = c(0,5)) #gap = 25, grouping = factor(so_orig$annotation_level2[sub_cells])

library(dplyr)
library(ggplot2)
library(patchwork)   # to stack with your main plot
tmp = data.frame(annotatation_level2 = so@meta.data[sub_cells,"annotation_level2"], order = order(tsne_1d$Y))
# ggplot2(tmp) + geom_bar(aes(order, fill = annotation_level2))
# ensure rows are in the right left→right order
ann_df <- tmp %>% arrange(order) %>%
  mutate(x = order, y = 1)   # constant height row
p_bar <- ggplot(ann_df, aes(x = x, y = y, fill = annotatation_level2)) +
    geom_tile(height = 1, width = 1) +  # outline = fill
    scale_fill_manual(values = mypal_level2) +
    # facet_wrap(~ annotatation_level2, scales = "free_y") +
    theme_void() +
    theme(legend.position = "none",
          plot.margin = margin(0, 5, 0, 5))

p_bar_list = list()
for (i in levels(so2$annotation_level2)[1:6]){
    print(i)
    p_bar_list[[i]] <- ggplot() +
        geom_tile(data = ann_df %>% filter(annotatation_level2 == i), aes(x = x, y = y, fill = annotatation_level2), height = 1, width = 1) +
        # Add more geom_tile() layers for other levels if necessary
        scale_fill_manual(values = mypal_level2) +
        theme_void() +
        theme(legend.position = "none",
              plot.margin = margin(0, 5, 0, 5))
}

stacked = wrap_plots(p_bar_list, ncol = 1) + plot_layout(axes = "collect_x", guides = "collect")  # collect x-axes & legends

pdf(file = sprintf("%s/StructurePlot_Tregclusters_stacked_v3.pdf", out_dir), 20, 10, useDingbats = F)
stacked2 <- p_struct / stacked + plot_layout(heights = c(10, 2.5), guides = "collect")
stacked2
dev.off()


########

# tmp = data.frame(level2 = so@meta.data[sub_cells,"annotation_level2"], order = order(tsne_1d$Y))
# ggplot2(tmp) + geom_bar(aes(order, fill = annotation_level2))

ZemmourLib::MyStructurePlot(loadings_matrix = L1[sub_cells,], grouping = so$annotation_level2[sub_cells], topics = c("F9", "F27","F6", "F25", "F12", "F174", "F25", "F80", "F152", "F72"), colors = mypal_topics, y_limit = c(0, 4), bar_width = 1)
ZemmourLib::MyStructurePlot(loadings_matrix = L1[sub_cells,], grouping = so_orig$annotation_level1[sub_cells], topics = c("F27"), colors = mypal_topics, y_limit = c(0, 4), bar_width = 4)

sub_cells = c(so_orig@meta.data %>% filter(annotation_level1 == "Treg") %>% group_by(annotation_level2) %>% slice_sample(n = 500, replace = FALSE) %>% ungroup() %>% pull(cellID))
fastTopics::structure_plot(L1[sub_cells,], topics = c(27,68), colors = mypal_topics, gap = 25, loadings_order = sub_cells,grouping = so_orig$annotation_level2[sub_cells]) + ylim(values = c(0,5))

```

**plots for exploration and testing for figure**

Structure plot with 
cl1: F9
not cl1: 27,6,25
cl3: 12
cl6: (15),174
cl2: 27,6,35
cl4: 25,80
cl8: 6,152,25,27,72
```{r}
mypal_topics = setNames(object = RColorBrewer::brewer.pal(10,name = "Set3"), c("F9", "F27","F6", "F25", "F12", "F174", "F25", "F80", "F152", "F72")) #RColorBrewer::brewer.pal(8,name = "Accent") sample(gtex_colors)
mypal_topics = mypal_topics[!is.na(names(mypal_topics))]

sub_cells = so@meta.data %>% filter(annotation_level1 == "Treg" & condition_broad == "healthy") %>% group_by(annotation_level2) %>% slice_sample(n = 100, replace = FALSE) %>% ungroup() %>% pull(cellID)
structure_plot(L1[sub_cells,], topics = c(27,68), gap = 25, colors = mypal_topics,loadings_order = sub_cells,grouping = so_orig$annotation_level2[sub_cells]) + ylim(values = c(0,5))
ZemmourLib::MyStructurePlot(loadings_matrix = L1[sub_cells,], grouping = so$annotation_level2[sub_cells], topics = c("F9", "F27","F6", "F25", "F12", "F174", "F25", "F80", "F152", "F72"), colors = mypal_topics, y_limit = c(0, 4), bar_width = 1)
ZemmourLib::MyStructurePlot(loadings_matrix = L1[sub_cells,], grouping = so_orig$annotation_level1[sub_cells], topics = c("F27"), colors = mypal_topics, y_limit = c(0, 4), bar_width = 4)

sub_cells = c(so_orig@meta.data %>% filter(annotation_level1 == "Treg") %>% group_by(annotation_level2) %>% slice_sample(n = 500, replace = FALSE) %>% ungroup() %>% pull(cellID))
structure_plot(L1[sub_cells,], topics = c(27,68), colors = mypal_topics, gap = 25, loadings_order = sub_cells,grouping = so_orig$annotation_level2[sub_cells]) + ylim(values = c(0,5))

```

MyDotPlot
1,3,6,2,8,4
F9, 27, 12, 174, 6, 35, 25, 80, 152, 72
F9, 27, 12, (174), 6, 35, 25, 80, 152, 72
```{r}
# topics_to_plot = c("F9", "F27","F6", "F25", "F12", "F174", "F25", "F80", "F152", "F72")
topics_to_plot = c("F9", "F27","F12", "F174", "F6", "F35", "F25", "F80", "F152", "F72")
mypal_topics = setNames(object = RColorBrewer::brewer.pal(10, name = "Set3"),topics_to_plot) #RColorBrewer::brewer.pal(8,name = "Accent") sample(gtex_colors)
mypal_topics = mypal_topics[!is.na(names(mypal_topics))]

idx_mat <- apply(F1[,topics_to_plot], 2, function(col) head(order(col, decreasing = TRUE), 15))
idx_vec <- as.vector(idx_mat)
idx_vec <- unique(as.vector(idx_mat))
top_genes <- rownames(F1)[idx_vec]

diff_genes = lapply(results, function(x) { x[["diff_genes"]] %>% as.data.frame() %>% arrange(desc(log2FC)) %>% head(50) %>% pull(SYMBOL)}) %>% unlist() %>% unique()
diff_genes

intersect(top_genes, diff_genes) %>% length()

sub_cells = c(so@meta.data %>% filter(annotation_level1 == "Treg" & !(annotation_level2 %in% c("Treg_miniverse", "Treg_prolif"))) %>% group_by(annotation_level2) %>% slice_sample(n = 500, replace = FALSE) %>% ungroup() %>% pull(cellID))

so2 = so[,sub_cells] %>% NormalizeData()

pdf(file = sprintf("%s/DotPlot_Tregclusters.pdf", out_dir), 20, 5, useDingbats = F)
DotPlot(object = so2, top_genes, assay = "RNA", group.by = "annotation_level2")  + scale_colour_gradientn(colours =  rev(magma(10))) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
DotPlot(object = so2, top_genes, assay = "RNA", group.by = "annotation_level2") + scale_colour_gradientn(colours =  colorRampPalette(c('white','red'))(20)) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
DotPlot(object = so2, top_genes, assay = "RNA", group.by = "annotation_level2") + scale_colour_gradientn(colours =  rev(colorRampPalette(brewer.pal(n = 7,name = "RdBu"))(20))) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
dev.off() 

idx_mat <- apply(F1[,topics_to_plot], 2, function(col) head(order(col, decreasing = TRUE), 15))
p = list()
for (topic in topics_to_plot) {
    print(topic)
    idx_vec <- as.vector(idx_mat[,topic])
    top_genes = rownames(F1)[idx_vec] %>% intersect(diff_genes)
    # p[[topic]] = DotPlot(object = so, top_genes, assay = "RNA", group.by = "annotation_level2", dot.scale = 6, scale = T, scale.by = "radius")  + 
    #     labs(y = topic, x = NULL) +
    #     scale_colour_gradientn(colours =  colorRampPalette(c('white',mypal_topics[topic]))(10)) + 
    #     theme(axis.text.x = element_text(angle = 45, hjust = 1)) + coord_flip()
    p[[topic]] = MyDotPlot(object = so2, top_genes, assay = "RNA", group.by = "annotation_level2", dot.scale = 6, scale = T, scale.by = "radius",point.shape = 21, alpha.range = c(0, 1), show.alpha.legend = F)  + 
    labs(y = topic, x = NULL) +
    scale_fill_gradientn(colours =  colorRampPalette(c("grey",'white',mypal_topics[topic]))(10)) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + coord_flip()

}

top_genes2 = results[["Treg_cl1"]]$diff_genes %>% arrange(desc(log2FC)) %>% head(10) %>% pull(SYMBOL) 
p[["Treg_cl1"]] = MyDotPlot(object = so2, features = top_genes2, assay = "RNA", group.by = "annotation_level2", dot.scale = 6, scale = T, scale.by = "radius",point.shape = 21, alpha.range = c(0, 1), show.alpha.legend = F)  + 
    labs(y = topic, x = NULL) +
    scale_fill_gradientn(colours =  colorRampPalette(c("grey",'white',"blue"))(10)) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + coord_flip()

stacked = wrap_plots(p, ncol = 1) + plot_layout(axes = "collect_x", guides = "collect")  # collect x-axes & legends
pdf(file = sprintf("%s/GeneTilePlot_Tregclusters_stacked.pdf", out_dir), 5, 25, useDingbats = F)
stacked
dev.off()
```


F27+F68
```{r}
pdf(file = sprintf("%s/StructurePlot_F27F68.pdf", fig_dir), 10, 5, useDingbats = F)
sub_cells = c(so_orig@meta.data %>% filter(annotation_level1 == "Treg") %>% slice_sample(n = 1500, replace = FALSE) %>% pull(cellID),
              so_orig@meta.data %>% filter(annotation_level1 != "Treg") %>% group_by(annotation_level1) %>% slice_sample(n = 100, replace = FALSE) %>% ungroup() %>% pull(cellID))
structure_plot(L1[sub_cells,], topics = c(27,68), gap = 25, colors = mypal_topics,loadings_order = sub_cells,grouping = so_orig$annotation_level1[sub_cells]) + ylim(values = c(0,5))
ZemmourLib::MyStructurePlot(loadings_matrix = L1[sub_cells,], grouping = so_orig$annotation_level1[sub_cells], topics = c("F68"), colors = mypal_topics, y_limit = c(0, 4), bar_width = 4)
ZemmourLib::MyStructurePlot(loadings_matrix = L1[sub_cells,], grouping = so_orig$annotation_level1[sub_cells], topics = c("F27"), colors = mypal_topics, y_limit = c(0, 4), bar_width = 4)

sub_cells = c(so_orig@meta.data %>% filter(annotation_level1 == "Treg") %>% group_by(annotation_level2) %>% slice_sample(n = 500, replace = FALSE) %>% ungroup() %>% pull(cellID))
structure_plot(L1[sub_cells,], topics = c(27,68), colors = mypal_topics, gap = 25, loadings_order = sub_cells,grouping = so_orig$annotation_level2[sub_cells]) + ylim(values = c(0,5))
dev.off()


```

Gene tile plot
```{r}
pdf(file = sprintf("%s/GeneTilePlot_F27F68.pdf", fig_dir), 5, 5, useDingbats = F)
ZemmourLib::MyGeneTilePlot(gene_factor_matrix = F1, topics = c("F68", "F27"), n_genes_per_topic = 15, title = "Genes in GP")

ZemmourLib::MyGeneTilePlot(gene_factor_matrix = F1, topics = c("F68"), n_genes_per_topic = 15, title = "Genes in GP")
ZemmourLib::MyGeneTilePlot(gene_factor_matrix = F1, topics = c("F68"), n_genes_per_topic = 15,alpha_range = c(0,1), title = "Genes in GP")
dev.off()


```

Activated Treg topics

F171 for cl1?
F27 for all eff
F12 for cl3
F6 for 2/8
F80 for cl4
F15 for cl6
F174 for cl6
F152 for cl8
F5 for prolif
```{r}
sub_cells = c(so_orig@meta.data %>% filter(annotation_level1 == "Treg" & !(annotation_level2 %in% c("Treg_miniverse", "Treg_prolif"))) %>% group_by(annotation_level2) %>% slice_sample(n = 500, replace = FALSE) %>% ungroup() %>% pull(cellID))
mypal_topics = setNames(object = RColorBrewer::brewer.pal(8,name = "Set1"), c("F27","F12", "F6", "F80", "F15", "F152")) #RColorBrewer::brewer.pal(8,name = "Accent") sample(gtex_colors)
mypal_topics = mypal_topics[!is.na(names(mypal_topics))]

pdf(file = sprintf("%s/StructurePlot_ActTregGP.pdf", fig_dir), 10, 5, useDingbats = F)
structure_plot(L1[sub_cells,rev(c("F27","F12", "F15", "F152","F6", "F80"))], topics = rev(c("F27","F12", "F15", "F152","F6", "F80")), colors = mypal_topics, gap = 25, loadings_order = sub_cells,grouping = so_orig$annotation_level2[sub_cells]) + ylim(values = c(0,10)) #
structure_plot(L1[sub_cells,rev(c("F27","F12", "F15", "F152","F6", "F80"))], topics = rev(c("F27","F12", "F15", "F152","F6", "F80")), colors = mypal_topics, gap = 25,loadings_order = "embed", grouping = factor(so_orig$annotation_level2[sub_cells])) + ylim(values = c(0,10)) 
# structure_plot(L1[sub_cells,], topics = c("F27","F12", "F6", "F80", "F15", "F152"), gap = 25, n = 1000,grouping = so_orig$annotation_level2[sub_cells])
MyStructurePlot(loadings_matrix = L1[sub_cells,], grouping = so_orig$annotation_level2[sub_cells], topics = rev(c("F27","F12", "F15", "F152","F6", "F80")), colors = mypal_topics, y_limit = c(0, 10), bar_width = 2)
MyStructurePlot(loadings_matrix = L1[sub_cells,], grouping = so_orig$annotation_level2[sub_cells], topics = c("F27"), colors = mypal_topics, y_limit = c(0, 2.5), bar_width = 2)
MyStructurePlot(loadings_matrix = L1[sub_cells,], grouping = so_orig$annotation_level2[sub_cells], topics = c("F12"), colors = mypal_topics, y_limit = c(0, 2.5), bar_width = 2)
MyStructurePlot(loadings_matrix = L1[sub_cells,], grouping = so_orig$annotation_level2[sub_cells], topics = c("F15"), colors = mypal_topics, y_limit = c(0, 2.5), bar_width = 2)
MyStructurePlot(loadings_matrix = L1[sub_cells,], grouping = so_orig$annotation_level2[sub_cells], topics = c("F152"), colors = mypal_topics, y_limit = c(0, 2.5), bar_width = 2)
MyStructurePlot(loadings_matrix = L1[sub_cells,], grouping = so_orig$annotation_level2[sub_cells], topics = c("F6"), colors = mypal_topics, y_limit = c(0, 3), bar_width = 2)
MyStructurePlot(loadings_matrix = L1[sub_cells,], grouping = so_orig$annotation_level2[sub_cells], topics = c("F80"), colors = mypal_topics, y_limit = c(0, 2.5), bar_width = 2)
dev.off()

##GeneTile plot
pdf(file = sprintf("%s/GeneTilePlot_ActTregG.pdf", fig_dir), 5, 10, useDingbats = F)
MyGeneTilePlot(gene_factor_matrix = F1, topics = c("F27","F12", "F15", "F152","F6", "F80"), n_genes_per_topic = 15,alpha_range = c(0,1), title = "Genes in GP")
MyGeneTilePlot(gene_factor_matrix = F1, topics = c("F27","F12", "F15", "F152","F6", "F80"), n_genes_per_topic = 15, title = "Genes in GP")
dev.off()

###DotPlot of classic genes in association with GP
idx_mat <- apply(F1[,c("F27","F12", "F15", "F152","F6", "F80")], 2, function(col) head(order(col, decreasing = TRUE), 15))
idx_vec <- as.vector(idx_mat)
idx_vec <- unique(as.vector(idx_mat))
top_genes <- rownames(F1)[idx_vec]

so = so_orig[,sub_cells] %>% NormalizeData()

pdf(file = sprintf("%s/DotPlot_ActTregG.pdf", fig_dir), 20, 5, useDingbats = F)
DotPlot(object = so, top_genes, assay = "RNA", group.by = "annotation_level2")  + scale_colour_gradientn(colours =  rev(magma(10))) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
DotPlot(object = so, top_genes, assay = "RNA", group.by = "annotation_level2") + scale_colour_gradientn(colours =  colorRampPalette(c('white','red'))(20)) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
DotPlot(object = so, top_genes, assay = "RNA", group.by = "annotation_level2") + scale_colour_gradientn(colours =  rev(colorRampPalette(brewer.pal(n = 7,name = "RdBu"))(20))) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
dev.off() 

idx_mat <- apply(F1[,c("F27","F12", "F15", "F152","F6", "F80")], 2, function(col) head(order(col, decreasing = TRUE), 15))
p = list()
for (topic in c("F27","F12", "F15", "F152","F6", "F80")) {
    print(topic)
    idx_vec <- as.vector(idx_mat[,topic])
    top_genes <- rownames(F1)[idx_vec]
    # p[[topic]] = DotPlot(object = so, top_genes, assay = "RNA", group.by = "annotation_level2", dot.scale = 6, scale = T, scale.by = "radius")  + 
    #     labs(y = topic, x = NULL) +
    #     scale_colour_gradientn(colours =  colorRampPalette(c('white',mypal_topics[topic]))(10)) + 
    #     theme(axis.text.x = element_text(angle = 45, hjust = 1)) + coord_flip()
    p[[topic]] = MyDotPlot(object = so, top_genes, assay = "RNA", group.by = "annotation_level2", dot.scale = 6, scale = T, scale.by = "radius",point.shape = 21, alpha.range = c(0, 1), show.alpha.legend = F)  + 
    labs(y = topic, x = NULL) +
    scale_fill_gradientn(colours =  colorRampPalette(c("grey",'white',mypal_topics[topic]))(10)) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + coord_flip()

}

stacked = wrap_plots(p, ncol = 1) + plot_layout(axes = "collect_x", guides = "collect")  # collect x-axes & legends
pdf(file = sprintf("%s/GeneTilePlot_ActTregG_stacked.pdf", fig_dir), 5, 18, useDingbats = F)
stacked
dev.off()


MyDotPlot <- function (
        object, features, assay = NULL,
        cols = c("lightgrey","blue"), col.min = -2.5, col.max = 2.5,
        dot.min = 0, dot.scale = 6, idents = NULL, group.by = NULL,
        split.by = NULL, cluster.idents = FALSE, scale = TRUE,
        scale.by = "radius", scale.min = NA, scale.max = NA,
        point.shape = 21,                 # 21 has fill + outline
        alpha.range = c(0.2, 1.0),
        show.alpha.legend = FALSE
) {
    if (!requireNamespace("ggplot2", quietly = TRUE)) stop("Install ggplot2")
    if (!requireNamespace("rlang", quietly = TRUE)) stop("Install rlang")
    
    `%||%` <- Seurat::`%||%`
    assay <- assay %||% Seurat::DefaultAssay(object)
    Seurat::DefaultAssay(object) <- assay
    
    split.colors <- !is.null(split.by) && !any(cols %in% rownames(RColorBrewer::brewer.pal.info))
    scale.func <- switch(scale.by,
                         size   = ggplot2::scale_size,
                         radius = ggplot2::scale_radius,
                         stop("'scale.by' must be either 'size' or 'radius'"))
    
    feature.groups <- NULL
    if (is.list(features) || any(!is.na(names(features)))) {
        feature.groups <- unlist(lapply(seq_along(features), function(i) rep(names(features)[i], length(features[[i]]))))
        if (any(is.na(feature.groups))) warning("Some feature groups are unnamed.", call. = FALSE, immediate. = TRUE)
        features <- unlist(features)
        names(feature.groups) <- features
    }
    
    cells <- unlist(Seurat::CellsByIdentities(object, cells = colnames(object[[assay]]), idents = idents))
    data.features <- Seurat::FetchData(object, vars = features, cells = cells)
    
    data.features$id <- if (is.null(group.by)) Seurat::Idents(object)[cells, drop = TRUE] else object[[group.by, drop = TRUE]][cells, drop = TRUE]
    if (!is.factor(data.features$id)) data.features$id <- factor(data.features$id)
    id.levels <- levels(data.features$id)
    data.features$id <- as.vector(data.features$id)
    
    if (!is.null(split.by)) {
        splits <- Seurat::FetchData(object, vars = split.by)[cells, split.by]
        if (split.colors) {
            if (length(unique(splits)) > length(cols)) stop(sprintf("Need at least %d colors in 'cols'", length(unique(splits))))
            cols <- cols[seq_along(unique(splits))]
            names(cols) <- unique(splits)
        }
        data.features$id <- paste(data.features$id, splits, sep = "_")
        us <- unique(splits)
        id.levels <- paste0(rep(id.levels, each = length(us)), "_", rep(us, times = length(id.levels)))
    }
    
    data.plot <- lapply(unique(data.features$id), function(ident) {
        df <- data.features[data.features$id == ident, 1:(ncol(data.features) - 1), drop = FALSE]
        avg.exp <- apply(df, 2, function(x) mean(expm1(x)))
        pct.exp <- apply(df, 2, Seurat:::PercentAbove, threshold = 0)
        list(avg.exp = avg.exp, pct.exp = pct.exp)
    })
    names(data.plot) <- unique(data.features$id)
    
    if (cluster.idents) {
        mat <- do.call(rbind, lapply(data.plot, unlist))
        mat <- scale(mat)
        id.levels <- id.levels[hclust(dist(mat))$order]
    }
    
    data.plot <- do.call(rbind, lapply(names(data.plot), function(x) {
        d <- as.data.frame(data.plot[[x]])
        d$features.plot <- rownames(d); d$id <- x; d
    }))
    if (!is.null(id.levels)) data.plot$id <- factor(data.plot$id, levels = id.levels)
    
    ngroup <- length(levels(data.plot$id))
    if (ngroup == 1) { scale <- FALSE; warning("Only one identity present; expression values will not be scaled", call. = FALSE, immediate. = TRUE) }
    else if (ngroup < 5 && scale) { warning("Scaling with few groups can be misleading", call. = FALSE, immediate. = TRUE) }
    
    # color-like variable (kept for fill mapping)
    avg.exp.scaled <- sapply(unique(data.plot$features.plot), function(x) {
        v <- data.plot[data.plot$features.plot == x, "avg.exp"]
        if (scale) Seurat:::MinMax(scale(log1p(v)), min = col.min, max = col.max) else log1p(v)
    })
    avg.exp.scaled <- as.vector(t(avg.exp.scaled))
    if (split.colors) avg.exp.scaled <- as.numeric(cut(avg.exp.scaled, breaks = 20))
    data.plot$avg.exp.scaled <- avg.exp.scaled
    
    # alpha driver: per-feature log1p → [0,1]
    avg.exp.alpha <- sapply(unique(data.plot$features.plot), function(x) {
        v <- data.plot[data.plot$features.plot == x, "avg.exp"]; v <- log1p(v); Seurat:::MinMax(v, min = 0, max = 1)
    })
    data.plot$alpha <- as.vector(t(avg.exp.alpha))
    
    data.plot$features.plot <- factor(data.plot$features.plot, levels = features)
    data.plot$pct.exp[data.plot$pct.exp < dot.min] <- NA
    data.plot$pct.exp <- data.plot$pct.exp * 100
    
    if (split.colors) {
        splits.use <- unlist(lapply(data.plot$id, function(x)
            sub(paste0(".*_(", paste(sort(unique(splits), decreasing = TRUE), collapse = "|"), ")$"), "\\1", x)))
        data.plot$colors <- mapply(function(color, value) colorRampPalette(c("grey", color))(20)[value],
                                   color = cols[splits.use], value = avg.exp.scaled)
    }
    
    fill.by <- if (split.colors) "colors" else "avg.exp.scaled"
    
    if (!is.na(scale.min)) data.plot[data.plot$pct.exp < scale.min, "pct.exp"] <- scale.min
    if (!is.na(scale.max)) data.plot[data.plot$pct.exp > scale.max, "pct.exp"] <- scale.max
    if (!is.null(feature.groups)) data.plot$feature.groups <- factor(feature.groups[data.plot$features.plot], levels = unique(feature.groups))
    
    library(ggplot2)
    plot <- ggplot(data.plot, aes(x = .data$features.plot, y = .data$id)) +
        geom_point(
            aes(size = .data$pct.exp,
                fill = .data[[fill.by]],
                alpha = .data$alpha),
            shape = point.shape, colour = "black", stroke = 0.25
        ) +
        scale.func(range = c(0, dot.scale), limits = c(scale.min, scale.max)) +
        scale_alpha(range = alpha.range, limits = c(0, 1)) +
        theme_minimal(base_size = 11) +
        theme(axis.title.x = element_blank(), axis.title.y = element_blank())
    
    if (!is.null(feature.groups)) {
        plot <- plot +
            facet_grid(~feature.groups, scales = "free_x", space = "free_x", switch = "y") +
            theme(panel.spacing = grid::unit(1, "lines"), strip.background = element_blank())
    }
    
    if (split.colors) {
        plot <- plot + scale_fill_identity()
    } else if (length(cols) == 1) {
        plot <- plot + scale_fill_distiller(palette = cols)
    } else if (length(cols) == 2) {
        plot <- plot + scale_fill_gradient(low = cols[1], high = cols[2])
    } else {
        plot <- plot + scale_fill_gradientn(colours = cols)
    }
    
    if (!split.colors) {
        plot <- plot +
            NoGrid()+
            guides(
                fill  = guide_colorbar(title = "Average Expression"),
                size  = guide_legend(title = "Percent Expressed"),
                alpha = if (show.alpha.legend) guide_legend(title = "Avg exp (α)") else "none"
            )
    }
    plot
}

MyDotPlot(
  so, features = top_genes, assay = "RNA",
  group.by = "annotation_level2",
  cols = colorRampPalette(c('white','orange'))(20),#rev(viridisLite::magma(10)),
  point.shape = 21, alpha.range = c(0.5, 1), show.alpha.legend = T
) +coord_flip()



```













