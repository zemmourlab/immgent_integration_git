---
title: "metadata_update.Rmd"
output: html_document
date: "2024-05-29"
---


Most uptodate seurat object
```{r}
# so = readRDS("/project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/Treg/totalvi_igt1_56_allgenes_Treg_20240529_so.Rds")
# so = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241006.Rds")
# so = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241021.Rds")
# so = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241028.Rds")
# so = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241101.Rds")
# so = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241216.Rds")
# so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250109.Rds")
# so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250212.Rds")
# so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250316.Rds")

```

single cell metadata: single_cell_qc.csv
Sample metadata: 
iNKT MAIT by TCR data file: inktInDec24Freeze.csv maitInDec24Freeze.csv
annotation file: annotation_table_20250109.csv
cell cycle file: Prolif_scores.csv
TG by TCR: allTGcells.csv

```{r}
so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250316.Rds")
so = so_orig

so@meta.data = data.frame(cellID = colnames(so))
rownames(so@meta.data) = so$cellID
```

Load original seurat object
```{r}
#IGT1-56 subsets
prefix = "totalvi_igt1_56_20240306_allgenes"
to_subset = "Treg"
so = readRDS(file = sprintf("/project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/%s/bpcells/totalvi_igt1_56_allgenes_%s_20240306_counts/totalvi_igt1_56_allgenes_%s_20240306_BPCells_so.Rds", to_subset, to_subset, to_subset))
# so = readRDS(file = sprintf("~/google_drive/ImmgenT/analysis/data_integration/IGT1_56/%s/bpcells/totalvi_igt1_56_allgenes_%s_20240306_counts/totalvi_igt1_56_allgenes_%s_20240306_BPCells_so.Rds", to_subset, to_subset, to_subset))
so = readRDS("/project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/Treg/totalvi_igt1_56_allgenes_Treg_20240528_so.Rds")
so = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/export_data/igt1_96_20241006_inmemory_diet_seurat.Rds")
```

**Add ADT feature metadata**
```{r}
# metaf = read.table("export_data/citeseq_qc_leon_nov2024.csv", header = T, sep = ",", as.is = T, row.names = 1)
metaf = read.table("export_data/citeseq_qc_20250513.csv", header = T, sep = ",", as.is = T, row.names = 1)
rownames(metaf)[!rownames(metaf) %in% rownames(so@assays$ADT)]
metaf = metaf[match(rownames(so@assays$ADT),rownames(metaf)),]
data.frame(rownames(metaf), rownames(so@assays$ADT), matched = rownames(metaf) == rownames(so@assays$ADT)) %>% arrange(matched)
rownames(metaf) = rownames(so@assays$ADT)
so@assays$ADT@meta.features = metaf
so@assays$ADT@meta.features$IGT1only[is.na(so@assays$ADT@meta.features$IGT1only)] = T
table(so@assays$ADT@meta.features$IGT1only)

```

**Add latent spaces, umaps**
```{r}
dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/totalvi_20241006"

# sprintf("%s_X_SCVI_%s.csv", prefix, prefix2)

AddLatentData = function(so, latent_file, prefix, calculate_umap = F) {
    totalvi = read.csv(file = latent_file, header = T, sep = ",", row.names = 1)
    # pattern = "(IGT\\S*)_(\\d+)"
    # rownames(totalvi) = gsub(pattern, "\\1", rownames(totalvi))
    colnames(totalvi) = as.character(seq(1:ncol(totalvi)))
    #all(rownames(totalvi) == colnames(so))
    totalvi = as.matrix(totalvi)
    pattern = "^IGT\\d{1,2}\\.[A-Z]{16}$"
    matches = grepl(pattern, rownames(totalvi))
    if (!all(matches)) {
        print("updating cell names in csv file, assuming same order as seurat object" )
        #rownames(totalvi) = gsub(pattern = "(\\S*)_(\\d+)", replacement = "\\1", rownames(totalvi))
        rownames(totalvi) = colnames(so)
    }
    totalvi = totalvi[colnames(so),]
    if (all(colnames(so) == rownames(totalvi))) {
        print("all cells ARE in the latent_file")
        so[[prefix]] = CreateDimReducObject(embeddings = totalvi, key = prefix, assay = "RNA") #sprintf("totalvi_%s", prefix2)
        if (calculate_umap == T) {
            so = RunUMAP(so, dims = 1:ncol(totalvi), reduction = prefix, n.components = 2, reduction.name = sprintf("umap_%s", prefix))
        }
        return(so)
    } else {
        print("all cells ARE NOT in the latent_file")
        return(so)
    }
}

so = AddLatentData(so, latent_file = sprintf("%s/latent.csv",dir_with_file), prefix = "totalvi_20241006", calculate_umap = T)
#write.table(so[['umap_totalvi_20241006']]@cell.embeddings, file = sprintf("%s/umap.csv",dir_with_file), quote = F, sep = ",", row.names = T, col.names = T)

so = AddLatentData(so, latent_file = sprintf("%s/latent.csv",dir_with_file), prefix = "totalvi_20241006", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/umap.csv",dir_with_file), prefix = "umap_totalvi_20241006", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/mde.csv",dir_with_file), prefix = "mde_totalvi_20241006", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/mde2.csv",dir_with_file), prefix = "mde2_totalvi_20241006", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/umap_python.csv",dir_with_file), prefix = "umap2_totalvi_20241006", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/umap_mde_aligned.csv",dir_with_file), prefix = "mdeumap_totalvi_20241006", calculate_umap = F)

dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/totalvi_20241008_rmIGTsample"
so = AddLatentData(so, latent_file = sprintf("%s/umap_python.csv",dir_with_file), prefix = "umap_totalvi_20241008_rmIGTsample", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/mde.csv",dir_with_file), prefix = "mde_totalvi_20241008_rmIGTsample", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/mde2.csv",dir_with_file), prefix = "mde2_totalvi_20241008_rmIGTsample", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/umap_mde_aligned.csv",dir_with_file), prefix = "mdeumap_totalvi_20241008_rmIGTsample", calculate_umap = F)
#write.table(so[['umap_totalvi_20241006']]@cell.embeddings, file = sprintf("%s/umap.csv",dir_with_file), quote = F, sep = ",", row.names = T, col.names = T)

dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/totalviv2can"
so = AddLatentData(so, latent_file = sprintf("%s/umap.csv",dir_with_file), prefix = "umap_totalviv2_can", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/mde.csv",dir_with_file), prefix = "mde_totalviv2_can", calculate_umap = F)

dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/totalvi_20241029_fitleredGenesProt"
so = AddLatentData(so, latent_file = sprintf("%s/umap_python.csv",dir_with_file), prefix = "umap_totalvi_20241029_fitleredGenesProt", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/mde2.csv",dir_with_file), prefix = "mde_totalvi_20241029_fitleredGenesProt", calculate_umap = F)

dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/totalvi_20241008_rmIGTsample"
so = AddLatentData(so, latent_file = sprintf("%s/latent.csv",dir_with_file), prefix = "totalvi_20241008_rmIGTsample", calculate_umap = F)
```

Add mde_incremental in the whole object --> only possible in the cleaned version, so do at the end
```{r}
dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/"
so = AddLatentData(so, latent_file = sprintf("%s/20250109_mde_incremental_fromEachLevel1.csv",dir_with_file), prefix = "mde_incremental", calculate_umap = F)

### TO MAKE 20250109_mde_incremental_fromEachLevel1.csv

latent_files = c("CD4/20250109_CD4/mde_incremental.csv",
"CD8AB/20250109_CD8AB/mde_incremental.csv",
"Treg/20250109_Treg/mde_incremental.csv",
"gdT/20250109_gdT/mde_incremental.csv",
"nonconv/20250109_nonconv/mde_incremental.csv",
"abT_CD8aa/20250109_abT_CD8aa/mde_incremental.csv",
"abT_DP/20250109_abT_DP/mde2.csv",
"abT_DN/20250109_abT_DN/mde_incremental.csv")

mde_incremental_list = list()
for (i in 1: length(latent_files)) {
    print(i)
    mde_incremental_list[[i]] = read.csv(file = latent_files[i], header = T, sep = ",", row.names = 1)
}

totalvi = do.call(rbind, mde_incremental_list)
colnames(totalvi) = as.character(seq(1:ncol(totalvi)))

missing_rows = setdiff(colnames(so), rownames(totalvi))
if (length(missing_rows) > 0) {
  na_matrix = matrix(NA, nrow = length(missing_rows), ncol = ncol(totalvi))
  rownames(na_matrix) <- missing_rows
  colnames(na_matrix) <- colnames(totalvi)
  totalvi <- rbind(totalvi, na_matrix)
}
totalvi = totalvi[colnames(so), , drop = FALSE]
totalvi = as.matrix(totalvi)
pattern = "^IGT\\d{1,2}\\.[A-Z]{16}$"
matches = grepl(pattern, rownames(totalvi))
if (!all(matches)) {
    print("updating cell names in csv file, assuming same order as seurat object" )
    #rownames(totalvi) = gsub(pattern = "(\\S*)_(\\d+)", replacement = "\\1", rownames(totalvi))
    rownames(totalvi) = colnames(so)
}
totalvi = totalvi[colnames(so),]
write.table(totalvi, file = "20250109_mde_incremental_fromEachLevel1.csv", sep = ",", row.names = T, quote = F,col.names = T)

```


**1. Add single_cell_qc.csv**
```{r}
scqc = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/export_data/single_cell_qc.csv",header = T, sep = ",")
all(rownames(scqc) == colnames(so))

tmp = merge(so@meta.data, scqc,by.x = "cellID", by.y = "IGT_cellID", all.x = T, all.y = F)
rownames(tmp) = tmp$cellID
tmp = tmp[colnames(so),]
all(rownames(tmp) == colnames(so))
colnames(tmp)
so@meta.data = tmp
head(so@meta.data)
```

**2. Add Clusters e.g. totalvi_20241006/clusters.csv and/or annotations**
```{r}
annot = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD4_activated/totalvi_20241014_CD4_activated_rmIGTsample/Cluster_totalvi_20241014_CD4_activated_rmIGTsample_Res.csv",header = T, sep = ",", row.names = 1)
annot2 = annot[match(colnames(so), rownames(annot)),]
rownames(annot2) = colnames(so)
so@meta.data = data.frame(so@meta.data,annot2)
```

first annotation_level1.csv
first annotation_level2_XX.csv
```{r}
annotl1 = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/annotation_level1.csv",header = F, sep = ",", row.names = 1)
so$annotation_level1 = annotl1[colnames(so),1]

annot = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/annotation_CD4_clusters_l1.csv",header = F, sep = ",", row.names = 1)
so$annotation_CD4_level1 = annot[match(colnames(so), rownames(annot)),1]

annot = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/annotation_level2_CD4.csv",header = F, sep = ",", row.names = 1)
so$annotation_level2_CD4 = annot[match(colnames(so), rownames(annot)),1]

annot = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/annotation_level2_CD8AB.csv",header = F, sep = ",", row.names = 1)
so$annotation_level2_CD8AB = annot[match(colnames(so), rownames(annot)),1]

annot = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/annotation_level2_treg.csv",header = F, sep = ",", row.names = 1)
so$annotation_level2_Treg = annot[match(colnames(so), rownames(annot)),1]

annot = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/annotation_level2_unconventional.csv",header = F, sep = ",", row.names = 1)
so$annotation_level2_unconventional = annot[match(colnames(so), rownames(annot)),1]

annot = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/annotation_level2_miniverse.csv",header = F, sep = ",", row.names = 1)
so$annotation_level2_miniverse = annot[match(colnames(so), rownames(annot)),1]

head(so@meta.data[,grepl("annotation_level2_", colnames(so@meta.data))])

so$annotation_level2 = so@meta.data %>%
  select(starts_with("annotation_level2_")) %>%
  mutate(merged_annotations = coalesce(annotation_level2_CD4, 
                                       annotation_level2_CD8AB, 
                                       annotation_level2_Treg, 
                                       annotation_level2_unconventional,
                                       annotation_level2_miniverse)) %>%
  pull(merged_annotations)

so$annotation_level2[so$annotation_level1 == "thymocyte"] = "thymocyte"
so$annotation_level2[so$annotation_level1 == "nonT"] = "nonT"

library(gtools)
vec = unique(so$annotation_level2)
vec = vec[!vec %in% c("nonT", "thymocyte")]
sorted_vec = mixedsort(vec)
sorted_vec = c(sorted_vec, c("thymocyte", "nonT"))
sorted_vec
so$annotation_level2 = factor(so$annotation_level2, levels = sorted_vec)

table(so$annotation_level1, so$annotation_level2)

```

add annotation_table_20241113.csv
```{r}
so$annotation_level1 = NULL
so$annotation_level2 = NULL
colnames(so@meta.data)[grepl(pattern = "annotation_level", colnames(so@meta.data))]
so@meta.data[,grepl(pattern = "annotation_level", colnames(so@meta.data))] = NULL

annotl1 = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/annotation_table_20241113.csv",header = T, sep = ",")
all(rownames(annotl1) == colnames(so))
colnames(annotl1)
so$annotation_level2_oct24 = annotl1[colnames(so),"annotation_level2"]
so$annotation_level0 = annotl1[colnames(so),"level0"]
so$annotation_level1 = annotl1[colnames(so),"level1"]
so$annotation_level2 = annotl1[colnames(so),"level2"]
so$nonconv_tcr_recog = annotl1[colnames(so),"nonconv_tcr_recog"]

```

add annotation_table_20241201.csv
```{r}
so = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241113.Rds")
so$annotation_level0_20241113 = so$annotation_level0
so$annotation_level0 = NULL
so$annotation_level1_20241113 = so$annotation_level1
so$annotation_level1 = NULL
so$annotation_level2_20241113 = so$annotation_level2
so$annotation_level2 = NULL


annotl1 = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/annotation_table_20241201.csv",header = T, sep = ",", row.names = 1)
all(rownames(annotl1) == colnames(so))
colnames(annotl1)
so$annotation_level1 = annotl1[colnames(so),"level1"]
so$annotation_level2 = annotl1[colnames(so),"level2"]

saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241201.Rds")

```

add annotation_table_20241202.csv
```{r}
so = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241201.Rds")
so_orig = so
so$annotation_level1_20241201 = so$annotation_level1
so$annotation_level1 = NULL
so$annotation_level2_20241201 = so$annotation_level2
so$annotation_level2 = NULL


annotl1 = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/annotation_table_20241202.csv",header = T, sep = ",", row.names = 1)
all(rownames(annotl1) == colnames(so))
colnames(annotl1)
so$annotation_level1 = annotl1[colnames(so),"level1"]
so$annotation_level2 = annotl1[colnames(so),"level2"]

saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241202.Rds")

```

add annotation_table_20241216.csv
```{r}
so = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241202.Rds")
so_orig = so
so$annotation_level1_20241202 = so$annotation_level1
so$annotation_level1 = NULL
so$annotation_level2_20241202 = so$annotation_level2
so$annotation_level2 = NULL

annotl1 = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/annotation_table_20241216.csv",header = T, sep = ",", row.names = 1)
all(rownames(annotl1) == colnames(so))
colnames(annotl1)
so$annotation_level1 = annotl1[colnames(so),"level1"]
so$annotation_level2 = annotl1[colnames(so),"level2"]
so$annotation_level2_parent1 = annotl1[colnames(so),"level2_parent1"]

# Now directly in annotation_table_20241216.csv Add resting, activated
# so$annotation_level2_parent1 = "not_applicable"
# annot$level2_parent1[annot$level2 %in% c("CD4_cl10", "CD4_cl13", "CD4_cl14", "CD4_cl15", "CD4_cl16", "CD4_cl17", "CD4_cl18", "CD4_cl20", "CD4_cl21", "CD4_cl22", "CD4_cl23", "CD4_cl25", "CD4_cl9", "CD8AB_cl10", "CD8AB_cl11", "CD8AB_cl12", "CD8AB_cl13", "CD8AB_cl14", "CD8AB_cl15", "CD8AB_cl18", "CD8AB_cl20", "CD8AB_cl6", "CD8AB_cl7","treg_cl2", "treg_cl3", "treg_cl4", "treg_cl6", "treg_cl8")] = "activated"
# so$annotation_level2_parent1[so$annotation_level2 %in% c("CD4_cl1", "CD4_cl12", "CD4_cl2", "CD4_cl3", "CD4_cl4", "CD4_cl5", "CD4_cl7", "CD8AB_cl1", "CD8AB_cl2", "CD8AB_cl22", "CD8AB_cl4", "CD8AB_cl5","treg_cl1", "treg_cl7")] = "resting"
# so$annotation_level2_parent1[so$annotation_level2 %in% c("CD4_cl8", "CD8AB_cl19", "treg_cl5","not_CD4CD8_cl48")] = "proliferating"
# table(so$annotation_level2_parent1, so$annotation_level2)

annotation_level2_order = so@meta.data %>% 
    select(annotation_level2, annotation_level1, annotation_level2_parent1) %>%
    group_by(annotation_level2, annotation_level1, annotation_level2_parent1) %>% 
    arrange(
        sub("^.*_cl", "", annotation_level2) %>% as.numeric(), # Extract cluster number and convert to numeric
        annotation_level2                                     # Keep cluster prefix order (CD4, treg, etc.)
    ) %>% 
    arrange(annotation_level1) %>%
    pull(annotation_level2) %>% 
    unique() %>%
    as.character()

so$annotation_level2 = factor(so$annotation_level2, levels = annotation_level2_order)
any(is.na(so$annotation_level2))

so$annotation_level2.IGTHT = paste(so$annotation_level2, so$IGTHT, sep = ".")

saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241216.Rds")


```

add annotation_table_20250109_withlevel220241216.csv
```{r}
so = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241216.Rds")
so_orig = so
so$annotation_level1_20241216 = so$annotation_level1
so$annotation_level1 = NULL
so$annotation_level2_20241216 = so$annotation_level2
so$annotation_level2 = NULL
so$annotation_level2_parent1_20241216 = so$annotation_level2_parent1
so$annotation_level2_parent1 = NULL
so$annotation_level2.IGTHT = NULL

annotl1 = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/annotation_table_20250109_withlevel220241216.csv",header = T, sep = ",", row.names = 1)
all(rownames(annotl1) == colnames(so))
colnames(annotl1)
so$annotation_level1 = annotl1[colnames(so),"level1"]
so$annotation_level2 = annotl1[colnames(so),"level2"]
so$annotation_level2_parent1 = annotl1[colnames(so),"level2_parent1"]

saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250109.Rds")


```

add annotation_table_20250109.csv
```{r}
# so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250109_level1only.Rds")
# so = so_orig

so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241216.Rds")
so = so_orig
so$annotation_level1_20241216 = so$annotation_level1
so$annotation_level1 = NULL
so$annotation_level2_20241216 = so$annotation_level2
so$annotation_level2 = NULL
so$annotation_level2_parent1_20241216 = so$annotation_level2_parent1
so$annotation_level2_parent1 = NULL
so$annotation_level2.IGTHT = NULL

# Now directly in annotation_table_2050109.csv but if needed: double check before using
# so$annotation_level2_parent1 = "not_applicable"
# annot$level2_parent1[annot$level2 %in% c("CD4_cl10", "CD4_cl13", "CD4_cl14", "CD4_cl15", "CD4_cl16", "CD4_cl17", "CD4_cl18", "CD4_cl20", "CD4_cl21", "CD4_cl22", "CD4_cl23", "CD4_cl25", "CD4_cl9", "CD4_cl28", "CD8AB_cl10", "CD8AB_cl11", "CD8AB_cl12", "CD8AB_cl13", "CD8AB_cl14", "CD8AB_cl15", "CD8AB_cl18", "CD8AB_cl20", "CD8AB_cl6", "CD8AB_cl7","CD8AB_cl25", "CD8AB_cl26","CD8AB_cl28","treg_cl2", "treg_cl3", "treg_cl4", "treg_cl6", "treg_cl8")] = "activated"
# so$annotation_level2_parent1[so$annotation_level2 %in% c("CD4_cl1", "CD4_cl12", "CD4_cl2", "CD4_cl3", "CD4_cl4", "CD4_cl5", "CD4_cl7", "CD8AB_cl1", "CD8AB_cl2", "CD8AB_cl22", "CD8AB_cl4", "CD8AB_cl5","CD8AB_cl27","treg_cl1", "treg_cl7")] = "resting"
# so$annotation_level2_parent1[so$annotation_level2 %in% c("CD4_cl8", "CD8AB_cl19", "treg_cl5","not_CD4CD8_cl48", "gdT_prolif", "CD4_prolif", "CD8AB_prolif")] = "proliferating"
# table(so$annotation_level2_parent1, so$annotation_level2)

annotl1 = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/annotation_table_20250109.csv",header = T, sep = ",", row.names = 1)
all(rownames(annotl1) == colnames(so))
colnames(annotl1)
so$annotation_level1 = annotl1[colnames(so),"level1"]
so$annotation_level2 = annotl1[colnames(so),"level2"]
so$annotation_level2_parent1 = annotl1[colnames(so),"level2_parent1"]

table(so$annotation_level1_20241216, so$annotation_level1)

# annotation_level2_order = so@meta.data %>%
#     select(annotation_level2, annotation_level1, annotation_level2_parent1) %>%
#     group_by(annotation_level2, annotation_level1, annotation_level2_parent1) %>%
#     arrange(
#         sub("^.*_cl", "", annotation_level2) %>% as.numeric(), # Extract cluster number and convert to numeric
#         annotation_level2                                     # Keep cluster prefix order (CD4, treg, etc.)
#     ) %>%
#     arrange(annotation_level1) %>%
#     pull(annotation_level2) %>%
#     unique() %>%
#     as.character()

annotation_level2_order = so@meta.data %>%
    select(annotation_level2, annotation_level1, annotation_level2_parent1) %>%
    group_by(annotation_level2, annotation_level1, annotation_level2_parent1) %>%
    mutate(
        cluster_num = as.numeric(ifelse(grepl("_cl\\d+$", annotation_level2), sub("^.*_cl", "", annotation_level2), NA))  # Extract cluster number and convert to numeric
    ) %>%
    arrange(annotation_level1, cluster_num, annotation_level2) %>% 
    pull(annotation_level2) %>%
    unique() %>%
    as.character()

test = factor(so$annotation_level2, levels = annotation_level2_order)
any(is.na(test))

so$annotation_level2 = factor(so$annotation_level2, levels = annotation_level2_order)
any(is.na(so$annotation_level2))

so$annotation_level2.IGTHT = paste(so$annotation_level2, so$IGTHT, sep = ".")

saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250109.Rds")


```
```{r}
# so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250109.Rds")
# so = so_orig
so$annotation_level1 = NULL
so$annotation_level2 = NULL
so$annotation_level2_parent1 = NULL
so$annotation_level2.IGTHT = NULL

annotl1 = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/annotation_table_20250109.csv",header = T, sep = ",", row.names = 1)
all(rownames(annotl1) == colnames(so))
colnames(annotl1)
so$annotation_level1 = annotl1[colnames(so),"level1"]
so$annotation_level2 = annotl1[colnames(so),"level2"]
so$annotation_level2_group = annotl1[colnames(so),"level2.group"]

so$annotation_level2_group[grepl("miniverse",so$annotation_level2 )] = "miniverse"
so$annotation_level2_group[grepl("prolif",so$annotation_level2 )] = "proliferating"
so$annotation_level2_group[grepl("unclear",so$annotation_level2 )] = "other"
so$annotation_level2_group[is.na(so$annotation_level2_group)] = "other"

annotation_level2_order = so@meta.data %>%
    select(annotation_level2, annotation_level1, annotation_level2_group) %>%
    group_by(annotation_level2, annotation_level1, annotation_level2_group) %>%
    mutate(
        cluster_num = as.numeric(ifelse(grepl("_cl\\d+$", annotation_level2), sub("^.*_cl", "", annotation_level2), NA))  # Extract cluster number and convert to numeric
    ) %>%
    arrange(annotation_level1, cluster_num, annotation_level2) %>% 
    pull(annotation_level2) %>%
    unique() %>%
    as.character()

test = factor(so$annotation_level2, levels = annotation_level2_order)
any(is.na(test))

so$annotation_level2 = factor(so$annotation_level2, levels = annotation_level2_order)
any(is.na(so$annotation_level2))

so$annotation_level2.IGTHT = paste(so$annotation_level2, so$IGTHT, sep = ".")

# saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250109.Rds")

# so_orig = so
# so$annotation_level2 = as.character(so$annotation_level2)
# so$annotation_level2[so$annotation_level2 == "DNcl29"] = "DN_cl29"

```

add annotation_table_history_20250226.csv
```{r}
# so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250109.Rds")
# so = so_orig
# so$annotation_level1 = NULL
# so$annotation_level2 = NULL
# so$annotation_level2_parent1 = NULL
# so$annotation_level2.IGTHT = NULL

annotl1 = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/annotation_table_20250226.csv",header = T, sep = ",", row.names = 1)
all(rownames(annotl1) == colnames(so))
colnames(annotl1)
so$annotation_level1 = annotl1[colnames(so),"level1"]
so$annotation_level2 = annotl1[colnames(so),"level2"]
so$annotation_level2_group = annotl1[colnames(so),"level2.group"]

so$annotation_level2_group[grepl("miniverse",so$annotation_level2 )] = "miniverse"
so$annotation_level2_group[grepl("prolif",so$annotation_level2 )] = "proliferating"
so$annotation_level2_group[grepl("unclear",so$annotation_level2 )] = "other"
so$annotation_level2_group[is.na(so$annotation_level2_group)] = "other"

annotation_level2_order = so@meta.data %>%
    select(annotation_level2, annotation_level1, annotation_level2_group) %>%
    group_by(annotation_level2, annotation_level1, annotation_level2_group) %>%
    mutate(
        cluster_num = as.numeric(ifelse(grepl("_cl\\d+$", annotation_level2), sub("^.*_cl", "", annotation_level2), NA))  # Extract cluster number and convert to numeric
    ) %>%
    arrange(annotation_level1, cluster_num, annotation_level2) %>% 
    pull(annotation_level2) %>%
    unique() %>%
    as.character()

test = factor(so$annotation_level2, levels = annotation_level2_order)
any(is.na(test))

so$annotation_level2 = factor(so$annotation_level2, levels = annotation_level2_order)
any(is.na(so$annotation_level2))

so$annotation_level2.IGTHT = paste(so$annotation_level2, so$IGTHT, sep = ".")

# saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250109.Rds")

# so_orig = so
# so$annotation_level2 = as.character(so$annotation_level2)
# so$annotation_level2[so$annotation_level2 == "DNcl29"] = "DN_cl29"

```


**3. Add proliferation scores**

```{r}
cc_scores = read.table(file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Prolif_scores.csv", header = T, sep = ",", row.names = 1)
cc_scores = cc_scores[colnames(so),]
all(rownames(cc_scores) == colnames(so))

so$S.Score = cc_scores$S.Score
so$G2M.Score = cc_scores$G2M.Score

```



(add annotation_table_20241203.csv FORGET! )
```{r}
so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241202.Rds")
so = so_orig
so$annotation_level1_20241202 = so$annotation_level1
so$annotation_level1 = NULL
so$annotation_level2_20241202 = so$annotation_level2
so$annotation_level2 = NULL


annotl1 = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/annotation_table_20241203.csv",header = T, sep = ",", row.names = 1)
all(rownames(annotl1) == colnames(so))
colnames(annotl1)
so$annotation_level1 = annotl1[colnames(so),"level1"]
so$annotation_level2 = annotl1[colnames(so),"level2"]

saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241203.Rds")

```



**4.update the sample metadata**
Load metadata csv file
```{r}
#m = read.table("/project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/Sample_metadata_david_20240324_v3.csv",header = T, sep = ",")
#m = read.table("/project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/Sample_metadata_david_20240520_v5.csv",header = T, sep = ",")
# m = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/export_data/Sample_metadata_david_20240920_v6.csv",header = T, sep = ",")
# m = read.table("/project/zemmour/david/ImmgenT/exp_id/IGT1_96_sample_metadata.csv",header = T, sep = ",", row.names = 1)
# m = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/export_data/Sample_metadata_david_20250124_v7.csv",header = T, sep = ",")
# m = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/export_data/Sample_metadata_david_20250226_v8.csv",header = T, sep = ",")
# m = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/export_data/Sample_metadata_david_20250311_v8.csv",header = T, sep = ",")
# m = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/export_data/Sample_metadata_david_20250317_v8.csv",header = T, sep = ",")
m = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/export_data/Sample_metadata_david_20250419_v9.csv",header = T, sep = ",")

# changing here and not in the original file to keep consistent with the database
colnames(m)
m$IGT_10xlane_id = NULL
m$organism_id = NULL
m$IGT = m$immgent_IGT_10xlane_id
m$immgent_IGT_10xlane_id = NULL
m$HT = m$hashtag_number
m$hashtag_number = NULL
m$sample_id = NULL
m$count_unique = NULL
m$sample_code.1 = NULL

colnames(m)
```

code version with V7+, easier
```{r}
tmp = merge(so@meta.data, m, by = "IGTHT", all.x = T, all.y = F)
rownames(tmp) = tmp$cellID
tmp = tmp[colnames(so),]
all(rownames(tmp) == colnames(so))
colnames(tmp)
tmp$count_unique = NULL
so@meta.data = tmp

#Any missing data in sample_metadata?
tmp$IGT[which(is.na(tmp$exp_number))] %>% unique()
tmp$IGTHT[which(is.na(tmp$exp_number))] %>% unique()
any(apply(tmp,2, function(x) any(is.na(x))))

all(rownames(tmp) == colnames(so))
tmp = tmp[rownames(so@meta.data),]
all(rownames(tmp) == colnames(so))

so@meta.data = tmp
head(so@meta.data)
```

Some other code, if needed
```{r}

#Remove unwanted columns in Sample_metadata csv
m$ht_number = NULL
m$igt_number = NULL
m$count_unique = NULL

#not needed in V7
m$IGTHT = paste(m$immgent_IGT_10xlane_id, m$hashtag_number, sep = "")
m$IGTHT = gsub(pattern = "IGT", replacement = "I", x = m$IGTHT)
m$IGTHT = gsub(pattern = "HT", replacement = "H", x = m$IGTHT)

#not needed in V7
m$cite_seq = T
m$cite_seq[m$IGT %in% sprintf("IGT%s",c(7,8,9,44,45,46,73,85,90,91,92))] = F

#m$sample_id = paste(m$immgent_IGT_10xlane_id, m$hashtag_number, sep = ".")
#so$sample_id = paste(so$IGT, so$hashtag_number, sep = ".")

someta = so@meta.data
colnames(someta)
someta$cell_barcode = NULL
someta$seurat_clusters = NULL
someta$IGTHT = someta$IGT.HT
someta$IGTHT = gsub(x = someta$IGTHT, pattern = "\\.", replacement = "")
someta$IGT.HT = NULL
colnames(someta)[!(colnames(someta) %in% colnames(m) & !(colnames(someta) %in% c("sample_id", "hashtag_number", "IGTHT")))]
colnames(someta)[!(colnames(someta) %in% colnames(m) & !(colnames(someta) %in% c("IGTHT"))) | !colnames(someta) %in% c("Cell_ID", "is_spleen_standard", "B6J_shipped_from_JAX", "timepoint_days", "sample_name_david", "is_spleen_healthy", "is_spleen_healthy_igt", "infection_days", "treat_mode", "tumor_days")]
someta = someta[, !(colnames(someta) %in% colnames(m) & !(colnames(someta) %in% c("sample_id", "hashtag_number", "IGTHT")))]
m2 = merge(someta, m, by  = "IGTHT", all.x = T)
#m2 = merge(someta, m, by  = "sample_id", all.x = T)
#Any missing data in sample_metadata?
m2$IGT[which(is.na(m2$exp_number))] %>% unique()
m2$IGTHT[which(is.na(m2$exp_number))] %>% unique()
table(m2$is_spleen_standard[which(is.na(m2$exp_number))]) #missing metadata about spleen standards!!
m2$colnames[which(is.na(m2$exp_number))]

all(m2$colnames %in% rownames(so@meta.data))
rownames(m2) = m2$colnames
m2 = m2[rownames(so@meta.data),]
all(m2$colnames %in% rownames(so@meta.data))

so@meta.data = m2

#Adjust colnames(so) if it was modified when merged
message("check colnames to be IGT.BARCODE")
pattern = "^IGT\\d{1,2}\\.[A-Z]{16}$"
matches = grepl(pattern, colnames(so))
all(matches)
#and adjust colnames if needed:
unique(so$IGT[which(matches == F)])
#Adjust colnames(so) 
#pattern = "(IGT\\S*)_(\\d+)"
so$colnames = colnames(so)
sample(colnames(so), 100)
pattern = "(\\S*)_(\\d+)"
so$colnames = gsub(pattern, "\\1", so$colnames) #remove the _1 or other number at the end
sample(so$colnames, 100)
unique(so$IGT[!grepl("^IGT", so$colnames)])
so$colnames[!grepl("^IGT", so$colnames)] = paste(so$IGT[!grepl("^IGT", so$colnames)], so$colnames[!grepl("^IGT", so$colnames)], sep = ".")
sample(so$colnames, 10)
any(duplicated(so$colnames))
#recheck
pattern = "^IGT\\d{1,2}\\.[A-Z]{16}$"
matches = grepl(pattern, so$colnames)
all(matches)
#so@meta.data[which(matches == F),]
if(all(matches)) {colnames(so) = so$colnames}
all(grepl(pattern, colnames(so)))

#remove duplicated columns
removeDuplicateColumns <- function(df) {
    # Determine unique columns by comparing all pairs
    uniqueCols <- !duplicated(as.list(df))
    # Subset dataframe to keep only unique columns
    dfUnique <- df[, uniqueCols]
    print(colnames(df)[!uniqueCols])
    return(dfUnique)
}

df = so@meta.data
dim(df)
df2 = removeDuplicateColumns(df)
dim(df2) 
#removes usually immgent_IGT_10xlane_id,hashtag_number.y,tumor,tumor_days,X: empty of repeated

so@meta.data = removeDuplicateColumns(so@meta.data)

#Remove some columns
colnames(so@meta.data)[grepl("^Cluster", colnames(so@meta.data ))]
so@meta.data[,grepl("^Cluster", colnames(so@meta.data ))] = NULL
any(is.na(so$IGT))
so$immgent_IGT_10xlane_id  = NULL

#remove .x or .y at the end of any colnames
colnames(so@meta.data)[grepl("\\.x|\\.y",colnames(so@meta.data))]
which(is.na(so$hashtag_number.x))
which(is.na(so$hashtag_number.y)) #NA because not in the metadata file
so$hashtag_number.y = NULL
colnames(so@meta.data) = gsub("\\.x$|\\.y$","", colnames(so@meta.data))

#add sample_id: IGT.HT. Now in sample_name_david in the metadata file
#so$sample_id_david = paste(so$IGT, so$hashtag_number.x, sep = ".")
#so$IGTHT = paste(so$IGT, so$hashtag_number.x, sep = "")

#order IGT
unique(so$IGT)
extract_numeric = function(x) {
  as.numeric(gsub("\\D", "", x))
}
ordered_vector = unique(so$IGT)[order(extract_numeric(unique(so$IGT)))] %>% as.character()
so$IGT = factor(so$IGT, levels = ordered_vector)

#annotate spleen control samples, if missing: should not be necessary anymore
#so$organ[is.na(so$organ)] = "spleen"
#so$condition_broad[is.na(so$condition_broad)] = "healthy"

#organ_simplified
so$organ_simplified = so$organ
so$organ_simplified[grep(pattern = "lymph node", so$organ)] = "LN"
so$organ_simplified[grep(pattern = "skin|Skin", so$organ)] = "skin"
so$organ_simplified[grep(pattern = "colon", so$organ)] = "colon"
so$organ_simplified[grep(pattern = "duoden|ileal|ileum|jejun|small intestine", so$organ)] = "small intestine"
so$organ_simplified[so$organ_simplified %in% c("CNS", "brain")] = "CNS"
so$organ_simplified[so$organ_simplified %in% c("lamina propria", "gut")] = "small intestine"
so$organ_simplified[grep(pattern = "salivary|submandibular", so$organ_simplified)] = "submandibular salivary gland"
table(so$organ, so$organ_simplified)

#add is_spleen_healthy (spleen control)
so$is_spleen_healthy = F
so$is_spleen_healthy[so$organ == "spleen" & so$condition_broad == "healthy"] = T
so$is_spleen_healthy_igt = so$is_spleen_healthy
so$is_spleen_healthy_igt[so$is_spleen_healthy == T] = as.character(so$IGT[so$is_spleen_healthy == T])
#table(so$is_spleen_healthy, so$is_spleen_standard)

```

**5.Add iNKT and MAIT info**
```{r}
nkt = read.table(file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/TCR/inktInDec24Freeze.csv", sep = ",", row.names = 1, header = T, as.is = T)
so$iNKT = colnames(so) %in% rownames(nkt)
table(so$iNKT)

mait = read.table(file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/TCR/maitInDec24Freeze.csv", sep = ",", row.names = 1, header = T, as.is = T)
so$MAIT = colnames(so) %in% rownames(mait)
table(so$MAIT)

```

**6.Add trangenic**
```{r}

tg = read.table(file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/TCR/transgenic_tetramer_cells/antigen_specific_cells.tsv", sep = "\t", header = T, as.is = T)
tmp = merge(so@meta.data, tg, by = "cellID", all.x = T, all.y = F)
rownames(tmp) = tmp$cellID
all(rownames(tmp) == colnames(so))
tmp = tmp[rownames(so@meta.data),]
all(rownames(tmp) == colnames(so))

so@meta.data = tmp
head(so@meta.data)

#####
tg = read.table(file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/TCR/allTGcells.csv", sep = ",", header = T, as.is = T)
rownames(tg) = tg$cellID
so$transgenic_byTCR = NA
# all(colnames(so) == tg$cellID[match(colnames(so),tg$cellID)])
so$transgenic_byTCR = tg$TG[match(colnames(so),tg$cellID)]
all(so$transgenic_byTCR[tg$cellID] == tg$TG)

```

**7. Identify spleen standard**
```{r}
so$spleen_standard = so$organ_simplified == "spleen" & so$jax == T & so$condition_broad == "healthy" & so$age_weeks >= 6 & so$age_weeks <= 8 & so$target_cells_simplified %in% c("allT", "CD45p")
# so@meta.data %>% filter(spleen_standard == T) %>% select(IGTHT, sample_code) %>% unique() %>% write.table(file = "export_data/spleen_standard_samples.txt", row.names = F, col.names = T, quote = F, sep = "\t")
```

**Remove unwanted dimensional reductions**
```{r}
so[["umap_totalvi_20241006"]] = NULL
so[["mde_totalvi_20241006"]] = NULL
so[["umap2_totalvi_20241006"]] = NULL
so[["mdeumap_totalvi_20241006"]] = NULL
so[["umap_totalvi_20241008_rmIGTsample"]] = NULL
so[["mde_totalvi_20241008_rmIGTsample"]] = NULL
so[["mde2_totalvi_20241008_rmIGTsample"]] = NULL
so[["mdeumap_totalvi_20241008_rmIGTsample"]] = NULL
so[["mde_totalvi_20241029_fitleredGenesProt"]] = NULL
so[["umap_totalvi_20241029_fitleredGenesProt"]] = NULL
```


**9. Save**
```{r}
DefaultAssay(so) = "ADT"
so[['RNA']]$data = NULL
DefaultAssay(so) = "RNA"
so[['ADT']]$data = NULL
# saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241113.Rds")
# saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241201.Rds")
# saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250212.Rds")
# saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250226.Rds")
# saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250316.Rds")
# saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250317.Rds")
saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250513.Rds")

```

**10. Save clean version**

```{r}
so = so[,!so$annotation_level1 %in% c("unclear", "nonT", "remove")]

dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/"
so = AddLatentData(so, latent_file = sprintf("%s/20250109_mde_incremental_fromEachLevel1.csv",dir_with_file), prefix = "mde_incremental", calculate_umap = F)

# saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250316_clean.Rds")
# saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250317_clean.Rds")
saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250513_clean.Rds")

```

**Save version with CITEseq only**
```{r}
DefaultAssay(so) = "ADT"
so[['RNA']] = NULL

saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250513_clean_ADTonly.Rds")
```



**if needed, small adjustments**
```{r}
so$cite_seq = T
so$cite_seq[so$IGT %in% sprintf("IGT%s",c(7,8,9,44,45,46,73,85,90,91,92))] = F

igtht_thymus = read.table("IGTHT_thymus_samples.csv", header = F, sep = ",")
so$organ[so$IGTHT %in% igtht_thymus[,1]] = "thymus"
so$organ_simplified[so$IGTHT %in% igtht_thymus[,1]] = "thymus"

saveRDS(so,"/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241006.Rds")
```


**Split by cell types, add latent space**
```{r}
AddLatentData = function(so, latent_file, prefix, calculate_umap = F) {
    totalvi = read.csv(file = latent_file, header = T, sep = ",", row.names = 1)
    # pattern = "(IGT\\S*)_(\\d+)"
    # rownames(totalvi) = gsub(pattern, "\\1", rownames(totalvi))
    colnames(totalvi) = as.character(seq(1:ncol(totalvi)))
    #all(rownames(totalvi) == colnames(so))
    totalvi = as.matrix(totalvi)
    pattern = "^IGT\\d{1,2}\\.[A-Z]{16}$"
    matches = grepl(pattern, rownames(totalvi))
    if (!all(matches)) {
        print("updating cell names in csv file, assuming same order as seurat object" )
        #rownames(totalvi) = gsub(pattern = "(\\S*)_(\\d+)", replacement = "\\1", rownames(totalvi))
        rownames(totalvi) = colnames(so)
    }
    totalvi = totalvi[colnames(so),]
    if (all(colnames(so) == rownames(totalvi))) {
        print("all cells ARE in the latent_file")
        so[[prefix]] = CreateDimReducObject(embeddings = totalvi, key = prefix, assay = "RNA") #sprintf("totalvi_%s", prefix2)
        if (calculate_umap == T) {
            so = RunUMAP(so, dims = 1:ncol(totalvi), reduction = prefix, n.components = 2, reduction.name = sprintf("umap_%s", prefix))
        }
        return(so)
    } else {
        print("all cells ARE NOT in the latent_file")
        return(so)
    }
}

# cd4 = so[,so$annotation_level1 == "CD4"]
so = readRDS("CD4/igt1_96_CD4_20241028_so.Rds")
dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD4/totalvi_20241014_CD4_rmIGTsample"
so = AddLatentData(so, latent_file = sprintf("%s/latent.csv",dir_with_file), prefix = "totalvi_20241014_CD4_rmIGTsample", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/mde2.csv",dir_with_file), prefix = "mde_totalvi_20241014_CD4_rmIGTsample", calculate_umap = F)
saveRDS(so, "CD4/igt1_96_CD4_20241029_so.Rds")

# cd8 = so[,so$annotation_level1 == "CD8AB"]
so = readRDS("CD8AB/igt1_96_CD8AB_20241028_so.Rds")
dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD8AB/totalvi_20241014_CD8AB_rmIGTsample"
so = AddLatentData(so, latent_file = sprintf("%s/latent.csv",dir_with_file), prefix = "totalvi_20241014_CD8AB_rmIGTsample", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/mde2.csv",dir_with_file), prefix = "mde_totalvi_20241014_CD8AB_rmIGTsample", calculate_umap = F)
saveRDS(so, "CD8AB/igt1_96_CD8AB_20241029_so.Rds")

# treg = so[,so$annotation_level1 == "Treg"]
so = readRDS("Treg/igt1_96_Treg_20241028_so.Rds")
dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg/totalvi_20241014_Treg_rmIGTsample"
so = AddLatentData(so, latent_file = sprintf("%s/latent.csv",dir_with_file), prefix = "totalvi_20241014_Treg_rmIGTsample", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/mde2.csv",dir_with_file), prefix = "mde_totalvi_20241014_Treg_rmIGTsample", calculate_umap = F)
saveRDS(so, "Treg/igt1_96_Treg_20241029_so.Rds")

unconv = so[,so$annotation_level1 == "unconventional"]
# so = readRDS("unconventional/igt1_96_unconventional_20241028_so.Rds")
dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/unconventional/totalvi_20241014_unconventional_rmIGTsample"
unconv = AddLatentData(unconv, latent_file = sprintf("%s/latent.csv",dir_with_file), prefix = "totalvi_20241014_unconventional_rmIGTsample", calculate_umap = F)
unconv = AddLatentData(unconv, latent_file = sprintf("%s/mde2.csv",dir_with_file), prefix = "mde_totalvi_20241014_unconventional_rmIGTsample", calculate_umap = F)
saveRDS(unconv, "unconventional/igt1_96_unconventional_20241029_so.Rds")

```


**For python**

```{python}
mdata = mu.read("totalvi_igt1_56_allgenes_Treg_20240525_igtsampleregressedout/mdata.h5mu")
```

Update cell names
```{python}
import re
import pandas as pd
import numpy as np

# Assuming `mdata` is your MuData object and `so` is the relevant part of the MuData object

# Check column names pattern
pattern = r"^IGT\d{1,2}\.[A-Z]{16}$"
obs_names = pd.Series(mdata.mod['RNA'].obs_names, index=mdata.mod['RNA'].obs.index)  # Ensure alignment
matches = obs_names.str.match(pattern)
print("All columns match the pattern:", matches.all())

# Adjust column names if needed
non_matching_IGTs = mdata.mod['RNA'].obs.loc[matches.values == False, 'IGT'].unique()
print("Unique IGT values for non-matching columns:", non_matching_IGTs)

# Save original column names
mdata.obs['colnames'] = obs_names

# Sample 100 column names
print("Sample 100 column names before adjustment:", np.random.choice(obs_names, 100))

# Remove trailing numbers after underscore
pattern = r"(\S*)_(\d+)"
adjusted_colnames = obs_names.str.replace(pattern, r"\1", regex=True)
mdata.obs['colnames'] = adjusted_colnames

# Sample 100 column names after adjustment
print("Sample 100 column names after adjustment:", np.random.choice(adjusted_colnames, 100))

# Add IGT prefix to columns that don't start with IGT
non_IGT_mask = ~mdata.obs['colnames'].str.startswith("IGT")
mdata.obs.loc[non_IGT_mask, 'colnames'] = (
    mdata.mod['RNA'].obs.loc[non_IGT_mask, 'IGT'].astype(str) + '.' + mdata.obs.loc[non_IGT_mask, 'colnames']
)

# Sample 10 column names after prefix adjustment
print("Sample 10 column names after prefix adjustment:", np.random.choice(mdata.obs['colnames'], 100))

# Check for duplicates
duplicates_exist = mdata.obs['colnames'].duplicated().any()
print("Any duplicated column names:", duplicates_exist)

# Recheck the pattern match after adjustments
pattern = r"^IGT\d{1,2}\.[A-Z]{16}$"
matches = mdata.obs['colnames'].str.match(pattern)
print("All columns match the pattern after adjustment:", matches.all())

# Set adjusted colnames as column names if all match
if matches.all():
    mdata.mod['RNA'].obs_names = mdata.obs['colnames'].values
    mdata.mod['protein'].obs_names = mdata.obs['colnames'].values
    
# Final check
all_match_final = pd.Series(mdata.mod['RNA'].obs_names).str.match(pattern).all()
print("All final column names match the pattern:", all_match_final)

```

add metadata
```{python}

m = pd.read_csv('/project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/Sample_metadata_david_20240520_v5.csv')
m.columns
m['sample_id'] = m['sample_id_david']
m = m.drop(columns=['sample_id_david'])
#m
#mdata.mod['RNA'].obs['sample_id'] = mdata.mod['RNA'].obs['IGT'].astype(str) + '.' + mdata.mod['RNA'].obs['hashtag_number'].astype(str)
mdata.mod['RNA'].obs['sample_id'] = mdata.mod['RNA'].obs['IGT'].astype(str) + '' + mdata.mod['RNA'].obs['hashtag_number'].astype(str)
meta = mdata.mod['RNA'].obs

cols_to_keep = ['sample_id'] + list(set(meta.columns) - set(m.columns) - set(['encapsulation_date', 'exp_id', 'IGT','sample_name.1','encapsulated_cell_number','is_spleen_standard'])) 
meta = meta[cols_to_keep]
m2 = pd.merge(meta, m, on='sample_id', how='left')
m2.shape
m2[m2['exp_number'].isna()].shape
#print(m2[m2['exp_number'].isna()]['sample_id']) 
#print(m2[m2['exp_number'].isna()]['is_spleen_standard']) 
# m2[m2['exp_number'].isna()]['organ'] = 'spleen'
# m2[m2['exp_number'].isna()]['condition_broad'] = 'healthy'

(m2['colnames'].values == mdata.mod['RNA'].obs.index.to_list()).all()
#set(m2['colnames']) == set(mdata.mod['RNA'].obs.index)
# m2.index = m2['colnames']
# m2 = m2.reindex(mdata.mod['RNA'].obs.index, axis=0)
# (m2['colnames'].values == mdata.mod['RNA'].obs.index.to_list()).all()

m2['IGT'] = m2['immgent_IGT_10xlane_id']
m2 = m2.drop(columns=['immgent_IGT_10xlane_id'])

m2.index = meta.index

mdata.mod['RNA'].obs = m2

#simplify the organ columns
mdata.mod["RNA"].obs["organ_simplified"] = mdata.mod['RNA'].obs['organ']
list(mdata.mod["RNA"].obs["organ_simplified"].unique())
mdata.mod["RNA"].obs["organ_simplified"] = mdata.mod["RNA"].obs["organ_simplified"].astype('object')
list(mdata.mod["RNA"].obs["organ_simplified"].unique())
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ'].str.contains('lymph node|LN', na=False, case=False), 'organ_simplified'] = 'lymph node'
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ'].str.contains('skin', na=False, case=False), 'organ_simplified'] = 'skin'
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ'].str.contains('colon', na=False, case=False), 'organ_simplified'] = 'colon'
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ'].str.contains('duoden|ileal|ileum|jejun|small intestine', na=False, case=False), 'organ_simplified'] = 'small intestine'
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ_simplified'].isna(), 'organ_simplified'] = 'spleen'
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ_simplified'].isna(), 'condition_broad'] = 'healthy'
mdata.mod["RNA"].obs["organ_simplified"] = mdata.mod["RNA"].obs["organ_simplified"].str.replace('[^0-9a-zA-Z]', '.', regex=True)
list(mdata.mod["RNA"].obs["organ_simplified"].unique())
mdata.mod["RNA"].obs["organ_simplified"] = mdata.mod["RNA"].obs["organ_simplified"].astype('category')

for mod_key in mdata.mod.keys():
    # Convert all columns in .obs to string type to avoid error in writing
    mdata.mod[mod_key].obs = mdata.mod[mod_key].obs.astype(str)
    
# sample_id_equal = mdata.mod['RNA'].obs["sample_id"].values == mdata.mod['RNA'].obs["sample_id"].values
# false_indices = np.where(sample_id_equal == False)[0]
# different_rows = mdata.mod['RNA'].obs.iloc[false_indices]
# print(different_rows[['sample_id', 'sample_id']])
# del mdata.mod['RNA'].obs["sample_id_david"]

```

```{python}
mdata.write_h5mu("mdata_Sample_metadata_david_20240520_v5.h5mu")
```




