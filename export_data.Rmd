---
title: "export_data"
output: html_document
date: "2024-03-30"
author: "David Zemmour"
editor_options: 
  chunk_output_type: console
---

README file in the export_data folder

Data export from 2024/03/30
IGT1-56
code for data export on github immgent_integration_git/export_data.Rmd

Each IGT represents a 10x lane (typically one experiment) and contains several samples (typically 10 different, with different hashtags)

Sample metadata is in Sample_metadata_david_20240324_v3.csv (sampleID is in the column sample_id_david, with format <IGTXX.HTXX> IGT from immgent_IGT_10xlane_id column and HT from the hashtag_number column). 
In the cell metadata, sampleID can be reconstructed by concatenating IGT and hashtag_number columns (i.e. paste(so$IGT, so$hashtag_number, sep = "."))

Data is exported in several formats and always contains the following:
- RNA expression (counts)
- Protein expression (aka ADT) (counts)
- totalvi latent space and 2D UMAP ("reductions")
- cell metadata

1) BPCells V5 Seurat object (in-disk): 
in the bpcells folder load totalvi_igt1_56_20231030_allgenes_BPCells_so.Rds
- RNA expression: seurat_object[["RNA"]]
- Protein expression ("ADT"): seurat_object[["ADT"]]
- totalvi latent space and 2D UMAP ("reductions"): seurat_object[["umap_totalvi"]], seurat_object[["totalvi"]]
- cell metadata: seurat_object@meta.data

2) In-memory V5 Seurat object: 
load  totalvi_igt1_56_20231030_allgenes_inmemory_diet_seurat.Rds
- RNA expression: seurat_object[["RNA"]]
- Protein expression ("ADT"): seurat_object[["ADT"]]
- totalvi latent space and 2D UMAP ("reductions"): seurat_object[["umap_totalvi"]], seurat_object[["totalvi"]]
- cell metadata: seurat_object@meta.data

3) Individual files:
matrix_rna.mtx
matrix_protein.mtx
genes.tsv
proteins.tsv
cells.tsv
cell_metadata.tsv
reductions.tsv

4) AnnData object (for python):
load  totalvi_igt1_56_20231030_allgenes_adata.h5ad
- RNA expression: adata.X
- Protein expression: adata.obsm['protein']
- totalvi latent space and 2D UMAP ("reductions"): adata.obsm['X_ umap_totalvi'] adata.obsm['X_totalvi'] 
- cell metadata: adata.obs

The totalvi model used is in totalvi_igt1_56_20231030_allgenes. It contains the exact adata.h5ad used (same data but cell names were not reformatted and are slightly different, and metadata isn't cleaned up).

ClusterTOTALVI_Res1_quickannotation.csv contains broad annotation of ClusterTOTALVI_Res1


**Start interactive session on Midway3**
```{bash}
ssh -Y zemmour@midway3.rcc.uchicago.edu
sinfo -s
screen -S david
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=jfkfloor2 --qos=jfkfloor2 --nodes=1 
sinteractive --time=12:00:00 --account=pi-zemmour --partition=caslake --nodes=1 --mem=128GB
sinteractive --time=3:00:00 --account=pi-zemmour --partition=gpu --gres=gpu:1 --mem=152GB
cd $LABHOME

module load python/anaconda-2022.05 
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13

source activate /project/jfkfloor2/zemmourlab/david/envs/scvi
#source activate /project/zemmour/david/envs/scvi_20240315
module load openblas/0.3.13 #load again or error

R
options(max.print=1000)
options(Seurat.object.assay.version = 'v5')
```

**Initialize: load libraries and custom functions**

```{r}
setwd("/project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/")
setwd("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96")

libs = c("Seurat","BPCells", "ggplot2", "dplyr", "reshape2", "ggrastr", "RColorBrewer", "pals", "scales") 
#libs = c("matrixStats", "gplots","ggplot2", "reshape2", "scales", "gridExtra", "dplyr", "RColorBrewer", "grid", "Rtsne", "limma",   "RColorBrewer", "pheatmap", "Seurat",  "ggrastr", "ggbeeswarm") #pwr, preprocessCore, "readxl", vegan", "genefilter" "scde" "cellrangerRkit", "Rsamtools", "GenomicRanges", "GenomicAlignments", "VGAM", "WGCNA",rafalib, ‘UsingR’,MAST "ggrastr",
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))

```

Original seurat object to export
```{r}
prefix = "totalvi_igt1_56_20231030_allgenes"
so = readRDS(file = sprintf("/project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/bpcells/%s_counts/%s_BPCells_so_sketched_20231106.Rds", prefix, prefix))

prefix = "totalvi_igt1_96_20241006"
so = readRDS(file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/immgent_igt1_56_20241006.Rds")
so = readRDS(file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/export_data/totalvi_igt1_96_20241006_inmemory_diet_seurat.Rds")

DefaultAssay(so) = "RNA"

#write.table(so[["umap_totalvi"]]@cell.embeddings, file = sprintf("/project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/bpcells/%s_counts/%s_BPCells_so_umaptotalvi.csv", prefix, prefix), quote = F, sep = ",", row.names = T, col.names = T)

#m = so@meta.data[,c("Rosetta_RNA_clusters","Rosetta_Protein_clusters","iNKT","MAIT","ClusterTOTALVI_Res1")]
#all(rownames(so@meta.data) == rownames(so[["umap_totalvi"]]@cell.embeddings))
#m = data.frame(m, so[["umap_totalvi"]]@cell.embeddings)
#m = data.frame(m, so[["totalvi"]]@cell.embeddings)

#write.table(m, file = sprintf("/project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/bpcells/%s_counts/%s_BPCells_so_umaptotalvi_andothermetadata.csv", prefix, prefix), quote = F, sep = ",", row.names = T, col.names = T)


```

Update the metadata in seurat object
```{r}
message("check colnames to be IGT.BARCODE")
pattern = "^IGT\\d{1,2}\\.[A-Z]{16}$"
matches = grepl(pattern, so$colnames)
all(matches)
#and adjust colnames if needed:
unique(so$IGT[which(matches == F)])
#Adjust colnames(so) 
#pattern = "(IGT\\S*)_(\\d+)"
so$colnames = colnames(so)
sample(colnames(so), 100)
pattern = "(\\S*)_(\\d+)"
so$colnames = gsub(pattern, "\\1", so$colnames) #remove the _1 or other number at the end
sample(so$colnames, 100)
unique(so$IGT[!grepl("^IGT", so$colnames)])
so$colnames[!grepl("^IGT", so$colnames)] = paste(so$IGT[!grepl("^IGT", so$colnames)], so$colnames[!grepl("^IGT", so$colnames)], sep = ".")
sample(so$colnames, 100)
any(duplicated(so$colnames))
#recheck
pattern = "^IGT\\d{1,2}\\.[A-Z]{16}$"
matches = grepl(pattern, so$colnames)
all(matches)
#so@meta.data[which(matches == F),]
if(all(matches)) {colnames(so) = so$colnames}
all(grepl(pattern, colnames(so)))

#add sample_id: IGT.HT
#so$sample_id_david = paste(so$IGT, so$hashtag_number, sep = ".") #in IGT1-56
table(so$IGT)
any(is.na(so$IGT))
table(so$hashtag_number)
any(is.na(so$hashtag_number))
IGT.HT = paste(so$IGT, so$hashtag_number, sep = ".")
IGT.HT = gsub(x = IGT.HT, pattern = "IGT", replacement = "I")
IGT.HT = gsub(x = IGT.HT, pattern = "HT", replacement = "H")
so$IGT.HT = IGT.HT

#order IGT
unique(so$IGT)
extract_numeric = function(x) {
  as.numeric(gsub("\\D", "", x))
}
ordered_vector = unique(so$IGT)[order(extract_numeric(unique(so$IGT)))] %>% as.character()
so$IGT = factor(so$IGT, levels = ordered_vector)

#Clean up metadata
cat(colnames(so@meta.data), sep = '\",\"')
#someta = so@meta.data
so@meta.data = so@meta.data[,c("nCount_RNA","nFeature_RNA","nCount_ADT","nFeature_ADT","percent_mito","signature_1T.enriched","signature_1mnp.enriched","signature_1B.enriched","signature_1ILC.enriched","IGT","is_spleen_standard","Rosetta_RNA_clusters","Rosetta_Protein_clusters","hashtag_number","ClusterTOTALVI_Res0.25","ClusterTOTALVI_Res0.5","ClusterTOTALVI_Res1","ClusterTOTALVI_Res2","ClusterTOTALVI_Res3","ClusterTOTALVI_Res4","iNKT","MAIT", "sample_id_david")]

```

Export seurat object as BPCells (on-disk instead of in-memory) object and with sketched assay
```{r}
library(BPCells)
file_dir = "export_data/bpcells"

DefaultAssay(so) = "RNA"
so = JoinLayers(so)

write_matrix_dir(mat = so[["RNA"]]$counts, dir = sprintf("%s/%s_counts", file_dir, prefix))
counts.mat = open_matrix_dir(dir = sprintf("%s/%s_counts", file_dir, prefix))

so_bp = so
so_bp[["RNA"]]$counts = counts.mat

message("Saving Seurat BPCells object")
# saveRDS( object = so_bp,
#          file = sprintf("%s_BPCells_seurat.Rds", prefix),
#          destdir = file_dir
# )

saveRDS( object = so_bp,
         file = sprintf("%s/%s_BPCells_seurat.Rds", file_dir, prefix),
)

#so_bp = readRDS(sprintf("%s/%s_BPCells_seurat.Rds", file_dir, prefix))

```

Export in-memory diet seurat object
```{r}
file_dir = "export_data"
sod = so
sod[["RNA"]]$counts = as(object = sod[["RNA"]]$counts, Class = "dgCMatrix")
DefaultAssay(sod) = "RNA"

sod = DietSeurat(sod,
  layers = c("counts"),
  features = NULL,
  assays = c("RNA", "ADT"),
  dimreducs = c("totalvi", "umap_totalvi"),
  graphs = NULL,
  misc = TRUE
)

saveRDS(object = sod, file = sprintf("%s/%s_inmemory_diet_seurat.Rds", file_dir, prefix))

#sod = readRDS(sprintf("export_data/%s_inmemory_diet_seurat.Rds", prefix))
```

Export individual files (like for GEO)
```{r}
library(Matrix)

file_dir = "export_data/individual_files"
dir.create(file_dir)

#message("Exporting data")
message("Exporting matrix_rna.mtx...")
writeMM(obj = sod[["RNA"]]$counts, file = sprintf("%s/matrix_rna.mtx", file_dir))

message("Exporting matrix_protein.mtx...")
writeMM(obj = sod[["ADT"]]$counts, file = sprintf("%s/matrix_protein.mtx", file_dir))

message("Exporting genes.tsv and proteins.tsv...")
write.table(rownames(sod[["RNA"]]), file = sprintf("%s/genes.tsv", file_dir), sep = "\t", quote = F, row.names = F, col.names = F)
write.table(rownames(sod[["ADT"]]), file = sprintf("%s/proteins.tsv", file_dir), sep = "\t", quote = F, row.names = F, col.names = F)

message("Exporting cells.tsv...")
write.table(colnames(sod), file = sprintf("%s/cells.tsv", file_dir), sep = "\t", quote = F, row.names = F, col.names = F)

message("Exporting cell_metadata.tsv")
write.table(sod@meta.data, file = sprintf("%s/cell_metadata.tsv", file_dir), sep = "\t", quote = F, row.names = T, col.names = T)

message("Exporting reductions.tsv")
reductions = data.frame(sod[["totalvi"]]@cell.embeddings, sod[["umap_totalvi"]]@cell.embeddings)
write.table(reductions, file = sprintf("%s/reductions.tsv", file_dir), sep = "\t", quote = F, row.names = T, col.names = T)


```

Export Anndata h5ad file
Don't forget to activate the scvi python environment before launching R
```{r}
file_dir = "export_data"
library(SingleCellExperiment)
library(sceasy)
library(anndata)

message("Loading python library")
sc = tryCatch(import("scanpy", convert = FALSE), error = function(e) {message("scanpy error usually not a problem undefined symbol: cblas_cdotc_sub")})
scvi = import("scvi", convert = FALSE)
sys = import ("sys", convert = FALSE)
np = import("numpy", convert=FALSE)

sce = Seurat::as.SingleCellExperiment(so)

message("Converting to AnnData")
adata = convertFormat(sce, from = "sce", to= "anndata", main_layer = "counts", drop_single_values=FALSE)
adata_protein = convertFormat(altExp(sce), from="sce", to="anndata", main_layer="counts", drop_single_values=FALSE)
adata$obsm[["protein"]] = adata_protein$to_df()
print(adata) # Note generally in Python, dataset conventions are obs x var

write_h5ad(adata, filename = sprintf("%s/%s_adata.h5ad", file_dir, prefix))
          
```

Export the sample metadata and ClusterTOTALVI_Res1_quickannotation.csv
```{r}
command = "cp ClusterTOTALVI_Res1_quickannotation.csv export_data/"
system(command)

command = "cp Sample_metadata_david_20240324_v3.csv export_data/"
system(command)

```

Export the totalvi model
```{r}
command = "cp totalvi_igt1_56_20231030_allgenes export_data/"
system(command)

```

EXTRA
Export sketched data only
```{bash}
file_dir = "export_data"
#so = readRDS("bpcells/totalvi_igt1_56_20231030_allgenes_counts/totalvi_igt1_56_20231030_allgenes_BPCells_so_sketched_20231106.Rds")

DefaultAssay(so) = "sketch"
length(colnames(so[["sketch"]]))

#check  colnames of so[["sketch"]] and ADT if needed
pattern = "^IGT\\d{1,2}\\.[A-Z]{16}$"
all(grepl(pattern, colnames(so[["RNA"]])))
all(grepl(pattern, colnames(so[["sketch"]])))
all(grepl(pattern, colnames(so[["ADT"]])))

sketch = subset(so, cells = colnames(so[["sketch"]]))
DefaultAssay(sketch) = "RNA"
sketch[["RNA"]]$counts = as(object = sketch[["RNA"]]$counts, Class = "dgCMatrix")

sketch = DietSeurat(sketch,
  layers = c("counts"),
  features = NULL,
  assays = c("RNA", "ADT"),
  dimreducs = c("totalvi", "umap_totalvi"),
  graphs = NULL,
  misc = TRUE
)

saveRDS(sketch, file = sprintf("%s/%s_seurat_sketch.Rds", file_dir, prefix)) #saves in memory by default

```

if needed, add Sample metadata from the database
Currently prefers to have it separated (object size, easier to update): Sample_metadata_david_20240324_v3.txt
```{r}

m = read.table("/project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/Sample_metadata_david_20240324_v3.csv",header = T, sep = ",")
#m$sample_id = paste(m$immgent_IGT_10xlane_id, m$hashtag_number, sep = ".")

someta = so@meta.data
someta = someta[, !(colnames(someta) %in% colnames(m) & !(colnames(someta) %in% c("sample_id", "hashtag_number")))]
m2 = merge(someta, m, by  = "sample_id", all.x = T)
m2$sample_id[which(is.na(m2$exp_number))]
m2$is_spleen_standard[which(is.na(m2$exp_number))] #missing metadata about spleen standards!!
m2$colnames[which(is.na(m2$exp_number))]

all(m2$colnames %in% rownames(so@meta.data))
rownames(m2) = m2$colnames
m2 = m2[rownames(so@meta.data),]
all(m2$colnames %in% rownames(so@meta.data))

as(bpcells_mat, "dgCMatrix")

so@meta.data = m2
```

**For python**
source activate /project/zemmour/david/envs/scvi_20240315

Make h5ad files
```{python}
import pandas as pd
from scipy.io import mmread
import anndata as ad

os.chdir("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/export_data/")

# Step 1: Load the data
matrix_rna = mmread('individual_files/matrix_rna.mtx').tocsr()  # Load the RNA expression matrix and convert to CSR format
matrix_protein = mmread('individual_files/matrix_protein.mtx').tocsr()  # Load the protein expression matrix

genes = pd.read_csv('individual_files/genes.tsv', header=None, sep='\t')  # Gene names
proteins = pd.read_csv('individual_files/proteins.tsv', header=None, sep='\t')  # Protein names
cells = pd.read_csv('individual_files/cells.tsv', header=None, sep='\t')  # Cell names

# Assuming cell_metadata.tsv has a header with metadata columns
cell_metadata = pd.read_csv('individual_files/cell_metadata.tsv', sep='\t', index_col=0)  # Load cell metadata

# Step 2: Create AnnData objects
adata_rna = ad.AnnData(X=matrix_rna, obs=cell_metadata, var=pd.DataFrame(index=genes[0]))
adata_protein = ad.AnnData(X=matrix_protein, obs=cell_metadata, var=pd.DataFrame(index=proteins[0]))

# Set the cell names if they are provided
adata_rna.obs_names = cells[0]
adata_protein.obs_names = cells[0]

# Step 3: Merge RNA and Protein data into one object
# Assume the same cells in the same order for both matrices
adata_rna.obsm['protein_expression'] = adata_protein.X

# Step 4: Save the AnnData object
adata_rna.write('combined_rna_protein.h5ad')

```


Export MuData file
Don't forget to activate the scvi python environment before launching R
source activate /project/zemmour/david/envs/scvi_20240315
```{python}
import warnings; warnings.simplefilter('ignore')

import scvi
import os
import scanpy as sc
import muon as mu

import numpy as np
import mplscience
import matplotlib.pyplot as plt
import pickle
import pandas as pd
pd.set_option('display.max_rows', 1000)
pd.set_option('display.max_columns', 1000)

os.chdir("/project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/"+file_dir)
prefix = "totalvi_igt1_56_20231030_allgenes"

#mdata = mu.read("totalvi_igt1_56_allgenes_Treg_20240306/adata.h5mu")

adata = sc.read_h5ad("totalvi_igt1_56_20231030_allgenes_adata.h5ad")

#model = scvi.model.TOTALVI.load("totalvi_igt1_56_allgenes_Treg_20240306/")
mdata = mu.MuData({"RNA": adata})
mdata.mod["RNA"].layers["counts"] = mdata.mod["RNA"].X.copy()
protein_data = adata.obsm['protein']
non_zero_columns = np.sum(protein_data, axis=0) > 0
protein_data = protein_data.loc[:,non_zero_columns]
protein_adata = sc.AnnData(X=protein_data)
mdata.mod['protein'] = protein_adata
TOTALVI_LATENT_KEY = "X_totalVI"
#mdata.mod["RNA"].obsm[TOTALVI_LATENT_KEY] = model.get_latent_representation()
del mdata.mod["RNA"].obsm["protein"]
#mdata.write(prefix+"_mdata.h5mu")
#mdata = mu.read(file_path)

#import metadata
m = pd.read_csv('/project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/Sample_metadata_david_20240324_v3.csv')
#m
m['sample_id'] = m['immgent_IGT_10xlane_id'].astype(str) + '.' + m['hashtag_number'].astype(str)
mdata.mod['RNA'].obs['sample_id'] = mdata.mod['RNA'].obs['IGT'].astype(str) + '.' + mdata.mod['RNA'].obs['hashtag_number'].astype(str)
meta = mdata.mod['RNA'].obs

cols_to_keep = ['sample_id', 'hashtag_number'] + list(set(meta.columns) - set(m.columns))
meta = meta[cols_to_keep]
m2 = pd.merge(meta, m, on='sample_id', how='left')
m2.shape
m2[m2['exp_number'].isna()].shape
#print(m2[m2['exp_number'].isna()]['sample_id']) 
#print(m2[m2['exp_number'].isna()]['is_spleen_standard']) 
m2[m2['exp_number'].isna()]['organ'] = 'spleen'
m2[m2['exp_number'].isna()]['condition_broad'] = 'healthy'

#(m2['colnames'].values == mdata.mod['RNA'].obs.index.to_list()).all()
(m2["nFeature_RNA"].values == mdata.mod['RNA'].obs['nFeature_RNA'].values).all()
#set(m2['colnames']) == set(mdata.mod['RNA'].obs.index)
#m2.index = m2['colnames']
m2.index = mdata.obs.index
#m2 = m2.reindex(mdata.mod['RNA'].obs.index, axis=0)
#(m2['colnames'].values == mdata.mod['RNA'].obs.index.to_list()).all()
(m2.index == mdata.mod['RNA'].obs.index).all()

#clean up columns
m2.columns
m2.columns[m2.iloc[0,].duplicated()]

(m2.sample_id.values == m2.sample_id_david.values).all()
m2.sample_id[m2.sample_id.values != m2.sample_id_david.values]
m2.sample_id_david[m2.sample_id.values != m2.sample_id_david.values]

(m2.hashtag_number_x.values.to_numpy() == m2.hashtag_number_y.values).all()
m2.hashtag_number_x[(m2['hashtag_number_x'] != m2['hashtag_number_y'])]
m2.hashtag_number_y[(m2['hashtag_number_x'] != m2['hashtag_number_y'])]

(m2.IGT.values.to_numpy() == m2.immgent_IGT_10xlane_id.values).all()
m2.IGT[(m2['IGT'] != m2['immgent_IGT_10xlane_id'])]
m2.immgent_IGT_10xlane_id[(m2['IGT'] != m2['immgent_IGT_10xlane_id'])]
m2.immgent_IGT_10xlane_id[(m2['hashtag_number_x'] != m2['hashtag_number_y'])]

columns_to_drop = ['hashtag_number_y', 'sample_id_david', 'count_unique', "immgent_IGT_10xlane_id", "ident", "igt_number", "ht_number"]

# Use the drop method to remove the columns
m2 = m2.drop(columns=columns_to_drop)

mdata.mod['RNA'].obs = m2

#simplify the organ columns
mdata.mod["RNA"].obs["organ_simplified"] = mdata.mod['RNA'].obs['organ']
list(mdata.mod["RNA"].obs["organ_simplified"].unique())
mdata.mod["RNA"].obs["organ_simplified"] = mdata.mod["RNA"].obs["organ_simplified"].astype('object')
list(mdata.mod["RNA"].obs["organ_simplified"].unique())
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ'].str.contains('lymph node|LN', na=False, case=False), 'organ_simplified'] = 'lymph node'
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ'].str.contains('skin', na=False, case=False), 'organ_simplified'] = 'skin'
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ'].str.contains('colon', na=False, case=False), 'organ_simplified'] = 'colon'
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ'].str.contains('duoden|ileal|ileum|jejun|small intestine', na=False, case=False), 'organ_simplified'] = 'small intestine'
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ_simplified'].isna(), 'organ_simplified'] = 'spleen'
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ_simplified'].isna(), 'condition_broad'] = 'healthy'
mdata.mod["RNA"].obs["organ_simplified"] = mdata.mod["RNA"].obs["organ_simplified"].str.replace('[^0-9a-zA-Z]', '.', regex=True)
list(mdata.mod["RNA"].obs["organ_simplified"].unique())
mdata.mod["RNA"].obs["organ_simplified"] = mdata.mod["RNA"].obs["organ_simplified"].astype('category')

for mod_key in mdata.mod.keys():
    # Convert all columns in .obs to string type to avoid error in writing
    mdata.mod[mod_key].obs = mdata.mod[mod_key].obs.astype(str)

mdata.write(prefix+"_mdata.h5mu")

          
```


