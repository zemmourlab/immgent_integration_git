---
title: "clustering_CD8"
output: html_document
date: "2024-10-17"
editor_options: 
  chunk_output_type: console
---

**Start interactive session on Midway3**
```{bash}
ssh -Y zemmour@midway3.rcc.uchicago.edu
sinfo -s
screen -S david
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=jfkfloor2 --qos=jfkfloor2 --nodes=1 
sinteractive --time=12:00:00 --account=pi-zemmour --partition=caslake --nodes=1 --mem=128GB
sinteractive --time=3:00:00 --account=pi-zemmour --partition=gpu --gres=gpu:1 --mem=152GB
cd $LABHOME

module load python/anaconda-2022.05 
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13

#sinteractive --time=1:00:00 -p gpu --gres=gpu:1 --account=pi-zemmour 

#source activate /project/jfkfloor2/zemmourlab/david/envs/scvi
source activate /project/zemmour/david/envs/scvi_20240315
module load openblas/0.3.13 #load again or error

cd /project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD8AB
#cd ~/google_drive/ImmgenT/analysis/data_integration/IGT1_56/Treg

R
#options(max.print=1000)
#options(Seurat.object.assay.version = 'v5')
```

**Initialize: load libraries and custom functions**

```{r}
options(max.print=1000)
setwd("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD8AB")
source("/project/jfkfloor2/zemmourlab/david/immgent/immgent_integration_git/custom_functions_david.R")

libs = c("fgsea","fastTopics", "flashier", "Matrix", "Seurat","BPCells", "ggplot2", "dplyr", "reshape2", "ggrastr", "RColorBrewer", "pals", "scales", "pheatmap") 
#libs = c("matrixStats", "gplots","ggplot2", "reshape2", "scales", "gridExtra", "dplyr", "RColorBrewer", "grid", "Rtsne", "limma",   "RColorBrewer", "pheatmap", "Seurat",  "ggrastr", "ggbeeswarm") #pwr, preprocessCore, "readxl", vegan", "genefilter" "scde" "cellrangerRkit", "Rsamtools", "GenomicRanges", "GenomicAlignments", "VGAM", "WGCNA",rafalib, ‘UsingR’,MAST "ggrastr",
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))


#Gradients
library(RColorBrewer)
ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
ColorRamp = rev(rainbow(10, end = 4/6))
library(viridis)
ColorRamp = rev(viridis(100))
ColorRamp = rev(cividis(100))
#image(1:100, 1, as.matrix(1:100), col = ColorRamp, main = "Color Palette", xaxt = 'n', yaxt = 'n', xlab = "", ylab = "")

#mycol = c("black","blue","red","darkgreen", "orange","purple", "cyan", "greenyellow",    "salmon", "magenta","pink", "tan", "brown") # c("magenta", "red",  "darkgreen", "cyan", "blue", "blue", "blue", "black", "blue", "blue", "blue", "blue", "orange")

#Large Color palette
library("pals")
n = 70
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
mypal1 = unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals))))
mypal1 = mypal1[-4]
mypal = c(glasbey(), polychrome(), mypal1)
names(mypal) = NULL
#pal.bands(mypal, main="Colormap suggestions")

mypal_level1 = setNames(mypal, unique(so$annotation_level1))
mypal_level2 = setNames(mypal, unique(so$annotation_level2))

#parade = function(n) { return(Seurat::DiscretePalette(n, palette = "parade", shuffle = F)) }


```

Seurat object with the results: igt1_96_CD8AB_20241017.Rds
annotation: annotation_CD8AB_clusters_l1.csv

```{r}

so = readRDS(file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD8AB/igt1_96_CD8AB_20241017.Rds")
so = NormalizeData(so,assay = "RNA", normalization.method = "LogNormalize",verbose = T)
so = NormalizeData(so,assay = "ADT", normalization.method = "CLR", verbose = T)

```

**Load seurat expression data**
--> igt1_96_treg_20241017.Rds
```{r}
so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241021.Rds")

so = so_orig[,so_orig$annotation_level1 == "CD8AB"]
so[['mde_totalvi_20241006']] = NULL
so[['umap2_totalvi_20241006']] = NULL
so[['mdeumap_totalvi_20241006']] = NULL
so[['mde_totalvi_20241008_rmIGTsample']] = NULL
so[['mdeumap_totalvi_20241008_rmIGTsample']] = NULL

```

Add latent spaces, umaps
```{r}
# sprintf("%s_X_SCVI_%s.csv", prefix, prefix2)

AddLatentData = function(so, latent_file, prefix, calculate_umap = F) {
    totalvi = read.csv(file = latent_file, header = T, sep = ",", row.names = 1)
    # pattern = "(IGT\\S*)_(\\d+)"
    # rownames(totalvi) = gsub(pattern, "\\1", rownames(totalvi))
    colnames(totalvi) = as.character(seq(1:ncol(totalvi)))
    #all(rownames(totalvi) == colnames(so))
    totalvi = as.matrix(totalvi)
    pattern = "^IGT\\d{1,2}\\.[A-Z]{16}$"
    matches = grepl(pattern, rownames(totalvi))
    if (!all(matches)) {
        print("updating cell names in csv file, assuming same order as seurat object" )
        #rownames(totalvi) = gsub(pattern = "(\\S*)_(\\d+)", replacement = "\\1", rownames(totalvi))
        rownames(totalvi) = colnames(so)
    }
    totalvi = totalvi[colnames(so),]
    if (all(colnames(so) == rownames(totalvi))) {
        print("all cells ARE in the latent_file")
        so[[prefix]] = CreateDimReducObject(embeddings = totalvi, key = prefix, assay = "RNA") #sprintf("totalvi_%s", prefix2)
        if (calculate_umap == T) {
            so = RunUMAP(so, dims = 1:ncol(totalvi), reduction = prefix, n.components = 2, reduction.name = sprintf("umap_%s", prefix))
        }
        return(so)
    } else {
        print("all cells ARE NOT in the latent_file")
        return(so)
    }
}

dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD8AB/totalvi_20241014_CD8AB"
so = AddLatentData(so, latent_file = sprintf("%s/latent.csv",dir_with_file), prefix = "totalvi_20241014_CD8AB", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/umap_python.csv",dir_with_file), prefix = "umap_totalvi_20241014_CD8AB", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/mde2.csv",dir_with_file), prefix = "mde_totalvi_20241014_CD8AB", calculate_umap = F)

dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD8AB/totalvi_20241014_CD8AB_rmIGTsample"
# so = AddLatentData(so, latent_file = sprintf("%s/latent.csv",dir_with_file), prefix = "totalvi_20241014_CD8AB_rmIGTsample", calculate_umap = F)
# so = AddLatentData(so, latent_file = sprintf("%s/umap_python.csv",dir_with_file), prefix = "umap_totalvi_20241014_CD8AB_rmIGTsample", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/mde2.csv",dir_with_file), prefix = "mde_totalvi_20241014_CD8AB_rmIGTsample", calculate_umap = F)


```

```{r}
prefix = "totalvi_20241014_CD8AB_rmIGTsample"
#setwd(prefix)
reduc = "mde_totalvi_20241014_CD8AB_rmIGTsample"
reduc = "umap_totalvi_20241014_CD8AB_rmIGTsample"
```

```{r}
RenameCluster = function(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl") {
    cl = as.numeric(cluster.vector)
    ordered = order(unique(cl))
    cl = sprintf("%s%s", cluster.prefix, cl )
    renamed.vector = factor(cl, levels = unique(cl)[ordered])
    return(renamed.vector)
}

n_latent = ncol(so[[prefix]]@cell.embeddings)
so = FindNeighbors(so, dims = 1:n_latent, reduction = prefix)
so = FindClusters(so, resolution = 0.25, cluster.name = sprintf("Cluster_%s_Res0.25",prefix))
so = FindClusters(so, resolution = 0.5, cluster.name = sprintf("Cluster_%s_Res0.5",prefix))
so = FindClusters(so, resolution = 0.75, cluster.name = sprintf("Cluster_%s_Res0.75",prefix))
so = FindClusters(so, resolution = 1, cluster.name = sprintf("Cluster_%s_Res1",prefix))
so = FindClusters(so, resolution = 1.5, cluster.name = sprintf("Cluster_%s_Res1.5",prefix))
so = FindClusters(so, resolution = 2, cluster.name = sprintf("Cluster_%s_Res2",prefix))
so = FindClusters(so, resolution = 3, cluster.name = sprintf("Cluster_%s_Res3",prefix))
so = FindClusters(so, resolution = 4, cluster.name = sprintf("Cluster_%s_Res4",prefix))

cluster.name = sprintf("Cluster_%s_Res0.25",prefix)
so[[cluster.name]][,1] = RenameCluster(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl")
cluster.name = sprintf("Cluster_%s_Res0.5",prefix)
so[[cluster.name]][,1] = RenameCluster(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl")
cluster.name = sprintf("Cluster_%s_Res0.75",prefix)
so[[cluster.name]][,1] = RenameCluster(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl")
cluster.name = sprintf("Cluster_%s_Res1",prefix)
so[[cluster.name]][,1] = RenameCluster(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl")
cluster.name = sprintf("Cluster_%s_Res1.5",prefix)
so[[cluster.name]][,1] = RenameCluster(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl")
cluster.name = sprintf("Cluster_%s_Res2",prefix)
so[[cluster.name]][,1] = RenameCluster(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl")
cluster.name = sprintf("Cluster_%s_Res3",prefix)
so[[cluster.name]][,1] = RenameCluster(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl")
cluster.name = sprintf("Cluster_%s_Res4",prefix)
so[[cluster.name]][,1] = RenameCluster(cluster.vector = so[[cluster.name]][,1], cluster.prefix = "cl")

# write.table(data.frame(colnames(so), so@meta.data[,grepl("Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res", colnames(so@meta.data))]), file = sprintf("%s/Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res.csv", prefix), sep = ",", quote = F, row.names = F, col.names = F)

```

UMAP/MDE with clusters
```{r}
# pdf(sprintf("%s/UMAP_Clusters.pdf", prefix), 20, 20, useDingbats = F)
# for (i in c(0.25,0.5,0.75,1,1.5,2,3,4)) {
#     MyPlots(seurat_object = so, 
#         dim1 = so[[reduc]]@cell.embeddings[,1], 
#         dim2 = so[[reduc]]@cell.embeddings[,2], 
#         color_by = sprintf("Cluster_%s_Res%s",prefix,i), 
#         split_by1 = "organ_simplified",
#         split_by2 =  NULL, 
#         genes = NULL, 
#         cluster_key = NULL, mypal = mypal) #glasbey()
# }
# dev.off()

# pdf(sprintf("%s/UMAP_Clusters.pdf", prefix), 20, 20, useDingbats = F)
pdf(sprintf("%s/MDE_Clusters.pdf", prefix), 20, 20, useDingbats = F)
for (i in c(0.25,0.5,0.75,1,1.5,2,3,4)) {
    print(i)
    print(DimPlot(so, reduction = reduc, group.by = sprintf("Cluster_%s_Res%s",prefix,i), raster = T, raster.dpi = c(1024,1024), label = T) + scale_color_manual(values = mypal))
    print(DimPlot(so, reduction = reduc, group.by = sprintf("Cluster_%s_Res%s",prefix,i), split.by = "organ_simplified", ncol = trunc(sqrt(length(unique(so$organ_simplified)))), raster = T, raster.dpi = c(1024,1024), label = F, pt.size = 2) + scale_color_manual(values = mypal))
}
dev.off()

```

UMAP/MDE with genes
```{r}
# pdf(sprintf("%s/UMAP_genes.pdf", prefix), 20,20, useDingbats = F)
pdf(sprintf("%s/MDE_genes.pdf", prefix), 40,40, useDingbats = F)
DefaultAssay(so) = "RNA"
FeaturePlot(so, slot = "data", reduction = reduc, features = c("Cd4", "Cd8a", "Cd8b1","Sell", "Ccr7", "Il7r", "Cd44", "Klrg1",  "Tcf7", "Bcl2", "Cxcr3", "Cxcr5", "Slamf6", "Eomes", "Foxp3","Tbx21", "Nr4a1", "Mki67","Pdcd1", "Havcr2", "Ctla4", "Tox", "Lag3", "Cd69", "Itgae", "Cxcr6", "Zeb2", "Runx3", "Slamf6", "Nkg7", "Zbtb16" ,"Gzmb", "Prf1", "Ifng", "Tnf", "Fasl", "Tnfsf10", "Il2", "Il10", "Klrk1", "Ccl3", 'Ccl4', "Ccl5", "Xcl1"), ncol = 7, order = T, raster = T, raster.dpi = c(1024,1024))
dev.off()

# pdf(sprintf("%s/UMAP_proteins.pdf", prefix), 20,20, useDingbats = F)
pdf(sprintf("%s/MDE_proteins.pdf", prefix), 30,30, useDingbats = F)
DefaultAssay(so) = "ADT"
FeaturePlot(so[,so$cite_seq == T], reduction = reduc,slot = "data", features = c("CD3","CD4","CD8A","CD8B","TCRB","IL2RA.CD25","CD62L", "CD27", "IL7RA.CD127", "CD44", "CD45RB", "KLRG1", "CD137", "CD69", "CD103", "PDCD1.PD1.CD279", "HAVCR2", "TIGIT"), ncol = 5, order = T, raster = T, raster.dpi = c(1024, 1024))
dev.off()
```

--> annotation_level2_CD8AB.csv
```{r}
library(cluster)
cluster.name = sprintf("Cluster_%s_Res0.25",prefix)
cluster.names = sprintf("Cluster_%s_Res%s",prefix,c(0.25, 0.5, 0.75, 1,2,3,4))
#cluster.name = sprintf("Cluster_%s_Res0.75",prefix)

#1 in all the data
so_sub = so[,sample(colnames(so), 50000,replace = F)]
reduc.dist = dist(so_sub[[prefix]]@cell.embeddings)

pdf(sprintf("%s/Cluster_silhouettes.pdf", prefix), 10, 10, useDingbats = F)
for (cluster.name in cluster.names) {
    print(cluster.name)
    cl = as.integer(so_sub[[cluster.name]][,1])
    sil = silhouette(cl, dist = reduc.dist)
    clust.col = mypal
    sil.cols = clust.col[ifelse(sil[,3] > 0, sil[,1], sil[,2])]
    sil.cols = sil.cols[order(-sil[,1], sil[,3])]
    plot(sil,
         main = sprintf("Silhouette in %s", cluster.name),
         border = sil.cols,
         col = sil.cols,
         do.col.sort = FALSE)
}
dev.off()

so$CD8AB_clusters = "unknown"
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl1"] = "CD8AB_cl1" #resting
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 %in% c("cl3", "cl4", "cl12")] = "CD8AB_cl1" #MERGING resting 
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.5 == "cl2"] = "CD8AB_cl2" #resting
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl9"] = "CD8AB_cl3" #resting
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl6"] = "CD8AB_cl4" #MPEC
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl6" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.5 == "cl17"] = "CD8AB_cl5"
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl6" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.5 == "cl17" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.75 == "cl11"] = "CD8AB_cl6"

so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl2"] = "CD8AB_cl13" #SLEC
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl2" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.5 == "cl16"] = "CD8AB_cl14" #MPEC
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl2" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.5 == "cl13" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res1 == "cl5"] = "CD8AB_cl15" #SLEC
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl2" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.5 == "cl13" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res1 == "cl27"] = "CD8AB_cl16" #SLEC
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl8"] = "CD8AB_cl17" #
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl8" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.5 == "cl14"] = "CD8AB_cl18" #SLEC
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl8" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res2 == "cl22"] = "CD8AB_cl19" #
so$CD8AB_clusters[so$CD8AB_clusters == "CD8AB_cl17" & so[["mde_totalvi_20241014_CD8AB_rmIGTsample"]]@cell.embeddings[,1]<0] = "CD8AB_cl1" #
so$CD8AB_clusters[so$CD8AB_clusters == "CD8AB_cl17" & so[["mde_totalvi_20241014_CD8AB_rmIGTsample"]]@cell.embeddings[,1]>1] = "CD8AB_cl16" #
# so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl8" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res2 == "cl18"] = "CD8AB_cl20" #
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 %in% c("cl7", "cl10", "cl11")] = "CD8AB_cl20" #prolif

# version1
# so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5"] = "CD8AB_cl5" #
# so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res4 == "cl18"] = "CD8AB_cl5" #
# so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.75 == "cl18"] = "CD8AB_cl6" #Trm

# version2
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5"] = "CD8AB_cl7" #
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res4 == "cl48"] = "CD8AB_cl8" #CD4 contamination
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res2 == "cl25" ] = "CD8AB_cl9" #true Trm
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res2 %in% c("cl31","cl35", "cl20")] = "CD8AB_cl10" #Trm
# so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res2 %in% c("cl31", "cl20") ] = "CD8AB_cl11" # merge with
so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res2 == "cl20" ] = "CD8AB_cl12" #
# # version 3
# so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5"] = "CD8AB_cl21" #
# so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res4 == "cl48"] = "CD8AB_cl22" #CD4 contamination
# so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res4 == "cl42" ] = "CD8AB_cl23" #true Trm
# so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res4 == "cl12" ] = "CD8AB_cl24" #Trm
# so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res4 == "cl7" ] = "CD8AB_cl25" #
# so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res4 == "cl20" ] = "CD8AB_cl26" #
# so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res4 == "cl56" ] = "CD8AB_cl27" #
# so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res4 == "cl33" ] = "CD8AB_cl28" #
# so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res4 == "cl15" ] = "CD8AB_cl29" #
# so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res4 == "cl43" ] = "CD8AB_cl30" #

extract_numeric = function(x) {
  as.numeric(gsub("\\D", "", x))
}
ordered_vector = unique(so$CD8AB_clusters)[order(extract_numeric(unique(so$CD8AB_clusters)))] %>% as.character()
new_cluster_names = paste0("CD8AB_cl", seq_along(ordered_vector))
names(new_cluster_names) = ordered_vector
so$CD8AB_clusters_renamed = as.character(new_cluster_names[so$CD8AB_clusters])

ordered_vector = unique(so$CD8AB_clusters_renamed)[order(extract_numeric(unique(so$CD8AB_clusters_renamed)))] %>% as.character()
so$CD8AB_clusters = factor(so$CD8AB_clusters_renamed, levels = ordered_vector)
so$CD8AB_clusters_renamed = NULL

# so$CD8AB_clusters = sprintf("CD8AB_%s",so$CD8AB_clusters)
so$CD8AB_clusters = factor(so$CD8AB_clusters)
any(is.na(so$CD8AB_clusters))

table(so$CD8AB_clusters)

# so$CD8AB_clusters[so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.25 == "cl5" & so$Cluster_totalvi_20241014_CD8AB_rmIGTsample_Res0.75 == "cl18"] = "CD8AB_cl6" #Trm
# so$test = so$CD8AB_clusters %in% "unknown"
# DimPlot(so, reduction = reduc, group.by = "test", raster = F, order = T) + scale_color_manual(values = mypal)

# pdf(sprintf("%s/UMAP_Clusters_Final.pdf", prefix), 20, 20, useDingbats = F)
pdf(sprintf("%s/MDE_Clusters_Final.pdf", prefix), 20, 20, useDingbats = F)
DimPlot(so, reduction = reduc, group.by = "CD8AB_clusters", raster = T, raster.dpi = c(2048,2048), label = T) + scale_color_manual(values = mypal)
DimPlot(so, reduction = reduc, group.by = "CD8AB_clusters", split.by = "CD8AB_clusters", ncol = 4, raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
DimPlot(so, reduction = reduc, group.by = "CD8AB_clusters", split.by = "organ_simplified", ncol = trunc(sqrt(length(unique(so$organ_simplified)))), raster = T, raster.dpi = c(512,512), label = F, pt.size = 2) + scale_color_manual(values = mypal)
DimPlot(so, reduction = "mde_totalvi_20241014_CD8AB", group.by = "CD8AB_clusters", raster = T, raster.dpi = c(2048,2048), label = T) + scale_color_manual(values = mypal)
dev.off()

so_sub = so[,colnames(so_sub)]
cluster.name =  "CD8AB_clusters"
pdf(sprintf("%s/%s_silhouette.pdf", prefix, cluster.name), 10, 10, useDingbats = F)
cl = as.integer(so_sub[[cluster.name]][,1])
sil = silhouette(cl, dist = reduc.dist)
clust.col = mypal
sil.cols = clust.col[ifelse(sil[,3] > 0, sil[,1], sil[,2])]
sil.cols = sil.cols[order(-sil[,1], sil[,3])]
plot(sil,
     main = sprintf("Silhouette in %s", cluster.name),
     border = sil.cols,
     col = sil.cols,
     do.col.sort = FALSE)
dev.off()

write.table(data.frame(colnames(so), so$CD8AB_clusters), file = "../annotation_level2_CD8AB.csv", sep = ",", quote = F, row.names = F, col.names = F)

```

Robustness of clusters with silhouette analysis for cluster.name at all resolution + deeper analysis for resolution 0.75 and 0.5 (the optimum)
in all dataset
in each organ
in each IGT
```{r}
SilhouetteSummaryPlots = function(sil_list = sil_list, column_name = column_name, categories = categories, cluster.name = cluster.name) {
    message("plot silhouettes")
    for (i in categories) {
        print(i)
        sil = sil_list[[i]]
        if (length(sil) >1) {
            # prepare colours:
            clust.col <- mypal#scater:::.get_palette("tableau10medium") # hidden scater colours
            sil.cols <- clust.col[ifelse(sil[,3] > 0, sil[,1], sil[,2])]
            sil.cols <- sil.cols[order(-sil[,1], sil[,3])]
            plot(sil,
                 main = sprintf("Silhouette in %s in %s:%s", cluster.name, i, column_name),
                 border = sil.cols,
                 col = sil.cols,
                 do.col.sort = FALSE)
        }
        
    }
    
    message("Plot Boxplot")
    sil_summary_list = list()
    for (i in categories) {
        sil = sil_list[[i]]
        if (length(sil) >1) {
            sil_summary_list[[i]] = as.data.frame(sil) %>% 
                group_by(cluster) %>% 
                summarise(mean_sil_width = mean(sil_width),
                          total = n(),  # Count total observations in each cluster
                          positive_count = sum(sil_width > 0),  # Count negative silhouette widths
                          percentage_positive = (positive_count / total) * 100)     %>%  # Calculate percentage) 
                as.data.frame()
            sil_summary_list[[i]][,column_name] = i
        }
    }
    sil_summary = Reduce(rbind,sil_summary_list)
    
    #sil_summary[sample(size = 20, x = 1:nrow(sil_summary),replace = F),]
    
    averaged_data <- sil_summary %>%
        group_by(cluster, column_name = sil_summary[,column_name]) %>%
        summarise(ncells = mean(total), mean_of_means = mean(mean_sil_width, na.rm = TRUE), mean_of_percentage_positive = mean(percentage_positive, na.rm = TRUE), .groups = 'drop') %>% data.frame()
    
    p = ggplot(data = averaged_data, aes(x = as.factor(cluster), y = mean_of_means)) +
        geom_boxplot(outlier.shape = NA, alpha = 0.7, width = 0.7, color = "black") +  # Draw boxplots
        geom_point(aes(color = column_name, size = ncells > 10), position = position_jitter(width = 0.2, height = 0), alpha = 0.6) +  # Add jittered points
        scale_color_manual(values=mypal) +  # Color scheme for points
        labs(title = "Boxplot of Average Mean Silhouette Width per Cluster",
             x = "Cluster",
             y = "Average of Mean Silhouette Width",
             color = column_name) +
        theme_minimal() +
        theme(axis.text.x = element_text(angle = 45, hjust = 1),  # Improve x-axis label readability
              legend.position = "right")  # Adjust the legend position
    print(p)
    
    message("Plot Individual")
    p = ggplot(data = averaged_data, aes(x = as.factor(cluster), y = mean_of_means,group = column_name, color = column_name)) +
        geom_line() +  # Add lines to connect points
        #geom_point(size = 3, alpha = 0.8) +  # Add points
        geom_point(alpha = 0.8, aes(size = ncells >10)) +
        scale_color_manual(values=mypal) +  # Use a distinguishable color palette
        labs(title = "Line Plot of Average Mean Silhouette Width per Cluster",
             x = "Cluster",
             y = "Average of Mean Silhouette Width",
             color = column_name) +
        theme_minimal() +
        theme(axis.text.x = element_text(angle = 45, hjust = 1),
              legend.position = "right") 
        
    print(p)
    print(p + facet_wrap(~column_name))
    
     p = ggplot(data = averaged_data, aes(x = as.factor(cluster), y = mean_of_percentage_positive)) +
        geom_boxplot(outlier.shape = NA, alpha = 0.7, width = 0.7, color = "black") +  # Draw boxplots
        geom_point(aes(color = column_name, size = ncells >10), position = position_jitter(width = 0.2, height = 0), alpha = 0.6) +  # Add jittered points
        scale_color_manual(values=mypal) +  # Color scheme for points
        labs(title = "Boxplot of Average Percentage of Cells with Positive Width per Cluster",
             x = "Cluster",
             y = "Average of Percentage of Cells with Positive Width",
             color = column_name) +
        theme_minimal() +
        theme(axis.text.x = element_text(angle = 45, hjust = 1),  # Improve x-axis label readability
              legend.position = "right")  # Adjust the legend position
    print(p)
    
    message("Plot Individual")
    p = ggplot(data = averaged_data, aes(x = as.factor(cluster), y = mean_of_percentage_positive, group = column_name, color = column_name)) +
        geom_line() +  # Add lines to connect points
        #geom_point(size = 3, alpha = 0.8) +  # Add points
        geom_point(alpha = 0.8, aes(size = ncells >10)) +
        scale_color_manual(values=mypal) +  # Use a distinguishable color palette
        labs(title = "Line Plot of Average Percentage of Cells with Positive per Cluster",
             x = "Cluster",
             y = "Average of Percentage of Cells with Positive Width",
             color = column_name) +
        theme_minimal() +
        theme(axis.text.x = element_text(angle = 45, hjust = 1),
              legend.position = "right") 
        
    print(p)
    print(p + facet_wrap(~column_name))
}

# By IGT
sil_list = list()
column_name = "IGT"
categories = levels(so[[column_name]][,1])
cluster.name =  "CD8AB_clusters"

for (i in categories) {
    print(i)
    reduc.dist = dist(so[[prefix]]@cell.embeddings[so[[column_name]] == i,])
    cl = as.integer(so[[cluster.name]][so[[column_name]] == i,1])
    sil_list[[i]] = silhouette(cl, dist = reduc.dist)
}

pdf(sprintf("%s/%s_silhouettes_by%s.pdf", prefix, cluster.name, column_name), 40, 40, useDingbats = F)
SilhouetteSummaryPlots(sil_list = sil_list, column_name = column_name, categories = categories, cluster.name = cluster.name)
dev.off()

# in each organ_simplified: how much does it fit each organ?
so2 = so[,!is.na(so$organ_simplified)]

sil_list = list()
column_name = "organ_simplified"
categories = unique(so2[[column_name]][,1]) %>% na.omit() %>% as.character()
cluster.name =  "CD8AB_clusters"

sil_list = list()
for (i in categories) {
    print(i)
    reduc.dist = dist(so2[[prefix]]@cell.embeddings[so2[[column_name]] == i,])
    cl = as.integer(so2[[cluster.name]][so2[[column_name]] == i,1])
    #cl = as.integer(so2[[cluster.name]][so2[[column_name]] == i,1])
    sil_list[[i]] = silhouette(cl, dist = reduc.dist)
}

pdf(sprintf("%s/%s_silhouettes_by%s.pdf", prefix, cluster.name, column_name), 20, 20, useDingbats = F)
SilhouetteSummaryPlots(sil_list = sil_list, column_name = column_name, categories = categories, cluster.name = cluster.name)
dev.off()

```

```{r}
DefaultAssay(so) = "ADT"
so[['RNA']]$data = NULL
DefaultAssay(so) = "RNA"
so[['ADT']]$data = NULL

saveRDS(so, file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD8AB/igt1_96_CD8AB_20241017.Rds")
```

**Compare mde_totalvi_20241014_Treg_rmIGTsample and mde_totalvi_20241008_rmIGTsample_Treg (MDE from totalvi_20241008_rmIGTsample on all cells, then subset Tregs to calculate MDE)**
```{r}
setwd("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD8AB")
so = readRDS("igt1_96_CD8AB_20241029_so.Rds")

dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/totalvi_20241008_rmIGTsample"
so = AddLatentData(so, latent_file = sprintf("%s/mde_totalvi_20241008_rmIGTsample_inCD8AB.csv",dir_with_file), prefix = "mde_totalvi_20241008_rmIGTsample_inCD8AB", calculate_umap = F)

pdf(sprintf("%s/MDE_Clusters_ComparingMDEs.pdf", "."), 20, 20, useDingbats = F)
DimPlot(so, reduction = "mde_totalvi_20241014_CD8AB_rmIGTsample", group.by = "annotation_level2_CD8AB", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
DimPlot(so, reduction = "mde_totalvi_20241008_rmIGTsample_inCD8AB", group.by = "annotation_level2_CD8AB", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
# print(DimPlot(so, reduction = "mde_totalvi_20241008_rmIGTsample", group.by = annotation_level2_Treg, split.by = "organ_simplified", ncol = trunc(sqrt(length(unique(so$organ_simplified)))), raster = T, raster.dpi = c(512,512), label = F, pt.size = 2) + scale_color_manual(values = mypal))
dev.off()

```

**clustering V2, post Oct 2024 workshop**

MDE recalculated in CD8AB from the overall totalvi_20241008_rmIGTsample
```{r}
AddLatentData = function(so, latent_file, prefix, calculate_umap = F) {
    totalvi = read.csv(file = latent_file, header = T, sep = ",", row.names = 1)
    # pattern = "(IGT\\S*)_(\\d+)"
    # rownames(totalvi) = gsub(pattern, "\\1", rownames(totalvi))
    colnames(totalvi) = as.character(seq(1:ncol(totalvi)))
    #all(rownames(totalvi) == colnames(so))
    totalvi = as.matrix(totalvi)
    pattern = "^IGT\\d{1,2}\\.[A-Z]{16}$"
    matches = grepl(pattern, rownames(totalvi))
    if (!all(matches)) {
        print("updating cell names in csv file, assuming same order as seurat object" )
        #rownames(totalvi) = gsub(pattern = "(\\S*)_(\\d+)", replacement = "\\1", rownames(totalvi))
        rownames(totalvi) = colnames(so)
    }
    totalvi = totalvi[colnames(so),]
    if (all(colnames(so) == rownames(totalvi))) {
        print("all cells ARE in the latent_file")
        so[[prefix]] = CreateDimReducObject(embeddings = totalvi, key = prefix, assay = "RNA") #sprintf("totalvi_%s", prefix2)
        if (calculate_umap == T) {
            so = RunUMAP(so, dims = 1:ncol(totalvi), reduction = prefix, n.components = 2, reduction.name = sprintf("umap_%s", prefix))
        }
        return(so)
    } else {
        print("all cells ARE NOT in the latent_file")
        return(so)
    }
}


# so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241113.Rds")
so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241216.Rds")
setwd("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD8AB")
so = so_orig[,so_orig$annotation_level1 == "CD8AB"]# so = so_orig[,so_orig$annotation_level0 == "CD8AB"]

table_data = table(so$annotation_level2_oct24, so$annotation_level2)
# pdf(sprintf("%s/ClustersOct24_Newclusters.pdf", "."), width = 10, height = 10)
# 
# # Convert the table to a data frame for better readability in the PDF
# table_df <- as.data.frame(table_data)
# 
# # Create the table in the PDF
# grid.table(table_df)
# 
# # Close the PDF device
# dev.off()


dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/totalvi_20241008_rmIGTsample"
so = AddLatentData(so, latent_file = sprintf("%s/mde_totalvi_20241008_rmIGTsample_inCD8AB.csv",dir_with_file), prefix = "mde_totalvi_20241008_rmIGTsample_inCD8AB", calculate_umap = F)


pdf(sprintf("%s/MDE_totalvi_20241008_rmIGTsample_Clusters_2024113.pdf", "."), 20, 20, useDingbats = F)
DimPlot(so, reduction = "mde_totalvi_20241008_rmIGTsample_inCD8AB", group.by = "annotation_level1", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
DimPlot(so, reduction = "mde_totalvi_20241008_rmIGTsample_inCD8AB", group.by = "annotation_level2", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
DimPlot(so, reduction = "mde_totalvi_20241008_rmIGTsample_inCD8AB", group.by = "annotation_level2_oct24", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
# print(DimPlot(so, reduction = "mde_totalvi_20241008_rmIGTsample", group.by = annotation_level2_Treg, split.by = "organ_simplified", ncol = trunc(sqrt(length(unique(so$organ_simplified)))), raster = T, raster.dpi = c(512,512), label = F, pt.size = 2) + scale_color_manual(values = mypal))
dev.off()
```


```{r}

prefix = "totalvi_20241113_CD8AB_rmIGTsample"
dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD8AB/totalvi_20241113_CD8AB_rmIGTsample"
so = AddLatentData(so, latent_file = sprintf("%s/latent.csv",dir_with_file), prefix = "totalvi_20241113_CD8AB_rmIGTsample", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/mde2.csv",dir_with_file), prefix = "mde_totalvi_20241113_CD8AB_rmIGTsample", calculate_umap = F)

pdf(sprintf("%s/MDE_Clusters20241113.pdf", prefix), 20, 20, useDingbats = F)
DimPlot(so, reduction = "mde_totalvi_20241113_CD8AB_rmIGTsample", group.by = "annotation_level1", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
DimPlot(so, reduction = "mde_totalvi_20241113_CD8AB_rmIGTsample", group.by = "annotation_level2", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
DimPlot(so, reduction = "mde_totalvi_20241113_CD8AB_rmIGTsample", group.by = "annotation_level2_oct24", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
# print(DimPlot(so, reduction = "mde_totalvi_20241008_rmIGTsample", group.by = annotation_level2_Treg, split.by = "organ_simplified", ncol = trunc(sqrt(length(unique(so$organ_simplified)))), raster = T, raster.dpi = c(512,512), label = F, pt.size = 2) + scale_color_manual(values = mypal))
dev.off()

saveRDS(so, file = "igt1_96_CD8AB_20241113.Rds")

```

```{r}

prefix = "totalvi_20241113_CD8AB_rmIGTsample"
dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD8AB/totalvi_20241113_CD8AB_rmIGTsample"
so = AddLatentData(so, latent_file = sprintf("%s/latent.csv",dir_with_file), prefix = "totalvi_20241113_CD8AB_rmIGTsample", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/mde_incremental.csv",dir_with_file), prefix = "mde_incremental", calculate_umap = F)

pdf(sprintf("%s/MDE_AnnotationLevel20241216.pdf", "."), 10, 10, useDingbats = F)
MyDimPlotHighlight(so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = names(which(so_orig$annotation_level1 == "CD8AB")), highlight_column_name ="annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal, print_plot1 = T, print_plot2 = T )
DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level2", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level2", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal) + theme_void() + NoLegend() 
DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level2_parent1", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level2_parent1", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal) + theme_void() + NoLegend() 
dev.off()

# saveRDS(so, file = "igt1_96_CD8AB_20241113.Rds")
saveRDS(so, file = "igt1_96_CD8AB_20241216.Rds")



```

remove unwanted cell embeddings
totalvi_20241006 - mde2_totalvi_20241006
totalvi_20241113_CD8AB_rmIGTsample - mde_incremental
```{r}
so[["umap_totalvi_20241006"]] = NULL
so[["mde_totalvi_20241006"]] = NULL
so[["umap2_totalvi_20241006"]] = NULL
so[["mdeumap_totalvi_20241006"]] = NULL
so[["umap_totalvi_20241008_rmIGTsample"]] = NULL
so[["mde_totalvi_20241008_rmIGTsample"]] = NULL
so[["mde2_totalvi_20241008_rmIGTsample"]] = NULL
so[["mdeumap_totalvi_20241008_rmIGTsample"]] = NULL
so[["mde_totalvi_20241029_fitleredGenesProt"]] = NULL
so[["umap_totalvi_20241029_fitleredGenesProt"]] = NULL

saveRDS(so, file = "igt1_96_CD8AB_20241216.Rds")

```

**Test reintegrating the CD8B+ cells from the CD4**
totalvi_20250103_cd8_rmIGTsample - mde_incremental and mde_totalvi_20250103_cd8_rmIGTsample
```{r}
so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20241216.Rds")
so = so_orig
discordant = read.table("../DiscordantCD4_david.csv", header = F, sep = ",")[,1]
so_orig$new_level1 = so_orig$annotation_level1
so_orig$new_level1[colnames(so_orig) %in% discordant] = "CD8AB"
table(so$new_level1,so$annotation_level1 )


so = so[,so$new_level1 == "CD8AB"]# so = so_orig[,so_orig$annotation_level0 == "CD8AB"]


prefix = "totalvi_20250103_CD8AB_rmIGTsample"
dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD8AB/totalvi_20250103_CD8AB_rmIGTsample"
so = AddLatentData(so, latent_file = sprintf("%s/latent.csv",dir_with_file), prefix = "totalvi_20250103_CD8AB_rmIGTsample", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/mde2.csv",dir_with_file), prefix = "mde_totalvi_20250103_CD8AB_rmIGTsample", calculate_umap = F)
so = AddLatentData(so, latent_file = sprintf("%s/mde_incremental.csv",dir_with_file), prefix = "mde_incremental", calculate_umap = F)

pdf(sprintf("%s/MDE_20250103_test.pdf", "."), 10, 10, useDingbats = F)
MyDimPlotHighlight(so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = names(which(so$annotation_level1 == "CD4")), highlight_column_name ="annotation_level1", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level1, print_plot1 = T, print_plot2 = T )

MyDimPlotHighlight(so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = names(which(so$annotation_level1 == "CD4")), highlight_column_name ="annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level2, print_plot1 = T, print_plot2 = T )

MyDimPlotHighlight(so, umap_to_plot = "mde_totalvi_20250103_CD8AB_rmIGTsample", cells_to_highlight = names(which(so$annotation_level1 == "CD4")), highlight_column_name = "annotation_level1", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level1, print_plot1 = T, print_plot2 = T ) 

MyDimPlotHighlight(so, umap_to_plot = "mde_totalvi_20250103_CD8AB_rmIGTsample", cells_to_highlight = names(which(so$annotation_level1 == "CD4")), highlight_column_name = "annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level2, print_plot1 = T, print_plot2 = T )

MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = names(which(so$annotation_level1 == "CD4")), highlight_column_name = "annotation_level1", highlight_size = 0.5, highlight_alpha = 0.5, xlim = c(-2.5,2.5), pixels = c(512, 512), mycols = mypal_level1, print_plot1 = T, print_plot2 = T )

MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = names(which(so$annotation_level1 == "CD4")), highlight_column_name = "annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, xlim = c(-2.5,2.5), pixels = c(512, 512), mycols = mypal_level2, print_plot1 = T, print_plot2 = T )

# p = DimPlot(so, reduction = "mde_totalvi_20250103_CD8AB_rmIGTsample", group.by = "annotation_level1", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
# p
# p + theme_void() + NoLegend() 
# p = DimPlot(so, reduction = "mde_totalvi_20250103_CD8AB_rmIGTsample", group.by = "annotation_level2", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal) 
# p
# p + theme_void() + NoLegend() 
# p = DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level1", raster = F, raster.dpi = c(512,512), label = F, order = T) + scale_color_manual(values = mypal) + scale_x_continuous(limit = c(-3,3))
# p 
# p + theme_void() + NoLegend() 
# p = DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level2", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
# p
# p + theme_void() + NoLegend() 
# p = DimPlot(so, reduction = "mde2_totalvi_20241006", group.by = "annotation_level1", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
# p
# p + theme_void() + NoLegend() 
# p = DimPlot(so, reduction = "mde2_totalvi_20241006", group.by = "annotation_level2", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
# p
# p + theme_void() + NoLegend() 
dev.off()

# saveRDS(so, file = "igt1_96_CD8AB_20250103_test.Rds")

```


**Annotation 20250109**

```{r}
so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250109_level1only.Rds")
mypal_level1 = setNames(mypal, unique(so_orig$annotation_level1))
mypal_level2 = setNames(mypal, unique(so_orig$annotation_level2))
setwd("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD8AB")
so = so_orig[,so_orig$annotation_level1 == "CD8AB"]

dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/totalvi_20241008_rmIGTsample"
so = AddLatentData(so, latent_file = sprintf("%s/latent.csv",dir_with_file), prefix = "totalvi_20241008_rmIGTsample", calculate_umap = F)
dir_with_file = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD8AB/20250109_CD8AB"
so = AddLatentData(so, latent_file = sprintf("%s/mde_incremental.csv",dir_with_file), prefix = "mde_incremental", calculate_umap = F)

```

Transfer labels

```{r}
library(RcppAnnoy)

so$level2_new = as.character(so$annotation_level2_20241216)
# so$level2_new[so$annotation_level2_parent1 == "proliferating"] = "CD8AB_prolif"
so$level2_new[so$annotation_level2_parent1 == "miniverse"] = "CD8AB_miniverse"
# so$level2_new[so$annotation_level2_parent1 == "preT"] = "CD8AB_preT"
table(so$level2_new, so$annotation_level1)
table(so$level2_new, so$annotation_level2_parent1)

so$is_ref = "other"
so$is_ref[so$annotation_level1 == "CD8AB" & so$annotation_level1_20241216 == "CD8AB"] = "ref"
so$is_ref[so$annotation_level1 == "CD8AB" & so$annotation_level1_20241216 != "CD8AB"] = "query"
so$is_ref[so$annotation_level2_parent1 %in% c("miniverse")] = "other" #"proliferating", "preT"
cell_embeddings_ref = so[["totalvi_20241008_rmIGTsample"]]@cell.embeddings[so$is_ref == "ref",]
cell_embeddings_query = so[["totalvi_20241008_rmIGTsample"]]@cell.embeddings[so$is_ref == "query",]

# Use the Annoy algorithm to find nearest neighbors between query (3k) and ref (10K) datasets
n_neighbors = 30  # Number of nearest neighbors to find k =30

# Create Annoy index for ref dataset
annoy_index = new(AnnoyAngular, ncol(cell_embeddings_ref)) ##use cosine distance Angular
for (i in 1:nrow(cell_embeddings_ref)) {
  annoy_index$addItem(i - 1, cell_embeddings_ref[i, ])
}
annoy_index$build(10)  # Build the index with 10 trees

# Find nearest ref neighbors for each cell in query dataset
nn_indices <- t(sapply(1:nrow(cell_embeddings_query), function(i) {
  annoy_index$getNNsByVector(cell_embeddings_query[i, ], n_neighbors)
}))

# nn_indices gives you the indices of nearest neighbors in the ref dataset
# the rows are cells from query dataset, columns are the 30 nearest cells in the ref dataset
dim(nn_indices)
head(nn_indices)

labels_ref = as.character(so$annotation_level2_20241216[so$is_ref == "ref"])
# Transfer labels based on majority vote from nearest neighbors
transfer_labels <- apply(nn_indices, 1, function(neighbors) {
  # Get labels for the nearest neighbors
  neighbor_labels <- labels_ref[neighbors + 1]  # Add 1 for R's 1-based index
  
  # Return the most common label (majority vote)
  most_common_label <- names(sort(table(neighbor_labels), decreasing = TRUE))[1]
  return(most_common_label)
})

# Now, transfer_labels contains the predicted labels for the 3k PBMC dataset
so$level2_new[so$is_ref == "query"] = transfer_labels
head(transfer_labels)
table(transfer_labels)

table(so$annotation_level2_parent1, so$level2_new)
table(so$annotation_level1, so$level2_new)
table(so$annotation_level2_20241216, so$level2_new)

```

Check transfer and readjust clusters if needed, i.e. add new clusters
CD8AB_cl25: used to be abT DP
CD8AB_cl26: mixture
CD8AB_cl27: used to be in prolif
CD8AB_cl28: used to be in prolif

```{r}
# FeaturePlot(so, reduction = "mde_incremental",slot = "count", features = "Stmn1", order = T, raster = T, raster.dpi = c(1024,1024))

prefix_latent = "totalvi_20241008_rmIGTsample"
n_latent = ncol(so[[prefix_latent]]@cell.embeddings)
so = FindNeighbors(so, dims = 1:n_latent, reduction = prefix_latent)
so = FindClusters(so, resolution = 1, cluster.name = sprintf("Cluster_%s_Res1",prefix_latent))

pdf(sprintf("%s/MDE_annotation_20250109_TransferLabels_Reclustering_to_see.pdf", "20250109_CD8AB"), 20, 20, useDingbats = F)
DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level1", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal_level1)
DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level1_20241216", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
DimPlot(so, reduction = "mde_incremental", group.by = "level2_new", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal_level2) + ggtitle("transfer labels from annotation_level2_20241216")
DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level2_20241216", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal_level2)
DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level2_parent1", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
DimPlot(so, reduction = "mde_incremental", group.by = sprintf("Cluster_%s_Res1",prefix_latent), raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
dev.off()

so$level2_new[so$Cluster_totalvi_20241008_rmIGTsample_Res1 %in% "25" & so[["mde_incremental"]]@cell.embeddings[,1] < 1 ] = "CD8AB_cl25"
so$level2_new[so$Cluster_totalvi_20241008_rmIGTsample_Res1 %in% "15" & so[["mde_incremental"]]@cell.embeddings[,1] > 0 ] = "CD8AB_cl26"
so$level2_new[so$Cluster_totalvi_20241008_rmIGTsample_Res1 %in% "13" ] = "CD8AB_cl27"
so$level2_new[so$Cluster_totalvi_20241008_rmIGTsample_Res1 %in% "20" ] = "CD8AB_cl28"
so$level2_new[so$level2_new  %in% c("CD8AB_cl19")] = "CD8AB_prolif"

# DimPlot(so, reduction = "mde_incremental", cells = names(so$level2_new[so$Cluster_totalvi_20241008_rmIGTsample_Res1 %in% "25" & so[["mde_incremental"]]@cell.embeddings[,1] < 1 ]), raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal_level2)

#rerun annotation_level2_parent1 since new annotated cells from transfer labels etc
so$annotation_level2_parent1[so$level2_new %in% c("CD8AB_cl25", "CD8AB_cl26","CD8AB_cl28" ) ] = "activated"
so$annotation_level2_parent1[so$level2_new %in% c("CD8AB_cl27") ] = "resting"
so$annotation_level2_parent1[so$level2_new %in% c("CD8AB_cl10", "CD8AB_cl11", "CD8AB_cl12", "CD8AB_cl13", "CD8AB_cl14", "CD8AB_cl15", "CD8AB_cl18", "CD8AB_cl20", "CD8AB_cl6", "CD8AB_cl7","CD8AB_cl25", "CD8AB_cl26","CD8AB_cl28")] = "activated"
so$annotation_level2_parent1[so$level2_new  %in% c("CD8AB_cl1", "CD8AB_cl2", "CD8AB_cl22", "CD8AB_cl4", "CD8AB_cl5","treg_cl1", "treg_cl7", "CD8AB_cl27")] = "resting"
so$annotation_level2_parent1[so$level2_new  %in% c("CD8AB_prolif")] = "proliferating"
table(so$annotation_level2_parent1, so$level2_new)

pdf(sprintf("%s/MDE_annotation_20250109_level2.pdf", "20250109_CD8AB"), 20, 20, useDingbats = F)
DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level1", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal_level1)
DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level1_20241216", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
DimPlot(so, reduction = "mde_incremental", group.by = "level2_new", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal) + ggtitle("After transfer labels and reclustering")
DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level2_20241216", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal_level2)
DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level2_parent1", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal)
dev.off()

if (all(colnames(so_orig)[so_orig$annotation_level1 == "CD8AB"] == colnames(so))) {
    print("True")
    so_orig$annotation_level2[so_orig$annotation_level1 == "CD8AB"] = so$level2_new[colnames(so_orig)[so_orig$annotation_level1 == "CD8AB"]]
    so_orig$annotation_level2_parent1[so_orig$annotation_level1 == "CD8AB"] = so$annotation_level2_parent1[colnames(so_orig)[so_orig$annotation_level1 == "CD8AB"]]
}

table(so_orig$annotation_level2_parent1, so_orig$annotation_level2)

#Export to save awaiting the other annotations
annot = data.frame(cell_id = colnames(so_orig), so_orig@meta.data[,c("annotation_level1", "annotation_level2", "annotation_level2_parent1", "nonconv_tcr_recog")])
colnames(annot) = c("cell_id", "level1", "level2", "level2_parent1", "nonconv_tcr_recog")
table(annot$level2_parent1, annot$level1)
sum(rowSums(apply(annot,2,is.na)))
write.table(x = annot, file = "../annotation_table_20250109_withlevel2CD8AB.csv", row.names = F, quote = F, sep = ",")


```

Check Prolif clusters

```{r}

setwd("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD8AB")
so = so_orig[,so_orig$annotation_level1 == "CD8AB"]
so = NormalizeData(so)
so$is_prolif = so$S.Score >0.07 | so$G2M.Score >0.2

pdf(sprintf("%s/Prolif_scores_MDE.pdf","."), 20, 20, useDingbats = F)
FeaturePlot(so, reduction = "mde_incremental", slot = "data", features = "S.Score", order = F, raster = T, raster.dpi = c(1024,1024))
FeaturePlot(so, reduction = "mde_incremental", slot = "data", features = "G2M.Score", order = F, raster = T, raster.dpi = c(1024,1024))
DimPlot(so, reduction = "mde_incremental", group.by = "is_prolif", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = c("grey", "red"))
MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = names(which(so$is_prolif == "TRUE")), highlight_column_name ="is_prolif", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = c("grey", "red"), label = F, print_plot1 = T, print_plot2 = F )
MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = names(which(so$annotation_level2_parent1 == "proliferating")), highlight_column_name ="annotation_level2_parent1", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level2_parent1, label = F, print_plot1 = T, print_plot2 = F )
dev.off()

so$is_prolif = NULL
```



**Kaplan's data**

```{r}

pdf("MDE_Kaplan.pdf", 12, 12, useDingbats = F)
DimPlot(so[,so$IGT == "IGT46"], reduction = "mde_incremental", group.by = "sample_name_david", raster = F, raster.dpi = c(512,512), label = F) + scale_color_manual(values = mypal)
DimPlot(so[,so$IGT == "IGT46"], reduction = "mde_incremental", group.by = "sample_name_david", raster = F, raster.dpi = c(512,512), label = F) + scale_color_manual(values = mypal) + NoLegend()
DimPlot(so[,so$IGT == "IGT46"], reduction = "mde_incremental", group.by = "annotation_level2", split.by = "sample_name_david", raster = F, raster.dpi = c(512,512), label = F, ncol = 4) + scale_color_manual(values = mypal) + NoLegend()
DimPlot(so[,so$IGT == "IGT46"], reduction = "mde_incremental", group.by = "annotation_level2", split.by = "condition_detailed_organ", raster = F, raster.dpi = c(512,512), label = F, ncol = 3) + scale_color_manual(values = mypal)
DimPlot(so[,so$IGT == "IGT46"], reduction = "mde_incremental", group.by = "annotation_level2", split.by = "condition_detailed_organ", raster = F, raster.dpi = c(512,512), label = F, ncol = 3) + scale_color_manual(values = mypal) + NoLegend()
dev.off()



DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level2", raster = T, raster.dpi = c(2048,2048), label = T) + scale_color_manual(values = mypal)
DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level2_oct24", raster = T, raster.dpi = c(2048,2048), label = T) + scale_color_manual(values = mypal)
# print(DimPlot(so, reduction = "mde_totalvi_20241008_rmIGTsample", group.by = annotation_level2_Treg, split.by = "organ_simplified", ncol = trunc(sqrt(length(unique(so$organ_simplified)))), raster = T, raster.dpi = c(512,512), label = F, pt.size = 2) + scale_color_manual(values = mypal))
dev.off()

```



