---
title: "composition_analysis"
output: html_document
date: "2024-10-24"
author: "David Zemmour"
editor_options: 
  chunk_output_type: console
---

**Initialize: load libraries and custom functions**

```{bash}
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=jfkfloor2 --qos=jfkfloor2 --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=beagle3-bigmem --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=zemmour-hm --qos=zemmour --nodes=1 
sinteractive --time=03:00:00 --account=pi-zemmour --partition=caslake --nodes=1 --mem=96GB

module load python/anaconda-2022.05 
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13
source activate /project/zemmour/david/envs/scvi_20240315
#source activate /project/zemmour/david/envs/r443 -->
module load openblas/0.3.13

cd /project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/
R
```

```{r}
setwd("~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/")
libs = c("fastTopics", "flashier", "Seurat", "tidyr", "ggplot2", "dplyr", "RColorBrewer", "pals", "scales", "reshape2", "pheatmap", "scattermore", "limma", "ggbeeswarm") 
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))
source("/project/jfkfloor2/zemmourlab/david/immgent/immgent_integration_git/custom_functions_david.R")
source("/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/analysis/immgent_integration_git/custom_functions_david.R")


ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
ColorRamp = rev(rainbow(10, end = 4/6))
ColorRamp = rev(viridis(100))
ColorRamp = brewer.pal(9, "Blues")

mypal_list = readRDS("/project/jfkfloor2/zemmourlab/david/immgent/immgent_integration_git/immgent_color_palettes/20250709/immgent_color_palettes_list_20250709.Rds")
mypal_list = readRDS("/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/analysis/immgent_integration_git/immgent_color_palettes/20250709/immgent_color_palettes_list_20250709.Rds")
mypal_level1 = mypal_list[["level1"]]
mypal_level2_all = mypal_list[["level2_all"]]
mypal_level2 = c(mypal_list[["CD4"]], mypal_list[["CD8"]], mypal_list[["Treg"]], mypal_list[["gdT"]], mypal_list[["nonconv"]], mypal_list[["CD8aa"]], mypal_list[["DN"]], mypal_list[["DP"]],mypal_list[["thymocyte"]])
mypal_organ = mypal_list[["organ_simplified"]]

#mycol = c("black","blue","red","darkgreen", "orange","purple", "cyan", "greenyellow",    "salmon", "magenta","pink", "tan", "brown") # c("magenta", "red",  "darkgreen", "cyan", "blue", "blue", "blue", "black", "blue", "blue", "blue", "blue", "orange")

n = 70
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
mypal1 = unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals))))
mypal1 = mypal1[-4]

library("pals")
parade = function(n) { return(Seurat::DiscretePalette(n, palette = "parade", shuffle = F)) }

length(glasbey())
length(polychrome())
mypal = c(glasbey(), polychrome(), mypal1)
names(mypal) = NULL

mypal_condition_detailed_simplified = setNames(mypal, unique(so$condition_detailed_simplified))
mypal_condition_detailed_simplified = mypal_condition_detailed_simplified[!is.na(names(mypal_condition_detailed_simplified))]

mypal_igt = setNames(mypal, unique(so$IGT))
mypal_igt = mypal_igt[!is.na(names(mypal_igt))]

```

**Load data and models**

Seurat object
```{r}
prefix = "SampleComp/20250226"
# prefix2 = "flashier/20250709_expoPropInLevel1"
prefix2 = "flashier/20250312"

# so_orig = readRDS("igt1_96_withtotalvi20250226.Rds")
so_orig = readRDS("/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250710_clean_ADTonly.Rds")
so = so_orig

```

prop_data and mdata
mdata_sl1 from annotation_level2_PropPerSamplePerLevel1_withMetadata.Rds
mdata_s from annotation_level2_PropPerSample.txt
```{r}
# prop_data = read.table(file = sprintf("%s/annotation_level2_PropPerSample.txt", prefix), header = T, sep = "\t" ) # --> mdata_s
prop_data = readRDS(file = sprintf("%s/annotation_level2_PropPerSamplePerLevel1_withMetadata.Rds", prefix)) %>% select(IGTHT, ends_with("ncells"), ends_with("prop")) # --> mdata_sl1
colnames(prop_data) = gsub(pattern = "gdT_52", replacement = "gdT_cl52", x = colnames(prop_data))
colnames(prop_data) = gsub(pattern = "gdT_54", replacement = "gdT_cl54", x = colnames(prop_data))

m = read.table('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/exp_id/sample_metadata/Sample_metadata_david_20250628_v10.csv',header = T, sep = ",")

# changing here and not in the original file to keep consistent with the database
colnames(m)
m$IGT_10xlane_id = NULL
m$organism_id = NULL
m$IGT = m$immgent_IGT_10xlane_id
m$immgent_IGT_10xlane_id = NULL
m$HT = m$hashtag_number
m$hashtag_number = NULL
m$sample_id = NULL
m$count_unique = NULL

m$sample_code.1 = NULL

mdata = merge(prop_data, m, by.x = "IGTHT", by.y = "IGTHT",all.x = T, all.y = F, suffixes = c(".x", ""))

mdata$organ_simplified = factor(mdata$organ_simplified, levels = c("blood","spleen","LN","SLO","bone marrow","thymus",
                                                                   "lung", "liver", "peritoneal cavity",
                                                                   "colon epi","small intestine epi","colon LP","small intestine LP","skin",
                                                                   "mammary gland","uterus", "placenta", "prostate","submandibular gland","kidney", "pancreas","CNS","synovial fluid"))
#any(is.na(mdata$organ_simplified))

mdata$condition_detailed_simplified = factor(mdata$condition_detailed_simplified)
mdata$condition_detailed_simplified = relevel(mdata$condition_detailed_simplified, ref = "baseline")


mdata_s = mdata #mdata_sl1 = mdata
mdata_sl1 = mdata #mdata_sl1 = mdata

```

Topic fit
```{r}
fit = readRDS(sprintf("%s/%s/fit.Rds", prefix,prefix2))

res = ldf(fit, type = "i")
L1 = with(res, L %*% diag(D)) #same as res$F %*% diag
rownames(L1) == mdata$sample_code
colnames(L1) = paste("F", 1:ncol(L1), sep = "")

```


**Heatmap clusters x samples**

```{r}

mdata = mdata %>% arrange(organ_simplified, condition_detailed_simplified)
rownames(mdata) = mdata$IGTHT
df = mdata %>% select(ends_with("prop"))

pheatmap(df, cluster_rows = F, cluster_cols = F, display_numbers = F, color = c("white",brewer.pal(9, "Reds")))
pheatmap(df, cluster_rows = T, cluster_cols = F, display_numbers = F, color = c("white",brewer.pal(9, "Reds")))

```
on annotation_level2_PropPerSamplePerLevel1_withMetadata.Rds --> annotation_level2_PropPerSamplePerLevel1_heatmap.pdf , c("white", brewer.pal(9, "RdPu")) better
on annotation_level2_PropPerSample.txt --> annotation_level2_PropPerSample_heatmap.pdf
```{r}
# assume df is your numeric matrix (rownames = original rows, colnames = original cols)
mdata = mdata %>% arrange(organ_simplified, condition_detailed_simplified)
df = mdata %>% select(IGTHT, organ_simplified, condition_detailed_simplified, ends_with("prop"))
df_long = melt(df)
# df2 = mdata %>% select(IGTHT, organ_simplified, condition_detailed_simplified, ends_with("ncells"))
# # df$IGTHT = rownames(df)
# df_long1 = melt(df)
# df_long2 = melt(df2)
# all(df_long1$IGTHT == df_long2$IGTHT)
# df_long = data.frame(qsdf_long1, ncells = df_long2$value)
# df_long$value[df_long$ncells <5] = 0
# # length(which(df_long$ncells > 0 & df_long$ncells < 5))

df_long$annotation_level1 = NA
df_long$annotation_level1[grepl("CD8_", df_long$variable)] = "CD8"
df_long$annotation_level1[grepl("CD4_", df_long$variable)] = "CD4"
df_long$annotation_level1[grepl("Treg_", df_long$variable)] = "Treg"
df_long$annotation_level1[grepl("gdT_", df_long$variable)] = "gdT"
df_long$annotation_level1[grepl("CD8aa_", df_long$variable)] = "CD8aa"
df_long$annotation_level1[grepl("nonconv_", df_long$variable)] = "nonconv"
df_long$annotation_level1[grepl("DN_", df_long$variable)] = "DN"
df_long$annotation_level1[grepl("DP_", df_long$variable)] = "DP"
df_long$annotation_level1[grepl("thymocyte", df_long$variable)] = "thymocyte"
df_long$annotation_level1 = factor(df_long$annotation_level1, levels = c("CD8", "CD4", "Treg", "gdT", "CD8aa", "nonconv", "DN", "DP", "thymocyte"))
df_long$IGTHT = factor(df_long$IGTHT, levels = mdata$IGTHT)


heatmap_plot = ggplot(df_long, aes(x = variable, y = IGTHT, fill = value)) +
  geom_tile() +
  # facet into strips by level1, free x-scale and free x-space gives a visible gap
  facet_grid(. ~ annotation_level1,
             scales = "free_x",
             space  = "free_x") +
  scale_fill_gradientn(
    # colours = c("white", brewer.pal(9, "RdPu")),
    colours = c("white",rev(rocket(10))), 
    name    = "value"
  ) +
  theme_minimal() +
  theme(
    # rotate your variable names
    axis.text.x = element_text(angle = 45, hjust = 1),

    # blow away the grid lines
    # panel.grid = element_blank(),
    panel.grid.major   = element_line(color = "grey80", linewidth = 0.2),
    panel.grid.minor   = element_line(color = "grey90", linewidth = 0.1),

    # widen the gap between facets
    panel.spacing.x = unit(0.5, "cm"),

    # you can style or remove those facet‐strips:
    strip.background = element_blank(),
    strip.text.x = element_text(face = "bold")
  )

heatmap_plot

annot_df <- df %>% 
  select(IGTHT, organ_simplified, condition_detailed_simplified) %>% 
  pivot_longer(-IGTHT, names_to = "anno", values_to = "value")
annot_df$IGTHT = factor(annot_df$IGTHT, levels = mdata$IGTHT)

# 3. discrete colours for your two annotation tracks
organ_cols = mypal_organ

cond_cols = mypal_condition_detailed_simplified#setNames( mypal, unique(df$condition_detailed) )
cond_cols["baseline"] = "grey"
cond_cols[names(cond_cols) != "baseline"] = "red3"


# 4. make the annotation heatmap
anno_plot <- ggplot(annot_df, aes(x = anno, y = IGTHT, fill = value)) +
  geom_tile() +
  scale_fill_manual(
    values = c(organ_cols, cond_cols)
    # guide  = "none"
  ) +
    facet_grid(. ~ anno,
             scales = "free_x",
             space  = "free_x") +
  theme_minimal() +
  theme(
      panel.spacing.x = unit(0, "cm"),
    axis.text.y      = element_blank(),
axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title       = element_blank(),
    panel.grid       = element_blank(),
    plot.margin      = margin(5,0,5,5)
  )
anno_plot

# 5. combine with patchwork give the annotation panel a small fixed width
# pdf(sprintf("%s/annotation_level2_PropPerSamplePerLevel1_heatmap.pdf", prefix), width = 25, 10,useDingbats = F)
pdf(sprintf("%s/annotation_level2_PropPerSample_heatmap.pdf", prefix), width = 25, 10,useDingbats = F)
anno_plot + NoLegend() + heatmap_plot + plot_layout(widths = c(0.1, 1))
anno_plot + heatmap_plot + plot_layout(widths = c(0.1, 1))
dev.off()

```

**Show one sample**

CD8 in I40H8_smallintestineLP_LCMVarm_D60_allT_P14_SMARTA_mouse0142 to show Trm at memory timepoint
I9H10_smallintestineLP_allT_mouse0018 to show rare Trm at baseline

```{r}
mdata = mdata_sl1
mdata = mdata_s
# mdata = mdata %>% arrange(organ_simplified, condition_detailed_simplified)
# df = mdata %>% select(IGTHT, organ_simplified, condition_detailed_simplified, ends_with("prop"))
# df_long = melt(df)
# df_long$variable = gsub("\\.prop", "",df_long$variable)

mdata = mdata %>% arrange(organ_simplified, condition_detailed_simplified)
df = mdata %>% select(IGTHT, organ_simplified, condition_detailed_simplified, ends_with("prop"))
df_long = melt(df)
df_long$annotation_level1 = NA
df_long$annotation_level1[grepl("CD8_", df_long$variable)] = "CD8"
df_long$annotation_level1[grepl("CD4_", df_long$variable)] = "CD4"
df_long$annotation_level1[grepl("Treg_", df_long$variable)] = "Treg"
df_long$annotation_level1[grepl("gdT_", df_long$variable)] = "gdT"
df_long$annotation_level1[grepl("CD8aa_", df_long$variable)] = "CD8aa"
df_long$annotation_level1[grepl("nonconv_", df_long$variable)] = "nonconv"
df_long$annotation_level1[grepl("DN_", df_long$variable)] = "DN"
df_long$annotation_level1[grepl("DP_", df_long$variable)] = "DP"
df_long$annotation_level1[grepl("thymocyte", df_long$variable)] = "thymocyte"
df_long$annotation_level1 = factor(df_long$annotation_level1, levels = c("CD8", "CD4", "Treg", "gdT", "CD8aa", "nonconv", "DN", "DP", "thymocyte"))
df_long$IGTHT = factor(df_long$IGTHT, levels = mdata$IGTHT)
df_long$variable = gsub("\\.prop", "",df_long$variable)
which(is.na(df_long$variable))
unique(df_long$variable)[!unique(df_long$variable) %in% levels(so$annotation_level2)]
df_long$variable = factor(df_long$variable, levels = levels(so$annotation_level2))

# p1 = ggplot(df_long) + geom_point(aes(variable, value, colour =variable )) + 
#     facet_grid(. ~ annotation_level1,
#              scales = "free_x",
#              space  = "free_x") + 
#   theme_minimal() +
#     scale_color_manual(values = mypal_level2) +
#   theme(
#     panel.grid.major = element_line(color = "grey90", linewidth = 0.2),
#     axis.text.x = element_text(angle = 45, hjust = 1)
#   ) +
#   labs(
#     x = "",
#     y = "Proportion",
#     color = "Population"
#   )
# p1 + NoLegend()

# pdf("paper_cosmology/figures/bits/barplot_example_sample_sl1.pdf", width = 15, 5,useDingbats = F)
pdf("paper_cosmology/figures/bits/barplot_example_sample_s.pdf", width = 15, 5,useDingbats = F)
p1 = ggplot(df_long, aes(x = variable, y = value, alpha = 0.5), fill = "grey") +
  geom_boxplot(outlier.shape = NA) 

example = df_long %>% filter(IGTHT == "I40H8")
# p2 = geom_bar(data = example, mapping = aes(variable, value, fill =variable ), stat = "identity")
p2 = geom_point(data = example, mapping = aes(variable, value, color =variable, size = 1, alpha = 1))
p = p1+p2 + facet_grid(. ~ annotation_level1,        # your small‐multiples layout
             scales = "free_x",
             space  = "free_x") +
  theme_minimal() +
  # scale_fill_manual(values = mypal_level2) +
    scale_color_manual(values = mypal_level2) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = 0.2),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    legend.position   = "none"             # hide legend if you don't need it
  ) +
  labs(
    x     = NULL,
    y     = "Proportion",
    fill  = "Population"
  ) + 
    ggtitle("I40H8_smallintestineLP_LCMVarm_D60_allT_P14_SMARTA_mouse0142")

print(p + NoLegend() + NoGrid())

example = df_long %>% filter(IGTHT == "I9H10")
# p2 = geom_bar(data = example, mapping = aes(variable, value, fill =variable ), stat = "identity")
p2 = geom_point(data = example, mapping = aes(variable, value, color =variable, size = 2, alpha = 1))
p = p1+p2 + facet_grid(. ~ annotation_level1,        # your small‐multiples layout
             scales = "free_x",
             space  = "free_x") +
  theme_minimal() +
  # scale_fill_manual(values = mypal_level2) +
    scale_color_manual(values = mypal_level2) +
  theme(
    panel.grid.major = element_line(color = "grey90", linewidth = 0.2),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    legend.position   = "none"             # hide legend if you don't need it
  ) +
  labs(
    x     = NULL,
    y     = "Proportion",
    fill  = "Population"
  ) + 
    ggtitle("I9H10_smallintestineLP_allT_mouse0018")
print(p + NoLegend() + NoGrid())

dev.off()


```



```{r}
# prefix2 = "flashier/20250709_expoPropInLevel1"
 prefix2 = S/flashier/20250312

ensure_directory(sprintf("%s/%s", prefix,prefix2))
ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdBu"))(100))
```


**Figures**


```{r}
prefix = "SampleComp/20250226"
prefix2 = "flashier/20250709_expoPropInLevel1"

# so_orig = readRDS("igt1_96_withtotalvi20250226.Rds")
so_orig = readRDS("/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250710_clean_ADTonly.Rds")

mdata_orig = readRDS(file = sprintf("%s/annotation_level2_PropPerSamplePerLevel1_withMetadata.Rds", prefix))
mdata

fit = readRDS(sprintf("%s/%s/fit.Rds", prefix,prefix2))
props = read.table(file = sprintf("%s/annotation_level2_PropPerSamplePerLevel1.txt", prefix))


res = ldf(fit, type = "i")
L1 = with(res, L %*% diag(D)) #same as res$F %*% diag
rownames(L1) == mdata$sample_code
colnames(L1) = paste("F", 1:ncol(L1), sep = "")


```

```{r}

pheatmap(as.dist(1-cor(t(L1))), color = rev(ColorRamp))
```



Structure plot


F1: Resting
F2: IEL
F3: Rorc
F4: activated?
F5: prolif acute activation
F6: 


```{r}

topic_colors = glasbey(6)
L1 = ldf(fit, type = "i")$L
L1 = L1/rowSums(L1)
rownames(L1) == mdata$sample_code
colnames(L1) = paste("F", 1:ncol(L1), sep = "")

mdata$organ_simplified = factor(mdata$organ_simplified, levels = c("blood","spleen","LN","SLO","bone marrow","thymus",
                                                                   "lung", "liver", "peritoneal cavity",
                                                                   "colon epi","small intestine epi","colon LP","small intestine LP","skin",
                                                                   "mammary gland","uterus", "placenta", "prostate","submandibular gland","kidney", "pancreas","CNS","synovial fluid"))

pdf(sprintf("%s/%s/structure_plots.pdf", prefix,prefix2), 15,5, useDingbats = F)
structure_plot(L1,grouping = mdata$organ_simplified,topics = 6:1,
               loadings_order = "embed",colors = mypal1, gap = 5) +
  labs(y = "membership") +
  theme(axis.text.x = element_text(angle = 30,hjust = 0.5))

structure_plot(L1,grouping = mdata$organ_simplified,topics = 6:1,
               loadings_order = "embed",colors = mypal1, gap = 5) +
  labs(y = "membership") +
  theme(axis.text.x = element_text(angle = 30,hjust = 0.5))

structure_plot(L1[mdata$condition_broad == "healthy",],grouping = mdata$organ_simplified[mdata$condition_broad == "healthy"],topics = 6:1,
               loadings_order = "embed",colors = mypal1, gap = 5) +
  labs(y = "membership") +
  theme(axis.text.x = element_text(angle = 30,hjust = 0.5))

#resting and activated factors
structure_plot(L1[mdata$condition_broad == "healthy",],grouping = mdata$organ_simplified[mdata$condition_broad == "healthy"],topics = c(5,4,1),
               loadings_order = "embed",colors = mypal1, gap = 5) +
  labs(y = "membership") +
  theme(axis.text.x = element_text(angle = 30,hjust = 0.5))

grps = factor(mdata$organ_simplified[mdata$condition_broad != "healthy"], levels = intersect(levels(mdata$organ_simplified),unique(mdata$organ_simplified[mdata$condition_broad != "healthy"])))
structure_plot(L1[mdata$condition_broad != "healthy",],grouping = grps,topics = c(5,4,1),
               loadings_order = "embed",colors = mypal1, gap = 5) +
    labs(y = "membership") +
    theme(axis.text.x = element_text(angle = 30,hjust = 0.5))

#IEL and Rorc
structure_plot(L1[mdata$condition_broad == "healthy",],grouping = mdata$organ_simplified[mdata$condition_broad == "healthy"],topics = c(3,2),
               loadings_order = "embed",colors = mypal1, gap = 5) +
  labs(y = "membership") +
  theme(axis.text.x = element_text(angle = 30,hjust = 0.5))

grps = factor(mdata$organ_simplified[mdata$condition_broad != "healthy"], levels = intersect(levels(mdata$organ_simplified),unique(mdata$organ_simplified[mdata$condition_broad != "healthy"])))
structure_plot(L1[mdata$condition_broad != "healthy",],grouping = grps,topics = c(3,2),
               loadings_order = "embed",colors = mypal1, gap = 5) +
    labs(y = "membership") +
    theme(axis.text.x = element_text(angle = 30,hjust = 0.5))


dev.off()



###
pdf(sprintf("%s/%s/structure_plot.pdf", prefix, prefix2), 10, 8, useDingbats = F)
plot(fit,
     kset = 1:2,
     pm_subset =,
     plot_type = "structure",
     pm_which = "loadings",
     pm_groups = mdata$organ_simplified,
     pm_colors = mypal_organ,
     gap = 5) #+ NoLegend()

plot(fit,
     include_scree = F,
     plot_type = "structure",
     pm_which = "factors",
     pm_groups = cluster_meta$annotation_level1,
     pm_colors = mypal_organ,
     gap = 5) #+ NoLegend()

dev.off()

```

boxplots
```{r}

df = data.frame(mdata, L1)
df2 = df %>% 
  filter(!organ_simplified %in% "SLO") %>%
  mutate(is_healthy = factor(condition_broad %in% "healthy", levels = c(TRUE, FALSE),
                             labels = c("Healthy","Not healthy")))


p = ggplot(df2) +
    geom_boxplot(aes(x = organ_simplified, y = F1, fill = organ_simplified), alpha = 0.6, outlier.shape = NA) +  # Remove outliers from the boxplot
    geom_jitter(aes(x = organ_simplified, y = F1), width = 0.2, alpha = 1, size = 0.5) +
    # geom_text(data = subset(summary_data, sum_value > 1), aes(x = annotation_level1, y = sum_value, label = annotation_level2), 
    #           size = 3, vjust = -0.5, color = "black") +
    scale_fill_manual(values = mypal_organ) +
    theme_minimal() +
    labs(
        x = "",
        y = "",
        title = "",
        fill = ""
    ) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))  +
    NoLegend()


p = ggplot(df2) +
    geom_boxplot(aes(x = organ_simplified, y = F1, fill = organ_simplified, group = interaction(organ_simplified, is_healthy)), alpha = 0.6, outlier.shape = NA) +  # Remove outliers from the boxplot
    # geom_jitter(aes(x = organ_simplified, y = F1), width = 0.2, alpha = 1, size = 0.5) +
    # geom_text(data = subset(summary_data, sum_value > 1), aes(x = annotation_level1, y = sum_value, label = annotation_level2), 
    #           size = 3, vjust = -0.5, color = "black") +
    scale_fill_manual(values = mypal_organ) +
    theme_minimal() +
    labs(
        x = "",
        y = "",
        title = "",
        fill = ""
    ) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))  #+ NoLegend()
p


```


Heatmap clusters factors

```{r}
F1 = ldf(fit, type = "i")$F
top_cl <- apply(F1, 2, order, decreasing = TRUE)[1:10, ]
top_cl <- rownames(fit$F_pm)[top_cl]
plot(fit,
     plot_type = "heatmap",
     pm_which = "factors",
     pm_subset = top_cl,
     pm_groups = factor(top_cl, levels = unique(top_cl)),
     kset = 1:6,
     gap = 0.2)
```






