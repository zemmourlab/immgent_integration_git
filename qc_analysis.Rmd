---
title: "QC_IGT"
output: html_document
date: "2025-05-05"
editor_options: 
  chunk_output_type: console
---


**Initialize: load libraries and custom functions**

```{r}
setwd('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/analysis/data_integration/IGT1_96/QC')

libs = c("Seurat","BPCells", "ggrepel", "ggplot2", "dplyr", "reshape2", "ggrastr", "RColorBrewer", "pals", "scales", "pheatmap") 
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))

options(Seurat.object.assay.version = 'v5')

ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
ColorRamp = rev(rainbow(10, end = 4/6))
ColorRamp = rev(viridis(100))

#mycol = c("black","blue","red","darkgreen", "orange","purple", "cyan", "greenyellow",    "salmon", "magenta","pink", "tan", "brown") # c("magenta", "red",  "darkgreen", "cyan", "blue", "blue", "blue", "black", "blue", "blue", "blue", "blue", "orange")

n = 70
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
mypal1 = unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals))))
mypal1 = mypal1[-4]

library("pals")
parade = function(n) { return(Seurat::DiscretePalette(n, palette = "parade", shuffle = F)) }

length(glasbey())
length(polychrome())
mypal = c(glasbey(), polychrome(), mypal1)
names(mypal) = NULL
#pal.bands(glasbey(), polychrome(), parade(), main="Colormap suggestions")

#pdf("mypal.pdf", 10, 10)
#pie(rep(1,n), col=unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))) )
#pie(rep(1,n), col=unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))), labels =  unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))))
#dev.off()

ReorderIGT = function(igt = sample_qc$IGT) {
    extract_numeric = function(x) { as.numeric(gsub("\\D", "", x)) }
    ordered_vector = unique(igt)[order(extract_numeric(unique(igt)))] %>% as.character()
    igt = factor(igt, levels = ordered_vector)
    return(igt)
}

```

**QC RNA and ADT per IGT or per sample**
per IGT or per sample
ncount_RNA
nfeature_RNA
ncount_ADT

Load and prepare data frame
```{r}
library(dplyr)
library(ggplot2)
library(ggrepel)

sample_qc = read.table('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/analysis/data_integration/IGT1_96/QC/Sample_metadata_withQC_IGT1-96.csv', header = T, sep = ",")
sample_qc$IGT = sample_qc$immgent_IGT_10xlane_id


sample_qc = sample_qc %>% filter(IGT %in% c(
    "IGT1","IGT2","IGT3","IGT5","IGT6","IGT7","IGT8","IGT9",
    "IGT10","IGT11","IGT12","IGT13","IGT14","IGT15","IGT16","IGT17","IGT18","IGT19",
    "IGT20","IGT21","IGT22","IGT23","IGT24","IGT25","IGT26","IGT27","IGT28","IGT29",
    "IGT30","IGT31","IGT32","IGT33","IGT35","IGT36","IGT37","IGT38","IGT39","IGT40",
    "IGT43","IGT44","IGT45","IGT46","IGT47","IGT48","IGT49",
    "IGT50","IGT51","IGT52","IGT54","IGT55","IGT56","IGT58","IGT59",
    "IGT60","IGT61","IGT64","IGT65","IGT66","IGT67","IGT68","IGT69",
    "IGT70","IGT73","IGT74","IGT75","IGT76","IGT77","IGT78","IGT79",
    "IGT80","IGT81","IGT82","IGT85","IGT87","IGT88",
    "IGT90","IGT91","IGT92","IGT95","IGT96"
))

sample_qc$IGT = ReorderIGT(sample_qc$IGT)

# unique(so_orig$IGT)
# unique(sample_qc$IGT)
# colnames(sample_qc)
```

QC boxplot across all experiments
```{r}
igt_qc = sample_qc %>% 
    group_by(IGT) %>% 
    summarize(ncells_preqc = sum(ncells_preqc), 
              ncells_outliers_nGenes = sum(ncells_outliers_nGenes),
              ncells_outliers_deadcells = sum(ncells_outliers_deadcells),
              ncells_outliers_lowCountADT = sum(ncells_outliers_lowCountADT),
              ncells_outliers_autofluorescence = sum(ncells_outliers_autofluorescence),
              ncells_nonTcells = sum(ncells_nonTcells),
              ncells_postqc = sum(ncells_postqc)) %>% 
        mutate(percent_postqc = ncells_postqc / ncells_preqc*100, 
               percent_RNA_nGenes = ncells_outliers_nGenes / ncells_preqc*100,
               percent_RNA_deadcells = ncells_outliers_deadcells / ncells_preqc*100,
               percent_Protein_lowCount= ncells_outliers_lowCountADT / ncells_preqc*100,
               percent_Protein_nonspecific_signal= ncells_outliers_autofluorescence / ncells_preqc*100,
               percent_nonTcells = ncells_nonTcells / ncells_preqc*100
               )

igt_qc_melt = melt(igt_qc, id.vars = "IGT")

vars_keep <- c(
  "percent_postqc", "percent_RNA_nGenes","percent_RNA_deadcells",
  "percent_Protein_lowCount", "percent_Protein_nonspecific_signal",
  "percent_nonTcells"
)

df <- igt_qc_melt %>%
  filter(variable %in% vars_keep) %>%
  group_by(variable) %>%
  mutate(
    q1 = quantile(value, 0.25, na.rm = TRUE),
    q3 = quantile(value, 0.75, na.rm = TRUE),
    iqr = q3 - q1,
    is_outlier = value < (q1 - 1.5 * iqr) | value > (q3 + 1.5 * iqr)
  ) %>%
  ungroup()

p <- ggplot(df, aes(x = variable, y = value)) +
  geom_boxplot() +
  geom_jitter(aes(color = IGT), width = 0, size = 2) +
  geom_text_repel(
    data = df %>% filter(is_outlier),
    aes(label = IGT, color = IGT),
    max.overlaps = getOption("ggrepel.max.overlaps", default = 30)
  ) +
  scale_color_manual(values = mypal) +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x  = element_text(angle = 75, vjust = 0.5, size = 10)) +
  ggtitle("QC RNA and Protein by IGT") +
  NoLegend() + NoGrid()

pdf("QC_RNA_ADT_IGT.pdf", 10,8, useDingbats = F)
print(p)
dev.off()

```

QC per IGT (shows each HT)
```{r}
sample_qc = sample_qc %>% mutate(percent_postqc = ncells_postqc / ncells_preqc*100, 
                     percent_RNA_nGenes = ncells_outliers_nGenes / ncells_preqc*100,
                     percent_RNA_deadcells = ncells_outliers_deadcells / ncells_preqc*100,
                     percent_Protein_lowCount= ncells_outliers_lowCountADT / ncells_preqc*100,
                     percent_Protein_nonspecific_signal= ncells_outliers_autofluorescence / ncells_preqc*100,
                     percent_nonTcells = ncells_nonTcells / ncells_preqc*100
                     )

sample_qc_melt = melt(sample_qc, id.vars = c("IGT", "hashtag_number"))


pdf("QC_RNA_ADT_perIGT.pdf", 10,8, useDingbats = F)
for (i in levels(sample_qc_melt$IGT)) {
    pdf(sprintf("QC_RNA_ADT_%s.pdf", i), 10,8, useDingbats = F)
    print(i)
    sample_qc_melt_sub = sample_qc_melt %>% 
        filter(IGT == i & variable %in% c("percent_postqc", "percent_RNA_nGenes", 
                                         "percent_RNA_deadcells", "percent_Protein_lowCount", 
                                         "percent_Protein_nonspecific_signal", "percent_nonTcells"))
    p = ggplot(data = sample_qc_melt %>% 
               filter(variable %in% c("percent_postqc", "percent_RNA_nGenes", 
                                      "percent_RNA_deadcells", "percent_Protein_lowCount", 
                                      "percent_Protein_nonspecific_signal", "percent_nonTcells")), 
           aes(x = variable, y = as.numeric(value))) +
        geom_boxplot(outlier.shape = NA) +
        geom_jitter(data = sample_qc_melt_sub, aes(x = variable, y = as.numeric(value), color = hashtag_number), width = 0, size = 2) +
        geom_text_repel(data = sample_qc_melt_sub, aes(x = variable, y = as.numeric(value), label = hashtag_number), max.overlaps = getOption("ggrepel.max.overlaps", default = 10)) +
        scale_color_manual(values = mypal) +
        ylab("Percent") +
        theme_bw() + theme(axis.title.x = element_blank()) + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10)) + ggtitle(i) #+ NoLegend()
        ggtitle(i) 
    print(p)
    dev.off()
}
dev.off()


pdf("QC_ncells_perIGTandsample.pdf", 12,8, useDingbats = F)
p <- ggplot(sample_qc_melt %>% filter(variable %in% c("ncells_postqc")), aes(y = as.numeric(value))) +
  geom_boxplot(aes(x = "All"),outlier.shape = NA, fill = "grey", alpha = 0.5) +  # A single boxplot for all data
  geom_jitter(aes(x = IGT, color = hashtag_number), width = 0, size = 2) +  # Jitter plot for each IGT
  scale_color_manual(values = mypal) +
  theme_bw() + 
  theme(axis.title.x = element_blank()) + 
scale_x_discrete(limits = c("All", as.character(levels(sample_qc_melt$IGT)))) +
  ggtitle(label = "QC ncells by IGT and sample") + 
  theme(axis.text.x  = element_text(angle = 75, vjust = 0.5, size = 10))
print(p)
dev.off()
```

Write the tables
```{r}
write.table(igt_qc, file = "QC_RNA_ADT_IGT_summary_table.csv",quote = F, sep = ",",row.names = F)
write.table(sample_qc, file = "QC_RNA_ADT_sample_summary_table.csv",quote = F, sep = ",",row.names = F)
```

Transfer summary QC plot in each IGT
```{bash}
cd ~/google_drive/ImmgenT/analysis/QC/  

for i in {1..56}; do \
echo IGT$i ; \
#ls ~/google_drive/ImmgenT/exp_id/*exp_id*/IGT${i}/; \
#ls QC_RNA_ADT_IGT${i}.pdf; \
cp QC_RNA_ADT_IGT${i}.pdf ~/google_drive/ImmgenT/exp_id/*exp_id*/IGT${i}/
done 

```

**TCR**
NOT COMPUTED YET FOR IGT 57-96 
per IGT or per sample
n sequences
% cells with a, b, ab, 2a, 2b, 2ab

```{r}
exp_igt_table = read.table("~/google_drive/ImmgenT/exp_id/igt_exp.txt", header = T, sep = ",")
#exp_lists = list.files(path = "~/google_drive/ImmgenT/exp_id/")
#id = "16"
#folder = exps[grepl(pattern = sprintf("exp_id_%s", id), x = exp_lists)]
#IGT = "IGT24"

for (i in 1:nrow(exp_igt_table)) {
    print(i)
    #i = 24 
    folder = exp_igt_table[i,"exp_id"]
    IGT = exp_igt_table[i,"IGT"]

    so = readRDS(sprintf("~/google_drive/ImmgenT/exp_id/%s/%s/dataset_clean.Rds", folder, IGT))

    #Number of cells post-QC
    exp_igt_table[i,"n_cells_scs"] = ncol(so)
    #n_cells_scs = ncol(so)
    exp_igt_table[i,"n_cells_scs"] = ncol(so)

    #tcr = read.table(file = sprintf("~/google_drive/ImmgenT/exp_id/%s/%s/%s_tcr_table.csv", folder, IGT, IGT), header = T, sep = ",")
    tcr = tryCatch(read.table(file = sprintf("~/google_drive/ImmgenT/exp_id/%s/%s/%s_tcr_table.csv", folder, IGT, IGT), header = T, sep = ","), error = function(e) {message("no TCR data")})

    if (!is.null(tcr)) {
        #Number of cells post-QC in TCR
        exp_igt_table[i,"n_cells_tcr"] = nrow(tcr)
        #n_cells_tcr = nrow(tcr)
        
        #Number of cells with at least 1 TCR sequence
        exp_igt_table[i,"n_cells_tcr_and_scs"] = length(unique(intersect(colnames(so), tcr$IGT.cellID)))
        #n_cells_tcr = length(unique(intersect(colnames(so), tcr$IGT.cellID)))
        
        #Number of TCR cells without SCS
        exp_igt_table[i,"n_cells_tcr_without_scs"] = exp_igt_table[i,"n_cells_tcr"] - exp_igt_table[i,"n_cells_tcr_and_scs"] 
        
        #Number of SCS cells without TCR
        exp_igt_table[i,"n_cells_scs_without_tcr"] = exp_igt_table[i,"n_cells_scs"] - exp_igt_table[i,"n_cells_tcr_and_scs"] 
        
        tcr_filt = tcr[tcr$IGT.cellID %in% unique(intersect(colnames(so), tcr$IGT.cellID)),]
        #dim(tcr_filt)
        tcr_filt2 = tcr_filt %>% select(alpha.vgene, beta.vgene, alpha2.vgene, beta2.vgene)
        tcr_filt2 = ifelse(is.na(tcr_filt2), yes = 0, no = 1)
        table(rowSums(tcr_filt2))
        
        # paired 1ab
        exp_igt_table[i,"n_cells_1a1b"] = sum(rowSums(tcr_filt2[,1:2]) == 2 & rowSums(tcr_filt2[,3:4]) == 0)
        #table(rowSums(tcr_filt2[,1:2]))
        
        #2 alpha and beta
        exp_igt_table[i,"n_cells_2a2b"] = sum(rowSums(tcr_filt2[,1:2]) == 2 & rowSums(tcr_filt2[,3:4]) == 2)
        
        #2 alpha - 1 beta
        exp_igt_table[i,"n_cells_2a1b"] = sum(rowSums(tcr_filt2[,1:2]) == 2 & tcr_filt2[,3] == 1 & tcr_filt2[,4] == 0)
        
        #2 beta - 1 beta
        exp_igt_table[i,"n_cells_1a2b"] = sum(rowSums(tcr_filt2[,1:2]) == 2 & tcr_filt2[,3] == 0 & tcr_filt2[,4] == 1)
        rm(tcr_filt2)
        rm(tcr_filt)
    }
}

exp_igt_table[is.na(exp_igt_table)] = 0
unique(exp_igt_table$IGT)
extract_numeric = function(x) {
  as.numeric(gsub("\\D", "", x))
}
ordered_vector = unique(exp_igt_table$IGT)[order(extract_numeric(unique(exp_igt_table$IGT)))] %>% as.character()
exp_igt_table$IGT = factor(exp_igt_table$IGT, levels = ordered_vector)

```

Plots
```{r}

exp_igt_table = exp_igt_table %>% group_by(IGT) %>% mutate(percent_tcr = n_cells_tcr_and_scs /n_cells_scs*100,
                                                           percent_tcr_without_scs = n_cells_tcr_and_scs /n_cells_tcr*100,
                                                           percent_1a1b = n_cells_1a1b /n_cells_tcr_and_scs*100,
                                                           percent_2a2b = n_cells_2a2b /n_cells_tcr_and_scs*100,
                                                           percent_2a1b = n_cells_2a1b /n_cells_tcr_and_scs*100,
                                                           percent_1a2b = n_cells_1a2b /n_cells_tcr_and_scs*100
) %>% as.data.frame()
exp_igt_table[is.na(exp_igt_table)] = 0

sum(exp_igt_table$n_cells_tcr_and_scs)


#exp_igt_table_melt = melt(exp_igt_table)

pdf("QC_tcr_1.pdf", 10,10, useDingbats = F)
#exp_igt_table$n_cells_scs_no_tcr = exp_igt_table$n_cells_scs - exp_igt_table$n_cells_tcr_and_scs
p = ggplot(exp_igt_table[,c("IGT","n_cells_tcr_and_scs", "n_cells_scs_without_tcr", "n_cells_tcr_without_scs")] %>% melt()) +
geom_bar(aes(IGT, value, fill = variable), stat = "identity") +
    scale_fill_manual(values = mypal) +
    #scale_y_continuous(trans = log_trans(), breaks = c(0.01, 0.05, seq(0.1, 1, by = 0.1)) , labels =  c( 0.01, 0.05, seq(0.1, 1, by = 0.1))) + 
    theme_bw()+ ggtitle(label = "Number of cells with and without TCR or without SCS") + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10))
print(p)
dev.off()

pdf("QC_tcr_2.pdf", 10,8, useDingbats = F)
p = ggplot(exp_igt_table_melt %>% filter(variable %in% c("percent_tcr", "percent_1a1b","percent_2a2b", "percent_2a1b", "percent_1a2b")), aes(x = variable, y = value)) + geom_boxplot() + 
    geom_jitter(width = 0, aes(color = IGT), size = 2) +
    geom_text_repel(aes(x = variable, y = value, label = IGT), max.overlaps = getOption("ggrepel.max.overlaps", default = 20)) +
    scale_color_manual(values = mypal) +
    #scale_y_continuous(trans = log_trans(), breaks = c(0.01, 0.05, seq(0.1, 1, by = 0.1)) , labels =  c( 0.01, 0.05, seq(0.1, 1, by = 0.1))) + 
    theme_bw() + theme(axis.title.x = element_blank())+ ggtitle(label = "Percent of cells with abTCR") + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10)) + NoLegend()
print(p)
dev.off()


p2 = ggplot(exp_igt_table, aes(x = "", y = percent_tcr)) + geom_boxplot() + 
    geom_jitter(width = 0, aes(color = IGT), size = 2) +
    geom_text_repel(aes(x = "",  y = percent_tcr, label = IGT), max.overlaps = getOption("ggrepel.max.overlaps", default = 20)) +
    scale_color_manual(values = mypal) +
    #scale_y_continuous(trans = log_trans(), breaks = c(0.01, 0.05, seq(0.1, 1, by = 0.1)) , labels =  c( 0.01, 0.05, seq(0.1, 1, by = 0.1))) + 
    theme_bw() + theme(axis.title.x = element_blank())+ ggtitle(label = "Percent of cells with paired abTCR") + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10)) + NoLegend()

p3 = ggplot(exp_igt_table, aes(x = "", y = percent_1a1b)) + geom_boxplot() + 
    geom_jitter(width = 0, aes(color = IGT), size = 2) +
    geom_text_repel(aes(x = "",  y = percent_1a1b, label = IGT), max.overlaps = getOption("ggrepel.max.overlaps", default = 20)) +
    scale_color_manual(values = mypal) +
    #scale_y_continuous(trans = log_trans(), breaks = c(0.01, 0.05, seq(0.1, 1, by = 0.1)) , labels =  c( 0.01, 0.05, seq(0.1, 1, by = 0.1))) + 
    theme_bw() + theme(axis.title.x = element_blank()) + ggtitle(label = "Percent of cells with paired abTCR") + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10))+ NoLegend()

p4 = ggplot(exp_igt_table, aes(x = "", y = percent_2a2b)) + geom_boxplot() + 
    geom_jitter(width = 0, aes(color = IGT), size = 2) +
    geom_text_repel(aes(x = "",  y = percent_2a2b, label = IGT), max.overlaps = getOption("ggrepel.max.overlaps", default = 20)) +
    scale_color_manual(values = mypal) +
    #scale_y_continuous(trans = log_trans(), breaks = c(0.01, 0.05, seq(0.1, 1, by = 0.1)) , labels =  c( 0.01, 0.05, seq(0.1, 1, by = 0.1))) + 
    theme_bw() + theme(axis.title.x = element_blank()) + ggtitle(label = "Percent of cells with paired abTCR") + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10))+ NoLegend()

p5 = ggplot(exp_igt_table, aes(x = "", y = percent_2a1b)) + geom_boxplot() + 
    geom_jitter(width = 0, aes(color = IGT), size = 2) +
    geom_text_repel(aes(x = "",  y = percent_2a1b, label = IGT), max.overlaps = getOption("ggrepel.max.overlaps", default = 20)) +
    scale_color_manual(values = mypal) +
    #scale_y_continuous(trans = log_trans(), breaks = c(0.01, 0.05, seq(0.1, 1, by = 0.1)) , labels =  c( 0.01, 0.05, seq(0.1, 1, by = 0.1))) + 
    theme_bw() + theme(axis.title.x = element_blank()) + ggtitle(label = "Percent of cells with paired abTCR") + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10)) + NoLegend()

p6 = ggplot(exp_igt_table, aes(x = "", y = percent_1a2b)) + geom_boxplot() + 
    geom_jitter(width = 0, aes(color = IGT), size = 2) +
    geom_text_repel(aes(x = "",  y = percent_1a2b, label = IGT), max.overlaps = getOption("ggrepel.max.overlaps", default = 20)) +
    scale_color_manual(values = mypal) +
    #scale_y_continuous(trans = log_trans(), breaks = c(0.01, 0.05, seq(0.1, 1, by = 0.1)) , labels =  c( 0.01, 0.05, seq(0.1, 1, by = 0.1))) + 
    theme_bw() + theme(axis.title.x = element_blank())+ ggtitle(label = "Percent of cells with paired abTCR") + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10)) + NoLegend()

print(p2)
print(p3)
print(p4)
print(p5)
print(p6)

dev.off()

#Write the tables
write.table(exp_igt_table, file = "QC_tcr_IGT1_56_tcr_table.csv",quote = F, sep = ",",row.names = F)
            



```


**Other plots**
```{r}
sample_qc = read.table("~/google_drive/ImmgenT/analysis/QC/Sample_metadata_withQC.csv", header = T, sep = ",")
sample_qc$IGT = sample_qc$immgent_IGT_10xlane_id
sample_qc$IGT = ReorderIGT(sample_qc$IGT)

#sex
pdf("QC_ncells_perSex.pdf", 4,4, useDingbats = F)
colnames(sample_qc)
sex = sample_qc %>% group_by(sex) %>% summarize(sum = sum(ncells_postqc)) %>% as.data.frame()
p = ggplot(sex, aes(x = sex, y = sum, fill = sex)) + 
    geom_bar(stat = "identity") +scale_color_manual(values = mypal) + 
    geom_text(aes(label = sum), vjust = -0.5, size = 2) + 
    theme_bw() + theme(axis.title.x = element_blank()) + 
    ggtitle(label = "# cells by sex") + 
    theme(axis.text.x  = element_text(angle = 75, vjust = 0.5, size = 10),
          axis.text.y  = element_text(size = 10))
print(p)
dev.off()

#organ
colnames(sample_qc)
sample_qc$organ2 = sample_qc$organ
sample_qc$organ2[grepl("spleen|lymph", sample_qc$organ)] = "SLO"
sample_qc$organ2[grepl("colon|duodenum|gut|ileum|jejunum|intestine|propria|SI", sample_qc$organ)] = "gut"
sample_qc$organ2[grepl("skin", sample_qc$organ)] = "skin"
sample_qc$organ2[grepl("submandibular", sample_qc$organ)] = "submandibular gland"
sample_qc$organ2 = tolower(sample_qc$organ2)
organ = sample_qc %>% group_by(organ2) %>% summarize(sum = sum(ncells_postqc)) %>% as.data.frame()

pdf("QC_ncells_perOrgan.pdf", 8,4, useDingbats = F)
p = ggplot(organ, aes(x = organ2, y = sum, fill = organ2)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = sum), vjust = -0.5, size = 3) +  # Add text on top of bars
    scale_fill_manual(values = mypal) + 
    theme_bw() +
    ylim(0, max(organ$sum)*1.1) +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(angle = 75, vjust = 0.5, size = 10),
          axis.text.y = element_text(size = 10)) +
    ggtitle(label = "# cells by organ") +
    guides(fill = "none")  # Remove legend
print(p)
dev.off()

#Conditions
colnames(sample_qc)
condition = sample_qc %>% group_by(condition) %>% summarize(sum = sum(ncells_postqc)) %>% as.data.frame()

pdf("QC_ncells_perCondition.pdf", 6,4, useDingbats = F)
p = ggplot(condition, aes(x = condition, y = sum, fill = condition)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = sum), vjust = -0.5, size = 3) +  # Add text on top of bars
    scale_fill_manual(values = mypal) + 
    theme_bw() +
    ylim(0, max(condition$sum)*1.1) +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(angle = 75, vjust = 0.5, size = 10),
          axis.text.y = element_text(size = 10)) +
    ggtitle(label = "# cells by condition") +
    guides(fill = "none")  # Remove legend
print(p)
dev.off()

#Condition and organ
tmp = sample_qc %>% group_by(condition, organ2) %>% summarize(sum = sum(ncells_postqc)) %>% as.data.frame()
tmp = dcast(tmp, condition ~ organ2)
rownames = tmp[,1]
tmp = tmp[,-1]
tmp[is.na(tmp)] = 0
tmp = apply(tmp, 2, function(x) {as.numeric(x)})
rownames(tmp) = rownames

pdf("QC_Heatmap_OrganperCondition.pdf", 9,6, useDingbats = F)
ColorRamp = rev(viridis(100))
tmp[tmp==0] = NA
labels_matrix = ifelse(is.na(tmp), yes = "", no = as.character(signif(tmp,2)))
#labels_matrix = matrix(labels_matrix, nrow(data_matrix), ncol(data_matrix))
pheatmap(mat = signif(tmp,2), cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix, number_format = "%.0f", breaks = seq(0,10000,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 10, main = "Number of cells per organ and condition", na_col = "#FDE725")
dev.off()


```


