---
title: "TopicDGE"
output: html_document
date: "2025-04-24"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
options(max.print=1000)
setwd("/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/misc_plots")
# source("/Users/david/google_drive/ImmgenT/analysis/immgent_integration_git/custom_functions_david.R")

libs = c("ZemmourLib","ggplot2", "dplyr", "reshape2", "RColorBrewer", "pals", "viridis") 
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))

```

Custom functions: ZemmourLib::FlashierDGE in ZemmourLib

Load necessary data
```{r}
#Import cell metadata, for example from the most recent seurat object
so_orig = readRDS("/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20260206_clean_ADTonly.Rds")
mdata_orig = so_orig@meta.data
# or from a different file (e.g., if you don't want to use the Seurat object)
# mdata_orig = read.table("metadata_20250513_mde.txt", header = T, sep = "\t")

#option 1 (best): import F1 and L1 from the fit object: 
L1 = readRDS(sprintf('/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/topic/flashier20250215_alldata_backfit/L1.Rds')) #cells x factor
F1 = readRDS(sprintf("/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/topic/flashier20250215_alldata_backfit/F1.Rds")) #gene x factor

#option1 (best): import F1 and L1 from the fit object
# fit = readRDS("fit.Rds")
# res = ldf(fit, type = "i")
# L1 = with(res, L %*% diag(D)  ) #same as res$L %*% diag(res$D)
# L1 = L1[mdata_orig$cellID,]
# all(rownames(L1) == rownames(mdata_orig))
# colnames(L1) = sprintf("F%s", 1:ncol(L1))
# 
# F1 = with(ldf(fit, type = "i"), F)
# colnames(F1) = paste("F", 1:ncol(F1), sep = "")

#option 2: import F1 and L1 from the matrices
# F1 = read.table("gene_factor_matrix.txt", header = T, sep = "\t") %>% as.matrix() #gene x factor
# L1 = read.table("cell_factor_matrix.txt", header = T, sep = "\t") %>% as.matrix() #cells x factor

mdata_orig %>% select(IGT, exp_name) %>% unique()

```

Example
```{r}
group1 = mdata_orig %>% filter(annotation_level1 %in% c("Treg") & annotation_level2 %in% c("Treg.D") & organ_simplified == "spleen" & condition_broad == "healthy") %>% pull(cellID)
group2 = mdata_orig %>% filter(annotation_level1 %in% c("Treg") & annotation_level2 %in% c("Treg.F") & organ_simplified == "spleen" & condition_broad == "healthy") %>% pull(cellID)


# Call the function with F1, L1, and group data
results = FlashierDGE(F1, L1, group1, group2, title_plot = "Treg.D vs Treg.F in colon healthy")

# Access the plots and data
results$p1  # First plot (MA plot of factors)
results$p2  # Second plot (MA plot of genes)
results$diff_factors  # table for fold changes of gene programs
results$diff_genes %>% arrange(desc(log2FC)) # table for fold changes of genes

```


