---
title: "TopicDGE"
output: html_document
date: "2025-04-24"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
options(max.print=1000)
setwd("/Users/david/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/topic/flashier20250215_alldata_backfit/")
source("/Users/david/google_drive/ImmgenT/analysis/immgent_integration_git/custom_functions_david.R")

libs = c("ggplot2", "dplyr", "reshape2", "RColorBrewer", "pals", "viridis") 
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))

```

Custom functions
```{r}
FlashierDGE = function(F1, L1, group1, group2, title_plot = "") {
    
    require(ggplot2)
    require(ggrepel)
    require(dplyr)
    require(scattermore)
    
    # Calculate the loadings
    loadings_group1 = colMeans(L1[group1,])
    loadings_group2 = colMeans(L1[group2,])
    loadings_groups = colMeans(L1[c(group1, group2),])
    
    # Mean genes for each group
    mean_genes_group1 = F1 %*% loadings_group1
    mean_genes_group2 = F1 %*% loadings_group2
    mean_genes = F1 %*% colMeans(L1[c(group1, group2),])
    
    # Fold Change between the two groups
    fc_loadings = loadings_group1 - loadings_group2
    fc_genes = F1 %*% fc_loadings %>% as.data.frame()  # take exp to have the actual FC
    
    # Create vplot for fold changes (MA plot of factors)
    vplot = data.frame(SYMBOL = names(fc_loadings), log2FC = fc_loadings / log(2), AveExpr = loadings_groups)
    
    # Maximum FC for symmetrical x-axis range
    max_fc = ceiling(max(abs(vplot$log2FC)))  # Get the max of the absolute FC values and round up
    top_genes = vplot %>%
        arrange(desc(abs(log2FC))) %>%
        head(50)
    
    # MA Plot (Factors)
    p1 = ggplot(data = vplot) + 
        geom_point(aes(x = log2FC, y = AveExpr), colour = "black", alpha = I(1), size = I(1)) +
        xlim(-max_fc, max_fc) +  # Set symmetrical x-axis range
        geom_text_repel(data = top_genes, aes(x = log2FC, y = AveExpr, label = SYMBOL), 
                        size = 3, color = "red", box.padding = 0.35, point.padding = 0.5, segment.color = 'grey50', max.overlaps  = 20) +
        theme_minimal() +
        labs(
            x = "Fold Change (log2)",
            y = "Average Expression",
            title = title_plot
        )
    
    # Create vplot for gene expression (MA plot of genes)
    vplot_genes = data.frame(SYMBOL = rownames(fc_genes), log2FC = fc_genes[,1] / log(2), AveExpr = mean_genes[,1])
    
    # Maximum FC for symmetrical x-axis range (for genes)
    max_fc_genes = ceiling(max(abs(vplot_genes$log2FC)))  # Get the max of the absolute FC values and round up
    top_genes_genes <- vplot_genes %>%
        arrange(desc(abs(log2FC))) %>%
        head(50)
    
    # MA Plot (Genes)
    p2 <- ggplot(data = vplot_genes) + 
        geom_scattermore(aes(x = log2FC, y = AveExpr), colour = "black", alpha = I(1), size = I(1), pixels = c(512, 512)) +
        xlim(-max_fc_genes, max_fc_genes) +  # Set symmetrical x-axis range
        geom_text_repel(data = top_genes_genes, aes(x = log2FC, y = AveExpr, label = SYMBOL), 
                        size = 3, color = "red", box.padding = 0.35, point.padding = 0.5, segment.color = 'grey50', max.overlaps  = 20) +
        theme_minimal() +
        labs(
            x = "Fold Change (log2)",
            y = "Average Expression",
            title = title_plot
        )
    
    # Return the plots and vplot tables
    list(p1 = p1, p2 = p2, diff_factors = vplot, diff_genes = vplot_genes)
}
```


Load necessary data
```{r}

#import cell metadata
mdata_orig = read.table("metadata_20250513_mde.txt", header = T, sep = "\t")

#option1 (best): import F1 and L1 from the fit object
fit = readRDS("fit.Rds")
res = ldf(fit, type = "i")
L1 = with(res, L %*% diag(D)  ) #same as res$L %*% diag(res$D)
L1 = L1[mdata_orig$cellID,]
all(rownames(L1) == rownames(mdata_orig))
colnames(L1) = sprintf("F%s", 1:ncol(L1))

F1 = with(ldf(fit, type = "i"), F)
colnames(F1) = paste("F", 1:ncol(F1), sep = "")

#option 2: import F1 and L1 from the matrices
F1 = read.table("gene_factor_matrix.txt", header = T, sep = "\t") %>% as.matrix() #gene x factor
L1 = read.table("cell_factor_matrix.txt", header = T, sep = "\t") %>% as.matrix() #cells x factor

mdata_orig %>% select(IGT, exp_name) %>% unique()

```

Example
```{r}
group1 = mdata_orig %>% filter(annotation_level1 %in% c("Treg") & annotation_level2 %in% c("Treg_cl8") & organ_simplified == "colon" & condition_broad == "healthy") %>% pull(cellID)
group2 = mdata_orig %>% filter(annotation_level1 %in% c("Treg") & annotation_level2 %in% c("Treg_cl2") & organ_simplified == "colon" & condition_broad == "healthy") %>% pull(cellID)


# Call the function with F1, L1, and group data
results = FlashierDGE(F1, L1, group1, group2, title_plot = "Treg_cl8 vs Treg_cl2 in colon healthy")

# Access the plots and data
results$p1  # First plot (MA plot of factors)
results$p2  # Second plot (MA plot of genes)
results$diff_factors  # table for fold changes of gene programs
results$diff_genes %>% arrange(desc(log2FC)) # table for fold changes of genes

```


