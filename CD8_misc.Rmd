---
title: "composition_analysis"
output: html_document
date: "2024-10-24"
author: "David Zemmour"
editor_options: 
  chunk_output_type: console
---

**Initialize: load libraries and custom functions**

```{bash}
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=jfkfloor2 --qos=jfkfloor2 --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=beagle3-bigmem --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=zemmour-hm --qos=zemmour --nodes=1 
sinteractive --time=03:00:00 --account=pi-zemmour --partition=caslake --nodes=1 --mem=96GB

module load python/anaconda-2022.05 
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13
#source activate /project/zemmour/david/envs/scvi_20240315
source activate /project/zemmour/david/envs/r443
module load openblas/0.3.13

cd /project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD8
R
```

Figures folder
```{r}
fig_dir = "~/google_drive_uchicago/ImmgenT/20250109_freeze/CD8/paper_CD8/figures/bits_david"
out_dir = "~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/CD8/misc_plots"
```


```{r}
# setwd("~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/CD8")
libs = c("ZemmourLib","Seurat", "patchwork", "tidyr", "ggplot2", "dplyr", "RColorBrewer", "pals", "scales", "reshape2", "pheatmap", "scattermore",  "ggbeeswarm") 
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))
# source("/project/jfkfloor2/zemmourlab/david/immgent/immgent_integration_git/custom_functions_david.R")

ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
ColorRamp = rev(rainbow(10, end = 4/6))
ColorRamp = rev(viridis(100))
ColorRamp = brewer.pal(9, "Blues")

#mycol = c("black","blue","red","darkgreen", "orange","purple", "cyan", "greenyellow",    "salmon", "magenta","pink", "tan", "brown") # c("magenta", "red",  "darkgreen", "cyan", "blue", "blue", "blue", "black", "blue", "blue", "blue", "blue", "orange")

n = 70
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
mypal1 = unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals))))
mypal1 = mypal1[-4]

library("pals")
parade = function(n) { return(Seurat::DiscretePalette(n, palette = "parade", shuffle = F)) }

length(glasbey())
length(polychrome())
mypal = c(glasbey(), polychrome(), mypal1)
names(mypal) = NULL

mypal_organ = ZemmourLib::immgent_colors$organ_simplified
mypal_level1 = ZemmourLib::immgent_colors$level1
mypal_level2 = ZemmourLib::immgent_colors$level2

# mypal_organ = setNames(mypal, unique(so$organ_simplified))
# mypal_organ["other"] = "grey"
# mypal_organ = mypal_organ[!is.na(names(mypal_organ))]
# mypal_organ = setNames(mypal, unique(mdata_orig$organ_simplified))
# mypal_organ["other"] = "grey"
# mypal_organ = mypal_organ[!is.na(names(mypal_organ))]
# 
# mypal_level1 = setNames(mypal, unique(so$annotation_level1))
# mypal_level1 = mypal_level1[!is.na(names(mypal_level1))]
# 
# mypal_level2 = setNames(mypal, unique(so$annotation_level2))
# mypal_level2 = mypal_level2[!is.na(names(mypal_level2))]

mypal_condition_broad = setNames(mypal, unique(so$condition_broad))
mypal_condition_broad = mypal_condition_broad[!is.na(names(mypal_condition_broad))]

mypal_condition_broad = setNames(mypal, unique(mdata_orig$condition_broad))
mypal_condition_broad = mypal_condition_broad[!is.na(names(mypal_condition_broad))]
mypal_condition_broad["healthy"] = "black"
mypal_condition_broad["allergy"] = mypal[60]

mypal_condition_detailed_simplified = setNames(mypal, unique(so$condition_detailed_simplified))
mypal_condition_detailed_simplified = mypal_condition_detailed_simplified[!is.na(names(mypal_condition_detailed_simplified))]

mypal_igt = setNames(mypal, unique(so$IGT))
mypal_igt = mypal_igt[!is.na(names(mypal_igt))]
```

**Most up-to-date data**

```{r}
# so_orig = readRDS("igt1_96_withtotalvi20250317_clean.Rds")
# so_orig = readRDS("igt1_96_withtotalvi20250513_clean.Rds")
so_orig = readRDS("igt1_96_withtotalvi20250710_clean_ADTonly.Rds")
so = so_orig[,so_orig@meta.data %>% filter(organ_simplified != "thymus") %>% row.names()]


so = so_orig[,so_orig$annotation_level1 == "CD8"]
so$Ag_spe[is.na(so$Ag_spe)] = "poly"

prefix = "CD8"

so@meta.data %>% select(IGT, infection_agent) %>% unique()
so@meta.data %>% select(IGT, tumor, Ag_spe) %>% unique()

```

Counting cells
```{r}
so_orig@meta.data %>% filter(annotation_level2 == "CD8_cl10" & condition_broad %in% c("virus", "bacteria", "parasite", "mutiinfection", "fungus")) %>% count(IGTHT) %>%   summarise(n_samples = sum(n > 5))
so_orig@meta.data %>% filter(annotation_level2 == "CD8_cl10") %>% count(IGTHT) %>%   summarise(n_samples = sum(n > 5))
so_orig@meta.data %>% filter(annotation_level2 == "CD8_cl10" & condition_broad %in% c("virus", "bacteria", "parasite", "mutiinfection", "fungus")) %>% count(condition_detailed_simplified) %>%   summarise(n_samples = sum(n > 5))
so_orig@meta.data %>% filter(annotation_level2 == "CD8_cl10" & condition_broad %in% c("virus", "bacteria", "parasite", "mutiinfection", "fungus")) %>% count(organ_simplified) %>%   summarise(n_samples = sum(n > 5))


```

States at baseline (6-8 wo mouse, male or female, SPF JAX)
```{r}
so = so_orig[,so_orig$annotation_level1 == "CD8"]

pdf(sprintf("%s/MDE_level2_basline.pdf", out_dir), 5,5, useDingbats = F)
p = DimPlot(so_orig[,so_orig@meta.data %>% filter(annotation_level1 == "CD8", condition_detailed == "baseline") %>% row.names()], group.by = "annotation_level2", reduction = "mde_incremental") + scale_color_manual(values = mypal_level2)
p + NoLegend()
sub = so_orig@meta.data %>% filter(annotation_level1 == "CD8", condition_detailed == "baseline") %>% row.names()
MyDimPlotHighlight(seurat_object = so, umap_to_plot = "mde_incremental", cells_to_highlight = sub, highlight_column_name = "annotation_level2", mycols =mypal_level2, highlight_size = 0.5)
dev.off()
# DimPlot(so, cells.highlight = sub, raster = T, raster.dpi = c(1024,1024), group.by = "annotation_level2",cols.highlight = mypal_level2[so$annotation_level2[sub]], reduction = "mde_incremental")
so_orig@meta.data %>% filter(annotation_level1 == "CD8", condition_detailed == "baseline")


```


LCMV arm
```{r}
DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level2", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal) + theme_void() + NoLegend() 

ia = "LCMV armstrong"
igts = c("IGT36", "IGT38", "IGT40")
orgs = unique(so$organ_simplified)
as = c("P14", "poly")

ip = c("acute")
pdf(sprintf("%s/MDE_LCMVarm_acutephase_20250402.pdf", prefix), 5, 5, useDingbats = F)
for (o in orgs) {
    for (a in as) {
        ch = colnames(so)[so$infection_agent %in% ia & so$IGT %in% igts & so$infection_phase %in% ip & so$organ_simplified %in% o & so$Ag_spe %in% a]
        if (length(ch) != 0 ) {
            print(sprintf("%s %s %s %s", ia, ip, o, a))
            print(length(ch))
            MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = ch, highlight_column_name = "annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level2, print_plot1 = T, print_plot2 = T, labelclusters = F, title = sprintf("%s %s %s %s", ia, ip, o, a) )
            rm(ch)
        }
    }
}
dev.off()

ip = c("cleared")
pdf(sprintf("%s/MDE_LCMVarm_latephase_20250402.pdf", prefix), 5, 5, useDingbats = F)
for (o in orgs) {
    for (a in as) {
        ch = colnames(so)[so$infection_agent %in% ia & so$IGT %in% igts & so$infection_phase %in% ip & so$organ_simplified %in% o & so$Ag_spe %in% a]
        if (length(ch) != 0 ) {
            print(sprintf("%s %s %s %s", ia, ip, o, a))
            print(length(ch))
            MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = ch, highlight_column_name = "annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level2, print_plot1 = T, print_plot2 = T, labelclusters = F, title = sprintf("%s %s %s %s", ia, ip, o, a) )
            rm(ch)
        }
    }
}


dev.off()

pdf(sprintf("%s/MDE_IGT36_38_40_48_spleen_standard.pdf", prefix), 5, 5, useDingbats = F)
ch = colnames(so)[so$IGT %in% c("IGT36", "IGT38", "IGT40", "IGT48") & so$spleen_standard == T]
MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = ch, highlight_column_name = "annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level2, print_plot1 = T, print_plot2 = T, labelclusters = F, title = "spleen standard" )
dev.off()

```

B16
```{r}
# igts = c("IGT35")
spls = unique(so$sample_type[so$IGT == "IGT35"])
as = c("P14", "poly")

pdf(sprintf("%s/MDE_B16.gp33_20250402.pdf", prefix), 5, 5, useDingbats = F)
for (s in spls) {
    for (a in as) {
        ch = colnames(so)[so$sample_type %in% s & so$Ag_spe %in% a ] #
        if (length(ch) != 0 ) {
            print(sprintf("%s %s", s, a))
            print(length(ch))
            MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = ch, highlight_column_name = "annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level2, print_plot1 = T, print_plot2 = T, labelclusters = F, title = sprintf("%s %s", s,  a) )
            rm(ch)
        }
    }
}
dev.off()


```

KP
```{r}
# igts = c("IGT35")
spls = unique(so$sample_type[so$IGT %in% c("IGT95", "IGT96")])
as = c("OT1", "poly")

pdf(sprintf("%s/MDE_KPzSIIN_20250402.pdf", prefix), 5, 5, useDingbats = F)
for (s in spls) {
    for (a in as) {
        ch = colnames(so)[so$sample_type %in% s & so$Ag_spe %in% a ] #
        if (length(ch) != 0 ) {
            print(sprintf("%s %s", s, a))
            print(length(ch))
            MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = ch, highlight_column_name = "annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level2, print_plot1 = T, print_plot2 = T, labelclusters = F, title = sprintf("%s %s", s,  a) )
            rm(ch)
        }
    }
}
dev.off()
```

KP
```{r}
# igts = c("IGT35")
spls = unique(so$sample_type[so$IGT %in% c("IGT64", "IGT65")])
as = c("OT1", "poly")

pdf(sprintf("%s/MDE_PDAC_20250402.pdf", prefix), 5, 5, useDingbats = F)
for (s in spls) {
    for (a in as) {
        ch = colnames(so)[so$sample_type %in% s & so$Ag_spe %in% a ] #
        if (length(ch) != 0 ) {
            print(sprintf("%s %s", s, a))
            print(length(ch))
            MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = ch, highlight_column_name = "annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level2, print_plot1 = T, print_plot2 = T, labelclusters = F, title = sprintf("%s %s", s,  a) )
            rm(ch)
        }
    }
}
dev.off()


```

GBM
```{r}
# igts = c("IGT35")
spls = unique(so$sample_type[so$IGT %in% c("IGT69")])
as = c("OT1", "poly")

pdf(sprintf("%s/MDE_GBM_20250402.pdf", prefix), 5, 5, useDingbats = F)
for (s in spls) {
    for (a in as) {
        ch = colnames(so)[so$sample_type %in% s & so$Ag_spe %in% a ] #
        if (length(ch) != 0 ) {
            print(sprintf("%s %s", s, a))
            print(length(ch))
            MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = ch, highlight_column_name = "annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level2, print_plot1 = T, print_plot2 = T, labelclusters = F, title = sprintf("%s %s", s,  a) )
            rm(ch)
        }
    }
}
dev.off()


```

**FCFC plots for giovanni**
```{r}
source('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/analysis/immgent_integration_git/custom_functions_david.R')

tt_list = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/analysis/data_integration/IGT1_96/CD8/DGE_limma/20250109/ttlist_OneVsAll.Rds')

names(tt_list)


# Create the vplot dataframe with fold changes
vplot = data.frame(fc1 = exp(tt_list$CD8_cl10_vs_All$logFC), fc2 = exp(tt_list$CD8_cl11_vs_All$logFC), SYMBOL = tt_list$CD8_cl10_vs_All$SYMBOL)

# Identify genes with large fold changes (>2)
genes_to_plot = abs(tt_list$CD8_cl10_vs_All$logFC) > 0.69 | abs(tt_list$CD8_cl11_vs_All$logFC) > 0.69
# genes_to_label = vplot[genes_to_plot, ]
genes_to_label = vplot$SYMBOL[genes_to_plot]

# Create the plot
FCFCplot(vplot, 
         xlab = "FC for CD8_cl10", 
         ylab = "FC for CD8_cl11", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = genes_to_label)

FCFCplot(vplot, 
         xlab = "FC for CD8_cl10", 
         ylab = "FC for CD8_cl11", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = NULL)

vplot = data.frame(fc1 = exp(tt_list$CD8_cl10_vs_All$logFC), fc2 = exp(tt_list$CD8_cl7_vs_All$logFC), SYMBOL = tt_list$CD8_cl10_vs_All$SYMBOL)
# Identify genes with large fold changes (>2)
genes_to_plot = abs(tt_list$CD8_cl10_vs_All$logFC) > 0.69 | abs(tt_list$CD8_cl7_vs_All$logFC) > 0.69
genes_to_label = vplot[genes_to_plot, ]
# Create the plot
FCFCplot(vplot, 
         xlab = "FC for CD8_cl10", 
         ylab = "FC for CD8_cl7", 
         main = "Fold Change vs Fold Change", 
         printgeomtext = T, 
         genes_to_label = genes_to_label)



```

**Barplot of cluster proportion in specific samples**

prop_data and mdata
mdata_sl1 from annotation_level2_PropPerSamplePerLevel1_withMetadata.Rds (proportion of CD8, CD4, Treg etc in each sample)
mdata_s from annotation_level2_PropPerSample.txt (proportion of total cells in the sample)
```{r}
prop_data = read.table(file = sprintf("%s/annotation_level2_PropPerSample.txt", prefix), header = T, sep = "\t" ) # --> mdata_s
prop_data = readRDS(file = sprintf("%s/annotation_level2_PropPerSamplePerLevel1_withMetadata.Rds", prefix)) %>% select(IGTHT, ends_with("ncells"), ends_with("prop")) # --> mdata_sl1
colnames(prop_data) = gsub(pattern = "gdT_52", replacement = "gdT_cl52", x = colnames(prop_data))
colnames(prop_data) = gsub(pattern = "gdT_54", replacement = "gdT_cl54", x = colnames(prop_data))

m = read.table('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/exp_id/sample_metadata/Sample_metadata_david_20250628_v10.csv',header = T, sep = ",")

# changing here and not in the original file to keep consistent with the database
colnames(m)
m$IGT_10xlane_id = NULL
m$organism_id = NULL
m$IGT = m$immgent_IGT_10xlane_id
m$immgent_IGT_10xlane_id = NULL
m$HT = m$hashtag_number
m$hashtag_number = NULL
m$sample_id = NULL
m$count_unique = NULL

m$sample_code.1 = NULL

mdata = merge(prop_data, m, by.x = "IGTHT", by.y = "IGTHT",all.x = T, all.y = F, suffixes = c(".x", ""))

mdata$organ_simplified = factor(mdata$organ_simplified, levels = c("blood","spleen","LN","SLO","bone marrow","thymus",
                                                                   "lung", "liver", "peritoneal cavity",
                                                                   "colon epi","small intestine epi","colon LP","small intestine LP","skin",
                                                                   "mammary gland","uterus", "placenta", "prostate","submandibular gland","kidney", "pancreas","CNS","synovial fluid"))
#any(is.na(mdata$organ_simplified))

mdata$condition_detailed_simplified = factor(mdata$condition_detailed_simplified)
mdata$condition_detailed_simplified = relevel(mdata$condition_detailed_simplified, ref = "baseline")


mdata_sl1 = mdata
mdata_s = mdata

```


CD8_cl14/15/18 barplot samples
```{r}
mdata #see chunk at the beginning, from prop_data = read.table(file = sprintf("%s/annotation_level2_PropPerSample.txt", prefix), header = T, sep = "\t" ) 

# rorc = c("CD4_cl17","nonconv_cl8", "gdT_cl7","gdT_cl9", "gdT_cl46","gdT_cl10", "CD8_cl7", "DP_cl60", "Treg_cl2", "CD4_cl21", "CD8_cl10", "Treg_cl8", "CD8aa_cl1", "DN_cl41")
mycl = c("CD8_cl14","CD8_cl15","CD8_cl28")
want_cols = paste0(mycl, ".prop")
tmp = mdata %>% filter(grepl(pattern = "allT|CD45p", x = target_cells_simplified) & !(condition_detailed == "baseline" & organ_simplified == "spleen") ) %>% select(sample_code,any_of(want_cols))
# tmp = mdata %>% select(sample_code,any_of(want_cols))

tmp2 = tmp %>% mutate(total_prop = rowSums(select(., ends_with(".prop")), na.rm = TRUE)) %>% arrange(desc(total_prop))
tmp2 %>% head(50) %>% pull(sample_code)

tmp2 <- tmp2 %>% 
  arrange(desc(total_prop)) %>% 
  mutate(sample_code = factor(sample_code, sample_code)) %>% 
    head(50)

tmp_long <- tmp2 %>% 
  select(-total_prop) %>% 
  pivot_longer(
    cols      = -sample_code,
    names_to  = "population",
    values_to = "prop"
  ) 

tmp_long$population = gsub("\\.prop","", tmp_long$population )
tmp_long$condition_detailed_organ = mdata$condition_detailed_organ[match(tmp_long$sample_code, mdata$sample_code)]

label_map = tmp_long %>% 
  distinct(sample_code, condition_detailed_organ) %>% 
  arrange(sample_code)
lab_vec = label_map$condition_detailed_organ
names(lab_vec) = label_map$sample_code


pdf(sprintf("%s/CD8cl141528_clusters_in_topsamples.pdf", fig_dir),10, 8, useDingbats = F) #all cells
p = ggplot(tmp_long, aes(x = sample_code, y = prop, fill = population)) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = immgent_colors$level2) +
    scale_x_discrete(labels = lab_vec) +
    theme_minimal() +
    labs(
        x    = "Sample",
        y    = "Proportion",
        fill = "Population"
    ) +
    ggtitle("Top samples with CD8 cl14/15/28 - percent of total CD8") +
    theme_minimal() +
    theme(
        panel.grid.major = element_blank(), # Removes major grid lines
        panel.grid.minor = element_blank(), # Removes minor grid lines
        # axis.title = element_blank(),       # Removes axis titles (e.g., "count")
        # axis.text = element_blank(),        # Removes axis labels/text (e.g., numbers on the axis)
        axis.ticks = element_blank(),        # Removes axis tick marks
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
print(p)
dev.off()


```

CD8_cl barplot samples
```{r}
mdata = mdata_sl1
mdata #see chunk at the beginning, from prop_data = read.table(file = sprintf("%s/annotation_level2_PropPerSample.txt", prefix), header = T, sep = "\t" ) 

for (mycl in unique(so$annotation_level2[so$annotation_level1 == "CD8"])) {
    print(mycl)
    want_cols = paste0(mycl, ".prop")
    tmp = mdata %>% filter(grepl(pattern = "allT|CD45p", x = target_cells_simplified) & !(condition_detailed == "baseline" & organ_simplified == "spleen") ) %>% select(sample_code,any_of(want_cols))
    # tmp = mdata %>% select(sample_code,any_of(want_cols))
    
    tmp2 = tmp %>% mutate(total_prop = rowSums(select(., ends_with(".prop")), na.rm = TRUE)) %>% arrange(desc(total_prop))
    tmp2 %>% head(50) %>% pull(sample_code)
    
    tmp2 <- tmp2 %>% 
        arrange(desc(total_prop)) %>% 
        mutate(sample_code = factor(sample_code, sample_code)) %>% 
        head(50)
    
    tmp_long <- tmp2 %>% 
        select(-total_prop) %>% 
        pivot_longer(
            cols      = -sample_code,
            names_to  = "population",
            values_to = "prop"
        ) 
    
    tmp_long$population = gsub("\\.prop","", tmp_long$population )
    tmp_long$condition_detailed_organ = mdata$condition_detailed_organ[match(tmp_long$sample_code, mdata$sample_code)]
    
    label_map = tmp_long %>% 
        distinct(sample_code, condition_detailed_organ) %>% 
        arrange(sample_code)
    lab_vec = label_map$condition_detailed_organ
    names(lab_vec) = label_map$sample_code
    
    
    pdf(sprintf("%s/BarplotTopSamples_%s.pdf", fig_dir, mycl),10, 8, useDingbats = F) #all cells
    p = ggplot(tmp_long, aes(x = sample_code, y = prop, fill = population)) +
        geom_bar(stat = "identity") +
        scale_fill_manual(values = immgent_colors$level2) +
        scale_x_discrete(labels = lab_vec) +
        theme_minimal() +
        labs(
            x    = "Sample",
            y    = "Proportion",
            fill = "Population"
        ) +
        ggtitle(sprintf("Top samples with CD8 %s - percent of total CD8", mycl)) +
        theme_minimal() +
        theme(
            panel.grid.major = element_blank(), # Removes major grid lines
            panel.grid.minor = element_blank(), # Removes minor grid lines
            # axis.title = element_blank(),       # Removes axis titles (e.g., "count")
            # axis.text = element_blank(),        # Removes axis labels/text (e.g., numbers on the axis)
            axis.ticks = element_blank(),        # Removes axis tick marks
            axis.text.x = element_text(angle = 45, hjust = 1)
        )
    print(p)
    dev.off()
    
}


```


**Plot Clusters across Timepoints in LCMV**

LT and NLT samples
```{r}
mdata = mdata_s
# mdata = mdata_sl1

lcmv = mdata %>% filter(IGT %in% c("IGT36", "IGT38", "IGT40") )
healthy = mdata %>% filter( organ_simplified %in% lcmv$organ_simplified & !(organ_simplified %in% "spleen") & condition_detailed == "baseline" & grepl(pattern = "allT|CD45p", x = target_cells_simplified))
healthy = healthy %>% group_by(organ_simplified) %>% sample_n(4)

tmp = mdata %>% filter(sample_code %in% c(lcmv$sample_code, healthy$sample_code))  %>% select(ends_with(".prop"),organ_simplified, timepoint, sample_code, condition_detailed, IGTHT)

tmp$timepoint[tmp$timepoint == ""] = "0 dpi"
# tmp = mdata %>% filter(infection_agent %in% c("LCMV armstrong", "LCMV Armstrong") & grepl(pattern = "allT|CD45p", x = target_cells_simplified) & organ_simplified == "spleen") %>% select(ends_with(".prop"), organ_simplified, timepoint, sample_code) 

# tmp = tmp %>% group_by(organ_simplified) %>% filter(any(condition_detailed == "baseline") & any(condition_detailed != "baseline"))

plot_data = tmp %>%
  # Reshape data from wide to long
  pivot_longer(
    cols = ends_with(".prop"),
    names_to = "population",
    values_to = "proportion"
  ) %>%
  # Clean up the population names (e.g., "CD4_cl1.prop" -> "CD4_cl1")
  mutate(population = str_remove(population, "\\.prop$")) %>%
  # Ensure timepoint is ordered correctly, not alphabetically
  mutate(timepoint = factor(timepoint, levels = c("0 dpi", "7 dpi", "30 dpi", "60 dpi")))

plot_data$level1 = sub("_.*" ,"",plot_data$population)
plot_data$annotation_level2.IGTHT = paste(plot_data$population, plot_data$IGTHT, sep = ".")

#Add ncells
plot_data_ncells = mdata %>% filter(sample_code %in% c(lcmv$sample_code, healthy$sample_code))  %>% select(ends_with(".ncells"),IGTHT) %>%
  pivot_longer(
    cols = ends_with(".ncells"),
    names_to = "population",
    values_to = "ncells"
  ) %>%
  # Clean up the population names (e.g., "CD4_cl1.prop" -> "CD4_cl1")
  mutate(population = str_remove(population, "\\.ncells$"))
plot_data_ncells$annotation_level2.IGTHT = paste(plot_data_ncells$population, plot_data_ncells$IGTHT, sep = ".")

plot_data$ncells = plot_data_ncells$ncells[match(plot_data$annotation_level2.IGTHT,plot_data_ncells$annotation_level2.IGTHT)]

p = ggplot(plot_data, aes(x = timepoint, y = proportion, color = population, group = population)) +
    # Add a summary line showing the mean trend for each population
    stat_summary(
        fun = "mean",
        geom = "line",
        linewidth = 1,
        alpha = 0.8
    ) +
    # Add points for each individual sample
    geom_point(
        # aes(shape = sample_code), # Optional: give each sample a different shape
        aes(size = ncells>10),
        # size = 2,
        alpha = 0.7
    ) +
    # Apply a nice color scale and theme
    scale_color_manual(values = mypal_level2) +
    scale_size_manual(values = c(0.5,2)) +
    theme_minimal() +
    labs(
        title = "Population Proportions Over Time, LCMV Arm, (% of all T cells)",
        x = "Timepoint",
        y = "Proportion",
        color = "Cell Population" # Rename the legend title
    ) +
    # Optional: hide the shape legend if it's too cluttered
    guides(shape = "none") +
    # Rotate x-axis labels if they overlap
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

pdf(sprintf("%s/LCMVarm_cluster_timecourse.pdf", fig_dir),20, 20, useDingbats = F) #all cells
# pdf(sprintf("%s/LCMVarm_cluster_timecourse_sl1.pdf", fig_dir),15, 15, useDingbats = F) #all cells
p + facet_grid(organ_simplified ~ level1, scales = "free", space  = "free_x")
p + facet_grid(organ_simplified ~ level1, scales = "free", space  = "free_x") +
    NoLegend() + 
    NoGrid()
dev.off()    


```

**Plot CITEseq for grant**

```{r}
so_orig = readRDS("igt1_96_withtotalvi20250710_clean_ADTonly.Rds")
so = so_orig[,so_orig$cite_seq == T & so_orig$annotation_level1 == "CD8" &  !(so_orig$annotation_level2 %in% c("CD8_miniverse", "CD8_prolif"))]

so = NormalizeData(so, assay = "ADT", normalization.method = "LogNormalize")

pdf("FeatureScatter_forgrant.pdf", 5, 5, useDingbats = F)
FeatureScatter(object = so, slot = "data", feature1 = "CD62L", feature2 = "CD44",group.by = "annotation_level2", raster = T, cols = mypal_level2, plot.cor = F) + NoLegend()
FeatureScatter(object = so[,so$annotation_level2 %in% c("CD8_cl7","CD8_cl10","CD8_cl11","CD8_cl12","CD8_cl13","CD8_cl14","CD8_cl15","CD8_cl28")], slot = "data", feature1 = "IL7RA.CD127", feature2 = "ITAX.CD11C",group.by = "annotation_level2", raster = T, cols = mypal_level2, pt.size = 1.5, plot.cor = F) + xlim(c(2,5)) + NoLegend()
FeatureScatter(object = so[,so$annotation_level2 %in% c("CD8_cl7","CD8_cl10","CD8_cl11","CD8_cl12","CD8_cl13","CD8_cl14","CD8_cl15","CD8_cl28")], slot = "data", feature1 = "IL7RA.CD127", feature2 = "KLRG1",group.by = "annotation_level2", raster = T, cols = mypal_level2, pt.size = 1.5, plot.cor = F) + xlim(c(2,5)) + NoLegend()
FeatureScatter(object = so[,so$annotation_level2 %in% c("CD8_cl14","CD8_cl15","CD8_cl28")], slot = "data", feature1 = "CD94", feature2 = "KLRG1",group.by = "annotation_level2", raster = F, cols = mypal_level2, plot.cor = F)  + xlim(c(1,6)) + ylim(c(1,7)) + NoLegend()
FeatureScatter(object = so[,so$annotation_level2 %in% c("CD8_cl7","CD8_cl10","CD8_cl11")], slot = "data", feature1 = "CD39", feature2 = "CD73.5NTD",group.by = "annotation_level2", raster = F, cols = mypal_level2, plot.cor = F)  + xlim(c(1,6)) + ylim(c(1,8)) + NoLegend()
FeatureScatter(object = so[,so$annotation_level2 %in% c("CD8_cl7","CD8_cl10","CD8_cl11")], slot = "data", feature1 = "CD49A", feature2 = "CD103",group.by = "annotation_level2", raster = F, cols = mypal_level2, plot.cor = F)  + xlim(c(1,6)) + ylim(c(1,8)) + NoLegend()
FeatureScatter(object = so[,so$annotation_level2 %in% c("CD8_cl7","CD8_cl10","CD8_cl11")], slot = "data", feature1 = "HAVCR2", feature2 = "GITR.CD357",group.by = "annotation_level2", raster = F, cols = mypal_level2, plot.cor = F) + xlim(c(1,6)) + ylim(c(1,6)) + NoLegend()
dev.off()
```

**Figure: cumulative number of clusters**

```{r}
library(dplyr)

## 1. Count cells per IGT × annotation_level2
df_counts <- so@meta.data %>%
  as.data.frame() %>%
  count(IGT, annotation_level2, name = "n_cells") %>%
  mutate(
    IGT_num = as.numeric(gsub("[^0-9]", "", IGT))   # extract numeric part to sort IGT1..IGT96
  )

## 2. Cumulative # cells per cluster across IGTs
df_cum <- df_counts %>%
  arrange(annotation_level2, IGT_num) %>%          # for each cluster, go in IGT order
  group_by(annotation_level2) %>%
  mutate(
    cum_n_cells = cumsum(n_cells)                  # cumulative # cells in this cluster up to this IGT
  ) %>%
  ungroup()

## 3. For each IGT, how many clusters have cum_n_cells > 20 so far?
# igt_cum_clusters <- df_cum %>%
#   group_by(IGT, IGT_num) %>%
#   summarise(
#     n_clusters_gt20 = sum(cum_n_cells > 20),
#     .groups = "drop"
#   ) %>%
#   arrange(IGT_num)

discovery_tbl <- df_cum %>%
  filter(cum_n_cells > 100) %>%                   # only steps where it’s above threshold
  group_by(annotation_level2) %>%
  summarise(
    first_IGT_num = min(IGT_num),                # first time this cluster crosses 20 cells
    .groups = "drop"
  )

## 4. Walk through IGTs in order and compute cumulative discovery
igt_steps <- df_cum %>%
  distinct(IGT, IGT_num) %>%
  arrange(IGT_num)

igt_steps$n_new <- 0L

for (i in seq_len(nrow(igt_steps))) {
  current_num <- igt_steps$IGT_num[i]
  # how many clusters cross the threshold for the FIRST time at this IGT?
  igt_steps$n_new[i] <- sum(discovery_tbl$first_IGT_num == current_num)
}

igt_steps$cum_clusters <- cumsum(igt_steps$n_new)

igt_steps
igt_steps = igt_steps %>% arrange(IGT_num)
igt_steps$IGT = factor(igt_steps$IGT, levels = igt_steps$IGT)

pdf(sprintf("%s/CumulativeNumberClusters_immgenT_CD8.pdf", out_dir,i), 10,5, useDingbats = F)
p = ggplot(igt_steps, aes(x = IGT, y = cum_clusters, group = 1)) +
  geom_line() +
  geom_point(size = 1.5) +
    geom_hline(yintercept = 21, colour = "brown", linetype = "dashed", size = 0.5) +
  # scale_x_continuous(breaks = igt_steps$IGT_num,labels = igt_steps$IGT) +
  labs(
    x = "IGT",
    y = "Cumulative # clusters (cum_n_cells > 100)",
    title = "Cumulative discovery of clusters across IGTs",
    subtitle = "number of clusters detected=cumsum reaching least 100 cells"
  ) +
    ylim(0,22) +
  theme_bw(base_size = 11) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
p + NoGrid()
dev.off()


```

104024 cells
```{r}
so_merged_orig = readRDS("trbi_17studies_diet_merged.Rds")
# so_merged_orig$level1_final[so_merged_orig$dataset == "GSE199563"] = "CD8"
so_merged = so_merged_orig[,so_merged_orig@meta.data %>% filter(level1_final %in% "CD8", dataset %in% c("GSE244487", "GSE122712","GSE131535", "GSE164978", "GSE202543", "GSE186164", "GSE129030", "TabulaMuris")) %>% row.names()]
so_merged@meta.data %>% count(dataset, name = "ncells") %>% write.table(sprintf("%s/TRBI_CD8_studies.txt",out_dir), row.names = F, quote = F)

igt_bkrg = data.frame(dim1 = so[["mde_incremental"]]@cell.embeddings[,1], dim2 = so[["mde_incremental"]]@cell.embeddings[,2])
bkrg = ggplot(igt_bkrg) + geom_scattermore(aes(dim1, dim2), colour = "grey", alpha = 0.5, pixels = c(1024, 1024))

dat_frg = data.frame(so_merged@meta.data[rownames(so_merged[["mde_incremental_level2"]]),], dim1 = so_merged[["mde_incremental_level2"]]@cell.embeddings[,1], dim2 = so_merged[["mde_incremental_level2"]]@cell.embeddings[,2])


pdf(sprintf("%s/TRBI_MDEmain_level2_perdataset.pdf", out_dir), 5,5, useDingbats = F)
p = bkrg + geom_scattermore(data = dat_frg, aes(dim1, dim2, color = dataset), size =2, pixels = c(c(1024, 1024))) + scale_color_manual(values = mypal) + theme_void() + xlim(-3,3) + ylim(-3,3) + NoGrid() 
p
p + NoLegend()
p = bkrg + geom_scattermore(data = dat_frg, aes(dim1, dim2, color = level2_final), size =2, pixels = c(c(1024, 1024))) + ggtitle(label = "CD8 level2")+ scale_color_manual(values = c(mypal_level2)) + theme_void() + xlim(-3,3) + ylim(-3,3) + NoGrid() 
p + NoLegend()
for (i in unique(dat_frg$dataset)) {
    print(i)
   p = bkrg + geom_scattermore(data = dat_frg %>% filter(dataset == i), aes(dim1, dim2, color = level2_final), size =2, pixels = c(c(1024, 1024))) + scale_color_manual(values = mypal_level2) + ggtitle(label = i) + theme_void() + xlim(-3,3) + ylim(-3,3) + NoGrid() + NoLegend()
   print(p)
}
dev.off()
# DimPlot(so_merged, reduction = "mde_incremental_allT",group.by = "level1_final", raster.dpi = c(1024, 1024)) + scale_color_manual(values = mypal_level1) + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()
# DimPlot(so_merged, reduction = "mde_incremental_allT",group.by = "is_nont", raster.dpi = c(1024, 1024)) + scale_color_manual(values = c("grey", "red")) + xlim(-2.5,2.5) + ylim(-2.5,2.5) + NoGrid() + NoLegend()

```


**Odhran integration plots**

Background CD8 immgenT
```{r}
so_orig = readRDS("../igt1_96_withtotalvi20250710_clean_ADTonly.Rds")
so_orig[["mde_incremental_level2"]] = so_orig[["mde_incremental"]] 
so_orig[["mde_incremental_allT"]] = so_orig[["mde2_totalvi_20241006"]] 

so = so_orig[,so_orig$annotation_level1 == "CD8"]

so$sample = "immgent"

DimPlot(so, reduction = "mde_incremental_level2", group.by = "annotation_level2", cols = mypal_level2)
MyDimPlotHighlight(so, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation_level2", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T)
```

https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE122712
```{r}
query_dir = '/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE122712/gdT_all_TRIAL_zero_separate_SCVIs'
so_query = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE122712/gdT_all_TRIAL_zero_separate_SCVIs/Final_Seurat_object.Rds') 
so_query

head(so_query@meta.data)
table(so_query$cluster)
table(so_query$level2_final)
table(so_query$batch)
table(so_query$level2_plot, so_query$cluster)
table(so_query$level2_plot, so_query$level1_final)

sub = so_query@meta.data %>% filter(level1_final == "CD8" & !is.na(cluster)) %>% row.names()
# p1 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "annotation", cols = mypal)
# p2 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "level2_plot", cols = mypal_level2)
# p1 + p2
# FeaturePlot(so_query[,sub], reduction = "mde_incremental_level2", features = "Pdcd1")

so2 = merge(so, so_query[,sub], merge.dr = T)

mypal_annotation = mypal_level1 = setNames(c("brown", "darkblue", "purple", "pink", "green"),na.omit(unique(so_query$annotation)))


MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_plot", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = F)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_plot", mycols = mypal_level2)

p1 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "annotation", cols = mypal_annotation)
p2 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "level2_plot", cols = mypal_level2)
p1 + p2
dev.off()

pdf(sprintf("%s/GSE122712_RBI_byclust.pdf",query_dir),7, 7, useDingbats = F)
for (s in na.omit(unique(so_query$annotation))) {
    print(s)
    print(MyDimPlotHighlight(so2[,so2$annotation %in% c(s) | so2$sample %in% c("immgent")], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_plot", highlight_size = 3, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("authors annotation: %s", s)))
    print(MyDimPlotHighlight(so2[,so2$annotation %in% c(s) | so2$sample %in% c("immgent")], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", highlight_size = 3, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("authors annotation: %s", s)))
    # print(MyDimPlotHighlight(so2[,so2$sample %in% c("immgent", s)], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample: %s", s)))
}
dev.off()
```

https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE122675
tumor data don't have annotation and umap in the paper so forget. GSE122712 is the other part of the paper
```{r}
so_query = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE122675/gdT_all_TRIAL_zero_separate_SCVIs/Final_Seurat_object.Rds') 
so_query

head(so_query@meta.data)
table(so_query$cluster)
table(so_query$level2_final)
table(so_query$batch)
table(so_query$level2_final, so_query$cluster)
table(so_query$level2_final, so_query$level1_final)

sub = so_query@meta.data %>% filter(level1_final == "CD8" & !is.na(annotation)) %>% row.names()
so2 = merge(so, so_query[,sub], merge.dr = T)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_plot", mycols = mypal_level2)
p1 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "annotation", cols = mypal)
p2 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "level2_plot", cols = mypal_level2)

p1 + p2



```

https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE131535
```{r}
query_dir = '/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE131535/gdT_all_TRIAL_zero_separate_SCVIs/'
so_query = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE131535/gdT_all_TRIAL_zero_separate_SCVIs/Final_Seurat_object.Rds') 
so_query

head(so_query@meta.data)
table(so_query$cluster)
table(so_query$level2_plot)
table(so_query$batch)
table(so_query$batch_sample)
table(so_query$level2_plot, so_query$cluster)
table(so_query$level2_plot, so_query$level1_final)

so_query$sample = as.integer(sub('.*-(\\d+)$', '\\1', colnames(so_query)))

sub = so_query@meta.data %>% filter(level1_final == "CD8" & !(level2_plot %in% c("not classified"))) %>% row.names()
# p1 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "annotation", cols = mypal)
# p2 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "level2_plot", cols = mypal_level2)
# p1 + p2
# FeaturePlot(so_query[,sub], reduction = "mde_incremental_level2", features = "Pdcd1")

so2 = merge(so, so_query[,sub], merge.dr = T)


mypal_annotation = setNames(c("brown", "darkblue", "purple", "pink", "green"),na.omit(unique(so_query$annotation)))
mypal_annotation = mypal

pdf(sprintf("%s/GSE131535_RBI.pdf",query_dir),7, 7, useDingbats = F)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_plot", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T)
# MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F)
for (s in unique(so_query$sample)) {
    print(s)
    print(MyDimPlotHighlight(so2[,so2$sample %in% c("immgent", s)], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_plot", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(so2[,so2$sample %in% c("immgent", s)], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
}

# p1 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "annotation", cols = mypal_annotation)
# p2 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "level2_plot", cols = mypal_level2)
# p1 + p2
dev.off()


```

https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE182275
```{r}
query_dir = '/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE182275/gdT_all_TRIAL_zero_separate_SCVIs'
so_query = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE182275/gdT_all_TRIAL_zero_separate_SCVIs/Final_Seurat_object.Rds') 
so_query

head(so_query@meta.data)
table(so_query$cluster)
table(so_query$level2_plot)
table(so_query$batch)
table(so_query$tissue)
table(so_query$annotation, so_query$tissue)

table(so_query$batch_sample)
table(so_query$level2_plot, so_query$cluster)
table(so_query$level2_plot, so_query$level1_final)
so_query$annotation = paste("cl", so_query$annotation, sep = "_")


# so_query$sample = as.integer(sub('.*-(\\d+)$', '\\1', colnames(so_query)))

sub = so_query@meta.data %>% filter(level1_final == "CD8" & !(level2_plot %in% c("not classified"))) %>% row.names()
# p1 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "annotation", cols = mypal)
# p2 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "level2_plot", cols = mypal_level2)
# p1 + p2
# FeaturePlot(so_query[,sub], reduction = "mde_incremental_level2", features = "Pdcd1")

so2 = merge(so, so_query[,sub], merge.dr = T)

mypal_annotation = setNames(c("#5D7AA5", "#BED4EB", "#E59339", "#F5CA8F", "#6FA649", "#B9E185", "#B29A39", "#EFD374", "#649B9F", "#A9CBC2", "#D2635A", "#F3B0B0"), c("cl_0", "cl_1", "cl_2", "cl_3", "cl_4", "cl_5", "cl_6", "cl_7", "cl_8", "cl_9", "cl_10", "cl_11"))
# mypal_annotation = mypal

pdf(sprintf("%s/GSE182275_RBI.pdf",query_dir),7, 7, useDingbats = F)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_plot", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "tissue", mycols = mypal, print_plot1 = T, print_plot2 = T,labelclusters = F)
# MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F)
for (s in unique(so_query$tissue)) {
    print(s)
    print(MyDimPlotHighlight(so2[,so2$tissue %in% c(s) | so2$sample %in% c("immgent")], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_plot", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    print(MyDimPlotHighlight(so2[,so2$tissue %in% c(s) | so2$sample %in% c("immgent")], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(so2[,so2$sample %in% c("immgent", s)], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample: %s", s)))
}

# p1 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "annotation", cols = mypal_annotation)
# p2 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "level2_plot", cols = mypal_level2)
# p1 + p2
dev.off()


```

Spranger data
```{r}
query_dir = '/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/Spranger_Data/gdT_all_TRIAL_zero_separate_SCVIs'
so_query = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/Spranger_Data/gdT_all_TRIAL_zero_separate_SCVIs/Final_Seurat_object.Rds') 
so_query

head(so_query@meta.data)
table(so_query$level2_plot)

table(so_query$level2_plot, so_query$cluster)
table(so_query$level2_plot, so_query$level1_final)
so_query$annotation = paste("cl", so_query$annotation, sep = "_")
so_query$sample = so_query$IGTHT

sub = so_query@meta.data %>% filter(level1_final == "CD8" & !(level2_plot %in% c("not classified"))) %>% row.names()
# p1 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "annotation", cols = mypal)
# p2 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "level2_plot", cols = mypal_level2)
# p1 + p2
# FeaturePlot(so_query[,sub], reduction = "mde_incremental_level2", features = "Pdcd1")

so2 = merge(so, so_query[,sub], merge.dr = T)

# mypal_annotation = setNames(c("#5D7AA5", "#BED4EB", "#E59339", "#F5CA8F", "#6FA649", "#B9E185", "#B29A39", "#EFD374", "#649B9F", "#A9CBC2", "#D2635A", "#F3B0B0"), c("cl_0", "cl_1", "cl_2", "cl_3", "cl_4", "cl_5", "cl_6", "cl_7", "cl_8", "cl_9", "cl_10", "cl_11"))
mypal_annotation = mypal
mypal_sample = mypal

pdf(sprintf("%s/Spranger_RBI_biggerpoints.pdf",query_dir),7, 7, useDingbats = F)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_plot", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "sample", mycols = mypal, print_plot1 = T, print_plot2 = T,labelclusters = F)
# MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F)
for (s in unique(so_query$sample)) {
    print(s)
    print(MyDimPlotHighlight(so2[,so2$sample %in% c(s) | so2$sample %in% c("immgent")], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_plot", highlight_size = 3, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    print(MyDimPlotHighlight(so2[,so2$sample %in% c(s) | so2$sample %in% c("immgent")], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", highlight_size = 3, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(so2[,so2$sample %in% c("immgent", s)], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample: %s", s)))
}

# p1 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "annotation", cols = mypal_annotation)
# p2 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "level2_plot", cols = mypal_level2)
# p1 + p2
dev.off()

sub = so_query@meta.data %>% filter(!(level2_plot %in% c("not classified"))) %>% row.names()
so2 = merge(so_orig, so_query[,sub], merge.dr = T)
head(so2@meta.data)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_allT", cells_to_highlight = sub, highlight_column_name =  "level2_plot", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T)


###
so_query <- so_query %>%
  NormalizeData(normalization.method = "LogNormalize", scale.factor = 1e4, verbose = T) %>%
  FindVariableFeatures(selection.method = "vst", nfeatures = 2000, verbose = T) %>%
  ScaleData(features = VariableFeatures(.), verbose = T) %>%     # note the "."
  RunPCA(features = VariableFeatures(.), npcs = 50, verbose = T) %>%
  FindNeighbors(dims = 1:30, verbose = T) %>%
  RunUMAP(dims = 1:30, seed.use = 123, verbose = T)
DimPlot(so_query, reduction = "umap", group.by = "level2_plot", cols = immgent_colors$level2_option2)
DimPlot(so_query, reduction = "umap", group.by = "level1_final", cols = immgent_colors$level1)
FeaturePlot(so_query, features = c("Cd4"))
p1 = DimPlot(so_query[,so_query$level1_final == "CD4"], reduction = "umap", group.by = "level1_final", cols = immgent_colors$level1)
p2 = FeaturePlot(so_query, features = c("Cd4"))
p1+p2

p1 = DimPlot(so_query[,so_query$level1_final == "Treg"], reduction = "umap", group.by = "level2_final", cols = immgent_colors$level2) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
p2 = FeaturePlot(so_query, features = c("Foxp3")) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
p1+p2

p1 = DimPlot(so_query[,so_query$level1_final == "CD8"], reduction = "umap", group.by = "level2_plot", cols = immgent_colors$level2) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
p2 = FeaturePlot(so_query, features = c("Cd8b1")) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
p1+p2

p1 = DimPlot(so_query[,so_query$level1_final != "not classified"], reduction = "umap", group.by = "level1_final", cols = immgent_colors$level1) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
p2 = FeaturePlot(so_query[,so_query$level1_final != "not classified"], features = c("Foxp3")) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
p1+p2



```

CD8 atlas
```{r}
query_dir = '/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE164978_CD8_atlas/gdT_all_TRIAL_zero_separate_SCVIs/Final_Seurat_object.Rds'
so_query = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE164978_CD8_atlas/gdT_all_TRIAL_zero_separate_SCVIs/Final_Seurat_object.Rds') 
so_query %>% NormalizeData(assay = "RNA", normalization.method = "LogNormalize")

head(so_query@meta.data)
table(so_query$level2_plot)


so_query

sub = so_query@meta.data %>% filter(!(level2_plot %in% c("not classified"))) %>% row.names()
sub = so_query@meta.data %>% sample_n(10000) %>% row.names()
so2 = merge(so_orig, so_query[,sub], merge.dr = T)
head(so2@meta.data)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_allT", cells_to_highlight = sub, highlight_column_name =  "level2_plot", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T)

p1 = DimPlot(so_query[,sub], reduction = "mde_incremental_allT", group.by = "level1_final", cols = immgent_colors$level1) + ggplot2::xlim(c(-2,2)) + ggplot2::ylim(c(-2,2))
p1
p2 = FeaturePlot(so_query[,sub], reduction = "mde_incremental_allT",  slot = "counts", features = c("Cd8a")) + ggplot2::xlim(c(-2,2)) + ggplot2::ylim(c(-2,2))
p1 + p2




```

GSE202543 CAR T
```{r}
query_dir = '/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE202543_Giovanni_CAR_T/Trial_Final/'
so_query = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/GSE202543_Giovanni_CAR_T/Trial_Final/Final_Seurat_object.Rds') 
so_query_orig = so_query

head(so_query@meta.data)
table(so_query$level2_plot)

so_query@meta.data %>% group_by(IGTHT) %>% count()
so_query@meta.data %>% group_by(level2_final) %>% count() %>% as.data.frame()
so_query@meta.data %>% group_by(annotation) %>% count() %>% as.data.frame()
so_query@meta.data %>% filter(!is.na(annotation)) %>% group_by(level2_final) %>% count() %>% as.data.frame()

so_query = so_query_orig[,so_query_orig@meta.data %>% filter(!is.na(annotation)) %>% row.names()]

p1 = DimPlot(so_query, reduction = "mde_incremental_level2", group.by = "annotation", cols = mypal)
p2 = DimPlot(so_query, reduction = "mde_incremental_level2", group.by = "level2_final", cols = mypal_level2)
p1 + p2
FeaturePlot(so_query, reduction = "mde_incremental_level2", features = "Pdcd1")

so_query$annotation = paste("cl", so_query$annotation, sep = "_")
so_query$sample = so_query$IGTHT

# sub = so_query@meta.data %>% filter(level1_final == "CD8" & !(level2_plot %in% c("not classified"))) %>% row.names()
# so2 = merge(so, so_query[,sub], merge.dr = T)

so2 = merge(so, so_query, merge.dr = T)
so2@meta.data %>% group_by(sample) %>% count()

# mypal_annotation = setNames(c("#BFD3EA", "#689AC5", "#E59339", "#487EB5", "#6FA649", "#B9E185", "#B29A39", "#EFD374", "#649B9F", "#A9CBC2", "#D2635A", "#F3B0B0"), c("cl_0", "cl_1", "cl_2", "cl_3", "cl_4", "cl_5", "cl_6", "cl_7", "cl_8", "cl_9", "cl_10", "cl_11"))
mypal_annotation = c(cl_0 = "#BFD3EA", 
                     cl_1 = "#689AC5", 
                     cl_2 = "#DE4D3B", 
                     cl_3= "#487EB5",
                     cl_4 ="#C15935",
                     cl_5 = "#F1B873",
                     cl_6 = "#66549E",
                     cl_7 = "#5B1318",
                     cl_8 = "#B2D5A7",
                     cl_9 = "#9E99C7",
                     cl_10 = "#DEEAD1")
mypal_annotation = mypal
mypal_sample = mypal

sub = so2@meta.data %>% filter(sample != "immgent") %>% row.names()
pdf(sprintf("%s/RBI.pdf",query_dir),10, 10, useDingbats = F)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_final", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "sample", mycols = mypal, print_plot1 = T, print_plot2 = T,labelclusters = F)
# MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F)
for (s in unique(so_query$sample)) {
    print(s)
    tmp = so2[,so2$sample %in% c(s) | so2$sample %in% c("immgent")]
    print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "level2_final", highlight_size = 1, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "annotation", highlight_size = 1, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "level2_final", highlight_size = 1, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "annotation", highlight_size = 1, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(so2[,so2$sample %in% c("immgent", s)], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample: %s", s)))
}

# p1 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "annotation", cols = mypal_annotation)
# p2 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "level2_plot", cols = mypal_level2)
# p1 + p2
dev.off() 

# pdf(sprintf("%s/RBI_sidebyside.pdf",query_dir),50, 10, useDingbats = F)
p1_author = list()
p1_immgent = list()
stacked_list = list()
for (s in unique(so_query$sample)) {
    print(s)
    tmp = so2[,so2$sample %in% c(s) | so2$sample %in% c("immgent")]
    p = MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "level2_final", highlight_size = 1, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s))
    p1_immgent[[s]] = p$plot1
    p = MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "annotation", highlight_size = 1, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s))
    p1_author[[s]] = p$plot1
    # print(p1_author[[s]] + NoGrid() + p1_immgent[[s]] + theme_void() + NoLegend() + ggtitle(label = NULL) )
    stacked_list[[s]] = wrap_plots(list(p1_author[[s]] + theme_void() + NoLegend(), 
                              p1_immgent[[s]] + theme_void() + NoLegend() + ggtitle(label = NULL) ), ncol = 1) + plot_layout(axes = "collect_x", guides = "collect") 
    # print(stacked_list[[s]])
    # print(MyDimPlotHighlight(so2[,so2$sample %in% c("immgent", s)], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample: %s", s)))
}
pdf(sprintf("%s/RBI_sidebyside.pdf",query_dir),50, 10, useDingbats = F)
print(wrap_plots(stacked_list, nrow = 1) + plot_layout(axes = "collect_y", guides = "collect"))
dev.off()

for (s in unique(so_query$sample)) {
    p1_immgent[[s]] + p1_author[[s]]
}



sub = so_query@meta.data %>% filter(!(level2_plot %in% c("not classified"))) %>% row.names()
so2 = merge(so_orig, so_query[,sub], merge.dr = T)
head(so2@meta.data)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_allT", cells_to_highlight = sub, highlight_column_name =  "level2_plot", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T)


```


Laurent_CD8_nonconv... dataset is the CD8 atlas..
```{r}
query_dir = '/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/Laurent_CD8_nonconv/Trial_Final'
so_query = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/CD8/Laurent_CD8_nonconv/Trial_Final/Final_Seurat_object.Rds') 
so_query_orig = so_query

head(so_query@meta.data)
table(so_query$level2_plot)

so_query@meta.data %>% group_by(IGTHT) %>% count()
so_query@meta.data %>% group_by(level2_final) %>% count() %>% as.data.frame()

so_query = so_query_orig[,so_query_orig@meta.data %>% filter(!is.na(annotation)) %>% row.names()]

# p1 = DimPlot(so_query, reduction = "mde_incremental_level2", group.by = "annotation", cols = mypal)
# p2 = DimPlot(so_query, reduction = "mde_incremental_level2", group.by = "level2_final", cols = mypal_level2)
# p1 + p2
# FeaturePlot(so_query, reduction = "mde_incremental_level2", features = "Pdcd1")

# so_query$annotation = paste("cl", so_query$annotation, sep = "_")
so_query$sample = so_query$IGTHT

# sub = so_query@meta.data %>% filter(level1_final == "CD8" & !(level2_plot %in% c("not classified"))) %>% row.names()
# so2 = merge(so, so_query[,sub], merge.dr = T)

so2 = merge(so, so_query, merge.dr = T)
so2@meta.data %>% group_by(sample) %>% count()

# mypal_annotation = setNames(c("#BFD3EA", "#689AC5", "#E59339", "#487EB5", "#6FA649", "#B9E185", "#B29A39", "#EFD374", "#649B9F", "#A9CBC2", "#D2635A", "#F3B0B0"), c("cl_0", "cl_1", "cl_2", "cl_3", "cl_4", "cl_5", "cl_6", "cl_7", "cl_8", "cl_9", "cl_10", "cl_11"))
# mypal_annotation = c(cl_0 = "#BFD3EA",
#                      cl_1 = "#689AC5",
#                      cl_2 = "#DE4D3B",
#                      cl_3= "#487EB5",
#                      cl_4 ="#C15935",
#                      cl_5 = "#F1B873",
#                      cl_6 = "#66549E",
#                      cl_7 = "#5B1318",
#                      cl_8 = "#B2D5A7",
#                      cl_9 = "#9E99C7",
#                      cl_10 = "#DEEAD1")
# mypal_annotation = mypal
mypal_sample = mypal

sub = so2@meta.data %>% filter(sample != "immgent") %>% row.names()
pdf(sprintf("%s/RBI.pdf",query_dir),7, 7, useDingbats = F)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_final", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, xlim = c(-3,3), ylim = c(-3,3))
# MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "sample", mycols = mypal, print_plot1 = T, print_plot2 = T,labelclusters = F, xlim = c(-3,3), ylim = c(-3,3))
# MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F)
for (s in unique(so_query$sample)) {
    print(s)
    tmp = so2[,so2$sample %in% c(s) | so2$sample %in% c("immgent")]
    print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "level2_final", highlight_size = 3, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(so2[,so2$sample %in% c(s) | so2$sample %in% c("immgent")], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", highlight_size = 3, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(so2[,so2$sample %in% c("immgent", s)], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample: %s", s)))
}

# p1 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "annotation", cols = mypal_annotation)
# p2 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "level2_plot", cols = mypal_level2)
# p1 + p2
dev.off()

# sub = so_query@meta.data %>% filter(!(level2_plot %in% c("not classified"))) %>% row.names()
# so2 = merge(so_orig, so_query[,sub], merge.dr = T)
# head(so2@meta.data)
# MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_allT", cells_to_highlight = sub, highlight_column_name =  "level2_plot", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T)


###UMAP from the samples
so_query <- so_query %>%
  NormalizeData(normalization.method = "LogNormalize", scale.factor = 1e4, verbose = T) %>%
  FindVariableFeatures(selection.method = "vst", nfeatures = 2000, verbose = T) %>%
  ScaleData(features = VariableFeatures(.), verbose = T) %>%     # note the "."
  RunPCA(features = VariableFeatures(.), npcs = 50, verbose = T) %>%
  FindNeighbors(dims = 1:30, verbose = T) %>%
  RunUMAP(dims = 1:30, seed.use = 123, verbose = T)
DimPlot(so_query, reduction = "umap", group.by = "level2_final", cols = immgent_colors$level2)
DimPlot(so_query, reduction = "umap", group.by = "level1_final", cols = immgent_colors$level1)
FeaturePlot(so_query, features = c("Cd4"))
p1 = DimPlot(so_query[,so_query$level1_final == "CD4"], reduction = "umap", group.by = "level1_final", cols = immgent_colors$level1)
p2 = FeaturePlot(so_query, features = c("Cd4"))
p1+p2

p1 = DimPlot(so_query[,so_query$level1_final == "Treg"], reduction = "umap", group.by = "level2_final", cols = immgent_colors$level2) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
p2 = FeaturePlot(so_query, features = c("Foxp3")) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
p1+p2

p1 = DimPlot(so_query[,so_query$level1_final == "CD8"], reduction = "umap", group.by = "level2_plot", cols = immgent_colors$level2) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
p2 = FeaturePlot(so_query, features = c("Cd8b1")) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
p1+p2

p1 = DimPlot(so_query[,so_query$level1_final != "not classified"], reduction = "umap", group.by = "level1_final", cols = immgent_colors$level1) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
p2 = FeaturePlot(so_query[,so_query$level1_final != "not classified"], features = c("Foxp3")) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
p1+p2



```



