---
title: "composition_analysis"
output: html_document
date: "2024-10-24"
author: "David Zemmour"
editor_options: 
  chunk_output_type: console
---

**Initialize: load libraries and custom functions**

```{bash}
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=jfkfloor2 --qos=jfkfloor2 --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=beagle3-bigmem --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=zemmour-hm --qos=zemmour --nodes=1 
sinteractive --time=03:00:00 --account=pi-zemmour --partition=caslake --nodes=1 --mem=96GB

module load python/anaconda-2022.05 
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13
#source activate /project/zemmour/david/envs/scvi_20240315
source activate /project/zemmour/david/envs/r443
module load openblas/0.3.13

cd /project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD8
R
```

Figures folder
```{r}
fig_dir = "~/google_drive_uchicago/ImmgenT/20250109_freeze/CD8/paper_CD8/figures/bits_david"
```


```{r}
# setwd("~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96")
libs = c("ZemmourLib","Seurat","lme4", "emmeans", "lmerTest", "tidyr", "ggplot2", "dplyr", "RColorBrewer", "pals", "scales", "reshape2", "pheatmap", "scattermore", "limma", "ggbeeswarm") 
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))
# source("/project/jfkfloor2/zemmourlab/david/immgent/immgent_integration_git/custom_functions_david.R")

ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
ColorRamp = rev(rainbow(10, end = 4/6))
ColorRamp = rev(viridis(100))
ColorRamp = brewer.pal(9, "Blues")

#mycol = c("black","blue","red","darkgreen", "orange","purple", "cyan", "greenyellow",    "salmon", "magenta","pink", "tan", "brown") # c("magenta", "red",  "darkgreen", "cyan", "blue", "blue", "blue", "black", "blue", "blue", "blue", "blue", "orange")

n = 70
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
mypal1 = unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals))))
mypal1 = mypal1[-4]

library("pals")
parade = function(n) { return(Seurat::DiscretePalette(n, palette = "parade", shuffle = F)) }

length(glasbey())
length(polychrome())
mypal = c(glasbey(), polychrome(), mypal1)
names(mypal) = NULL

mypal_organ = setNames(mypal, unique(so$organ_simplified))
mypal_organ["other"] = "grey"
mypal_organ = mypal_organ[!is.na(names(mypal_organ))]
mypal_organ = setNames(mypal, unique(mdata_orig$organ_simplified))
mypal_organ["other"] = "grey"
mypal_organ = mypal_organ[!is.na(names(mypal_organ))]

mypal_level1 = setNames(mypal, unique(so$annotation_level1))
mypal_level1 = mypal_level1[!is.na(names(mypal_level1))]

mypal_level2 = setNames(mypal, unique(so$annotation_level2))
mypal_level2 = mypal_level2[!is.na(names(mypal_level2))]

mypal_condition_broad = setNames(mypal, unique(so$condition_broad))
mypal_condition_broad = mypal_condition_broad[!is.na(names(mypal_condition_broad))]

mypal_condition_broad = setNames(mypal, unique(mdata_orig$condition_broad))
mypal_condition_broad = mypal_condition_broad[!is.na(names(mypal_condition_broad))]
mypal_condition_broad["healthy"] = "black"
mypal_condition_broad["allergy"] = mypal[60]

mypal_condition_detailed_simplified = setNames(mypal, unique(so$condition_detailed_simplified))
mypal_condition_detailed_simplified = mypal_condition_detailed_simplified[!is.na(names(mypal_condition_detailed_simplified))]

mypal_igt = setNames(mypal, unique(so$IGT))
mypal_igt = mypal_igt[!is.na(names(mypal_igt))]
```

**Most up-to-date data**

```{r}
# so_orig = readRDS("igt1_96_withtotalvi20250317_clean.Rds")
so_orig = readRDS("igt1_96_withtotalvi20250513_clean.Rds")
so = so[,so$annotation_level1 == "CD8"]
so$Ag_spe[is.na(so$Ag_spe)] = "poly"

prefix = "CD8"

so@meta.data %>% select(IGT, infection_agent) %>% unique()
so@meta.data %>% select(IGT, tumor, Ag_spe) %>% unique()

```

LCMV arm
```{r}
DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level2", raster = T, raster.dpi = c(512,512), label = T) + scale_color_manual(values = mypal) + theme_void() + NoLegend() 

ia = "LCMV armstrong"
igts = c("IGT36", "IGT38", "IGT40")
orgs = unique(so$organ_simplified)
as = c("P14", "poly")

ip = c("acute")
pdf(sprintf("%s/MDE_LCMVarm_acutephase_20250402.pdf", prefix), 5, 5, useDingbats = F)
for (o in orgs) {
    for (a in as) {
        ch = colnames(so)[so$infection_agent %in% ia & so$IGT %in% igts & so$infection_phase %in% ip & so$organ_simplified %in% o & so$Ag_spe %in% a]
        if (length(ch) != 0 ) {
            print(sprintf("%s %s %s %s", ia, ip, o, a))
            print(length(ch))
            MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = ch, highlight_column_name = "annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level2, print_plot1 = T, print_plot2 = T, labelclusters = F, title = sprintf("%s %s %s %s", ia, ip, o, a) )
            rm(ch)
        }
    }
}
dev.off()

ip = c("cleared")
pdf(sprintf("%s/MDE_LCMVarm_latephase_20250402.pdf", prefix), 5, 5, useDingbats = F)
for (o in orgs) {
    for (a in as) {
        ch = colnames(so)[so$infection_agent %in% ia & so$IGT %in% igts & so$infection_phase %in% ip & so$organ_simplified %in% o & so$Ag_spe %in% a]
        if (length(ch) != 0 ) {
            print(sprintf("%s %s %s %s", ia, ip, o, a))
            print(length(ch))
            MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = ch, highlight_column_name = "annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level2, print_plot1 = T, print_plot2 = T, labelclusters = F, title = sprintf("%s %s %s %s", ia, ip, o, a) )
            rm(ch)
        }
    }
}


dev.off()

pdf(sprintf("%s/MDE_IGT36_38_40_48_spleen_standard.pdf", prefix), 5, 5, useDingbats = F)
ch = colnames(so)[so$IGT %in% c("IGT36", "IGT38", "IGT40", "IGT48") & so$spleen_standard == T]
MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = ch, highlight_column_name = "annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level2, print_plot1 = T, print_plot2 = T, labelclusters = F, title = "spleen standard" )
dev.off()

```

B16
```{r}
# igts = c("IGT35")
spls = unique(so$sample_type[so$IGT == "IGT35"])
as = c("P14", "poly")

pdf(sprintf("%s/MDE_B16.gp33_20250402.pdf", prefix), 5, 5, useDingbats = F)
for (s in spls) {
    for (a in as) {
        ch = colnames(so)[so$sample_type %in% s & so$Ag_spe %in% a ] #
        if (length(ch) != 0 ) {
            print(sprintf("%s %s", s, a))
            print(length(ch))
            MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = ch, highlight_column_name = "annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level2, print_plot1 = T, print_plot2 = T, labelclusters = F, title = sprintf("%s %s", s,  a) )
            rm(ch)
        }
    }
}
dev.off()


```

KP
```{r}
# igts = c("IGT35")
spls = unique(so$sample_type[so$IGT %in% c("IGT95", "IGT96")])
as = c("OT1", "poly")

pdf(sprintf("%s/MDE_KPzSIIN_20250402.pdf", prefix), 5, 5, useDingbats = F)
for (s in spls) {
    for (a in as) {
        ch = colnames(so)[so$sample_type %in% s & so$Ag_spe %in% a ] #
        if (length(ch) != 0 ) {
            print(sprintf("%s %s", s, a))
            print(length(ch))
            MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = ch, highlight_column_name = "annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level2, print_plot1 = T, print_plot2 = T, labelclusters = F, title = sprintf("%s %s", s,  a) )
            rm(ch)
        }
    }
}
dev.off()
```

KP
```{r}
# igts = c("IGT35")
spls = unique(so$sample_type[so$IGT %in% c("IGT64", "IGT65")])
as = c("OT1", "poly")

pdf(sprintf("%s/MDE_PDAC_20250402.pdf", prefix), 5, 5, useDingbats = F)
for (s in spls) {
    for (a in as) {
        ch = colnames(so)[so$sample_type %in% s & so$Ag_spe %in% a ] #
        if (length(ch) != 0 ) {
            print(sprintf("%s %s", s, a))
            print(length(ch))
            MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = ch, highlight_column_name = "annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level2, print_plot1 = T, print_plot2 = T, labelclusters = F, title = sprintf("%s %s", s,  a) )
            rm(ch)
        }
    }
}
dev.off()


```

GBM
```{r}
# igts = c("IGT35")
spls = unique(so$sample_type[so$IGT %in% c("IGT69")])
as = c("OT1", "poly")

pdf(sprintf("%s/MDE_GBM_20250402.pdf", prefix), 5, 5, useDingbats = F)
for (s in spls) {
    for (a in as) {
        ch = colnames(so)[so$sample_type %in% s & so$Ag_spe %in% a ] #
        if (length(ch) != 0 ) {
            print(sprintf("%s %s", s, a))
            print(length(ch))
            MyDimPlotHighlight(so, umap_to_plot = "mde_incremental", cells_to_highlight = ch, highlight_column_name = "annotation_level2", highlight_size = 0.5, highlight_alpha = 0.5, pixels = c(512, 512), mycols = mypal_level2, print_plot1 = T, print_plot2 = T, labelclusters = F, title = sprintf("%s %s", s,  a) )
            rm(ch)
        }
    }
}
dev.off()


```

**FCFC plots for giovanni**
```{r}
source('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/analysis/immgent_integration_git/custom_functions_david.R')

tt_list = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/analysis/data_integration/IGT1_96/CD8/DGE_limma/20250109/ttlist_OneVsAll.Rds')

names(tt_list)


# Create the vplot dataframe with fold changes
vplot = data.frame(fc1 = exp(tt_list$CD8_cl10_vs_All$logFC), fc2 = exp(tt_list$CD8_cl11_vs_All$logFC), SYMBOL = tt_list$CD8_cl10_vs_All$SYMBOL)

# Identify genes with large fold changes (>2)
genes_to_plot = abs(tt_list$CD8_cl10_vs_All$logFC) > 0.69 | abs(tt_list$CD8_cl11_vs_All$logFC) > 0.69
# genes_to_label = vplot[genes_to_plot, ]
genes_to_label = vplot$SYMBOL[genes_to_plot]

# Create the plot
FCFCplot(vplot, 
         xlab = "FC for CD8_cl10", 
         ylab = "FC for CD8_cl11", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = genes_to_label)

FCFCplot(vplot, 
         xlab = "FC for CD8_cl10", 
         ylab = "FC for CD8_cl11", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = NULL)

vplot = data.frame(fc1 = exp(tt_list$CD8_cl10_vs_All$logFC), fc2 = exp(tt_list$CD8_cl7_vs_All$logFC), SYMBOL = tt_list$CD8_cl10_vs_All$SYMBOL)
# Identify genes with large fold changes (>2)
genes_to_plot = abs(tt_list$CD8_cl10_vs_All$logFC) > 0.69 | abs(tt_list$CD8_cl7_vs_All$logFC) > 0.69
genes_to_label = vplot[genes_to_plot, ]
# Create the plot
FCFCplot(vplot, 
         xlab = "FC for CD8_cl10", 
         ylab = "FC for CD8_cl7", 
         main = "Fold Change vs Fold Change", 
         printgeomtext = T, 
         genes_to_label = genes_to_label)



```

**Barplot of cluster proportion in specific samples**

prop_data and mdata
mdata_sl1 from annotation_level2_PropPerSamplePerLevel1_withMetadata.Rds (proportion of CD8, CD4, Treg etc in each sample)
mdata_s from annotation_level2_PropPerSample.txt (proportion of total cells in the sample)
```{r}
prop_data = read.table(file = sprintf("%s/annotation_level2_PropPerSample.txt", prefix), header = T, sep = "\t" ) # --> mdata_s
prop_data = readRDS(file = sprintf("%s/annotation_level2_PropPerSamplePerLevel1_withMetadata.Rds", prefix)) %>% select(IGTHT, ends_with("ncells"), ends_with("prop")) # --> mdata_sl1
colnames(prop_data) = gsub(pattern = "gdT_52", replacement = "gdT_cl52", x = colnames(prop_data))
colnames(prop_data) = gsub(pattern = "gdT_54", replacement = "gdT_cl54", x = colnames(prop_data))

m = read.table('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/exp_id/sample_metadata/Sample_metadata_david_20250628_v10.csv',header = T, sep = ",")

# changing here and not in the original file to keep consistent with the database
colnames(m)
m$IGT_10xlane_id = NULL
m$organism_id = NULL
m$IGT = m$immgent_IGT_10xlane_id
m$immgent_IGT_10xlane_id = NULL
m$HT = m$hashtag_number
m$hashtag_number = NULL
m$sample_id = NULL
m$count_unique = NULL

m$sample_code.1 = NULL

mdata = merge(prop_data, m, by.x = "IGTHT", by.y = "IGTHT",all.x = T, all.y = F, suffixes = c(".x", ""))

mdata$organ_simplified = factor(mdata$organ_simplified, levels = c("blood","spleen","LN","SLO","bone marrow","thymus",
                                                                   "lung", "liver", "peritoneal cavity",
                                                                   "colon epi","small intestine epi","colon LP","small intestine LP","skin",
                                                                   "mammary gland","uterus", "placenta", "prostate","submandibular gland","kidney", "pancreas","CNS","synovial fluid"))
#any(is.na(mdata$organ_simplified))

mdata$condition_detailed_simplified = factor(mdata$condition_detailed_simplified)
mdata$condition_detailed_simplified = relevel(mdata$condition_detailed_simplified, ref = "baseline")


mdata_sl1 = mdata
mdata_s = mdata

```


CD8_cl14/15/18 barplot samples
```{r}
mdata #see chunk at the beginning, from prop_data = read.table(file = sprintf("%s/annotation_level2_PropPerSample.txt", prefix), header = T, sep = "\t" ) 

# rorc = c("CD4_cl17","nonconv_cl8", "gdT_cl7","gdT_cl9", "gdT_cl46","gdT_cl10", "CD8_cl7", "DP_cl60", "Treg_cl2", "CD4_cl21", "CD8_cl10", "Treg_cl8", "CD8aa_cl1", "DN_cl41")
mycl = c("CD8_cl14","CD8_cl15","CD8_cl28")
want_cols = paste0(mycl, ".prop")
tmp = mdata %>% filter(grepl(pattern = "allT|CD45p", x = target_cells_simplified) & !(condition_detailed == "baseline" & organ_simplified == "spleen") ) %>% select(sample_code,any_of(want_cols))
# tmp = mdata %>% select(sample_code,any_of(want_cols))

tmp2 = tmp %>% mutate(total_prop = rowSums(select(., ends_with(".prop")), na.rm = TRUE)) %>% arrange(desc(total_prop))
tmp2 %>% head(50) %>% pull(sample_code)

tmp2 <- tmp2 %>% 
  arrange(desc(total_prop)) %>% 
  mutate(sample_code = factor(sample_code, sample_code)) %>% 
    head(50)

tmp_long <- tmp2 %>% 
  select(-total_prop) %>% 
  pivot_longer(
    cols      = -sample_code,
    names_to  = "population",
    values_to = "prop"
  ) 

tmp_long$population = gsub("\\.prop","", tmp_long$population )
tmp_long$condition_detailed_organ = mdata$condition_detailed_organ[match(tmp_long$sample_code, mdata$sample_code)]

label_map = tmp_long %>% 
  distinct(sample_code, condition_detailed_organ) %>% 
  arrange(sample_code)
lab_vec = label_map$condition_detailed_organ
names(lab_vec) = label_map$sample_code


pdf(sprintf("%s/CD8cl141528_clusters_in_topsamples.pdf", fig_dir),10, 8, useDingbats = F) #all cells
p = ggplot(tmp_long, aes(x = sample_code, y = prop, fill = population)) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = immgent_colors$level2) +
    scale_x_discrete(labels = lab_vec) +
    theme_minimal() +
    labs(
        x    = "Sample",
        y    = "Proportion",
        fill = "Population"
    ) +
    ggtitle("Top samples with CD8 cl14/15/28 - percent of total CD8") +
    theme_minimal() +
    theme(
        panel.grid.major = element_blank(), # Removes major grid lines
        panel.grid.minor = element_blank(), # Removes minor grid lines
        # axis.title = element_blank(),       # Removes axis titles (e.g., "count")
        # axis.text = element_blank(),        # Removes axis labels/text (e.g., numbers on the axis)
        axis.ticks = element_blank(),        # Removes axis tick marks
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
print(p)
dev.off()


```

**Plot Clusters across Timepoints in LCMV**

LT and NLT samples
```{r}
mdata = mdata_s
mdata = mdata_sl1

lcmv = mdata %>% filter(IGT %in% c("IGT36", "IGT38", "IGT40") )
healthy = mdata %>% filter( organ_simplified %in% lcmv$organ_simplified & !(organ_simplified %in% "spleen") & condition_detailed == "baseline" & grepl(pattern = "allT|CD45p", x = target_cells_simplified))
healthy = healthy %>% group_by(organ_simplified) %>% sample_n(4)

tmp = mdata %>% filter(sample_code %in% c(lcmv$sample_code, healthy$sample_code))  %>% select(ends_with(".prop"), organ_simplified, timepoint, sample_code, condition_detailed)

tmp$timepoint[tmp$timepoint == ""] = "0 dpi"
# tmp = mdata %>% filter(infection_agent %in% c("LCMV armstrong", "LCMV Armstrong") & grepl(pattern = "allT|CD45p", x = target_cells_simplified) & organ_simplified == "spleen") %>% select(ends_with(".prop"), organ_simplified, timepoint, sample_code) 

tmp = tmp %>% group_by(organ_simplified) %>% filter(any(condition_detailed == "baseline") & any(condition_detailed != "baseline"))

plot_data = tmp %>%
  # Reshape data from wide to long
  pivot_longer(
    cols = ends_with(".prop"),
    names_to = "population",
    values_to = "proportion"
  ) %>%
  # Clean up the population names (e.g., "CD4_cl1.prop" -> "CD4_cl1")
  mutate(population = str_remove(population, "\\.prop$")) %>%
  # Ensure timepoint is ordered correctly, not alphabetically
  mutate(timepoint = factor(timepoint, levels = c("0 dpi", "7 dpi", "30 dpi", "60 dpi")))

plot_data$level1 = sub("_.*" ,"",plot_data$population)

p = ggplot(plot_data, aes(x = timepoint, y = proportion, color = population, group = population)) +
  # Add a summary line showing the mean trend for each population
  stat_summary(
    fun = "mean",
    geom = "line",
    linewidth = 1,
    alpha = 0.8
  ) +
  # Add points for each individual sample
  geom_point(
    # aes(shape = sample_code), # Optional: give each sample a different shape
    size = 2,
    alpha = 0.7
  ) +
  # Apply a nice color scale and theme
  scale_color_manual(values = mypal_level2) +
  theme_minimal() +
  labs(
    title = "Population Proportions Over Time, LCMV Arm, (% of all T cells)",
    x = "Timepoint",
    y = "Proportion",
    color = "Cell Population" # Rename the legend title
  ) +
  # Optional: hide the shape legend if it's too cluttered
  guides(shape = "none") +
  # Rotate x-axis labels if they overlap
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

pdf(sprintf("%s/LCMVarm_cluster_timecourse.pdf", fig_dir),15, 15, useDingbats = F) #all cells
pdf(sprintf("%s/LCMVarm_cluster_timecourse_sl1.pdf", fig_dir),15, 15, useDingbats = F) #all cells
p + facet_grid(organ_simplified ~ level1, scales = "free", space  = "free_x")
p + facet_grid(organ_simplified ~ level1, scales = "free", space  = "free_x") +
    NoLegend() + 
    NoGrid()
dev.off()    


```

