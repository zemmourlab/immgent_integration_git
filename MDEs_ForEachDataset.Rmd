---
title: "MDEs_ForEachDataset"
output: html_document
date: "2025-05-21"
editor_options: 
  chunk_output_type: console
---

**Start interactive session on Midway3**
```{bash}
ssh -Y zemmour@midway3.rcc.uchicago.edu
sinfo -s
screen -S david
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=jfkfloor2 --qos=jfkfloor2 --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=zemmour-hm --qos=zemmour --nodes=1 
sinteractive --time=12:00:00 --account=pi-zemmour --partition=beagle3-bigmem --nodes=1 --mem=128GB
sinteractive --time=12:00:00 --account=pi-zemmour --partition=caslake --nodes=1 --mem=96GB
sinteractive --time=3:00:00 --account=pi-zemmour --partition=gpu --gres=gpu:1 --mem=152GB
cd $LABHOME

module load python/anaconda-2022.05 
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13

#sinteractive --time=1:00:00 -p gpu --gres=gpu:1 --account=pi-zemmour 

#source activate /project/jfkfloor2/zemmourlab/david/envs/scvi
source activate /project/zemmour/david/envs/scvi_20240315
module load openblas/0.3.13 #load again or error

cd /project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/
#cd ~/google_drive/ImmgenT/analysis/data_integration/IGT1_56/Treg

#srun --pty --jobid 21908677 -w midway3-0291 /bin/bash

R
#options(max.print=1000)
#options(Seurat.object.assay.version = 'v5')
```

**Initialize in R: load libraries and custom functions**

```{r}
options(max.print=1000)
# setwd("/project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_96")
source("/project/jfkfloor2/zemmourlab/david/immgent/immgent_integration_git/custom_functions_david.R")

libs = c("ZemmourLib","gridExtra","fgsea","fastTopics", "flashier", "Matrix", "Seurat","BPCells", "ggplot2", "dplyr", "reshape2", "ggrastr", "RColorBrewer", "pals", "scales", "pheatmap", "rafalib", "limma") 
#libs = c("m,atrixStats", "gplots","ggplot2", "reshape2", "scales", "gridExtra", "dplyr", "RColorBrewer", "grid", "Rtsne", "limma",   "RColorBrewer", "pheatmap", "Seurat",  "ggrastr", "ggbeeswarm") #pwr, preprocessCore, "readxl", vegan", "genefilter" "scde" "cellrangerRkit", "Rsamtools", "GenomicRanges", "GenomicAlignments", "VGAM", "WGCNA",rafalib, ‘UsingR’,MAST "ggrastr",
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))


#Gradients
library(RColorBrewer)
ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
# ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
ColorRamp = rev(rainbow(10, end = 4/6))
library(viridis)
ColorRamp = rev(viridis(100))
ColorRamp = rev(cividis(100))
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
ColorRamp = colorRampPalette(c('white','red'))(20)
ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdBu"))(100))
# ColorRamp = colorRampPalette(c('Red'))(20)
#image(1:100, 1, as.matrix(1:100), col = ColorRamp, main = "Color Palette", xaxt = 'n', yaxt = 'n', xlab = "", ylab = "")

#mycol = c("black","blue","red","darkgreen", "orange","purple", "cyan", "greenyellow",    "salmon", "magenta","pink", "tan", "brown") # c("magenta", "red",  "darkgreen", "cyan", "blue", "blue", "blue", "black", "blue", "blue", "blue", "blue", "orange")

#Large Color palette
library("pals")
n = 70
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
mypal1 = unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals))))
mypal1 = mypal1[-4]
mypal = c( glasbey(),polychrome(), mypal1)
names(mypal) = NULL

# mypal_list = readRDS("/project/jfkfloor2/zemmourlab/david/immgent/immgent_integration_git/immgent_color_palettes/20250709/immgent_color_palettes_list_20250709.Rds")
# mypal_list = readRDS("/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/analysis/immgent_integration_git/immgent_color_palettes/20250709/immgent_color_palettes_list_20250709.Rds")
mypal_list = readRDS("/Users/david/Library/CloudStorage/Box-Box/ZemmourLab_David/ZemmourLib/data/immgent_color_palettes_list_20250709.Rds")

mypal_level1 = mypal_list[["level1"]]
mypal_level2_all = mypal_list[["level2_all"]]
mypal_level2 = c(mypal_list[["CD4"]], mypal_list[["CD8"]], mypal_list[["Treg"]], mypal_list[["gdT"]], mypal_list[["nonconv"]], mypal_list[["CD8aa"]], mypal_list[["DN"]], mypal_list[["DP"]],mypal_list[["thymocyte"]])
mypal_organ = mypal_list[["organ_simplified"]]




#parade = function(n) { return(Seurat::DiscretePalette(n, palette = "parade", shuffle = F)) }
```

**Load dataset**

```{r}
# so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250513_clean.Rds") 
so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250710_clean.Rds") 

output_dir = "MDE_InEachSample_20250712"


```

**Feature plots in each MDE**


```{r}
library(gridExtra)

gene = "Fcer1g"

so = so_orig
so = NormalizeData(so,assay = "RNA", normalization.method = "LogNormalize",verbose = T)

so = list()
so[["CD4"]] = so_orig[,so_orig$annotation_level1 == "CD4"]
so[["CD8"]] =  so_orig[,so_orig$annotation_level1 == "CD8"]
so[["Treg"]] =  so_orig[,so_orig$annotation_level1 == "Treg"]
so[["gdT"]] = so_orig[,so_orig$annotation_level1 == "gdT"]
so[["CD8aa"]] = so_orig[,so_orig$annotation_level1 == "CD8aa"]
so[["nonconv"]] = so_orig[,so_orig$annotation_level1 == "nonconv"]
so[["DN"]] = so_orig[,so_orig$annotation_level1 == "DN"]
so[["DP"]] = so_orig[,so_orig$annotation_level1 == "DP"]
# so = lapply(so, function(x) NormalizeData(x,assay = "RNA", normalization.method = "LogNormalize",verbose = T))



ImmgenTFeaturePlots = function(so_orig, so_list = SplitObject(so_orig, split.by = "annotation_level1"), gene = "Cd4", slot = "data", reduction_overall = "mde2_totalvi_20241006", reduction_level2 = "mde_incremental",mypal_level1 = ZemmourLib::immgent_colors[["level1"]], mypal_level2 = ZemmourLib::immgent_colors[["level2"]]) {
    library(gridExtra)
    # don't forget to run NormalizeData() before
    # split so_orig to so_list before running
    level1 = c("CD4", "CD8", "Treg", "gdT", "CD8aa", "nonconv", "DN", "DP")
    ps1 = list()
    ps2 = list()
    ps1[["all"]] = DimPlot(so_orig, reduction = reduction_overall, group.by = "annotation_level1", raster = T, raster.dpi = c(1024,1024), label = T) + scale_color_manual(values = mypal_level1) + ggtitle("") + theme_void() + NoLegend()
    print(ps1[["all"]])
    
    ps2[["all"]]  = FeaturePlot(so_orig, reduction = reduction_overall,slot = "data", features = gene, order = F, raster = T, raster.dpi = c(1024,1024)) + ggtitle(sprintf("%s", gene)) + theme_void() + NoLegend()
    print(ps2[["all"]])
    
    ps1 = list()
    ps2 = list()
    for (l in level1) {
        print(l)
        ps1[[l]] = DimPlot(so_list[[l]], reduction = reduction_level2, group.by = "annotation_level2", raster = T, raster.dpi = c(1024,1024), label = T) + scale_color_manual(values = mypal_level2) + ggtitle(sprintf("MDE %s", l)) + theme_void() + NoLegend()
        ps2[[l]] = FeaturePlot(so_list[[l]], reduction = reduction_level2,slot = "data", features = gene, order = F, raster = T, raster.dpi = c(1024,1024)) + ggtitle(sprintf("MDE %s, gene %s", l, gene)) + theme_void() + NoLegend()
    }
    grid.arrange(grobs = ps1, ncol = 3, nrow = 3)
    grid.arrange(grobs = ps2, ncol = 3, nrow = 3)
    
}

#example of use
so_orig
so_orig = NormalizeData(so_orig,assay = "RNA", normalization.method = "LogNormalize",verbose = T)
so_list = SplitObject(so_orig, split.by = "annotation_level1")
so_list[["thymocyte"]] = NULL
mypal_level2 = immgent_colors$level2
gene = "Cd4"
pdf(sprintf("misc_plots/FeaturePlot_%s.pdf",gene), width = 20, height = 20, useDingbats = F)
ImmgenTFeaturePlots(so_orig, so_list, gene = "Cd4", slot = "data")
dev.off()

# level1 = c("CD4", "CD8", "Treg", "gdT", "CD8aa", "nonconv", "DN", "DP")
pdf(sprintf("misc_plots/FeaturePlot_%s.pdf",gene), width = 20, height = 20, useDingbats = F)
ps1 = list()
ps2 = list()
ps1[["all"]] = DimPlot(so_orig, reduction = "mde2_totalvi_20241006", group.by = "annotation_level1", raster = T, raster.dpi = c(1024,1024), label = T) + scale_color_manual(values = mypal_level1) + ggtitle("") + theme_void() + NoLegend()
print(ps1[["all"]])

ps2[["all"]]  = FeaturePlot(so_orig, reduction = "mde2_totalvi_20241006",slot = "data", features = gene, order = F, raster = T, raster.dpi = c(1024,1024)) + ggtitle(sprintf("%s", gene)) + theme_void() + NoLegend()
print(ps2[["all"]])

ps1 = list()
ps2 = list()
for (l in level1) {
    print(l)
    ps1[[l]] = DimPlot(so[[l]], reduction = "mde_incremental", group.by = "annotation_level2", raster = T, raster.dpi = c(1024,1024), label = T) + scale_color_manual(values = mypal_level2) + ggtitle(sprintf("MDE %s", l)) + theme_void() + NoLegend()
    ps2[[l]] = FeaturePlot(so[[l]], reduction = "mde_incremental",slot = "data", features = gene, order = F, raster = T, raster.dpi = c(1024,1024)) + ggtitle(sprintf("MDE %s, gene %s", l, gene)) + theme_void() + NoLegend()
}
grid.arrange(grobs = ps1, ncol = 3, nrow = 3)
grid.arrange(grobs = ps2, ncol = 3, nrow = 3)
dev.off()

```



**MDE plots in each sample**
Too long so better to run on Midway with:
--> sbatch $SCRIPT_DIR/mde_plots_wrapper.sh output_dir
--> Rscript $SCRIPT_DIR/mde_plots_per_sample.R $path_to_seurat_object $output_dir

MDE_InEachSample
```{bash}
path_to_seurat_object=/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250513_clean.Rds
output_dir=MDE_InEachSample
Rscript $SCRIPT_DIR/mde_plots_per_sample.R $path_to_seurat_object $output_dir
```

MDE_InEachSample_20250712
```{bash}
path_to_seurat_object=/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250710_clean.Rds
output_dir=MDE_InEachSample_20250712
Rscript $SCRIPT_DIR/mde_plots_per_sample.R $path_to_seurat_object $output_dir
```


```{r}

library(gridExtra)

so_orig$is_agspe = !is.na(so_orig$Ag_spe)

so = list()
so[["CD4"]] = so_orig[,so_orig$annotation_level1 == "CD4"]
so[["CD8"]] =  so_orig[,so_orig$annotation_level1 == "CD8"]
so[["Treg"]] =  so_orig[,so_orig$annotation_level1 == "Treg"]
so[["gdT"]] = so_orig[,so_orig$annotation_level1 == "gdT"]
so[["CD8aa"]] = so_orig[,so_orig$annotation_level1 == "CD8aa"]
so[["nonconv"]] = so_orig[,so_orig$annotation_level1 == "nonconv"]
so[["DN"]] = so_orig[,so_orig$annotation_level1 == "DN"]
so[["DP"]] = so_orig[,so_orig$annotation_level1 == "DP"]


i = "IGT37"
level1 = c("CD4", "CD8", "Treg", "gdT", "CD8aa", "nonconv", "DN", "DP")

pdf("MDE_InEachSample/IGT1-96_MDEs.pdf", width = 20, height = 20, useDingbats = F)
for (i in unique(so_orig$IGT)) {
    samples = so_orig@meta.data %>% filter(IGT == i) %>% pull(sample_code) %>% unique()
    for (s in samples) {
        print(s)
        ensure_directory(sprintf("MDE_InEachSample/%s/", i))
        # pdf(sprintf("MDE_InEachSample/%s/%s_MDEs.pdf", i, s), width = 20, height = 20, useDingbats = F)
        ps2 = list()
        ps3 = list()
        p = MyDimPlotHighlight(seurat_object = so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(so_orig)[which(so_orig$sample_code == s)], highlight_column_name = "annotation_level2", pixels = c(512, 512), mycols = mypal_level2, title = sprintf("%s",s), highlight_size = 1, highlight_alpha = 1, print_plot1 = T, print_plot2 = T, labelclusters = T)
        ps2[["all"]] =  p$plot2
        ps3[["all"]] =  p$plot3
        for (l in level1) {
            # print(l)
            p = MyDimPlotHighlight(seurat_object = so[[l]], umap_to_plot = "mde_incremental", cells_to_highlight = colnames(so[[l]])[which(so[[l]]$sample_code == s)], highlight_column_name = "annotation_level2", pixels = c(512, 512), mycols = mypal_level2, title = sprintf("%s in %s", l, s), highlight_size = 1, highlight_alpha = 1, print_plot1 = T, print_plot2 = T, labelclusters = T)
            ps2[[l]] = p$plot2
            ps3[[l]] = p$plot3 #to get plot with labels
        }
        grid.arrange(grobs = ps3, ncol = 3, nrow = 3)
        # grid.arrange(grobs = ps2, ncol = 3, nrow = 3)
        # dev.off()
    }
}
dev.off()



for (i in unique(so_orig$IGT)) {
    samples = so_orig@meta.data %>% filter(IGT == i) %>% pull(sample_code) %>% unique()
    for (s in samples) {
        print(s)
        ensure_directory(sprintf("MDE_InEachSample/%s/", i))
        pdf(sprintf("MDE_InEachSample/%s/%s_MDEs.pdf", i, s), width = 20, height = 20, useDingbats = F)
        ps2 = list()
        ps3 = list()
        p = MyDimPlotHighlight(seurat_object = so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(so_orig)[which(so_orig$sample_code == s)], highlight_column_name = "annotation_level2", pixels = c(512, 512), mycols = mypal_level2, title = sprintf("%s",s), highlight_size = 1, highlight_alpha = 1, print_plot1 = T, print_plot2 = T, labelclusters = T)
        ps2[["all"]] =  p$plot2
        ps3[["all"]] =  p$plot3
        for (l in level1) {
            # print(l)
            p = MyDimPlotHighlight(seurat_object = so[[l]], umap_to_plot = "mde_incremental", cells_to_highlight = colnames(so[[l]])[which(so[[l]]$sample_code == s)], highlight_column_name = "annotation_level2", pixels = c(512, 512), mycols = mypal_level2, title = sprintf("%s in %s", l, s), highlight_size = 1, highlight_alpha = 1, print_plot1 = T, print_plot2 = T, labelclusters = T)
            ps2[[l]] = p$plot2
            ps3[[l]] = p$plot3 #to get plot with labels
        }
        grid.arrange(grobs = ps3, ncol = 3, nrow = 3)
        grid.arrange(grobs = ps2, ncol = 3, nrow = 3)
        dev.off()
    }
}








```

For Ag-specific cells only

```{r}
library(gridExtra)

so_orig$is_agspe = !is.na(so_orig$Ag_spe)

so = list()
so[["CD4"]] = so_orig[,so_orig$annotation_level1 == "CD4"]
so[["CD8"]] =  so_orig[,so_orig$annotation_level1 == "CD8"]
so[["Treg"]] =  so_orig[,so_orig$annotation_level1 == "Treg"]
so[["gdT"]] = so_orig[,so_orig$annotation_level1 == "gdT"]
so[["CD8aa"]] = so_orig[,so_orig$annotation_level1 == "CD8aa"]
so[["nonconv"]] = so_orig[,so_orig$annotation_level1 == "nonconv"]
so[["DN"]] = so_orig[,so_orig$annotation_level1 == "DN"]
so[["DP"]] = so_orig[,so_orig$annotation_level1 == "DP"]


# i = "IGT37"
level1 = c("CD4", "CD8", "Treg", "gdT", "CD8aa", "nonconv", "DN", "DP")

igts = so_orig@meta.data %>% filter(is_agspe == T) %>% pull(IGT) %>% unique()

# pdf("MDE_InEachSample/IGT1-96_MDEs_AgSpe.pdf", width = 20, height = 20, useDingbats = F)
pdf("MDE_InEachSample_20250712/IGT1-96_MDEs_AgSpe.pdf", width = 20, height = 20, useDingbats = F)

for (i in igts) {
    samples = so_orig@meta.data %>% filter(IGT == i) %>% pull(sample_code) %>% unique()
    for (s in samples) {
        print(s)
        ensure_directory(sprintf("MDE_InEachSample/%s/", i))
        # pdf(sprintf("MDE_InEachSample/%s/%s_MDEs_AgSpe.pdf", i, s), width = 20, height = 20, useDingbats = F)
        ps2 = list()
        ps3 = list()
        for (l in level1) {
            # print(l)
            p = MyDimPlotHighlight(seurat_object = so[[l]], umap_to_plot = "mde_incremental", cells_to_highlight = colnames(so[[l]])[which(so[[l]]$sample_code == s)], highlight_column_name = "is_agspe", pixels = c(512, 512), mycols = c("black", "red"), title = sprintf("%s in %s", l, s), highlight_size = 1, highlight_alpha = 1, print_plot1 = T, print_plot2 = T, labelclusters = T)
            ps2[[l]] = p$plot2
            ps3[[l]] = p$plot3 #to get plot with labels
        }
        grid.arrange(grobs = ps3, ncol = 3, nrow = 3)
        grid.arrange(grobs = ps2, ncol = 3, nrow = 3)
        # dev.off()
    }
}
dev.off()

pdf("MDE_InEachSample_20250712/IGT1-96_MDEs_AgSpe2.pdf", width = 20, height = 20, useDingbats = F)
ps2 = list()
ps3 = list()
for (l in level1) {
    print(l)
    p = MyDimPlotHighlight(seurat_object = so[[l]], umap_to_plot = "mde_incremental", cells_to_highlight = colnames(so[[l]])[which(so[[l]]$is_agspe == T)], highlight_column_name = "Ag_spe", pixels = c(512, 512), mycols = mypal, title = sprintf("Ag spe in %s", l), highlight_size = 1, highlight_alpha = 1, print_plot1 = T, print_plot2 = T, labelclusters = T)
    ps2[[l]] = p$plot2
    ps3[[l]] = p$plot3 #to get plot with labels
}
grid.arrange(grobs = ps3, ncol = 3, nrow = 3)
grid.arrange(grobs = ps2, ncol = 3, nrow = 3)
dev.off()

```


**Export images for movie**
On desktop (couldn't install av on midway3) is easier
```{r}

ensure_directory(sprintf("%s/frames_all", output_dir))

samples = so_orig@meta.data %>% pull(sample_code) %>% unique()
l = "all"

for (i in 1:length(samples)) {
    print(samples[i])
    p = MyDimPlotHighlight(seurat_object = so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = colnames(so_orig)[which(so_orig$sample_code == samples[i])], highlight_column_name = "annotation_level2", pixels = c(512, 512), mycols = mypal_level2, title = sprintf("%s",samples[i]), highlight_size = 1, highlight_alpha = 1, print_plot1 = T, print_plot2 = T, labelclusters = T)
    # p = MyDimPlotHighlight(seurat_object = so[[l]], umap_to_plot = "mde_incremental", cells_to_highlight = colnames(so[[l]])[which(so[[l]]$sample_code == s)], highlight_column_name = "annotation_level2", pixels = c(512, 512), mycols = mypal_level2, title = sprintf("%s in %s", l, s), highlight_size = 1, highlight_alpha = 1, print_plot1 = T, print_plot2 = T, labelclusters = T)
    ggsave(sprintf("%s/frames_all/frame_%03d.png", output_dir, i), plot = p$plot2 + ggtitle(sprintf("%s",samples[i])), width = 5, height = 5, bg = "white")
}

```

```{r}
##On my desktop (couldn't install av on midway3)
library(av)
# setwd(sprintf('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/analysis/data_integration/IGT1_96/%s', output_dir))

# Create a video from the PNG frames
av_encode_video(
  list.files(sprintf("%s/frames_all", output_dir), full.names = TRUE), 
  framerate = 10,           # 10 frames per second
  output = sprintf("%s/immgenT_movie_all.mp4", output_dir)
)

```














