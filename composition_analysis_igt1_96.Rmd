---
title: "composition_analysis"
output: html_document
date: "2024-10-24"
author: "David Zemmour"
editor_options: 
  chunk_output_type: console
---

**Initialize: load libraries and custom functions**

```{bash}
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=jfkfloor2 --qos=jfkfloor2 --nodes=1 
sinteractive --time=03:00:00 --account=pi-zemmour --partition=caslake --nodes=1 --mem=96GB

module load python/anaconda-2022.05 
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13
source activate /project/zemmour/david/envs/scvi_20240315
module load openblas/0.3.13

cd /project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/
R
```

```{r}
setwd("~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96")
libs = c("Seurat", "ggplot2", "dplyr", "ggrastr", "RColorBrewer", "pals", "scales", "reshape2", "pheatmap", "scattermore") 
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))
source("/project/jfkfloor2/zemmourlab/david/immgent/immgent_integration_git/custom_functions_david.R")

ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
ColorRamp = rev(rainbow(10, end = 4/6))
ColorRamp = rev(viridis(100))
ColorRamp = brewer.pal(9, "Blues")

#mycol = c("black","blue","red","darkgreen", "orange","purple", "cyan", "greenyellow",    "salmon", "magenta","pink", "tan", "brown") # c("magenta", "red",  "darkgreen", "cyan", "blue", "blue", "blue", "black", "blue", "blue", "blue", "blue", "orange")

n = 70
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
mypal1 = unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals))))
mypal1 = mypal1[-4]

library("pals")
parade = function(n) { return(Seurat::DiscretePalette(n, palette = "parade", shuffle = F)) }

length(glasbey())
length(polychrome())
mypal = c(glasbey(), polychrome(), mypal1)
names(mypal) = NULL

```

Prefix
```{r}
prefix = "SampleComp/20250109"
reduc = "totalvi_20241006"
clusters = "annotation_level1"
```

**Most up-to-date data**

```{r}
# so = readRDS("igt1_96_withtotalvi20241021.Rds")
so = readRDS("igt1_96_withtotalvi20250109.Rds")
so = so[,!so$annotation_level1 %in% c("unclear", "nonT", "remove")]

sample_metadata = read.table("/project/zemmour/david/ImmgenT/exp_id/IGT1_96_sample_metadata.csv",header = T, sep = ",")

```

**Count number of cells for each cluster level 2 in each sample**
```{r}
m = so@meta.data

ncells = m %>% group_by(IGTHT) %>% summarize(n_cells = n()) %>% as.data.frame()

stat = m %>% group_by(IGTHT) %>% mutate(n_sampleid = n()) %>% group_by(IGTHT, annotation_level2) %>% summarize(ncells = n(), prop = ncells/first(n_sampleid)) %>% ungroup() %>% as.data.frame()

stat_df_ncells = dcast(stat, IGTHT ~ annotation_level2, value.var = "ncells")
stat_df_ncells[is.na(stat_df_ncells)] = 0
stat_df_prop = dcast(stat, IGTHT ~ annotation_level2, value.var = "prop")
stat_df_prop[is.na(stat_df_prop)] = 0

all(ncells$IGTHT == stat_df_ncells$IGTHT)

m2 = merge(ncells, stat_df_ncells, by.x = "IGTHT", by.y = "IGTHT")
m2 = merge(m2, stat_df_prop, by.x = "IGTHT", by.y = "IGTHT", suffixes = c(".ncells", ".prop"))

write.table(m2, file = sprintf("%s/annotation_level2_PropPerSample.csv", prefix),row.names = F, col.names = T, sep = ",", quote = F)

sample_metadata$IGTHT = paste(sample_metadata$immgent_IGT_10xlane_id, sample_metadata$hashtag_number, sep = "")
sample_metadata$IGTHT = gsub(x = sample_metadata$IGTHT, pattern = "IGT", replacement = "I" )
sample_metadata$IGTHT = gsub(x = sample_metadata$IGTHT, pattern = "HT", replacement = "H" )

m3 = merge(m2, sample_metadata, by.x = "IGTHT", by.y = "IGTHT",all.x = T, all.y = F)

m3$sample_name_new = paste(m3$IGTHT, m3$sample_name, sep = ".")
m3$sample_name_new = make.names(m3$sample_name_new)

saveRDS(m3, file = sprintf("%s/annotation_level2_PropPerSample_withMetadata.Rds", prefix))

write.table(m3, file = sprintf("%s/annotation_level2_PropPerSample_withMetadata.csv", prefix) ,row.names = F, col.names = T, sep = ",", quote = F)
```

```{r}
library(pheatmap)

m3 = readRDS(sprintf("%s/annotation_level2_PropPerSample_withMetadata.Rds", prefix))

m3$sample_name_new = paste(m3$IGTHT, m3$sample_name, sep = ".")
m3$sample_name_new = make.names(m3$sample_name_new)

tmp3 = m3[,c("sample_name_new", colnames(m3)[grepl(pattern = ".prop$", colnames(m3))])]
rownames(tmp3) = tmp3[,1]
tmp3 = tmp3[,-1]
colnames(tmp3) = gsub(pattern = "\\.prop", replacement = "", colnames(tmp3))

# ColorRamp = rev(viridis(100))
labels_matrix = signif(tmp3,2)*100
labels_matrix[labels_matrix==0] = ""

pdf(file = sprintf("%s/annotation_level2_Sample_Composition_heatmap.pdf", prefix), width =50, height =150, useDingbats = F)

pheatmap(mat = tmp3*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix, number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 10, main = "Percent of cells in each Sample", na_col = "#FDE725")

for (i in c("CD4", "CD8", "Treg", "gdT", "CD8aa","nonconv", "DN", "DP")) {
    print(i)
    colz = grepl(sprintf("%s_",i), colnames(tmp3))
    pheatmap(mat = tmp3[,colz]*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix[,colz], number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 10, main = sprintf("Percent of cells in each Sample for %s clusters",i), na_col = "#FDE725")
    
}

dev.off()

```

split by annotation_level1
```{r}
m3 = readRDS(file = sprintf("%s/annotation_level2_PropPerSample_withMetadata.Rds", prefix))

# which(colnames(m3) == "sample_name")
# i = "CD4"
for(i in c("CD4", "CD8", "Treg", "gdT", "CD8aa","nonconv", "DN", "DP")) {
    print(i)
    sub = c(which(grepl(sprintf("%s_",i), colnames(m3))), seq(which(colnames(m3) == "sample_name"),ncol(m3)))
    write.table(m3[,sub], file = sprintf("%s/annotation_level2_PropPerSample_withMetadata_%s.csv", prefix,i) ,row.names = F, col.names = T, sep = ",", quote = F)
}
```



**Count number of cells for each cluster LEVEL 1 in each sample**
```{r}
m = so@meta.data

ncells = m %>% group_by(IGTHT) %>% summarize(n_cells = n()) %>% as.data.frame()

stat = m %>% group_by(IGTHT) %>% mutate(n_sampleid = n()) %>% group_by(IGTHT, annotation_level1) %>% summarize(ncells = n(), prop = ncells/first(n_sampleid)) %>% ungroup() %>% as.data.frame()

stat_df_ncells = dcast(stat, IGTHT ~ annotation_level1, value.var = "ncells")
stat_df_ncells[is.na(stat_df_ncells)] = 0
stat_df_prop = dcast(stat, IGTHT ~ annotation_level1, value.var = "prop")
stat_df_prop[is.na(stat_df_prop)] = 0

all(ncells$IGTHT == stat_df_ncells$IGTHT)

m2 = merge(ncells, stat_df_ncells, by.x = "IGTHT", by.y = "IGTHT")
m2 = merge(m2, stat_df_prop, by.x = "IGTHT", by.y = "IGTHT", suffixes = c(".ncells", ".prop"))

write.table(m2, file = sprintf("%s/annotation_level1_PropPerSample.csv", prefix),row.names = F, col.names = T, sep = ",", quote = F)

sample_metadata = read.table("/project/zemmour/david/ImmgenT/exp_id/IGT1_96_sample_metadata.csv",header = T, sep = ",", row.names = 1)
sample_metadata$IGTHT = paste(sample_metadata$immgent_IGT_10xlane_id, sample_metadata$hashtag_number, sep = "")
sample_metadata$IGTHT = gsub(x = sample_metadata$IGTHT, pattern = "IGT", replacement = "I" )
sample_metadata$IGTHT = gsub(x = sample_metadata$IGTHT, pattern = "HT", replacement = "H" )

m3 = merge(m2, sample_metadata, by.x = "IGTHT", by.y = "IGTHT",all.x = T, all.y = F)

m3$sample_name_new = paste(m3$IGTHT, m3$sample_name, sep = ".")
m3$sample_name_new = make.names(m3$sample_name_new)

saveRDS(m3, file = sprintf("%s/annotation_level1_PropPerSample_withMetadata.Rds", prefix))

write.table(m3, file = sprintf("%s/annotation_level1_PropPerSample_withMetadata.csv", prefix),row.names = F, col.names = T, sep = ",", quote = F)


```
heatmaps
```{r}
library(pheatmap)

m3 = readRDS( sprintf("%s/annotation_level1_PropPerSample_withMetadata.Rds", prefix))

tmp3 = m3[,c("sample_name_new", colnames(m3)[grepl(pattern = ".prop$", colnames(m3))])]
rownames(tmp3) = tmp3[,1]
tmp3 = tmp3[,-1]
colnames(tmp3) = gsub(pattern = "\\.prop", replacement = "", colnames(tmp3))

# ColorRamp = rev(viridis(100))
labels_matrix = signif(tmp3,2)*100
labels_matrix[labels_matrix==0] = ""

pdf(file = sprintf("%s/annotation_level1_Sample_Composition_heatmap.pdf", prefix), width =20, height =150, useDingbats = F)

pheatmap(mat = tmp3*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix, number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 10, main = "Percent of cells in each Sample", na_col = "#FDE725")

dev.off()

```


**Count number of cells for each cluster level 2 in each IGT**
```{r}
m = so@meta.data

ncells = m %>% group_by(IGT) %>% summarize(n_cells = n()) %>% as.data.frame()

stat = m %>% group_by(IGT) %>% mutate(n_sampleid = n()) %>% group_by(IGT, annotation_level2) %>% summarize(ncells = n(), prop = ncells/first(n_sampleid)) %>% ungroup() %>% as.data.frame()

stat_df_ncells = dcast(stat, IGT ~ annotation_level2, value.var = "ncells")
stat_df_ncells[is.na(stat_df_ncells)] = 0
stat_df_prop = dcast(stat, IGT ~ annotation_level2, value.var = "prop")
stat_df_prop[is.na(stat_df_prop)] = 0

all(ncells$IGT == stat_df_ncells$IGT)

m2 = merge(ncells, stat_df_ncells, by.x = "IGT", by.y = "IGT")
m2 = merge(m2, stat_df_prop, by.x = "IGT", by.y = "IGT", suffixes = c(".ncells", ".prop"))

write.table(m2, file = sprintf("%s/annotation_level2_PropPerIGT.csv", prefix),row.names = F, col.names = T, sep = ",", quote = F)

saveRDS(m2, file = sprintf("%s/annotation_level2_PropPerIGT.Rds", prefix))

```
heatmaps
```{r}
library(pheatmap)

m3 = readRDS(sprintf("%s/annotation_level2_PropPerIGT.Rds", prefix))

tmp3 = m3[,c("IGT", colnames(m3)[grepl(pattern = ".prop$", colnames(m3))])]
rownames(tmp3) = tmp3[,1]
tmp3 = tmp3[,-1]
colnames(tmp3) = gsub(pattern = "\\.prop", replacement = "", colnames(tmp3))

# ColorRamp = rev(viridis(100))
labels_matrix = signif(tmp3,2)*100
labels_matrix[labels_matrix==0] = ""

pdf(file = sprintf("%s/annotation_level2_IGT_Composition_heatmap.pdf", prefix), width =20, height =20, useDingbats = F)
pheatmap(mat = tmp3*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix, number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 5, main = "Percent of cells in each Sample", na_col = "#FDE725")

for (i in c("CD4", "CD8", "Treg", "gdT", "CD8aa","nonconv", "DN", "DP")) {
    print(i)
    colz = grepl(sprintf("%s_",i), colnames(tmp3))
    pheatmap(mat = tmp3[,colz]*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix[,colz], number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 10, main = sprintf("Percent of cells in each IGT for %s clusters",i), na_col = "#FDE725")
    
}

dev.off()
```

**Count number of cells for each cluster level 2 in each organs**
```{r}
m = so@meta.data

sample_metadata = read.table("/project/zemmour/david/ImmgenT/exp_id/IGT1_96_sample_metadata.csv",header = T, sep = ",", row.names = 1)
sample_metadata$IGTHT = paste(sample_metadata$immgent_IGT_10xlane_id, sample_metadata$hashtag_number, sep = "")
sample_metadata$IGTHT = gsub(x = sample_metadata$IGTHT, pattern = "IGT", replacement = "I" )
sample_metadata$IGTHT = gsub(x = sample_metadata$IGTHT, pattern = "HT", replacement = "H" )
#organ_simplified
sample_metadata$organ_simplified = sample_metadata$organ
sample_metadata$organ_simplified[grep(pattern = "lymph node", sample_metadata$organ)] = "LN"
sample_metadata$organ_simplified[grep(pattern = "skin|Skin", sample_metadata$organ)] = "skin"
sample_metadata$organ_simplified[grep(pattern = "colon", sample_metadata$organ)] = "colon"
sample_metadata$organ_simplified[grep(pattern = "duoden|ileal|ileum|jejun|small intestine", sample_metadata$organ)] = "small intestine"
sample_metadata$organ_simplified[sample_metadata$organ %in% c("CNS", "brain")] = "CNS"
sample_metadata$organ_simplified[sample_metadata$organ %in% c("lamina propria", "gut")] = "small intestine"
sample_metadata$organ_simplified[grep(pattern = "salivary|submandibular", sample_metadata$organ)] = "submandibular salivary gland"

m2 = merge(m, sample_metadata, by.x = "IGTHT", by.y = "IGTHT",all.x = T, all.y = F, suffixes = c(".x", ""))

ncells = m2 %>% group_by(organ_simplified) %>% summarize(n_cells = n()) %>% as.data.frame()

stat = m2 %>% group_by(organ_simplified) %>% mutate(n_sampleid = n()) %>% group_by(organ_simplified, annotation_level2) %>% summarize(ncells = n(), prop = ncells/first(n_sampleid)) %>% ungroup() %>% as.data.frame()

stat_df_ncells = dcast(stat, organ_simplified ~ annotation_level2, value.var = "ncells")
stat_df_ncells[is.na(stat_df_ncells)] = 0
stat_df_prop = dcast(stat, organ_simplified ~ annotation_level2, value.var = "prop")
stat_df_prop[is.na(stat_df_prop)] = 0

all(ncells$organ_simplified == stat_df_ncells$organ_simplified)

m3 = merge(ncells, stat_df_ncells, by.x = "organ_simplified", by.y = "organ_simplified")
m4 = merge(m3, stat_df_prop, by.x = "organ_simplified", by.y = "organ_simplified", suffixes = c(".ncells", ".prop"))

write.table(m4, file = sprintf("%s/annotation_level2_PropPerOrgan.csv", prefix),row.names = F, col.names = T, sep = ",", quote = F)

saveRDS(m4, file = sprintf("%s/annotation_level2_PropPerOrgan.Rds", prefix))

```

heatmaps
```{r}
library(pheatmap)

m3 = readRDS(sprintf("%s/annotation_level2_PropPerOrgan.Rds", prefix))

tmp3 = m3[,c("organ_simplified", colnames(m3)[grepl(pattern = ".prop$", colnames(m3))])]
rownames(tmp3) = tmp3[,1]
tmp3 = tmp3[,-1]
colnames(tmp3) = gsub(pattern = "\\.prop", replacement = "", colnames(tmp3))

# ColorRamp = rev(viridis(100))
labels_matrix = signif(tmp3,2)*100
labels_matrix[labels_matrix==0] = ""

pdf(file = sprintf("%s/annotation_level2_Organ_Composition_heatmap.pdf", prefix), width =20, height =10, useDingbats = F)
pheatmap(mat = tmp3*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix, number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 5, main = "Percent of cells in each Organ", na_col = "#FDE725")

for (i in c("CD4", "CD8", "Treg", "gdT", "CD8aa","nonconv", "DN", "DP")) {
    print(i)
    colz = grepl(sprintf("%s_",i), colnames(tmp3))
    pheatmap(mat = tmp3[,colz]*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix[,colz], number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 10, main = sprintf("Percent of cells in each Organ for %s clusters",i), na_col = "#FDE725")
    
}

dev.off()
```

split by annotation_level1
```{r}
m3 = readRDS(file = sprintf("%s/annotation_level2_PropPerOrgan.Rds", prefix))

# which(colnames(m3) == "sample_name")
# i = "CD4"
for(i in c("CD4", "CD8", "Treg", "gdT", "CD8aa","nonconv", "DN", "DP")) {
    print(i)
    sub = which(grepl(sprintf("%s_|organ_simplified",i), colnames(m3)))
    write.table(m3[,sub], file = sprintf("%s/annotation_level2_PropPerOrgan_%s.csv", prefix,i) ,row.names = F, col.names = T, sep = ",", quote = F)
}
```



**Count number of cells for each cluster level 1 in each organ**
```{r}
m = so@meta.data

sample_metadata = read.table("/project/zemmour/david/ImmgenT/exp_id/IGT1_96_sample_metadata.csv",header = T, sep = ",", row.names = 1)
sample_metadata$IGTHT = paste(sample_metadata$immgent_IGT_10xlane_id, sample_metadata$hashtag_number, sep = "")
sample_metadata$IGTHT = gsub(x = sample_metadata$IGTHT, pattern = "IGT", replacement = "I" )
sample_metadata$IGTHT = gsub(x = sample_metadata$IGTHT, pattern = "HT", replacement = "H" )
#organ_simplified
sample_metadata$organ_simplified = sample_metadata$organ
sample_metadata$organ_simplified[grep(pattern = "lymph node", sample_metadata$organ)] = "LN"
sample_metadata$organ_simplified[grep(pattern = "skin|Skin", sample_metadata$organ)] = "skin"
sample_metadata$organ_simplified[grep(pattern = "colon", sample_metadata$organ)] = "colon"
sample_metadata$organ_simplified[grep(pattern = "duoden|ileal|ileum|jejun|small intestine", sample_metadata$organ)] = "small intestine"
sample_metadata$organ_simplified[sample_metadata$organ %in% c("CNS", "brain")] = "CNS"
sample_metadata$organ_simplified[sample_metadata$organ %in% c("lamina propria", "gut")] = "small intestine"
sample_metadata$organ_simplified[grep(pattern = "salivary|submandibular", sample_metadata$organ)] = "submandibular salivary gland"

m2 = merge(m, sample_metadata, by.x = "IGTHT", by.y = "IGTHT",all.x = T, all.y = F, suffixes = c(".x", ""))

ncells = m2 %>% group_by(organ_simplified) %>% summarize(n_cells = n()) %>% as.data.frame()

stat = m2 %>% group_by(organ_simplified) %>% mutate(n_sampleid = n()) %>% group_by(organ_simplified, annotation_level1) %>% summarize(ncells = n(), prop = ncells/first(n_sampleid)) %>% ungroup() %>% as.data.frame()

stat_df_ncells = dcast(stat, organ_simplified ~ annotation_level1, value.var = "ncells")
stat_df_ncells[is.na(stat_df_ncells)] = 0
stat_df_prop = dcast(stat, organ_simplified ~ annotation_level1, value.var = "prop")
stat_df_prop[is.na(stat_df_prop)] = 0

all(ncells$organ_simplified == stat_df_ncells$organ_simplified)

m3 = merge(ncells, stat_df_ncells, by.x = "organ_simplified", by.y = "organ_simplified")
m4 = merge(m3, stat_df_prop, by.x = "organ_simplified", by.y = "organ_simplified", suffixes = c(".ncells", ".prop"))

write.table(m4, file = sprintf("%s/annotation_level1_PropPerOrgan.csv", prefix),row.names = F, col.names = T, sep = ",", quote = F)

saveRDS(m4, file = sprintf("%s/annotation_level1_PropPerOrgan.Rds", prefix))

```

```{r}
library(pheatmap)

m3 = readRDS(sprintf("%s/annotation_level1_PropPerOrgan.Rds", prefix))

tmp3 = m3[,c("organ_simplified", colnames(m3)[grepl(pattern = ".prop$", colnames(m3))])]
rownames(tmp3) = tmp3[,1]
tmp3 = tmp3[,-1]
colnames(tmp3) = gsub(pattern = "\\.prop", replacement = "", colnames(tmp3))

# ColorRamp = rev(viridis(100))
labels_matrix = signif(tmp3,2)*100
labels_matrix[labels_matrix==0] = ""

pdf(file = sprintf("%s/annotation_level1_Organ_Composition_heatmap.pdf", prefix), width =10, height =10, useDingbats = F)
pheatmap(mat = tmp3*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix, number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 10, main = "Percent of cells in each Organ", na_col = "#FDE725")
dev.off()
```

**PCA/UMAP of samples with annotation level2**

```{r}
set.seed(1)
library(uwot)
df = readRDS(sprintf("%s/annotation_level2_PropPerSample_withMetadata.Rds", prefix))
df$organ_simplified = df$organ
df$organ_simplified[grep(pattern = "lymph node", df$organ)] = "LN"
df$organ_simplified[grep(pattern = "skin|Skin", df$organ)] = "skin"
df$organ_simplified[grep(pattern = "colon", df$organ)] = "colon"
df$organ_simplified[grep(pattern = "duoden|ileal|ileum|jejun|small intestine", df$organ)] = "small intestine"
df$organ_simplified[df$organ_simplified %in% c("CNS", "brain")] = "CNS"
df$organ_simplified[df$organ_simplified %in% c("lamina propria", "gut")] = "small intestine"
df$organ_simplified[grep(pattern = "salivary|submandibular", df$organ_simplified)] = "submandibular salivary gland"
table(df$organ, df$organ_simplified)
table(df$organ_simplified)


props = df[,grepl("prop", colnames(df))]

props_scaled = t(scale(t(props)))

mypca = prcomp(props_scaled, center = F, scale. = F)

explained_variance = mypca$sdev^2
proportion_variance = explained_variance / sum(explained_variance)
elbow_df = data.frame(
  PC = seq_along(proportion_variance),
  VarianceExplained = proportion_variance
)
ggplot(elbow_df, aes(x = PC, y = VarianceExplained)) +
  geom_point(size = 2) +
  geom_line() +
  theme_minimal() +
  labs(
    title = "Elbow Plot",
    x = "Principal Component (PC)",
    y = "Proportion of Variance Explained"
  )


#Find clusters
library(igraph)
library(FNN)
pca_embeddings = mypca$x[, 1:30]
k = 15  # Number of neighbors for KNN
knn = get.knn(pca_embeddings, k = k)
adj_matrix <- matrix(0, nrow = nrow(pca_embeddings), ncol = nrow(pca_embeddings))
for (i in 1:nrow(knn$nn.index)) {
  neighbors <- knn$nn.index[i, ]
  adj_matrix[i, neighbors] <- 1
}
g <- graph_from_adjacency_matrix(adj_matrix, mode = "undirected")
louvain_result <- cluster_louvain(g, resolution = 1)
clusters <- membership(louvain_result)
table(clusters)

#Make UMAP
umap_result = umap(mypca$x[, 1:30], n_neighbors = 15, min_dist = 0.1, metric = "euclidean")
umap_df = as.data.frame(umap_result)
colnames(umap_df) = c("UMAP_1", "UMAP_2")
rownames(umap_df) = df$sample_name_new
umap_df$sample_name_new = rownames(umap_df)
umap_df = data.frame(umap_df, df)
umap_df$clusters = factor(clusters)

#Add annotation level 1 prop to dataframe
m3 = readRDS(sprintf("%s/annotation_level1_PropPerSample_withMetadata.Rds", prefix))
umap_df = merge(umap_df, m3[,grepl(".ncells|.prop|sample_name_new", colnames(m3))], by = "sample_name_new", all.x = T)

umap_df %>% group_by(clusters) %>% summarize()
umap_df %>% filter(clusters == "10") %>% pull(sample_name_new)

pdf(sprintf("%s/umap_samples.pdf",prefix), 8, 8,useDingbats = F)
p = ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = clusters)) +
  geom_point(alpha = 0.8, size = 2) +
        scale_color_manual(values = mypal)+
  theme_void() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")
LabelClusters(p, id = "clusters")

bkgrd = ggplot(umap_df[,c("UMAP_1", "UMAP_2")],aes(x = UMAP_1, y = UMAP_2)) + geom_point(alpha = 0.1, size = 1, color = "grey50")

p = geom_point(data = umap_df, aes(x = UMAP_1, y = UMAP_2, color = condition_broad), alpha = 0.8, size = 2)
bkgrd + p + scale_color_manual(values = mypal) + theme_minimal() + labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

p = geom_point(data = umap_df, aes(x = UMAP_1, y = UMAP_2, color = clusters), alpha = 1, size = 2)
bkgrd + p + facet_wrap(~organ_simplified) + scale_color_manual(values = mypal) + theme_minimal() + labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

p = geom_point(data = umap_df[umap_df$organ_simplified == "spleen",], aes(x = UMAP_1, y = UMAP_2, color = condition_broad), alpha = 0.8, size = 2)
bkgrd + p + facet_wrap(~condition_detailed) + scale_color_manual(values = mypal) + theme_minimal() + labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

p = ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = clusters)) +
  geom_point(alpha = 0.8, size = 2) +
  scale_color_manual(values = mypal) +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")
LabelClusters(p, id = "clusters")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD4.prop, size = CD4.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD8.prop, size = CD8.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = Treg.prop, size = Treg.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = gdT.prop, size = gdT.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD8aa.prop, size = CD8aa.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = nonconv.prop, size = nonconv.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = DN.prop, size = DN.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = DP.prop, size = DP.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD8_cl10.prop, size = CD8_cl10.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD8_cl11.prop, size = CD8_cl11.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD8_cl12.prop, size = CD8_cl12.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD4_cl23.prop, size = CD4_cl23.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD4_cl15.prop, size = CD4_cl15.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD4_cl18.prop, size = CD4_cl18.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD4_cl20.prop, size = CD4_cl20.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "", x = "UMAP 1", y = "UMAP 2")

dev.off()

library(tidygate)
gating <- 
  umap_df |>
  mutate(gated = gate(x = UMAP_1, y = UMAP_2))

gating %>% filter(!is.na(gated)) %>% pull(sample_name_new)

saveRDS(umap_df, file = sprintf("%s/annotation_level2_UMAP_samples.Rds", prefix))

```

**Saturation**

```{r}

igt_vec = unique(umap_df$immgent_IGT_10xlane_id) %>% na.omit()
extract_numeric = function(x) {
  as.numeric(gsub("\\D", "", x))
}
igt_vec = igt_vec[order(extract_numeric(igt_vec))] %>% as.character()

tmp = umap_df[,grepl("ncells|immgent_IGT_10xlane_id", colnames(umap_df)) ]
tmp = tmp[,!grepl("CD4\\.|CD8\\.|CD8aa\\.|DN\\.|DP\\.|gdT\\.|nonconv\\.|thymocyte.y\\.|Treg\\.", colnames(tmp))]
umap_df_melt = melt(tmp[,grepl("ncells|immgent_IGT_10xlane_id", colnames(tmp)) ])

nclust = c()
for (s in 1:length(igt_vec)) {
    print(s)
    umap_df_melt2 = umap_df_melt[umap_df_melt$immgent_IGT_10xlane_id %in% igt_vec[1:s],] %>% group_by(variable) %>% summarize(ncells = sum(value)) %>% as.data.frame()
    nclust = c(nclust, sum(umap_df_melt2$ncells > 50))
}

df = data.frame(experiment_number = igt_vec, number_of_clusters = nclust)
df$experiment_number = factor(df$experiment_number, levels = igt_vec)

pdf(sprintf("%s/cluster_saturation.pdf", prefix), 15, 7,useDingbats = F)
ggplot(df) + geom_point(aes(experiment_number, number_of_clusters), size = 3) + 
    geom_line(aes(x = experiment_number, y = number_of_clusters, group = 1)) + 
    geom_hline(aes(yintercept = 114), linetype="dashed", color = "brown", linewidth = 1) +
    ylim(c(0,130)) + theme_bw() + theme(axis.text.x=element_text(size=10, angle = 30), axis.text.y=element_text(size=20), legend.text=element_text(size=15), axis.title.x = element_text(size=15) , axis.title.y = element_text(size=15), legend.title = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
dev.off()


```

**Split per annotation level1**

```{r}

```




To do later?
```{r}
##2. Composition of each organ 
df = data.frame(cluster = factor(sprintf("cl%s",so@meta.data[,res]), levels = sprintf("cl%s",as.character(c(0:(length(unique(so@meta.data[,res]))-1))))), 
                sample = factor(so$organ, levels = sort(unique(so$organ))) )
tmp = table(df$cluster, df$sample)
tmp2 = t(t(tmp) / colSums(tmp)) # normalize the number of cells per sample
colSums(tmp2)
tmp3 = tmp2
rowSums(tmp3)
tmp4 = melt(tmp3)
head(tmp4)
tmp4$sample = df$sample[match(tmp4$Var2, df$sample)]

pdf(file = sprintf("%s_OrganComposition_%s.pdf", prefix, res), width =30, height =20)
ColorRamp = rev(viridis(100))
tmp3[tmp3==0] = NA
labels_matrix = ifelse(is.na(tmp3), yes = "", no = as.character(signif(tmp3,2)*100))
#labels_matrix = matrix(labels_matrix, nrow(data_matrix), ncol(data_matrix))
pheatmap(mat = signif(tmp3,2)*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix, number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 15, main = "Percent of cells in each IGT", na_col = "#FDE725")

ggplot(tmp4) + geom_jitter(aes(Var1, value, color = sample), position = position_jitter(width = 0.2), size = I(5), alpha = 0.7) + scale_color_manual(values = mypal) + scale_y_continuous(trans = log_trans(), breaks = c(0.01, 0.05, seq(0.1, 1, by = 0.1)) , labels =  c( 0.01, 0.05, seq(0.1, 1, by = 0.1))) + theme_bw()+ ggtitle(label = "Cluster composition in each organ") + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10))

ggplot(tmp4, aes(Var1, value)) + geom_boxplot(aes(fill = sample, group = Var1), outlier.alpha = 0 ) + 
    geom_jitter(aes(Var1, value, color = sample), position = position_jitter(width = 0.2), size = I(5), alpha = 0.7) +
    scale_color_manual(values = mypal) +
    scale_y_continuous(trans = log_trans(), breaks = c(0.01, 0.05, seq(0.1, 1, by = 0.1)) , labels =  c( 0.01, 0.05, seq(0.1, 1, by = 0.1))) + 
    theme_bw()+ ggtitle(label = "Cluster composition in each  organ") + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10))

ggplot(tmp4, aes(Var1, value)) + geom_boxplot(aes(fill = sample, group = Var1), outlier.alpha = 0) + 
    geom_jitter(aes(Var1, value, color = sample), position = position_jitter(width = 0.2), size = I(5), alpha = 0.7) +
    scale_color_manual(values = mypal) +
    theme_bw()+ ggtitle(label = "Cluster composition in each  organ") + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10))


ggplot(tmp4) + geom_point(aes(Var1, value, color = sample), size = I(3), alpha = 0.7) + scale_color_manual(values = mypal) + scale_y_continuous(trans = log_trans(), breaks = c(0.01, 0.05, seq(0.1, 1, by = 0.1)) , labels =  c( 0.01, 0.05, seq(0.1, 1, by = 0.1))) + theme_bw()+ ggtitle(label = "Cluster composition in each organ") + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10)) + facet_wrap(~sample)  + NoLegend()

ggplot(tmp4) + geom_point(aes(Var1, value, color = sample), size = I(3), alpha = 0.7) + scale_color_manual(values = mypal) + theme_bw()+ ggtitle(label = "Cluster composition in each organ") + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10)) + facet_wrap(~sample) + NoLegend()

dev.off()


```


