---
title: "composition_analysis"
output: html_document
date: "2024-10-24"
author: "David Zemmour"
editor_options: 
  chunk_output_type: console
---

**Initialize: load libraries and custom functions**

```{bash}
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=jfkfloor2 --qos=jfkfloor2 --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=beagle3-bigmem --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=zemmour-hm --qos=zemmour --nodes=1 
sinteractive --time=03:00:00 --account=pi-zemmour --partition=caslake --nodes=1 --mem=96GB

module load python/anaconda-2022.05 
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13
source activate /project/zemmour/david/envs/scvi_20240315
module load openblas/0.3.13

cd /project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/
R
```

```{r}
setwd("~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96")
libs = c("Seurat", "ggplot2", "dplyr", "ggrastr", "RColorBrewer", "pals", "scales", "reshape2", "pheatmap", "scattermore") 
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))
source("/project/jfkfloor2/zemmourlab/david/immgent/immgent_integration_git/custom_functions_david.R")

ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
ColorRamp = rev(rainbow(10, end = 4/6))
ColorRamp = rev(viridis(100))
ColorRamp = brewer.pal(9, "Blues")

#mycol = c("black","blue","red","darkgreen", "orange","purple", "cyan", "greenyellow",    "salmon", "magenta","pink", "tan", "brown") # c("magenta", "red",  "darkgreen", "cyan", "blue", "blue", "blue", "black", "blue", "blue", "blue", "blue", "orange")

n = 70
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
mypal1 = unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals))))
mypal1 = mypal1[-4]

library("pals")
parade = function(n) { return(Seurat::DiscretePalette(n, palette = "parade", shuffle = F)) }

length(glasbey())
length(polychrome())
mypal = c(glasbey(), polychrome(), mypal1)
names(mypal) = NULL

```

Prefix
```{r}
# prefix = "SampleComp/20250109"
# prefix = "SampleComp/20250224"
prefix = "SampleComp/20250226"

# reduc = "totalvi_20241006"
# clusters = "annotation_level1"

if (!dir.exists(prefix)) {
    dir.create(prefix, recursive = TRUE)
    cat("Folder created:", prefix, "\n")
} else {
    cat("Folder already exists:", prefix, "\n")
}
```

**Most up-to-date data**

```{r}
# so = readRDS("igt1_96_withtotalvi20241021.Rds")
# so = readRDS("igt1_96_withtotalvi20250109.Rds")
# so = readRDS("igt1_96_withtotalvi20250212.Rds")
so = readRDS("igt1_96_withtotalvi20250226.Rds")
so = so[,!so$annotation_level1 %in% c("unclear", "nonT", "remove")]

# sample_metadata = read.table("/project/zemmour/david/ImmgenT/exp_id/IGT1_96_sample_metadata.csv",header = T, sep = ",")
# sample_metadata = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/export_data/Sample_metadata_david_20250124_v7.csv",header = T, sep = ",")
sample_metadata = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/export_data/Sample_metadata_david_20250226_v8.csv",header = T, sep = ",")
```

**Count number of cells for each cluster level 2 in each sample**

proportion per level1 per sample
```{r}
m = so@meta.data

ncells = m %>% group_by(IGTHT) %>% summarize(n_cells = n()) %>% as.data.frame()

stat = m %>% group_by(IGTHT, annotation_level1) %>% mutate(n_sampleid = n()) %>% group_by(IGTHT, annotation_level2) %>% summarize(ncells = n(), prop = ncells/first(n_sampleid)) %>% ungroup() %>% as.data.frame()

# stat = m %>% group_by(IGTHT) %>% mutate(n_sampleid = n()) %>% group_by(IGTHT, annotation_level2) %>% summarize(ncells = n(), prop = ncells/first(n_sampleid)) %>% ungroup() %>% as.data.frame()

stat_df_ncells = dcast(stat, IGTHT ~ annotation_level2, value.var = "ncells")
stat_df_ncells[is.na(stat_df_ncells)] = 0
stat_df_prop = dcast(stat, IGTHT ~ annotation_level2, value.var = "prop")
stat_df_prop[is.na(stat_df_prop)] = 0
# rowSums(stat_df_prop[,grepl("^CD4", colnames(stat_df_prop))])

all(ncells$IGTHT == stat_df_ncells$IGTHT)

m2 = merge(ncells, stat_df_ncells, by.x = "IGTHT", by.y = "IGTHT")
m2 = merge(m2, stat_df_prop, by.x = "IGTHT", by.y = "IGTHT", suffixes = c(".ncells", ".prop"))

write.table(m2, file = sprintf("%s/annotation_level2_PropPerSample.txt", prefix),row.names = F, col.names = T, sep = "\t", quote = F)

# sample_metadata$IGTHT = paste(sample_metadata$immgent_IGT_10xlane_id, sample_metadata$hashtag_number, sep = "")
# sample_metadata$IGTHT = gsub(x = sample_metadata$IGTHT, pattern = "IGT", replacement = "I" )
# sample_metadata$IGTHT = gsub(x = sample_metadata$IGTHT, pattern = "HT", replacement = "H" )

m3 = merge(m2, sample_metadata, by.x = "IGTHT", by.y = "IGTHT",all.x = T, all.y = F)

# m3$sample_code = paste(m3$IGTHT, m3$sample_name, sep = ".")
# m3$sample_code = make.names(m3$sample_code)

saveRDS(m3, file = sprintf("%s/annotation_level2_PropPerSamplePerLevel1_withMetadata.Rds", prefix))

write.table(m3, file = sprintf("%s/annotation_level2_PropPerSamplePerLevel1_withMetadata.txt", prefix) ,row.names = F, col.names = T, sep = "\t", quote = F)
```

proportion per sample
```{r}
m = so@meta.data

ncells = m %>% group_by(IGTHT) %>% summarize(n_cells = n()) %>% as.data.frame()

stat = m %>% group_by(IGTHT) %>% mutate(n_sampleid = n()) %>% group_by(IGTHT, annotation_level2) %>% summarize(ncells = n(), prop = ncells/first(n_sampleid)) %>% ungroup() %>% as.data.frame()

stat_df_ncells = dcast(stat, IGTHT ~ annotation_level2, value.var = "ncells")
stat_df_ncells[is.na(stat_df_ncells)] = 0
stat_df_prop = dcast(stat, IGTHT ~ annotation_level2, value.var = "prop")
stat_df_prop[is.na(stat_df_prop)] = 0

all(ncells$IGTHT == stat_df_ncells$IGTHT)

m2 = merge(ncells, stat_df_ncells, by.x = "IGTHT", by.y = "IGTHT")
m2 = merge(m2, stat_df_prop, by.x = "IGTHT", by.y = "IGTHT", suffixes = c(".ncells", ".prop"))

write.table(m2, file = sprintf("%s/annotation_level2_PropPerSample.txt", prefix),row.names = F, col.names = T, sep = "\t", quote = F)

# sample_metadata$IGTHT = paste(sample_metadata$immgent_IGT_10xlane_id, sample_metadata$hashtag_number, sep = "")
# sample_metadata$IGTHT = gsub(x = sample_metadata$IGTHT, pattern = "IGT", replacement = "I" )
# sample_metadata$IGTHT = gsub(x = sample_metadata$IGTHT, pattern = "HT", replacement = "H" )

m3 = merge(m2, sample_metadata, by.x = "IGTHT", by.y = "IGTHT",all.x = T, all.y = F)

# m3$sample_code = paste(m3$IGTHT, m3$sample_name, sep = ".")
# m3$sample_code = make.names(m3$sample_code)

saveRDS(m3, file = sprintf("%s/annotation_level2_PropPerSample_withMetadata.Rds", prefix))

write.table(m3, file = sprintf("%s/annotation_level2_PropPerSample_withMetadata.txt", prefix) ,row.names = F, col.names = T, sep = "\t", quote = F)
```

```{r}
library(pheatmap)

m3 = readRDS(sprintf("%s/annotation_level2_PropPerSample_withMetadata.Rds", prefix))

# m3$sample_code = paste(m3$IGTHT, m3$sample_name, sep = ".")
# m3$sample_code = make.names(m3$sample_code)

tmp3 = m3[,c("sample_code", colnames(m3)[grepl(pattern = ".prop$", colnames(m3))])]
rownames(tmp3) = tmp3[,1]
tmp3 = tmp3[,-1]
colnames(tmp3) = gsub(pattern = "\\.prop", replacement = "", colnames(tmp3))

# ColorRamp = rev(viridis(100))
labels_matrix = signif(tmp3,2)*100
labels_matrix[labels_matrix==0] = ""

pdf(file = sprintf("%s/annotation_level2_Sample_Composition_heatmap.pdf", prefix), width =50, height =150, useDingbats = F)

pheatmap(mat = tmp3*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix, number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 10, main = "Percent of cells in each Sample", na_col = "#FDE725")

for (i in c("CD4", "CD8", "Treg", "gdT", "CD8aa","nonconv", "DN", "DP")) {
    print(i)
    colz = grepl(sprintf("%s_",i), colnames(tmp3))
    pheatmap(mat = tmp3[,colz]*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix[,colz], number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 10, main = sprintf("Percent of cells in each Sample for %s clusters",i), na_col = "#FDE725")
    
}

dev.off()

```

split by annotation_level1
```{r}
m3 = readRDS(file = sprintf("%s/annotation_level2_PropPerSample_withMetadata.Rds", prefix))

# which(colnames(m3) == "sample_name")
# i = "CD4"
for(i in c("CD4", "CD8", "Treg", "gdT", "CD8aa","nonconv", "DN", "DP")) {
    print(i)
    sub = c(which(grepl(sprintf("%s_",i), colnames(m3))), seq(which(colnames(m3) == "sample_name"),ncol(m3)))
    write.table(m3[,sub], file = sprintf("%s/annotation_level2_PropPerSample_withMetadata_%s.txt", prefix,i) ,row.names = F, col.names = T, sep = "\t", quote = F)
}
```



**Count number of cells for each cluster LEVEL 1 in each sample**
```{r}
m = so@meta.data

ncells = m %>% group_by(IGTHT) %>% summarize(n_cells = n()) %>% as.data.frame()

stat = m %>% group_by(IGTHT) %>% mutate(n_sampleid = n()) %>% group_by(IGTHT, annotation_level1) %>% summarize(ncells = n(), prop = ncells/first(n_sampleid)) %>% ungroup() %>% as.data.frame()

stat_df_ncells = dcast(stat, IGTHT ~ annotation_level1, value.var = "ncells")
stat_df_ncells[is.na(stat_df_ncells)] = 0
stat_df_prop = dcast(stat, IGTHT ~ annotation_level1, value.var = "prop")
stat_df_prop[is.na(stat_df_prop)] = 0

all(ncells$IGTHT == stat_df_ncells$IGTHT)

m2 = merge(ncells, stat_df_ncells, by.x = "IGTHT", by.y = "IGTHT")
m2 = merge(m2, stat_df_prop, by.x = "IGTHT", by.y = "IGTHT", suffixes = c(".ncells", ".prop"))

write.table(m2, file = sprintf("%s/annotation_level1_PropPerSample.txt", prefix),row.names = F, col.names = T, sep = "\t", quote = F)

m3 = merge(m2, sample_metadata, by.x = "IGTHT", by.y = "IGTHT",all.x = T, all.y = F)

saveRDS(m3, file = sprintf("%s/annotation_level1_PropPerSample_withMetadata.Rds", prefix))

write.table(m3, file = sprintf("%s/annotation_level1_PropPerSample_withMetadata.txt", prefix),row.names = F, col.names = T, sep = "\t", quote = F)


```
heatmaps
```{r}
library(pheatmap)

m3 = readRDS( sprintf("%s/annotation_level1_PropPerSample_withMetadata.Rds", prefix))

tmp3 = m3[,c("sample_code", colnames(m3)[grepl(pattern = ".prop$", colnames(m3))])]
rownames(tmp3) = tmp3[,1]
tmp3 = tmp3[,-1]
colnames(tmp3) = gsub(pattern = "\\.prop", replacement = "", colnames(tmp3))

# ColorRamp = rev(viridis(100))
labels_matrix = signif(tmp3,2)*100
labels_matrix[labels_matrix==0] = ""

pdf(file = sprintf("%s/annotation_level1_Sample_Composition_heatmap.pdf", prefix), width =20, height =150, useDingbats = F)

pheatmap(mat = tmp3*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix, number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 10, main = "Percent of cells in each Sample", na_col = "#FDE725")

dev.off()

```


**Count number of cells for each cluster level 2 in each IGT**
```{r}
m = so@meta.data

ncells = m %>% group_by(IGT) %>% summarize(n_cells = n()) %>% as.data.frame()

stat = m %>% group_by(IGT) %>% mutate(n_sampleid = n()) %>% group_by(IGT, annotation_level2) %>% summarize(ncells = n(), prop = ncells/first(n_sampleid)) %>% ungroup() %>% as.data.frame()

stat_df_ncells = dcast(stat, IGT ~ annotation_level2, value.var = "ncells")
stat_df_ncells[is.na(stat_df_ncells)] = 0
stat_df_prop = dcast(stat, IGT ~ annotation_level2, value.var = "prop")
stat_df_prop[is.na(stat_df_prop)] = 0

all(ncells$IGT == stat_df_ncells$IGT)

m2 = merge(ncells, stat_df_ncells, by.x = "IGT", by.y = "IGT")
m2 = merge(m2, stat_df_prop, by.x = "IGT", by.y = "IGT", suffixes = c(".ncells", ".prop"))

write.table(m2, file = sprintf("%s/annotation_level2_PropPerIGT.txt", prefix),row.names = F, col.names = T, sep = "\t", quote = F)

saveRDS(m2, file = sprintf("%s/annotation_level2_PropPerIGT.Rds", prefix))

```
heatmaps
```{r}
library(pheatmap)

m3 = readRDS(sprintf("%s/annotation_level2_PropPerIGT.Rds", prefix))

tmp3 = m3[,c("IGT", colnames(m3)[grepl(pattern = ".prop$", colnames(m3))])]
rownames(tmp3) = tmp3[,1]
tmp3 = tmp3[,-1]
colnames(tmp3) = gsub(pattern = "\\.prop", replacement = "", colnames(tmp3))

# ColorRamp = rev(viridis(100))
labels_matrix = signif(tmp3,2)*100
labels_matrix[labels_matrix==0] = ""

pdf(file = sprintf("%s/annotation_level2_IGT_Composition_heatmap.pdf", prefix), width =20, height =20, useDingbats = F)
pheatmap(mat = tmp3*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix, number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 5, main = "Percent of cells in each Sample", na_col = "#FDE725")

for (i in c("CD4", "CD8", "Treg", "gdT", "CD8aa","nonconv", "DN", "DP")) {
    print(i)
    colz = grepl(sprintf("%s_",i), colnames(tmp3))
    pheatmap(mat = tmp3[,colz]*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix[,colz], number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 10, main = sprintf("Percent of cells in each IGT for %s clusters",i), na_col = "#FDE725")
    
}

dev.off()
```

**Count number of cells for each cluster level 2 in each organs**
```{r}
m = so@meta.data

# sample_metadata = read.table("/project/zemmour/david/ImmgenT/exp_id/IGT1_96_sample_metadata.csv",header = T, sep = ",", row.names = 1)
# sample_metadata$IGTHT = paste(sample_metadata$immgent_IGT_10xlane_id, sample_metadata$hashtag_number, sep = "")
# sample_metadata$IGTHT = gsub(x = sample_metadata$IGTHT, pattern = "IGT", replacement = "I" )
# sample_metadata$IGTHT = gsub(x = sample_metadata$IGTHT, pattern = "HT", replacement = "H" )
# #organ_simplified
# sample_metadata$organ_simplified = sample_metadata$organ
# sample_metadata$organ_simplified[grep(pattern = "lymph node", sample_metadata$organ)] = "LN"
# sample_metadata$organ_simplified[grep(pattern = "skin|Skin", sample_metadata$organ)] = "skin"
# sample_metadata$organ_simplified[grep(pattern = "colon", sample_metadata$organ)] = "colon"
# sample_metadata$organ_simplified[grep(pattern = "duoden|ileal|ileum|jejun|small intestine", sample_metadata$organ)] = "small intestine"
# sample_metadata$organ_simplified[sample_metadata$organ %in% c("CNS", "brain")] = "CNS"
# sample_metadata$organ_simplified[sample_metadata$organ %in% c("lamina propria", "gut")] = "small intestine"
# sample_metadata$organ_simplified[grep(pattern = "salivary|submandibular", sample_metadata$organ)] = "submandibular salivary gland"

m2 = merge(m, sample_metadata, by.x = "IGTHT", by.y = "IGTHT",all.x = T, all.y = F, suffixes = c(".x", ""))

ncells = m2 %>% group_by(organ_simplified) %>% summarize(n_cells = n()) %>% as.data.frame()

stat = m2 %>% group_by(organ_simplified) %>% mutate(n_sampleid = n()) %>% group_by(organ_simplified, annotation_level2) %>% summarize(ncells = n(), prop = ncells/first(n_sampleid)) %>% ungroup() %>% as.data.frame()

stat_df_ncells = dcast(stat, organ_simplified ~ annotation_level2, value.var = "ncells")
stat_df_ncells[is.na(stat_df_ncells)] = 0
stat_df_prop = dcast(stat, organ_simplified ~ annotation_level2, value.var = "prop")
stat_df_prop[is.na(stat_df_prop)] = 0

all(ncells$organ_simplified == stat_df_ncells$organ_simplified)

m3 = merge(ncells, stat_df_ncells, by.x = "organ_simplified", by.y = "organ_simplified")
m4 = merge(m3, stat_df_prop, by.x = "organ_simplified", by.y = "organ_simplified", suffixes = c(".ncells", ".prop"))

write.table(m4, file = sprintf("%s/annotation_level2_PropPerOrgan.txt", prefix),row.names = F, col.names = T, sep = "\t", quote = F)

saveRDS(m4, file = sprintf("%s/annotation_level2_PropPerOrgan.Rds", prefix))

```

heatmaps
```{r}
library(pheatmap)

m3 = readRDS(sprintf("%s/annotation_level2_PropPerOrgan.Rds", prefix))

tmp3 = m3[,c("organ_simplified", colnames(m3)[grepl(pattern = ".prop$", colnames(m3))])]
rownames(tmp3) = tmp3[,1]
tmp3 = tmp3[,-1]
colnames(tmp3) = gsub(pattern = "\\.prop", replacement = "", colnames(tmp3))

# ColorRamp = rev(viridis(100))
labels_matrix = signif(tmp3,2)*100
labels_matrix[labels_matrix==0] = ""

pdf(file = sprintf("%s/annotation_level2_Organ_Composition_heatmap.pdf", prefix), width =20, height =10, useDingbats = F)
pheatmap(mat = tmp3*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix, number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 5, main = "Percent of cells in each Organ", na_col = "#FDE725")

for (i in c("CD4", "CD8", "Treg", "gdT", "CD8aa","nonconv", "DN", "DP")) {
    print(i)
    colz = grepl(sprintf("%s_",i), colnames(tmp3))
    pheatmap(mat = tmp3[,colz]*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix[,colz], number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 10, main = sprintf("Percent of cells in each Organ for %s clusters",i), na_col = "#FDE725")
    
}

dev.off()
```

split by annotation_level1
```{r}
m3 = readRDS(file = sprintf("%s/annotation_level2_PropPerOrgan.Rds", prefix))

for( i in c("CD4", "CD8", "Treg", "gdT", "CD8aa","nonconv", "DN", "DP")) {
    print(i)
    sub = c(which(grepl(sprintf("%s_|organ_simplified",i), colnames(m3))))
    write.table(m3[,sub], file = sprintf("%s/annotation_level2_PropPerOrgan_%s.txt", prefix,i) ,row.names = F, col.names = T, sep = "\t", quote = F)
}


```

**Count number of cells for each cluster level 1 in each organ**
```{r}
m = so@meta.data

# sample_metadata = read.table("/project/zemmour/david/ImmgenT/exp_id/IGT1_96_sample_metadata.csv",header = T, sep = ",", row.names = 1)
# sample_metadata$IGTHT = paste(sample_metadata$immgent_IGT_10xlane_id, sample_metadata$hashtag_number, sep = "")
# sample_metadata$IGTHT = gsub(x = sample_metadata$IGTHT, pattern = "IGT", replacement = "I" )
# sample_metadata$IGTHT = gsub(x = sample_metadata$IGTHT, pattern = "HT", replacement = "H" )
# #organ_simplified
# sample_metadata$organ_simplified = sample_metadata$organ
# sample_metadata$organ_simplified[grep(pattern = "lymph node", sample_metadata$organ)] = "LN"
# sample_metadata$organ_simplified[grep(pattern = "skin|Skin", sample_metadata$organ)] = "skin"
# sample_metadata$organ_simplified[grep(pattern = "colon", sample_metadata$organ)] = "colon"
# sample_metadata$organ_simplified[grep(pattern = "duoden|ileal|ileum|jejun|small intestine", sample_metadata$organ)] = "small intestine"
# sample_metadata$organ_simplified[sample_metadata$organ %in% c("CNS", "brain")] = "CNS"
# sample_metadata$organ_simplified[sample_metadata$organ %in% c("lamina propria", "gut")] = "small intestine"
# sample_metadata$organ_simplified[grep(pattern = "salivary|submandibular", sample_metadata$organ)] = "submandibular salivary gland"

m2 = merge(m, sample_metadata, by.x = "IGTHT", by.y = "IGTHT",all.x = T, all.y = F, suffixes = c(".x", ""))

ncells = m2 %>% group_by(organ_simplified) %>% summarize(n_cells = n()) %>% as.data.frame()

stat = m2 %>% group_by(organ_simplified) %>% mutate(n_sampleid = n()) %>% group_by(organ_simplified, annotation_level1) %>% summarize(ncells = n(), prop = ncells/first(n_sampleid)) %>% ungroup() %>% as.data.frame()

stat_df_ncells = dcast(stat, organ_simplified ~ annotation_level1, value.var = "ncells")
stat_df_ncells[is.na(stat_df_ncells)] = 0
stat_df_prop = dcast(stat, organ_simplified ~ annotation_level1, value.var = "prop")
stat_df_prop[is.na(stat_df_prop)] = 0

all(ncells$organ_simplified == stat_df_ncells$organ_simplified)

m3 = merge(ncells, stat_df_ncells, by.x = "organ_simplified", by.y = "organ_simplified")
m4 = merge(m3, stat_df_prop, by.x = "organ_simplified", by.y = "organ_simplified", suffixes = c(".ncells", ".prop"))

write.table(m4, file = sprintf("%s/annotation_level1_PropPerOrgan.txt", prefix),row.names = F, col.names = T, sep = "\t", quote = F)

saveRDS(m4, file = sprintf("%s/annotation_level1_PropPerOrgan.Rds", prefix))

```

```{r}
library(pheatmap)

m3 = readRDS(sprintf("%s/annotation_level1_PropPerOrgan.Rds", prefix))

tmp3 = m3[,c("organ_simplified", colnames(m3)[grepl(pattern = ".prop$", colnames(m3))])]
rownames(tmp3) = tmp3[,1]
tmp3 = tmp3[,-1]
colnames(tmp3) = gsub(pattern = "\\.prop", replacement = "", colnames(tmp3))

# ColorRamp = rev(viridis(100))
labels_matrix = signif(tmp3,2)*100
labels_matrix[labels_matrix==0] = ""

pdf(file = sprintf("%s/annotation_level1_Organ_Composition_heatmap.pdf", prefix), width =10, height =10, useDingbats = F)
pheatmap(mat = tmp3*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix, number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 10, main = "Percent of cells in each Organ", na_col = "#FDE725")
dev.off()
```

**PCA/UMAP of samples with annotation level2**

```{r}
set.seed(1)
library(uwot)
df = readRDS(sprintf("%s/annotation_level2_PropPerSample_withMetadata.Rds", prefix))
# df$organ_simplified = df$organ
# df$organ_simplified[grep(pattern = "lymph node", df$organ)] = "LN"
# df$organ_simplified[grep(pattern = "skin|Skin", df$organ)] = "skin"
# df$organ_simplified[grep(pattern = "colon", df$organ)] = "colon"
# df$organ_simplified[grep(pattern = "duoden|ileal|ileum|jejun|small intestine", df$organ)] = "small intestine"
# df$organ_simplified[df$organ_simplified %in% c("CNS", "brain")] = "CNS"
# df$organ_simplified[df$organ_simplified %in% c("lamina propria", "gut")] = "small intestine"
# df$organ_simplified[grep(pattern = "salivary|submandibular", df$organ_simplified)] = "submandibular salivary gland"
# table(df$organ, df$organ_simplified)
# table(df$organ_simplified)

props = df[,grepl("prop", colnames(df))]

props_scaled = t(scale(t(props)))

mypca = prcomp(props_scaled, center = F, scale. = F)

explained_variance = mypca$sdev^2
proportion_variance = explained_variance / sum(explained_variance)
elbow_df = data.frame(
  PC = seq_along(proportion_variance),
  VarianceExplained = proportion_variance
)
ggplot(elbow_df, aes(x = PC, y = VarianceExplained)) +
  geom_point(size = 2) +
  geom_line() +
  theme_minimal() +
  labs(
    title = "Elbow Plot",
    x = "Principal Component (PC)",
    y = "Proportion of Variance Explained"
  )


#Find clusters
library(igraph)
library(FNN)
pca_embeddings = mypca$x[, 1:30]
k = 15  # Number of neighbors for KNN
knn = get.knn(pca_embeddings, k = k)
adj_matrix <- matrix(0, nrow = nrow(pca_embeddings), ncol = nrow(pca_embeddings))
for (i in 1:nrow(knn$nn.index)) {
  neighbors <- knn$nn.index[i, ]
  adj_matrix[i, neighbors] <- 1
}
g <- graph_from_adjacency_matrix(adj_matrix, mode = "undirected")
louvain_result <- cluster_louvain(g, resolution = 1)
clusters <- membership(louvain_result)
table(clusters)

#Make UMAP
umap_result = umap(mypca$x[, 1:30], n_neighbors = 15, min_dist = 0.1, metric = "euclidean")
umap_df = as.data.frame(umap_result)
colnames(umap_df) = c("UMAP_1", "UMAP_2")
rownames(umap_df) = df$sample_code
umap_df$sample_code = rownames(umap_df)
umap_df = data.frame(umap_df, df)
umap_df$clusters = factor(clusters)

#Add annotation level 1 prop to dataframe
m3 = readRDS(sprintf("%s/annotation_level1_PropPerSample_withMetadata.Rds", prefix))
umap_df = merge(umap_df, m3[,grepl(".ncells|.prop|sample_code", colnames(m3))], by = "sample_code", all.x = T)

umap_df %>% group_by(clusters) %>% summarize()
umap_df %>% filter(clusters == "10") %>% pull(sample_code)

pdf(sprintf("%s/umap_samples.pdf",prefix), 8, 8,useDingbats = F)
p = ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = clusters)) +
  geom_point(alpha = 0.8, size = 2) +
        scale_color_manual(values = mypal)+
  theme_void() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")
LabelClusters(p, id = "clusters")

bkgrd = ggplot(umap_df[,c("UMAP_1", "UMAP_2")],aes(x = UMAP_1, y = UMAP_2)) + geom_point(alpha = 0.1, size = 1, color = "grey50")

p = geom_point(data = umap_df, aes(x = UMAP_1, y = UMAP_2, color = condition_broad), alpha = 0.8, size = 2)
bkgrd + p + scale_color_manual(values = mypal) + theme_minimal() + labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

p = geom_point(data = umap_df, aes(x = UMAP_1, y = UMAP_2, color = clusters), alpha = 1, size = 2)
bkgrd + p + facet_wrap(~organ_simplified) + scale_color_manual(values = mypal) + theme_minimal() + labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

p = geom_point(data = umap_df[umap_df$organ_simplified == "spleen",], aes(x = UMAP_1, y = UMAP_2, color = condition_broad), alpha = 0.8, size = 2)
bkgrd + p + facet_wrap(~condition_detailed) + scale_color_manual(values = mypal) + theme_minimal() + labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

p = ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = clusters)) +
  geom_point(alpha = 0.8, size = 2) +
  scale_color_manual(values = mypal) +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")
LabelClusters(p, id = "clusters")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD4.prop, size = CD4.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD8.prop, size = CD8.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = Treg.prop, size = Treg.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = gdT.prop, size = gdT.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD8aa.prop, size = CD8aa.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = nonconv.prop, size = nonconv.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = DN.prop, size = DN.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = DP.prop, size = DP.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD8_cl10.prop, size = CD8_cl10.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD8_cl11.prop, size = CD8_cl11.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD8_cl12.prop, size = CD8_cl12.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD4_cl23.prop, size = CD4_cl23.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD4_cl15.prop, size = CD4_cl15.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "UMAP Visualization", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD4_cl18.prop, size = CD4_cl18.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "", x = "UMAP 1", y = "UMAP 2")

ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = CD4_cl20.prop, size = CD4_cl20.prop)) +
  geom_point(alpha = 0.8) +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "", x = "UMAP 1", y = "UMAP 2")

dev.off()

library(tidygate)
gating <- 
  umap_df |>
  mutate(gated = gate(x = UMAP_1, y = UMAP_2))

gating %>% filter(!is.na(gated)) %>% pull(sample_code)

saveRDS(umap_df, file = sprintf("%s/annotation_level2_UMAP_samples.Rds", prefix))

```

**Saturation**

```{r}

igt_vec = unique(umap_df$immgent_IGT_10xlane_id) %>% na.omit()
extract_numeric = function(x) {
  as.numeric(gsub("\\D", "", x))
}
igt_vec = igt_vec[order(extract_numeric(igt_vec))] %>% as.character()

tmp = umap_df[,grepl("ncells|immgent_IGT_10xlane_id", colnames(umap_df)) ]
tmp = tmp[,!grepl("CD4\\.|CD8\\.|CD8aa\\.|DN\\.|DP\\.|gdT\\.|nonconv\\.|thymocyte.y\\.|Treg\\.", colnames(tmp))]
umap_df_melt = melt(tmp[,grepl("ncells|immgent_IGT_10xlane_id", colnames(tmp)) ])

nclust = c()
for (s in 1:length(igt_vec)) {
    print(s)
    umap_df_melt2 = umap_df_melt[umap_df_melt$immgent_IGT_10xlane_id %in% igt_vec[1:s],] %>% group_by(variable) %>% summarize(ncells = sum(value)) %>% as.data.frame()
    nclust = c(nclust, sum(umap_df_melt2$ncells > 50))
}

df = data.frame(experiment_number = igt_vec, number_of_clusters = nclust)
df$experiment_number = factor(df$experiment_number, levels = igt_vec)

pdf(sprintf("%s/cluster_saturation.pdf", prefix), 15, 7,useDingbats = F)
ggplot(df) + geom_point(aes(experiment_number, number_of_clusters), size = 3) + 
    geom_line(aes(x = experiment_number, y = number_of_clusters, group = 1)) + 
    geom_hline(aes(yintercept = 113), linetype="dashed", color = "brown", linewidth = 1) +
    ylim(c(0,130)) + theme_bw() + theme(axis.text.x=element_text(size=10, angle = 30), axis.text.y=element_text(size=20), legend.text=element_text(size=15), axis.title.x = element_text(size=15) , axis.title.y = element_text(size=15), legend.title = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
dev.off()


```


**LIMMA**

lm with organ in healthy: ~ 0 + organ_simplified + IGT
very similar/almost same as ~ 0 + organ_simplified !

```{r}
prefix3 = "limma/organsimplified_Treg"
prefix3 = "limma/organsimplified_IGT_Treg"
ensure_directory(sprintf("%s/%s", prefix,prefix3))
ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdBu"))(100))

# mdata_orig = readRDS(file = sprintf("%s/annotation_level1_PropPerSample_withMetadata.Rds", prefix))
prefix = "SampleComp/20250224"
mdata_orig = readRDS(file = sprintf("%s/annotation_level2_PropPerSample_withMetadata.Rds", prefix))
mdata_orig$IGT_10xlane_id = NULL
mdata_orig$organism_id = NULL
mdata_orig$IGT = mdata_orig$immgent_IGT_10xlane_id
mdata_orig$immgent_IGT_10xlane_id = NULL
mdata_orig$HT = mdata_orig$hashtag_number
mdata_orig$hashtag_number = NULL
mdata_orig$sample_id = NULL
mdata_orig$count_unique = NULL
colnames(mdata_orig)

mdata0 = mdata_orig %>% select(matches("Treg.*ncells"), sample_name:last_col()) %>% filter(condition_broad == "healthy") %>% as.data.frame()
mdata = mdata0 %>% select(matches("ncells")) %>% mutate(totcells = rowSums(.)) %>% mutate(across(-totcells, ~ . / totcells, .names = "{.col}_prop"))
colnames(mdata) = gsub(pattern = "ncells_prop", replacement = "prop", colnames(mdata))
mdata = data.frame(mdata, mdata0 %>% select(sample_name:last_col()) %>% as.data.frame())
all(mdata$Treg_cl1.ncells == mdata0$Treg_cl1.ncells)
mdata = mdata %>% filter(totcells >= 10) %>% as.data.frame()

mdata$IGT = factor(mdata$IGT, levels = unique(mdata$IGT)[order(extract_numeric(unique(mdata$IGT)))])

mdata$organ_simplified = make.names(mdata$organ_simplified)
mdata$organ_simplified =  factor(mdata$organ_simplified, levels = names(which(!table( mdata$organ_simplified)==0)))


# Create the design matrix for the linear model
design = model.matrix(~ 0 + organ_simplified + IGT, data = mdata) #make sure no empty category! otherwise creates an error during fit
design = model.matrix(~ 0 + organ_simplified, data = mdata) #make sure no empty category! otherwise creates an error during fit
colnames(design) = gsub("organ_simplified", "", colnames(design))
colnames(design) = gsub("IGTIGT", "IGT", colnames(design))
# Select the columns that match "^F" in mdata (assuming these are numeric variables)
feature_data = t(mdata[, grepl("*prop", colnames(mdata))])
# Fit the linear model using limma
fit = lmFit(feature_data, design)
summary(fit)
saveRDS(fit, file = sprintf("%s/%s/fit.Rds",  prefix, prefix3))
# fit = readRDS(sprintf("%s/%s/fit.Rds",  prefix,prefix3))

#subset the metadata depending on the design above and wanted contrast, i.e. remove the confounding
# metadata = mdata %>% select(annotation_level2, IGTHT) %>% unique() (IGTT is the confounding)
metadata = mdata %>% select(organ_simplified) %>% unique()
rownames(metadata) = NULL
contrasts = c()
namescontrasts = c()
for (cl in levels(metadata$organ_simplified)) {
    print(cl)
    group1_filter <- expr(organ_simplified == cl)
    group2_filter <- expr(!(organ_simplified %in% cl))
    groups = GetGroups(metadata, group1_filter,group2_filter, "organ_simplified")
    nmecontrast = sprintf("%s_vs_AllinHealthy", cl)
    # nmecontrast = CreateComparisonName(group1_filter, group2_filter)
    
    # contrasts = c()
    # namescontrasts = c()
    # # i = 1
    group1 = groups[[1]]
    group2 = groups[[2]]
    contrasts[cl] = sprintf("(%s)/%s-(%s)/%s", paste(group1, collapse = "+"), length(group1), paste(group2, collapse = "+"), length(group2))
    namescontrasts[cl] = nmecontrast
    # names(contrasts) = namescontrasts
    # gene_symbol = rownames(tmm$E)#rownames(so[["RNA"]]$counts)
}

message("contrasts.fit...")
cont.matrix = makeContrasts( contrasts = contrasts, levels = design)
colnames(cont.matrix) = namescontrasts
# colnames(cont.matrix) = names(contrasts)
fit2 = contrasts.fit(fit, cont.matrix)
message("eBayes...")
fit2 = eBayes(fit2, trend = TRUE, robust = TRUE)
# saveRDS(fit2, sprintf("%s/%s/fit_contrast.Rds",  prefix3))
# fit2 = readRDS(sprintf("%s/%s/fit_contrast.Rds",  prefix3))

#write coefficients
results = topTable(fit2, number = Inf, sort.by = "none", adjust.method = "BH") #same as fit2$coefficients
write.table(results, file = sprintf("%s/%s/coefficients.csv",  prefix, prefix3), quote = F, row.names = T, col.names = T, sep = ",")

#Heatmap
# Extract p-values for all comparisons
pvmat = apply(fit2$p.value, 1, function(x) p.adjust(x, method = "BH"))
pvmat[is.na(pvmat)] = 1
pvmat = t(pvmat)
# extract_numeric(rownames(pvmat)) == extract_numeric(rownames(factor_means))
# extract_numeric(colnames(pvmat)) == extract_numeric(colnames(factor_means))
labels_matrix = pvmat
labels_matrix[pvmat<0.05] = "*"
labels_matrix[pvmat<0.01] = "**"
labels_matrix[pvmat<0.001] = "***"
labels_matrix[pvmat>0.05] = ""

pdf(sprintf("%s/%s/heatmap.pdf",  prefix, prefix3), 10,10, useDingbats = F)
pheatmap(fit2$coefficients, cluster_rows = F, cluster_cols = F, breaks = seq(-0.5,0.5,length.out = length(ColorRamp)+1), col = ColorRamp, display_numbers = labels_matrix, main = "fit2$coefficients")
pheatmap(fit2$coefficients, cluster_rows = T, cluster_cols = T, breaks = seq(-0.5,0.5,length.out = length(ColorRamp)+1), col = ColorRamp, display_numbers = labels_matrix, main = "fit2$coefficients")
dev.off()


#Write Tables and Volcanos
tt_list = list()
for (i in colnames(fit2$contrasts)) { #colnames(cont.matrix)
    print(i)
    tt_list[[i]] = topTable(fit2,coef = i ,n = Inf, adjust.method = "BH", sort.by = "none")
    tt_list[[i]]$SYMBOL = rownames(tt_list[[i]])
    # tt_list[[i]]$SYMBOL = gene_symbol
}

tmp = tt_list
names(tmp)

saveRDS(tt_list, file = sprintf("%s/%s/ttlist.Rds",  prefix,prefix3))
message("Results saved to: ", sprintf("%s/%s/ttlist.Rds",  prefix,prefix3))

pdf(sprintf("%s/%s/DiffExpression_volcanos.pdf",  prefix,prefix3), width = 10, height = 10)
for (i in 1:length(tmp)) {
    print(i)
    vplot = na.omit(data.frame(SYMBOL = tmp[[i]]$SYMBOL, fc = 2^tmp[[i]]$logFC, pval = tmp[[i]]$P.Value + 10^-300, AveExpr = 2^(tmp[[i]]$AveExpr))) #dealing with NA
    # vplot = data.frame(SYMBOL = tmp[[i]]$SYMBOL, fc = 2^tmp[[i]]$logFC, pval = tmp[[i]]$P.Value+10^-300, AveExpr = 2^(tmp[[i]]$AveExpr))
    p = Vplot(vplot = vplot, xlab = names(tmp)[i], xlimits = c(min(vplot$fc[vplot$fc != 0]), max(vplot$fc)), ylimits = c(min(vplot$pval), 1)) #c(min(vplot$pval[vplot$pval != 0]),1)
    sub = vplot %>%
        filter(pval < 0.05) %>% #abs(log2(fc)) > 0.5 & 
        arrange(desc(log2(fc))) %>%
        pull(SYMBOL)
    highlight_genes = unique(c(head(sub, 25), tail(sub, 25)))
    # sub = (log2(vplot$fc) > 0.5 | log2(vplot$fc) < -0.5)  & vplot$pval < 0.05
    # sub = vplot[sub,] %>% arrange(desc(log2(fc)))
    # sub1 = sub %>% pull(SYMBOL) %>% head(25) #vplot$SYMBOL %in% as.character(sub2$SYMBOL)[1:200]
    # sub2 = sub %>% pull(SYMBOL) %>% tail(25)
    highlight_filter = vplot$SYMBOL %in% highlight_genes
    # sub = vplot$SYMBOL %in% c(sub1, sub2)#as.character(sub2$SYMBOL)[1:50]
    library(ggrepel)
    print(p + geom_text_repel(data = vplot[highlight_filter,], aes(x = fc, y = pval, label = SYMBOL)))
    # print(p + geom_text(data = vplot[highlight_filter,], aes(x = fc, y = pval, label = SYMBOL)))
}
dev.off()
message("Plots saved to: ", sprintf("%s/%s/DiffExpression_volcanos.pdf",  prefix,prefix3))

if (length(tt_list) > 1) {
    tt = CollapseDiff_limmatrend(tt_list)
} else {
    tt = tt_list[[1]]
}
tt$SYMBOL = rownames(tt)
colnames(tt) = gsub(pattern = "AveExpr", replacement = "log2AveExpr", colnames(tt))
colnames(tt) = gsub(pattern = "logFC", replacement = "log2FC", colnames(tt))
tt = data.frame(SYMBOL = tt$SYMBOL, tt[,!colnames(tt) %in% "SYMBOL"])
write.table(x = tt, file = sprintf("%s/%s/ttlist.txt",  prefix,prefix3), sep = "\t", quote = F)
message("Table saved to: ", sprintf("%s/%s/ttlist.txt",  prefix,prefix3))

```

lm with ~ 0 + organ_simplified + condition_detailed + IGT
```{r}
prefix3 = "limma/organsimplified_condition_detailed_IGT_Treg"
ensure_directory(sprintf("%s/%s", prefix,prefix3))
ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdBu"))(100))

# mdata_orig = readRDS(file = sprintf("%s/annotation_level1_PropPerSample_withMetadata.Rds", prefix))
prefix = "SampleComp/20250224"
mdata_orig = readRDS(file = sprintf("%s/annotation_level2_PropPerSample_withMetadata.Rds", prefix))
mdata_orig$IGT_10xlane_id = NULL
mdata_orig$organism_id = NULL
mdata_orig$IGT = mdata_orig$immgent_IGT_10xlane_id
mdata_orig$immgent_IGT_10xlane_id = NULL
mdata_orig$HT = mdata_orig$hashtag_number
mdata_orig$hashtag_number = NULL
mdata_orig$sample_id = NULL
mdata_orig$count_unique = NULL
colnames(mdata_orig)

mdata0 = mdata_orig %>% select(matches("Treg.*ncells"), sample_name:last_col()) %>% as.data.frame()
mdata = mdata0 %>% select(matches("ncells")) %>% mutate(totcells = rowSums(.)) %>% mutate(across(-totcells, ~ . / totcells, .names = "{.col}_prop"))
colnames(mdata) = gsub(pattern = "ncells_prop", replacement = "prop", colnames(mdata))
mdata = data.frame(mdata, mdata0 %>% select(sample_name:last_col()) %>% as.data.frame())
all(mdata$Treg_cl1.ncells == mdata0$Treg_cl1.ncells)
mdata = mdata %>% filter(totcells >= 10) %>% as.data.frame()
dim(mdata)

mdata$IGT = factor(mdata$IGT, levels = unique(mdata$IGT)[order(extract_numeric(unique(mdata$IGT)))])

mdata$organ_simplified = make.names(mdata$organ_simplified)
mdata$organ_simplified =  factor(mdata$organ_simplified, levels = names(which(!table( mdata$organ_simplified)==0)))

mdata$condition_detailed[mdata$condition_detailed == ""] = "baseline"
mdata$condition_detailed = make.names(mdata$condition_detailed)
mdata$condition_detailed =  factor(mdata$condition_detailed, levels = names(which(!table( mdata$condition_detailed)==0)))

# Create the design matrix for the linear model
design = model.matrix(~ 0 + organ_simplified + condition_detailed + IGT, data = mdata) #make sure no empty category! otherwise creates an error during fit
colnames(design) = gsub("organ_simplified|condition_detailed", "", colnames(design))
colnames(design) = gsub("IGTIGT", "IGT", colnames(design))
# Select the columns that match "^F" in mdata (assuming these are numeric variables)
feature_data = t(mdata[, grepl("*prop", colnames(mdata))])
# Fit the linear model using limma
fit = lmFit(feature_data, design)
saveRDS(fit, file = sprintf("%s/%s/fit.Rds",  prefix, prefix3))
# fit = readRDS(sprintf("%s/%s/fit.Rds",  prefix,prefix3))

#subset the metadata depending on the design above and wanted contrast, i.e. remove the confounding
# metadata = mdata %>% select(annotation_level2, IGTHT) %>% unique() (IGTT is the confounding)
metadata = mdata %>% filter(condition_detailed == "baseline") %>% select(organ_simplified) %>% unique()
rownames(metadata) = NULL
contrasts = c()
namescontrasts = c()
for (cl in sort(unique(metadata$organ_simplified))) {
    print(cl)
    group1_filter <- expr(organ_simplified == cl)
    group2_filter <- expr(!(organ_simplified %in% cl))
    groups = GetGroups(metadata, group1_filter,group2_filter, "organ_simplified")
    nmecontrast = sprintf("%s_vs_AllinHealthy", cl)
    # nmecontrast = CreateComparisonName(group1_filter, group2_filter)
    
    # contrasts = c()
    # namescontrasts = c()
    # # i = 1
    group1 = groups[[1]]
    group2 = groups[[2]]
    contrasts[cl] = sprintf("(%s)/%s-(%s)/%s", paste(group1, collapse = "+"), length(group1), paste(group2, collapse = "+"), length(group2))
    namescontrasts[cl] = nmecontrast
    # names(contrasts) = namescontrasts
    # gene_symbol = rownames(tmm$E)#rownames(so[["RNA"]]$counts)
}

metadata = mdata %>% filter(organ_simplified == "colon") %>% select(condition_detailed) %>% unique()
rownames(metadata) = NULL
contrasts = c()
namescontrasts = c()
for (cl in sort(unique(metadata$condition_detailed))) {
    print(cl)
    group1_filter <- expr(condition_detailed == cl)
    group2_filter <- expr(!(condition_detailed %in% cl))
    groups = GetGroups(metadata, group1_filter,group2_filter, "condition_detailed")
    nmecontrast = sprintf("%s_vs_AllinColon", cl)
    # nmecontrast = CreateComparisonName(group1_filter, group2_filter)
    
    # contrasts = c()
    # namescontrasts = c()
    # # i = 1
    group1 = groups[[1]]
    group2 = groups[[2]]
    contrasts[cl] = sprintf("(%s)/%s-(%s)/%s", paste(group1, collapse = "+"), length(group1), paste(group2, collapse = "+"), length(group2))
    namescontrasts[cl] = nmecontrast
    # names(contrasts) = namescontrasts
    # gene_symbol = rownames(tmm$E)#rownames(so[["RNA"]]$counts)
}

metadata = mdata %>% filter(organ_simplified == "lung") %>% select(condition_detailed) %>% unique()
rownames(metadata) = NULL
contrasts = c()
namescontrasts = c()
for (cl in sort(unique(metadata$condition_detailed))) {
    print(cl)
    group1_filter <- expr(condition_detailed == cl)
    group2_filter <- expr(!(condition_detailed %in% cl))
    groups = GetGroups(metadata, group1_filter,group2_filter, "condition_detailed")
    nmecontrast = sprintf("%s_vs_AllinLung", cl)
    # nmecontrast = CreateComparisonName(group1_filter, group2_filter)
    
    # contrasts = c()
    # namescontrasts = c()
    # # i = 1
    group1 = groups[[1]]
    group2 = groups[[2]]
    contrasts[cl] = sprintf("(%s)/%s-(%s)/%s", paste(group1, collapse = "+"), length(group1), paste(group2, collapse = "+"), length(group2))
    namescontrasts[cl] = nmecontrast
    # names(contrasts) = namescontrasts
    # gene_symbol = rownames(tmm$E)#rownames(so[["RNA"]]$counts)
}



message("contrasts.fit...")
cont.matrix = makeContrasts( contrasts = contrasts, levels = design)
colnames(cont.matrix) = namescontrasts
# colnames(cont.matrix) = names(contrasts)
fit2 = contrasts.fit(fit, cont.matrix)
message("eBayes...")
fit2 = eBayes(fit2, trend = TRUE, robust = TRUE)
# saveRDS(fit2, sprintf("%s/%s/fit_contrast.Rds",  prefix3))
# fit2 = readRDS(sprintf("%s/%s/fit_contrast.Rds",  prefix3))

#write coefficients
results = topTable(fit2, number = Inf, sort.by = "none", adjust.method = "BH") #same as fit2$coefficients
write.table(results, file = sprintf("%s/%s/coefficients.csv",  prefix, prefix3), quote = F, row.names = T, col.names = T, sep = ",")

#Heatmap
# Extract p-values for all comparisons
pvmat = apply(fit2$p.value, 1, function(x) p.adjust(x, method = "BH"))
pvmat[is.na(pvmat)] = 1
pvmat = t(pvmat)
# extract_numeric(rownames(pvmat)) == extract_numeric(rownames(factor_means))
# extract_numeric(colnames(pvmat)) == extract_numeric(colnames(factor_means))
labels_matrix = pvmat
labels_matrix[pvmat<0.05] = "*"
labels_matrix[pvmat<0.01] = "**"
labels_matrix[pvmat<0.001] = "***"
labels_matrix[pvmat>0.05] = ""

pdf(sprintf("%s/%s/heatmap.pdf",  prefix, prefix3), 10,10, useDingbats = F)
pheatmap(fit2$coefficients, cluster_rows = F, cluster_cols = F, breaks = seq(-0.5,0.5,length.out = length(ColorRamp)+1), col = ColorRamp, display_numbers = labels_matrix, main = "fit2$coefficients")
pheatmap(fit2$coefficients, cluster_rows = T, cluster_cols = T, breaks = seq(-0.5,0.5,length.out = length(ColorRamp)+1), col = ColorRamp, display_numbers = labels_matrix, main = "fit2$coefficients")
dev.off()


#Write Tables and Volcanos
tt_list = list()
for (i in colnames(fit2$contrasts)) { #colnames(cont.matrix)
    print(i)
    tt_list[[i]] = topTable(fit2,coef = i ,n = Inf, adjust.method = "BH", sort.by = "none")
    tt_list[[i]]$SYMBOL = rownames(tt_list[[i]])
    # tt_list[[i]]$SYMBOL = gene_symbol
}

tmp = tt_list
names(tmp)

saveRDS(tt_list, file = sprintf("%s/%s/ttlist.Rds",  prefix,prefix3))
message("Results saved to: ", sprintf("%s/%s/ttlist.Rds",  prefix,prefix3))

pdf(sprintf("%s/%s/DiffExpression_volcanos.pdf",  prefix,prefix3), width = 10, height = 10)
for (i in 1:length(tmp)) {
    print(i)
    vplot = na.omit(data.frame(SYMBOL = tmp[[i]]$SYMBOL, fc = 2^tmp[[i]]$logFC, pval = tmp[[i]]$P.Value + 10^-300, AveExpr = 2^(tmp[[i]]$AveExpr))) #dealing with NA
    # vplot = data.frame(SYMBOL = tmp[[i]]$SYMBOL, fc = 2^tmp[[i]]$logFC, pval = tmp[[i]]$P.Value+10^-300, AveExpr = 2^(tmp[[i]]$AveExpr))
    p = Vplot(vplot = vplot, xlab = names(tmp)[i], xlimits = c(min(vplot$fc[vplot$fc != 0]), max(vplot$fc)), ylimits = c(min(vplot$pval), 1)) #c(min(vplot$pval[vplot$pval != 0]),1)
    sub = vplot %>%
        filter(pval < 0.05) %>% #abs(log2(fc)) > 0.5 & 
        arrange(desc(log2(fc))) %>%
        pull(SYMBOL)
    highlight_genes = unique(c(head(sub, 25), tail(sub, 25)))
    # sub = (log2(vplot$fc) > 0.5 | log2(vplot$fc) < -0.5)  & vplot$pval < 0.05
    # sub = vplot[sub,] %>% arrange(desc(log2(fc)))
    # sub1 = sub %>% pull(SYMBOL) %>% head(25) #vplot$SYMBOL %in% as.character(sub2$SYMBOL)[1:200]
    # sub2 = sub %>% pull(SYMBOL) %>% tail(25)
    highlight_filter = vplot$SYMBOL %in% highlight_genes
    # sub = vplot$SYMBOL %in% c(sub1, sub2)#as.character(sub2$SYMBOL)[1:50]
    library(ggrepel)
    print(p + geom_text_repel(data = vplot[highlight_filter,], aes(x = fc, y = pval, label = SYMBOL)))
    # print(p + geom_text(data = vplot[highlight_filter,], aes(x = fc, y = pval, label = SYMBOL)))
}
dev.off()
message("Plots saved to: ", sprintf("%s/%s/DiffExpression_volcanos.pdf",  prefix,prefix3))

if (length(tt_list) > 1) {
    tt = CollapseDiff_limmatrend(tt_list)
} else {
    tt = tt_list[[1]]
}
tt$SYMBOL = rownames(tt)
colnames(tt) = gsub(pattern = "AveExpr", replacement = "log2AveExpr", colnames(tt))
colnames(tt) = gsub(pattern = "logFC", replacement = "log2FC", colnames(tt))
tt = data.frame(SYMBOL = tt$SYMBOL, tt[,!colnames(tt) %in% "SYMBOL"])
write.table(x = tt, file = sprintf("%s/%s/ttlist.txt",  prefix,prefix3), sep = "\t", quote = F)
message("Table saved to: ", sprintf("%s/%s/ttlist.txt",  prefix,prefix3))

```




To do later?
```{r}
##2. Composition of each organ 
df = data.frame(cluster = factor(sprintf("cl%s",so@meta.data[,res]), levels = sprintf("cl%s",as.character(c(0:(length(unique(so@meta.data[,res]))-1))))), 
                sample = factor(so$organ, levels = sort(unique(so$organ))) )
tmp = table(df$cluster, df$sample)
tmp2 = t(t(tmp) / colSums(tmp)) # normalize the number of cells per sample
colSums(tmp2)
tmp3 = tmp2
rowSums(tmp3)
tmp4 = melt(tmp3)
head(tmp4)
tmp4$sample = df$sample[match(tmp4$Var2, df$sample)]

pdf(file = sprintf("%s_OrganComposition_%s.pdf", prefix, res), width =30, height =20)
ColorRamp = rev(viridis(100))
tmp3[tmp3==0] = NA
labels_matrix = ifelse(is.na(tmp3), yes = "", no = as.character(signif(tmp3,2)*100))
#labels_matrix = matrix(labels_matrix, nrow(data_matrix), ncol(data_matrix))
pheatmap(mat = signif(tmp3,2)*100, cluster_rows = F, cluster_cols = F, display_numbers = labels_matrix, number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), col = ColorRamp, fontsize_row = 10, fontsize_col = 10, fontsize = 15, main = "Percent of cells in each IGT", na_col = "#FDE725")

ggplot(tmp4) + geom_jitter(aes(Var1, value, color = sample), position = position_jitter(width = 0.2), size = I(5), alpha = 0.7) + scale_color_manual(values = mypal) + scale_y_continuous(trans = log_trans(), breaks = c(0.01, 0.05, seq(0.1, 1, by = 0.1)) , labels =  c( 0.01, 0.05, seq(0.1, 1, by = 0.1))) + theme_bw()+ ggtitle(label = "Cluster composition in each organ") + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10))

ggplot(tmp4, aes(Var1, value)) + geom_boxplot(aes(fill = sample, group = Var1), outlier.alpha = 0 ) + 
    geom_jitter(aes(Var1, value, color = sample), position = position_jitter(width = 0.2), size = I(5), alpha = 0.7) +
    scale_color_manual(values = mypal) +
    scale_y_continuous(trans = log_trans(), breaks = c(0.01, 0.05, seq(0.1, 1, by = 0.1)) , labels =  c( 0.01, 0.05, seq(0.1, 1, by = 0.1))) + 
    theme_bw()+ ggtitle(label = "Cluster composition in each  organ") + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10))

ggplot(tmp4, aes(Var1, value)) + geom_boxplot(aes(fill = sample, group = Var1), outlier.alpha = 0) + 
    geom_jitter(aes(Var1, value, color = sample), position = position_jitter(width = 0.2), size = I(5), alpha = 0.7) +
    scale_color_manual(values = mypal) +
    theme_bw()+ ggtitle(label = "Cluster composition in each  organ") + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10))


ggplot(tmp4) + geom_point(aes(Var1, value, color = sample), size = I(3), alpha = 0.7) + scale_color_manual(values = mypal) + scale_y_continuous(trans = log_trans(), breaks = c(0.01, 0.05, seq(0.1, 1, by = 0.1)) , labels =  c( 0.01, 0.05, seq(0.1, 1, by = 0.1))) + theme_bw()+ ggtitle(label = "Cluster composition in each organ") + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10)) + facet_wrap(~sample)  + NoLegend()

ggplot(tmp4) + geom_point(aes(Var1, value, color = sample), size = I(3), alpha = 0.7) + scale_color_manual(values = mypal) + theme_bw()+ ggtitle(label = "Cluster composition in each organ") + theme(axis.text.x  = element_text(angle=75, vjust=0.5, size=10)) + facet_wrap(~sample) + NoLegend()

dev.off()


```


