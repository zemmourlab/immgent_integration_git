---
title: "mrVI_analysis"
output: html_document
date: "2024-03-27"
---

**Start interactive session on Midway3**
```{bash}
ssh -Y zemmour@midway3.rcc.uchicago.edu
sinfo -s
screen -S david
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=jfkfloor2 --qos=jfkfloor2 --nodes=1 
sinteractive --time=12:00:00 --account=pi-zemmour --partition=caslake --nodes=1 --mem=128GB
sinteractive --time=3:00:00 --account=pi-zemmour --partition=gpu --gres=gpu:1 --mem=96GB
sinteractive --time=3:00:00 --account=pi-zemmour --partition=beagle3 --gres=gpu:1 --mem=96GB
cd $LABHOME

module load python/anaconda-2022.05 
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13
#module load cuda/12.2

#sinteractive --time=1:00:00 -p gpu --gres=gpu:1 --account=pi-zemmour 

#source activate /project/jfkfloor2/zemmourlab/david/envs/scvi
#source activate /project/zemmour/david/envs/scvi113_20240525 #works but error saving the model, pickle error
source activate /project/zemmour/david/envs/mrvi_test5 #torch worjks but scvi not, jax error
module load openblas/0.3.13 #load again or error

cd /project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/Treg
#cd ~/google_drive/ImmgenT/analysis/data_integration/IGT1_56/Treg

#R
#options(max.print=1000)
#options(Seurat.object.assay.version = 'v5')
```


https://docs.scvi-tools.org/en/latest/tutorials/notebooks/scrna/MrVI_tutorial.html
installation: see install_scvi.Rmd

Import libraries

```{python}
import warnings; warnings.simplefilter('ignore')

import os
import tempfile

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
import scanpy as sc
import mudata as mu
# import seaborn as sns
import scvi
from scvi.external import MRVI
import torch
import pymde
import pickle

scvi.__version__
torch.cuda.is_available()
scvi.settings.seed = 0  # optional: ensures reproducibility

```

```{python}
os.chdir("/project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/Treg")
prefix="mrvi_igt1_56_Treg_20240525_sampleiddavid_IGT"
prefix="mrvi_igt1_56_Treg_20240525_sampleiddavid_IGT_test3"
```


Load data
```{python}
mdata = mu.read("totalvi_igt1_56_allgenes_Treg_20240306/adata.h5mu")

```

Add metadata
CAREFUL SPLEEN control are not in the Sample_metadata_david_20240324_v3.csv, so lots of NA for them
```{python}
m = pd.read_csv('/project/jfkfloor2/zemmourlab/david/immgent/analysis/integration/IGT1_56/Sample_metadata_david_20240324_v3.csv')
#m
m['sample_id'] = m['immgent_IGT_10xlane_id'].astype(str) + '.' + m['hashtag_number'].astype(str)
mdata.mod['RNA'].obs['sample_id'] = mdata.mod['RNA'].obs['IGT'].astype(str) + '.' + mdata.mod['RNA'].obs['hashtag_number'].astype(str)
meta = mdata.mod['RNA'].obs

cols_to_keep = ['sample_id', 'hashtag_number'] + list(set(meta.columns) - set(m.columns))
meta = meta[cols_to_keep]
m2 = pd.merge(meta, m, on='sample_id', how='left')
m2.shape
m2[m2['exp_number'].isna()].shape
#print(m2[m2['exp_number'].isna()]['sample_id']) 
#print(m2[m2['exp_number'].isna()]['is_spleen_standard']) 
m2[m2['exp_number'].isna()]['organ'] = 'spleen'
m2[m2['exp_number'].isna()]['condition_broad'] = 'healthy'

(m2['colnames'].values == mdata.mod['RNA'].obs.index.to_list()).all()
#set(m2['colnames']) == set(mdata.mod['RNA'].obs.index)
m2.index = m2['colnames']
m2 = m2.reindex(mdata.mod['RNA'].obs.index, axis=0)
(m2['colnames'].values == mdata.mod['RNA'].obs.index.to_list()).all()

mdata.mod['RNA'].obs = m2

#simplify the organ columns
mdata.mod["RNA"].obs["organ_simplified"] = mdata.mod['RNA'].obs['organ']
list(mdata.mod["RNA"].obs["organ_simplified"].unique())
mdata.mod["RNA"].obs["organ_simplified"] = mdata.mod["RNA"].obs["organ_simplified"].astype('object')
list(mdata.mod["RNA"].obs["organ_simplified"].unique())
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ'].str.contains('lymph node|LN', na=False, case=False), 'organ_simplified'] = 'lymph node'
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ'].str.contains('skin', na=False, case=False), 'organ_simplified'] = 'skin'
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ'].str.contains('colon', na=False, case=False), 'organ_simplified'] = 'colon'
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ'].str.contains('duoden|ileal|ileum|jejun|small intestine', na=False, case=False), 'organ_simplified'] = 'small intestine'
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ_simplified'].isna(), 'organ_simplified'] = 'spleen'
mdata.mod['RNA'].obs.loc[mdata.mod['RNA'].obs['organ_simplified'].isna(), 'condition_broad'] = 'healthy'
mdata.mod["RNA"].obs["organ_simplified"] = mdata.mod["RNA"].obs["organ_simplified"].str.replace('[^0-9a-zA-Z]', '.', regex=True)
list(mdata.mod["RNA"].obs["organ_simplified"].unique())
mdata.mod["RNA"].obs["organ_simplified"] = mdata.mod["RNA"].obs["organ_simplified"].astype('category')

for mod_key in mdata.mod.keys():
    # Convert all columns in .obs to string type to avoid error in writing
    mdata.mod[mod_key].obs = mdata.mod[mod_key].obs.astype(str)
    
sample_id_equal = mdata.mod['RNA'].obs["sample_id"].values == mdata.mod['RNA'].obs["sample_id_david"].values
false_indices = np.where(sample_id_equal == False)[0]
different_rows = mdata.mod['RNA'].obs.iloc[false_indices]
print(different_rows[['sample_id', 'sample_id_david']])
del mdata.mod['RNA'].obs["sample_id_david"]
    
```

from mudata to adata
```{python}
adata = mdata.mod['RNA']
adata.obs['sample_id']

```

Fit MRVI model
```{python}
sample_key = "sample_id"  # target covariate
batch_key="IGT" # nuisance variable identifier
MRVI.setup_anndata(adata, sample_key=sample_key, batch_key = batch_key)
model = MRVI(adata)
model.train(max_epochs=2)
model.save(prefix, save_anndata=True)

plt.plot(model.history["elbo_validation"].iloc[5:])
plt.xlabel("Epoch")
plt.ylabel("Validation ELBO")
plt.show()
```

Save latent dims U and Z
```{python}
u = model.get_latent_representation()
latent_df = pd.DataFrame(u, index = adata.obs.index)
latent_df.to_csv(prefix+"/latent_u.csv", index=True)
z = model.get_latent_representation(give_z=True) #to get z instead of u
latent_df = pd.DataFrame(z, index = adata.obs.index)
latent_df.to_csv(prefix+"/latent_z.csv", index=True)

sc.pp.neighbors(pancreas_ref, use_rep=SCVI_LATENT_KEY)
sc.tl.leiden(pancreas_ref)
sc.tl.umap(pancreas_ref)


u_mde = scvi.model.utils.mde(u)
adata.obsm["u_mde"] = u_mde
sc.pl.embedding(
    adata,
    basis="u_mde",
    color=["cell_type", "organ_simplified","condition_broad"],
    ncols=1,
    save="u_plot.pdf"
)

z_mde = scvi.model.utils.mde(z)
adata.obsm["z_mde"] = z_mde
sc.pl.embedding(
    adata,
    basis="z_mde",
    color=["cell_type", "organ_simplified","condition_broad"],
    ncols=1,
    save="z_plot.pdf"
)


```


