---
title: "cometsc_CD4"
output: html_document
date: "2025-01-09"
editor_options: 
  chunk_output_type: console
---

Continuation from clustering_CD4_igt_1_96.Rmd

```{bash}
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=jfkfloor2 --qos=jfkfloor2 --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=zemmour-hm --qos=zemmour --nodes=1 

module load python/anaconda-2022.05 
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13
source activate /project/zemmour/david/envs/scvi_20240315
module load openblas/0.3.13

cd /project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD4
R
```

```{r}
libs = c("Seurat", "ggplot2", "dplyr","scattermore", "ggrastr", "RColorBrewer", "pals", "scales", "reshape2", "pheatmap") 
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))
options(Seurat.object.assay.version = 'v5')
source("/project/jfkfloor2/zemmourlab/david/immgent/immgent_integration_git/custom_functions_david.R")
source("/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/analysis/immgent_integration_git/custom_functions_david.R")

ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
ColorRamp = rev(rainbow(10, end = 4/6))
ColorRamp = viridis(100)
ColorRamp = brewer.pal(9, "Blues")

#mycol = c("black","blue","red","darkgreen", "orange","purple", "cyan", "greenyellow",    "salmon", "magenta","pink", "tan", "brown") # c("magenta", "red",  "darkgreen", "cyan", "blue", "blue", "blue", "black", "blue", "blue", "blue", "blue", "orange")

#Large Color palette
library("pals")
n = 70
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
mypal1 = unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals))))
mypal1 = mypal1[-4]
mypal = c(glasbey(), polychrome(), mypal1)
names(mypal) = NULL
#pal.bands(mypal, main="Colormap suggestions")
mypal_organ = setNames(mypal, unique(so$organ_simplified))
mypal_organ = mypal_organ[!is.na(names(mypal_organ))]
mypal_level1 = setNames(mypal, unique(so$annotation_level1))
mypal_level1 = mypal_level1[!is.na(names(mypal_level1))]
mypal_level2 = setNames(mypal, unique(so$annotation_level2))
mypal_level2 = mypal_level2[!is.na(names(mypal_level2))]
mypal_level2["CD4_cl18"] = "blue"
mypal_igt = setNames(mypal, unique(so$IGT))
mypal_igt = mypal_igt[!is.na(names(mypal_igt))]


```

Functions already in custom_functions_david.R
```{r}
MyFeatureScatter = function(so = so, assay = "ADT", slot = "data", feature1 = feature1, feature2 = feature2, group.by = sprintf("is_%s", cl), split.by = NULL, raster = T) {
    require(scattermore)
    df = data.frame(feature1 = so[[assay]][slot][feature1,],feature2 = so[[assay]][slot][feature2,], group.by = so@meta.data[,group.by])
    df$split.by = so@meta.data[,split.by]
    df2 = df[df$group.by == T,]
    df2$density = densCols(df2$feature1, df2$feature2, colramp = colorRampPalette(rev(rainbow(10, end = 4/6))), nbin = 500)
    
    p1 = ggplot(df) + geom_scattermore(aes(feature1, feature2), color = "grey", pixels = c(512, 512)) 
    # p1 = ggplot(df) + geom_point(aes(feature1, feature2), color = "grey") 
    if (raster == T ){
        p2 = geom_scattermore(data = df2, aes(feature1, feature2, color = density),  pixels = c(216, 216)) 
    } else {
        p2 = geom_point(data = df2, aes(feature1, feature2, color = density)) 
    }
    if(is.null(split.by)) {
        p3 = p1 + p2 + xlab(feature1) + ylab(feature2) +scale_colour_identity()+  theme_bw() + theme(axis.text.x=element_text(size=15), axis.text.y=element_text(size=15), legend.text=element_text(size=10), axis.title.x = element_text(size=20) , axis.title.y = element_text(size=20), legend.title = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
    } else {
        p3 = p1 + p2 + xlab(feature1) + ylab(feature2) +scale_colour_identity()+  theme_bw() + theme(axis.text.x=element_text(size=15), axis.text.y=element_text(size=15), legend.text=element_text(size=10), axis.title.x = element_text(size=20) , axis.title.y = element_text(size=20), legend.title = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + facet_wrap(~split.by)
    }
    return(p3)
}

TpTnFpFn = function(x = colnames(so) %in% gate_list[["cl2"]], y = so$is_cl2) { 
    tmp = table(x,y)
    #rownames(tmp) = c("gate_neg", "gate_pos")
    #colnames(tmp) = c("notcluster", "cluster")
    tp = tmp["TRUE","TRUE"]
    tn = tmp["FALSE","FALSE"]
    fp = tmp["TRUE","FALSE"]
    fn = tmp["FALSE","TRUE"]
    return(c(tp = tp, tn = tn, fp=fp, fn=fn))
}

SeSpPPVNPV = function(tp = tmp["tp"], tn = tmp["tn"], fp=tmp["fp"], fn=tmp["fn"]) {
    se = tp / (tp+fn)
    sp = tn / (fp+tn)
    ppv = tp / (tp+fp)
    npv = tn / (tn+fn)
    res = c(se, sp, ppv, npv)
    names(res) =  c("se", "sp", "ppv", "npv")
    return(res)
}


```


Prefix
```{r}
prefix = "cometsc/20250109"
reduc = "mde_incremental"
clusters = "annotation_level2"
```

**Prepare the data**

Filter the data:
remove data without CITEseq: "IGT7"  "IGT8"  "IGT9"  "IGT44" "IGT45" "IGT46" "IGT73" "IGT85" "IGT90" "IGT91" "IGT92"
Remove IGT1: CITEseq V1
Remove IGT90: CD45.1/2 only, not the panel
remove protein with less than 1000 rowSums, except TCRVA11.1-TCRVA11.2
--> cometsc/20250109/igt1_96_CD4_filteredforCometsc.Rds

```{r}
so = readRDS("igt1_96_CD4_20250109.Rds")
library(reshape2)
library(pheatmap)
so_orig = so

#remove IGT without CITEseq:
table(so$cite_seq, so$IGT)
so = so[,so$cite_seq == T]
so = so[,!so$IGT %in% c("IGT1")]

#remove IGT with less than 50 cells
so = so[,so$IGT %in% names(which(table(so$IGT) >50))]
table(so$cite_seq, so$IGT)
so$IGT = factor(so$IGT, levels = names(which(table(so$IGT) >0)))

adt = so[["ADT"]]$counts
tmp = as.data.frame(t(as.matrix(adt)))
tmp$IGT = so$IGT

tmp2 = melt(tmp)
tmp2 = tmp2 %>% group_by(IGT, variable) %>% summarise(sum(value))
tmp2 = dcast(tmp2, variable ~ IGT)
rownames(tmp2) = tmp2[,1]
tmp2 = tmp2[,-1]
pdf(sprintf("%s/dataprep_ADT_pre_post.pdf", prefix), 10,15)
pheatmap(log10(tmp2+1), cluster_rows = T, cluster_cols = F, main = "Sum ADT per IGT")


#Remove ADT with no signal
adt = so[["ADT"]]$counts
hist(log10(rowSums(adt)+1))
remove_adt = setdiff(names(which(rowSums(adt) < 100)), c("TCRVA11.1-TCRVA11.2"))

#remake seurat object without those
adt = adt[!rownames(adt) %in% remove_adt,]
so[["ADT"]] = NULL
so[["ADT"]] = CreateAssayObject(counts = adt)

#CLR normlization
so = NormalizeData(so, assay = "ADT", normalization.method = "CLR")
adt = so[["ADT"]]$data
tmp = as.data.frame(t(as.matrix(adt)))
tmp$IGT = so$IGT
tmp2 = melt(tmp)
tmp2 = tmp2 %>% group_by(IGT, variable) %>% summarise(mean(value))
tmp2 = dcast(tmp2, variable ~ IGT)
rownames(tmp2) = tmp2[,1]
tmp2 = tmp2[,-1]
#tmp2 = apply(tmp2,1, as.numeric)
pheatmap(log10(tmp2+1), cluster_rows = T, cluster_cols = F, main = "Mean CLR ADT per IGT")
dev.off()

saveRDS(so, sprintf("%s/igt1_96_CD4_filteredforCometsc.Rds", prefix))

```

Heatmap Clusters ADT
```{r}
so = readRDS(sprintf("%s/igt1_96_CD4_filteredforCometsc.Rds", prefix))

so = NormalizeData(so, assay = "ADT", normalization.method = "CLR")
adt = so[["ADT"]]$data
tmp = as.data.frame(t(as.matrix(adt)))
tmp[,clusters] = so[[clusters]]
tmp2 = melt(tmp)
tmp2 = tmp2 %>% group_by(!!sym(clusters), variable) %>% summarise(mean(value)) 
tmp2 = dcast(tmp2, as.formula(paste("variable ~", clusters)))
rownames(tmp2) = tmp2[,1]
tmp2 = tmp2[,-1]
#tmp2 = apply(tmp2,1, as.numeric)
pdf(sprintf("%s/heatmap_ADT_clusters.pdf", prefix), 10,15)
pheatmap(log10(tmp2+1), cluster_rows = F, cluster_cols = F, main = "Mean CLR ADT per clusters")
pheatmap(log10(tmp2+1), cluster_rows = T, cluster_cols = T, main = "Mean CLR ADT per clusters")
pheatmap(log10(tmp2+1), cluster_rows = T, cluster_cols = F, main = "Mean CLR ADT per clusters")
dev.off()


```

export data for cometsc
tabmarker.txt tabvis.txt tabcluster.txt
```{r}
so = readRDS(sprintf("%s/igt1_96_CD4_filteredforCometsc.Rds", prefix))

#Sample cells so that no more than 2000 cells per cluster
sample_cells = so@meta.data %>%
  group_by(!!sym(clusters)) %>%
  sample_n(size = min(2000, n()), replace = FALSE) %>%
    pull(colnames)

so = so[,sample_cells]
table(so[[clusters]])

so = NormalizeData(so, assay = "ADT", normalization.method = "CLR")
adt = as.matrix(so[["ADT"]]$data)
write.table(adt, file = sprintf("%s/input_data.txt",prefix), sep = "\t", row.names = T, col.names = T, quote = F)

so = NormalizeData(so, assay = "ADT", normalization.method = "LogNormalize")
adt = as.matrix(so[["ADT"]]$data)
write.table(adt, file = sprintf("%s/input_data_log.txt",prefix), sep = "\t", row.names = T, col.names = T, quote = F)

vis = so[[reduc]]@cell.embeddings
write.table(vis, file = sprintf("%s/input_umap.txt",prefix), sep = "\t", row.names = T, col.names = F, quote = F)

clusters = data.frame(cell_id = colnames(so), clusters = so[[clusters]])
write.table(clusters, file = sprintf("%s/input_clusters.txt",prefix), sep = "\t", row.names = F, col.names = F, quote = F)

protein_list = rownames(so[["ADT"]])
write.table(protein_list, file = sprintf("%s/input_markers.txt",prefix), sep = "\t", row.names = F, col.names = F, quote = F)
```

**Run COMETSC**
Comet tabmarker.txt tabvis.txt tabcluster.txt output/ -skipvis True

```{bash}
#!/bin/bash
#SBATCH -A pi-zemmour ##SBATCH -q jfkfloor2 --exclusive 
#SBATCH --partition=caslake 
#SBATCH --nodes=1 
#SBATCH --mem=96GB
#SBATCH -J cometsc_%j            
#SBATCH -o cometsc_%j.log
#SBATCH -t 24:00:00              ##SBATCH --mem=8G
#SBATCH --mail-type=ALL         # Type of email notification- BEGIN,END,FAIL,ALL ; 
#SBATCH --mail-user=zemmour@rcc.uchicago.edu   # Email to which notifications will be sent

#run as: sbatch $SCRIPT_DIR/cometsc_wrapper_20250109_CD4.sh

module load python/anaconda-2022.05 
source $(conda info --base)/etc/profile.d/conda.sh
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13
source activate /project/zemmour/david/envs/cometsc #torch worjks but scvi not, jax error
module load openblas/0.3.13 #load again or error


SCRIPT_DIR=/project/jfkfloor2/zemmourlab/david/immgent/immgent_integration_git
path_to_wd=/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD4/cometsc/20250109

cd $path_to_wd

Comet input_data_log.txt input_umap.txt input_clusters.txt k2_log -C 36 -K 2

Comet input_data.txt input_umap.txt input_clusters.txt k2 -C 36 -K 2 # -C is for cores, -K is the number of gene combinations for two does single and 2 markers -->

```


Plots
back to source activate /project/zemmour/david/envs/scvi_20240315
Prefix
```{r}
prefix = prefix
prefix2 = "k2_logdata" # prefix2 = "k2data"
# prefix3 = "markers_level2"
```

```{r}
setwd("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD4")
so = readRDS(sprintf("%s/igt1_96_CD4_filteredforCometsc.Rds", prefix))

```

```{r}

singleton_list = list()
files = list.files(path = sprintf("%s/%s", prefix, prefix2), pattern = "singleton_all_ranked.csv")
# cluster_ids = gsub(".*_(cl\\d+)_.*", "\\1", files)
cluster_ids = gsub("cluster_|_singleton_all_ranked.csv", "", files)
for (i in 1:length(files)) {
    singleton_list[[files[i]]] = read.table(file = sprintf("%s/%s/%s", prefix, prefix2, files[i]), header = T, as.is = T, sep = ",")
    if(nrow(singleton_list[[files[i]]]) != 0) {
        singleton_list[[files[i]]][,"cluster"] = cluster_ids[i]
    }
}
singleton_list = Reduce(f = rbind, singleton_list)

singleton_list %>% group_by(cluster) %>% arrange(rank, decreasing = F) %>% slice_head(n = 5) %>% as.data.frame() %>% write.table(sprintf("%s/%s/singleton_all_ranked_top5percluster.csv", prefix, prefix2), sep = ",", quote = F, row.names = F, col.names = T)

singleton_list %>% group_by(cluster) %>% arrange(rank, decreasing = F) %>% slice_head(n = 10) %>% as.data.frame() %>% write.table(sprintf("%s/%s/singleton_all_ranked_top10percluster.csv", prefix, prefix2), sep = ",", quote = F, row.names = F, col.names = T)

```

**Exploring the data with subset of cells for finding the gates**
Loading data on desktop
```{r}
setwd("/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/analysis/data_integration/IGT1_96/CD4/cometsc/")
so_orig = readRDS("../../igt1_96_withtotalvi20250513_clean_ADTonly.Rds")
so = so_orig[,so_orig$cite_seq == T & so_orig$annotation_level1 == "CD4" &  !(so_orig$annotation_level2 %in% c("CD4_miniverse", "CD4_prolif"))]

so = NormalizeData(so, assay = "ADT", normalization.method = "LogNormalize")
# so = NormalizeData(so, assay = "ADT", normalization.method = "CLR")

DefaultAssay(so) = "ADT"
# so = so[rownames(so)[so@assays$ADT@meta.features$IGT1only == F],]

```

Loading data on Midway
```{r}
setwd("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/CD4/cometsc")
so_orig = readRDS("../../igt1_96_withtotalvi20250513_clean_ADTonly.Rds")
so = so_orig[,so_orig$cite_seq == T & so_orig$annotation_level1 == "CD4" &  !(so_orig$annotation_level2 %in% c("CD4_miniverse", "CD4_prolif"))]

so = NormalizeData(so, assay = "ADT", normalization.method = "LogNormalize")
# so = NormalizeData(so, assay = "ADT", normalization.method = "CLR")

DefaultAssay(so) = "ADT"
# so = so[rownames(so)[so@assays$ADT@meta.features$IGT1only == F],]

```

Plot CITEseq on MDE
```{r}
so = NormalizeData(so, assay = "ADT", normalization.method = "CLR")
# prots = sort(rownames(so)[so@assays$ADT@meta.features$IGT1only == F])
prots = so@assays$ADT@meta.features %>% filter(IGT1only == F) %>% select(classification) %>% arrange(classification) %>% row.names()
umap_to_plot = "mde_incremental"
pdf(sprintf("%s/MDE_proteins_CLR.pdf", "."), 10,10, useDingbats = F)
for (f in prots) {
    print(f)
    print(FeaturePlot(so, reduction = umap_to_plot, features = f, raster = T, order = F, raster.dpi = c(1024,1024)))
}
dev.off()

so@assays$ADT@meta.features %>% filter(IGT1only == F) %>% select(classification) %>% arrange(classification) %>% row.names()

```

Heatmap
```{r}
so = NormalizeData(so, assay = "ADT", normalization.method = "LogNormalize")
adt = as.matrix(so[["ADT"]]$data)
markers = c("CD62L", "KLRG1", "CD49B", "FR4", "SCA1", "NEUROPILIN1.CD304", "CD69", "CD45RB")
adt = adt[markers,]
tmp = melt(adt)
tmp$cluster = so$Cluster_totalvi20240525rmigtsample_Res0.5[tmp$Var2]
tmp2 = tmp %>% group_by(cluster, Var1) %>% summarize(mean(value))
tmp3 = dcast(data = tmp2, Var1 ~ cluster)
rownames(tmp3) = tmp3[,1]
tmp3 = tmp3[,-1]
#labels_matrix = ifelse(is.na(tmp3), yes = "", no = as.character(signif(tmp3,2)))
# tmp4 = t(tmp3 / colMeans(tmp3))
tmp4 = tmp3 - rowMeans(tmp3)

pdf(sprintf("%s/%s_heatmap.pdf", prefix, prefix3), 5,5)
pheatmap(mat = tmp3, cluster_rows = T, cluster_cols = T, col = ColorRamp, fontsize_row = 10, fontsize_col = 10,  main = "log10+1 geom mean ADT", na_col = "grey") #display_numbers = labels_matrix, number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), fontsize = 10,
pheatmap(mat = tmp3, cluster_rows = T, cluster_cols = F, col = ColorRamp, fontsize_row = 10, fontsize_col = 10,  main = "log10+1 geom mean ADT", na_col = "grey") #display_numbers = labels_matrix, number_format = "%.0f", breaks = seq(0,100,length.out = length(ColorRamp)+1), fontsize = 10,
pheatmap(mat = tmp4, cluster_rows = T, cluster_cols = T, col = ColorRamp, fontsize_row = 10, fontsize_col = 10,  main = "log10+1 geom mean ADT (rowMean normalized)", na_col = "grey")
pheatmap(mat = tmp4, cluster_rows = T, cluster_cols = F, col = ColorRamp, fontsize_row = 10, fontsize_col = 10,  main = "log10+1 geom mean ADT (rowMean normalized)", na_col = "grey")

dev.off()


```


*Exploring the data with subset of cells for finding the gates*
CD62L- might be enough (vs using also CD44). 
    CD62L+ CD44- fine: for all resting
    CD62L- CD44+: fine: clean for 15,16,17,18,21,22,23
    less clean for 9,10,13,14: CD62L- but CD44+ variable
    28 is weird and CD62L variable CD44 int
    25 is CD62L+ CD44int

CD45RB++ CD38++ --> cl20,28 (CD45RB captures all resting + 25,20,28)
    CD8A+ CD8B- (still CD4+) capture subset of cl28
    

FR4+ CD73+: 9,10,13,14 (FR4 also in resting pops)
    9=(CD73+/++) FR4+/++ CXCR5- NRP1- (PD1 +/-)
    13=(CD73++) FR4++ CXCR5+ NRP1+
    14=(CD73++) FR4++ CXCR5+ NRP1- (PD1+)
    10=(CD73++) FR4++ CXCR5- NRP1+
    
FR4- CD73-: 21,22,23
    21: CD69+ KLRG1- 
    22: CD69- KLRG1-
    23: CD69- KLRG1+
    
FR4- CD73+: 15,16,17,18
    DNAM1- --> 16
    DNAM1+ 15,17,18
        GITR+ CD49B+ --> 15
        GITR- CD49B- --> 17,18
            CD38++ --> 18
    KLRG1 is subset of 15/16 but specific for it
    GITR+ CD38- very specific for 15/16 also
    16: DNAM1- GITR+ very specific for 16 (across all clusters) (DNAM1- is enough in the gate of FR4- CD73+)
    15: DNAM1+ GITR+ CD49B+; CD38+/-, subset KLRG1
    17: DNAM1+ GITR- CD38+
    18: DNAM1+ GITR- CD38++ very specific for 18

Interesting parallel expression between KLRG1 and PD1!

KLRG1+ is specific for the paws (15, 16, 23>>22, but not 17,18) (and not the FR4+ pops). Not necessarily all of them but very specific to check if full phenotype:
    21-23 are CD73- and use CD69
    15-16 are CD73- and use DNAM1 to split

Other notes
CD2 lower in 15,16,17,18
CD69, KLRG1 useless
ICOS same
SCA1 not useful

cl20: CD45RB++ >6 CD38++ >5 CD8A- <4 (CD8B- <5)
cl28: CD45RB++ >6 CD38++ >5 CD8A- >4 (CD8B- <5)

cl9:  CD45RBlo/- <6 & CD38lo/- < 5 & CD62L- <4 & FR4+ > 3.5 & CD73+ > 5 & CXCR5- < 2 & NRP1lo < 4
cl13: CD45RBlo/- <6 & CD38lo/- < 5 & CD62L- <4 & FR4+ > 3.5 & CD73+ > 5 & CXCR5- < 2 & NRP1hi > 4
cl14: CD45RBlo/- <6 & CD38lo/- < 5 & CD62L- <4 & FR4+ > 3.5 & CD73+ > 5 & CXCR5+ > 2 & PD1+ > 4
cl10: CD45RBlo/- <6 & CD38lo/- < 5 & CD62L- <4 & FR4+ > 3.5 & CD73+ > 5 & CXCR5+ > 2 & PD1- < 4

cl21: CD45RBlo/- <6 & CD38lo/- < 5 & CD62L- <4 & FR4-< 3.5 & CD73- < 5 & KLRG1- < 4 & CD69+ > 4 
cl22: CD45RBlo/- <6 & CD38lo/- < 5 & CD62L- <4 & FR4-< 3.5 & CD73- < 5 & KLRG1- < 4 & CD69- < 4 
cl23: CD45RBlo/- <6 & CD38lo/- < 5 & CD62L- <4 & FR4-< 3.5 & CD73- < 5 & KLRG1+ > 4 & CD69- < 4 
    
cl16: CD45RBlo/- <6 & CD38lo/- < 5 & CD62L- <4 & FR4-< 3.5 & CD73+ > 5 & DNAM1- < 2.5 (& GITR+ > 4 & CD49B- < 4 & CD38+/- < 5)
cl15: CD45RBlo/- <6 & CD38lo/- < 5 & CD62L- <4 & FR4-< 3.5 & CD73+ > 5 & DNAM1+ > 2.5 & GITR+ > 4 & CD49B+ > 4 (& CD38+/- < 5)
cl17: CD45RBlo/- <6 & CD38lo/- < 5 & CD62L- <4 & FR4-< 3.5 & CD73+ > 5 & DNAM1+ > 2.5 & GITR- < 4 & CD49B- < 4 & CD38+/- < 5
cl18: CD45RBlo/- <6 & CD38lo/- < 5 & CD62L- <4 & FR4-< 3.5 & CD73+ > 5 & DNAM1+ > 2.5 & GITR- < 4 & CD49B- < 4 & CD38++ > 5

--> use these plots to update gating.xlsx (then export each sheet for downstream analysis)
```{r}

## Subset data to plot and analyze faster
so@meta.data %>% group_by(annotation_level2) %>% summarize(n()) %>% as.data.frame()
sub = so@meta.data %>% group_by(annotation_level2) %>% sample_n(ifelse(test = n() < 1000, yes = n(), no = 1000)) %>% pull(cellID)
so_sub = so[,sub]
so_sub@meta.data %>% group_by(annotation_level2) %>% summarize(n()) %>% as.data.frame()
so = so_sub

features_list = list(c("CD62L", "CD44"),
                     c("CD45RB", "CD38"),
                     c("CD8A", "CD8B"),
                     c("FR4", "CD73.5NTD"),
                     #c("CD73.5NTD", "KLRG1"),
                     c("FR4", "CD38"),
                     c("NEUROPILIN1.CD304", "CXCR5"),
                     c("PDCD1.PD1.CD279", "CXCR5"),
                     c("FR4", "CD73.5NTD"),
                     c("KLRG1", "CD69"),
                     c("CD38", "GITR.CD357"),
                     c("KLRG1", "GITR.CD357"),
                     c("KLRG1", "PDCD1.PD1.CD279"),
                     c("CD226.DNAM1", "GITR.CD357"),
                     c("CD49B", "GITR.CD357"),
                     c("CD38", "GITR.CD357"),
                     c("FR4", "KLRG1"),
                     c("CD62L", "CD45RB"),
                     c("CD4", "CD8A"),
                     c("CD8A", "CD8B"), #19
                     c( "CD62L", "CD69"),
                     c( "CD55.DAF", "CD69")
                     )

pdf("all_pops_gates_facetted.pdf", 15,15, useDingbats = F)
i = 1
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 4
th2 = 5
# FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2_group") + scale_color_manual(values = mypal_level2) #+ ggtitle(sprintf("is_%s", cl))
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown") 

i = 2
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 6
th2 = 5
# FeatureScatter(so[,so$annotation_level2_group == "activated"],slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2") + scale_color_manual(values = mypal_level2) #+ ggtitle(sprintf("is_%s", cl))
# FeatureScatter(so[,so$annotation_level2_group == "activated"],slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 3
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 4
th2 = 5
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 4
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 3.5
th2 = 5
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 5
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 3.5
th2 = 4
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 6
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 4
th2 = 2
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 7
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 4
th2 = 2
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 8
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 3.5
th2 = 5
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 9
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 4
th2 = 4
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 10
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 5
th2 = 4
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 11
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 4
th2 = 4
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 12
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 4
th2 = 5
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 13
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 2.5
th2 = 4
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 14
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 4
th2 = 4
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 15
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 5
th2 = 4
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 16
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 2.5
th2 = 4
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 17
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 4
th2 = 6
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 


i = 18
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 4
th2 = 6
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 19
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 4
th2 = 6
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 20
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 4
th2 = 4
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

i = 21
feature1 = features_list[[i]][1]
feature2 = features_list[[i]][2]
th1 = 4
th2 = 4
FeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = "annotation_level2", split.by = "annotation_level2", ncol = 3, raster = F, pt.size = 0.2) + scale_color_manual(values = mypal_level2) + geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")#+ ggtitle(sprintf("is_%s", cl)) 

dev.off()

```


*Plots from gating strategy*
```{r}

#DO NOT USE SO_SUB!

toplot = read.table("gating_toplot.csv", header = T, sep = ",", row.names = 1)
pops = read.table("gating_populations.csv", header = T, sep = ",",  row.names = 1)


toplot = read.table("gating_toplot20250527.csv", header = T, sep = ",", row.names = 1)
pops = read.table("gating_populations20250527.csv", header = T, sep = ",",  row.names = 1)
thresholds = read.table("gating/gating_thresholds.csv", header = T, sep = ",",  row.names = 1)
plots = read.table("gating/gating_plots.csv", header = T, sep = ",",  row.names = 1)
prefix3 = "gating/20250527"

toplot = read.table("gating_toplot20250605.csv", header = T, sep = ",", row.names = 1)
pops = read.table("gating_populations20250605.csv", header = T, sep = ",",  row.names = 1)
thresholds = read.table("gating/gating_thresholds.csv", header = T, sep = ",",  row.names = 1)
plots = read.table("gating/gating_plots.csv", header = T, sep = ",",  row.names = 1)
prefix3 = "gating/202506057"

toplot = read.table("gating/gating_toplot20250606.csv", header = T, sep = ",", row.names = 1)
pops = read.table("gating/gating_populations20250606.csv", header = T, sep = ",",  row.names = 1)
thresholds = read.table("gating/gating_thresholds.csv", header = T, sep = ",",  row.names = 1)
plots = read.table("gating/gating_plots.csv", header = T, sep = ",",  row.names = 1)
# prefix3 = "gating/20250606"

toplot = read.table("gating/gating_toplot20250606_2.csv", header = T, sep = ",", row.names = 1)
pops = read.table("gating/gating_populations20250606_2.csv", header = T, sep = ",",  row.names = 1)
thresholds = read.table("gating/gating_thresholds20250606_2.csv", header = T, sep = ",",  row.names = 1)
plots = read.table("gating/gating_plots.csv", header = T, sep = ",",  row.names = 1)
# prefix3 = "gating/20250606_2"

toplot = read.table("gating/gating_toplot20250606_3.csv", header = T, sep = ",", row.names = 1)
pops = read.table("gating/gating_populations20250606_3.csv", header = T, sep = ",",  row.names = 1)
thresholds = read.table("gating/gating_thresholds20250606_3.csv", header = T, sep = ",",  row.names = 1)
plots = read.table("gating/gating_plots.csv", header = T, sep = ",",  row.names = 1)
prefix3 = "gating/20250606_3"

toplot = read.table("gating/gating_toplot20250606_4.csv", header = T, sep = ",", row.names = 1)
pops = read.table("gating/gating_populations20250606_4.csv", header = T, sep = ",",  row.names = 1)
thresholds = read.table("gating/gating_thresholds20250606_4.csv", header = T, sep = ",",  row.names = 1)
plots = read.table("gating/gating_plots.csv", header = T, sep = ",",  row.names = 1)
prefix3 = "gating/20250606_4"

ensure_directory(prefix3)

```

Flow-like plots
```{r}
for (i in 1:nrow(pops)) {
    pop = rownames(pops)[i]
    print(pop)
    toplots = colnames(toplot)[!is.na(toplot[pop,])]
    # j = toplots[2]
    pdf(sprintf("%s/gating_strategy_%s.pdf",prefix3, pop), 6, 6, useDingbats = F)
    for (j in toplots) {
        print(j)
        features = colnames(plots)[!is.na(plots[j,])]
        feature1 = features[1]
        feature2 = features[2]
        feature1_th1 = thresholds[features[1],"th1"]
        feature1_th2 = thresholds[features[2],"th1"]
        pop_split = strsplit(pop, split = ",") %>% unlist() #if interested population is a mixture of several clusters
        so@meta.data[,sprintf("is_%s", pop)] = factor(so$annotation_level2 %in% pop_split) #so@meta.data[,sprintf("is_%s", cl)] =
        p = MyFeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = sprintf("is_%s", pop),split.by = NULL, raster = F) + geom_vline(aes(xintercept = feature1_th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = feature1_th2), linetype="dashed", color = "brown") + ggtitle(sprintf("is_%s", pop))
        print(p)
        
    }
    dev.off()
    
}

```

Bioinfo Sort
--> GatedCells.Rds, SeSpPPVNPV_ClusterBySample.tsv
cellid in each gate --> GatedCells.Rds
```{r}
pops[is.na(pops) | pops == "" ] = NA

gate_list = list()

for (i in 1:nrow(pops)) {
    pop = rownames(pops)[i]
    print(pop)
    mrks = na.omit(unlist(pops[i,]))
    ths = thresholds[rownames(thresholds) %in% names(mrks),"th1"]
    names(ths) = names(mrks)
    ths
    
    cells = colnames(so)
    for (m in names(mrks)) { 
        print(m)
        if (mrks[m] == "p") {
            cells = intersect(cells, names(which(so[["ADT"]]$data[m,cells] > ths[m])))
        } else {
            cells = intersect(cells, names(which(so[["ADT"]]$data[m,cells] < ths[m])))
        }
    }
    gate_list[[pop]] = cells
    message(sprintf("%s: %s cells",pop, length(cells)))
}

# saveRDS(gate_list, file = "GatedCells_20250527.Rds")
# saveRDS(gate_list, file = sprintf("GatedCells_%s.Rds",prefix3))
# gate_list = readRDS(sprintf("GatedCells_%s.Rds",prefix3))
saveRDS(gate_list, file = sprintf("%s/GatedCells.Rds",prefix3))
# gate_list = readRDS(sprintf("%s/GatedCells.Rds",prefix3))

# pdf(sprintf("gated_cells_inMDE_%s.pdf",prefix3), 10, 10, useDingbats = F)
# for (i in 1:nrow(pops)) {
#     pop = rownames(pops)[i]
#     print(pop)
#     pop_split = strsplit(pop, split = ",") %>% unlist() #if interested population is a mixture of several clusters
#     so@meta.data[,sprintf("is_%s", pop)] = factor(so$annotation_level2 %in% pop_split)
#     so@meta.data[,sprintf("is_gated_%s", pop)] = colnames(so) %in% gate_list[[pop]] #so@meta.data[,sprintf("is_%s", cl)] =
#     p = MyDimPlotHighlight(seurat_object = so, umap_to_plot = "mde_incremental", cells_to_highlight = colnames(so)[which(so$annotation_level2 %in% pop_split)], highlight_column = "annotation_level2", pixels = c(512, 512), mycols = mypal_level2, title = sprintf("%s", pop))
#     print(p)
#     p = MyDimPlotHighlight(seurat_object = so, umap_to_plot = "mde_incremental", cells_to_highlight = colnames(so)[which(so@meta.data[,sprintf("is_gated_%s", pop)])], highlight_column = "annotation_level2", pixels = c(512, 512), mycols = mypal_level2, title = sprintf("gated %s", pop), highlight_size = 0.1, highlight_alpha = 0.1)
#     print(p)
# }
# dev.off()


# pdf(sprintf("%s/gated_cells_inMDE.pdf",prefix3), 5, 5, useDingbats = F)
for (i in 1:nrow(pops)) {
    pop = rownames(pops)[i]
    print(pop)
    pdf(sprintf("%s/gated_cells_inMDE_%s.pdf",prefix3, pop), 5, 5, useDingbats = F)
    pop_split = strsplit(pop, split = ",") %>% unlist() #if interested population is a mixture of several clusters
    so@meta.data[,sprintf("is_%s", pop)] = factor(so$annotation_level2 %in% pop_split)
    so@meta.data[,sprintf("is_gated_%s", pop)] = colnames(so) %in% gate_list[[pop]]
    so$density = "grey"
    so$density[so@meta.data[,sprintf("is_gated_%s", pop)]] = densCols(so[["mde_incremental"]]@cell.embeddings[so@meta.data[,sprintf("is_gated_%s", pop)], 1], so[["mde_incremental"]]@cell.embeddings[so@meta.data[,sprintf("is_gated_%s", pop)], 2], colramp = colorRampPalette(rev(rainbow(10, end = 4/6))), nbin = 500)
    p = MyDimPlotHighlight(seurat_object = so, umap_to_plot = "mde_incremental", cells_to_highlight = colnames(so)[which(so$annotation_level2 %in% pop_split)], highlight_column = "annotation_level2", pixels = c(512, 512), mycols = mypal_level2, title = sprintf("%s", pop))
    print(p)
    p = MyDimPlotHighlight(seurat_object = so, umap_to_plot = "mde_incremental", cells_to_highlight = colnames(so)[which(so@meta.data[,sprintf("is_gated_%s", pop)])], highlight_column = "annotation_level2", pixels = c(512, 512), mycols = mypal_level2, title = sprintf("gated %s", pop), highlight_size = 0.5, highlight_alpha = 0.5)
    print(p)
    p = MyDimPlotHighlightDensity(so, umap_to_plot = "mde_incremental",group.by = sprintf("is_gated_%s", pop), split.by = NULL, raster = F, highlight_size = 0.2, highlight_alpha = 0.2)
    print(p) + ggtitle(sprintf("%s", pop))
    # p = DimPlot(so,reduction = "mde_incremental", group.by= "density", raster = F) + scale_color_identity()
    # print(p) + ggtitle(sprintf("%s", pop))
    dev.off()
}








```

SeSpPPVNPV_ClusterBySample.tsv by comparing gated cells and true clusters
```{r}
stats_list = list()
for (i in 1:nrow(pops)) {
    pop = rownames(pops)[i]
    print(pop)
    pop_split = strsplit(pop, split = ",") %>% unlist() 
    so@meta.data[,sprintf("is_%s", pop)] = factor(so$annotation_level2 %in% pop_split)
    stats = list()
    tmp = so@meta.data
    # s = "I39H3_decidua_E12.5_SFB_allT_mouse0135"
    for (s in unique(so$sample_code)) {
        # print(s)
        tmp = so@meta.data %>% filter(sample_code == s)
        cont_table = TpTnFpFn(x = factor(rownames(tmp) %in% gate_list[[pop]], levels = c("TRUE", "FALSE")), y = factor(tmp[,sprintf("is_%s", pop)],levels = c("TRUE", "FALSE")))
        stats[[s]] = SeSpPPVNPV(tp = cont_table["tp"], tn = cont_table["tn"], fp = cont_table["fp"], fn=  cont_table["fn"])
        stats[[s]]["ncells"] = length(which(tmp[,sprintf("is_%s", pop)] == "TRUE"))
        stats[[s]]["prevalence"] = stats[[s]]["ncells"] / nrow(tmp)
    }
    stats_list[[pop]] = do.call(rbind, stats) %>% as.data.frame
    stats_list[[pop]][,"pop"] = pop
    stats_list[[pop]][,"sample_code"] = rownames(stats_list[[pop]])
    
}


stats = Reduce(f = rbind, stats_list) %>% as.data.frame()

# m = read.table("/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/analysis/data_integration/IGT1_96/export_data/Sample_metadata_david_20250419_v9.csv",header = T, sep = ",")
m = read.table("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/export_data/Sample_metadata_david_20250419_v9.csv",header = T, sep = ",")

stats = merge(stats, m, by = "sample_code", all.x = T, all.y = F)

# write.table(stats, file = "SeSpPPVNPV_ClusterBySample.tsv", quote = F, row.names = F, col.names = T, sep = "\t")
write.table(stats, file = sprintf("%s/SeSpPPVNPV_ClusterBySample.tsv", prefix3), quote = F, row.names = F, col.names = T, sep = "\t")


# i = "npv"
for (i in c("se", "sp", "ppv", "npv")) {
    print(i)
    
    # pdf(sprintf("stats_%s_SummaryPlot.pdf", i),15,10, useDingbats = F)
    pdf(sprintf("%s/stats_%s_SummaryPlot.pdf", prefix3,i),15,10, useDingbats = F)
    
    p = ggplot(stats %>% filter(prevalence>0.2 & ncells > 50)) + geom_boxplot(aes(pop, !!(sym(i)), color = pop), outliers = F) + 
        geom_jitter(data = stats, aes(pop, !!(sym(i)), color = pop, size = prevalence>0.2 & ncells > 50), width = 0.2, height = 0) +
        # geom_jitter(aes(pop, ppv, color = pop), width = 0.2, height = 0) +
        scale_size_manual(values = c(0.5,2)) +
        scale_color_manual(values = mypal_level2) + 
        labs(title = sprintf("%s by Gating Strategies across Populations,\nBoxplot samples with prevalence >0.2 and ncells >50",i), x = "Gating Strategies", y = i, color = "Level2") + 
        theme_minimal() + 
        theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
    print(p)
    
    p = ggplot(stats %>% filter(prevalence>0.2 & ncells > 50)) + geom_boxplot(aes(pop, !!(sym(i)), color = pop), outliers = F) + 
        # geom_jitter(data = stats, aes(pop, ppv, color = pop, size = prevalence>0.1 & ncells > 50), width = 0.2, height = 0) +
        geom_jitter(aes(pop, !!(sym(i)), color = pop), width = 0.2, height = 0) +
        scale_size_manual(values = c(0.5,2)) +
        scale_color_manual(values = mypal_level2) + 
        labs(title = sprintf("%s by Gating Strategies across Populations,\nsamples with prevalence >0.2 and ncells >50",i), x = "Gating Strategies", y = i, color = "Level2") + 
        theme_minimal() + 
        theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
    print(p)
    
    
    p = ggplot(stats %>% filter(prevalence>0.2 & ncells > 50)) + geom_boxplot(aes(pop, !!(sym(i))), outliers = F) + 
        geom_jitter(data = stats, aes(pop, !!(sym(i)), color = organ_simplified, size = prevalence>0.2 & ncells > 50), width = 0.2, height = 0) +
        scale_size_manual(values = c(0.5,2)) +
        scale_color_manual(values = mypal_organ) + 
        labs(title = sprintf("%s by Gating Strategies across Populations,\nBoxplot samples with prevalence >0.2 and ncells >50",i), x = "Gating Strategies", y = i, color = "Organ") + 
        theme_minimal() + 
        theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
    print(p)
    
    p = ggplot(stats %>% filter(prevalence>0.2 & ncells > 50)) + geom_boxplot(aes(pop, !!(sym(i))), outliers = F) + 
        geom_jitter(aes(pop, !!(sym(i)), color = organ_simplified), width = 0.2, height = 0) +
        scale_size_manual(values = c(0.5,2)) +
        scale_color_manual(values = mypal_organ) + 
        labs(title = sprintf("%s by Gating Strategies across Populations, Boxplot samples with prevalence >0.2 and ncells >50",i), x = "Gating Strategies", y = i, color = "Organ") + 
        theme_minimal() + 
        theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
    print(p)
    
    dev.off()
    
}



```

**UMAP from selected markers**

```{r}
library(uwot)
panel = c("CD62L", "CD44", "FR4", "CD73.5NTD", "CD69", "CXCR5", "PDCD1.PD1.CD279", "NEUROPILIN1.CD304", "GITR.CD357", "CD38", "KLRG1", "CD226.DNAM1")

DefaultAssay(so) = "ADT"
# so = NormalizeData(so, assay = "ADT", normalization.method = "LogNormalize")
so = NormalizeData(so, assay = "ADT", normalization.method = "CLR")
so = ScaleData(so, features = panel)
so = RunPCA(so, features = panel, npcs = 12, reduction.name = "pca")
ElbowPlot(so)
so = FindNeighbors(so, dims = 1:6, reduction = "pca")
so = RunUMAP(so, dims = 1:6,reduction = "pca", reduction.name = "umap.panel")


umap_result = umap(t(so[["ADT"]]@scale.data), n_neighbors = 30L, min_dist = 0.3, metric = "correlation")
so[["umap.panel"]] = CreateDimReducObject(umap_result, assay = "ADT", key = "umap.panel")
DimPlot(so, reduction = "umap.panel", group.by = "annotation_level2", label = T, cols = mypal_level2,label.size = 0.5) + NoLegend()


pdf("gating/UMAP_panel_LogNorm.pdf", 5, 5, useDingbats = F)
# pdf("gating/UMAP_panel_CLR.pdf", 10, 10, useDingbats = F)
ElbowPlot(so)
DimPlot(so, reduction = "umap.panel", group.by = "annotation_level2", label = TRUE, cols = mypal_level2)
DimPlot(so, reduction = "umap.panel", group.by = "annotation_level2", label = T, cols = mypal_level2,label.size = 0.5) + NoLegend()
DimPlot(so, reduction = "umap.panel", group.by = "annotation_level2", label = F, cols = mypal_level2, split.by = "annotation_level2", ncol = 4) + NoLegend()
for (i in levels(so$annotation_level2)[levels(so$annotation_level2) %in% unique(so$annotation_level2)]) {
    print(i)
    p = MyDimPlotHighlight(seurat_object = so, umap_to_plot = "umap.panel", cells_to_highlight = colnames(so)[which(so@meta.data[,"annotation_level2"] %in% i)], highlight_column = "annotation_level2", pixels = c(512, 512), mycols = mypal_level2, title = sprintf("%s", i), highlight_size = 0.5, highlight_alpha = 0.5)
    print(p$plot3)
    so@meta.data[,sprintf("is_%s", i)] = so$annotation_level2 %in% i
    p = MyDimPlotHighlightDensity(so, umap_to_plot = "umap.panel",group.by = sprintf("is_%s", i), split.by = NULL, raster = F, highlight_size = 0.2, highlight_alpha = 0.2)
    print(p) + ggtitle(sprintf("%s", i))
}
dev.off()


```



