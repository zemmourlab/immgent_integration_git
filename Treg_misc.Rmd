---
title: "Treg_misc"
output: html_document
date: "2025-05-28"
author: "David Zemmour"
editor_options: 
  chunk_output_type: console
---

**Initialize: load libraries and custom functions**

```{bash}
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=jfkfloor2 --qos=jfkfloor2 --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=beagle3-bigmem --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=zemmour-hm --qos=zemmour --nodes=1 
sinteractive --time=03:00:00 --account=pi-zemmour --partition=caslake --nodes=1 --mem=96GB

module load python/anaconda-2022.05 
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13
source activate /project/zemmour/david/envs/scvi_20240315
#source activate /project/zemmour/david/envs/r443
module load openblas/0.3.13

cd /project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg
R
```


```{r}
# setwd("~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96")
libs = c("ZemmourLib","gridExtra","Matrix", "Seurat", "ggplot2", "dplyr", "reshape2", "ggrastr","scattermore", "RColorBrewer", "pals", "scales", "pheatmap", "rafalib") 
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))
#source("/project/jfkfloor2/zemmourlab/david/immgent/immgent_integration_git/custom_functions_david.R")

ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
ColorRamp = rev(rainbow(10, end = 4/6))
ColorRamp = rev(viridis(100))
ColorRamp = brewer.pal(9, "Blues")

#mycol = c("black","blue","red","darkgreen", "orange","purple", "cyan", "greenyellow",    "salmon", "magenta","pink", "tan", "brown") # c("magenta", "red",  "darkgreen", "cyan", "blue", "blue", "blue", "black", "blue", "blue", "blue", "blue", "orange")

mypal_level2 = immgent_colors$level2
mypal_level1 = immgent_colors$level1
mypal_organ = immgent_colors$organ_simplified

#Large Color palette
library("pals")
n = 70
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
mypal1 = unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals))))
mypal1 = mypal1[-4]
mypal = c(glasbey(), polychrome(), mypal1)
names(mypal) = NULL
#pal.bands(mypal, main="Colormap suggestions")
# mypal_organ = setNames(mypal, unique(so$organ_simplified))
# mypal_organ = mypal_organ[!is.na(names(mypal_organ))]
# mypal_level1 = setNames(mypal, unique(so$annotation_level1))
# mypal_level1 = mypal_level1[!is.na(names(mypal_level1))]
# mypal_level2 = setNames(mypal, unique(so_orig$annotation_level2))
# mypal_level2 = mypal_level2[!is.na(names(mypal_level2))]
# mypal_level2["CD4_cl18"] = "blue"
mypal_igt = setNames(mypal, unique(so$IGT))
mypal_igt = mypal_igt[!is.na(names(mypal_igt))]



```

```{r}
fig_dir = "~/google_drive_uchicago/ImmgenT/20250109_freeze/Treg/paper_Treg/figures/bits_david"
fig_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg/paper_Treg/figures/bits_david"

out_dir = "~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/Treg/misc" 
out_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg/misc"

```


**Most up-to-date data**
on Midway
```{r}

# so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250513_clean.Rds") 
so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250710_clean.Rds") 
so_orig$annotation_level2[so_orig$annotation_level2 == "Treg_cl7"] = "Treg_cl1"

so =  so_orig[,so_orig$annotation_level1 == "Treg"]
so$annotation_level2 = factor(so$annotation_level2, levels = c("Treg_cl1", "Treg_cl3", "Treg_cl6", "Treg_cl2","Treg_cl8","Treg_cl4", "Treg_prolif", "Treg_miniverse"))
```

on Desktop
```{r}
#source('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/analysis/immgent_integration_git/custom_functions_david.R') -->

tt_list = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/analysis/data_integration/IGT1_96/Treg/DGE_limma/20250109/ttlist_OneVsAll.Rds')

```


Load GP: L1 and F1
```{r}
library("flashier")
prefix = "topic"
prefix2 = "flashier20250215_alldata_backfit"
fit_flash = readRDS(sprintf("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/%s/%s/fit.Rds", prefix,prefix2))
fit = fit_flash

res = ldf(fit, type = "i")
L1 = with(res, L %*% diag(D)  ) #same as res$L %*% diag(res$D)
L1 = L1[colnames(so),]
all(colnames(so) == rownames(L1))
any(is.na(L1))
colnames(L1) = sprintf("F%s", 1:ncol(L1))
# sub_cells = sample(colnames(so_orig), 1500, replace = F)
# sub_cells = c(sample(colnames(so_orig)[so_orig$annotation_level1 %in% "Treg"], 1500, replace = F), sample(colnames(so_orig)[!so_orig$annotation_level1 %in% "Treg"], 1500, replace = F))
# sub_cells = c(so_orig@meta.data %>% filter(annotation_level1 == "Treg") %>% slice_sample(n = 1500, replace = FALSE) %>% pull(cellID),
#               so_orig@meta.data %>% filter(annotation_level1 != "Treg") %>% group_by(annotation_level1) %>% slice_sample(n = 100, replace = FALSE) %>% ungroup() %>% pull(cellID))

F1 = with(ldf(fit, type = "i"), F)
colnames(F1) = paste("F", 1:ncol(F1), sep = "")


# mdata_orig = read.table("metadata_20250513_mde.txt", header = T, sep = "\t")
mdata_orig = so@meta.data
```


Counting cells
```{r}
library(dplyr)

target_organs <- c("blood", "spleen", "LN", "thymus")

nlt = so_orig@meta.data %>% filter(annotation_level1 == "Treg" & !(organ_simplified %in% target_organs)) %>% count(name = "total_cells")

tot= so_orig@meta.data %>% filter(annotation_level1 == "Treg") %>% count(name = "total_cells")
(nlt)/tot
so_orig@meta.data %>% filter(annotation_level1 == "Treg") %>% distinct(IGTHT) %>% nrow()
```


**FCFC plots**
```{r}
source('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/analysis/immgent_integration_git/custom_functions_david.R')

tt_list = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/analysis/data_integration/IGT1_96/Treg/DGE_limma/20250109/ttlist_OneVsAll.Rds')

names(tt_list)


# Create the vplot dataframe with fold changes
vplot = data.frame(fc1 = exp(tt_list$CD8_cl10_vs_All$logFC), fc2 = exp(tt_list$CD8_cl11_vs_All$logFC), SYMBOL = tt_list$CD8_cl10_vs_All$SYMBOL)

# Identify genes with large fold changes (>2)
genes_to_plot = abs(tt_list$CD8_cl10_vs_All$logFC) > 0.69 | abs(tt_list$CD8_cl11_vs_All$logFC) > 0.69
# genes_to_label = vplot[genes_to_plot, ]
genes_to_label = vplot$SYMBOL[genes_to_plot]

# Create the plot
FCFCplot(vplot, 
         xlab = "FC for CD8_cl10", 
         ylab = "FC for CD8_cl11", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = genes_to_label)

FCFCplot(vplot, 
         xlab = "FC for CD8_cl10", 
         ylab = "FC for CD8_cl11", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = NULL)

vplot = data.frame(fc1 = exp(tt_list$CD8_cl10_vs_All$logFC), fc2 = exp(tt_list$CD8_cl7_vs_All$logFC), SYMBOL = tt_list$CD8_cl10_vs_All$SYMBOL)
# Identify genes with large fold changes (>2)
genes_to_plot = abs(tt_list$CD8_cl10_vs_All$logFC) > 0.69 | abs(tt_list$CD8_cl7_vs_All$logFC) > 0.69
genes_to_label = vplot[genes_to_plot, ]
# Create the plot
FCFCplot(vplot, 
         xlab = "FC for CD8_cl10", 
         ylab = "FC for CD8_cl7", 
         main = "Fold Change vs Fold Change", 
         printgeomtext = T, 
         genes_to_label = genes_to_label)



```

**MDE plots**
```{r}


o = unique(so$organ_simplified)

pdf("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg/MDE_organs_20250528.pdf", width = 10, height = 10, useDingbats = F)
for (o in unique(so$organ_simplified)) {
    print(o)
    p = MyDimPlotHighlight(seurat_object = so[,so$condition_broad == "healthy"], umap_to_plot = "mde_incremental", cells_to_highlight = colnames(so)[which(so$organ_simplified %in% o)], highlight_column_name = "annotation_level2", pixels = c(512, 512), mycols = mypal_level2, title = o, highlight_size = 0.5, highlight_alpha = 0.5, print_plot1 = T, print_plot2 = T, labelclusters = T)
    print(p)
}

dev.off()


pdf("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg/MDE_organs_20250528.pdf", width = 10, height = 20, useDingbats = F)
# p = DimPlot(so[,so$condition_broad == "healthy"], reduction = "mde_incremental", group.by = "annotation_level2", split.by = "organ_simplified", raster = F, raster.dpi = c(512,512), label = F, pt.size = 0.5, ncol = 3) + scale_color_manual(values = mypal_level2)
# p + NoLegend()
p = DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level2", split.by = "organ_simplified", raster = F, raster.dpi = c(512,512), label = F, pt.size = 0.2, ncol = 3) + scale_color_manual(values = mypal_level2)
p + NoLegend()
dev.off()

```

**Feature plots**
```{r}
so = so[,so$cite_seq]
so = NormalizeData(so,assay = "RNA", normalization.method = "LogNormalize",verbose = T)
so = NormalizeData(so,assay = "ADT", normalization.method = "LogNormalize",verbose = T)

pdf("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg/MDE_CD62L_20250528.pdf", width = 7, height = 7, useDingbats = F)
FeaturePlot(so, reduction = "mde_incremental", slot = "data", features = "CD62L", order = T, raster = F, raster.dpi = c(512,512))
dev.off()

pdf("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg/MyFeatureScatter_CD62LCD44_20250528.pdf", width = 7, height = 7, useDingbats = F)
for (pop in unique(so$annotation_level2)) {
    print(pop)
    feature1 = "CD62L"
    feature2 = "CD44"
    feature1_th1 = 0
    feature1_th2 = 0
    pop_split = strsplit(pop, split = ",") %>% unlist() #if interested population is a mixture of several clusters
    so@meta.data[,sprintf("is_%s", pop)] = factor(so$annotation_level2 %in% pop_split) #so@meta.data[,sprintf("is_%s", cl)] =
    p = MyFeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = sprintf("is_%s", pop),split.by = NULL, raster = F) + geom_vline(aes(xintercept = feature1_th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = feature1_th2), linetype="dashed", color = "brown") + ggtitle(sprintf("is_%s", pop))
    print(p)
}

dev.off()

pdf("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg/FeatureScatter_CD62LCD44_20250528.pdf", width = 7, height = 7, useDingbats = F)
FeatureScatter(so[,so$condition_broad == "healthy" & !so$annotation_level2 %in% c("Treg_prolif", "Treg_miniverse")],slot = "data",feature1 = "CD62L",feature2 =  "CD44", group.by = "annotation_level2", raster = F, pt.size = 0.1, split.by =  "annotation_level2", ncol = 3) + scale_color_manual(values = mypal_level2) + NoLegend() #+ geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")
FeatureScatter(so[,so$condition_broad == "healthy" & !so$annotation_level2 %in% c("Treg_prolif", "Treg_miniverse")],slot = "data",feature1 = "CD62L",feature2 =  "CD44", group.by = "annotation_level2", raster = T, pt.size = 0.1) + scale_color_manual(values = mypal_level2) + NoLegend() #+ geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = 
dev.off()

FeatureScatter(so, slot = "data", features = "CD62L", order = T, raster = T, raster.dpi = c(512,512))

```


**Barplot of cluster proportion in specific samples**

prop_data and mdata
mdata_sl1 from annotation_level2_PropPerSamplePerLevel1_withMetadata.Rds (proportion of CD8, CD4, Treg etc in each sample)
mdata_s from annotation_level2_PropPerSample.txt (proportion of total cells in the sample)
```{r}
prop_data = read.table(file = sprintf("%s/annotation_level2_PropPerSample.txt", prefix), header = T, sep = "\t" ) # --> mdata_s
prop_data = readRDS(file = sprintf("%s/annotation_level2_PropPerSamplePerLevel1_withMetadata.Rds", prefix)) %>% select(IGTHT, ends_with("ncells"), ends_with("prop")) # --> mdata_sl1
colnames(prop_data) = gsub(pattern = "gdT_52", replacement = "gdT_cl52", x = colnames(prop_data))
colnames(prop_data) = gsub(pattern = "gdT_54", replacement = "gdT_cl54", x = colnames(prop_data))

m = read.table('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/exp_id/sample_metadata/Sample_metadata_david_20250628_v10.csv',header = T, sep = ",")

# changing here and not in the original file to keep consistent with the database
colnames(m)
m$IGT_10xlane_id = NULL
m$organism_id = NULL
m$IGT = m$immgent_IGT_10xlane_id
m$immgent_IGT_10xlane_id = NULL
m$HT = m$hashtag_number
m$hashtag_number = NULL
m$sample_id = NULL
m$count_unique = NULL

m$sample_code.1 = NULL

mdata = merge(prop_data, m, by.x = "IGTHT", by.y = "IGTHT",all.x = T, all.y = F, suffixes = c(".x", ""))

mdata$organ_simplified = factor(mdata$organ_simplified, levels = c("blood","spleen","LN","SLO","bone marrow","thymus",
                                                                   "lung", "liver", "peritoneal cavity",
                                                                   "colon epi","small intestine epi","colon LP","small intestine LP","skin",
                                                                   "mammary gland","uterus", "placenta", "prostate","submandibular gland","kidney", "pancreas","CNS","synovial fluid"))
#any(is.na(mdata$organ_simplified))

mdata$condition_detailed_simplified = factor(mdata$condition_detailed_simplified)
mdata$condition_detailed_simplified = relevel(mdata$condition_detailed_simplified, ref = "baseline")


mdata_sl1 = mdata
mdata_s = mdata

```

Treg_cl barplot samples
```{r}
mdata = mdata_sl1
mdata = mdata_s
mdata #see chunk at the beginning, from prop_data = read.table(file = sprintf("%s/annotation_level2_PropPerSample.txt", prefix), header = T, sep = "\t" ) 

mdata %>% select(ends_with(".prop")) %>% pivot_longer(
            cols      = ends_with(".prop"),
            names_to  = "population",
            values_to = "prop") %>% mutate(population = gsub(pattern = "\\.prop",replacement = "", x = population )) %>% filter(population == starts_with("Treg")) %>% pull(population) %>% unique()


for (mycl in unique(so_orig$annotation_level2[so_orig$annotation_level1 == "Treg"])) {
    print(mycl)
    want_cols = paste0(mycl, ".prop")
    tmp = mdata %>% filter(grepl(pattern = "allT|CD45p", x = target_cells_simplified) & !(condition_detailed == "baseline" & organ_simplified == "spleen") ) %>% select(sample_code,any_of(want_cols))
    # tmp = mdata %>% select(sample_code,any_of(want_cols))
    
    tmp2 = tmp %>% mutate(total_prop = rowSums(select(., ends_with(".prop")), na.rm = TRUE)) %>% arrange(desc(total_prop))
    tmp2 %>% head(50) %>% pull(sample_code)
    
    tmp2 <- tmp2 %>% 
        arrange(desc(total_prop)) %>% 
        mutate(sample_code = factor(sample_code, sample_code)) %>% 
        head(50)
    
    tmp_long <- tmp2 %>% 
        select(-total_prop) %>% 
        pivot_longer(
            cols      = -sample_code,
            names_to  = "population",
            values_to = "prop"
        ) 
    
    tmp_long$population = gsub("\\.prop","", tmp_long$population )
    tmp_long$condition_detailed_organ = mdata$condition_detailed_organ[match(tmp_long$sample_code, mdata$sample_code)]
    
    label_map = tmp_long %>% 
        distinct(sample_code, condition_detailed_organ) %>% 
        arrange(sample_code)
    lab_vec = label_map$condition_detailed_organ
    names(lab_vec) = label_map$sample_code
    
    
    # pdf(sprintf("%s/BarplotTopSamples_%s_ofTreg.pdf", fig_dir, mycl),10, 8, useDingbats = F) #all Treg
    pdf(sprintf("%s/BarplotTopSamples_%s_oftotalT.pdf", fig_dir, mycl),10, 8, useDingbats = F) #all T cells
    p = ggplot(tmp_long, aes(x = sample_code, y = prop, fill = population)) +
        geom_bar(stat = "identity") +
        scale_fill_manual(values = immgent_colors$level2) +
        scale_x_discrete(labels = lab_vec) +
        theme_minimal() +
        labs(
            x    = "Sample",
            y    = "Proportion",
            fill = "Population"
        ) +
        # ggtitle(sprintf("Top samples with Treg %s - percent of total Treg", mycl)) +
        ggtitle(sprintf("Top samples with Treg %s - percent of total cells in the sample", mycl)) +
        theme_minimal() +
        theme(
            panel.grid.major = element_blank(), # Removes major grid lines
            panel.grid.minor = element_blank(), # Removes minor grid lines
            # axis.title = element_blank(),       # Removes axis titles (e.g., "count")
            # axis.text = element_blank(),        # Removes axis labels/text (e.g., numbers on the axis)
            axis.ticks = element_blank(),        # Removes axis tick marks
            axis.text.x = element_text(angle = 45, hjust = 1)
        )
    print(p)
    dev.off()
    
}


```

**Figure 1**
General MDE with Treg highlighted
```{r}

pdf("../MDE_level1_20251907.pdf", 5, 5, useDingbats = F)
DimPlot(object = so_orig, reduction = "mde2_totalvi_20241006", group.by = "annotation_level1", cols = mypal_level1, raster = T, raster.dpi = c(1024, 1024))
DimPlot(object = so_orig, reduction = "mde2_totalvi_20241006", group.by = "annotation_level1", cols = mypal_level1, raster = T, raster.dpi = c(1024, 1024)) + ggtitle(label = NULL) + theme_void() + NoLegend()
dev.off()

dim1 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[, 1]
dim2 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[, 2]
tmp = data.frame(so_orig@meta.data, dim1 = dim1, dim2 = dim2)

pdf(sprintf("%s/MDE_level1.pdf", fig_dir), width = 5,5,useDingbats = F)
ggplot(tmp) + scattermore::geom_scattermore(aes(dim1, dim2, color = annotation_level1, alpha = annotation_level1 == "Treg"), pointsize = 1, pixels = c(512, 512)) + scale_color_manual(values = mypal_level1) + scale_alpha_manual(values = c(0.01,0.3)) + theme_minimal() + NoGrid()

ggplot(tmp) + scattermore::geom_scattermore(aes(dim1, dim2, color = annotation_level1, alpha = annotation_level1 == "Treg"), pointsize = 1, pixels = c(512, 512)) + scale_color_manual(values = mypal_level1) + scale_alpha_manual(values = c(0.01,0.3)) + theme_minimal() + NoGrid() + NoLegend()

ggplot(tmp) + scattermore::geom_scattermore(aes(dim1, dim2, color = annotation_level1, alpha = annotation_level1 == "CD4"), pointsize = 1, pixels = c(512, 512)) + scale_color_manual(values = mypal_level1) + scale_alpha_manual(values = c(0.01,0.3)) + theme_minimal() + NoGrid() + NoLegend()

ggplot(tmp) + scattermore::geom_scattermore(aes(dim1, dim2, color = annotation_level1, alpha = annotation_level1 == "CD8"), pointsize = 1, pixels = c(512, 512)) + scale_color_manual(values = mypal_level1) + scale_alpha_manual(values = c(0.01,0.3)) + theme_minimal() + NoGrid() + NoLegend()

ggplot(tmp) + scattermore::geom_scattermore(aes(dim1, dim2, color = annotation_level1, alpha = annotation_level1 == "gdT"), pointsize = 1, pixels = c(512, 512)) + scale_color_manual(values = mypal_level1) + scale_alpha_manual(values = c(0.01,0.3)) + theme_minimal() + NoGrid() + NoLegend()

ggplot(tmp) + scattermore::geom_scattermore(aes(dim1, dim2, color = annotation_level1, alpha = annotation_level1 == "CD8aa"), pointsize = 1, pixels = c(512, 512)) + scale_color_manual(values = mypal_level1) + scale_alpha_manual(values = c(0.01,0.3)) + theme_minimal() + NoGrid() + NoLegend()

ggplot(tmp) + scattermore::geom_scattermore(aes(dim1, dim2, color = annotation_level1, alpha = annotation_level1 == "DN"), pointsize = 1, pixels = c(512, 512)) + scale_color_manual(values = mypal_level1) + scale_alpha_manual(values = c(0.01,0.3)) + theme_minimal() + NoGrid() + NoLegend()

ggplot(tmp) + scattermore::geom_scattermore(aes(dim1, dim2, color = annotation_level1, alpha = annotation_level1 == "DP"), pointsize = 1, pixels = c(512, 512)) + scale_color_manual(values = mypal_level1) + scale_alpha_manual(values = c(0.01,0.5)) + theme_minimal() + NoGrid() + NoLegend()

dev.off()

# MyDimPlotHighlight(seurat_object = so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = names(which(so_orig$annotation_level1 == "Treg")), labelclusters = F, highlight_column_name = "annotation_level1", background_color = F, print_plot1 = T, print_plot2 = F, mycols = mypal_level1, pixels = c(512, 512), background_alpha = 0.1)
# 
# MyDimPlotHighlight(seurat_object = so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = names(which(so_orig$annotation_level1 == "Treg")), highlight_size = 0.5, highlight_alpha = 0.5,labelclusters = F, highlight_column_name = "annotation_level1", background_color = T, print_plot1 = T, print_plot2 = F, mycols = mypal_level1, pixels = c(512, 512), background_alpha = 0.1)
# 
# MyDimPlotHighlight(seurat_object = so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = names(which(so_orig$annotation_level1 == "CD4")), highlight_size = 0.5, highlight_alpha = 0.5,labelclusters = F, highlight_column_name = "annotation_level1", background_color = T, print_plot1 = T, print_plot2 = F, mycols = mypal_level1, pixels = c(512, 512), background_alpha = 0.1)



so = so_orig[,so_orig$annotation_level1 == "Treg" & so_orig$IGT == "IGT67"]
saveRDS(so, "~/Desktop/IGT67_Treg.Rds")

```


**Figure 5: cl2 cancer vs cl2 non cancer**

```{r}
mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("B16_ACT", "PDAC", "GBMclass", "GBMmes", "KP")) %>% count(condition_detailed_simplified)
mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & !(condition_broad %in% c("healthy", "cancer"))) %>% count(condition_detailed_simplified)
mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("baseline")) %>% count(condition_detailed_simplified)

res_list = list()

group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("B16_ACT", "PDAC", "GBMclass", "GBMmes", "KP")) %>% pull(cellID)
group2 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("baseline")) %>% pull(cellID)
length(group1)
length(group2)
res_list[["Tregcl2Cancer_vs_Baseline"]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("Treg_cl2 cancer vs baseline %s",""))
# res_list[["Tregcl2Cancer_vs_Baseline"]]$p1
# res_list[["Tregcl2Cancer_vs_Baseline"]]$p2
# res_list[["Tregcl2Cancer_vs_Baseline"]]$diff_genes %>% arrange(desc(log2FC)) %>% head(50) %>% pull(SYMBOL)

group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("B16_ACT", "PDAC", "GBMclass", "GBMmes", "KP")) %>% pull(cellID)
group2 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & !(condition_broad %in% c("healthy", "cancer")))  %>% pull(cellID)
length(group1)
length(group2)
res_list[["Tregcl2Cancer_vs_OtherPerturb"]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("Treg_cl2 cancer vs other perturbations %s",""))
# res_list[["Tregcl2Cancer_vs_OtherPerturb"]]$p1
# res_list[["Tregcl2Cancer_vs_OtherPerturb"]]$p2
# res_list[["Tregcl2Cancer_vs_OtherPerturb"]]$diff_genes %>% arrange(desc(log2FC)) %>% head(50) %>% pull(SYMBOL)

group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & !(condition_broad %in% c("healthy", "cancer")))  %>% pull(cellID)
group2 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("baseline")) %>% pull(cellID)
length(group1)
length(group2)
res_list[["Tregcl2PerturbNotCancer_vs_Baseline"]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("Treg_cl2 perturbations not cancer vs baseline %s",""))
# res_list[["Tregcl2PerturbNotCancer_vs_Baseline"]]$p1
# res_list[["Tregcl2PerturbNotCancer_vs_Baseline"]]$p2
# res_list[["Tregcl2PerturbNotCancer_vs_Baseline"]]$diff_genes %>% arrange(desc(log2FC)) %>% head(50) %>% pull(SYMBOL)

all(res_list[[1]]$diff_genes$SYMBOL == res_list[[2]]$diff_genes$SYMBOL)

i = "Tregcl2Cancer_vs_Baseline"
j = "Tregcl2Cancer_vs_OtherPerturb"
vplot = data.frame(fc1 = 2^(res_list[[i]]$diff_genes$log2FC), fc2 = 2^(res_list[[j]]$diff_genes$log2FC), SYMBOL = res_list[[i]]$diff_genes$SYMBOL)
genes_to_plot = c(res_list[[i]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL), res_list[[j]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)) %>% unique()
# genes_to_label = vplot[genes_to_plot, ]
p1 = FCFCplot(vplot, 
         xlab = "Treg_cl2 cancer vs baseline", 
         ylab = "Treg_cl2 cancer vs other perturbations", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = genes_to_plot, xlimits = c(1/3, 3), ylimits = c(1/3, 3)) + NoGrid()
p2 = FCFCplot(vplot, 
         xlab = "Treg_cl2 cancer vs baseline", 
         ylab = "Treg_cl2 cancer vs other perturbations", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = NULL, xlimits = c(1/3, 3), ylimits = c(1/3, 3)) + NoGrid()

i = "Tregcl2Cancer_vs_Baseline"
j = "Tregcl2PerturbNotCancer_vs_Baseline"
vplot = data.frame(fc1 = 2^(res_list[[i]]$diff_genes$log2FC), fc2 = 2^(res_list[[j]]$diff_genes$log2FC), SYMBOL = res_list[[i]]$diff_genes$SYMBOL)
rownames(vplot) = vplot$SYMBOL
genes_to_plot = c(res_list[[i]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL), res_list[[j]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)) %>% unique()
p3 = FCFCplot(vplot, 
         xlab = "Treg_cl2 cancer vs baseline", 
         ylab = "Treg_cl2 perturbations not cancer vs baseline", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = genes_to_plot, xlimits = c(1/3, 3), ylimits = c(1/3, 3)) + NoGrid()
p4 = FCFCplot(vplot, 
         xlab = "Treg_cl2 cancer vs baseline", 
         ylab = "Treg_cl2 perturbations not cancer vs baseline", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = NULL, xlimits = c(1/3, 3), ylimits = c(1/3, 3)) + NoGrid()

pdf(sprintf("%s/Treg_cl2_FlashierDGE.pdf",out_dir), 7, 7, useDingbats = F)
res_list[["Tregcl2Cancer_vs_Baseline"]]$p1 + NoGrid()
res_list[["Tregcl2Cancer_vs_Baseline"]]$p2 + NoGrid()
res_list[["Tregcl2Cancer_vs_OtherPerturb"]]$p1 + NoGrid()
res_list[["Tregcl2Cancer_vs_OtherPerturb"]]$p2 + NoGrid()
res_list[["Tregcl2PerturbNotCancer_vs_Baseline"]]$p1 + NoGrid()
res_list[["Tregcl2PerturbNotCancer_vs_Baseline"]]$p2 + NoGrid()
print(p1)
print(p2)
print(p3)
print(p4)
dev.off()

saveRDS(res_list, sprintf("%s/Treg_cl2_FlashierDGE.Rds",out_dir) )
write.table(res_list[[1]]$diff_genes, file = sprintf("%s/Treg_cl2_FlashierDGE_%s.txt",out_dir, names(res_list)[1]), row.names = F, sep = "\t")
write.table(res_list[[2]]$diff_genes, file = sprintf("%s/Treg_cl2_FlashierDGE_%s.txt",out_dir, names(res_list)[2]), row.names = F, sep = "\t")
write.table(res_list[[2]]$diff_genes, file = sprintf("%s/Treg_cl2_FlashierDGE_%s.txt",out_dir, names(res_list)[3]), row.names = F, sep = "\t")
```

**Figure 4: cl2 across tissues**
only wt or B6-Foxp3-GFP and in tissues with at least 20 Treg_cl2

Treg_cl2 vs all others clusters
Treg_cl2 in each tissue vs Treg_cl1 in Spleen: works better to show that the Treg_cl2 signature is present across tissues
```{r}
organs_selected = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("baseline") & genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)")) %>% count(organ_simplified) %>% filter(n > 20) %>% pull(organ_simplified) %>% as.character()

mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% count(organ_simplified)

res_list = list()

group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% pull(cellID) 
group2 = mdata_orig %>% filter(!annotation_level2 %in% c("Treg_cl2", "Treg_prolif", "Treg_miniverse")  & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% pull(cellID) 
length(group1)
length(group2)
res_list[["Treg_cl2_vs_all"]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("%s vs other Tregs","Treg_cl2"))
# res_list[["Treg_cl2_vs_all"]]$p2
# res_list[["Treg_cl2_vs_all"]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)

orgs = list(c("spleen", "LN"),
            c("colon LP"),
            c("small intestine LP"),
            c("lung"),
            c("bone marrow"),
            c("thymus"),
            c("peritoneal cavity"),
            c("skin"),
            c("kidney")
            )
group2 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl1") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% c("spleen")) %>% pull(cellID) 
for (i in orgs) {
    print(sprintf("Treg_cl2 %s vs Treg_cl1 spleen",paste(i, collapse = "")))
    group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                                        condition_detailed_simplified %in% c("baseline") & 
                                        genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                                        organ_simplified %in% i) %>% pull(cellID)  
    res_list[[sprintf("Treg_cl2_%s_vs_Tregcl1Spleen", paste(i, collapse = ""))]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("Treg_cl2 %s vs Treg_cl1 spleen",paste(i, collapse = "")))
    # res_list[[sprintf("Treg_cl2_%s_vs_ColonLP", paste(i, collapse = ""))]]$p2
    # res_list[[sprintf("Treg_cl2_%s_vs_ColonLP", paste(i, collapse = ""))]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)
    
}

pdf(sprintf("%s/Treg_cl2_Tissue_vsTregcl1Spleen_FlashierDGE.pdf",out_dir), 7, 7, useDingbats = F)
for (i in 1:length(res_list)) {
    print(i)
    print(res_list[[i]]$p1 + NoGrid())
    print(res_list[[i]]$p2 + NoGrid())
}
dev.off()

saveRDS(res_list, sprintf("%s/Treg_cl2_Tissue_vsTregcl1Spleen_FlashierDGE.Rds",out_dir) )
# for (i in 1:length(res_list)) {
#     print(i)
#     write.table(res_list[[i]]$diff_genes, file = sprintf("%s/Treg_cl2_Tissue_vsTregcl1Spleen_FlashierDGE_%s.txt",out_dir, names(res_list)[i]), row.names = F, sep = "\t")
# }


### Heatmap
genes_to_plot = list()
for (i in 1:length(res_list)) {
    print(names(res_list)[i])
    genes_to_plot[[names(res_list)[i]]] = res_list[[i]]$diff_genes %>% filter(log2FC > 1) %>% arrange(desc(abs(log2FC))) %>% pull(SYMBOL)
}
# res_list[[i]]$diff_genes %>% filter(log2FC > 0.5) %>% arrange(desc(abs(log2FC))) %>% pull(SYMBOL)

res_merged_log2FC = data.frame(res_list[[1]]$diff_genes$log2FC)
for (i in 2:length(res_list)) {
    res_merged_log2FC = data.frame(res_merged_log2FC, res_list[[i]]$diff_genes$log2FC)
}
colnames(res_merged_log2FC) = names(res_list)
rownames(res_merged_log2FC) = res_list[[1]]$diff_genes$SYMBOL

library(pheatmap)
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(100))
pdf(sprintf("%s/Treg_cl2_Tissue_vsTregcl1Spleen_FlashierDGE_Heatmap.pdf",out_dir), 10, 20, useDingbats = F)
pheatmap(mat = as.matrix(res_merged_log2FC)[unlist(genes_to_plot) %>% unique(),], breaks = seq(-5,5,length.out = length(ColorRamp)+1), col = ColorRamp)
# pheatmap(mat = as.matrix(res_merged_log2FC)[unlist(genes_to_plot[-1]) %>% unique(),-1], breaks = seq(-5,5,length.out = length(ColorRamp)+1), col = ColorRamp)
# res_merged_log2FC2 = as.matrix(res_merged_log2FC)
# res_merged_log2FC2[abs(res_merged_log2FC) < 0.5] = 0

##If wanted to do a DotPlotHeatmap
library(tidyverse)
# mat <- as.matrix(res_merged_log2FC2)[unlist(genes_to_plot[-1]) %>% unique(),-1]
mat <- as.matrix(res_merged_log2FC)[unlist(genes_to_plot) %>% unique(),]
df <- as.data.frame(mat) %>%
  rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "contrast", values_to = "log2FC")

# (optional) order rows/cols by hierarchical clustering like a heatmap
row_ord <- rownames(mat)[hclust(dist(mat))$order]
col_ord <- colnames(mat)[hclust(dist(t(mat)))$order]
df <- df %>%
  mutate(gene     = factor(gene,     levels = rev(row_ord)),   # rev to match heatmap top→bottom
         contrast = factor(contrast, levels = col_ord))

# color/size mapping (cap color limits if you like)
lims <- c(-3, 3)  # change as needed
df <- df %>% mutate(
  log2FC_cap = pmax(pmin(log2FC, lims[2]), lims[1]),
  mag        = abs(log2FC_cap)
)

ggplot(df, aes(x = contrast, y = gene)) +
  geom_point(aes(colour = log2FC_cap, size = mag)) +
  scale_colour_gradient2(low = "blue", mid = "white", high = "red",
                         midpoint = 0, limits = lims, oob = scales::squish,
                         name = "log2FC") +
  scale_size_area(max_size = 6, name = "|log2FC|") +  # area ∝ magnitude
  theme_minimal(base_size = 11) +
  theme(
    axis.title = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )
dev.off()


##If wanted to do a DotPlot but the plot is too complicated..
sub_cells = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)")) %>% pull(cellID)

so2 = so[,sub_cells] %>% NormalizeData()

MyDotPlot(object = so2, genes_to_plot[1], assay = "RNA", group.by = "organ_simplified", dot.scale = 6, scale = T, scale.by = "radius",point.shape = 21, alpha.range = c(0, 1), show.alpha.legend = F)  + 
    labs(subtitle = topic, x = NULL) +
    scale_fill_gradientn(colours =  colorRampPalette(c("grey",'white',mypal_topics[topic]))(10)) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + coord_flip()



```

(Treg_cl2 in each tissue vs Treg_cl2 in Colon LP: using colon cl2 as reference is a bit messy as some are up and some are down from the colon. Was better to use Treg_cl1 as a reference)
```{r}
organs_selected = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("baseline") & genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)")) %>% count(organ_simplified) %>% filter(n > 20) %>% pull(organ_simplified) %>% as.character()

mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% count(organ_simplified)

res_list = list()

group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% pull(cellID) 
group2 = mdata_orig %>% filter(!annotation_level2 %in% c("Treg_cl2", "Treg_prolif", "Treg_miniverse")  & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% pull(cellID) 
length(group1)
length(group2)
res_list[["Treg_cl2_vs_all"]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("%s vs other Tregs","Treg_cl2"))
# res_list[["Treg_cl2_vs_all"]]$p2
# res_list[["Treg_cl2_vs_all"]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)

orgs = list(c("spleen", "LN"),
            c("small intestine LP"),
            c("lung"),
            c("bone marrow"),
            c("thymus"),
            c("peritoneal cavity"),
            c("skin"),
            c("kidney")
            )

group2 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% c("colon LP")) %>% pull(cellID) 
for (i in orgs) {
    print(sprintf("Treg_cl2 %s vs colon LP",paste(i, collapse = "")))
    group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                                        condition_detailed_simplified %in% c("baseline") & 
                                        genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                                        organ_simplified %in% i) %>% pull(cellID)  
    res_list[[sprintf("Treg_cl2_%s_vs_ColonLP", paste(i, collapse = ""))]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("Treg_cl2 %s vs colon LP",paste(i, collapse = "")))
    # res_list[[sprintf("Treg_cl2_%s_vs_ColonLP", paste(i, collapse = ""))]]$p2
    # res_list[[sprintf("Treg_cl2_%s_vs_ColonLP", paste(i, collapse = ""))]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)
    
}


pdf(sprintf("%s/Treg_cl2_Tissue_vsColonLP_FlashierDGE.pdf",out_dir), 7, 7, useDingbats = F)
for (i in 1:length(res_list)) {
    print(i)
    print(res_list[[i]]$p1 + NoGrid())
    print(res_list[[i]]$p2 + NoGrid())
}
dev.off()

saveRDS(res_list, sprintf("%s/Treg_cl2_Tissue_vsColonLP_FlashierDGE.Rds",out_dir) )
# for (i in 1:length(res_list)) {
#     print(i)
#     write.table(res_list[[i]]$diff_genes, file = sprintf("%s/Treg_cl2_Tissue_vsColonLP_FlashierDGE_%s.txt",out_dir, names(res_list)[i]), row.names = F, sep = "\t")
# }


### DotPlot
genes_to_plot = list()
for (i in 1:length(res_list)) {
    print(names(res_list)[i])
    genes_to_plot[[names(res_list)[i]]] = res_list[[i]]$diff_genes %>% filter(log2FC > 1) %>% arrange(desc(abs(log2FC))) %>% pull(SYMBOL)
}
# res_list[[i]]$diff_genes %>% filter(log2FC > 0.5) %>% arrange(desc(abs(log2FC))) %>% pull(SYMBOL)

res_merged_log2FC = data.frame(res_list[[1]]$diff_genes$log2FC)
for (i in 2:length(res_list)) {
    res_merged_log2FC = data.frame(res_merged_log2FC, res_list[[i]]$diff_genes$log2FC)
}
colnames(res_merged_log2FC) = names(res_list)
rownames(res_merged_log2FC) = res_list[[1]]$diff_genes$SYMBOL

pdf(sprintf("%s/Treg_cl2_Tissue_vsColonLP_FlashierDGE_Heatmap.pdf",out_dir), 10, 20, useDingbats = F)
library(pheatmap)
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(100))
pheatmap(mat = as.matrix(res_merged_log2FC)[unlist(genes_to_plot) %>% unique(),], breaks = seq(-5,5,length.out = length(ColorRamp)+1), col = ColorRamp)
pheatmap(mat = as.matrix(res_merged_log2FC)[unlist(genes_to_plot[-1]) %>% unique(),-1], breaks = seq(-5,5,length.out = length(ColorRamp)+1), col = ColorRamp)
# res_merged_log2FC2 = as.matrix(res_merged_log2FC)
# res_merged_log2FC2[abs(res_merged_log2FC) < 0.5] = 0


library(tidyverse)
mat <- as.matrix(res_merged_log2FC2)[unlist(genes_to_plot[-1]) %>% unique(),-1]
mat <- as.matrix(res_merged_log2FC)[unlist(genes_to_plot) %>% unique(),]
df <- as.data.frame(mat) %>%
  rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "contrast", values_to = "log2FC")

# (optional) order rows/cols by hierarchical clustering like a heatmap
row_ord <- rownames(mat)[hclust(dist(mat))$order]
col_ord <- colnames(mat)[hclust(dist(t(mat)))$order]
df <- df %>%
  mutate(gene     = factor(gene,     levels = rev(row_ord)),   # rev to match heatmap top→bottom
         contrast = factor(contrast, levels = col_ord))

# color/size mapping (cap color limits if you like)
lims <- c(-3, 3)  # change as needed
df <- df %>% mutate(
  log2FC_cap = pmax(pmin(log2FC, lims[2]), lims[1]),
  mag        = abs(log2FC_cap)
)

ggplot(df, aes(x = contrast, y = gene)) +
  geom_point(aes(colour = log2FC_cap, size = mag)) +
  scale_colour_gradient2(low = "blue", mid = "white", high = "red",
                         midpoint = 0, limits = lims, oob = scales::squish,
                         name = "log2FC") +
  scale_size_area(max_size = 6, name = "|log2FC|") +  # area ∝ magnitude
  theme_minimal(base_size = 11) +
  theme(
    axis.title = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )

dev.off()



```


Treg_cl8 vs all others clusters
Treg_cl8 in each tissue vs Treg_cl1 in Spleen: works better to show that the Treg_cl2 signature is present across tissues

```{r}
mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl8") & condition_detailed_simplified %in% c("baseline") & genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)")) %>% count(organ_simplified)
organs_selected = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl8") & condition_detailed_simplified %in% c("baseline") & genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)")) %>% count(organ_simplified) %>% filter(n > 20) %>% pull(organ_simplified) %>% as.character()

mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl8") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% count(organ_simplified)

res_list = list()

group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl8") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% pull(cellID) 
group2 = mdata_orig %>% filter(!annotation_level2 %in% c("Treg_cl8", "Treg_prolif", "Treg_miniverse")  & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% pull(cellID) 
length(group1)
length(group2)
res_list[["Treg_cl8_vs_all"]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("%s vs other Tregs","Treg_cl8"))
# res_list[["Treg_cl8_vs_all"]]$p2
# res_list[["Treg_cl8_vs_all"]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)

orgs = list(c("spleen", "LN"),
            c("colon LP"),
            c("small intestine LP"),
            c("lung"),
            c("bone marrow"),
            c("skin")
            )
group2 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl1") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% c("spleen")) %>% pull(cellID) 

for (i in orgs) {
    print(sprintf("Treg_cl8 %s vs Treg_cl1 spleen",paste(i, collapse = "")))
    group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl8") & 
                                        condition_detailed_simplified %in% c("baseline") & 
                                        genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                                        organ_simplified %in% i) %>% pull(cellID)  
    res_list[[sprintf("Treg_cl8_%s_vs_Tregcl1Spleen", paste(i, collapse = ""))]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("Treg_cl8 %s vs Treg_cl1 spleen",paste(i, collapse = "")))
    # res_list[[sprintf("Treg_cl8_%s_vs_ColonLP", paste(i, collapse = ""))]]$p2
    # res_list[[sprintf("Treg_cl8_%s_vs_ColonLP", paste(i, collapse = ""))]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)
    
}

pdf(sprintf("%s/Treg_cl8_Tissue_vsTregcl1Spleen_FlashierDGE.pdf",out_dir), 7, 7, useDingbats = F)
for (i in 1:length(res_list)) {
    print(i)
    print(res_list[[i]]$p1 + NoGrid())
    print(res_list[[i]]$p2 + NoGrid())
}
dev.off()

saveRDS(res_list, sprintf("%s/Treg_cl8_Tissue_vsTregcl1Spleen_FlashierDGE.Rds",out_dir) )
# for (i in 1:length(res_list)) {
#     print(i)
#     write.table(res_list[[i]]$diff_genes, file = sprintf("%s/Treg_cl8_Tissue_vsTregcl1Spleen_FlashierDGE_%s.txt",out_dir, names(res_list)[i]), row.names = F, sep = "\t")
# }


### Heatmap
genes_to_plot = list()
for (i in 1:length(res_list)) {
    print(names(res_list)[i])
    genes_to_plot[[names(res_list)[i]]] = res_list[[i]]$diff_genes %>% filter(log2FC > 1) %>% arrange(desc(abs(log2FC))) %>% pull(SYMBOL)
}
# res_list[[i]]$diff_genes %>% filter(log2FC > 0.5) %>% arrange(desc(abs(log2FC))) %>% pull(SYMBOL)

res_merged_log2FC = data.frame(res_list[[1]]$diff_genes$log2FC)
for (i in 2:length(res_list)) {
    res_merged_log2FC = data.frame(res_merged_log2FC, res_list[[i]]$diff_genes$log2FC)
}
colnames(res_merged_log2FC) = names(res_list)
rownames(res_merged_log2FC) = res_list[[1]]$diff_genes$SYMBOL

library(pheatmap)
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(100))
pdf(sprintf("%s/Treg_cl8_Tissue_vsTregcl1Spleen_FlashierDGE_Heatmap.pdf",out_dir), 10, 20, useDingbats = F)
pheatmap(mat = as.matrix(res_merged_log2FC)[unlist(genes_to_plot) %>% unique(),], breaks = seq(-5,5,length.out = length(ColorRamp)+1), col = ColorRamp)
# pheatmap(mat = as.matrix(res_merged_log2FC)[unlist(genes_to_plot[-1]) %>% unique(),-1], breaks = seq(-5,5,length.out = length(ColorRamp)+1), col = ColorRamp)
# res_merged_log2FC2 = as.matrix(res_merged_log2FC)
# res_merged_log2FC2[abs(res_merged_log2FC) < 0.5] = 0

##If wanted to do a DotPlotHeatmap
library(tidyverse)
# mat <- as.matrix(res_merged_log2FC2)[unlist(genes_to_plot[-1]) %>% unique(),-1]
mat <- as.matrix(res_merged_log2FC)[unlist(genes_to_plot) %>% unique(),]
df <- as.data.frame(mat) %>%
  rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "contrast", values_to = "log2FC")

# (optional) order rows/cols by hierarchical clustering like a heatmap
row_ord <- rownames(mat)[hclust(dist(mat))$order]
col_ord <- colnames(mat)[hclust(dist(t(mat)))$order]
df <- df %>%
  mutate(gene     = factor(gene,     levels = rev(row_ord)),   # rev to match heatmap top→bottom
         contrast = factor(contrast, levels = col_ord))

# color/size mapping (cap color limits if you like)
lims <- c(-3, 3)  # change as needed
df <- df %>% mutate(
  log2FC_cap = pmax(pmin(log2FC, lims[2]), lims[1]),
  mag        = abs(log2FC_cap)
)

ggplot(df, aes(x = contrast, y = gene)) +
  geom_point(aes(colour = log2FC_cap, size = mag)) +
  scale_colour_gradient2(low = "blue", mid = "white", high = "red",
                         midpoint = 0, limits = lims, oob = scales::squish,
                         name = "log2FC") +
  scale_size_area(max_size = 6, name = "|log2FC|") +  # area ∝ magnitude
  theme_minimal(base_size = 11) +
  theme(
    axis.title = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )
dev.off()


```










