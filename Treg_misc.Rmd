---
title: "Treg_misc"
output: html_document
date: "2025-05-28"
author: "David Zemmour"
editor_options: 
  chunk_output_type: console
---

**Initialize: load libraries and custom functions**

```{bash}
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=jfkfloor2 --qos=jfkfloor2 --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=beagle3-bigmem --nodes=1 
sinteractive --exclusive --time=12:00:00 --account=pi-zemmour --partition=zemmour-hm --qos=zemmour --nodes=1 
sinteractive --time=03:00:00 --account=pi-zemmour --partition=caslake --nodes=1 --mem=96GB

module load python/anaconda-2022.05 
module load hdf5/1.12.0 #for BPCells but also others
module load openblas/0.3.13
source activate /project/zemmour/david/envs/scvi_20240315
#source activate /project/zemmour/david/envs/r443
module load openblas/0.3.13

cd /project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg
R
```


```{r}
# setwd("~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/Treg")
libs = c("ZemmourLib","gridExtra","stringr", "patchwork", "Matrix", "Seurat", "ggplot2", "dplyr", "reshape2", "ggrastr","scattermore", "RColorBrewer", "pals", "scales", "pheatmap", "rafalib") 
sapply(libs, function(x) suppressMessages(suppressWarnings(library(x, character.only = TRUE, quietly = T, warn.conflicts  = F))))
#source("/project/jfkfloor2/zemmourlab/david/immgent/immgent_integration_git/custom_functions_david.R")

ColorRamp = rev(colorRampPalette(brewer.pal(n = 7,name = "RdYlBu"))(100))
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(20))
ColorRamp = rev(rainbow(10, end = 4/6))
ColorRamp = rev(viridis(100))
ColorRamp = brewer.pal(9, "Blues")

#mycol = c("black","blue","red","darkgreen", "orange","purple", "cyan", "greenyellow",    "salmon", "magenta","pink", "tan", "brown") # c("magenta", "red",  "darkgreen", "cyan", "blue", "blue", "blue", "black", "blue", "blue", "blue", "blue", "orange")

mypal_level2 = immgent_colors$level2
mypal_level2["not classified"] = "black"
mypal_level1 = immgent_colors$level1
mypal_level1["not classified"] = "black"
mypal_organ = immgent_colors$organ_simplified

#Large Color palette
library("pals")
n = 70
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
mypal1 = unique(unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals))))
mypal1 = mypal1[-4]
mypal = c(glasbey(), polychrome(), mypal1)
names(mypal) = NULL
#pal.bands(mypal, main="Colormap suggestions")
# mypal_organ = setNames(mypal, unique(so$organ_simplified))
# mypal_organ = mypal_organ[!is.na(names(mypal_organ))]
# mypal_level1 = setNames(mypal, unique(so$annotation_level1))
# mypal_level1 = mypal_level1[!is.na(names(mypal_level1))]
# mypal_level2 = setNames(mypal, unique(so_orig$annotation_level2))
# mypal_level2 = mypal_level2[!is.na(names(mypal_level2))]
# mypal_level2["CD4_cl18"] = "blue"
mypal_igt = setNames(mypal, unique(so$IGT))
mypal_igt = mypal_igt[!is.na(names(mypal_igt))]



```

```{r}
fig_dir = "~/google_drive_uchicago/ImmgenT/20250109_freeze/Treg/paper_Treg/figures/bits_david"
fig_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg/paper_Treg/figures/bits_david"

out_dir = "~/google_drive_uchicago/ImmgenT/analysis/data_integration/IGT1_96/Treg/misc" 
out_dir = "/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg/misc"

```


**Most up-to-date data**
on Midway
```{r}

# so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250513_clean.Rds") 
so_orig = readRDS("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/igt1_96_withtotalvi20250710_clean.Rds") 
so_orig$annotation_level2[so_orig$annotation_level2 == "Treg_cl7"] = "Treg_cl1"

so =  so_orig[,so_orig$annotation_level1 == "Treg"]
so$annotation_level2 = factor(so$annotation_level2, levels = c("Treg_cl1", "Treg_cl3", "Treg_cl6", "Treg_cl2","Treg_cl8","Treg_cl4", "Treg_prolif", "Treg_miniverse"))
```

on Desktop
```{r}
#source('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/analysis/immgent_integration_git/custom_functions_david.R') -->
# tt_list = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/analysis/data_integration/IGT1_96/Treg/DGE_limma/20250109/ttlist_OneVsAll.Rds')

so_orig = readRDS("../igt1_96_withtotalvi20250710_clean_ADTonly.Rds")
so = so_orig[,so_orig$annotation_level1 == "Treg"]
so_orig$annotation_level2[so_orig$annotation_level2 == "Treg_cl7"] = "Treg_cl1"
so$annotation_level2 = factor(so$annotation_level2, levels = c("Treg_cl1", "Treg_cl3", "Treg_cl6", "Treg_cl2","Treg_cl8","Treg_cl4", "Treg_prolif", "Treg_miniverse"))

```


Load GP: L1 and F1
```{r}
library("flashier")
prefix = "topic"
prefix2 = "flashier20250215_alldata_backfit"
fit_flash = readRDS(sprintf("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/%s/%s/fit.Rds", prefix,prefix2))
fit = fit_flash

res = ldf(fit, type = "i")
L1 = with(res, L %*% diag(D)  ) #same as res$L %*% diag(res$D)
L1 = L1[colnames(so),]
all(colnames(so) == rownames(L1))
any(is.na(L1))
colnames(L1) = sprintf("F%s", 1:ncol(L1))
# sub_cells = sample(colnames(so_orig), 1500, replace = F)
# sub_cells = c(sample(colnames(so_orig)[so_orig$annotation_level1 %in% "Treg"], 1500, replace = F), sample(colnames(so_orig)[!so_orig$annotation_level1 %in% "Treg"], 1500, replace = F))
# sub_cells = c(so_orig@meta.data %>% filter(annotation_level1 == "Treg") %>% slice_sample(n = 1500, replace = FALSE) %>% pull(cellID),
#               so_orig@meta.data %>% filter(annotation_level1 != "Treg") %>% group_by(annotation_level1) %>% slice_sample(n = 100, replace = FALSE) %>% ungroup() %>% pull(cellID))

F1 = with(ldf(fit, type = "i"), F)
colnames(F1) = paste("F", 1:ncol(F1), sep = "")


# mdata_orig = read.table("metadata_20250513_mde.txt", header = T, sep = "\t")
mdata_orig = so@meta.data
```


Counting cells
```{r}
library(dplyr)

target_organs <- c("blood", "spleen", "LN", "thymus")

nlt = so_orig@meta.data %>% filter(annotation_level1 == "Treg" & !(organ_simplified %in% target_organs)) %>% count(name = "total_cells")

tot= so_orig@meta.data %>% filter(annotation_level1 == "Treg") %>% count(name = "total_cells")
(nlt)/tot
so_orig@meta.data %>% filter(annotation_level1 == "Treg") %>% distinct(IGTHT) %>% nrow()
```


**FCFC plots**
```{r}
source('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/analysis/immgent_integration_git/custom_functions_david.R')

tt_list = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/analysis/data_integration/IGT1_96/Treg/DGE_limma/20250109/ttlist_OneVsAll.Rds')

names(tt_list)


# Create the vplot dataframe with fold changes
vplot = data.frame(fc1 = exp(tt_list$CD8_cl10_vs_All$logFC), fc2 = exp(tt_list$CD8_cl11_vs_All$logFC), SYMBOL = tt_list$CD8_cl10_vs_All$SYMBOL)

# Identify genes with large fold changes (>2)
genes_to_plot = abs(tt_list$CD8_cl10_vs_All$logFC) > 0.69 | abs(tt_list$CD8_cl11_vs_All$logFC) > 0.69
# genes_to_label = vplot[genes_to_plot, ]
genes_to_label = vplot$SYMBOL[genes_to_plot]

# Create the plot
FCFCplot(vplot, 
         xlab = "FC for CD8_cl10", 
         ylab = "FC for CD8_cl11", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = genes_to_label)

FCFCplot(vplot, 
         xlab = "FC for CD8_cl10", 
         ylab = "FC for CD8_cl11", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = NULL)

vplot = data.frame(fc1 = exp(tt_list$CD8_cl10_vs_All$logFC), fc2 = exp(tt_list$CD8_cl7_vs_All$logFC), SYMBOL = tt_list$CD8_cl10_vs_All$SYMBOL)
# Identify genes with large fold changes (>2)
genes_to_plot = abs(tt_list$CD8_cl10_vs_All$logFC) > 0.69 | abs(tt_list$CD8_cl7_vs_All$logFC) > 0.69
genes_to_label = vplot[genes_to_plot, ]
# Create the plot
FCFCplot(vplot, 
         xlab = "FC for CD8_cl10", 
         ylab = "FC for CD8_cl7", 
         main = "Fold Change vs Fold Change", 
         printgeomtext = T, 
         genes_to_label = genes_to_label)



```

**MDE plots**
```{r}
o = unique(so$organ_simplified)

pdf("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg/MDE_organs_20250528.pdf", width = 10, height = 10, useDingbats = F)
for (o in unique(so$organ_simplified)) {
    print(o)
    p = MyDimPlotHighlight(seurat_object = so[,so$condition_broad == "healthy"], umap_to_plot = "mde_incremental", cells_to_highlight = colnames(so)[which(so$organ_simplified %in% o)], highlight_column_name = "annotation_level2", pixels = c(512, 512), mycols = mypal_level2, title = o, highlight_size = 0.5, highlight_alpha = 0.5, print_plot1 = T, print_plot2 = T, labelclusters = T)
    print(p)
}
dev.off()


pdf("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg/MDE_organs_20250528.pdf", width = 10, height = 20, useDingbats = F)
# p = DimPlot(so[,so$condition_broad == "healthy"], reduction = "mde_incremental", group.by = "annotation_level2", split.by = "organ_simplified", raster = F, raster.dpi = c(512,512), label = F, pt.size = 0.5, ncol = 3) + scale_color_manual(values = mypal_level2)
# p + NoLegend()
p = DimPlot(so, reduction = "mde_incremental", group.by = "annotation_level2", split.by = "organ_simplified", raster = F, raster.dpi = c(512,512), label = F, pt.size = 0.2, ncol = 3) + scale_color_manual(values = mypal_level2)
p + NoLegend()
dev.off()

```


```{r}

pdf(sprintf("%s/MDE_Tregs.pdf",fig_dir), 5, 5, useDingbats = F)
DimPlot(so, reduction = "mde_incremental_level2", group.by = "annotation_level2", cols = mypal_level2, raster = T, raster.dpi = c(512,512), pt.size = 1, alpha = 1)
DimPlot(so, reduction = "mde_incremental_level2", group.by = "annotation_level2", cols = mypal_level2, raster = T, raster.dpi = c(512,512), pt.size = 1, alpha = 1) + NoLegend()
dev.off()

```




**Feature plots**
```{r}
so = so[,so$cite_seq]
so = NormalizeData(so,assay = "RNA", normalization.method = "LogNormalize",verbose = T)
so = NormalizeData(so,assay = "ADT", normalization.method = "LogNormalize",verbose = T)

pdf("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg/MDE_CD62L_20250528.pdf", width = 7, height = 7, useDingbats = F)
FeaturePlot(so, reduction = "mde_incremental", slot = "data", features = "CD62L", order = T, raster = F, raster.dpi = c(512,512))
dev.off()

pdf("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg/MyFeatureScatter_CD62LCD44_20250528.pdf", width = 7, height = 7, useDingbats = F)
for (pop in unique(so$annotation_level2)) {
    print(pop)
    feature1 = "CD62L"
    feature2 = "CD44"
    feature1_th1 = 0
    feature1_th2 = 0
    pop_split = strsplit(pop, split = ",") %>% unlist() #if interested population is a mixture of several clusters
    so@meta.data[,sprintf("is_%s", pop)] = factor(so$annotation_level2 %in% pop_split) #so@meta.data[,sprintf("is_%s", cl)] =
    p = MyFeatureScatter(so,slot = "data",feature1 = feature1, feature2 = feature2, group.by = sprintf("is_%s", pop),split.by = NULL, raster = F) + geom_vline(aes(xintercept = feature1_th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = feature1_th2), linetype="dashed", color = "brown") + ggtitle(sprintf("is_%s", pop))
    print(p)
}

dev.off()

pdf("/project/zemmour/david/ImmgenT/analysis/data_integration/IGT1_96/Treg/FeatureScatter_CD62LCD44_20250528.pdf", width = 7, height = 7, useDingbats = F)
FeatureScatter(so[,so$condition_broad == "healthy" & !so$annotation_level2 %in% c("Treg_prolif", "Treg_miniverse")],slot = "data",feature1 = "CD62L",feature2 =  "CD44", group.by = "annotation_level2", raster = F, pt.size = 0.1, split.by =  "annotation_level2", ncol = 3) + scale_color_manual(values = mypal_level2) + NoLegend() #+ geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = th2), linetype="dashed", color = "brown")
FeatureScatter(so[,so$condition_broad == "healthy" & !so$annotation_level2 %in% c("Treg_prolif", "Treg_miniverse")],slot = "data",feature1 = "CD62L",feature2 =  "CD44", group.by = "annotation_level2", raster = T, pt.size = 0.1) + scale_color_manual(values = mypal_level2) + NoLegend() #+ geom_vline(aes(xintercept = th1), linetype="dashed", color = "brown") + geom_hline(aes(yintercept = 
dev.off()

FeatureScatter(so, slot = "data", features = "CD62L", order = T, raster = T, raster.dpi = c(512,512))

```


**Barplot of cluster proportion in specific samples**

prop_data and mdata
mdata_sl1 from annotation_level2_PropPerSamplePerLevel1_withMetadata.Rds (proportion of CD8, CD4, Treg etc in each sample)
mdata_s from annotation_level2_PropPerSample.txt (proportion of total cells in the sample)
```{r}
prop_data = read.table(file = sprintf("%s/annotation_level2_PropPerSample.txt", prefix), header = T, sep = "\t" ) # --> mdata_s
prop_data = readRDS(file = sprintf("%s/annotation_level2_PropPerSamplePerLevel1_withMetadata.Rds", prefix)) %>% select(IGTHT, ends_with("ncells"), ends_with("prop")) # --> mdata_sl1
colnames(prop_data) = gsub(pattern = "gdT_52", replacement = "gdT_cl52", x = colnames(prop_data))
colnames(prop_data) = gsub(pattern = "gdT_54", replacement = "gdT_cl54", x = colnames(prop_data))

m = read.table('/Users/david/Library/CloudStorage/GoogleDrive-david.puyraimond@gmail.com/My Drive/ImmgenT/exp_id/sample_metadata/Sample_metadata_david_20250628_v10.csv',header = T, sep = ",")

# changing here and not in the original file to keep consistent with the database
colnames(m)
m$IGT_10xlane_id = NULL
m$organism_id = NULL
m$IGT = m$immgent_IGT_10xlane_id
m$immgent_IGT_10xlane_id = NULL
m$HT = m$hashtag_number
m$hashtag_number = NULL
m$sample_id = NULL
m$count_unique = NULL

m$sample_code.1 = NULL

mdata = merge(prop_data, m, by.x = "IGTHT", by.y = "IGTHT",all.x = T, all.y = F, suffixes = c(".x", ""))

mdata$organ_simplified = factor(mdata$organ_simplified, levels = c("blood","spleen","LN","SLO","bone marrow","thymus",
                                                                   "lung", "liver", "peritoneal cavity",
                                                                   "colon epi","small intestine epi","colon LP","small intestine LP","skin",
                                                                   "mammary gland","uterus", "placenta", "prostate","submandibular gland","kidney", "pancreas","CNS","synovial fluid"))
#any(is.na(mdata$organ_simplified))

mdata$condition_detailed_simplified = factor(mdata$condition_detailed_simplified)
mdata$condition_detailed_simplified = relevel(mdata$condition_detailed_simplified, ref = "baseline")


mdata_sl1 = mdata
mdata_s = mdata

```

Treg_cl barplot samples
```{r}
mdata = mdata_sl1
mdata = mdata_s
mdata #see chunk at the beginning, from prop_data = read.table(file = sprintf("%s/annotation_level2_PropPerSample.txt", prefix), header = T, sep = "\t" ) 

mdata %>% select(ends_with(".prop")) %>% pivot_longer(
            cols      = ends_with(".prop"),
            names_to  = "population",
            values_to = "prop") %>% mutate(population = gsub(pattern = "\\.prop",replacement = "", x = population )) %>% filter(population == starts_with("Treg")) %>% pull(population) %>% unique()


for (mycl in unique(so_orig$annotation_level2[so_orig$annotation_level1 == "Treg"])) {
    print(mycl)
    want_cols = paste0(mycl, ".prop")
    tmp = mdata %>% filter(grepl(pattern = "allT|CD45p", x = target_cells_simplified) & !(condition_detailed == "baseline" & organ_simplified == "spleen") ) %>% select(sample_code,any_of(want_cols))
    # tmp = mdata %>% select(sample_code,any_of(want_cols))
    
    tmp2 = tmp %>% mutate(total_prop = rowSums(select(., ends_with(".prop")), na.rm = TRUE)) %>% arrange(desc(total_prop))
    tmp2 %>% head(50) %>% pull(sample_code)
    
    tmp2 <- tmp2 %>% 
        arrange(desc(total_prop)) %>% 
        mutate(sample_code = factor(sample_code, sample_code)) %>% 
        head(50)
    
    tmp_long <- tmp2 %>% 
        select(-total_prop) %>% 
        pivot_longer(
            cols      = -sample_code,
            names_to  = "population",
            values_to = "prop"
        ) 
    
    tmp_long$population = gsub("\\.prop","", tmp_long$population )
    tmp_long$condition_detailed_organ = mdata$condition_detailed_organ[match(tmp_long$sample_code, mdata$sample_code)]
    
    label_map = tmp_long %>% 
        distinct(sample_code, condition_detailed_organ) %>% 
        arrange(sample_code)
    lab_vec = label_map$condition_detailed_organ
    names(lab_vec) = label_map$sample_code
    
    
    # pdf(sprintf("%s/BarplotTopSamples_%s_ofTreg.pdf", fig_dir, mycl),10, 8, useDingbats = F) #all Treg
    pdf(sprintf("%s/BarplotTopSamples_%s_oftotalT.pdf", fig_dir, mycl),10, 8, useDingbats = F) #all T cells
    p = ggplot(tmp_long, aes(x = sample_code, y = prop, fill = population)) +
        geom_bar(stat = "identity") +
        scale_fill_manual(values = immgent_colors$level2) +
        scale_x_discrete(labels = lab_vec) +
        theme_minimal() +
        labs(
            x    = "Sample",
            y    = "Proportion",
            fill = "Population"
        ) +
        # ggtitle(sprintf("Top samples with Treg %s - percent of total Treg", mycl)) +
        ggtitle(sprintf("Top samples with Treg %s - percent of total cells in the sample", mycl)) +
        theme_minimal() +
        theme(
            panel.grid.major = element_blank(), # Removes major grid lines
            panel.grid.minor = element_blank(), # Removes minor grid lines
            # axis.title = element_blank(),       # Removes axis titles (e.g., "count")
            # axis.text = element_blank(),        # Removes axis labels/text (e.g., numbers on the axis)
            axis.ticks = element_blank(),        # Removes axis tick marks
            axis.text.x = element_text(angle = 45, hjust = 1)
        )
    print(p)
    dev.off()
    
}


```

**Figure 1**
General MDE with Treg highlighted
```{r}

pdf("../MDE_level1_20251907.pdf", 5, 5, useDingbats = F)
DimPlot(object = so_orig, reduction = "mde2_totalvi_20241006", group.by = "annotation_level1", cols = mypal_level1, raster = T, raster.dpi = c(1024, 1024))
DimPlot(object = so_orig, reduction = "mde2_totalvi_20241006", group.by = "annotation_level1", cols = mypal_level1, raster = T, raster.dpi = c(1024, 1024)) + ggtitle(label = NULL) + theme_void() + NoLegend()
dev.off()

dim1 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[, 1]
dim2 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[, 2]
tmp = data.frame(so_orig@meta.data, dim1 = dim1, dim2 = dim2)

pdf(sprintf("%s/MDE_level1.pdf", fig_dir), width = 5,5,useDingbats = F)
ggplot(tmp) + scattermore::geom_scattermore(aes(dim1, dim2, color = annotation_level1, alpha = annotation_level1 == "Treg"), pointsize = 1, pixels = c(512, 512)) + scale_color_manual(values = mypal_level1) + scale_alpha_manual(values = c(0.01,0.3)) + theme_minimal() + NoGrid()

ggplot(tmp) + scattermore::geom_scattermore(aes(dim1, dim2, color = annotation_level1, alpha = annotation_level1 == "Treg"), pointsize = 1, pixels = c(512, 512)) + scale_color_manual(values = mypal_level1) + scale_alpha_manual(values = c(0.01,0.3)) + theme_minimal() + NoGrid() + NoLegend()

ggplot(tmp) + scattermore::geom_scattermore(aes(dim1, dim2, color = annotation_level1, alpha = annotation_level1 == "CD4"), pointsize = 1, pixels = c(512, 512)) + scale_color_manual(values = mypal_level1) + scale_alpha_manual(values = c(0.01,0.3)) + theme_minimal() + NoGrid() + NoLegend()

ggplot(tmp) + scattermore::geom_scattermore(aes(dim1, dim2, color = annotation_level1, alpha = annotation_level1 == "CD8"), pointsize = 1, pixels = c(512, 512)) + scale_color_manual(values = mypal_level1) + scale_alpha_manual(values = c(0.01,0.3)) + theme_minimal() + NoGrid() + NoLegend()

ggplot(tmp) + scattermore::geom_scattermore(aes(dim1, dim2, color = annotation_level1, alpha = annotation_level1 == "gdT"), pointsize = 1, pixels = c(512, 512)) + scale_color_manual(values = mypal_level1) + scale_alpha_manual(values = c(0.01,0.3)) + theme_minimal() + NoGrid() + NoLegend()

ggplot(tmp) + scattermore::geom_scattermore(aes(dim1, dim2, color = annotation_level1, alpha = annotation_level1 == "CD8aa"), pointsize = 1, pixels = c(512, 512)) + scale_color_manual(values = mypal_level1) + scale_alpha_manual(values = c(0.01,0.3)) + theme_minimal() + NoGrid() + NoLegend()

ggplot(tmp) + scattermore::geom_scattermore(aes(dim1, dim2, color = annotation_level1, alpha = annotation_level1 == "DN"), pointsize = 1, pixels = c(512, 512)) + scale_color_manual(values = mypal_level1) + scale_alpha_manual(values = c(0.01,0.3)) + theme_minimal() + NoGrid() + NoLegend()

ggplot(tmp) + scattermore::geom_scattermore(aes(dim1, dim2, color = annotation_level1, alpha = annotation_level1 == "DP"), pointsize = 1, pixels = c(512, 512)) + scale_color_manual(values = mypal_level1) + scale_alpha_manual(values = c(0.01,0.5)) + theme_minimal() + NoGrid() + NoLegend()

dev.off()

# MyDimPlotHighlight(seurat_object = so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = names(which(so_orig$annotation_level1 == "Treg")), labelclusters = F, highlight_column_name = "annotation_level1", background_color = F, print_plot1 = T, print_plot2 = F, mycols = mypal_level1, pixels = c(512, 512), background_alpha = 0.1)
# 
# MyDimPlotHighlight(seurat_object = so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = names(which(so_orig$annotation_level1 == "Treg")), highlight_size = 0.5, highlight_alpha = 0.5,labelclusters = F, highlight_column_name = "annotation_level1", background_color = T, print_plot1 = T, print_plot2 = F, mycols = mypal_level1, pixels = c(512, 512), background_alpha = 0.1)
# 
# MyDimPlotHighlight(seurat_object = so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = names(which(so_orig$annotation_level1 == "CD4")), highlight_size = 0.5, highlight_alpha = 0.5,labelclusters = F, highlight_column_name = "annotation_level1", background_color = T, print_plot1 = T, print_plot2 = F, mycols = mypal_level1, pixels = c(512, 512), background_alpha = 0.1)



so = so_orig[,so_orig$annotation_level1 == "Treg" & so_orig$IGT == "IGT67"]
saveRDS(so, "~/Desktop/IGT67_Treg.Rds")

```

**Figure 7 MHCII KO**

```{r}
so_orig@meta.data %>% count(IGT, exp_name) %>% as.data.frame() %>% View()
so_orig = NormalizeData(so_orig)
so = so_orig[,so_orig$IGT %in% c("IGT91", "IGT92")]
so = NormalizeData(so)

so@meta.data %>% count(sample_code, genetics, sample_type)
so@meta.data %>% count(sample_code, condition_detailed)


pdf(sprintf("%s/MDE_IGT9192_MHC2KO_level1_20251030.pdf", out_dir), 5, 5, useDingbats = F)
sub = so_orig@meta.data %>% filter(sample_type %in% "spleen_MHCIIKO_CD4p") %>% row.names()
MyDimPlotHighlight(seurat_object = so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = sub, highlight_column_name = "annotation_level1", mycols = mypal_level1)
sub = so_orig@meta.data %>% filter(sample_type %in% "spleen_MHCIIhet_CD4p") %>% row.names()
MyDimPlotHighlight(seurat_object = so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = sub, highlight_column_name = "annotation_level1", mycols = mypal_level1)
dev.off()

MyDimPlotHighlight(seurat_object = so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = sub, highlight_column_name = "annotation_level1", mycols = mypal_level1)
sub = so_orig@meta.data %>% filter(sample_type %in% "spleen_MHCIIKO_CD4p") %>% row.names()

pdf(sprintf("%s/MyFeaturePlot_IGT9192_MHC2KO.pdf", out_dir), 5, 5, useDingbats = F)
sub = so_orig@meta.data %>% filter(sample_type %in% "spleen_MHCIIKO_CD4p") %>% row.names()
MyFeaturePlotHighlight(seurat_object = so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = sub,highlight_size = 1, feature = "Foxp3", title = "MHCIIKO")
MyFeaturePlotHighlight(seurat_object = so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = sub,highlight_size = 1, feature = "Zbtb16", title = "MHCIIKO")
sub = so_orig@meta.data %>% filter(sample_type %in% "spleen_MHCIIhet_CD4p") %>% row.names()
MyFeaturePlotHighlight(seurat_object = so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = sub,highlight_size = 1, feature = "Foxp3", title = "MHCIIhet")
MyFeaturePlotHighlight(seurat_object = so_orig, umap_to_plot = "mde2_totalvi_20241006", cells_to_highlight = sub,highlight_size = 1, feature = "Zbtb16", title = "MHCIIhet")
dev.off()

# 
# dim1 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[, 1]
# dim2 = so_orig[["mde2_totalvi_20241006"]]@cell.embeddings[, 2]
# tmp = data.frame(so_orig@meta.data, dim1 = dim1, dim2 = dim2)
# p1 = ggplot(tmp) + scattermore::geom_scattermore(aes(dim1, dim2),color = "grey", pointsize = 1, pixels = c(512, 512)) 
# 
# tmp2 = data.frame(tmp[sub,], feature = so[["RNA"]]$data["Foxp3",sub])
# p1 + geom_point(data = tmp2, aes(dim1, dim2,color = feature)) + scale_color_gradientn(colours = viridis(10)) + theme_minimal() + NoGrid()
# 
# tmp2 = data.frame(tmp[sub,], feature = so[["RNA"]]$data["Zbtb16",sub])
# p1 + geom_point(data = tmp2, aes(dim1, dim2,color = feature)) + scale_color_gradientn(colours = viridis(10)) + theme_void() + NoGrid()
# p2 = FeaturePlot(so[,sub],reduction = "mde2_totalvi_20241006", features = c("Foxp3"), cols = viridis(10)) 

tmp = so_orig@meta.data %>%
  filter(IGT %in% c("IGT91", "IGT92") & condition_detailed_simplified %in% c("MHCIIKO", "MHCIIhet")) %>%
  count(sample_code, annotation_level1, name = "n_cells") %>%      # number of cells per IGTHT × level1
  group_by(sample_code) %>%
  mutate(
    total_cells_per_sample = sum(n_cells),                        # total cells per IGTHT
    prop = n_cells / total_cells_per_sample              # proportion per annotation_level1
  ) %>%
  ungroup() %>% as.data.frame()

so_orig@meta.data %>%
    filter(grepl(pattern = "allT|CD45p", x = target_cells_simplified))  %>%
    count(sample_code, annotation_level1, name = "n_cells") %>%      # number of cells per IGTHT × level1
    group_by(sample_code) %>%
    mutate(
        total_cells_per_sample = sum(n_cells),                        # total cells per IGTHT
        prop = n_cells / total_cells_per_sample              # proportion per annotation_level1
    ) %>%
    ungroup() %>%
    group_by(annotation_level1) %>% summarize(mean(prop)) %>% as.data.frame()

# write.table(x = tmp, file = sprintf("%s/MHCKO_table.txt", out_dir), quote = F, row.names = F, sep = "\t")



```


**Figure 5: cl2 cancer vs cl2 non cancer**

```{r}
mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("B16_ACT", "PDAC", "GBMclass", "GBMmes", "KP")) %>% count(condition_detailed_simplified)
mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & !(condition_broad %in% c("healthy", "cancer"))) %>% count(condition_detailed_simplified)
mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("baseline")) %>% count(condition_detailed_simplified)

res_list = list()

group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("B16_ACT", "PDAC", "GBMclass", "GBMmes", "KP")) %>% pull(cellID)
group2 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("baseline")) %>% pull(cellID)
length(group1)
length(group2)
res_list[["Tregcl2Cancer_vs_Baseline"]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("Treg_cl2 cancer vs baseline %s",""))
# res_list[["Tregcl2Cancer_vs_Baseline"]]$p1
# res_list[["Tregcl2Cancer_vs_Baseline"]]$p2
# res_list[["Tregcl2Cancer_vs_Baseline"]]$diff_genes %>% arrange(desc(log2FC)) %>% head(50) %>% pull(SYMBOL)

group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("B16_ACT", "PDAC", "GBMclass", "GBMmes", "KP")) %>% pull(cellID)
group2 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & !(condition_broad %in% c("healthy", "cancer")))  %>% pull(cellID)
length(group1)
length(group2)
res_list[["Tregcl2Cancer_vs_OtherPerturb"]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("Treg_cl2 cancer vs other perturbations %s",""))
# res_list[["Tregcl2Cancer_vs_OtherPerturb"]]$p1
# res_list[["Tregcl2Cancer_vs_OtherPerturb"]]$p2
# res_list[["Tregcl2Cancer_vs_OtherPerturb"]]$diff_genes %>% arrange(desc(log2FC)) %>% head(50) %>% pull(SYMBOL)

group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & !(condition_broad %in% c("healthy", "cancer")))  %>% pull(cellID)
group2 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("baseline")) %>% pull(cellID)
length(group1)
length(group2)
res_list[["Tregcl2PerturbNotCancer_vs_Baseline"]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("Treg_cl2 perturbations not cancer vs baseline %s",""))
# res_list[["Tregcl2PerturbNotCancer_vs_Baseline"]]$p1
# res_list[["Tregcl2PerturbNotCancer_vs_Baseline"]]$p2
# res_list[["Tregcl2PerturbNotCancer_vs_Baseline"]]$diff_genes %>% arrange(desc(log2FC)) %>% head(50) %>% pull(SYMBOL)

all(res_list[[1]]$diff_genes$SYMBOL == res_list[[2]]$diff_genes$SYMBOL)

i = "Tregcl2Cancer_vs_Baseline"
j = "Tregcl2Cancer_vs_OtherPerturb"
vplot = data.frame(fc1 = 2^(res_list[[i]]$diff_genes$log2FC), fc2 = 2^(res_list[[j]]$diff_genes$log2FC), SYMBOL = res_list[[i]]$diff_genes$SYMBOL)
genes_to_plot = c(res_list[[i]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL), res_list[[j]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)) %>% unique()
# genes_to_label = vplot[genes_to_plot, ]
p1 = FCFCplot(vplot, 
         xlab = "Treg_cl2 cancer vs baseline", 
         ylab = "Treg_cl2 cancer vs other perturbations", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = genes_to_plot, xlimits = c(1/3, 3), ylimits = c(1/3, 3)) + NoGrid()
p2 = FCFCplot(vplot, 
         xlab = "Treg_cl2 cancer vs baseline", 
         ylab = "Treg_cl2 cancer vs other perturbations", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = NULL, xlimits = c(1/3, 3), ylimits = c(1/3, 3)) + NoGrid()

i = "Tregcl2Cancer_vs_Baseline"
j = "Tregcl2PerturbNotCancer_vs_Baseline"
vplot = data.frame(fc1 = 2^(res_list[[i]]$diff_genes$log2FC), fc2 = 2^(res_list[[j]]$diff_genes$log2FC), SYMBOL = res_list[[i]]$diff_genes$SYMBOL)
rownames(vplot) = vplot$SYMBOL
genes_to_plot = c(res_list[[i]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL), res_list[[j]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)) %>% unique()
p3 = FCFCplot(vplot, 
         xlab = "Treg_cl2 cancer vs baseline", 
         ylab = "Treg_cl2 perturbations not cancer vs baseline", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = genes_to_plot, xlimits = c(1/3, 3), ylimits = c(1/3, 3)) + NoGrid()
p4 = FCFCplot(vplot, 
         xlab = "Treg_cl2 cancer vs baseline", 
         ylab = "Treg_cl2 perturbations not cancer vs baseline", 
         main = "Fold Change vs Fold Change", 
         genes_to_label = NULL, xlimits = c(1/3, 3), ylimits = c(1/3, 3)) + NoGrid()

pdf(sprintf("%s/Treg_cl2_FlashierDGE.pdf",out_dir), 7, 7, useDingbats = F)
res_list[["Tregcl2Cancer_vs_Baseline"]]$p1 + NoGrid()
res_list[["Tregcl2Cancer_vs_Baseline"]]$p2 + NoGrid()
res_list[["Tregcl2Cancer_vs_OtherPerturb"]]$p1 + NoGrid()
res_list[["Tregcl2Cancer_vs_OtherPerturb"]]$p2 + NoGrid()
res_list[["Tregcl2PerturbNotCancer_vs_Baseline"]]$p1 + NoGrid()
res_list[["Tregcl2PerturbNotCancer_vs_Baseline"]]$p2 + NoGrid()
print(p1)
print(p2)
print(p3)
print(p4)
dev.off()

saveRDS(res_list, sprintf("%s/Treg_cl2_FlashierDGE.Rds",out_dir) )
write.table(res_list[[1]]$diff_genes, file = sprintf("%s/Treg_cl2_FlashierDGE_%s.txt",out_dir, names(res_list)[1]), row.names = F, sep = "\t")
write.table(res_list[[2]]$diff_genes, file = sprintf("%s/Treg_cl2_FlashierDGE_%s.txt",out_dir, names(res_list)[2]), row.names = F, sep = "\t")
write.table(res_list[[2]]$diff_genes, file = sprintf("%s/Treg_cl2_FlashierDGE_%s.txt",out_dir, names(res_list)[3]), row.names = F, sep = "\t")
```

**Figure 4: cl2 across tissues**
only wt or B6-Foxp3-GFP and in tissues with at least 20 Treg_cl2

Treg_cl2 vs all others clusters
Treg_cl2 in each tissue vs Treg_cl1 in Spleen: works better to show that the Treg_cl2 signature is present across tissues
```{r}
organs_selected = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("baseline") & genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)")) %>% count(organ_simplified) %>% filter(n > 20) %>% pull(organ_simplified) %>% as.character()

mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% count(organ_simplified)

res_list = list()

group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% pull(cellID) 
group2 = mdata_orig %>% filter(!annotation_level2 %in% c("Treg_cl2", "Treg_prolif", "Treg_miniverse")  & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% pull(cellID) 
length(group1)
length(group2)
res_list[["Treg_cl2_vs_all"]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("%s vs other Tregs","Treg_cl2"))
# res_list[["Treg_cl2_vs_all"]]$p2
# res_list[["Treg_cl2_vs_all"]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)

orgs = list(c("spleen", "LN"),
            c("colon LP"),
            c("small intestine LP"),
            c("lung"),
            c("bone marrow"),
            c("thymus"),
            c("peritoneal cavity"),
            c("skin"),
            c("kidney")
            )
group2 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl1") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% c("spleen")) %>% pull(cellID) 
for (i in orgs) {
    print(sprintf("Treg_cl2 %s vs Treg_cl1 spleen",paste(i, collapse = "")))
    group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                                        condition_detailed_simplified %in% c("baseline") & 
                                        genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                                        organ_simplified %in% i) %>% pull(cellID)  
    res_list[[sprintf("Treg_cl2_%s_vs_Tregcl1Spleen", paste(i, collapse = ""))]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("Treg_cl2 %s vs Treg_cl1 spleen",paste(i, collapse = "")))
    # res_list[[sprintf("Treg_cl2_%s_vs_ColonLP", paste(i, collapse = ""))]]$p2
    # res_list[[sprintf("Treg_cl2_%s_vs_ColonLP", paste(i, collapse = ""))]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)
    
}

pdf(sprintf("%s/Treg_cl2_Tissue_vsTregcl1Spleen_FlashierDGE.pdf",out_dir), 7, 7, useDingbats = F)
for (i in 1:length(res_list)) {
    print(i)
    print(res_list[[i]]$p1 + NoGrid())
    print(res_list[[i]]$p2 + NoGrid())
}
dev.off()

saveRDS(res_list, sprintf("%s/Treg_cl2_Tissue_vsTregcl1Spleen_FlashierDGE.Rds",out_dir) )
# for (i in 1:length(res_list)) {
#     print(i)
#     write.table(res_list[[i]]$diff_genes, file = sprintf("%s/Treg_cl2_Tissue_vsTregcl1Spleen_FlashierDGE_%s.txt",out_dir, names(res_list)[i]), row.names = F, sep = "\t")
# }


### Heatmap
genes_to_plot = list()
for (i in 1:length(res_list)) {
    print(names(res_list)[i])
    genes_to_plot[[names(res_list)[i]]] = res_list[[i]]$diff_genes %>% filter(log2FC > 1) %>% arrange(desc(abs(log2FC))) %>% pull(SYMBOL)
}
# res_list[[i]]$diff_genes %>% filter(log2FC > 0.5) %>% arrange(desc(abs(log2FC))) %>% pull(SYMBOL)

res_merged_log2FC = data.frame(res_list[[1]]$diff_genes$log2FC)
for (i in 2:length(res_list)) {
    res_merged_log2FC = data.frame(res_merged_log2FC, res_list[[i]]$diff_genes$log2FC)
}
colnames(res_merged_log2FC) = names(res_list)
rownames(res_merged_log2FC) = res_list[[1]]$diff_genes$SYMBOL

library(pheatmap)
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(100))
pdf(sprintf("%s/Treg_cl2_Tissue_vsTregcl1Spleen_FlashierDGE_Heatmap.pdf",out_dir), 10, 20, useDingbats = F)
pheatmap(mat = as.matrix(res_merged_log2FC)[unlist(genes_to_plot) %>% unique(),], breaks = seq(-5,5,length.out = length(ColorRamp)+1), col = ColorRamp)
# pheatmap(mat = as.matrix(res_merged_log2FC)[unlist(genes_to_plot[-1]) %>% unique(),-1], breaks = seq(-5,5,length.out = length(ColorRamp)+1), col = ColorRamp)
# res_merged_log2FC2 = as.matrix(res_merged_log2FC)
# res_merged_log2FC2[abs(res_merged_log2FC) < 0.5] = 0

##If wanted to do a DotPlotHeatmap
library(tidyverse)
# mat <- as.matrix(res_merged_log2FC2)[unlist(genes_to_plot[-1]) %>% unique(),-1]
mat <- as.matrix(res_merged_log2FC)[unlist(genes_to_plot) %>% unique(),]
df <- as.data.frame(mat) %>%
  rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "contrast", values_to = "log2FC")

# (optional) order rows/cols by hierarchical clustering like a heatmap
row_ord <- rownames(mat)[hclust(dist(mat))$order]
col_ord <- colnames(mat)[hclust(dist(t(mat)))$order]
df <- df %>%
  mutate(gene     = factor(gene,     levels = rev(row_ord)),   # rev to match heatmap top→bottom
         contrast = factor(contrast, levels = col_ord))

# color/size mapping (cap color limits if you like)
lims <- c(-3, 3)  # change as needed
df <- df %>% mutate(
  log2FC_cap = pmax(pmin(log2FC, lims[2]), lims[1]),
  mag        = abs(log2FC_cap)
)

ggplot(df, aes(x = contrast, y = gene)) +
  geom_point(aes(colour = log2FC_cap, size = mag)) +
  scale_colour_gradient2(low = "blue", mid = "white", high = "red",
                         midpoint = 0, limits = lims, oob = scales::squish,
                         name = "log2FC") +
  scale_size_area(max_size = 6, name = "|log2FC|") +  # area ∝ magnitude
  theme_minimal(base_size = 11) +
  theme(
    axis.title = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )
dev.off()


##If wanted to do a DotPlot but the plot is too complicated..
sub_cells = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)")) %>% pull(cellID)

so2 = so[,sub_cells] %>% NormalizeData()

MyDotPlot(object = so2, genes_to_plot[1], assay = "RNA", group.by = "organ_simplified", dot.scale = 6, scale = T, scale.by = "radius",point.shape = 21, alpha.range = c(0, 1), show.alpha.legend = F)  + 
    labs(subtitle = topic, x = NULL) +
    scale_fill_gradientn(colours =  colorRampPalette(c("grey",'white',mypal_topics[topic]))(10)) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + coord_flip()



```

(Treg_cl2 in each tissue vs Treg_cl2 in Colon LP: using colon cl2 as reference is a bit messy as some are up and some are down from the colon. Was better to use Treg_cl1 as a reference)
```{r}
organs_selected = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & condition_detailed_simplified %in% c("baseline") & genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)")) %>% count(organ_simplified) %>% filter(n > 20) %>% pull(organ_simplified) %>% as.character()

mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% count(organ_simplified)

res_list = list()

group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% pull(cellID) 
group2 = mdata_orig %>% filter(!annotation_level2 %in% c("Treg_cl2", "Treg_prolif", "Treg_miniverse")  & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% pull(cellID) 
length(group1)
length(group2)
res_list[["Treg_cl2_vs_all"]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("%s vs other Tregs","Treg_cl2"))
# res_list[["Treg_cl2_vs_all"]]$p2
# res_list[["Treg_cl2_vs_all"]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)

orgs = list(c("spleen", "LN"),
            c("small intestine LP"),
            c("lung"),
            c("bone marrow"),
            c("thymus"),
            c("peritoneal cavity"),
            c("skin"),
            c("kidney")
            )

group2 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% c("colon LP")) %>% pull(cellID) 
for (i in orgs) {
    print(sprintf("Treg_cl2 %s vs colon LP",paste(i, collapse = "")))
    group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                                        condition_detailed_simplified %in% c("baseline") & 
                                        genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                                        organ_simplified %in% i) %>% pull(cellID)  
    res_list[[sprintf("Treg_cl2_%s_vs_ColonLP", paste(i, collapse = ""))]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("Treg_cl2 %s vs colon LP",paste(i, collapse = "")))
    # res_list[[sprintf("Treg_cl2_%s_vs_ColonLP", paste(i, collapse = ""))]]$p2
    # res_list[[sprintf("Treg_cl2_%s_vs_ColonLP", paste(i, collapse = ""))]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)
    
}


pdf(sprintf("%s/Treg_cl2_Tissue_vsColonLP_FlashierDGE.pdf",out_dir), 7, 7, useDingbats = F)
for (i in 1:length(res_list)) {
    print(i)
    print(res_list[[i]]$p1 + NoGrid())
    print(res_list[[i]]$p2 + NoGrid())
}
dev.off()

saveRDS(res_list, sprintf("%s/Treg_cl2_Tissue_vsColonLP_FlashierDGE.Rds",out_dir) )
# for (i in 1:length(res_list)) {
#     print(i)
#     write.table(res_list[[i]]$diff_genes, file = sprintf("%s/Treg_cl2_Tissue_vsColonLP_FlashierDGE_%s.txt",out_dir, names(res_list)[i]), row.names = F, sep = "\t")
# }


### DotPlot
genes_to_plot = list()
for (i in 1:length(res_list)) {
    print(names(res_list)[i])
    genes_to_plot[[names(res_list)[i]]] = res_list[[i]]$diff_genes %>% filter(log2FC > 1) %>% arrange(desc(abs(log2FC))) %>% pull(SYMBOL)
}
# res_list[[i]]$diff_genes %>% filter(log2FC > 0.5) %>% arrange(desc(abs(log2FC))) %>% pull(SYMBOL)

res_merged_log2FC = data.frame(res_list[[1]]$diff_genes$log2FC)
for (i in 2:length(res_list)) {
    res_merged_log2FC = data.frame(res_merged_log2FC, res_list[[i]]$diff_genes$log2FC)
}
colnames(res_merged_log2FC) = names(res_list)
rownames(res_merged_log2FC) = res_list[[1]]$diff_genes$SYMBOL

pdf(sprintf("%s/Treg_cl2_Tissue_vsColonLP_FlashierDGE_Heatmap.pdf",out_dir), 10, 20, useDingbats = F)
library(pheatmap)
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(100))
pheatmap(mat = as.matrix(res_merged_log2FC)[unlist(genes_to_plot) %>% unique(),], breaks = seq(-5,5,length.out = length(ColorRamp)+1), col = ColorRamp)
pheatmap(mat = as.matrix(res_merged_log2FC)[unlist(genes_to_plot[-1]) %>% unique(),-1], breaks = seq(-5,5,length.out = length(ColorRamp)+1), col = ColorRamp)
# res_merged_log2FC2 = as.matrix(res_merged_log2FC)
# res_merged_log2FC2[abs(res_merged_log2FC) < 0.5] = 0


library(tidyverse)
mat <- as.matrix(res_merged_log2FC2)[unlist(genes_to_plot[-1]) %>% unique(),-1]
mat <- as.matrix(res_merged_log2FC)[unlist(genes_to_plot) %>% unique(),]
df <- as.data.frame(mat) %>%
  rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "contrast", values_to = "log2FC")

# (optional) order rows/cols by hierarchical clustering like a heatmap
row_ord <- rownames(mat)[hclust(dist(mat))$order]
col_ord <- colnames(mat)[hclust(dist(t(mat)))$order]
df <- df %>%
  mutate(gene     = factor(gene,     levels = rev(row_ord)),   # rev to match heatmap top→bottom
         contrast = factor(contrast, levels = col_ord))

# color/size mapping (cap color limits if you like)
lims <- c(-3, 3)  # change as needed
df <- df %>% mutate(
  log2FC_cap = pmax(pmin(log2FC, lims[2]), lims[1]),
  mag        = abs(log2FC_cap)
)

ggplot(df, aes(x = contrast, y = gene)) +
  geom_point(aes(colour = log2FC_cap, size = mag)) +
  scale_colour_gradient2(low = "blue", mid = "white", high = "red",
                         midpoint = 0, limits = lims, oob = scales::squish,
                         name = "log2FC") +
  scale_size_area(max_size = 6, name = "|log2FC|") +  # area ∝ magnitude
  theme_minimal(base_size = 11) +
  theme(
    axis.title = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )

dev.off()



```

**Figure 4: cl8 across tissues**
Treg_cl8 vs all others clusters
Treg_cl8 in each tissue vs Treg_cl1 in Spleen: works better to show that the Treg_cl2 signature is present across tissues

```{r}
mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl8") & condition_detailed_simplified %in% c("baseline") & genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)")) %>% count(organ_simplified)
organs_selected = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl8") & condition_detailed_simplified %in% c("baseline") & genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)")) %>% count(organ_simplified) %>% filter(n > 20) %>% pull(organ_simplified) %>% as.character()

mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl8") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% count(organ_simplified)

res_list = list()

group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl8") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% pull(cellID) 
group2 = mdata_orig %>% filter(!annotation_level2 %in% c("Treg_cl8", "Treg_prolif", "Treg_miniverse")  & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% organs_selected) %>% pull(cellID) 
length(group1)
length(group2)
res_list[["Treg_cl8_vs_all"]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("%s vs other Tregs","Treg_cl8"))
# res_list[["Treg_cl8_vs_all"]]$p2
# res_list[["Treg_cl8_vs_all"]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)

orgs = list(c("spleen", "LN"),
            c("colon LP"),
            c("small intestine LP"),
            c("lung"),
            c("bone marrow"),
            c("skin")
            )
group2 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl1") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% c("spleen")) %>% pull(cellID) 

for (i in orgs) {
    print(sprintf("Treg_cl8 %s vs Treg_cl1 spleen",paste(i, collapse = "")))
    group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl8") & 
                                        condition_detailed_simplified %in% c("baseline") & 
                                        genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                                        organ_simplified %in% i) %>% pull(cellID)  
    res_list[[sprintf("Treg_cl8_%s_vs_Tregcl1Spleen", paste(i, collapse = ""))]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("Treg_cl8 %s vs Treg_cl1 spleen",paste(i, collapse = "")))
    # res_list[[sprintf("Treg_cl8_%s_vs_ColonLP", paste(i, collapse = ""))]]$p2
    # res_list[[sprintf("Treg_cl8_%s_vs_ColonLP", paste(i, collapse = ""))]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)
    
}

pdf(sprintf("%s/Treg_cl8_Tissue_vsTregcl1Spleen_FlashierDGE.pdf",out_dir), 7, 7, useDingbats = F)
for (i in 1:length(res_list)) {
    print(i)
    print(res_list[[i]]$p1 + NoGrid())
    print(res_list[[i]]$p2 + NoGrid())
}
dev.off()

saveRDS(res_list, sprintf("%s/Treg_cl8_Tissue_vsTregcl1Spleen_FlashierDGE.Rds",out_dir) )
# for (i in 1:length(res_list)) {
#     print(i)
#     write.table(res_list[[i]]$diff_genes, file = sprintf("%s/Treg_cl8_Tissue_vsTregcl1Spleen_FlashierDGE_%s.txt",out_dir, names(res_list)[i]), row.names = F, sep = "\t")
# }


### Heatmap
genes_to_plot = list()
for (i in 1:length(res_list)) {
    print(names(res_list)[i])
    genes_to_plot[[names(res_list)[i]]] = res_list[[i]]$diff_genes %>% filter(log2FC > 1) %>% arrange(desc(abs(log2FC))) %>% pull(SYMBOL)
}
# res_list[[i]]$diff_genes %>% filter(log2FC > 0.5) %>% arrange(desc(abs(log2FC))) %>% pull(SYMBOL)

res_merged_log2FC = data.frame(res_list[[1]]$diff_genes$log2FC)
for (i in 2:length(res_list)) {
    res_merged_log2FC = data.frame(res_merged_log2FC, res_list[[i]]$diff_genes$log2FC)
}
colnames(res_merged_log2FC) = names(res_list)
rownames(res_merged_log2FC) = res_list[[1]]$diff_genes$SYMBOL

library(pheatmap)
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(100))
pdf(sprintf("%s/Treg_cl8_Tissue_vsTregcl1Spleen_FlashierDGE_Heatmap.pdf",out_dir), 10, 20, useDingbats = F)
pheatmap(mat = as.matrix(res_merged_log2FC)[unlist(genes_to_plot) %>% unique(),], breaks = seq(-5,5,length.out = length(ColorRamp)+1), col = ColorRamp)
# pheatmap(mat = as.matrix(res_merged_log2FC)[unlist(genes_to_plot[-1]) %>% unique(),-1], breaks = seq(-5,5,length.out = length(ColorRamp)+1), col = ColorRamp)
# res_merged_log2FC2 = as.matrix(res_merged_log2FC)
# res_merged_log2FC2[abs(res_merged_log2FC) < 0.5] = 0

##If wanted to do a DotPlotHeatmap
library(tidyverse)
# mat <- as.matrix(res_merged_log2FC2)[unlist(genes_to_plot[-1]) %>% unique(),-1]
mat <- as.matrix(res_merged_log2FC)[unlist(genes_to_plot) %>% unique(),]
df <- as.data.frame(mat) %>%
  rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "contrast", values_to = "log2FC")

# (optional) order rows/cols by hierarchical clustering like a heatmap
row_ord <- rownames(mat)[hclust(dist(mat))$order]
col_ord <- colnames(mat)[hclust(dist(t(mat)))$order]
df <- df %>%
  mutate(gene     = factor(gene,     levels = rev(row_ord)),   # rev to match heatmap top→bottom
         contrast = factor(contrast, levels = col_ord))

# color/size mapping (cap color limits if you like)
lims <- c(-3, 3)  # change as needed
df <- df %>% mutate(
  log2FC_cap = pmax(pmin(log2FC, lims[2]), lims[1]),
  mag        = abs(log2FC_cap)
)

ggplot(df, aes(x = contrast, y = gene)) +
  geom_point(aes(colour = log2FC_cap, size = mag)) +
  scale_colour_gradient2(low = "blue", mid = "white", high = "red",
                         midpoint = 0, limits = lims, oob = scales::squish,
                         name = "log2FC") +
  scale_size_area(max_size = 6, name = "|log2FC|") +  # area ∝ magnitude
  theme_minimal(base_size = 11) +
  theme(
    axis.title = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )
dev.off()


```

Figure 5

**Figure 5: cl8 in lung across conditions**

```{r}
mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl8") & organ_simplified == "lung") %>% count(condition_detailed_simplified) %>% filter(n >= 15) %>% pull(condition_detailed_simplified) %>% as.character()
cond_selected = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & organ_simplified == "lung") %>% count(condition_detailed_simplified) %>% filter(n >= 15) %>% pull(condition_detailed_simplified) %>% as.character()

res_list = list()

group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl8") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)")) %>% pull(cellID) 
group2 = mdata_orig %>% filter(!annotation_level2 %in% c("Treg_cl8", "Treg_prolif", "Treg_miniverse")  & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)")) %>% pull(cellID) 
length(group1)
length(group2)
res_list[["Treg_cl8_vs_all"]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("%s vs other Tregs","Treg_cl8"))
# res_list[["Treg_cl8_vs_all"]]$p2
# res_list[["Treg_cl8_vs_all"]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)


group2 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl1") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% c("spleen")) %>% pull(cellID) 

for (i in cond_selected) {
    print(sprintf("Treg_cl8 Lung %s vs Treg_cl1 spleen",paste(i, collapse = "")))
    group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl8") & 
                                        organ_simplified == "lung" &
                                        condition_detailed_simplified %in% i) %>% pull(cellID)  
    res_list[[sprintf("Treg_cl8_lung_%s_vs_Tregcl1Spleen", paste(i, collapse = ""))]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("Treg_cl8 Lung %s vs Treg_cl1 spleen",paste(i, collapse = "")))
    # res_list[[sprintf("Treg_cl8_lung_%s_vs_Tregcl1Spleen", paste(i, collapse = ""))]]$p2
    # res_list[[sprintf("Treg_cl8_lung_%s_vs_Tregcl1Spleen", paste(i, collapse = ""))]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)
    
}

pdf(sprintf("%s/Treg_cl8_Lung_Conditions_vsTregcl1Spleen_FlashierDGE.pdf",out_dir), 7, 7, useDingbats = F)
for (i in 1:length(res_list)) {
    print(i)
    print(res_list[[i]]$p1 + NoGrid())
    print(res_list[[i]]$p2 + NoGrid())
}
dev.off()

saveRDS(res_list, sprintf("%s/Treg_cl8_Lung_Conditions_vsTregcl1Spleen_FlashierDGE.Rds",out_dir) )
# for (i in 1:length(res_list)) {
#     print(i)
#     write.table(res_list[[i]]$diff_genes, file = sprintf("%s/Treg_cl8_Lung_Conditions_vsTregcl1Spleen_FlashierDGE_%s.txt",out_dir, names(res_list)[i]), row.names = F, sep = "\t")
# }


### Heatmap
genes_to_plot = list()
for (i in 1:length(res_list)) {
    print(names(res_list)[i])
    genes_to_plot[[names(res_list)[i]]] = res_list[[i]]$diff_genes %>% filter(log2FC > 1) %>% arrange(desc(abs(log2FC))) %>% pull(SYMBOL)
}
# res_list[[i]]$diff_genes %>% filter(log2FC > 0.5) %>% arrange(desc(abs(log2FC))) %>% pull(SYMBOL)

res_merged_log2FC = data.frame(res_list[[1]]$diff_genes$log2FC)
for (i in 2:length(res_list)) {
    res_merged_log2FC = data.frame(res_merged_log2FC, res_list[[i]]$diff_genes$log2FC)
}
colnames(res_merged_log2FC) = names(res_list)
rownames(res_merged_log2FC) = res_list[[1]]$diff_genes$SYMBOL

library(pheatmap)
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(100))
pdf(sprintf("%s/Treg_cl8_Lung_Conditions_vsTregcl1Spleen_FlashierDGE_Heatmap.pdf",out_dir), 10, 20, useDingbats = F)
pheatmap(mat = as.matrix(res_merged_log2FC)[unlist(genes_to_plot) %>% unique(),], breaks = seq(-5,5,length.out = length(ColorRamp)+1), col = ColorRamp)
# pheatmap(mat = as.matrix(res_merged_log2FC)[unlist(genes_to_plot[-1]) %>% unique(),-1], breaks = seq(-5,5,length.out = length(ColorRamp)+1), col = ColorRamp)
# res_merged_log2FC2 = as.matrix(res_merged_log2FC)
# res_merged_log2FC2[abs(res_merged_log2FC) < 0.5] = 0

##If wanted to do a DotPlotHeatmap
library(tidyverse)
# mat <- as.matrix(res_merged_log2FC2)[unlist(genes_to_plot[-1]) %>% unique(),-1]
mat <- as.matrix(res_merged_log2FC)[unlist(genes_to_plot) %>% unique(),]
df <- as.data.frame(mat) %>%
  rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "contrast", values_to = "log2FC")

# (optional) order rows/cols by hierarchical clustering like a heatmap
row_ord <- rownames(mat)[hclust(dist(mat))$order]
col_ord <- colnames(mat)[hclust(dist(t(mat)))$order]
df <- df %>%
  mutate(gene     = factor(gene,     levels = rev(row_ord)),   # rev to match heatmap top→bottom
         contrast = factor(contrast, levels = col_ord))

# color/size mapping (cap color limits if you like)
lims <- c(-3, 3)  # change as needed
df <- df %>% mutate(
  log2FC_cap = pmax(pmin(log2FC, lims[2]), lims[1]),
  mag        = abs(log2FC_cap)
)

ggplot(df, aes(x = contrast, y = gene)) +
  geom_point(aes(colour = log2FC_cap, size = mag)) +
  scale_colour_gradient2(low = "blue", mid = "white", high = "red",
                         midpoint = 0, limits = lims, oob = scales::squish,
                         name = "log2FC") +
  scale_size_area(max_size = 6, name = "|log2FC|") +  # area ∝ magnitude
  theme_minimal(base_size = 11) +
  theme(
    axis.title = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )
dev.off()


```

**Figure 5: cl2 in lung across conditions**

```{r}
mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & organ_simplified == "lung") %>% count(condition_detailed_simplified) %>% filter(n >= 15) %>% pull(condition_detailed_simplified) %>% as.character()

cond_selected = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & organ_simplified == "lung") %>% count(condition_detailed_simplified) %>% filter(n >= 15) %>% pull(condition_detailed_simplified) %>% as.character()

res_list = list()

group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)")) %>% pull(cellID) 
group2 = mdata_orig %>% filter(!annotation_level2 %in% c("Treg_cl2", "Treg_prolif", "Treg_miniverse")  & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)")) %>% pull(cellID) 
length(group1)
length(group2)
res_list[["Treg_cl2_vs_all"]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("%s vs other Tregs","Treg_cl2"))
# res_list[["Treg_cl2_vs_all"]]$p2
# res_list[["Treg_cl2_vs_all"]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)


group2 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl1") & 
                           condition_detailed_simplified %in% c("baseline") & 
                           genetics %in% c("wt", "B6-Foxp3-GFP (B6.Cg-Foxp3tm1Kuch/J)") & 
                           organ_simplified %in% c("spleen")) %>% pull(cellID) 

for (i in cond_selected) {
    print(sprintf("Treg_cl2 Lung %s vs Treg_cl1 spleen",paste(i, collapse = "")))
    group1 = mdata_orig %>% filter( annotation_level2 %in% c("Treg_cl2") & 
                                        organ_simplified == "lung" &
                                        condition_detailed_simplified %in% i) %>% pull(cellID)  
    res_list[[sprintf("Treg_cl2_lung_%s_vs_Tregcl1Spleen", paste(i, collapse = ""))]] = FlashierDGE(F1, L1, group1, group2, title_plot = sprintf("Treg_cl2 Lung %s vs Treg_cl1 spleen",paste(i, collapse = "")))
    # res_list[[sprintf("Treg_cl2_lung_%s_vs_Tregcl1Spleen", paste(i, collapse = ""))]]$p2
    # res_list[[sprintf("Treg_cl2_lung_%s_vs_Tregcl1Spleen", paste(i, collapse = ""))]]$diff_genes %>% arrange(desc(abs(log2FC))) %>% head(50) %>% pull(SYMBOL)
    
}

pdf(sprintf("%s/Treg_cl2_Lung_Conditions_vsTregcl1Spleen_FlashierDGE.pdf",out_dir), 7, 7, useDingbats = F)
for (i in 1:length(res_list)) {
    print(i)
    print(res_list[[i]]$p1 + NoGrid())
    print(res_list[[i]]$p2 + NoGrid())
}
dev.off()

saveRDS(res_list, sprintf("%s/Treg_cl2_Lung_Conditions_vsTregcl1Spleen_FlashierDGE.Rds",out_dir) )
# for (i in 1:length(res_list)) {
#     print(i)
#     write.table(res_list[[i]]$diff_genes, file = sprintf("%s/Treg_cl2_Lung_Conditions_vsTregcl1Spleen_FlashierDGE_%s.txt",out_dir, names(res_list)[i]), row.names = F, sep = "\t")
# }


### Heatmap
genes_to_plot = list()
for (i in 1:length(res_list)) {
    print(names(res_list)[i])
    genes_to_plot[[names(res_list)[i]]] = res_list[[i]]$diff_genes %>% filter(log2FC > 1) %>% arrange(desc(abs(log2FC))) %>% pull(SYMBOL)
}
# res_list[[i]]$diff_genes %>% filter(log2FC > 0.5) %>% arrange(desc(abs(log2FC))) %>% pull(SYMBOL)

res_merged_log2FC = data.frame(res_list[[1]]$diff_genes$log2FC)
for (i in 2:length(res_list)) {
    res_merged_log2FC = data.frame(res_merged_log2FC, res_list[[i]]$diff_genes$log2FC)
}
colnames(res_merged_log2FC) = names(res_list)
rownames(res_merged_log2FC) = res_list[[1]]$diff_genes$SYMBOL

library(pheatmap)
ColorRamp = rev(colorRampPalette(c('red','white','blue'))(100))
pdf(sprintf("%s/Treg_cl2_Lung_Conditions_vsTregcl1Spleen_FlashierDGE_Heatmap.pdf",out_dir), 10, 20, useDingbats = F)
pheatmap(mat = as.matrix(res_merged_log2FC)[unlist(genes_to_plot) %>% unique(),], breaks = seq(-5,5,length.out = length(ColorRamp)+1), col = ColorRamp)
# pheatmap(mat = as.matrix(res_merged_log2FC)[unlist(genes_to_plot[-1]) %>% unique(),-1], breaks = seq(-5,5,length.out = length(ColorRamp)+1), col = ColorRamp)
# res_merged_log2FC2 = as.matrix(res_merged_log2FC)
# res_merged_log2FC2[abs(res_merged_log2FC) < 0.5] = 0

##If wanted to do a DotPlotHeatmap
library(tidyverse)
# mat <- as.matrix(res_merged_log2FC2)[unlist(genes_to_plot[-1]) %>% unique(),-1]
mat <- as.matrix(res_merged_log2FC)[unlist(genes_to_plot) %>% unique(),]
df <- as.data.frame(mat) %>%
  rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "contrast", values_to = "log2FC")

# (optional) order rows/cols by hierarchical clustering like a heatmap
row_ord <- rownames(mat)[hclust(dist(mat))$order]
col_ord <- colnames(mat)[hclust(dist(t(mat)))$order]
df <- df %>%
  mutate(gene     = factor(gene,     levels = rev(row_ord)),   # rev to match heatmap top→bottom
         contrast = factor(contrast, levels = col_ord))

# color/size mapping (cap color limits if you like)
lims <- c(-3, 3)  # change as needed
df <- df %>% mutate(
  log2FC_cap = pmax(pmin(log2FC, lims[2]), lims[1]),
  mag        = abs(log2FC_cap)
)

ggplot(df, aes(x = contrast, y = gene)) +
  geom_point(aes(colour = log2FC_cap, size = mag)) +
  scale_colour_gradient2(low = "blue", mid = "white", high = "red",
                         midpoint = 0, limits = lims, oob = scales::squish,
                         name = "log2FC") +
  scale_size_area(max_size = 6, name = "|log2FC|") +  # area ∝ magnitude
  theme_minimal(base_size = 11) +
  theme(
    axis.title = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )
dev.off()


```

**T-RBI**

Background Treg immgenT
```{r}
so_orig = readRDS("../igt1_96_withtotalvi20250710_clean_ADTonly.Rds")
so_orig[["mde_incremental_level2"]] = so_orig[["mde_incremental"]] 
so_orig[["mde_incremental_allT"]] = so_orig[["mde2_totalvi_20241006"]] 

sub_all <- so_orig@meta.data %>%
  group_by(annotation_level2) %>%
  group_modify(~ slice_sample(.x, n = min(500, nrow(.x)))) %>%
  pull(cellID)
so = so_orig[,sub_all]
so$sample = "immgent"
so$sample_type = "immgent"

so = so_orig[,so_orig$annotation_level1 == "Treg"]
so$sample = "immgent"
so$sample_type = "immgent"

DimPlot(so, reduction = "mde_incremental_level2", group.by = "annotation_level2", cols = mypal_level2)
MyDimPlotHighlight(so, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation_level2", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T)
```


GSE196338 Gut_RORg+_Tregs
```{r}
query_dir = '/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/Treg/GSE196338_Gut_RORg+_Tregs/gdT_all_TRIAL_zero_separate_SCVIs/'
so_query = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/Treg/GSE196338_Gut_RORg+_Tregs/gdT_all_TRIAL_zero_separate_SCVIs/Final_Seurat_object.Rds') 
so_query_orig = so_query

head(so_query@meta.data)

#merge replicates
so_query@meta.data %>% count(IGTHT) 
so_query$sample_type = so_query$IGTHT
so_query$sample_type = gsub(pattern = "VMNA_Maf_ko_|muscle_colon_Treg_Batch_1_|muscle_colon_Treg_Batch_2_|_1|_2|_3","", so_query$sample_type)
so_query@meta.data %>% count(IGTHT, sample_type)

#Redefine level1
so_query@meta.data %>% group_by(level2_final) %>% count() %>% as.data.frame()
so_query@meta.data %>% group_by(level1_final) %>% count() %>% as.data.frame()
so_query@meta.data %>% count(level1_final, level2_final)
so_query$level1_final_orig = so_query$level1_final
so_query$level1_final = str_extract(so_query$level2_final, "^[^_]+")
so_query@meta.data %>% count(level1_final, level2_final)

# so_query@meta.data %>% count(level2_final, level2_plot)


#filter cells wihout author's annotation
so_query@meta.data %>% group_by(annotation) %>% count() %>% as.data.frame()
so_query@meta.data %>% filter(!is.na(annotation)) %>% group_by(level2_final) %>% count() %>% as.data.frame()

so_query = so_query[,so_query@meta.data %>% filter(!is.na(annotation)) %>% row.names()]
so_query@meta.data %>% count(level1_final, level2_final)

#check that non-Tregs aren't expressing Foxp3
p1 = DimPlot(so_query, reduction = "mde_incremental_allT", group.by = "annotation", cols = mypal) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
p2 = DimPlot(so_query, reduction = "mde_incremental_allT", group.by = "level1_final", cols = mypal_level1) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
p3 = FeaturePlot(so_query, reduction = "mde_incremental_allT", features = "Foxp3", order = T) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
p1 + p2 + p3

# so_query$annotation = paste("cl", so_query$annotation, sep = "_")
so_query$sample = so_query$IGTHT

# sub = so_query@meta.data %>% filter(level1_final == "CD8" & !(level2_plot %in% c("not classified"))) %>% row.names()
# so2 = merge(so, so_query[,sub], merge.dr = T)

so2 = merge(so, so_query, merge.dr = T)
so2@meta.data %>% count(sample_type)

# mypal_annotation = setNames(c("#BFD3EA", "#689AC5", "#E59339", "#487EB5", "#6FA649", "#B9E185", "#B29A39", "#EFD374", "#649B9F", "#A9CBC2", "#D2635A", "#F3B0B0"), c("cl_0", "cl_1", "cl_2", "cl_3", "cl_4", "cl_5", "cl_6", "cl_7", "cl_8", "cl_9", "cl_10", "cl_11"))
mypal_annotation = c(cTreg_Helios = "#323E8A", 
                     cTreg_RORg = "#A8351B", 
                     mTreg_EarlyAct = "#507F4E", 
                     mTreg_ISG = "#E3D65A",
                     mTreg_RORg ="#C59926",
                     mTreg_Resting = "#759CC5",
                     mTreg_reparative = "#96979B")
# mypal_annotation = mypal
mypal_sample = mypal

sub = so2@meta.data %>% filter(sample != "immgent" & level1_final == "Treg") %>% row.names()
pdf(sprintf("%s/RBI.pdf",query_dir),10, 10, useDingbats = F)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_final", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "sample", mycols = mypal, print_plot1 = T, print_plot2 = T,labelclusters = F)
# MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F)
for (s in unique(so_query$sample_type)) {
    print(s)
    tmp = so2[,so2$sample_type %in% c(s) | so2$sample %in% c("immgent")]
    print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "level2_final", highlight_size = 1, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "annotation", highlight_size = 1, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "level2_final", highlight_size = 1, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "annotation", highlight_size = 1, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(so2[,so2$sample %in% c("immgent", s)], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample: %s", s)))
}

# p1 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "annotation", cols = mypal_annotation)
# p2 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "level2_plot", cols = mypal_level2)
# p1 + p2
dev.off() 

# pdf(sprintf("%s/RBI_sidebyside.pdf",query_dir),50, 10, useDingbats = F)
p1_author = list()
p1_immgent = list()
stacked_list = list()
for (s in unique(so_query$sample_type)) {
    print(s)
    tmp = so2[,so2$sample_type %in% c(s) | so2$sample %in% c("immgent")]
    p = MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "level2_final", highlight_size = 1, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s))
    p1_immgent[[s]] = p$plot1
    p = MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "annotation", highlight_size = 1, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s))
    p1_author[[s]] = p$plot1
    # print(p1_author[[s]] + NoGrid() + p1_immgent[[s]] + theme_void() + NoLegend() + ggtitle(label = NULL) )
    stacked_list[[s]] = wrap_plots(list(p1_author[[s]] + theme_void() + NoLegend(), 
                              p1_immgent[[s]] + theme_void() + NoLegend() + ggtitle(label = NULL) ), ncol = 1) + plot_layout(axes = "collect_x", guides = "collect") 
    # print(stacked_list[[s]])
    # print(MyDimPlotHighlight(so2[,so2$sample %in% c("immgent", s)], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample: %s", s)))
}
pdf(sprintf("%s/RBI_sidebyside.pdf",query_dir),5, 10, useDingbats = F)
# print(wrap_plots(stacked_list, nrow = 1) + plot_layout(axes = "collect_y", guides = "collect"))
print(stacked_list)
dev.off()


##UMAP from the query
so_query <- so_query %>%
  NormalizeData(normalization.method = "LogNormalize", scale.factor = 1e4, verbose = T) %>%
  FindVariableFeatures(selection.method = "vst", nfeatures = 2000, verbose = T) %>%
  ScaleData(features = VariableFeatures(.), verbose = T) %>%     # note the "."
  RunPCA(features = VariableFeatures(.), npcs = 50, verbose = T) %>%
  FindNeighbors(dims = 1:30, verbose = T) %>%
  RunUMAP(dims = 1:30, seed.use = 123, verbose = T)

pdf(sprintf("%s/RBI_UMAP_query.pdf",query_dir),10, 10, useDingbats = F)
p = DimPlot(so_query, reduction = "umap", group.by = "sample", cols = mypal)
p
p + NoLegend()
p = DimPlot(so_query, reduction = "umap", group.by = "sample_type", cols = mypal)
p
p + NoLegend()
p = DimPlot(so_query, reduction = "umap", group.by = "annotation", cols = mypal)
p
p + NoLegend()
p = DimPlot(so_query, reduction = "umap", group.by = "level1_final", cols = mypal_level1)
p
p + NoLegend()
p = DimPlot(so_query, reduction = "umap", group.by = "level2_final", cols = mypal_level2)
p
p + NoLegend()
so_query$is_not_classified = so_query$level2_final == "not classified"
p = DimPlot(so_query, reduction = "umap", group.by = "is_not_classified",cols = c("grey", "red"))
p
p + NoLegend()

dev.off()

# FeaturePlot(so_query, features = c("Cd4"))
# p1 = DimPlot(so_query[,so_query$level1_final == "CD4"], reduction = "umap", group.by = "level1_final", cols = immgent_colors$level1)
# p2 = FeaturePlot(so_query, features = c("Cd4"))
# p1+p2
# 
# so_query@meta.data %>% count(level2_final)
# DimPlot(so_query, reduction = "umap", group.by = "level2_final",cols = mypal_level2) # ggplot2::xlim(c(-8,8)) #+ ggplot2::ylim(c(-8,8))
# so_query$is_not_classified = so_query$level2_final == "not classified"
# DimPlot(so_query, reduction = "umap", group.by = "is_not_classified",cols = c("grey", "red"))
# 
# p1 = DimPlot(so_query[,so_query$level1_final == "Treg"], reduction = "umap", group.by = "level2_final", cols = immgent_colors$level2) + ggplot2::xlim(c(-8,8)) #+ ggplot2::ylim(c(-8,8))
# p2 = FeaturePlot(so_query, features = c("Foxp3")) #+ ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
# p1+p2
# 
# p1 = DimPlot(so_query[,so_query$level1_final != "not classified"], reduction = "umap", group.by = "level1_final", cols = immgent_colors$level1) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
# p2 = FeaturePlot(so_query[,so_query$level1_final != "not classified"], features = c("Foxp3")) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
# p1+p2

```

GSE248440 VAT Tregs
```{r}
query_dir = '/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/Treg/GSE248440_Adipose_Tregs_Age_diet/gdT_all_TRIAL_zero_separate_SCVIs/'
so_query = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/Treg/GSE248440_Adipose_Tregs_Age_diet/gdT_all_TRIAL_zero_separate_SCVIs/Final_Seurat_object.Rds') 
so_query_orig = so_query

head(so_query@meta.data)
so_query@meta.data %>% count(IGTHT) 

so_query = so_query_orig[,so_query@meta.data %>% filter(IGTHT %in% c("exp1_GSM7914419_A_exp1","exp2_GSM7914420_A_exp2")) %>% row.names()]

#merge replicates
so_query@meta.data %>% count(IGTHT)
so_query$sample_type = "VAT_Tregs"
# so_query$sample_type = gsub(pattern = "VMNA_Maf_ko_|muscle_colon_Treg_Batch_1_|muscle_colon_Treg_Batch_2_|_1|_2|_3","", so_query$sample_type)
so_query@meta.data %>% count(IGTHT, sample_type)

#Redefine level1
so_query@meta.data %>% count(level2_final) %>% as.data.frame()
so_query@meta.data %>% count(level1_final) %>% as.data.frame()
so_query@meta.data %>% count(level1_final, level2_final)
so_query$level1_final_orig = so_query$level1_final
so_query$level1_final = str_extract(so_query$level2_final, "^[^_]+")
so_query@meta.data %>% count(level1_final, level2_final)

# so_query@meta.data %>% count(level2_final, level2_plot)

#filter cells without author's annotation
so_query@meta.data %>% count(annotation) %>% as.data.frame()
so_query@meta.data %>% count(annotation, level2_final) %>% as.data.frame()
so_query@meta.data %>% filter(!is.na(annotation)) %>% group_by(level2_final) %>% count() %>% as.data.frame()

so_query = so_query[,so_query@meta.data %>% filter(!is.na(annotation)) %>% row.names()]

so_query$annotation[so_query$annotation == "Areg$^{hi}$ ST2$^{+}$"] = "AregHi ST2+"
so_query$annotation[so_query$annotation == "Areg$^{lo}$ ST2$^{+}$"] = "AregLo ST2+"
so_query$annotation[so_query$annotation == "Il18r1$^{+}$"] = "Il18r1+"
so_query$annotation[so_query$annotation == "Tbet$^{+}$"] = "Tbet+"
so_query@meta.data %>% count(annotation) %>% as.data.frame()

mypal_annotation = c("AregHi ST2+" = "#D0803D", 
                     "AregLo ST2+" = "#699968", 
                     "Il18r1+" = "#705694", 
                     "Tbet+" = "#5478AF",
                     "Early activation" ="#7D5D54",
                     "Quiescent" = "#AA322E",
                     "ISG" = "#DFAD80")


so_query@meta.data %>% count(level1_final, level2_final)

#check that non-Tregs aren't expressing Foxp3
p1 = DimPlot(so_query, reduction = "mde_incremental_allT", group.by = "annotation", cols = mypal) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
p2 = DimPlot(so_query, reduction = "mde_incremental_allT", group.by = "level1_final", cols = mypal_level1) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
p3 = FeaturePlot(so_query, reduction = "mde_incremental_allT", features = "Foxp3", order = T) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
p1 + p2 + p3
FeaturePlot(so_query[,so_query$level1_final != "Treg"], reduction = "mde_incremental_allT", features = "Foxp3", order = T) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
FeaturePlot(so_query[,so_query$level1_final == "Treg"], reduction = "mde_incremental_allT", features = "Foxp3", order = T) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
FeaturePlot(so_query[,so_query$level1_final == "CD4"], reduction = "mde_incremental_allT", features = "Foxp3", order = T) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))

# so_query$annotation = paste("cl", so_query$annotation, sep = "_")
so_query$sample = so_query$IGTHT

# sub = so_query@meta.data %>% filter(level1_final == "CD8" & !(level2_plot %in% c("not classified"))) %>% row.names()
# so2 = merge(so, so_query[,sub], merge.dr = T)

so2 = merge(so, so_query, merge.dr = T)
so2@meta.data %>% count(sample_type)
so2@meta.data %>% count(annotation)

# mypal_annotation = mypal
mypal_sample = mypal

sub = so2@meta.data %>% filter(sample != "immgent" & level1_final == "Treg") %>% row.names()
pdf(sprintf("%s/RBI.pdf",query_dir),10, 10, useDingbats = F)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_final", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "sample", mycols = mypal, print_plot1 = T, print_plot2 = T,labelclusters = F)
# MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F)
for (s in unique(so_query$sample_type)) {
    print(s)
    tmp = so2[,so2$sample_type %in% c(s) | so2$sample %in% c("immgent")]
    print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "level2_final", highlight_size = 1, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "annotation", highlight_size = 1, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "level2_final", highlight_size = 1, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "annotation", highlight_size = 1, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(so2[,so2$sample %in% c("immgent", s)], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample: %s", s)))
}

# p1 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "annotation", cols = mypal_annotation)
# p2 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "level2_plot", cols = mypal_level2)
# p1 + p2
dev.off() 

# pdf(sprintf("%s/RBI_sidebyside.pdf",query_dir),50, 10, useDingbats = F)
p1_author = list()
p1_immgent = list()
stacked_list = list()
for (s in unique(so_query$sample_type)) {
    print(s)
    tmp = so2[,so2$sample_type %in% c(s) | so2$sample %in% c("immgent")]
    p = MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "level2_final", highlight_size = 1, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s))
    p1_immgent[[s]] = p$plot1
    p = MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "annotation", highlight_size = 1, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s))
    p1_author[[s]] = p$plot1
    # print(p1_author[[s]] + NoGrid() + p1_immgent[[s]] + theme_void() + NoLegend() + ggtitle(label = NULL) )
    stacked_list[[s]] = wrap_plots(list(p1_author[[s]] + theme_void() + NoLegend(), 
                              p1_immgent[[s]] + theme_void() + NoLegend() + ggtitle(label = NULL) ), ncol = 1) + plot_layout(axes = "collect_x", guides = "collect") 
    # print(stacked_list[[s]])
    # print(MyDimPlotHighlight(so2[,so2$sample %in% c("immgent", s)], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample: %s", s)))
}
pdf(sprintf("%s/RBI_sidebyside.pdf",query_dir),5, 10, useDingbats = F)
# print(wrap_plots(stacked_list, nrow = 1) + plot_layout(axes = "collect_y", guides = "collect"))
print(stacked_list)
dev.off()


##UMAP from the query
so_query <- so_query %>%
  NormalizeData(normalization.method = "LogNormalize", scale.factor = 1e4, verbose = T) %>%
  FindVariableFeatures(selection.method = "vst", nfeatures = 2000, verbose = T) %>%
  ScaleData(features = VariableFeatures(.), verbose = T) %>%     # note the "."
  RunPCA(features = VariableFeatures(.), npcs = 50, verbose = T) %>%
  FindNeighbors(dims = 1:30, verbose = T) %>%
  RunUMAP(dims = 1:30, seed.use = 123, verbose = T)

pdf(sprintf("%s/RBI_UMAP_query.pdf",query_dir),10, 10, useDingbats = F)
p = DimPlot(so_query, reduction = "umap", group.by = "sample", cols = mypal)
p
p + NoLegend()
p = DimPlot(so_query, reduction = "umap", group.by = "sample_type", cols = mypal)
p
p + NoLegend()
p = DimPlot(so_query, reduction = "umap", group.by = "annotation", cols = mypal_annotation)
p
p + NoLegend()
p = DimPlot(so_query, reduction = "umap", group.by = "level1_final", cols = mypal_level1)
p
p + NoLegend()
p = DimPlot(so_query, reduction = "umap", group.by = "level2_final", cols = mypal_level2)
p
p + NoLegend()
so_query$is_not_classified = so_query$level2_final == "not classified"
p = DimPlot(so_query, reduction = "umap", group.by = "is_not_classified",cols = c("grey", "red"))
p
p + NoLegend()

dev.off()

# FeaturePlot(so_query, features = c("Cd4"))
# p1 = DimPlot(so_query[,so_query$level1_final == "CD4"], reduction = "umap", group.by = "level1_final", cols = immgent_colors$level1)
# p2 = FeaturePlot(so_query, features = c("Cd4"))
# p1+p2
# 
# so_query@meta.data %>% count(level2_final)
# DimPlot(so_query, reduction = "umap", group.by = "level2_final",cols = mypal_level2) # ggplot2::xlim(c(-8,8)) #+ ggplot2::ylim(c(-8,8))
# so_query$is_not_classified = so_query$level2_final == "not classified"
# DimPlot(so_query, reduction = "umap", group.by = "is_not_classified",cols = c("grey", "red"))
# 
# p1 = DimPlot(so_query[,so_query$level1_final == "Treg"], reduction = "umap", group.by = "level2_final", cols = immgent_colors$level2) + ggplot2::xlim(c(-8,8)) #+ ggplot2::ylim(c(-8,8))
# p2 = FeaturePlot(so_query, features = c("Foxp3")) #+ ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
# p1+p2
# 
# p1 = DimPlot(so_query[,so_query$level1_final != "not classified"], reduction = "umap", group.by = "level1_final", cols = immgent_colors$level1) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
# p2 = FeaturePlot(so_query[,so_query$level1_final != "not classified"], features = c("Foxp3")) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
# p1+p2

```

GSE234317 Meninges Tregs
```{r}
query_dir = '/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/Treg/GSE234317_Treg_Meninges/gdT_all_TRIAL_zero_separate_SCVIs/'
so_query = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/Treg/GSE234317_Treg_Meninges/gdT_all_TRIAL_zero_separate_SCVIs/Final_Seurat_object.Rds') 
so_query_orig = so_query

head(so_query@meta.data)
so_query@meta.data %>% count(IGTHT) 

so_query = so_query_orig[,so_query@meta.data %>% filter(IGTHT %in% c("Batch1_GSM7462259_Meninges_replicate1_GEX","Batch1_GSM7462262_Meninges_replicate2_GEX")) %>% row.names()]

#merge replicates
so_query@meta.data %>% count(IGTHT)
so_query$sample_type = "Meninges"
# so_query$sample_type = gsub(pattern = "VMNA_Maf_ko_|muscle_colon_Treg_Batch_1_|muscle_colon_Treg_Batch_2_|_1|_2|_3","", so_query$sample_type)
so_query@meta.data %>% count(IGTHT, sample_type)

#Redefine level1
so_query@meta.data %>% count(level2_final) %>% as.data.frame()
so_query@meta.data %>% count(level1_final) %>% as.data.frame()
so_query@meta.data %>% count(level1_final, level2_final)
so_query$level1_final_orig = so_query$level1_final
so_query$level1_final = str_extract(so_query$level2_final, "^[^_]+")
so_query@meta.data %>% count(level1_final, level2_final)

# so_query@meta.data %>% count(level2_final, level2_plot)

#filter cells without author's annotation
so_query@meta.data %>% count(annotation) %>% as.data.frame()
so_query@meta.data %>% count(annotation, level2_final) %>% as.data.frame()
so_query@meta.data %>% filter(!is.na(annotation)) %>% group_by(level2_final) %>% count() %>% as.data.frame()

so_query = so_query[,so_query@meta.data %>% filter(!is.na(annotation)) %>% row.names()]
so_query@meta.data %>% count(annotation, level2_final) %>% as.data.frame()
so_query@meta.data %>% count(annotation, level1_final) %>% as.data.frame()

# so_query$annotation[so_query$annotation == "Areg$^{hi}$ ST2$^{+}$"] = "AregHi ST2+"
# so_query$annotation[so_query$annotation == "Areg$^{lo}$ ST2$^{+}$"] = "AregLo ST2+"
# so_query$annotation[so_query$annotation == "Il18r1$^{+}$"] = "Il18r1+"
# so_query$annotation[so_query$annotation == "Tbet$^{+}$"] = "Tbet+"
# so_query@meta.data %>% count(annotation) %>% as.data.frame()

mypal_annotation = setNames(mypal, unique(so_query$annotation))
mypal_annotation["Tfr-like"] = "#6E9BF8"
mypal_annotation["Th1-like"] = "#E87D71"
mypal_annotation["Quiescent"] = "#53B64B"


so_query@meta.data %>% count(level1_final, level2_final)

#check that non-Tregs aren't expressing Foxp3
p1 = DimPlot(so_query, reduction = "mde_incremental_allT", group.by = "annotation", cols = mypal) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
p2 = DimPlot(so_query, reduction = "mde_incremental_allT", group.by = "level1_final", cols = mypal_level1) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
p3 = FeaturePlot(so_query, reduction = "mde_incremental_allT", features = "Foxp3", order = T) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
p1 + p2 + p3
FeaturePlot(so_query, reduction = "mde_incremental_allT", features = c("Zbtb16","Trgc1", "Cd8b1", "Cd4"), order = T) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
# FeaturePlot(so_query[,so_query$level1_final != "Treg"], reduction = "mde_incremental_allT", features = "Foxp3", order = T) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
# FeaturePlot(so_query[,so_query$level1_final == "Treg"], reduction = "mde_incremental_allT", features = "Foxp3", order = T) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
# FeaturePlot(so_query[,so_query$level1_final == "CD4"], reduction = "mde_incremental_allT", features = "Foxp3", order = T) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))

# so_query$annotation = paste("cl", so_query$annotation, sep = "_")
so_query$sample = so_query$IGTHT

# sub = so_query@meta.data %>% filter(level1_final == "CD8" & !(level2_plot %in% c("not classified"))) %>% row.names()
# so2 = merge(so, so_query[,sub], merge.dr = T)

so2 = merge(so, so_query, merge.dr = T)
so2@meta.data %>% count(sample_type)
so2@meta.data %>% count(annotation)

# mypal_annotation = mypal
mypal_sample = mypal

sub = so2@meta.data %>% filter(sample != "immgent" & level1_final == "Treg") %>% row.names()
highlight_size = 1/log10(length(sub)+1)
pdf(sprintf("%s/RBI.pdf",query_dir),10, 10, useDingbats = F)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F, highlight_size = 2)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_final", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, highlight_size = 2)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "sample", mycols = mypal, print_plot1 = T, print_plot2 = T,labelclusters = F, highlight_size = 2)
# MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F)
for (s in unique(so_query$sample_type)) {
    print(s)
    tmp = so2[,so2$sample_type %in% c(s) | so2$sample %in% c("immgent")]
    print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "level2_final", highlight_size = 2, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "annotation", highlight_size = 2, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "level2_final", highlight_size = 1, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "annotation", highlight_size = 1, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(so2[,so2$sample %in% c("immgent", s)], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample: %s", s)))
}

# p1 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "annotation", cols = mypal_annotation)
# p2 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "level2_plot", cols = mypal_level2)
# p1 + p2
dev.off() 

# pdf(sprintf("%s/RBI_sidebyside.pdf",query_dir),50, 10, useDingbats = F)
p1_author = list()
p1_immgent = list()
stacked_list = list()
for (s in unique(so_query$sample_type)) {
    print(s)
    tmp = so2[,so2$sample_type %in% c(s) | so2$sample %in% c("immgent")]
    p = MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "level2_final", highlight_size = 1, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s))
    p1_immgent[[s]] = p$plot1
    p = MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "annotation", highlight_size = 1, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s))
    p1_author[[s]] = p$plot1
    # print(p1_author[[s]] + NoGrid() + p1_immgent[[s]] + theme_void() + NoLegend() + ggtitle(label = NULL) )
    stacked_list[[s]] = wrap_plots(list(p1_author[[s]] + theme_void() + NoLegend(), 
                              p1_immgent[[s]] + theme_void() + NoLegend() + ggtitle(label = NULL) ), ncol = 1) + plot_layout(axes = "collect_x", guides = "collect") 
    # print(stacked_list[[s]])
    # print(MyDimPlotHighlight(so2[,so2$sample %in% c("immgent", s)], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample: %s", s)))
}
pdf(sprintf("%s/RBI_sidebyside.pdf",query_dir),5, 10, useDingbats = F)
# print(wrap_plots(stacked_list, nrow = 1) + plot_layout(axes = "collect_y", guides = "collect"))
print(stacked_list)
dev.off()


##UMAP from the query
so_query <- so_query %>%
  NormalizeData(normalization.method = "LogNormalize", scale.factor = 1e4, verbose = T) %>%
  FindVariableFeatures(selection.method = "vst", nfeatures = 2000, verbose = T) %>%
  ScaleData(features = VariableFeatures(.), verbose = T) %>%     # note the "."
  RunPCA(features = VariableFeatures(.), npcs = 50, verbose = T) %>%
  FindNeighbors(dims = 1:30, verbose = T) %>%
  RunUMAP(dims = 1:30, seed.use = 123, verbose = T)

pdf(sprintf("%s/RBI_UMAP_query.pdf",query_dir),10, 10, useDingbats = F)
p = DimPlot(so_query, reduction = "umap", group.by = "sample", cols = mypal)
p
p + NoLegend()
p = DimPlot(so_query, reduction = "umap", group.by = "sample_type", cols = mypal)
p
p + NoLegend()
p = DimPlot(so_query, reduction = "umap", group.by = "annotation", cols = mypal_annotation)
p
p + NoLegend()
p = DimPlot(so_query, reduction = "umap", group.by = "level1_final", cols = mypal_level1)
p
p + NoLegend()
p = DimPlot(so_query, reduction = "umap", group.by = "level2_final", cols = mypal_level2)
p
p + NoLegend()
so_query$is_not_classified = so_query$level2_final == "not classified"
p = DimPlot(so_query, reduction = "umap", group.by = "is_not_classified",cols = c("grey", "red"))
p
p + NoLegend()

dev.off()

# FeaturePlot(so_query, features = c("Cd4"))
# p1 = DimPlot(so_query[,so_query$level1_final == "CD4"], reduction = "umap", group.by = "level1_final", cols = immgent_colors$level1)
# p2 = FeaturePlot(so_query, features = c("Cd4"))
# p1+p2
# 
# so_query@meta.data %>% count(level2_final)
# DimPlot(so_query, reduction = "umap", group.by = "level2_final",cols = mypal_level2) # ggplot2::xlim(c(-8,8)) #+ ggplot2::ylim(c(-8,8))
# so_query$is_not_classified = so_query$level2_final == "not classified"
# DimPlot(so_query, reduction = "umap", group.by = "is_not_classified",cols = c("grey", "red"))
# 
# p1 = DimPlot(so_query[,so_query$level1_final == "Treg"], reduction = "umap", group.by = "level2_final", cols = immgent_colors$level2) + ggplot2::xlim(c(-8,8)) #+ ggplot2::ylim(c(-8,8))
# p2 = FeaturePlot(so_query, features = c("Foxp3")) #+ ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
# p1+p2
# 
# p1 = DimPlot(so_query[,so_query$level1_final != "not classified"], reduction = "umap", group.by = "level1_final", cols = immgent_colors$level1) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
# p2 = FeaturePlot(so_query[,so_query$level1_final != "not classified"], features = c("Foxp3")) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
# p1+p2

```

GSE219259 Ex Tregs
```{r}
query_dir = '/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/Treg/GSE219259_Foxp3_creERT2_TdT/Not_classified_Full_Trial/'
so_query = readRDS('/Users/david/Library/CloudStorage/GoogleDrive-zemmour@uchicago.edu/My Drive/ImmgenT/20250109_freeze/odhran/Treg/GSE219259_Foxp3_creERT2_TdT/Not_classified_Full_Trial/Final_Seurat_object.Rds') 
so_query_orig = so_query

head(so_query@meta.data)
so_query@meta.data %>% count(IGTHT) 

#merge replicates
so_query@meta.data %>% count(IGTHT)
so_query@meta.data %>% count(Condition)
so_query$sample_type = so_query$Condition
# so_query$sample_type = gsub(pattern = "VMNA_Maf_ko_|muscle_colon_Treg_Batch_1_|muscle_colon_Treg_Batch_2_|_1|_2|_3","", so_query$sample_type)
so_query@meta.data %>% count(IGTHT, sample_type)

#Redefine level1
so_query@meta.data %>% count(level2_final) %>% as.data.frame()
so_query@meta.data %>% count(level1_final) %>% as.data.frame()
so_query@meta.data %>% count(level1_final, level2_final)
so_query$level1_final_orig = so_query$level1_final
so_query$level1_final = str_extract(so_query$level2_final, "^[^_]+")
so_query@meta.data %>% count(level1_final, level1_final_orig)
so_query@meta.data %>% count(level1_final, level2_final)

# so_query@meta.data %>% count(level2_final, level2_plot)

#filter cells without author's annotation
so_query$annotation = so_query$celltypes
so_query@meta.data %>% count(annotation) %>% as.data.frame()
so_query@meta.data %>% count(annotation, level1_final) %>% as.data.frame()
so_query@meta.data %>% count(annotation, level2_final) %>% as.data.frame()
so_query@meta.data %>% filter(!is.na(annotation)) %>% group_by(level2_final) %>% count() %>% as.data.frame()

so_query = so_query[,so_query@meta.data %>% filter(!is.na(annotation)) %>% row.names()]
so_query@meta.data %>% count(annotation, level2_final) %>% as.data.frame()
so_query@meta.data %>% count(annotation, level1_final) %>% as.data.frame()

# so_query$annotation[so_query$annotation == "Areg$^{hi}$ ST2$^{+}$"] = "AregHi ST2+"
# so_query$annotation[so_query$annotation == "Areg$^{lo}$ ST2$^{+}$"] = "AregLo ST2+"
# so_query$annotation[so_query$annotation == "Il18r1$^{+}$"] = "Il18r1+"
# so_query$annotation[so_query$annotation == "Tbet$^{+}$"] = "Tbet+"
# so_query@meta.data %>% count(annotation) %>% as.data.frame()

#filter non T cells
so_query@meta.data %>% filter(level1_final %in% c("unclear", "nonT", "remove")) %>% group_by(level2_final) %>% count() %>% as.data.frame()
so_query = so_query[,so_query@meta.data %>% filter(!(level1_final %in% c("unclear", "nonT", "remove"))) %>% row.names()]

mypal_annotation = setNames(mypal, unique(so_query$annotation))
mypal_annotation["CD8+ memory T"] = "#8029A9"
mypal_annotation["NKT"] = "#EEC2BE"
mypal_annotation["CD4+ memory T"] = "#39817F"
mypal_annotation["NK"] = "#DEC2F5"
mypal_annotation["CD4+ T"] = "#906634"

so_query@meta.data %>% count(level1_final, level2_final)

#check that non-Tregs aren't expressing Foxp3
p1 = DimPlot(so_query, reduction = "mde_incremental_allT", group.by = "annotation", cols = mypal_annotation) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
p2 = DimPlot(so_query, reduction = "mde_incremental_allT", group.by = "level1_final", cols = mypal_level1) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
# p3 = FeaturePlot(so_query, reduction = "mde_incremental_allT", features = "Foxp3", order = T) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
p1 + p2
pdf(sprintf("%s/RBI_genes.pdf",query_dir),10, 15, useDingbats = F)
FeaturePlot(so_query, reduction = "mde_incremental_allT", features = c("Foxp3", "Cd4", "Cd8b1", "Cd8a","Trdc", "Zbtb16"), order = T) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))#Trgc1, Trgv2
# FeaturePlot(so_query[,so_query$level1_final != "Treg"], reduction = "mde_incremental_allT", features = "Foxp3", order = T) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
# FeaturePlot(so_query[,so_query$level1_final == "Treg"], reduction = "mde_incremental_allT", features = "Foxp3", order = T) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
# FeaturePlot(so_query[,so_query$level1_final == "CD4"], reduction = "mde_incremental_allT", features = "Foxp3", order = T) + xlim(c(-2.5,2.5)) + ylim(c(-2.5,2.5))
dev.off()

# so_query$annotation = paste("cl", so_query$annotation, sep = "_")
so_query$sample = so_query$IGTHT

# sub = so_query@meta.data %>% filter(level1_final == "CD8" & !(level2_plot %in% c("not classified"))) %>% row.names()
# so2 = merge(so, so_query[,sub], merge.dr = T)

so2 = merge(so, so_query, merge.dr = T)
# so2$sample[colnames(so_orig)] = "immgent"
# so2$sample_type[colnames(so_orig)] = "immgent"
so2@meta.data %>% count(sample_type)
so2@meta.data %>% count(annotation)

# mypal_annotation = mypal
mypal_sample = mypal

highlight_size = 1/log10(length(sub)+1)
pdf(sprintf("%s/RBI2.pdf",query_dir),10, 10, useDingbats = F)
sub = so2@meta.data %>% filter(sample != "immgent") %>% row.names()
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_allT", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F, highlight_size = 1)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_allT", cells_to_highlight = sub, highlight_column_name =  "level1_final", mycols = mypal_level1, print_plot1 = T, print_plot2 = T,labelclusters = F, highlight_size = 1)

FeaturePlot(so_query, features = "WPRE", reduction = "mde_incremental_allT", order = T)
so2$TdTomatoPos = so2[["RNA"]]$counts["WPRE",] > 3
MyFeaturePlotHighlight(so2, umap_to_plot = "mde_incremental_allT", cells_to_highlight = sub, assay = "RNA", feature = "WPRE", colors = viridis(10),background_alpha = 1)

sub = so2@meta.data %>% filter(sample != "immgent" & TdTomatoPos & level1_final != "not classified") %>% row.names()
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_allT", cells_to_highlight = sub, highlight_column_name =  "TdTomatoPos", mycols = c('FALSE'= "black", 'TRUE' = "red"), print_plot1 = T, print_plot2 = T,labelclusters = F, highlight_size = 2)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_allT", cells_to_highlight = sub, highlight_column_name =  "level1_final", mycols = mypal_level1, print_plot1 = T, print_plot2 = T,labelclusters = T, highlight_size = 2)
MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_allT", cells_to_highlight = sub, highlight_column_name =  "level2_final", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = F, highlight_size = 2)

sub = so2@meta.data %>% filter(sample != "immgent" & TdTomatoPos & level1_final == "Treg" & level1_final != "not classified") %>% row.names()
MyDimPlotHighlight(so2[, so2$level1_final == "Treg" | so2$annotation_level1 == "Treg"], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_final", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = F, background_alpha = 1,highlight_size = 2, pixels = c(512,512))
MyFeaturePlotHighlight(so2[, so2$level1_final == "Treg" | so2$annotation_level1 == "Treg"], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, assay = "RNA", feature = "WPRE", colors = viridis(10), xlim = c(-3,3), ylim = c(-3,3), background_alpha = 1, highlight_size = 2)
MyFeaturePlotHighlight(so2[, so2$level1_final == "Treg" | so2$annotation_level1 == "Treg"], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, assay = "RNA", feature = "Foxp3", colors = viridis(10), xlim = c(-3,3), ylim = c(-3,3), pixels = c(512,512), background_alpha = 1, highlight_size = 2)


sub = so2@meta.data %>% filter(sample != "immgent" & TdTomatoPos & level1_final == "CD4" & level1_final != "not classified") %>% row.names()
MyDimPlotHighlight(so2[, so2$level1_final == "CD4" | so2$annotation_level1 == "CD4"], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_final", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = F, highlight_size = 2, pixels = c(512,512), xlim = c(-3,3), ylim = c(-3,3))
MyFeaturePlotHighlight(so2[, so2$level1_final == "CD4" | so2$annotation_level1 == "CD4"], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, assay = "RNA", feature = "WPRE", colors = viridis(10), xlim = c(-3,3), ylim = c(-3,3), background_alpha = 1, highlight_size = 2)
MyFeaturePlotHighlight(so2[, so2$level1_final == "CD4" | so2$annotation_level1 == "CD4"], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, assay = "RNA", feature = "Foxp3", colors = viridis(10), xlim = c(-3,3), ylim = c(-3,3), pixels = c(512,512), background_alpha = 1, highlight_size = 2)
dev.off()

pdf(sprintf("%s/Distribution_TdTomatoCells.pdf",query_dir),7, 5, useDingbats = F)
#Distribution of WPRE+ cells (TdTomato)
library(forcats)
library(scales)

# 1) Proportions per sample × level1_final (TdTomato+ only)
props <- so2@meta.data %>%
    filter(TdTomatoPos == TRUE) %>%
    count(sample, level1_final, name = "n") %>%
    group_by(sample) %>%
    mutate(prop = n / sum(n)) %>%
    ungroup() %>%
    filter(level1_final != "not classified")

# 2) Mean per level1_final (to draw the bars)
props_mean <- props %>%
  group_by(level1_final) %>%
  summarise(mean_prop = mean(prop, na.rm = TRUE), .groups = "drop")

# (optional) reorder x by mean
props_mean <- props_mean %>%
  mutate(level1_final = fct_reorder(level1_final, mean_prop, .desc = T))

props <- props %>%
  mutate(level1_final = factor(level1_final, levels = rev(levels(props_mean$level1_final))))

# 3) Plot: mean bar + per-sample points
p = ggplot() +
  geom_col(
    data = props_mean,
    aes(x = level1_final, y = mean_prop, fill = level1_final),
    color = "black",width = 0.7
  ) +
  geom_point(
    data = props,
    aes(x = level1_final, y = prop ),
    position = position_jitter(width = 0.15, height = 0), shape = 16, color = "black",
    size = 4, alpha = 0.85
  ) +
    scale_fill_manual(values = mypal_level1) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +  # remove if you prefer raw proportions
  labs(x = NULL, y = "Proportion (of TdTomato+ cells)", fill = "Sample") +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
    # panel.grid.major.x = element_blank()
  ) + NoGrid()

p

props <- so2@meta.data %>%
    filter(TdTomatoPos == TRUE & level1_final == "Treg") %>%
    count(sample, level2_final, name = "n") %>%
    group_by(sample) %>%
    mutate(prop = n / sum(n)) %>%
    ungroup() %>%
    filter(level2_final != "Treg")
props_mean <- props %>%
  group_by(level2_final) %>%
  summarise(mean_prop = mean(prop, na.rm = TRUE), .groups = "drop")
props_mean <- props_mean %>%
  mutate(level2_final = fct_reorder(level2_final, mean_prop, .desc = T))
props <- props %>%
  mutate(level2_final = factor(level2_final, levels = rev(levels(props_mean$level2_final))))
p = ggplot() +
  geom_col(
    data = props_mean,
    aes(x = level2_final, y = mean_prop, fill = level2_final),
    color = "black",width = 0.7
  ) +
  geom_point(
    data = props,
    aes(x = level2_final, y = prop ),
    position = position_jitter(width = 0.15, height = 0), shape = 16, color = "black",
    size = 4, alpha = 0.85
  ) +
    scale_fill_manual(values = mypal_level2) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +  # remove if you prefer raw proportions
  labs(x = NULL, y = "Proportion (of TdTomato+ cells)", fill = "Sample") +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
    # panel.grid.major.x = element_blank()
  ) + NoGrid()
p

props <- so2@meta.data %>%
    filter(TdTomatoPos == TRUE & level1_final == "CD4") %>%
    count(sample, level2_final, name = "n") %>%
    group_by(sample) %>%
    mutate(prop = n / sum(n)) %>%
    ungroup() %>%
    filter(level2_final != "CD4")
props_mean <- props %>%
  group_by(level2_final) %>%
  summarise(mean_prop = mean(prop, na.rm = TRUE), .groups = "drop")
props_mean <- props_mean %>%
  mutate(level2_final = fct_reorder(level2_final, mean_prop, .desc = T))
props <- props %>%
  mutate(level2_final = factor(level2_final, levels = rev(levels(props_mean$level2_final))))
p = ggplot() +
  geom_col(
    data = props_mean,
    aes(x = level2_final, y = mean_prop, fill = level2_final),
    color = "black",width = 0.7
  ) +
  geom_point(
    data = props,
    aes(x = level2_final, y = prop ),
    position = position_jitter(width = 0.15, height = 0), shape = 16, color = "black",
    size = 4, alpha = 0.85
  ) +
    scale_fill_manual(values = mypal_level2) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +  # remove if you prefer raw proportions
  labs(x = NULL, y = "Proportion (of TdTomato+ cells)", fill = "Sample") +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
    # panel.grid.major.x = element_blank()
  ) + NoGrid()
p


dev.off()


so2 = NormalizeData(so2)
so2$TdTomatoNeg = so2[["RNA"]]@counts["WPRE",] == 0

    pdf(sprintf("%s/VolcanoPlot_TdTomatoPos_vs_Neg.pdf",query_dir),7, 7, useDingbats = F)
    group1 = so2@meta.data %>% filter(TdTomatoPos & level2_final %in% c("CD4_cl13", "CD4_cl14", "CD4_cl9")) %>% row.names()
    group2 = so2@meta.data %>% filter(TdTomatoNeg & level2_final %in% c("CD4_cl13")) %>% row.names()
    title = "TdTomatoPos vs TdTomatoNeg in CD4_cl9, CD4_cl13, CD4_cl14"
    so2$groups = NA
    so2$groups[colnames(so2) %in% group1] = "gp1"
    so2$groups[colnames(so2) %in% group2] = "gp2"
    so2$groups = factor(so2$groups)
    Idents(so2) = "groups"
    DefaultAssay(so2) <- "RNA"
    results = Seurat::FindMarkers(so2, slot = "data", ident.1 = "gp1", ident.2 = "gp2", logfc.threshold = 0, min.pct = 0, base = 2, verbose = T)
    results$SYMBOL = rownames(results)
    res = results %>% filter(pct.1 > 0.05 | pct.2 > 0.05, SYMBOL != "WPRE") 
    EnhancedVolcano(
      res,
      lab = rownames(res),
      x = 'avg_log2FC',
      y = 'p_val_adj',
      title = title,
      subtitle = NULL,
      caption = NULL,
      pCutoff = 0.05, 
      FCcutoff = abs(1),
      col = c(
        'grey50',   # non-sig
        'grey50',      # sig up
        'grey50',      # sig down
        'red'    ),   # both sig up & down
      colAlpha = 1,                              # solid
      drawConnectors = T,
      cutoffLineType = 'blank',                  # hide dashed lines (alternative to removing)
      cutoffLineWidth = 0,                       # ensure no line
      # --- no legends or guides ---
      legendPosition = 'None',
      # --- styling ---
      pointSize = 2,
      labSize = 3,
      gridlines.major = FALSE,
      gridlines.minor = FALSE,
      axisLabSize = 12,
      titleLabSize = 14
    )
    
    
    group1 = so2@meta.data %>% filter(TdTomatoPos & level2_final %in% c("CD4_cl13")) %>% row.names()
    group2 = so2@meta.data %>% filter(TdTomatoNeg & level2_final %in% c("CD4_cl13")) %>% row.names()
    title = "TdTomatoPos vs TdTomatoNeg in CD4_cl13"
    so2$groups = NA
    so2$groups[colnames(so2) %in% group1] = "gp1"
    so2$groups[colnames(so2) %in% group2] = "gp2"
    so2$groups = factor(so2$groups)
    Idents(so2) = "groups"
    DefaultAssay(so2) <- "RNA"
    results = Seurat::FindMarkers(so2, slot = "data", ident.1 = "gp1", ident.2 = "gp2", logfc.threshold = 0, min.pct = 0, base = 2, verbose = T)
    results$SYMBOL = rownames(results)
    res = results %>% filter(pct.1 > 0.05 | pct.2 > 0.05, SYMBOL != "WPRE") 
    EnhancedVolcano(
      res,
      lab = rownames(res),
      x = 'avg_log2FC',
      y = 'p_val_adj',
      title = title,
      subtitle = NULL,
      caption = NULL,
      pCutoff = 0.05, 
      FCcutoff = abs(1),
      col = c(
        'grey50',   # non-sig
        'grey50',      # sig up
        'grey50',      # sig down
        'red'    ),   # both sig up & down
      colAlpha = 1,                              # solid
      drawConnectors = T,
      cutoffLineType = 'blank',                  # hide dashed lines (alternative to removing)
      cutoffLineWidth = 0,                       # ensure no line
      # --- no legends or guides ---
      legendPosition = 'None',
      # --- styling ---
      pointSize = 2,
      labSize = 3,
      gridlines.major = FALSE,
      gridlines.minor = FALSE,
      axisLabSize = 12,
      titleLabSize = 14
    )
    
    
    group1 = so2@meta.data %>% filter(TdTomatoPos & level2_final %in% c("CD4_cl14")) %>% row.names()
    group2 = so2@meta.data %>% filter(TdTomatoNeg & level2_final %in% c("CD4_cl14")) %>% row.names()
    title = "TdTomatoPos vs TdTomatoNeg in CD4_cl14"
    so2$groups = NA
    so2$groups[colnames(so2) %in% group1] = "gp1"
    so2$groups[colnames(so2) %in% group2] = "gp2"
    so2$groups = factor(so2$groups)
    Idents(so2) = "groups"
    DefaultAssay(so2) <- "RNA"
    results = Seurat::FindMarkers(so2, slot = "data", ident.1 = "gp1", ident.2 = "gp2", logfc.threshold = 0, min.pct = 0, base = 2, verbose = T)
    results$SYMBOL = rownames(results)
    res = results %>% filter(pct.1 > 0.05 | pct.2 > 0.05, SYMBOL != "WPRE") 
    EnhancedVolcano(
      res,
      lab = rownames(res),
      x = 'avg_log2FC',
      y = 'p_val_adj',
      title = title,
      subtitle = NULL,
      caption = NULL,
      pCutoff = 0.05, 
      FCcutoff = abs(1),
      col = c(
        'grey50',   # non-sig
        'grey50',      # sig up
        'red',      # sig down
        'red'    ),   # both sig up & down
      colAlpha = 1,                              # solid
      drawConnectors = T,
      cutoffLineType = 'blank',                  # hide dashed lines (alternative to removing)
      cutoffLineWidth = 0,                       # ensure no line
      # --- no legends or guides ---
      legendPosition = 'None',
      # --- styling ---
      pointSize = 2,
      labSize = 3,
      gridlines.major = FALSE,
      gridlines.minor = FALSE,
      axisLabSize = 12,
      titleLabSize = 14
    )
    
    group1 = so2@meta.data %>% filter(TdTomatoPos & level2_final %in% c("CD4_cl9")) %>% row.names()
    group2 = so2@meta.data %>% filter(TdTomatoNeg & level2_final %in% c("CD4_cl9")) %>% row.names()
    title = "TdTomatoPos vs TdTomatoNeg in CD4_cl9"
    so2$groups = NA
    so2$groups[colnames(so2) %in% group1] = "gp1"
    so2$groups[colnames(so2) %in% group2] = "gp2"
    so2$groups = factor(so2$groups)
    Idents(so2) = "groups"
    DefaultAssay(so2) <- "RNA"
    results = Seurat::FindMarkers(so2, slot = "data", ident.1 = "gp1", ident.2 = "gp2", logfc.threshold = 0, min.pct = 0, base = 2, verbose = T)
    results$SYMBOL = rownames(results)
    res = results %>% filter(pct.1 > 0.05 | pct.2 > 0.05, SYMBOL != "WPRE") 
    EnhancedVolcano(
      res,
      lab = rownames(res),
      x = 'avg_log2FC',
      y = 'p_val_adj',
      title = title,
      subtitle = NULL,
      caption = NULL,
      pCutoff = 0.05, 
      FCcutoff = abs(1),
      col = c(
        'grey50',   # non-sig
        'grey50',      # sig up
        'red',      # sig down
        'red'    ),   # both sig up & down
      colAlpha = 1,                              # solid
      drawConnectors = T,
      cutoffLineType = 'blank',                  # hide dashed lines (alternative to removing)
      cutoffLineWidth = 0,                       # ensure no line
      # --- no legends or guides ---
      legendPosition = 'None',
      # --- styling ---
      pointSize = 2,
      labSize = 3,
      gridlines.major = FALSE,
      gridlines.minor = FALSE,
      axisLabSize = 12,
      titleLabSize = 14
    )
    
    group1 = so2@meta.data %>% filter(TdTomatoPos & level1_final %in% c("CD4")) %>% row.names()
    group2 = so2@meta.data %>% filter(TdTomatoNeg & level1_final %in% c("CD4")) %>% row.names()
    title = "TdTomatoPos vs TdTomatoNeg in CD4"
    so2$groups = NA
    so2$groups[colnames(so2) %in% group1] = "gp1"
    so2$groups[colnames(so2) %in% group2] = "gp2"
    so2$groups = factor(so2$groups)
    Idents(so2) = "groups"
    DefaultAssay(so2) <- "RNA"
    results = Seurat::FindMarkers(so2, slot = "data", ident.1 = "gp1", ident.2 = "gp2", logfc.threshold = 0, min.pct = 0, base = 2, verbose = T)
    results$SYMBOL = rownames(results)
    res = results %>% filter(pct.1 > 0.05 | pct.2 > 0.05, SYMBOL != "WPRE") 
    EnhancedVolcano(
      res,
      lab = rownames(res),
      x = 'avg_log2FC',
      y = 'p_val_adj',
      title = title,
      subtitle = NULL,
      caption = NULL,
      pCutoff = 0.05, 
      FCcutoff = abs(1),
      col = c(
        'grey50',   # non-sig
        'grey50',      # sig up
        'red',      # sig down
        'red'    ),   # both sig up & down
      colAlpha = 1,                              # solid
      drawConnectors = T,
      cutoffLineType = 'blank',                  # hide dashed lines (alternative to removing)
      cutoffLineWidth = 0,                       # ensure no line
      # --- no legends or guides ---
      legendPosition = 'None',
      # --- styling ---
      pointSize = 2,
      labSize = 3,
      gridlines.major = FALSE,
      gridlines.minor = FALSE,
      axisLabSize = 12,
      titleLabSize = 14
    )
    
    
    
    dev.off()
    
    


######



so_query$TdTomatoPos = so_query[["RNA"]]$counts["WPRE",] > 0
so_query$Foxp3Pos = so_query[["RNA"]]$counts["Foxp3",] > 0
MyDimPlotHighlight(so_query, umap_to_plot = "mde_incremental_allT", cells_to_highlight = sub, highlight_column_name =  "TdTomatoPos", mycols = c('FALSE'= "black", 'TRUE' = "red"), print_plot1 = T, print_plot2 = T,labelclusters = F, highlight_size = 1)
FeaturePlot(so_query, features = "WPRE", reduction = "mde_incremental_allT", order = T)
FeaturePlot(so_query, features = "Foxp3", reduction = "mde_incremental_allT", order = T)



so_query@meta.data %>% count(level1_final, TdTomatoPos)
so_query@meta.data %>% count(level1_final, Foxp3Pos)
so_query@meta.data %>% count(TdTomatoPos, Foxp3Pos)

mean(so_query[["RNA"]]$counts["Foxp3",which(so_query[["RNA"]]$counts["Foxp3",so_query$level1_final == "Treg"] >0)])


# MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "level2_final", mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, highlight_size = 2)
# MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "sample", mycols = mypal, print_plot1 = T, print_plot2 = T,labelclusters = F, highlight_size = 2)
# MyDimPlotHighlight(so2, umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = F)
for (s in unique(so_query$sample_type)) {
    print(s)
    tmp = so2[,so2$sample_type %in% c(s) | so2$sample %in% c("immgent")]
    print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "level2_final", highlight_size = 2, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "annotation", highlight_size = 2, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "level2_final", highlight_size = 1, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "annotation", highlight_size = 1, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s)))
    # print(MyDimPlotHighlight(so2[,so2$sample %in% c("immgent", s)], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample: %s", s)))
}

# p1 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "annotation", cols = mypal_annotation)
# p2 = DimPlot(so_query[,sub], reduction = "mde_incremental_level2", group.by = "level2_plot", cols = mypal_level2)
# p1 + p2
dev.off() 

# pdf(sprintf("%s/RBI_sidebyside.pdf",query_dir),50, 10, useDingbats = F)
p1_author = list()
p1_immgent = list()
stacked_list = list()
for (s in unique(so_query$sample_type)) {
    print(s)
    tmp = so2[,so2$sample_type %in% c(s) | so2$sample %in% c("immgent")]
    p = MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "level2_final", highlight_size = 1, mycols = mypal_level2, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s))
    p1_immgent[[s]] = p$plot1
    p = MyDimPlotHighlight(tmp, umap_to_plot = "mde_incremental_level2", cells_to_highlight = intersect(sub, colnames(tmp)), highlight_column_name =  "annotation", highlight_size = 1, mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample %s", s))
    p1_author[[s]] = p$plot1
    # print(p1_author[[s]] + NoGrid() + p1_immgent[[s]] + theme_void() + NoLegend() + ggtitle(label = NULL) )
    stacked_list[[s]] = wrap_plots(list(p1_author[[s]] + theme_void() + NoLegend(), 
                              p1_immgent[[s]] + theme_void() + NoLegend() + ggtitle(label = NULL) ), ncol = 1) + plot_layout(axes = "collect_x", guides = "collect") 
    # print(stacked_list[[s]])
    # print(MyDimPlotHighlight(so2[,so2$sample %in% c("immgent", s)], umap_to_plot = "mde_incremental_level2", cells_to_highlight = sub, highlight_column_name =  "annotation", mycols = mypal_annotation, print_plot1 = T, print_plot2 = T,labelclusters = T, title = sprintf("sample: %s", s)))
}
pdf(sprintf("%s/RBI_sidebyside.pdf",query_dir),5, 10, useDingbats = F)
# print(wrap_plots(stacked_list, nrow = 1) + plot_layout(axes = "collect_y", guides = "collect"))
print(stacked_list)
dev.off()


##UMAP from the query
so_query <- so_query %>%
  NormalizeData(normalization.method = "LogNormalize", scale.factor = 1e4, verbose = T) %>%
  FindVariableFeatures(selection.method = "vst", nfeatures = 2000, verbose = T) %>%
  ScaleData(features = VariableFeatures(.), verbose = T) %>%     # note the "."
  RunPCA(features = VariableFeatures(.), npcs = 50, verbose = T) %>%
  FindNeighbors(dims = 1:30, verbose = T) %>%
  RunUMAP(dims = 1:30, seed.use = 123, verbose = T)

pdf(sprintf("%s/RBI_UMAP_query.pdf",query_dir),10, 10, useDingbats = F)
p = DimPlot(so_query, reduction = "umap", group.by = "sample", cols = mypal)
p
p + NoLegend()
p = DimPlot(so_query, reduction = "umap", group.by = "sample_type", cols = mypal)
p
p + NoLegend()
p = DimPlot(so_query, reduction = "umap", group.by = "annotation", cols = mypal_annotation)
p
p + NoLegend()
p = DimPlot(so_query, reduction = "umap", group.by = "level1_final", cols = mypal_level1)
p
p + NoLegend()
p = DimPlot(so_query, reduction = "umap", group.by = "level2_final", cols = mypal_level2)
p
p + NoLegend()
so_query$is_not_classified = so_query$level2_final == "not classified"
p = DimPlot(so_query, reduction = "umap", group.by = "is_not_classified",cols = c("grey", "red"))
p
p + NoLegend()

dev.off()

# FeaturePlot(so_query, features = c("Cd4"))
# p1 = DimPlot(so_query[,so_query$level1_final == "CD4"], reduction = "umap", group.by = "level1_final", cols = immgent_colors$level1)
# p2 = FeaturePlot(so_query, features = c("Cd4"))
# p1+p2
# 
# so_query@meta.data %>% count(level2_final)
# DimPlot(so_query, reduction = "umap", group.by = "level2_final",cols = mypal_level2) # ggplot2::xlim(c(-8,8)) #+ ggplot2::ylim(c(-8,8))
# so_query$is_not_classified = so_query$level2_final == "not classified"
# DimPlot(so_query, reduction = "umap", group.by = "is_not_classified",cols = c("grey", "red"))
# 
# p1 = DimPlot(so_query[,so_query$level1_final == "Treg"], reduction = "umap", group.by = "level2_final", cols = immgent_colors$level2) + ggplot2::xlim(c(-8,8)) #+ ggplot2::ylim(c(-8,8))
# p2 = FeaturePlot(so_query, features = c("Foxp3")) #+ ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
# p1+p2
# 
# p1 = DimPlot(so_query[,so_query$level1_final != "not classified"], reduction = "umap", group.by = "level1_final", cols = immgent_colors$level1) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
# p2 = FeaturePlot(so_query[,so_query$level1_final != "not classified"], features = c("Foxp3")) + ggplot2::xlim(c(-8,8)) + ggplot2::ylim(c(-8,8))
# p1+p2

```






